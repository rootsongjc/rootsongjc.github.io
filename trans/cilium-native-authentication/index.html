<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>解密 Cilium 原生认证功能 · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/trans/cilium-native-authentication/" />
  <meta property="og:title" content="解密 Cilium 原生认证功能 | Jimmy Song" />
  <meta property="twitter:title" content="解密 Cilium 原生认证功能 | Jimmy Song" />

  
  <meta property="og:description" content="在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。" />
  <meta property="twitter:description" content="在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    [译] 解密 Cilium 原生认证功能
                </p>
                <p class="page-description">
                    在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>2024/08/08</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/categories/%e5%ae%89%e5%85%a8"> 
                        安全</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>22 分钟</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>4938 字</li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fas fa-language"></i>
                        </span><a href="https://blog.teknews.cloud/aks/security/network/2024/07/30/About_Cilium_native_authentication_feature.html" target="_blank" rel="noopener">原文</a>
                    </li>
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">

            
              <div class="alert alert-note-container mt-2">
    <div class="alert-note-title px-2 py-2">
      声明
    </div>
    <div class="alert-tip px-2">
        此文为个人翻译，仅供参考，不代表我个人立场。翻译过程中可能有删改或遗漏，如需了解原文，请自行查阅。如有疏漏，欢迎指正。
    </div>
  </div>
            
            
              <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#cilium-认证功能">Cilium 认证功能</a>
      <ul>
        <li><a href="#为什么我们需要认证">为什么我们需要认证</a></li>
        <li><a href="#cilium-认证功能的底层原理">Cilium 认证功能的底层原理</a></li>
      </ul>
    </li>
    <li><a href="#尝试-cilium-认证">尝试 Cilium 认证</a>
      <ul>
        <li><a href="#准备环境">准备环境</a></li>
        <li><a href="#使用相互认证">使用相互认证</a></li>
        <li><a href="#实施策略-2-和-3">实施策略 2 和 3</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
</details>

            
            <p>我们已经讨论了 Cilium 一段时间了，但是这个话题有很多值得关注的地方，我们知道我们会再次回到这个话题。今天，我建议我们探索一个用于认证工作负载的功能。在讨论这个话题之前，我们需要一些定义。</p>
<p>我们的议程将按照以下顺序进行：</p>
<ol>
<li>了解 Cilium 认证功能</li>
<li>尝试认证功能</li>
</ol>
<h2 id="cilium-认证功能">Cilium 认证功能</h2>
<h3 id="为什么我们需要认证">为什么我们需要认证</h3>
<p>在基于微服务的架构中，安全是一个巨大的话题。在 Kubernetes 环境中，我们可以查看网络，并通过限制只允许必要端口和协议的流量来实施最小权限原则。在这种情况下，我们可以依赖网络策略。例如，这个策略拒绝 <code>basic</code> 命名空间中的所有入站流量：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-deny-all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">basics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span></code></pre></div><p>这个策略仅允许标有 <code>app=userprofile</code> 标签的 pod 在端口 <code>8082</code> 上从带有标签 <code>tier=front</code> 和 <code>app=tripsinsights</code> 的命名空间中的 pod 接收流量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow-tripviewer-ingress-apiprofile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">userprofile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">front</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">tripinsights</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8082</span><span class="w">   
</span></span></span></code></pre></div><p>但这可能还不够，全局管理也相当困难，这是分布式安全的悖论。</p>
<p>我们在之前的文章中谈到了服务网格，其目的是为网络流量提供一个集中的控制平面。我们还看到，在标准化的倡议中，我们有一些特定的流量控制对象，其中包括了认证功能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">access.smi-spec.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IdentityBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">schemes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">podLabelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">service-a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">spiffeIdentities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;cluster.local/ns/default/sa/service-a&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;federated.trustdomain/boundary/boundaryName/identifierType/identifier&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">service-a</span><span class="w">
</span></span></span></code></pre></div><p>我们将在 Cilium 服务网格中，尤其是基于身份的安全性方面探讨这一点。在基础设施层拥有这样的功能是有趣的，因为应用层不总是能够包含认证功能，尤其是当我们考虑多服务时。最多，不幸的是，我们可能在前端获得认证，但不会更多。这里，我们提出了增加基于身份的安全性的建议。</p>
<p>让我们看看它是如何工作的。</p>
<h3 id="cilium-认证功能的底层原理">Cilium 认证功能的底层原理</h3>
<p>认证意味着，某种程度上，身份。正如之前在 smi 规范中暗示的，并在 <a href="https://docs.cilium.io/en/stable/network/servicemesh/mutual-authentication/mutual-authentication/#identity-management" title="Cilium 文档" target="_blank" rel="noopener">Cilium 文档</a>中记录的，所使用的技术是 <a href="https://spiffe.io/" title="SPIFFE" target="_blank" rel="noopener">SPIFFE</a>，即每个人的安全生产身份框架。它也是 <a href="https://www.cncf.io/projects/spiffe/" title="CNCF" target="_blank" rel="noopener">CNCF</a> 中的一个毕业项目，自 2022 年 8 月以来。Spiffe 规范在一个 <a href="https://github.com/spiffe/spiffe" title="专用的 github" target="_blank" rel="noopener">专用的 github</a>上定义。</p>
<p>此时，我们将在 github 仓库中描述的 SPIFFE 标准的高层概述，其中包括：</p>
<ul>
<li>SPIFFE ID，一个结构化的字符串（表示为 URI），用作实体的“名称”。</li>
<li>SPIFFE 可验证身份文档（SVID）是携带 SPIFFE ID 的文档。它是护照的功能等同物 - 一个携带提供者身份的文档。</li>
<li>工作负载 API 是工作负载或计算过程获取其 SVID 的方法。它通常在本地暴露（例如，通过 Unix 域套接字），并且明确不包括来自工作负载的认证握手或认证令牌。</li>
</ul>
<p>此外，重要的是要提到信任域，这是一个身份命名空间，由一组加密密钥支持的发行机构支持。这些密钥共同作为居住在信任域中的所有身份的加密锚点。</p>
<p>再次强调，由于 SPIFFE 是一组规范，所有这些概念/标准实际上都在 <a href="https://github.com/spiffe/spiffe/tree/main/standards" title="github 仓库" target="_blank" rel="noopener">github 仓库</a>中详细说明。</p>
<p>现在我们知道了规范和标准，但还有很多工作要做，因为，毕竟，这只是规范。幸运的是，还有 <a href="https://spiffe.io/docs/latest/spire-about/spire-concepts/" title="SPIRE 项目" target="_blank" rel="noopener">SPIRE 项目</a>，<a href="https://www.cncf.io/projects/spire/" title="另一个毕业的 CNCF 项目" target="_blank" rel="noopener">另一个毕业的 CNCF 项目</a>，这是 SPIFFE 规范的一个生产就绪实现。</p>
<p>在 Cilium 中，SPIFFE 的实现基于 SPIRE 中央服务器。这个 SPIRE 服务器扮演我们之前在规范和标准中提到的信任域的角色。它与每个节点的 SPIRE 代理一起工作，这些代理从服务器获取自己的身份，然后验证工作负载的身份请求。</p>
<p>要了解 SPIRE 是如何工作的，我们需要再次一些概念：</p>
<ul>
<li><strong>工作负载注册</strong>是 SPIRE 将能够识别所述工作负载的过程。它告诉 SPIRE 如何识别工作负载以及给它分配哪个 SPIFFE ID。</li>
<li>SPIRE 实现工作负载的<strong>认证</strong>，即断言其身份，通过收集来自工作负载和运行 SPIRE 代理的节点的属性。还值得注意的是，认证是由称为 <em>认证器</em> 的软件完成的。在我们的案例中，我们将有一个 Kubernetes 认证器用于托管在 Kubernetes 上的工作负载，但也有节点认证器用于需要首先注册的 SPIRE 代理，然后才能进行工作负载认证。在 Azure 上，节点认证/注册依赖于具有托管身份的 Azure VMs。</li>
</ul>
<p>节点认证遵循以下步骤：</p>
<ol>
<li>代理节点认证器插件查询平台以获取节点身份的证明，并将该信息提供给代理。</li>
<li>代理将这个身份证明传递给服务器。服务器将这些数据传递给其节点认证器。</li>
<li>服务器节点认证器通过调用平台 API 验证身份证明，使用它在第 2 步中获得的信息。节点认证器还为代理创建一个 SPIFFE ID，并将此 ID 以及它发现的任何节点选择器一起传回服务器进程。</li>
<li>服务器为代理节点发送回一个 SVID。</li>
</ol>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/trans/cilium-native-authentication/nodeattestation.webp" data-img="/trans/cilium-native-authentication/nodeattestation.webp" data-width="1068" data-height="624" alt="image" data-caption="图 1：节点认证流程">
        
      
    
  
  
  <figcaption>图 1：节点认证流程</figcaption>
  
</figure>
<p>一个请求身份的工作负载遵循以下步骤：</p>
<ol>
<li>它调用代理公开的工作负载 API 请求一个 SVID。</li>
<li>代理询问调用工作负载认证器插件，向其提供有关工作负载的信息。</li>
<li>工作负载认证器通过查询邻近的平台特定组件（如 Kubernetes kubelet）发现有关工作负载的额外信息。</li>
<li>认证器将发现的信息以选择器的形式返回给代理。</li>
<li>代理通过将发现的选择器与注册条目进行比较来确定工作负载的身份，并将正确的缓存 SVID 返回给工作负载。</li>
</ol>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/trans/cilium-native-authentication/wlattest.webp" data-img="/trans/cilium-native-authentication/wlattest.webp" data-width="615" data-height="723" alt="image" data-caption="图 2：工作负载认证流程">
        
      
    
  
  
  <figcaption>图 2：工作负载认证流程</figcaption>
  
</figure>
<p>好了，这就是这个概述的全部内容。SPIFFE 规范中还有更多细节，我只能建议进行更彻底的阅读以获得更好的理解。让我们看看当我们在 AKS 集群中部署时情况如何。</p>
<h2 id="尝试-cilium-认证">尝试 Cilium 认证</h2>
<h3 id="准备环境">准备环境</h3>
<p>为了尝试这个功能，我们将使用一个仅包含 AKS 集群及其默认节点池的环境，位于虚拟网络中。</p>
<p><strong>shcemainfra</strong></p>
<p>认证需要在安装 Cilium 时指定，参数 <code>authentication.mutual.spire.enabled</code> 和 <code>authentication.mutual.spire.install.enabled</code> 必须设置为 true。</p>
<p>我们使用的 Helm 参数的完整列表如下所示</p>
<table>
<thead>
<tr>
<th>Helm 参数</th>
<th>值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>hubble.relay.enabled</td>
<td>true</td>
<td>启用 Hubble Relay</td>
</tr>
<tr>
<td>hubble.ui.enabled</td>
<td>true</td>
<td>是否启用 Hubble UI</td>
</tr>
<tr>
<td>aksbyocni.enabled</td>
<td>true</td>
<td>启用 AKS BYOCNI 集成。注意，这与未在 BYOCNI 模式下创建的 AKS 集群不兼容：改用 Azure 集成（azure.enabled）。</td>
</tr>
<tr>
<td>nodeinit.enabled</td>
<td>true</td>
<td>启用节点初始化 DaemonSet</td>
</tr>
<tr>
<td>kubeProxyReplacement</td>
<td>true</td>
<td>替换 kubeproxy</td>
</tr>
<tr>
<td>k8sServiceHost</td>
<td>“&quot;</td>
<td>Kubernetes 服务主机 - 使用“auto”从集群信息 ConfigMap 中自动查找（仅限基于 kubeadm 的集群）</td>
</tr>
<tr>
<td>k8sServicePort</td>
<td>443</td>
<td>Kubernetes 服务端口</td>
</tr>
<tr>
<td>cluster.id</td>
<td>1</td>
<td>集群的唯一 ID。必须在所有连接的集群中是唯一的，并且在 1 到 255 的范围内。只有在使用 Cluster Mesh 时才需要，如果不使用 Cluster Mesh 可以为 0。</td>
</tr>
<tr>
<td>cluster.name</td>
<td>“&quot;</td>
<td>集群的名称。只有在使用 Cluster Mesh 和与 SPIRE 的互相认证时才需要。它必须满足以下限制：* 最多包含 32 个字符；* 必须以小写字母或数字字符开头和结尾；* 之间可以包含小写字母或数字字符和破折号。如果集群 ID 不同于 0，则不能使用“default”名称。</td>
</tr>
<tr>
<td>azure.resourceGroup</td>
<td>“&quot;</td>
<td>AKS 资源组</td>
</tr>
<tr>
<td>ipam.operator.clusterPoolIPv4PodCIDRList</td>
<td>“{Ip_Range}”</td>
<td>PoolIPv4PodCIDRList 列表 [“10.0.0.0/8”] IPv4 CIDR 范围列表，分配给单个节点用于 IPAM。</td>
</tr>
<tr>
<td>prometheus.enabled</td>
<td>true</td>
<td>启用 prometheus 指标</td>
</tr>
<tr>
<td>operator.prometheus.enabled</td>
<td>true</td>
<td>启用以 OpenMetrics 格式导出 hubble 指标。</td>
</tr>
<tr>
<td>hubble.metrics.enableOpenMetrics</td>
<td>false</td>
<td>启用以 OpenMetrics 格式导出 hubble 指标。</td>
</tr>
<tr>
<td>hubble.metrics.enabled</td>
<td>“{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction}”</td>
<td>配置要收集的指标列表。如果为空或 null，则禁用指标。示例：enabled: - dns:query;ignoreAAAA - drop - tcp - flow - icmp - http 您可以从 helm CLI 指定指标列表：–set hubble.metrics.enabled=”{dns:query;ignoreAAAA,drop,tcp,flow,icmp,http}”</td>
</tr>
<tr>
<td>authentication.mutual.spire.enabled</td>
<td>true</td>
<td>mutual.spire.enabled bool false 启用 SPIRE 集成（beta）</td>
</tr>
<tr>
<td>authentication.mutual.spire.install.enabled</td>
<td>true</td>
<td>ion.mutual.spire.install.enabled bool true 启用 SPIRE 安装。这将仅在 authentication.mutual.spire.enabled 为 true 时生效</td>
</tr>
</tbody>
</table>
<p>安装完成后，我们可以查看 Cilium 的状态。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">DaemonSet              cilium-envoy       Desired: 3, Ready: 3/3, Available: 3/3
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 3, Ready: 3/3, Available: 3/3
</span></span><span class="line"><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">3</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-envoy       Running: <span class="m">3</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          29/29 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.16.0
</span></span><span class="line"><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.16.0@sha256:46ffa4ef3cf6d8885dcc4af5963b0683f7d59daa90d49ed9fb68d3b1627fe058: <span class="m">3</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui:v0.13.1@sha256:e2e9313eb7caf64b0061d9da0efbdad59c6c461f6ca1752768942bfeda0796c6: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.13.1@sha256:0e0eed917653441fded4e7cdb096b7be6a3bddded5a2dd10812a27b1fc6ed95b: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.29.7-39a2a56bbd5b3a591f69dbca51d3e30ef97e0e51@sha256:bd5ff8c66716080028f414ec1cb4f7dc66f40d2fb5a009fff187f4a9b90b566b: <span class="m">3</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.16.0@sha256:d6621c11c4e4943bf2998af7febe05be5ed6fdcf812b27ad4388f47022190316: <span class="m">2</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.16.0@sha256:33fca7776fc3d7b2abe08873319353806dc1c5e07e12011d7da4da05f836ce8d: <span class="m">1</span>
</span></span></code></pre></div><p>我们还可以查看其他 Kubernetes 对象：</p>
<ul>
<li>一个 SPIRE 服务器的部署</li>
<li>在每个节点上运行的代理的守护进程集。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ k get all -n cilium-spire 
</span></span><span class="line"><span class="cl">NAME                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/spire-agent-65sh2   1/1     Running   <span class="m">0</span>          7h2m
</span></span><span class="line"><span class="cl">pod/spire-agent-hqnsm   1/1     Running   <span class="m">0</span>          7h2m
</span></span><span class="line"><span class="cl">pod/spire-agent-lcqrz   1/1     Running   <span class="m">0</span>          7h2m
</span></span><span class="line"><span class="cl">pod/spire-server-0      2/2     Running   <span class="m">0</span>          24h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="cl">service/spire-server   ClusterIP   100.65.61.5   &lt;none&gt;        8081/TCP   27h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span class="line"><span class="cl">daemonset.apps/spire-agent   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       <span class="m">3</span>            <span class="m">3</span>           &lt;none&gt;          27h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                            READY   AGE
</span></span><span class="line"><span class="cl">statefulset.apps/spire-server   1/1     27h
</span></span></code></pre></div><p>在进行一些测试之前，让我们看看我们的 SPIRE 服务器。我们可以在<a href="https://docs.cilium.io/en/stable/network/servicemesh/mutual-authentication/mutual-authentication-example/" title="相应文档" target="_blank" rel="noopener">相应文档</a>中找到查看它的命令。</p>
<p>首先我们可以检查 SPIRE 服务器的健康状况：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server healthcheck
</span></span><span class="line"><span class="cl">Server is healthy.
</span></span></code></pre></div><p>然后我们可以看看 SPIRE 代理及其认证状态。因为我们有 3 个节点，所以在守护进程集中有 3 个 pod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ k get ds -n cilium-spire 
</span></span><span class="line"><span class="cl">NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span class="line"><span class="cl">spire-agent   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       <span class="m">3</span>            <span class="m">3</span>           &lt;none&gt;          27h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server agent list
</span></span><span class="line"><span class="cl">Found <span class="m">3</span> attested agents:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SPIFFE ID         : spiffe://spiffe.cilium/spire/agent/k8s_psat/cluster1/c0c6afc3-1e0a-4ffb-b61e-18442b04123d
</span></span><span class="line"><span class="cl">Attestation <span class="nb">type</span>  : k8s_psat
</span></span><span class="line"><span class="cl">Expiration <span class="nb">time</span>   : 2024-07-30 17:27:15 +0000 UTC
</span></span><span class="line"><span class="cl">Serial number     : <span class="m">8338212869267325996294354393424215766</span>
</span></span><span class="line"><span class="cl">Can re-attest     : <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SPIFFE ID         : spiffe://spiffe.cilium/spire/agent/k8s_psat/cluster1/08af80d6-0166-4f46-b575-0aa0dc6a5152
</span></span><span class="line"><span class="cl">Attestation <span class="nb">type</span>  : k8s_psat
</span></span><span class="line"><span class="cl">Expiration <span class="nb">time</span>   : 2024-07-30 17:27:15 +0000 UTC
</span></span><span class="line"><span class="cl">Serial number     : <span class="m">317183292034746089049553637864798125627</span>
</span></span><span class="line"><span class="cl">Can re-attest     : <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SPIFFE ID         : spiffe://spiffe.cilium/spire/agent/k8s_psat/cluster1/bdd0dfa9-20ec-4f24-a82f-c646754588ce
</span></span><span class="line"><span class="cl">Attestation <span class="nb">type</span>  : k8s_psat
</span></span><span class="line"><span class="cl">Expiration <span class="nb">time</span>   : 2024-07-30 17:27:15 +0000 UTC
</span></span><span class="line"><span class="cl">Serial number     : <span class="m">215301213544348190052950735212628656167</span>
</span></span><span class="line"><span class="cl">Can re-attest     : <span class="nb">true</span>
</span></span></code></pre></div><p>接下来我们可以检查 SPIFFE 身份。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server entry show -parentID spiffe://spiffe.cilium/ns/cilium-spire/sa/spire-agent
</span></span><span class="line"><span class="cl">Found <span class="m">2</span> entries
</span></span><span class="line"><span class="cl">Entry ID         : 53b6506b-ebe3-4cd8-89b4-9647fa535c37
</span></span><span class="line"><span class="cl">SPIFFE ID        : spiffe://spiffe.cilium/cilium-agent
</span></span><span class="line"><span class="cl">Parent ID        : spiffe://spiffe.cilium/ns/cilium-spire/sa/spire-agent
</span></span><span class="line"><span class="cl">Revision         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">X509-SVID TTL    : default
</span></span><span class="line"><span class="cl">JWT-SVID TTL     : default
</span></span><span class="line"><span class="cl">Selector         : k8s:ns:kube-system
</span></span><span class="line"><span class="cl">Selector         : k8s:sa:cilium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Entry ID         : 8c361104-31a1-480e-b97d-83673a63ce72
</span></span><span class="line"><span class="cl">SPIFFE ID        : spiffe://spiffe.cilium/cilium-operator
</span></span><span class="line"><span class="cl">Parent ID        : spiffe://spiffe.cilium/ns/cilium-spire/sa/spire-agent
</span></span><span class="line"><span class="cl">Revision         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">X509-SVID TTL    : default
</span></span><span class="line"><span class="cl">JWT-SVID TTL     : default
</span></span><span class="line"><span class="cl">Selector         : k8s:ns:kube-system
</span></span></code></pre></div><h3 id="使用相互认证">使用相互认证</h3>
<p>现在让我们部署一些工作负载。为了简单起见，我们将创建一系列基于 nginx 的部署：</p>
<p>一个目标应用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>以及客户端：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">client1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">client2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>如果我们查看 Cilium 端点，我们应该能看到关联身份的信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ k get ciliumendpoint -o wide
</span></span><span class="line"><span class="cl">NAME                             SECURITY IDENTITY   INGRESS ENFORCEMENT   EGRESS ENFORCEMENT   VISIBILITY POLICY   ENDPOINT STATE   IPV4           IPV6
</span></span><span class="line"><span class="cl">client1-599c487979-dqm4v         <span class="m">76513</span>                                                                              ready            100.64.1.197   
</span></span><span class="line"><span class="cl">client1-599c487979-qqzvl         <span class="m">76513</span>                                                                              ready            100.64.0.206   
</span></span><span class="line"><span class="cl">client1-599c487979-t8728         <span class="m">76513</span>                                                                              ready            100.64.2.214   
</span></span><span class="line"><span class="cl">client2-d64dd865b-cj56m          <span class="m">77602</span>                                                                              ready            100.64.0.77    
</span></span><span class="line"><span class="cl">client2-d64dd865b-kb7cs          <span class="m">77602</span>                                                                              ready            100.64.1.51    
</span></span><span class="line"><span class="cl">client2-d64dd865b-qskqc          <span class="m">77602</span>                                                                              ready            100.64.2.25    
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-6s4xn   <span class="m">108597</span>                                                                             ready            100.64.0.124   
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-pmzkm   <span class="m">108597</span>                                                                             ready            100.64.1.244   
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-vz4gq   <span class="m">108597</span>                                                                             ready            100.64.2.127   
</span></span></code></pre></div><p>使用安全身份值，我们可以在 SPIRE 服务器上检查相应的身份。我们将使用 <code>'{.items[0].status.identity.id}'</code> 作为 jsonpath 值来提取安全身份作为变量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ k get deployment --show-labels 
</span></span><span class="line"><span class="cl">NAME             READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
</span></span><span class="line"><span class="cl">client1          3/3     <span class="m">3</span>            <span class="m">3</span>           14h   <span class="nv">app</span><span class="o">=</span>client1
</span></span><span class="line"><span class="cl">client2          3/3     <span class="m">3</span>            <span class="m">3</span>           14h   <span class="nv">app</span><span class="o">=</span>client2
</span></span><span class="line"><span class="cl">demodeployment   3/3     <span class="m">3</span>            <span class="m">3</span>           15h   <span class="nv">app</span><span class="o">=</span>demodeployment
</span></span><span class="line"><span class="cl">yumemaru@azure:~$ <span class="nb">export</span> <span class="nv">client1</span><span class="o">=</span><span class="k">$(</span>k get ciliumendpoints.cilium.io -l <span class="nv">app</span><span class="o">=</span>client1 -o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].status.identity.id}&#39;</span><span class="k">)</span>id<span class="o">}</span><span class="s1">&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s1">yumemaru@azure:~$ export client2Id=$(k get ciliumendpoints.cilium.io -l app=client2 -o=jsonpath=&#39;</span><span class="o">{</span>.items<span class="o">[</span>0<span class="o">]</span>.status.identity.id<span class="o">}</span><span class="s1">&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s1">yumemaru@azure:~$ export demoId=$(k get ciliumendpoints.cilium.io -l app=demodeployment -o=jsonpath=&#39;</span><span class="o">{</span>.items<span class="o">[</span>0<span class="o">]</span>.status.identity.id<span class="o">}</span><span class="err">&#39;</span><span class="o">)</span>
</span></span></code></pre></div><p>在 SPIRE 服务器 pod 内部，我们现在可以检查每个工作负载对应的身份：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server entry show -spiffeID spiffe://spiffe.cilium/identity/<span class="nv">$client1Id</span>
</span></span><span class="line"><span class="cl">Found <span class="m">1</span> entry
</span></span><span class="line"><span class="cl">Entry ID         : 7bf9a3b0-a06c-480e-8f0c-1fd654d3ec56
</span></span><span class="line"><span class="cl">SPIFFE ID        : spiffe://spiffe.cilium/identity/76513
</span></span><span class="line"><span class="cl">Parent ID        : spiffe://spiffe.cilium/cilium-operator
</span></span><span class="line"><span class="cl">Revision         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">X509-SVID TTL    : default
</span></span><span class="line"><span class="cl">JWT-SVID TTL     : default
</span></span><span class="line"><span class="cl">Selector         : cilium:mutual-auth
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server entry show -spiffeID spiffe://spiffe.cilium/identity/<span class="nv">$client2Id</span>
</span></span><span class="line"><span class="cl">Found <span class="m">1</span> entry
</span></span><span class="line"><span class="cl">Entry ID         : 62b158d0-c90b-449a-9b30-a8a24ba012ba
</span></span><span class="line"><span class="cl">SPIFFE ID        : spiffe://spiffe.cilium/identity/77602
</span></span><span class="line"><span class="cl">Parent ID        : spiffe://spiffe.cilium/cilium-operator
</span></span><span class="line"><span class="cl">Revision         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">X509-SVID TTL    : default
</span></span><span class="line"><span class="cl">JWT-SVID TTL     : default
</span></span><span class="line"><span class="cl">Selector         : cilium:mutual-auth
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yumemaru@azure:~$ kubectl <span class="nb">exec</span> -n cilium-spire spire-server-0 -c spire-server -- /opt/spire/bin/spire-server entry show -spiffeID spiffe://spiffe.cilium/identity/<span class="nv">$demoId</span>
</span></span><span class="line"><span class="cl">Found <span class="m">1</span> entry
</span></span><span class="line"><span class="cl">Entry ID         : 07f27f3c-7a94-450b-aecc-bb006f57b97e
</span></span><span class="line"><span class="cl">SPIFFE ID        : spiffe://spiffe.cilium/identity/108597
</span></span><span class="line"><span class="cl">Parent ID        : spiffe://spiffe.cilium/cilium-operator
</span></span><span class="line"><span class="cl">Revision         : <span class="m">0</span>
</span></span><span class="line"><span class="cl">X509-SVID TTL    : default
</span></span><span class="line"><span class="cl">JWT-SVID TTL     : default
</span></span><span class="line"><span class="cl">Selector         : cilium:mutual-auth
</span></span></code></pre></div><p>但也可以直接作为 cilium api 对象查看身份。以下是 <code>client1</code> 应用的结果：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemary@azure:~$ k describe ciliumidentities.cilium.io <span class="nv">$client1Id</span> 
</span></span><span class="line"><span class="cl">Name:         <span class="m">76513</span>
</span></span><span class="line"><span class="cl">Namespace:    
</span></span><span class="line"><span class="cl">Labels:       <span class="nv">app</span><span class="o">=</span>client1
</span></span><span class="line"><span class="cl">              io.cilium.k8s.policy.cluster<span class="o">=</span>cluster1
</span></span><span class="line"><span class="cl">              io.cilium.k8s.policy.serviceaccount<span class="o">=</span>default
</span></span><span class="line"><span class="cl">              io.kubernetes.pod.namespace<span class="o">=</span>default
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">API Version:  cilium.io/v2
</span></span><span class="line"><span class="cl">Kind:         CiliumIdentity
</span></span><span class="line"><span class="cl">Metadata:
</span></span><span class="line"><span class="cl">  Creation Timestamp:  2024-07-30T16:46:43Z
</span></span><span class="line"><span class="cl">  Generation:          <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Resource Version:    <span class="m">224640</span>
</span></span><span class="line"><span class="cl">  UID:                 433dd70b-58ba-41c0-abef-c9d5785eaddb
</span></span><span class="line"><span class="cl">Security - Labels:
</span></span><span class="line"><span class="cl">  k8s:app:                                                         client1
</span></span><span class="line"><span class="cl">  k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name:  default
</span></span><span class="line"><span class="cl">  k8s:io.cilium.k8s.policy.cluster:                                cluster1
</span></span><span class="line"><span class="cl">  k8s:io.cilium.k8s.policy.serviceaccount:                         default
</span></span><span class="line"><span class="cl">  k8s:io.kubernetes.pod.namespace:                                 default
</span></span><span class="line"><span class="cl">Events:                                                            &lt;none&gt;
</span></span></code></pre></div><p>我们会注意到 Cilium 身份名称、Cilium 端点上显示的安全身份和我们在 SPIRE 服务器上得到的 SPIFFE ID <code>spiffe://spiffe.cilium/identity/76513</code> 之间的对应关系。</p>
<p>那很好。现在，我们如何强制执行相互认证呢？实际上很简单，我们只需要在 Cilium 网络策略中添加适当的参数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">authentication</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;required&#34;</span><span class="w">
</span></span></span></code></pre></div><p>让我们编写 3 个网络策略：</p>
<ul>
<li>首先，按应有的方式，一个拒绝所有策略。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;demo1-default-deny&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Default-deny ingress policy for demo app&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpointSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">demodeployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {}<span class="w">
</span></span></span></code></pre></div><ul>
<li>其次，一个允许 app1 流量到 demo 应用的策略。</li>
<li>第三，一个网络策略允许 app2 到 demo 应用，但这次需要认证。</li>
</ul>
<p>如果我们仅应用第一个策略，我们应该无法再访问 demo 应用。这可以通过 <code>hubble observe</code> 命令看到</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemary@azure:~$ k <span class="nb">exec</span> deployments/client1 -- curl -i -X GET http://demodeployment
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl">  <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:--  0:02:09 --:--:--     <span class="m">0</span>
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to demodeployment port <span class="m">80</span> after <span class="m">129180</span> ms: Couldn<span class="err">&#39;</span>t connect to server
</span></span><span class="line"><span class="cl"><span class="nb">command</span> terminated with <span class="nb">exit</span> code <span class="m">28</span>
</span></span><span class="line"><span class="cl">yumemary@azure:~$ hubble observe --to-label <span class="nv">app</span><span class="o">=</span>demodeployment
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 09:54:42.541: default/client1-599c487979-t8728:54548 <span class="o">(</span>ID:76513<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-pmzkm:80 <span class="o">(</span>ID:108597<span class="o">)</span> to-overlay FORWARDED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span></code></pre></div><p>然而，我们仍然可以访问 client2 部署的一个 pod，因为我们只针对其标签的 demo 应用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemary@azure:~$ k get pod -o custom-columns<span class="o">=</span>Name:.metadata.name,PodIp:.status.podIP,HostIp:.status.hostIP
</span></span><span class="line"><span class="cl">Name                             PodIp          HostIp
</span></span><span class="line"><span class="cl">client1-599c487979-dqm4v         100.64.1.197   172.21.14.69
</span></span><span class="line"><span class="cl">client1-599c487979-qqzvl         100.64.0.206   172.21.14.68
</span></span><span class="line"><span class="cl">client1-599c487979-t8728         100.64.2.214   172.21.14.70
</span></span><span class="line"><span class="cl">client2-d64dd865b-cj56m          100.64.0.77    172.21.14.68
</span></span><span class="line"><span class="cl">client2-d64dd865b-kb7cs          100.64.1.51    172.21.14.69
</span></span><span class="line"><span class="cl">client2-d64dd865b-qskqc          100.64.2.25    172.21.14.70
</span></span><span class="line"><span class="cl">client3-6fbfd96c6f-bwhqh         100.64.1.150   172.21.14.69
</span></span><span class="line"><span class="cl">client3-6fbfd96c6f-cfhhv         100.64.0.91    172.21.14.68
</span></span><span class="line"><span class="cl">client3-6fbfd96c6f-wldx5         100.64.2.95    172.21.14.70
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-6s4xn   100.64.0.124   172.21.14.68
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-pmzkm   100.64.1.244   172.21.14.69
</span></span><span class="line"><span class="cl">demodeployment-bf5d895b5-vz4gq   100.64.2.127   172.21.14.70
</span></span><span class="line"><span class="cl">yumemary@azure:~$ k <span class="nb">exec</span> deployments/client1 -- curl -i -X GET http://100.64.2.25
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl"><span class="m">100</span>   <span class="m">615</span>  <span class="m">100</span>   <span class="m">615</span>    <span class="m">0</span>     <span class="m">0</span>   499k      <span class="m">0</span> --:--:-- --:--:-- --:--:--  600k
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Server: nginx/1.27.0
</span></span><span class="line"><span class="cl">Date: Wed, <span class="m">31</span> Jul <span class="m">2024</span> 10:01:58 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">615</span>
</span></span><span class="line"><span class="cl">Last-Modified: Tue, <span class="m">28</span> May <span class="m">2024</span> 13:22:30 GMT
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">ETag: <span class="s2">&#34;6655da96-267&#34;</span>
</span></span><span class="line"><span class="cl">Accept-Ranges: bytes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><h3 id="实施策略-2-和-3">实施策略 2 和 3</h3>
<p>现在我们来从客户端 1 和客户端 2 使用命令 <code>kubectl exec deployments/&lt;deploymentname&gt; -- curl -i -X GET http://demodeployment</code> 访问 demo 应用，我们可以通过 hubble 观察到客户端 1 的流量被授权：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemary@azure:~$ hubble observe --to-label <span class="nv">app</span><span class="o">=</span>demodeployment --from-label <span class="nv">app</span><span class="o">=</span>client1
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:33:48.647: default/client1-599c487979-t8728:54594 <span class="o">(</span>ID:76513<span class="o">)</span> &lt;&gt; default/demodeployment-bf5d895b5-vz4gq <span class="o">(</span>ID:108597<span class="o">)</span> pre-xlate-rev TRACED <span class="o">(</span>TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:33:48.647: default/client1-599c487979-t8728 <span class="o">(</span>ID:76513<span class="o">)</span> &lt;&gt; default/demodeployment-bf5d895b5-vz4gq:80 <span class="o">(</span>ID:108597<span class="o">)</span> post-xlate-fwd TRANSLATED <span class="o">(</span>TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:33:48.647: default/client1-599c487979-t8728:54594 <span class="o">(</span>ID:76513<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-vz4gq:80 <span class="o">(</span>ID:108597<span class="o">)</span> policy-verdict:L3-L4 INGRESS ALLOWED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:33:48.647: default/client1-599c487979-t8728:54594 <span class="o">(</span>ID:76513<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-vz4gq:80 <span class="o">(</span>ID:108597<span class="o">)</span> to-endpoint FORWARDED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:33:48.647: default/client1-599c487979-t8728:54594 <span class="o">(</span>ID:76513<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-vz4gq:80 <span class="o">(</span>ID:108597<span class="o">)</span> to-endpoint FORWARDED <span class="o">(</span>TCP Flags: ACK<span class="o">)</span>
</span></span></code></pre></div><p>以及客户端 2 的认证步骤：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yumemary@azure:~$ hubble observe --to-label <span class="nv">app</span><span class="o">=</span>demodeployment --from-label <span class="nv">app</span><span class="o">=</span>client2
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:18.651: default/client2-d64dd865b-qskqc <span class="o">(</span>ID:77602<span class="o">)</span> &lt;&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> post-xlate-fwd TRANSLATED <span class="o">(</span>TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:18.651: default/client2-d64dd865b-qskqc:50986 <span class="o">(</span>ID:77602<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> to-overlay FORWARDED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:18.651: default/client2-d64dd865b-qskqc:50986 <span class="o">(</span>ID:77602<span class="o">)</span> &lt;&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> policy-verdict:L3-L4 INGRESS DENIED <span class="o">(</span>TCP Flags: SYN<span class="p">;</span> Auth: SPIRE<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:18.651: default/client2-d64dd865b-qskqc:50986 <span class="o">(</span>ID:77602<span class="o">)</span> &lt;&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> Authentication required DROPPED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:19.661: default/client2-d64dd865b-qskqc:50986 <span class="o">(</span>ID:77602<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> policy-verdict:L3-L4 INGRESS ALLOWED <span class="o">(</span>TCP Flags: SYN<span class="p">;</span> Auth: SPIRE<span class="o">)</span>
</span></span><span class="line"><span class="cl">Jul <span class="m">31</span> 11:35:19.661: default/client2-d64dd865b-qskqc:50986 <span class="o">(</span>ID:77602<span class="o">)</span> -&gt; default/demodeployment-bf5d895b5-6s4xn:80 <span class="o">(</span>ID:108597<span class="o">)</span> to-endpoint FORWARDED <span class="o">(</span>TCP Flags: SYN<span class="o">)</span>
</span></span></code></pre></div><p>到此为止就是所有的内容了。让我们来总结一下。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。这一功能依赖于实现 SPIFFE 框架的 SPIRE 服务器部署。之后，实际上非常简单。网络策略中的简单规范确保了工作负载间的身份验证。而且在 hubble 上也很容易看到这一点。下一步应该是在 hubble 部分以及 SPIRE 服务器上配置更多的监控。这就是为什么在图表配置中添加了与指标相关的值。目前这对我来说还不起作用，所以我稍后还得回来处理这个问题。还需要对 SPIRE 服务器的可观测性进行一些思考。可能查看 loki 或类似工具的日志会很不错。但那将是下一次的内容。</p>

            <div class="border-bottom mb-2"></div>
          </div>

          <div class="col-12">
            <p>最后更新于 2024/08/26</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/tags/cilium" class="badge"> 
                  Cilium</a> 
              <a href="/tags/%e5%ae%89%e5%85%a8" class="badge">  
                  安全</a> 
              <a href="/tags/spire" class="badge">  
                  SPIRE</a> 
              <a href="/tags/spiffe" class="badge">  
                  SPIFFE</a> </div>
          </div>

          
          <div class="col-12">
            









    

    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    






    



    


<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/blog/envoy-gateway-integration-istio-mesh/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; 上一篇</span>
            <span class="text-align-left">集成 Envoy Gateway 作为 Istio 服务网格中的入口网关</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/blog/istio-configuration-safety-common-misconfigurations/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">下一篇 &rarr;</span>
            <span class="text-align-right">Istio 配置安全：如何避免错误配置</span>
        </a>
    </div>
     
</div>

          </div>

          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="zh-CN"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          











<div>
  <p class="related-sidebar-title">
  相关文章
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/blog/how-to-integrate-spire-with-istio/">
            如何在 Istio 中集成 SPIRE？
          </a>
      </li>
    
      <li>
          <a href="/blog/cert-manager-spire-istio/">
            使用 cert-manager 和 SPIRE 管理 Istio 中的证书
          </a>
      </li>
    
      <li>
          <a href="/blog/why-istio-need-spire/">
            为什么 Istio 要使用 SPIRE 做身份认证？
          </a>
      </li>
    
      <li>
          <a href="/blog/istio-configuration-safety-common-misconfigurations/">
            Istio 配置安全：如何避免错误配置
          </a>
      </li>
    
      <li>
          <a href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">
            保障 Istio 安全：解决关键安全漏洞及最佳实践
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#cilium-认证功能">Cilium 认证功能</a>
      <ul>
        <li><a href="#为什么我们需要认证">为什么我们需要认证</a></li>
        <li><a href="#cilium-认证功能的底层原理">Cilium 认证功能的底层原理</a></li>
      </ul>
    </li>
    <li><a href="#尝试-cilium-认证">尝试 Cilium 认证</a>
      <ul>
        <li><a href="#准备环境">准备环境</a></li>
        <li><a href="#使用相互认证">使用相互认证</a></li>
        <li><a href="#实施策略-2-和-3">实施策略 2 和 3</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/black-myth-wukong-game-life/">从黑神话悟空聊起：我心目中的 3A 大作</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-gateway-integration-istio-mesh/">集成 Envoy Gateway 作为 Istio 服务网格中的入口网关</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-configuration-safety-common-misconfigurations/">Istio 配置安全：如何避免错误配置</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 大连云原生技术开放日</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
