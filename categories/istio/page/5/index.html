<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Istio ä¸“æ  - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="æ¬¢è¿æ¥åˆ° Istio ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼ Istio çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»å…¥é—¨åˆ°é«˜çº§ä½¿ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€ç­–ç•¥æ‰§è¡Œå’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±ç”¨æˆ·ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Istioï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§å’Œå¯ç®¡ç†æ€§ã€‚">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/categories/istio/" />
  <meta property="og:title" content="Istio ä¸“æ  | Jimmy Song" />
  <meta property="twitter:title" content="Istio ä¸“æ  | Jimmy Song" />

  
  <meta property="og:description" content="æ¬¢è¿æ¥åˆ° Istio ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼ Istio çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»å…¥é—¨åˆ°é«˜çº§ä½¿ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€ç­–ç•¥æ‰§è¡Œå’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±ç”¨æˆ·ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Istioï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§å’Œå¯ç®¡ç†æ€§ã€‚" />
  <meta property="twitter:description" content="æ¬¢è¿æ¥åˆ° Istio ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼ Istio çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»å…¥é—¨åˆ°é«˜çº§ä½¿ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€ç­–ç•¥æ‰§è¡Œå’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±ç”¨æˆ·ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Istioï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§å’Œå¯ç®¡ç†æ€§ã€‚" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">åšå®¢</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">èµ„æ–™</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">å…¬å‘Š</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">è”ç³»</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">å…³äº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">ç¤¾åŒº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">è§†é¢‘ <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/categories/istio/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>æœç´¢</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">âŒ˜</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>ç«™å†…æœç´¢</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="å…³é—­"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="è¯·è¾“å…¥æœç´¢è¯" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="è¯·è¾“å…¥æœç´¢è¯">
        
        <div class="mt-4">
          <span>æœç´¢ç±»å‹: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">æ‰€æœ‰</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">åŸåˆ›</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">è¯‘æ–‡</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">èµ„æ–™</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">å…¬å‘Š</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Istio ä¸“æ 
                </p>
                <p class="page-description">
                    æ¬¢è¿æ¥åˆ° Istio ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼ Istio çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»å…¥é—¨åˆ°é«˜çº§ä½¿ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€ç­–ç•¥æ‰§è¡Œå’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±ç”¨æˆ·ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Istioï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§å’Œå¯ç®¡ç†æ€§ã€‚
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/implementing-gitops-and-canary-deployment-with-argo-project-and-istio/">ä½¿ç”¨ Argo é¡¹ç›® Istio åŠ SkyWalking å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/10/21</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä½¿ç”¨ Argo é¡¹ç›® Istio åŠ SkyWalking å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²', 'æœ¬æ–‡è®¨è®ºå¦‚ä½•ä½¿ç”¨ Kubernetes Deploymentã€Argo é¡¹ç›®å’Œ Istio æ¥å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚', '\n{{\u003ccallout note å…³äºæœ¬æ–‡\u003e}}\n\næœ¬æ–‡æ ¹æ®ç¬”è€…åœ¨ KubeCon\u0026CloudNativeCon China 2023 çš„é€šè¯ä»“æ´»åŠ¨ [IstioCon China](https:\/\/istioconchina2023.sched.com\/event\/1RoVG\/nano-argo-istio-re-skywalking-jiong-gitops-reqi-zha-yao-pi-how-to-achieve-the-perfect-union-of-gitops-and-observability-with-argo-istio-and-skywalking-jimmy-song-tetrate) ä¸Šçš„åˆ†äº«æ•´ç†è€Œæˆï¼ŒåŸæ ‡é¢˜ä¸ºã€Šå¦‚ä½•åœ¨ Argoã€Istio å’Œ SkyWalking ä¸­å®ç° GitOps å’Œå¯è§‚æµ‹æ€§çš„å®Œç¾ç»“åˆã€‹ã€‚\n\n{{\u003c\/callout\u003e}}\n\näº‘åŸç”Ÿåº”ç”¨çš„å‘å±•å¯¼è‡´å¼€å‘å·¦ç§»ï¼Œåº”ç”¨è¿­ä»£é¢‘ç‡æ›´é«˜ï¼Œè¿™å°±å‚¬ç”Ÿäº† GitOps çš„éœ€æ±‚ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Argo é¡¹ç›®ï¼ŒåŒ…æ‹¬ ArgoCD å’Œ Argo Rolloutsï¼Œé€šè¿‡ Istio å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚æ–‡ä¸­è¿˜æœ‰ä¸€ä¸ªæ¼”ç¤ºï¼Œå±•ç¤ºäº†å¦‚ä½•åŸºäº Tetrate Service Expressï¼ˆä¹Ÿé€‚ç”¨äº Tetrate Service Bridgeï¼‰æä¾›çš„ Istio ç¯å¢ƒå®ç° GitOpsã€‚\n\næœ¬æ–‡ demo çš„éƒ¨ç½²æ¶æ„å›¾å¦‚å›¾ 1 æ‰€ç¤ºã€‚å¦‚æœæ‚¨å·²ç»ç†Ÿæ‚‰æœ¬æ–‡ä»‹ç»çš„éƒ¨ç½²ç­–ç•¥å’Œ Argo é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥è·³åˆ° [demo éƒ¨åˆ†](#demo)ã€‚\n\n![å›¾ 1ï¼šåœ¨ TSE\/TSB ä¸­ä½¿ç”¨ Istio å’Œ Argo é¡¹ç›®å®ç° GitOps å’Œé‡‘ä¸é›€å‘å¸ƒçš„æ¶æ„å›¾](f1.svg)\n\n## éƒ¨ç½²ç­–ç•¥ {#deployment-strategy}\n\né¦–å…ˆï¼Œæˆ‘æƒ³ç®€å•ä»‹ç»ä¸€ä¸‹ Argo Rollouts æ”¯æŒçš„ä¸¤ç§éƒ¨ç½²ç­–ç•¥ï¼Œå¯ä»¥å®ç°é›¶åœæœºéƒ¨ç½²ã€‚\n\nè“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²çš„æ­¥éª¤å¦‚å›¾ 2 æ‰€ç¤ºã€‚\n\n![Figure 2: Steps of blue-green deployment and canary deployment](f2.svg)\n\n- è“ç»¿éƒ¨ç½²æ˜¯ä¸€ç§åœ¨å•ç‹¬çš„ç¯å¢ƒä¸­å¹¶è¡Œéƒ¨ç½²æ–°ç‰ˆæœ¬åº”ç”¨ç¨‹åºè€Œä¸å½±å“å½“å‰ç”Ÿäº§ç¯å¢ƒçš„ç­–ç•¥ã€‚åœ¨è“ç»¿éƒ¨ç½²ä¸­ï¼Œå½“å‰çš„ç”Ÿäº§ç¯å¢ƒç§°ä¸ºâ€œè“è‰²ç¯å¢ƒâ€ï¼Œéƒ¨ç½²æ–°ç‰ˆæœ¬åº”ç”¨ç¨‹åºçš„ç¯å¢ƒç§°ä¸ºâ€œç»¿è‰²ç¯å¢ƒâ€ã€‚ä¸€æ—¦ç»¿è‰²ç¯å¢ƒè¢«è®¤ä¸ºç¨³å®šå¹¶é€šè¿‡æµ‹è¯•ï¼Œæµé‡å°†é€æ¸ä»è“è‰²ç¯å¢ƒåˆ‡æ¢åˆ°ç»¿è‰²ç¯å¢ƒï¼Œè®©ç”¨æˆ·é€æ­¥æ¥å…¥æ–°ç‰ˆæœ¬ã€‚å¦‚æœåˆ‡æ¢è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šåˆ°è“ç¯å¢ƒï¼Œæœ€å¤§ç¨‹åº¦åœ°å‡å°‘å¯¹ç”¨æˆ·çš„å½±å“ã€‚è“ç»¿éƒ¨ç½²çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æä¾›é«˜å¯ç”¨æ€§å’Œé›¶åœæœºéƒ¨ç½²ã€‚\n- é‡‘ä¸é›€éƒ¨ç½²æ˜¯ä¸€ç§é€æ­¥å°†æ–°ç‰ˆæœ¬æˆ–åŠŸèƒ½å¼•å…¥ç”Ÿäº§ç¯å¢ƒçš„ç­–ç•¥ã€‚åœ¨é‡‘ä¸é›€éƒ¨ç½²ä¸­ï¼Œæ–°ç‰ˆæœ¬æˆ–æ–°åŠŸèƒ½é¦–å…ˆéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­çš„å°‘æ•°ç”¨æˆ·ï¼Œç§°ä¸ºâ€œé‡‘ä¸é›€ç”¨æˆ·â€ã€‚é€šè¿‡ç›‘æ§é‡‘ä¸é›€ç”¨æˆ·çš„åé¦ˆå’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå¼€å‘å›¢é˜Ÿå¯ä»¥è¯„ä¼°æ–°ç‰ˆæœ¬æˆ–åŠŸèƒ½çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥é€æ­¥å°†æ›´å¤šç”¨æˆ·çº³å…¥é‡‘ä¸é›€éƒ¨ç½²ä¸­ï¼Œç›´åˆ°æ‰€æœ‰ç”¨æˆ·éƒ½ä½¿ç”¨æ–°ç‰ˆæœ¬ã€‚å¦‚æœå‘ç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šæˆ–ä¿®å¤ï¼Œé¿å…å¯¹æ•´ä¸ªç”¨æˆ·ç¾¤é€ æˆè´Ÿé¢å½±å“ã€‚é‡‘ä¸é›€éƒ¨ç½²çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å¿«é€Ÿå‘ç°é—®é¢˜å¹¶åœ¨å½±å“è¾ƒå°çš„èŒƒå›´å†…è¿›è¡Œè°ƒæ•´ã€‚\n\nè“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²çš„ä¸»è¦åŒºåˆ«åœ¨äºéƒ¨ç½²æ–¹å¼å’Œå˜æ›´è§„æ¨¡ã€‚è“ç»¿éƒ¨ç½²æ˜¯å°†æ•´ä¸ªåº”ç”¨éƒ¨ç½²åœ¨æ–°çš„ç¯å¢ƒä¸­ï¼Œç„¶åè¿›è¡Œåˆ‡æ¢ï¼Œé€‚åˆå¤§è§„æ¨¡çš„å˜æ›´ï¼Œæ¯”å¦‚æ•´ä¸ªåº”ç”¨çš„é‡å¤§å‡çº§ã€‚é‡‘ä¸é›€éƒ¨ç½²é€æ¸å¼•å…¥æ–°ç‰ˆæœ¬æˆ–åŠŸèƒ½ï¼Œé€‚åˆå°è§„æ¨¡æ›´æ”¹ï¼Œä¾‹å¦‚æ·»åŠ æˆ–ä¿®æ”¹å•ä¸ªåŠŸèƒ½ã€‚\n\nä»åº”ç”¨åœºæ™¯æ¥çœ‹ï¼Œè“ç»¿éƒ¨ç½²é€‚åˆå¯¹é«˜å¯ç”¨ã€é›¶å®•æœºéƒ¨ç½²è¦æ±‚è¾ƒé«˜çš„ç³»ç»Ÿã€‚åœ¨éƒ¨ç½²å¤§è§„æ¨¡å˜æ›´æ—¶ï¼Œè“ç»¿éƒ¨ç½²å¯ä»¥ä¿è¯ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œå¹¶ä¸”å¯ä»¥å¿«é€Ÿå›æ»šä»¥åº”å¯¹çªå‘æƒ…å†µã€‚é‡‘ä¸é›€éƒ¨ç½²é€‚åˆéœ€è¦å¿«é€ŸéªŒè¯æ–°åŠŸèƒ½æˆ–ç‰ˆæœ¬çš„ç³»ç»Ÿã€‚é€šè¿‡é€æ­¥å¼•å…¥å˜æ›´ï¼Œå¯ä»¥åŠæ—©å‘ç°é—®é¢˜å¹¶è¿›è¡Œè°ƒæ•´ï¼Œå°½é‡å‡å°‘å¯¹ç”¨æˆ·çš„å½±å“ã€‚\n\n## Kubernetes Deployment çš„å‘å¸ƒç­–ç•¥ {#kuberentes-deployment}\n\nåœ¨ Kubernetes ä¸­ï¼ŒDeployment èµ„æºå¯¹è±¡æ˜¯ç®¡ç†åº”ç”¨ç¨‹åºéƒ¨ç½²å’Œæ›´æ–°çš„ä¸»è¦å·¥å…·ä¹‹ä¸€ã€‚éƒ¨ç½²æä¾›äº†ä¸€ç§å£°æ˜å¼æ–¹å¼æ¥å®šä¹‰åº”ç”¨ç¨‹åºçš„é¢„æœŸçŠ¶æ€ï¼Œå¹¶é€šè¿‡æ§åˆ¶å™¨çš„åŠŸèƒ½å®ç°å‘å¸ƒç­–ç•¥ã€‚Deployment çš„æ¶æ„å¦‚å›¾ 3 æ‰€ç¤ºï¼Œå…¶ä¸­å½©è‰²æ–¹å—ä»£è¡¨ä¸åŒç‰ˆæœ¬çš„ Podã€‚\n\n![å›¾ 3ï¼šKubernetes Deployment æ¶æ„å›¾](f3.svg)\n\nå‘å¸ƒç­–ç•¥å¯ä»¥åœ¨ Deployment çš„ spec å­—æ®µä¸­é…ç½®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å‘å¸ƒç­–ç•¥é€‰é¡¹ï¼š\n\n1. ReplicaSet çš„ç®¡ç†ï¼šDeployment ä½¿ç”¨ ReplicaSet æ¥åˆ›å»ºå’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å‰¯æœ¬ã€‚å¯ä»¥é€šè¿‡è®¾ç½® \u0060spec.replicas\u0060 å­—æ®µæ¥æŒ‡å®šæ‰€éœ€çš„å‰¯æœ¬æ•°é‡ã€‚åœ¨å‘å¸ƒè¿‡ç¨‹ä¸­ï¼ŒKubernetes æ§åˆ¶å™¨ä¿è¯æ–°ç‰ˆæœ¬ ReplicaSet çš„å‰¯æœ¬æ•°é‡åœ¨åˆ›å»ºæ—¶é€æ¸å¢åŠ ï¼Œæ—§ç‰ˆæœ¬ ReplicaSet çš„å‰¯æœ¬æ•°é‡åœ¨åˆ é™¤æ—¶é€æ¸å‡å°‘ï¼Œå®ç°å¹³æ»‘åˆ‡æ¢ã€‚\n2. æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼šéƒ¨ç½²æ”¯æŒå¤šç§æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® \u0060spec.strategy.type\u0060 å­—æ®µæ¥é€‰æ‹©ã€‚å¸¸è§æ”¿ç­–åŒ…æ‹¬ï¼š\n   - \u0060RollingUpdate\u0060ï¼šé»˜è®¤ç­–ç•¥ä»¥ä¸€å®šçš„æ—¶é—´é—´éš”é€æ¸æ›´æ–°å‰¯æœ¬ã€‚ä¸åŒæ—¶å¯ç”¨çš„å‰¯æœ¬æ•°é‡ä»¥åŠé¢å¤–å¯ç”¨çš„å‰¯æœ¬æ•°é‡å¯ä»¥é€šè¿‡è®¾ç½® \u0060spec.strategy.rollingUpdate.maxUnavailable\u0060 å’Œ \u0060spec.strategy.rollingUpdate.maxSurge\u0060 å­—æ®µæ¥æ§åˆ¶ã€‚\n   - \u0060ReCreate\u0060ï¼šè¯¥ç­–ç•¥åœ¨æ›´æ–°è¿‡ç¨‹ä¸­é¦–å…ˆåˆ é™¤æ—§ç‰ˆæœ¬çš„æ‰€æœ‰å‰¯æœ¬ï¼Œç„¶ååˆ›å»ºæ–°ç‰ˆæœ¬çš„å‰¯æœ¬ã€‚æ­¤ç­–ç•¥å°†å¯¼è‡´åº”ç”¨ç¨‹åºåœ¨æ›´æ–°æœŸé—´æš‚æ—¶ä¸å¯ç”¨ã€‚\n3. ç‰ˆæœ¬æ§åˆ¶ï¼šDeployment é€šè¿‡ \u0060spec.template.metadata.labels\u0060 å­—æ®µä¸ºæ¯ä¸ªç‰ˆæœ¬çš„ ReplicaSet è®¾ç½®æ ‡ç­¾ï¼Œä»¥ä¾¿æ§åˆ¶å™¨å‡†ç¡®è·Ÿè¸ªå’Œç®¡ç†ã€‚è¿™æ · ReplicaSet çš„å¤šä¸ªç‰ˆæœ¬å¯ä»¥å…±å­˜ï¼Œå¹¶ä¸”å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸ªç‰ˆæœ¬çš„å‰¯æœ¬æ•°é‡ã€‚\n\né€šè¿‡ä½¿ç”¨è¿™äº›é…ç½®é€‰é¡¹ï¼ŒDeployment å¯ä»¥å®ç°ä¸åŒçš„å‘å¸ƒç­–ç•¥ã€‚æ›´æ–° Deployment å¯¹è±¡çš„ spec å­—æ®µå¯ä»¥è§¦å‘æ–°ç‰ˆæœ¬çš„å‘å¸ƒã€‚Kubernetes æ§åˆ¶å™¨ä¼šæ ¹æ®æŒ‡å®šçš„ç­–ç•¥è‡ªåŠ¨å¤„ç†å‰¯æœ¬çš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ï¼Œä»¥å®ç°å¹³æ»‘çš„åº”ç”¨æ›´æ–°å’Œéƒ¨ç½²ç­–ç•¥ã€‚\n\n## ä½¿ç”¨ ArgoCD å®æ–½ GitOps {#argocd-gitops}\n\nå¯ä»¥ä½¿ç”¨ Deployment æ¥æ‰‹åŠ¨ç®¡ç†å‘å¸ƒç­–ç•¥ï¼Œä½†è¦å®ç°è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ ArgoCD ç­‰ GitOps å·¥å…·ã€‚\n\nArgoCD æ˜¯ä¸€ä¸ªåŸºäº GitOps çš„æŒç»­äº¤ä»˜å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨åŒ–å’Œç®¡ç† Kubernetes åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€‚å®ƒä¸ºæé«˜åº”ç”¨ç¨‹åºéƒ¨ç½²çš„æ•ˆç‡å’Œå¯é æ€§æä¾›äº†ä¸€äº›å…³é”®çš„å¸®åŠ©ã€‚\n\nä»¥ä¸‹æ˜¯ ArgoCD ä¸º Kubernetes åº”ç”¨ç¨‹åºéƒ¨ç½²æä¾›çš„ä¸€äº›å¸®åŠ©ï¼š\n\n1. **å£°æ˜å¼é…ç½®**ï¼šArgoCD ä½¿ç”¨å£°æ˜å¼æ–¹å¼å®šä¹‰åº”ç”¨ç¨‹åºçš„é¢„æœŸçŠ¶æ€ï¼Œå¹¶å°†åº”ç”¨ç¨‹åºé…ç½®å­˜å‚¨åœ¨ Git å­˜å‚¨åº“ä¸­ã€‚é€šè¿‡ç‰ˆæœ¬æ§åˆ¶å’ŒæŒç»­é›†æˆ\/æŒç»­äº¤ä»˜ (CI\/CD) æµç¨‹ï¼Œå¯ä»¥è½»æ¾è·Ÿè¸ªå’Œç®¡ç†åº”ç”¨ç¨‹åºé…ç½®æ›´æ”¹ã€‚\n2. **æŒç»­éƒ¨ç½²**ï¼šArgoCD å¯ä»¥ç›‘æ§ Git å­˜å‚¨åº“ä¸­çš„é…ç½®å˜åŒ–ï¼Œå¹¶è‡ªåŠ¨å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetes ç¯å¢ƒã€‚æä¾›å¯å®šåˆ¶çš„åŒæ­¥ç­–ç•¥ï¼Œè‡ªåŠ¨è§¦å‘åº”ç”¨éƒ¨ç½²å’Œæ›´æ–°ï¼Œå®ç°æŒç»­éƒ¨ç½²ã€‚\n3. **çŠ¶æ€æ¯”è¾ƒå’Œè‡ªåŠ¨ä¿®å¤**ï¼šArgoCD å®šæœŸæ£€æŸ¥åº”ç”¨ç¨‹åºçš„å½“å‰çŠ¶æ€å¹¶å°†å…¶ä¸é¢„æœŸçŠ¶æ€è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼Œå®ƒä¼šè‡ªåŠ¨å°è¯•ä¿®å¤å¹¶å°†åº”ç”¨ç¨‹åºæ¢å¤åˆ°æ‰€éœ€çŠ¶æ€ï¼Œä»¥ç¡®ä¿é¢„æœŸçŠ¶æ€ä¸å®é™…çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚\n4. **å¤šç¯å¢ƒç®¡ç†**ï¼šArgoCD æ”¯æŒç®¡ç†å¤šä¸ª Kubernetes ç¯å¢ƒï¼Œä¾‹å¦‚å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒã€‚å¯ä»¥è½»æ¾åœ°åœ¨ä¸åŒç¯å¢ƒä¹‹é—´éƒ¨ç½²å’ŒåŒæ­¥åº”ç”¨é…ç½®ï¼Œç¡®ä¿ä¸€è‡´æ€§å’Œå¯æ§æ€§ã€‚\n\nä¸ Deployment èµ„æºå¯¹è±¡ç›¸æ¯”ï¼ŒArgoCD æä¾›äº†æ›´é«˜çº§çš„åŠŸèƒ½å’Œå·¥ä½œæµç¨‹ï¼Œè¡¥å……äº†åŸç”Ÿ Kubernetes èµ„æºå¯¹è±¡çš„åŠŸèƒ½ï¼š\n\n- **åŸºäº GitOps çš„é…ç½®ç®¡ç†**ï¼šArgoCD å°†åº”ç”¨ç¨‹åºé…ç½®å­˜å‚¨åœ¨ Git å­˜å‚¨åº“ä¸­ï¼Œä»è€Œå®ç°åŸºäº GitOps çš„é…ç½®ç®¡ç†ã€‚è¿™ç§æ–¹æ³•ç¡®ä¿é…ç½®æ›´æ”¹æ˜¯å¯è·Ÿè¸ªã€å¯å®¡è®¡çš„ï¼Œå¹¶ä¸”å¯ä»¥ä¸ç°æœ‰çš„ CI\/CD ç®¡é“é›†æˆã€‚\n\n- **è‡ªåŠ¨åŒ–éƒ¨ç½²å’ŒæŒç»­äº¤ä»˜**ï¼šArgoCD å¯ä»¥è‡ªåŠ¨æ£€æµ‹ Git å­˜å‚¨åº“ä¸­çš„é…ç½®æ›´æ”¹å¹¶å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Kubernetes ç¯å¢ƒï¼Œä»è€Œå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²å’ŒæŒç»­äº¤ä»˜ã€‚\n\n- **çŠ¶æ€ç®¡ç†å’Œè‡ªåŠ¨æ¢å¤**ï¼šArgoCD æŒç»­ç›‘æ§åº”ç”¨ç¨‹åºçš„çŠ¶æ€å¹¶å°†å…¶ä¸é¢„æœŸçŠ¶æ€è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ£€æµ‹åˆ°ä¸ä¸€è‡´ï¼Œå®ƒä¼šè‡ªåŠ¨æ¢å¤å¹¶ç¡®ä¿åº”ç”¨ç¨‹åºçŠ¶æ€ä¸é¢„æœŸçŠ¶æ€ä¿æŒä¸€è‡´ã€‚\n\n## ä½¿ç”¨ Istio å®ç°ç»†ç²’åº¦çš„æµé‡è·¯ç”± {#istio-routing-traffic}\n\nè™½ç„¶ ArgoCD å¯ä»¥å®ç° GitOpsï¼Œä½†å®ƒæœ¬è´¨ä¸Šæ˜¯åœ¨ Kubernetes éƒ¨ç½²ä¸Šè¿è¡Œå¹¶é€šè¿‡å‰¯æœ¬æ•°é‡æ§åˆ¶æµé‡è·¯ç”±ã€‚ä¸ºäº†å®ç°ç»†ç²’åº¦çš„æµé‡è·¯ç”±ï¼Œä½¿ç”¨äº† Istio ç­‰æœåŠ¡ç½‘æ ¼ã€‚\n\nIstio é€šè¿‡ä»¥ä¸‹æ–¹æ³•å®ç°æ›´ç»†ç²’åº¦çš„æµé‡è·¯ç”±å’Œåº”ç”¨å‘å¸ƒï¼š\n\n**VirtualService**ï¼šIstio ä½¿ç”¨ VirtualService æ¥å®šä¹‰æµé‡è·¯ç”±è§„åˆ™ã€‚é€šè¿‡é…ç½® VirtualServiceï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚å¤´ã€è·¯å¾„ã€æƒé‡ç­‰è¯·æ±‚å±æ€§å¯¹æµé‡è¿›è¡Œè·¯ç”±å’Œåˆ†å‘ï¼Œå°†è¯·æ±‚å®šå‘åˆ°ä¸åŒçš„æœåŠ¡å®ä¾‹æˆ–ç‰ˆæœ¬ã€‚\n\n**DestinationRule**ï¼šIstio çš„ DestinationRule ç”¨äºå®šä¹‰æœåŠ¡ç‰ˆæœ¬ç­–ç•¥å’Œè´Ÿè½½å‡è¡¡è®¾ç½®ã€‚é€šè¿‡æŒ‡å®šä¸åŒç‰ˆæœ¬æœåŠ¡å®ä¾‹ä¹‹é—´ä¸åŒçš„æµé‡æƒé‡ï¼Œå¯ä»¥å®ç°é‡‘ä¸é›€å‘å¸ƒã€è“ç»¿éƒ¨ç½²ç­‰é«˜çº§åº”ç”¨å‘å¸ƒç­–ç•¥ã€‚\n\n**æµé‡æ§åˆ¶å’Œç­–ç•¥**ï¼šIstio æä¾›äº†ä¸°å¯Œçš„æµé‡æ§åˆ¶å’Œç­–ç•¥èƒ½åŠ›ï¼Œå¦‚æµé‡é™åˆ¶ã€æ•…éšœæ³¨å…¥ã€è¶…æ—¶è®¾ç½®ã€é‡è¯•æœºåˆ¶ç­‰ï¼Œè¿™äº›åŠŸèƒ½å¸®åŠ©åº”ç”¨ç¨‹åºå®ç°æ›´é«˜çº§åˆ«çš„è´Ÿè½½å‡è¡¡ã€å®¹é”™å’Œå¯é æ€§è¦æ±‚ã€‚\n\nä¸ ArgoCD å’Œ Kubernetes Deployment å¯¹è±¡ç›¸æ¯”ï¼ŒIstio åœ¨åº”ç”¨éƒ¨ç½²æ–¹é¢æä¾›äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š\n\n**ç»†ç²’åº¦çš„æµé‡è·¯ç”±æ§åˆ¶**ï¼šIstio æä¾›äº†æ›´ä¸°å¯Œçš„æµé‡è·¯ç”±èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®å¤šç§è¯·æ±‚å±æ€§è¿›è¡Œçµæ´»çš„è·¯ç”±å’Œåˆ†å‘ï¼Œä»è€Œå®ç°æ›´ç»†ç²’åº¦çš„æµé‡æ§åˆ¶å’Œç®¡ç†ã€‚\n\n**é«˜çº§å‘å¸ƒç­–ç•¥æ”¯æŒ**ï¼šIstio çš„ DestinationRule å¯ä»¥æŒ‡å®šä¸åŒç‰ˆæœ¬æœåŠ¡å®ä¾‹ä¹‹é—´çš„æµé‡æƒé‡ï¼Œæ”¯æŒé‡‘ä¸é›€å‘å¸ƒã€è“ç»¿éƒ¨ç½²ç­‰é«˜çº§åº”ç”¨å‘å¸ƒç­–ç•¥ã€‚è¿™ä½¿å¾—åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒæ›´åŠ çµæ´»å¯æ§ã€‚\n\n**å¼ºå¤§çš„æµé‡æ§åˆ¶å’Œç­–ç•¥èƒ½åŠ›**ï¼šIstio æä¾›äº†ä¸°å¯Œçš„æµé‡æ§åˆ¶å’Œç­–ç•¥èƒ½åŠ›ï¼Œå¦‚æµé‡é™åˆ¶ã€æ•…éšœæ³¨å…¥ã€è¶…æ—¶è®¾ç½®ã€é‡è¯•æœºåˆ¶ç­‰ï¼Œè¿™äº›åŠŸèƒ½å¸®åŠ©åº”ç”¨ç¨‹åºå®ç°æ›´é«˜çº§åˆ«çš„è´Ÿè½½å‡è¡¡ã€å®¹é”™å’Œå¯é æ€§è¦æ±‚ã€‚\n\nå°† Istio ä¸ Argo Rollouts ç›¸ç»“åˆï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ Istio ç»†ç²’åº¦æµé‡è·¯ç”±çš„ä¼˜åŠ¿ã€‚ç°åœ¨è®©æˆ‘ä»¬ä¸€èµ·è¿›è¡Œæ¼”ç¤ºã€‚åœ¨æˆ‘ä»¬çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ TSE æä¾›çš„ Kubernetes å’Œ Istio ç¯å¢ƒï¼Œä½¿ç”¨ ArgoCD å®ç° GitOpsï¼Œå¹¶ä½¿ç”¨ Argo Rollouts å®ç°é‡‘ä¸é›€å‘å¸ƒã€‚\n\n## Demo\n\næˆ‘ä»¬çš„æ¼”ç¤ºä¸­ä½¿ç”¨çš„è½¯ä»¶ç‰ˆæœ¬æ˜¯ï¼š\n\n-  Kubernetes v1.24.14\n-  Istio v1.15.7\n-  Argo CD v2.7.4\n-  Argo å‘å¸ƒ v1.5.1\n-  TSE Preview 2\n\næˆ‘ä»¬å°†ä½¿ç”¨ Istio çš„ VirtualService å’Œ DestinationRule æ¥å®ç°åŸºäº Subset çš„æµé‡åˆ†ç»„è·¯ç”±ï¼Œå¹¶ä½¿ç”¨ ArgoCD Rollouts è¿›è¡Œæ¸è¿›å¼å‘å¸ƒã€‚\n\n### éƒ¨ç½² ArgoCD å’Œ Argo Rollouts {#deployment-argocd-and-rollouts}\n\næˆ‘æå‰åˆ›å»ºäº†ä¸€ä¸ª Kubernetes é›†ç¾¤å¹¶å°†å…¶æ·»åŠ åˆ° TSE ä¸­ï¼ŒTSE ä¼šè‡ªåŠ¨ä¸ºé›†ç¾¤å®‰è£… Istio æ§åˆ¶å¹³é¢ã€‚æˆ‘ä»¬è¿˜éœ€è¦å®‰è£… ArgoCD å’Œ Argo Rolloutsï¼š\n\n\u0060\u0060\u0060bash\n# Install ArgoCD\nkubectl create namespace argocd\nkubectl apply -n argocd -f https:\/\/raw.githubusercontent.com\/argoproj\/argo-cd\/stable\/manifests\/install.yaml\n\n# Install ArgoCD CLI on macOS\nbrew install argocd\n\n# Change the service type of argocd-server to LoadBalancer\nkubectl patch svc argocd-server -n argocd -p \u0027{\u0022spec\u0022: {\u0022type\u0022: \u0022LoadBalancer\u0022}}\u0027\n\n# Get the ArgoCD UI address\nARGOCD_ADDR=$(kubectl get svc argocd-server -n argocd -o jsonpath=\u0027{.status.loadBalancer.ingress[0].hostname}\u0027)\n\n# Login using ArgoCD CLI, see https:\/\/argo-cd.readthedocs.io\/en\/stable\/getting_started\/#4-login-using-the-cli to get password\nargocd login $ARGOCD_ADDR --skip-test-tls --grpc-web --insecure\n\n# Install Argo Rollouts\nkubectl create namespace argo-rollouts\nkubectl apply -n argo-rollouts -f https:\/\/github.com\/argoproj\/argo-rollouts\/releases\/download\/latest\/install.yaml\n\n# Install rollouts plugin on macOS\ncurl -LO https:\/\/github.com\/argoproj\/argo-rollouts\/releases\/download\/v1.5.0\/kubectl-argo-rollouts-darwin-amd64\nchmod \u002bx .\/kubectl-argo-rollouts-darwin-amd64\nsudo mv .\/kubectl-argo-rollouts-darwin-amd64 \/usr\/local\/bin\/kubectl-argo-rollouts\n\u0060\u0060\u0060\n\nè¯¥åŠŸèƒ½ä¸é€‚ç”¨äº TSE Bridge Modeï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨ TSE Direct Mode æ¥å®ç°æ¸è¿›å¼å‘å¸ƒã€‚\n\n{{\u003ccallout note \u0022ğŸ’¡ä»€ä¹ˆæ˜¯æ¡¥æ¥æ¨¡å¼å’Œç›´æ¥æ¨¡å¼ï¼Ÿ\u0022\u003e}}\n\n\nç›´æ¥æ¨¡å¼å’Œæ¡¥æ¥æ¨¡å¼æ˜¯ TSE ä¸­æ§åˆ¶å¹³é¢ä¸‹å‘é…ç½®çš„ä¸¤ç§æ¨¡å¼ã€‚é€‚ç”¨äºæµé‡ã€å®‰å…¨ã€ç½‘å…³ç»„é…ç½®æ¨¡å¼ã€‚BRIDGED æ¨¡å¼æ˜¯ä¸€ç§æç®€æ¨¡å¼ï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨ Tetrate ç‰¹å®šçš„ API å¿«é€Ÿé…ç½®æœåŠ¡ç½‘æ ¼ä¸­æœ€å¸¸ç”¨çš„åŠŸèƒ½ï¼Œè€Œ DIRECT æ¨¡å¼ä¸ºé«˜çº§ç”¨æˆ·æä¾›æ›´å¤§çš„çµæ´»æ€§ï¼Œå…è®¸ä»–ä»¬ç›´æ¥ä½¿ç”¨ Istio API è¿›è¡Œé…ç½®ã€‚\n\n{{\u003c\/callout\u003e}}\n\næ¥ä¸‹æ¥ï¼Œéƒ¨ç½² Rollouts Dashboardï¼š\n\n\u0060\u0060\u0060bash\ngit clone https:\/\/github.com\/argoproj\/argo-rollouts.git\nkustomize build manifests\/dashboard-install|kubectl apply -n argo-rollouts -f -\nkubectl port-forward svc\/argo-rollouts-dashboard -n argo-rollouts 3100:3100\n\u0060\u0060\u0060\n\næ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ \u003chttps:\/\/localhost:3100\/rollouts\/\u003e è®¿é—® Rollouts ä»ªè¡¨æ¿ã€‚\n\n### éƒ¨ç½² Bookinfo åº”ç”¨ {#bookinfo}\n\næˆ‘ä»¬å·²ç»ä¸º Bookinfo åº”ç”¨ç¨‹åºå‡†å¤‡äº†é…ç½®æ–‡ä»¶ï¼ˆä¿å­˜åœ¨ [tse-gitops-demo](https:\/\/github.com\/tetrateio\/tse-gitops-demo\/) å­˜å‚¨åº“ä¸­ï¼‰ï¼Œæ‚¨ä¹Ÿå¯ä»¥å°†å…¶ fork åˆ°æ‚¨è‡ªå·±çš„å¸æˆ·å¹¶å°†å…¶æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å­˜å‚¨åº“ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½² Bookinfo åº”ç”¨ç¨‹åºï¼š\n\n\u0060\u0060\u0060bash\nargocd app create bookinfo-app --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path application --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated\n\u0060\u0060\u0060\n\næ³¨æ„ï¼šæˆ‘ä»¬åœ¨ [\u0060reviews\u0060 éƒ¨ç½²](https:\/\/github.com\/tetrateio\/tse-gitops-demo\/blob\/main\/application\/bookinfo.yaml#L151)ä¸­å°† \u0060replicas\u0060 è®¾ç½®ä¸º \u00600\u0060 ï¼Œå› ä¸ºæˆ‘ä»¬å°†åˆ›å»º Argo Rollouts æ¥æ“çºµ \u0060reviews\u0060 çš„å®ä¾‹æ•°é‡æœåŠ¡ã€‚å¦‚æœè¿™é‡Œè®¾ç½®ä¸ºéé›¶æ­£æ•´æ•°ï¼Œæˆ‘ä»¬å°†æ— æ³•å®ç°é‡‘ä¸é›€éƒ¨ç½²ã€‚\n\nç°åœ¨æ‚¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ ArgoCD UIï¼Œå¦‚å›¾ 4 æ‰€ç¤ºã€‚\n\n![å›¾ 4ï¼šArgoCD ç”¨æˆ·ç•Œé¢](f4.png)\n\nå¦‚æœæ‚¨å‘ç°åº”ç”¨ç¨‹åºçŠ¶æ€ä¸åŒæ­¥ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æˆ–å•å‡» UI ä¸­çš„ SYNC æŒ‰é’®ã€‚\n\n\u0060\u0060\u0060bash\nargocd app sync bookinfo-app\n\u0060\u0060\u0060\n\n## ä½¿ç”¨ Istio å®æ–½ç»†ç²’åº¦æµé‡ç®¡ç† {#istio-fine-grain-traffic-management}\n\né¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ Argo CD åˆ›å»º Istio ç›¸å…³çš„èµ„æºå¯¹è±¡ï¼š\n\n\u0060\u0060\u0060bash\nargocd app create bookinfo-tse-conf --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path argo\/tse --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated --self-heal\n\n# Check the creation status\nargocd app get bookinfo-tse-conf\n\u0060\u0060\u0060\n\n### å°† Deployment è½¬æ¢ä¸º Rollout {#convert-deployment-to-rollout}\n\nå‡è®¾æˆ‘ä»¬è¦å‘å¸ƒæ–°ç‰ˆæœ¬çš„ \u0060reviews\u0060 æœåŠ¡ã€‚ä¸ºäº†å®ç°é›¶åœæœºæ›´æ–°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é‡‘ä¸é›€éƒ¨ç½²ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. å°† \u0060reviews\u0060 Deployment çš„ \u0060replicas\u0060 å‡å°‘ä¸º 0ï¼›\n2. åˆ›å»ºå¼•ç”¨å…ˆå‰åœ¨ Bookinfo åº”ç”¨ç¨‹åºä¸­éƒ¨ç½²çš„ \u0060reviews\u0060 Deployment çš„ Rolloutï¼›\n3. å°†æµé‡å‘é€åˆ° \u0060reviews\u0060 æœåŠ¡ä»¥å®ç°è‡ªåŠ¨é‡‘ä¸é›€éƒ¨ç½²è¿›åº¦ã€‚\n\næ‚¨å¯ä»¥åœ¨ GitHub ä¸ŠæŸ¥çœ‹æœ¬æ¼”ç¤ºä¸­ä½¿ç”¨çš„ Rollout å’Œ AnalysisTemplate é…ç½®ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½² \u0060reivews-rollout\u0060 ï¼š\n\n\u0060\u0060\u0060bash\nargocd app create reviews-rollout --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path argo\/rollout --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated\n\u0060\u0060\u0060\n\næ³¨æ„ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ \u0060argocd\u0060 å‘½ä»¤æ¥éƒ¨ç½²æˆ–ä½¿ç”¨ \u0060kubectl apply\u0060 ã€‚æ¨èä½¿ç”¨ \u0060argocd\u0060 ï¼Œå› ä¸ºæ‚¨å¯ä»¥åŒæ—¶åœ¨ ArgoCD UI å’Œ Argo Rollouts Dashboard ä¸­æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨ \u0060argocd\u0060 å‘½ä»¤ç®¡ç†éƒ¨ç½²ã€‚\n\nåœ¨ Argo Rollouts Dashboard ä¸­æŸ¥çœ‹ \u0060reviews\u0060 éƒ¨ç½²çš„çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æµé‡å‘é€åˆ° \u0060reviews\u0060 æœåŠ¡ä¸€æ®µæ—¶é—´ï¼š\n\n\u0060\u0060\u0060bash\nexport GATEWAY_HOSTNAME=$(kubectl -n bookinfo get service tsb-gateway-bookinfo -o jsonpath=\u0027{.status.loadBalancer.ingress[0].hostname}\u0027)\nwhile 1;do curl -H \u0022Host: bookinfo.tetrate.com\u0022 http:\/\/$GATEWAY_HOSTNAME\/api\/v1\/products\/1\/reviews;sleep 3;done\n\u0060\u0060\u0060\n\næ‚¨å°†åœ¨è¾“å‡ºä¸­çœ‹åˆ°æ¥è‡ªå…·æœ‰ä¸åŒ rollouts-pod-template-hash æ ‡ç­¾çš„ pod çš„å“åº”ï¼Œè¿™è¯æ˜é‡‘ä¸é›€éƒ¨ç½²æ˜¯æœ‰æ•ˆçš„ã€‚å¤§çº¦ 10 åˆ†é’Ÿåï¼Œæ‚¨çœ‹åˆ°çš„ Argo Rollouts ä»ªè¡¨æ¿å°†å¦‚å›¾ 5 æ‰€ç¤ºã€‚\n\n![å›¾ 5ï¼šArgo Rollouts ä»ªè¡¨æ¿](f5.png)\n\nä»å›¾ 5 ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡‘ä¸é›€éƒ¨ç½²è¿›å±•é¡ºåˆ©ï¼Œå·²ç»åˆ°äº†ç¬¬ä¸‰æ­¥ã€‚è¿™æ˜¯å› ä¸º \u0060reviews\u0060 æœåŠ¡çš„ \u0060apdex\u0060 ï¼ˆåº”ç”¨æ€§èƒ½æŒ‡æ•°ï¼‰æŒ‡æ ‡æ­£å¸¸ã€‚æ‚¨å¯ä»¥[ä½¿ç”¨ Postman å‘ SkyWalking æäº¤ GraphQL æŸ¥è¯¢](https:\/\/tetrate.io\/blog\/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman\/)æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼Œå¦‚å›¾ 6 æ‰€ç¤ºã€‚\n\n![å›¾ 6ï¼šä½¿ç”¨ Postman å°† GraphQL æŸ¥è¯¢æäº¤åˆ° SkyWalking](f6.png)\n\næˆ‘ä»¬æ„å»ºçš„ GraphQL æŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060graphql\nquery ReadMetricsValues {\n    readMetricsValues(condition: {\n    name: \u0022service_apdex\u0022, entity: {scope: Service, serviceName: \u0022canary|reviews|bookinfo|cluster-1|-\u0022, normal: true}\n  }, duration: {\n    start: \u00222023-07-13 0812\u0022,\n    end: \u00222023-07-13 0813\u0022,\n    step: MINUTE\n  }) {\n        label\n        values {\n            values {\n                id\n                value\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nè¯¥è¯­å¥ä» UTC \u00602023-07-13 8:12\u0060 åˆ° \u00602023 8:13\u0060 æŸ¥è¯¢ \u0060canary|reviews|bookinfo|cluster-1|-\u0060 æœåŠ¡çš„ \u0060apdex\u0060 æŒ‡æ ‡ï¼ŒæŒç»­ä¸¤åˆ†é’Ÿï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š\n\n\u0060\u0060\u0060json\n{\n    \u0022data\u0022: {\n        \u0022readMetricsValues\u0022: {\n            \u0022label\u0022: null,\n            \u0022values\u0022: {\n                \u0022values\u0022: [\n                    {\n                        \u0022id\u0022: \u0022service_apdex_202307130812_Y2FuYXJ5fHJldmlld3N8Ym9va2luZm98Y2x1c3Rlci0xfC0=.1\u0022,\n                        \u0022value\u0022: 10000\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_apdex_202307130813_Y2FuYXJ5fHJldmlld3N8Ym9va2luZm98Y2x1c3Rlci0xfC0=.1\u0022,\n                        \u0022value\u0022: 10000\n                    }\n                ]\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\n\u0060apdex\u0060 æŒ‡æ ‡çš„å€¼å¤§äº 9900ï¼ˆAnalysisTemplate çš„ \u0060successCondition\u0060 ä¸­é…ç½®çš„é˜ˆå€¼ï¼‰ï¼Œå› æ­¤ Rollouts ä¼šé¡ºåˆ©è¿›è¡Œã€‚æ‚¨è¿˜å¯ä»¥åœ¨ Argo Rollouts Dashboard ä¸Šå•å‡»â€œæ‰‹åŠ¨å‡çº§â€æ¥å‡çº§å®ƒï¼Œæˆ–è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n\n\u0060\u0060\u0060bash\nkubectl argo rollouts promote reviews-rollout -n bookinf\n\u0060\u0060\u0060\n\n## æ¸…ç† {#clean-up}\n\nåˆ é™¤å·²éƒ¨ç½²çš„ ArgoCD åº”ç”¨ç¨‹åºå’Œ Rolloutï¼š\n\n\u0060\u0060\u0060bash\nargocd app delete -y reviews-rollout\nargocd app delete -y bookinfo-tse-conf\nargocd app delete -y bookinfo-app\n\u0060\u0060\u0060\n\n## Argo Rollouts åŸç† {#rollouts-principle}\n\nä¸ Istio é›†æˆæ—¶ï¼ŒArgo Rollouts æ”¯æŒåŸºäº VirtualService å’Œ Subset çš„æµé‡æ‹†åˆ†ï¼Œå¦‚å›¾ 7 æ‰€ç¤ºã€‚\n\n![å›¾ 7ï¼šArgo Rollouts ä½¿ç”¨ Istio è¿›è¡Œæµé‡åˆ†é…](f7.svg)\n\nä¸‹è¡¨æä¾›äº†è¿™ä¸¤ç§æµé‡åˆ†æ®µæ–¹æ³•çš„è¯¦ç»†æ¯”è¾ƒã€‚\n\n| ç±»å‹           | é€‚ç”¨åœºæ™¯                             | èµ„æºå¯¹è±¡                                          | åŸåˆ™                                                         |\n| :------------- | :----------------------------------- | :------------------------------------------------ | :----------------------------------------------------------- |\n| ä¸»æœºçº§æµé‡åˆ†å‰² | é€‚ç”¨äºæ ¹æ®ä¸»æœºåè®¿é—®ä¸åŒç‰ˆæœ¬çš„æœåŠ¡ï¼› | 2 ä¸ªæœåŠ¡ã€1 ä¸ªè™šæ‹ŸæœåŠ¡ã€1 ä¸ªéƒ¨ç½²ï¼›                | Rollout å°† rollouts-pod-template-hash æ ‡ç­¾æ³¨å…¥åˆ° ReplicaSet ä¸­ï¼Œå¹¶é€šè¿‡æ›´æ–° Service ä¸­çš„é€‰æ‹©å™¨æ¥é€‰æ‹©å¸¦æœ‰è¿™äº›æ ‡ç­¾çš„ podï¼› |\n| å­é›†çº§æµé‡åˆ†å‰² | é€‚ç”¨äºæ ¹æ®æ ‡ç­¾è®¿é—®ä¸åŒçš„æœåŠ¡ï¼›       | 1 ä¸ªæœåŠ¡ã€1 ä¸ªè™šæ‹ŸæœåŠ¡ã€1 ä¸ªç›®æ ‡è§„åˆ™å’Œ 1 ä¸ªè½¬å‡ºï¼› | Rollout å°† rollouts-pod-template-hash æ ‡ç­¾æ³¨å…¥åˆ° ReplicaSet ä¸­ï¼Œå¹¶é€šè¿‡æ›´æ–° DestinationRule ä¸­çš„é€‰æ‹©å™¨æ¥é€‰æ‹©å…·æœ‰è¿™äº›æ ‡ç­¾çš„ podï¼› |\n\næœ¬æ¼”ç¤ºä¸­ä½¿ç”¨åŸºäºå­é›†çš„æµé‡åˆ†å‰²ï¼ŒArgo ä¸æ–­æ¨å‡ºï¼š\n\n- ä¿®æ”¹ VirtualService \u0060spec.http[].route[].weight\u0060 ä»¥åŒ¹é…å½“å‰æ‰€éœ€çš„é‡‘ä¸é›€æƒé‡\n- ä¿®æ”¹ DestinationRule \u0060spec.subsets[].labels\u0060 ä»¥åŒ…å« canary å’Œç¨³å®š ReplicaSet çš„ \u0060rollouts-pod-template-hash\u0060 æ ‡ç­¾\n\nè¯·è®¿é—® [Argo Rollouts æ–‡æ¡£](https:\/\/argo-rollouts.readthedocs.io\/en\/stable\/features\/traffic-management\/istio\/)ï¼Œäº†è§£æœ‰å…³ä½¿ç”¨ Istio è¿›è¡Œæµé‡ç®¡ç†çš„è¯¦ç»†ä¿¡æ¯ã€‚\n\n## æ€»ç»“ {#summary}\n\næœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ Argo é¡¹ç›®å’Œ Istio å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ ArgoCD å®ç° GitOpsï¼Œç„¶åä½¿ç”¨ Argo Rollout å’Œ SkyWalking å®ç°è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒã€‚ä» demo ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° TSE éƒ¨ç½²çš„ Istio ä¸å¼€æºç‰ˆæœ¬å®Œå…¨å…¼å®¹ã€‚TSE æœ‰è®¸å¤šåŠŸèƒ½å€¼å¾—æ¢ç´¢ï¼Œè¯·è®¿é—® [Tetrate ç½‘ç«™](https:\/\/tetrate.io\/tetrate-service-express\/)äº†è§£æ›´å¤šä¿¡æ¯ã€‚\n', '\/blog\/implementing-gitops-and-canary-deployment-with-argo-project-and-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡è®¨è®ºå¦‚ä½•ä½¿ç”¨ Kubernetes Deploymentã€Argo é¡¹ç›®å’Œ Istio æ¥å®ç° GitOps å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/demystifying-the-load-balancing-in-istio/">Istio ä¸­çš„è´Ÿè½½å‡è¡¡è¯¦è§£åŠå¤šé›†ç¾¤è·¯ç”±å®è·µ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/09/07</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio ä¸­çš„è´Ÿè½½å‡è¡¡è¯¦è§£åŠå¤šé›†ç¾¤è·¯ç”±å®è·µ', 'Istio è´Ÿè½½å‡è¡¡è¯¦è§£å°¤å…¶æ˜¯å¤šé›†ç¾¤å¦‚ä½•å®ç°è·¯ç”±ä¸è´Ÿè½½å‡è¡¡çš„ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªå¤šé›†ç¾¤è·¯ç”±çš„æ¼”ç¤ºã€‚', '\n{{\u003ccallout note ç¼–è€…æŒ‰\u003e}}\n\næœ¬æ–‡ä»‹ç»äº† Istio ä¸­æ”¯æŒçš„è´Ÿè½½å‡è¡¡ç±»å‹ï¼Œç„¶åæå‡ºå¤šé›†ç¾¤ç½‘æ ¼è´Ÿè½½å‡è¡¡çš„è§£å†³æ–¹æ¡ˆã€‚å¦‚æœæ‚¨å·²ç»äº†è§£ Istio ä¸­è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥ç›´æ¥ä»[å¤šé›†ç¾¤ç½‘æ ¼ä¸­çš„è´Ÿè½½å‡è¡¡](#multicluster)éƒ¨åˆ†å¼€å§‹é˜…è¯»ã€‚\n\n{{\u003c\/callout\u003e}}\n\nåœ¨ä¹‹å‰çš„åšå®¢[ä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨äº† Kubernetes åä½ å¯èƒ½è¿˜éœ€è¦ Istio](\/blog\/why-do-you-need-istio-when-you-already-have-kubernetes\/) ä¸­æåˆ° Istio æ˜¯åœ¨ Kubernetes çš„åŸºç¡€ä¹‹ä¸Šæ„å»ºèµ·æ¥çš„ï¼ŒKubernetes ä¸­çš„ç»„ä»¶ kube-proxy æœ¬èº«å·²æœ‰è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œä½†æ˜¯åªæ”¯æŒå››å±‚æµé‡çš„è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”æ— æ³•å®ç°æœåŠ¡è¶…æ—¶ã€ç†”æ–­ç­‰é«˜çº§åŠŸèƒ½ã€‚å…·ä½“æ¥è¯´ï¼ŒæœåŠ¡ç½‘æ ¼æ¯”èµ· Kubernetes æ–°å¢äº†ä»¥ä¸‹è´Ÿè½½å‡è¡¡åŠéŸ§æ€§ï¼ˆResiliencyï¼‰ç‰¹æ€§ï¼š\n\n1. **Layer 7 è´Ÿè½½å‡è¡¡**ï¼šæœåŠ¡ç½‘æ ¼åœ¨åº”ç”¨å±‚ï¼ˆLayer 7ï¼‰æ“ä½œå’Œç®¡ç†æµé‡ï¼Œå¯ä»¥æ›´ç»†ç²’åº¦åœ°è¯†åˆ«å’Œæ§åˆ¶æµé‡ã€‚è¿™ä½¿å¾—å®ƒå¯ä»¥å®ç°æ›´é«˜çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¦‚åŸºäº HTTP è¯·æ±‚å¤´ã€URL è·¯å¾„ã€Cookie ç­‰çš„è·¯ç”±å’Œæµé‡åˆ†å‘ã€‚\n\n2. **åŠ¨æ€è´Ÿè½½å‡è¡¡**ï¼šæœåŠ¡ç½‘æ ¼é€šå¸¸å…·å¤‡è‡ªåŠ¨è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®åç«¯æœåŠ¡çš„å®æ—¶å¥åº·çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡æ¥åŠ¨æ€åˆ†å‘æµé‡ã€‚è¿™å…è®¸å®ƒå®ç°æ™ºèƒ½è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå°†æµé‡è·¯ç”±åˆ°æ€§èƒ½æœ€ä½³çš„æœåŠ¡å®ä¾‹ã€‚\n\n3. **æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šæœåŠ¡ç½‘æ ¼å…·å¤‡é«˜çº§çš„æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ã€‚å®ƒå¯ä»¥æ£€æµ‹åˆ°åç«¯æœåŠ¡å®ä¾‹çš„æ•…éšœï¼Œå¹¶è‡ªåŠ¨å°†æµé‡ä»æ•…éšœå®ä¾‹è½¬ç§»åˆ°å¥åº·å®ä¾‹ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§ã€‚\n\n4. **A\/B æµ‹è¯•å’Œé‡‘ä¸é›€å‘å¸ƒ**ï¼šæœåŠ¡ç½‘æ ¼å…è®¸å®æ–½é«˜çº§éƒ¨ç½²ç­–ç•¥ï¼Œå¦‚ A\/B æµ‹è¯•å’Œé‡‘ä¸é›€å‘å¸ƒã€‚è¿™äº›ç­–ç•¥å…è®¸åœ¨ä¸åŒçš„æœåŠ¡ç‰ˆæœ¬ä¹‹é—´åŠ¨æ€åˆ†é…æµé‡ï¼Œå¹¶æ ¹æ®ç»“æœè¿›è¡Œå†³ç­–ã€‚\n\n5. **ç†”æ–­å’Œé‡è¯•**ï¼šæœåŠ¡ç½‘æ ¼é€šå¸¸åŒ…å«ç†”æ–­å’Œé‡è¯•æœºåˆ¶ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ã€‚å®ƒå¯ä»¥æ ¹æ®åç«¯æœåŠ¡çš„æ€§èƒ½å’Œå¯ç”¨æ€§æƒ…å†µæ¥è‡ªåŠ¨æ‰§è¡Œç†”æ–­æ“ä½œï¼Œå¹¶åœ¨å¿…è¦æ—¶é‡è¯•è¯·æ±‚ã€‚\n\n6. **å…¨å±€æµé‡æ§åˆ¶**ï¼šæœåŠ¡ç½‘æ ¼æä¾›äº†é›†ä¸­å¼çš„æµé‡æ§åˆ¶å’Œç­–ç•¥å®šä¹‰ï¼Œå…è®¸å¯¹æ•´ä¸ªæœåŠ¡ç½‘æ ¼ä¸­çš„æµé‡è¿›è¡Œå…¨å±€ç®¡ç†ã€‚è¿™ä½¿å¾—å®ç°ç»Ÿä¸€çš„å®‰å…¨æ€§ã€ç›‘æ§å’Œç­–ç•¥æˆä¸ºå¯èƒ½ã€‚\n\n7. **æ·±åº¦é›†æˆçš„ç›‘æ§å’Œè¿½è¸ª**ï¼šæœåŠ¡ç½‘æ ¼é€šå¸¸é›†æˆäº†å¼ºå¤§çš„ç›‘æ§å’Œè¿½è¸ªå·¥å…·ï¼Œå¯ä»¥æä¾›æœ‰å…³æµé‡æ€§èƒ½å’Œå¯è§æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¸®åŠ©è¿›è¡Œæ•…éšœæ’é™¤å’Œæ€§èƒ½ä¼˜åŒ–ã€‚\n\nè™½ç„¶ Kubernetes æä¾›äº†åŸºæœ¬çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œä½†æœåŠ¡ç½‘æ ¼åœ¨å…¶ä¹‹ä¸Šæ„å»ºäº†æ›´é«˜çº§çš„è´Ÿè½½å‡è¡¡å’Œæµé‡ç®¡ç†åŠŸèƒ½ï¼Œä»¥æ»¡è¶³å¾®æœåŠ¡æ¶æ„ä¸­å¤æ‚çš„éœ€æ±‚ã€‚\n\n### å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ vs æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡\n\nå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æ˜¯ä¸¤ç§ä¸åŒçš„è´Ÿè½½å‡è¡¡æ–¹æ³•ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„åœºæ™¯å’Œåº”ç”¨ä¸­æœ‰å„è‡ªçš„ä¼˜åŠ¿ã€‚ä»¥ä¸‹æ˜¯å¯¹å®ƒä»¬çš„è§£é‡Šï¼Œé€‚ç”¨çš„åœºæ™¯ï¼Œå®ç°æ¡ˆä¾‹ä»¥åŠç›¸å…³çš„å¼€æºé¡¹ç›®ï¼š\n\n**å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆClient-Side Load Balancingï¼‰**\n\nå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„ç¤ºæ„å›¾å¦‚å›¾ 1 æ‰€ç¤ºã€‚\n\n![å›¾ 1ï¼šå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡](client-side-load-balancing.svg)\n\n- **å®šä¹‰**ï¼šåœ¨å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¸­ï¼Œè´Ÿè½½å‡è¡¡å†³ç­–æ˜¯ç”±æœåŠ¡çš„æ¶ˆè´¹è€…ï¼ˆå®¢æˆ·ç«¯ï¼‰æ¥åšå‡ºçš„ã€‚å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨é€šå¸¸ä¼šç»´æŠ¤ä¸€ä¸ªæœåŠ¡å®ä¾‹åˆ—è¡¨ï¼Œå¹¶æ ¹æ®é…ç½®å’Œç­–ç•¥é€‰æ‹©è¦å‘é€è¯·æ±‚çš„å®ä¾‹ã€‚\n\n- **é€‚ç”¨åœºæ™¯**ï¼šå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é€‚ç”¨äºä»¥ä¸‹æƒ…å†µï¼š\n  - å¤šä¸ªå®¢æˆ·ç«¯éœ€è¦è®¿é—®åŒä¸€ç»„åç«¯æœåŠ¡ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å’Œç­–ç•¥é€‰æ‹©åç«¯æœåŠ¡ã€‚\n  - æœåŠ¡æ¶ˆè´¹è€…éœ€è¦æ›´å¤šçš„æµé‡æ§åˆ¶å’Œç­–ç•¥å®šä¹‰ï¼Œä¾‹å¦‚ A\/B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒç­‰ã€‚\n\n- **å®ç°æ¡ˆä¾‹**ï¼šå¸¸è§çš„å®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å¼€æºé¡¹ç›®åŒ…æ‹¬ï¼š\n  - **Ribbon**ï¼šNetflix Ribbon æ˜¯ä¸€ä¸ªç”¨äºå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å¼€æºé¡¹ç›®ï¼Œå®ƒå¯ä»¥ä¸ Spring Cloud é›†æˆã€‚\n  - **Envoy**ï¼šEnvoy æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ä»£ç†æœåŠ¡å™¨ï¼Œæ”¯æŒå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œå¹¿æ³›ç”¨äºæœåŠ¡ç½‘æ ¼å’Œå¾®æœåŠ¡æ¶æ„ä¸­ã€‚\n  - **NGINX**ï¼šè™½ç„¶ NGINX é€šå¸¸ç”¨äºåå‘ä»£ç†ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨ä½œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ã€‚\n\n**æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼ˆServer-Side Load Balancingï¼‰**\n\næœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å¦‚å›¾ 2 æ‰€ç¤ºã€‚\n\n![å›¾ 2ï¼šæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡](server-side-load-balancing.svg)\n\n- **å®šä¹‰**ï¼šåœ¨æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ä¸­ï¼Œè´Ÿè½½å‡è¡¡å†³ç­–æ˜¯ç”±æœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡å™¨æˆ–ä»£ç†æ¥åšå‡ºçš„ã€‚å®¢æˆ·ç«¯åªéœ€å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯ï¼Œç„¶åæœåŠ¡ç«¯å†³å®šå°†è¯·æ±‚è·¯ç”±åˆ°å“ªä¸ªåç«¯æœåŠ¡å®ä¾‹ã€‚\n\n- **é€‚ç”¨åœºæ™¯**ï¼šæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡é€‚ç”¨äºä»¥ä¸‹æƒ…å†µï¼š\n  - å®¢æˆ·ç«¯ä¸å…³å¿ƒåç«¯æœåŠ¡çš„å…·ä½“å®ä¾‹ï¼Œåªå…³å¿ƒå‘é€è¯·æ±‚åˆ°æœåŠ¡çš„åç§°æˆ–åœ°å€ã€‚\n  - è´Ÿè½½å‡è¡¡ç­–ç•¥éœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œå…¨å±€é…ç½®ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒè´Ÿè½½å‡è¡¡ç»†èŠ‚ã€‚\n\n- **å®ç°æ¡ˆä¾‹**ï¼šå¸¸è§çš„å®ç°æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡çš„å¼€æºé¡¹ç›®åŒ…æ‹¬ï¼š\n  - **NGINX**ï¼šNGINX å¯ä»¥ç”¨ä½œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œæ‰§è¡ŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°åç«¯æœåŠ¡ã€‚\n  - **HAProxy**ï¼šHAProxy æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œé€šå¸¸ç”¨äºæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ã€‚\n  - **Amazon ELBï¼ˆElastic Load Balancerï¼‰**ï¼šäºšé©¬é€Šæä¾›çš„è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œç”¨äºå°†è¯·æ±‚è·¯ç”±åˆ° AWS åç«¯æœåŠ¡å®ä¾‹ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæœ‰æ—¶ä¹Ÿä¼šå°†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ç»“åˆä½¿ç”¨ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚ã€‚é€‰æ‹©å“ªç§è´Ÿè½½å‡è¡¡æ–¹æ³•é€šå¸¸å–å†³äºæ‚¨çš„æ¶æ„ã€éƒ¨ç½²éœ€æ±‚ä»¥åŠæ€§èƒ½è¦æ±‚ã€‚æœåŠ¡ç½‘æ ¼ï¼ˆå¦‚ Istioï¼‰é€šå¸¸ä½¿ç”¨å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ¥å®ç°ç»†ç²’åº¦çš„æµé‡æ§åˆ¶å’Œç­–ç•¥å®šä¹‰ï¼Œè€Œåœ¨äº‘æœåŠ¡æä¾›å•†ä¸­ï¼ŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡é€šå¸¸ç”¨äºè‡ªåŠ¨æ‰©å±•å’Œæµé‡ç®¡ç†ã€‚\n\n### Istio å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ {#how-istio-do-lb}\n\nåœ¨æœåŠ¡ç½‘æ ¼ï¼ˆå¦‚ Istioï¼‰ä¸­ï¼Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é€šå¸¸æ˜¯é€šè¿‡ Envoy ä»£ç†å®ç°çš„ã€‚Envoy æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ä»£ç†æœåŠ¡å™¨ï¼Œå®ƒå¯ä»¥ç”¨äºæ„å»ºæœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢ï¼Œç”¨äºå¤„ç†æœåŠ¡ä¹‹é—´çš„é€šä¿¡ã€‚å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§åœ¨æœåŠ¡æ¶ˆè´¹è€…ï¼ˆå®¢æˆ·ç«¯ï¼‰ä¸€ä¾§å®ç°çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ƒå†³å®šäº†è¯·æ±‚åº”è¯¥å¦‚ä½•è·¯ç”±åˆ°åç«¯æœåŠ¡å®ä¾‹ã€‚\n\nå•é›†ç¾¤å•ç½‘ç»œ Istio æœåŠ¡ç½‘æ ¼çš„è´Ÿè½½å‡è¡¡å¦‚å›¾ 3 æ‰€ç¤ºã€‚\n\n![å›¾ 3ï¼šå•é›†ç¾¤å•ç½‘ç»œçš„ Istio æœåŠ¡ç½‘æ ¼çš„è´Ÿè½½å‡è¡¡](istio-load-balancing.svg)\n\nä»¥ä¸‹æ˜¯æœåŠ¡ç½‘æ ¼ä¸­å¦‚ä½•å®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„ä¸€èˆ¬æµç¨‹ï¼š\n\n1. **Sidecar ä»£ç†**: åœ¨æœåŠ¡ç½‘æ ¼ä¸­ï¼Œæ¯ä¸ªéƒ¨ç½²çš„æœåŠ¡å®ä¾‹é€šå¸¸éƒ½ä¸ä¸€ä¸ª Sidecar ä»£ç†ï¼ˆé€šå¸¸æ˜¯ Envoyï¼‰å…³è”ã€‚è¿™ä¸ª Sidecar ä»£ç†ä½äºæœåŠ¡å®ä¾‹æ—è¾¹ï¼Œè´Ÿè´£å¤„ç†è¯¥æœåŠ¡å®ä¾‹çš„å…¥ç«™å’Œå‡ºç«™æµé‡ã€‚\n\n2. **æœåŠ¡æ³¨å†Œä¸å‘ç°**: åœ¨æœåŠ¡ç½‘æ ¼ä¸­ï¼ŒæœåŠ¡å®ä¾‹çš„æ³¨å†Œå’Œå‘ç°é€šå¸¸ç”±æœåŠ¡æ³¨å†Œè¡¨ï¼ˆKubernetes çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼‰å¤„ç†ã€‚è¿™äº›æ³¨å†Œè¡¨ç»´æŠ¤äº†æœåŠ¡å®ä¾‹çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ç½‘ç»œåœ°å€å’Œå¥åº·çŠ¶æ€ã€‚\n\n3. **å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é…ç½®**: åœ¨å®¢æˆ·ç«¯ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰å‘é€è¯·æ±‚æ—¶ï¼ŒSidecar ä»£ç†ä¼šæ‰§è¡Œè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚è¿™äº›è´Ÿè½½å‡è¡¡ç­–ç•¥é€šå¸¸åœ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­è·å–çš„æœåŠ¡å®ä¾‹åˆ—è¡¨ä¸Šæ“ä½œã€‚ç­–ç•¥å¯ä»¥åŸºäºå¤šç§å› ç´ è¿›è¡Œé€‰æ‹©ï¼Œä¾‹å¦‚æƒé‡ã€å¥åº·çŠ¶æ€ã€å»¶è¿Ÿç­‰ã€‚\n\n4. **è¯·æ±‚è·¯ç”±**: æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒSidecar ä»£ç†å°†è¯·æ±‚è·¯ç”±åˆ°é€‰æ‹©çš„åç«¯æœåŠ¡å®ä¾‹ã€‚è¿™å¯ä»¥åŒ…æ‹¬ä½¿ç”¨è½®è¯¢ã€åŠ æƒè½®è¯¢ã€æœ€å°‘è¿æ¥ç­‰ç®—æ³•æ¥é€‰æ‹©ç›®æ ‡å®ä¾‹ã€‚\n\n5. **é€šä¿¡å¤„ç†**: ä¸€æ—¦é€‰æ‹©äº†ç›®æ ‡å®ä¾‹ï¼ŒSidecar ä»£ç†å°†è¯·æ±‚è½¬å‘ç»™è¯¥å®ä¾‹ï¼Œç„¶åå°†å“åº”ä¼ å›ç»™å®¢æˆ·ç«¯ã€‚å®ƒè¿˜å¯ä»¥å¤„ç†è¿æ¥ç®¡ç†ã€æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ç­‰ä»»åŠ¡ã€‚\n\næ€»ä¹‹ï¼Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æ˜¯åœ¨æœåŠ¡æ¶ˆè´¹è€…ä¸€ä¾§ï¼ˆé€šå¸¸æ˜¯ Envoy ä»£ç†ï¼‰å®ç°çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ƒä½¿æœåŠ¡ç½‘æ ¼èƒ½å¤Ÿæœ‰æ•ˆåœ°åˆ†å‘æµé‡å¹¶å¤„ç†åç«¯æœåŠ¡å®ä¾‹çš„æ•…éšœã€‚è¿™ç§æ–¹å¼ä½¿å¾—è´Ÿè½½å‡è¡¡å†³ç­–åœ¨æœåŠ¡æ¶ˆè´¹è€…çš„æ§åˆ¶ä¸‹ï¼Œå¹¶å…è®¸æ›´ç²¾ç»†çš„æµé‡æ§åˆ¶å’Œç­–ç•¥å®šä¹‰ã€‚Envoy ä»£ç†æ˜¯å®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒå…·æœ‰ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œå¯ç”¨äºæ»¡è¶³ä¸åŒçš„è´Ÿè½½å‡è¡¡éœ€æ±‚ã€‚\n\n## Istio ä¸­çš„è´Ÿè½½å‡è¡¡ç±»å‹ {#lb-types}\n\nåœ¨ Istio çš„[DestinationRule](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/destination-rule\/)èµ„æºä¸­ï¼Œ\u0060loadBalancer\u0060éƒ¨åˆ†ç”¨äºé…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ§åˆ¶è¯·æ±‚å¦‚ä½•åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å®ä¾‹æˆ–ç‰ˆæœ¬ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å›¾ 4ï¼šIstio ä¸­çš„è´Ÿè½½å‡è¡¡é…ç½®å‚æ•°](istio-loadbalancer.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒIstio æ”¯æŒä¸‰ç§ç±»å‹çš„è´Ÿè½½å‡è¡¡ï¼Œåˆ†åˆ«æ˜¯ï¼š\n\n- \u0060simple\u0060ï¼šåŸºäºå¸¸ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•çš„ç®€å•è´Ÿè½½å‡è¡¡\n- \u0060consistentHashLB\u0060ï¼šåŸºäºä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è´Ÿè½½å‡è¡¡\n- \u0060localityLbSetting\u0060ï¼šåŸºäºåœ°åŸŸçš„æœ¬åœ°æ€§è´Ÿè½½å‡è¡¡\n\nä»¥ä¸‹æ˜¯ä¸è´Ÿè½½å‡è¡¡é…ç½®ç›¸å…³çš„å­—æ®µçš„å«ä¹‰ï¼š\n\n1. **simple**ï¼šè¿™ä¸ªéƒ¨åˆ†å®šä¹‰äº†ä¸€äº›ç®€å•çš„è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰é¡¹ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹é€‰é¡¹ï¼š\n   - **ROUND_ROBIN**ï¼šè¯·æ±‚ä¼šä¾æ¬¡åˆ†å‘åˆ°æ‰€æœ‰å¯ç”¨çš„åç«¯å®ä¾‹ï¼Œä»¥è½®è¯¢çš„æ–¹å¼ã€‚\n   - **LEAST_CONN**ï¼šè¯·æ±‚å°†è·¯ç”±åˆ°å½“å‰è¿æ¥æ•°æœ€å°‘çš„åç«¯å®ä¾‹ã€‚\n   - **RANDOM**ï¼šè¯·æ±‚å°†éšæœºè·¯ç”±åˆ°åç«¯å®ä¾‹ã€‚\n   - **PASSTHROUGH**ï¼šIstio ä¸ä¼šè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œè€Œæ˜¯å°†è¯·æ±‚ç›´æ¥è·¯ç”±åˆ°æœåŠ¡çš„ä¸€ä¸ªå®ä¾‹ï¼Œé€‚ç”¨äºç‰¹å®šç”¨ä¾‹ã€‚\n2. **consistentHashLB**ï¼šè¿™ä¸ªéƒ¨åˆ†å…è®¸ä½ é…ç½®ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹å­—æ®µï¼š\n   - **httpHeaderName**ï¼šç”¨äºå“ˆå¸Œè®¡ç®—çš„ HTTP æ ‡å¤´çš„åç§°ã€‚\n   - **httpCookie**ï¼šç”¨äºå“ˆå¸Œè®¡ç®—çš„ HTTP Cookie çš„é…ç½®ï¼ŒåŒ…æ‹¬åç§°ã€è·¯å¾„å’Œç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ã€‚\n   - **useSourceIp**ï¼šæ˜¯å¦ä½¿ç”¨è¯·æ±‚çš„æº IP åœ°å€è¿›è¡Œå“ˆå¸Œè®¡ç®—ã€‚\n   - **httpQueryParameterName**ï¼šç”¨äºå“ˆå¸Œè®¡ç®—çš„ HTTP æŸ¥è¯¢å‚æ•°çš„åç§°ã€‚\n   - **ringHash**ï¼šé…ç½®ç¯å½¢å“ˆå¸Œè´Ÿè½½å‡è¡¡ï¼ŒåŒ…æ‹¬æœ€å°ç¯å¤§å°ï¼ˆminimumRingSizeï¼‰ã€‚\n   - **maglev**ï¼šé…ç½® Maglev è´Ÿè½½å‡è¡¡ï¼ŒåŒ…æ‹¬è¡¨æ ¼å¤§å°ï¼ˆtableSizeï¼‰å’Œæœ€å°ç¯å¤§å°ï¼ˆminimumRingSizeï¼‰ã€‚\n3. **localityLbSetting**ï¼šè¿™ä¸ªéƒ¨åˆ†ç”¨äºé…ç½®æœ¬åœ°æ€§è´Ÿè½½å‡è¡¡è®¾ç½®ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹å­—æ®µï¼š\n   - **distribute**ï¼šå®šä¹‰äº†è¯·æ±‚çš„åˆ†å¸ƒï¼ŒåŒ…æ‹¬èµ·å§‹ä½ç½®ï¼ˆfromï¼‰å’Œç»“æŸä½ç½®ï¼ˆtoï¼‰ã€‚\n   - **failover**ï¼šå®šä¹‰äº†æ•…éšœåˆ‡æ¢ï¼ŒåŒ…æ‹¬èµ·å§‹ä½ç½®ï¼ˆfromï¼‰å’Œç»“æŸä½ç½®ï¼ˆtoï¼‰ã€‚\n   - **failoverPriority**ï¼šæ•…éšœåˆ‡æ¢çš„ä¼˜å…ˆçº§è®¾ç½®ã€‚\n   - **enabled**ï¼šæ˜¯å¦å¯ç”¨æœ¬åœ°æ€§è´Ÿè½½å‡è¡¡ã€‚\n\nè¿™äº›å­—æ®µå…è®¸ä½ æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©é€‚å½“çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¹¶é…ç½®é¢å¤–çš„é€‰é¡¹ï¼Œä»¥ç¡®ä¿è¯·æ±‚æŒ‰ç…§æ‰€éœ€çš„æ–¹å¼åˆ†å‘åˆ°åç«¯æœåŠ¡å®ä¾‹ã€‚ä¸åŒçš„ç­–ç•¥å’Œé…ç½®é€‰é¡¹å¯ä»¥æ»¡è¶³å„ç§è´Ÿè½½å‡è¡¡éœ€æ±‚ï¼Œå¦‚æ€§èƒ½ã€å¯é æ€§å’Œæµé‡æ§åˆ¶ã€‚å…³äºè¿™äº›å­—æ®µçš„è¯¦ç»†ä»‹ç»è¯·è§ [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/destination-rule\/)ã€‚\n\n## å¦‚ä½•åœ¨ Istio ä¸­ä¸ºæœåŠ¡è®¾ç½®è´Ÿè½½å‡è¡¡ {#istio-lb}\n\næ­£å¦‚æˆ‘åœ¨[å¦‚ä½•ç†è§£ Istio ä¸­çš„ VirtualService å’Œ DestinationRule](\/blog\/understand-istio-vs-and-dr\/)è¿™ç¯‡æ–‡ç« ä¸­æ‰€è¯´çš„ï¼Œ\u0060VirtualService\u0060 ä¸»è¦ç”¨äºè®¾ç½®è·¯ç”±è§„åˆ™ï¼Œè€ŒæœåŠ¡å¼¹æ€§ï¼ˆè´Ÿè½½å‡è¡¡ã€è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ç­‰ï¼‰éœ€è¦é å®ƒå’Œ DestinationRule æ¥å…±åŒç»´æŒã€‚åªæœ‰åŒæ—¶éƒ¨ç½²äº†ä»¥ä¸Šä¸¤ç§èµ„æºï¼Œè´Ÿè½½å‡è¡¡æ‰èƒ½çœŸæ­£ç”Ÿæ•ˆã€‚\n\nä»¥ä¸‹æ˜¯è®¾ç½®è´Ÿè½½å‡è¡¡çš„ä¸€èˆ¬æ­¥éª¤ï¼š\n\n1. **åˆ›å»º DestinationRule èµ„æº**ï¼šé¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª DestinationRule èµ„æºï¼Œè¯¥èµ„æºå®šä¹‰äº†æœåŠ¡çš„æµé‡ç­–ç•¥å’Œç›®æ ‡è§„åˆ™ã€‚åœ¨ DestinationRule ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šè¦è®¾ç½®è´Ÿè½½å‡è¡¡çš„æœåŠ¡çš„åç§°ï¼ˆhostï¼‰ä»¥åŠè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚\n\n   ä»¥ä¸‹æ˜¯ä¸€ä¸ª DestinationRule çš„ç¤ºä¾‹ï¼Œå…¶ä¸­å°†æµé‡åˆ†å‘åˆ°å…·æœ‰æ ‡ç­¾ \u0022version: v1\u0022 å’Œ \u0022version: v2\u0022 çš„ä¸¤ä¸ªå­é›†ä¸­ï¼Œå¹¶ä½¿ç”¨ \u0060ROUND_ROBIN\u0060 è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š\n\n   \u0060\u0060\u0060yaml\n   apiVersion: networking.istio.io\/v1alpha3\n   kind: DestinationRule\n   metadata:\n     name: my-destination-rule\n   spec:\n     host: my-service.example.com\n     trafficPolicy:\n       loadBalancer:\n         simple: ROUND_ROBIN\n     subsets:\n       - name: v1\n         labels:\n           version: v1\n       - name: v2\n         labels:\n           version: v2\n   \u0060\u0060\u0060\n\n2. **åº”ç”¨ DestinationRule**ï¼šåˆ›å»º DestinationRule åï¼Œå°†å…¶åº”ç”¨äºè¦è¿›è¡Œè´Ÿè½½å‡è¡¡çš„æœåŠ¡ã€‚è¿™é€šå¸¸å¯ä»¥é€šè¿‡ Istio çš„ VirtualService èµ„æºæ¥å®Œæˆï¼Œé€šè¿‡åœ¨ VirtualService ä¸­å¼•ç”¨ DestinationRuleã€‚\n\n   ä»¥ä¸‹æ˜¯ä¸€ä¸ª VirtualService ç¤ºä¾‹ï¼Œå°†æµé‡å¼•å¯¼åˆ°åä¸º \u0022my-destination-rule\u0022 çš„ DestinationRuleï¼š\n\n   \u0060\u0060\u0060yaml\n   apiVersion: networking.istio.io\/v1alpha3\n   kind: VirtualService\n   metadata:\n     name: my-virtual-service\n   spec:\n     hosts:\n       - my-service.example.com\n     http:\n       - route:\n           - destination:\n               host: my-service.example.com\n               subset: v1\n         weight: 80\n       - route:\n           - destination:\n               host: my-service.example.com\n               subset: v2\n         weight: 20\n   \u0060\u0060\u0060\n\n   åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ ¹æ®æƒé‡é…ç½®ï¼Œ80% çš„æµé‡å°†è·¯ç”±åˆ°å­é›† v1ï¼Œè€Œ 20% çš„æµé‡å°†è·¯ç”±åˆ°å­é›† v2ã€‚\n\n3. **åº”ç”¨é…ç½®**ï¼šæœ€åï¼Œå°† VirtualService å’Œ DestinationRule èµ„æºåº”ç”¨åˆ°ä½ çš„ Istio ç¯å¢ƒä¸­ï¼Œä»¥ç¡®ä¿è´Ÿè½½å‡è¡¡è§„åˆ™ç”Ÿæ•ˆã€‚\n\n   ä½¿ç”¨ kubectl å‘½ä»¤å°† VirtualService å’Œ DestinationRule åº”ç”¨åˆ° Istio ä¸­ï¼š\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f your-service.yaml\n   \u0060\u0060\u0060\n\né€šè¿‡è¿™äº›æ­¥éª¤ï¼Œä½ å¯ä»¥ä¸ºä½ çš„æœåŠ¡è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œæ ¹æ®éœ€è¦å°†æµé‡åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡ç‰ˆæœ¬æˆ–å®ä¾‹ï¼Œå¹¶æ§åˆ¶æµé‡çš„æƒé‡ã€‚è¿™æœ‰åŠ©äºå®ç°è¯¸å¦‚é‡‘ä¸é›€å‘å¸ƒã€A\/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒç­‰éƒ¨ç½²ç­–ç•¥ã€‚è¯·æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚å’Œç¯å¢ƒè°ƒæ•´è´Ÿè½½å‡è¡¡é…ç½®ã€‚\n\n### ä¸ºä»€ä¹ˆè¦åˆ†å¼€é…ç½®ï¼Ÿ{#devide}\n\nåœ¨ Istio ä¸­ï¼Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œå®ƒä»¬é€šå¸¸ç”¨äºæ§åˆ¶æœåŠ¡ä¹‹é—´çš„æµé‡å’Œè¡Œä¸ºï¼Œå› æ­¤é€šå¸¸åˆ†åˆ«é…ç½®åœ¨ä¸¤ä¸ªä¸åŒçš„èµ„æºå¯¹è±¡ä¸­ï¼š\u0060DestinationRule\u0060 ç”¨äºè´Ÿè½½å‡è¡¡ï¼Œ\u0060VirtualService\u0060 ç”¨äºè·¯ç”±ã€‚è¿™ç§åˆ†ç¦»çš„è®¾è®¡æœ‰ä¸€äº›ä¼˜ç‚¹ï¼š\n\n1. **æ¨¡å—åŒ–å’Œæ¸…æ™°æ€§ï¼š** å°†è´Ÿè½½å‡è¡¡å’Œè·¯ç”±é…ç½®åˆ†ç¦»æˆä¸¤ä¸ªèµ„æºå¯¹è±¡å¯ä»¥ä½¿é…ç½®æ›´åŠ æ¨¡å—åŒ–å’Œæ¸…æ™°ã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥æ›´å®¹æ˜“åœ°ç†è§£å’Œç»´æŠ¤è¿™ä¸¤ä¸ªæ–¹é¢çš„é…ç½®ï¼Œè€Œä¸ä¼šä½¿é…ç½®å¯¹è±¡è¿‡äºå¤æ‚ã€‚\n\n2. **å¯ç»´æŠ¤æ€§ï¼š** å°†è´Ÿè½½å‡è¡¡å’Œè·¯ç”±é…ç½®åˆ†å¼€å¯ä»¥ä½¿å®ƒä»¬æ›´å®¹æ˜“ç»´æŠ¤å’Œä¿®æ”¹ï¼Œå› ä¸ºå®ƒä»¬ä½äºä¸åŒçš„èµ„æºå¯¹è±¡ä¸­ã€‚è¿™æ ·ï¼Œæ‚¨å¯ä»¥é’ˆå¯¹ä¸åŒçš„éœ€æ±‚æ›´æ”¹è´Ÿè½½å‡è¡¡ç­–ç•¥è€Œä¸ä¼šå½±å“è·¯ç”±è§„åˆ™ï¼Œåä¹‹äº¦ç„¶ã€‚\n\n3. **å¯é‡ç”¨æ€§ï¼š** æ¨¡å—åŒ–çš„é…ç½®å…è®¸æ‚¨æ›´å®¹æ˜“åœ°é‡ç”¨é…ç½®ç‰‡æ®µã€‚æ‚¨å¯ä»¥åœ¨ä¸åŒçš„ \u0060DestinationRule\u0060 æˆ– \u0060VirtualService\u0060 ä¸­ä½¿ç”¨ç›¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥æˆ–è·¯ç”±è§„åˆ™ï¼Œä»¥æé«˜é…ç½®çš„å¯é‡ç”¨æ€§ã€‚\n\n4. **ç²¾ç»†æ§åˆ¶ï¼š** åˆ†ç¦»çš„é…ç½®å…è®¸æ‚¨å¯¹æ¯ä¸ªæ–¹é¢è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡å®šåˆ¶ä¸åŒçš„è·¯ç”±è§„åˆ™å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„ç”¨ä¾‹å’Œè¦æ±‚ã€‚\n\nè™½ç„¶è´Ÿè½½å‡è¡¡å’Œè·¯ç”±é€šå¸¸æ˜¯åˆ†å¼€é…ç½®çš„ï¼Œä½†å®ƒä»¬ä¹‹é—´ä»ç„¶å­˜åœ¨ç´§å¯†çš„å…³è”ï¼Œå› ä¸ºè·¯ç”±è§„åˆ™å†³å®šäº†è¯·æ±‚å°†å¦‚ä½•è¢«è·¯ç”±åˆ°åç«¯æœåŠ¡ï¼Œè€Œè´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šäº†åœ¨æ‰€é€‰ç›®æ ‡æœåŠ¡ä¹‹é—´å¦‚ä½•åˆ†å‘æµé‡ã€‚å› æ­¤ï¼Œåœ¨ Istio ä¸­ï¼Œè¿™ä¸¤ä¸ªé…ç½®å¯¹è±¡é€šå¸¸éœ€è¦ååŒå·¥ä½œï¼Œä»¥å®ç°æ‚¨çš„æµé‡ç®¡ç†éœ€æ±‚ã€‚é€šè¿‡å°†å®ƒä»¬åˆ†å¼€é…ç½®ï¼Œä½¿å¾—é…ç½®æ›´åŠ æ¸…æ™°å’Œå¯ç»´æŠ¤ï¼Œå¹¶å…è®¸æ›´çµæ´»åœ°æ»¡è¶³ä¸åŒçš„éœ€æ±‚ã€‚\n\n## å¤šé›†ç¾¤ç½‘æ ¼ä¸­çš„è´Ÿè½½å‡è¡¡ {#multicluster}\n\nåœ¨å¾®æœåŠ¡é¢†åŸŸï¼ŒIstio å·²è¢«è¯æ˜æ˜¯ç®¡ç†æœåŠ¡é€šä¿¡çš„æ— ä»·ä¹‹å®ã€‚è™½ç„¶å®ƒåœ¨å•é›†ç¾¤åœºæ™¯ä¸‹è¡¨ç°å‡ºè‰²ï¼Œä½†å¤šé›†ç¾¤è®¾ç½®å¼•å…¥äº†ç‹¬ç‰¹çš„æŒ‘æˆ˜ï¼Œç‰¹åˆ«æ˜¯åœ¨è´Ÿè½½å‡è¡¡æ–¹é¢ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ­ç§˜ Istio ä¸­çš„å¤šé›†ç¾¤è´Ÿè½½å‡è¡¡ï¼Œä¸ºæ‚¨æä¾›è§£å†³è¿™ä¸€å¤æ‚ä»»åŠ¡çš„æ¸…æ™°è·¯çº¿å›¾ã€‚\n\n### ä¸¤å±‚å…¥å£ç½‘å…³ï¼šå®ç°å¤šé›†ç¾¤é€šä¿¡çš„å…³é”® {#two-tier-ingress-gateway}\n\nåœ¨æ¶‰åŠæ¥è‡ªä¸åŒä¾›åº”å•†çš„é›†ç¾¤çš„å¤šé›†ç¾¤è®¾ç½®ä¸­ï¼Œç¬¬ä¸€æ­¥æ˜¯ä¸ºæ¯ä¸ªé›†ç¾¤å»ºç«‹ä¸€ä¸ªç½‘å…³ã€‚ç„¶è€Œï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„å…³é”®ä¸€ç‚¹æ˜¯éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„ç”¨æˆ·è®¿é—®å…¥å£ç‚¹ã€‚å°½ç®¡å¯ä»¥åœ¨åŒä¸€é›†ç¾¤ä¸­éƒ¨ç½²æ­¤ç½‘å…³ï¼Œä½†é€šå¸¸å»ºè®®å°†å…¶æ”¾ç½®åœ¨ä¸€ä¸ªå•ç‹¬çš„é›†ç¾¤ä¸­ã€‚\n\nä¸¤å±‚å…¥å£ç½‘æ ¼çš„éƒ¨ç½²æ¶æ„å¦‚å›¾ 4 æ‰€ç¤ºã€‚\n\n![å›¾ 4ï¼šä¸¤å±‚å…¥å£ç½‘å…³](tier1-gw-listening.svg)\n\n### å¤šé›†ç¾¤é€šä¿¡æ‰€éœ€ç»„ä»¶ {#components}\n\nåŸºäº Istio åˆ›å»ºçš„å¤šé›†ç¾¤ç½‘æ ¼ï¼Œé€šå¸¸æ˜¯[å¤šç½‘æ ¼å¤šç½‘ç»œæ¨¡å¼](https:\/\/istio.io\/latest\/docs\/setup\/install\/multicluster\/multi-primary_multi-network\/)ï¼Œä¸ºäº†è®©ç½‘æ ¼äº’é€šï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªä¸€çº§ï¼ˆTier-1ï¼‰é›†ç¾¤ï¼Œå¹¶åœ¨æ¯ä¸ªé›†ç¾¤ä¸­åˆ›å»ºå¦‚ä¸‹ç»„ä»¶ï¼š\n\n1. **å…¥å£ç½‘å…³**ï¼šæ¯ä¸ªç½‘æ ¼å¿…é¡»æœ‰ä¸€ä¸ªå…¥å£ç½‘å…³ã€‚\n2. **ServiceEntry**ï¼šç”¨äºå…è®¸é›†ç¾¤å‘ç°å½¼æ­¤çš„ç«¯ç‚¹ã€‚\n3. **VirtualServices å’Œ DestinationRules**ï¼šå¯¹äºæ¯ä¸ªé›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè·¯ç”±è‡³å…³é‡è¦ã€‚\n\n## å®æˆ˜æ¼”ç¤ºï¼šä¸€ä¸ªå¤šé›†ç¾¤æ¼”ç¤º {#demo}\n\nåœ¨è¿™ä¸ªæ¼”ç¤ºä¸­ï¼Œæˆ‘å°†æ¶µç›–ä¸‰ä¸ª GKE ä¸Šçš„ Kubernetes é›†ç¾¤ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„åŒºåŸŸï¼Œå¦‚å›¾ 5 æ‰€ç¤ºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸åŒçš„ä¾›åº”å•†æˆ–è€…è·¨ä¾›åº”å•†ã€‚åœ¨æ¯ä¸ªé›†ç¾¤ä¸­éƒ¨ç½²äº† Istioï¼Œä¸ºå¤šé›†ç¾¤é€šä¿¡å¥ å®šäº†åŸºç¡€ã€‚\n\nå»ºç«‹äº†ä¸¤å±‚é›†ç¾¤ï¼šä¸€ä¸ªä¸“é—¨æ‰˜ç®¡ \u0060productpage\u0060 æœåŠ¡ï¼Œå¦ä¸€ä¸ªåŒ…å«å®Œæ•´ [bookinfo](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/) çš„æœåŠ¡å¥—ä»¶ã€‚\n\n![å›¾ 5ï¼šæ¼”ç¤ºç¯å¢ƒçš„éƒ¨ç½²æƒ…å†µ](init-infra.svg)\n\n### å®ç°å¤šé›†ç¾¤è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ {#multicluster-routing-and-lb}\n\nä¸ºäº†å®ç°è¯¸å¦‚è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ç­‰é«˜çº§åŠŸèƒ½ï¼Œè§£å†³å¤šé›†ç¾¤è·¯ç”±é—®é¢˜è‡³å…³é‡è¦ã€‚ç”±äºä¸€çº§é›†ç¾¤ä¹Ÿéƒ¨ç½²äº† Istioï¼Œå¯ä»¥å°†å…ˆå‰è®¨è®ºçš„è´Ÿè½½å‡è¡¡æŠ€å·§åº”ç”¨äºæ­¤ç½‘å…³ã€‚\n\nå…³é”®æ­¥éª¤ï¼š\n\n1. åœ¨æ¯ä¸ªé›†ç¾¤ä¸­åˆ›å»ºå…¥å£ç½‘å…³ï¼Œå¹¶è·å–ç½‘å…³ä½¿ç”¨çš„è´Ÿè½½å‡è¡¡å™¨çš„ IP åœ°å€ã€‚\n\n2. åœ¨æ¯ä¸ªé›†ç¾¤ä¸­åˆ›å»º **VirtualServicesã€DestinationRules å’Œ ServiceEntries**ã€‚ç¡®ä¿ ServiceEntries åŒ…å«æ¯ä¸ªé›†ç¾¤å…¥å£ç½‘å…³çš„å…¥å£ç‚¹ã€‚\n\n3. ä¸ºè¿›ä¸€æ­¥çš„æµ‹è¯•ï¼Œ**æ£€ç´¢ Tier 1 ç½‘å…³çš„ IP åœ°å€**ã€‚\n\n   \u0060\u0060\u0060bash\n   export GATEWAY_IP=$(kubectl -n tier1 get service tier1-gateway -o jsonpath=\u0027{.status.loadBalancer.ingress[0].ip}\u0027)\n   \u0060\u0060\u0060\n\n   æ³¨æ„ï¼šè¿™ä¸€æ­¥éœ€è¦åœ¨ä¸€çº§é›†ç¾¤ä¸­æ“ä½œã€‚\n\nä¸€çº§é›†ç¾¤çš„ç½‘å…³ä½œä¸ºç»Ÿä¸€ç½‘å…³å…¥å£ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨è¿™ä¸ªé›†ç¾¤ä¸­é…ç½® Gatewayã€VirtualServiceã€DestinationRule å’Œ ServiceEntry èµ„æºå¯¹è±¡ï¼Œå®ç°å¤šé›†ç¾¤çš„è·¯ç”±ï¼Œå¦‚å›¾ 6 æ‰€ç¤ºã€‚\n\n![å›¾ 6ï¼šä¸€çº§é›†ç¾¤ä¸­çš„ Istio èµ„æº](istio-resources.svg)\n\nåœ¨è¿™ä¸ªæ¼”ç¤ºä¸­æˆ‘ä»¬å°†å®ç°åŸºäº HTTP header å’Œ prefix çš„å¤šé›†ç¾¤çš„è·¯ç”±ï¼Œæœ€ç»ˆçš„è·¯ç”±è·¯å¾„å¦‚å›¾ 7 æ‰€ç¤ºã€‚\n\n![å›¾ 7ï¼šè·¯ç”±è·¯å¾„](final.svg)\n\nå…³äºæ“ä½œçš„ç»†èŠ‚å¯ä»¥å‚è€ƒ TSB æ–‡æ¡£ä¸­çš„[ç»Ÿä¸€ç½‘å…³](https:\/\/docs.tetrate.io\/service-bridge\/next\/howto\/gateway\/unified-gateway)ã€‚\n\n### æµ‹è¯•è®¾ç½® {#test}\n\næ¼”ç¤ºç»§ç»­è¿›è¡Œå®é™…æµ‹è¯•ï¼Œä½¿ç”¨ \u0060curl\u0060 å‘½ä»¤ï¼š\n\n1. æ— éœ€ HTTP æ ‡å¤´çš„è¯·æ±‚ URLã€‚\n\n   \u0060\u0060\u0060bash\n   curl -Ss \u0022http:\/\/bookinfo.tetrate.io\/productpage\u0022 --resolve \u0022bookinfo.tetrate.io:80:$GATEWAY_IP\u0022 -v \u003e index1.html\n   \u0060\u0060\u0060\n\n2. ä½¿ç”¨æŒ‡ç¤ºé¦–é€‰é›†ç¾¤çš„ HTTP æ ‡å¤´è¯·æ±‚ URLã€‚\n\n   \u0060\u0060\u0060bash\n   curl -Ss \u0022http:\/\/bookinfo.tetrate.io\/productpage\u0022 --resolve \u0022bookinfo.tetrate.io:80:$GATEWAY_IP\u0022 -v -H \u0022X-CLUSTER-SELECTOR: gke-jimmy-us-west1-1\u0022 \u003e index2.html\n   curl -Ss \u0022http:\/\/bookinfo.tetrate.io\/productpage\u0022 --resolve \u0022bookinfo.tetrate.io:80:$GATEWAY_IP\u0022 -v -H \u0022X-CLUSTER-SELECTOR: gke-jimmy-us-west1-2\u0022 \u003e index3.html\n   \u0060\u0060\u0060\n\né€šè¿‡å¯¼å‡ºçš„ HTML æ–‡ä»¶éªŒè¯ç»“æœã€‚åœ¨æµè§ˆå™¨ä¸­åˆ†åˆ«æ‰“å¼€ \u0060index1.html\u0060ã€\u0060index2.html\u0060 å’Œ \u0060index3.html\u0060 è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œä½ å°†çœ‹åˆ°é¡µé¢ 1 å’Œé¡µé¢ 2 ä¸­éƒ½æ˜¾ç¤º reviews å’Œ details æœåŠ¡ä¸å¯ç”¨ï¼Œåªæœ‰é¡µé¢ 3 ä¸­çš„æ‰€æœ‰æœåŠ¡éƒ½å¯è®¿é—®ã€‚\n\n### å¤šé›†ç¾¤è´Ÿè½½å‡è¡¡ {#multicluster-lb}\n\næ¼”ç¤ºæˆåŠŸå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ HTTP æ ‡å¤´å’Œè·¯å¾„è·¯ç”±ã€‚è·¯ç”±æ˜¯è´Ÿè½½å‡è¡¡çš„åŸºç¡€ã€‚å®ç°äº†å¤šé›†ç¾¤è·¯ç”±ä¹‹åï¼Œä½ å°±å¯ä»¥å°†æ¥è‡ªäºŒçº§ï¼ˆTier-2ï¼‰é›†ç¾¤çš„ç«¯ç‚¹æ·»åŠ åˆ°ä¸€ä¸ª subset ä¸­ï¼Œä»è€Œåœ¨ DestinationRule ä¸­å®ç°è´Ÿè½½å‡è¡¡é…ç½®ã€‚\n\nå¯ä»¥é€šè¿‡å°†äºŒçº§é›†ç¾¤ä¸­çš„å…¥å£ç½‘å…³é…ç½®ä¸ºä¸œè¥¿å‘ç½‘å…³ï¼Œä»è€Œè§£å†³ Cluster 1 ä¸­çš„æ•…éšœè½¬ç§»é—®é¢˜ã€‚è¯·å‚è€ƒ [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/setup\/install\/multicluster\/multi-primary_multi-network\/)ã€‚\n\n### è‡ªåŠ¨åŒ–çš„å‘¼å£° {#automation}\n\nå°½ç®¡ Istio æä¾›äº†åŸºäº Envoy çš„å„ç§è´Ÿè½½å‡è¡¡ç±»å‹ï¼Œä½†æ‰‹åŠ¨åœ¨å¤šä¸ªé›†ç¾¤ä¸­åˆ›å»ºèµ„æºå¯¹è±¡å®¹æ˜“å‡ºé”™ä¸”æ•ˆç‡ä½ä¸‹ã€‚è‡ªåŠ¨åŒ–ï¼Œæœ€å¥½æ˜¯åœ¨ Istio ä¹‹ä¸Šæ·»åŠ ä¸€ä¸ªè§£é‡Šå±‚ï¼Œæ˜¯ä¸‹ä¸€ä¸ªå‘å±•é˜¶æ®µã€‚\n\nTetrate ä½¿ç”¨ TSB è§£å†³äº†è¿™ä¸ªéœ€æ±‚ï¼ŒTSB ä¸ä¸Šæ¸¸çš„ Istio å…¼å®¹ï¼Œä¸ºå¤šé›†ç¾¤éƒ¨ç½²æä¾›äº†æ— ç¼çš„è§£å†³æ–¹æ¡ˆã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—® [Tetrate ç½‘ç«™](https:\/\/tetrate.io)ã€‚\n\n## æ€»ç»“ {#summary}\n\nç²¾é€š Istio ä¸­çš„å¤šé›†ç¾¤è´Ÿè½½å‡è¡¡å¯¹äºåœ¨å¤æ‚ç¯å¢ƒä¸­å‘æŒ¥å¾®æœåŠ¡çš„å…¨éƒ¨æ½œåŠ›è‡³å…³é‡è¦ã€‚é€šè¿‡è°¨æ…çš„é…ç½®å’Œåˆé€‚çš„å·¥å…·ï¼Œæ‚¨å¯ä»¥åœ¨é›†ç¾¤ä¹‹é—´å®ç°å¼ºå¤§ä¸”å¯é çš„é€šä¿¡ï¼Œç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºæ— è®ºéƒ¨ç½²åœ¨ä½•å¤„éƒ½èƒ½é¡ºåˆ©è¿è¡Œã€‚å¯¹äºæ›´ç²¾ç»†çš„è´Ÿè½½å‡è¡¡è°ƒæ•´ï¼Œè¯·è€ƒè™‘æ¢ç´¢ EnvoyFilterã€‚æ„Ÿè°¢æ‚¨åŠ å…¥æˆ‘ä»¬ä¸€èµ·æ­ç§˜ Istio ä¸­çš„å¤šé›†ç¾¤è´Ÿè½½å‡è¡¡ä¹‹æ—…ï¼\n\n## å‚è€ƒ {#reference}\n\n- [Install Multi-Primary on different networks - istio.io](https:\/\/istio.io\/latest\/docs\/setup\/install\/multicluster\/multi-primary_multi-network\/)\n- [Unified Gateway - docs.tetrate.io](https:\/\/docs.tetrate.io\/service-bridge\/next\/howto\/gateway\/unified-gateway)\n- [DestinationRule - istio.io](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/destination-rule\/)\n', '\/blog\/demystifying-the-load-balancing-in-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Istio è´Ÿè½½å‡è¡¡è¯¦è§£å°¤å…¶æ˜¯å¤šé›†ç¾¤å¦‚ä½•å®ç°è·¯ç”±ä¸è´Ÿè½½å‡è¡¡çš„ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªå¤šé›†ç¾¤è·¯ç”±çš„æ¼”ç¤ºã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman/">å¦‚ä½•ä½¿ç”¨ GraphQL å’Œ Postman æŸ¥è¯¢ SkyWalking ä¸­çš„æ•°æ®</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/07/20</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('å¦‚ä½•ä½¿ç”¨ GraphQL å’Œ Postman æŸ¥è¯¢ SkyWalking ä¸­çš„æ•°æ®', 'æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ GraphQL ä» SkyWalking æŸ¥è¯¢å¯è§‚æµ‹æ€§æ•°æ®ã€‚å®ƒé¦–å…ˆä»‹ç»äº† GraphQL å’Œ SkyWalkingï¼Œç„¶åä»‹ç»äº†å¦‚ä½•è®¾ç½® Postman å‘é€ GraphQL æŸ¥è¯¢ï¼Œæœ€åæä¾›äº†ä¸€äº›ç¤ºä¾‹ GraphQL æŸ¥è¯¢ï¼Œå¯ç”¨äºä» SkyWalking æŸ¥è¯¢å¯è§‚æµ‹æ€§æ•°æ®ã€‚', '\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨ [GraphQL ä¸](https:\/\/graphql.org\/)[Postman](https:\/\/www.postman.com\/) ä¸€èµ·ä» [SkyWalking](https:\/\/skywalking.apache.org\/) æŸ¥è¯¢æ•°æ®ã€‚å®ƒåŒ…æ‹¬è·å–ä¸è®°åä»¤ç‰Œã€æ„å»ºæŸ¥è¯¢ä»¥æ£€ç´¢ç‰¹å®šæœåŠ¡çš„è´Ÿè½½æŒ‡æ ‡ä»¥åŠä½¿ç”¨ GraphQL è‡ªçœæ¥æŸ¥çœ‹ SkyWalking GraphQL API æ¶æ„çš„æ­¥éª¤ã€‚æœ¬æ–‡è¿˜æä¾›äº†æ›´å¤šä¿¡æ¯çš„å‚è€ƒã€‚\n\n## ä»€ä¹ˆæ˜¯ GraphQLï¼Ÿ\n\nGraphQL æ˜¯ Facebook å¼€å‘çš„ä¸€ç§ API æŸ¥è¯¢è¯­è¨€å’Œè¿è¡Œæ—¶ã€‚å®ƒå…è®¸å®¢æˆ·ç«¯å‡†ç¡®æŒ‡å®šä»–ä»¬éœ€è¦çš„æ•°æ®å¹¶ä»…æ¥æ”¶è¯¥æ•°æ®ä½œä¸ºå“åº”ï¼Œä»è€Œä¸ºä¼ ç»Ÿ REST API æä¾›äº†æ›´é«˜æ•ˆã€æ›´å¼ºå¤§ã€æ›´çµæ´»çš„æ›¿ä»£æ–¹æ¡ˆã€‚ä½¿ç”¨ GraphQLï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨å•ä¸ªè¯·æ±‚ä¸­æŸ¥è¯¢å¤šä¸ªèµ„æºï¼Œä»è€Œå‡å°‘ä¸æœåŠ¡å™¨çš„å¾€è¿”æ¬¡æ•°å¹¶æé«˜æ€§èƒ½ã€‚\n\n## GraphQL å’Œ REST API ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\n\nGraphQL å…è®¸å®¢æˆ·ç«¯ä»…è¯·æ±‚ä»–ä»¬éœ€è¦çš„æ•°æ®ï¼Œè€Œ REST API è¦æ±‚å®¢æˆ·ç«¯æ£€ç´¢èµ„æºä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œæ— è®ºä»–ä»¬æ˜¯å¦éœ€è¦ã€‚æ­¤å¤–ï¼ŒGraphQL å…è®¸å®¢æˆ·ç«¯åœ¨å•ä¸ªè¯·æ±‚ä¸­æŸ¥è¯¢å¤šä¸ªèµ„æºï¼Œè¿™ä½¿å…¶æ¯” REST API æ›´é«˜æ•ˆã€æ›´ç®€æ´ã€‚\n\n## å¦‚ä½•æŸ¥è¯¢ SkyWalking æ•°æ®ï¼Ÿ\n\nSkyWalking å®šä¹‰äº†æŸ¥è¯¢é˜¶æ®µçš„é€šä¿¡åè®®ã€‚SkyWalking åŸç”Ÿ UI å’Œ CLI ä½¿ç”¨æ­¤åè®®ä»åç«¯æŒç»­è·å–æ•°æ®ï¼Œæ— éœ€æ‹…å¿ƒåç«¯æ›´æ–°ã€‚\n\nä» SkyWalking æŸ¥è¯¢æŒ‡æ ‡æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\n1. [GraphQL API](https:\/\/skywalking.apache.org\/docs\/main\/v9.4.0\/en\/api\/query-protocol\/)\n2. [PromQL API](https:\/\/skywalking.apache.org\/docs\/main\/v9.4.0\/en\/api\/promql-service\/)\n\næœ¬æ–‡æä¾›äº†æœ‰å…³å¦‚ä½•ä½¿ç”¨ GraphQL ä» SkyWalking æŸ¥è¯¢æŒ‡æ ‡çš„æŒ‡å—ã€‚å¦‚æœä½ å¯¹ PromQL API æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚é˜…æ–‡ç« [ä¸º Apache SkyWalking æ„å»º Grafana Dashboard - åŸç”Ÿ PromQL æ”¯æŒ](https:\/\/skywalking.apache.org\/zh\/2023-03-17-build-grafana-dashboards-for-apache-skywalking-native-promql-support\/) ã€‚ç»§ç»­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤éœ€è¦å®‰è£… TSBã€‚å¦‚æœä½ æ²¡æœ‰ï¼Œä½†ä»æƒ³ä½“éªŒä½¿ç”¨ GraphQL åœ¨ SkyWalking ä¸­æŸ¥è¯¢æ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨ SkyWalking æä¾›çš„å…è´¹[æ¼”ç¤ºç¯å¢ƒ](https:\/\/skywalking.apache.org\/)ï¼ˆç”¨æˆ·å \/ å¯†ç ï¼šskywalking\/skywalkingï¼‰ã€‚ç™»å½•æ¼”ç¤ºç½‘ç«™å¹¶è·å–æŸ¥è¯¢ä»¤ç‰Œã€‚GraphQL æŸ¥è¯¢çš„ç«¯ç‚¹åœ°å€æ˜¯ \u003chttp:\/\/demo.skywalking.apache.org\/graphql\u003e ã€‚æ„é€ æŸ¥è¯¢çš„æ­¥éª¤ä¸ä¸‹é¢æè¿°çš„ç›¸åŒã€‚\n\n## è§‚å¯Ÿ TSB ä¸­çš„ GraphQL æŸ¥è¯¢\n\nåœ¨æˆ‘ä»¬ä½¿ç”¨ Postman æ„å»ºè‡ªå·±çš„ GraphQL æŸ¥è¯¢ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè§‚å¯Ÿ TSB å¦‚ä½•ä» SkyWalking è·å–æ•°æ®ã€‚\n\n1. æ‰“å¼€ Chrome DevTools å¹¶åˆ‡æ¢åˆ°â€œNetworkâ€é€‰é¡¹å¡ã€‚\n2. è®¿é—®ç½‘ç«™ä¸Šçš„**Organization - Services** é€‰é¡¹å¡ã€‚\n\nè§‚å¯Ÿç½‘ç»œè¯·æ±‚åˆ—è¡¨å¹¶å³é”®å•å‡»å…¶ä¸­ä¸€ä¸ª graphql è¯·æ±‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![å›¾ 1ï¼šChrome DevTool](f1.jpg)\n\nä½ çœ‹åˆ°çš„ curl å‘½ä»¤å°†å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä½ å°†ä» SkyWalking ä¸­è·å– TSB ç®¡ç†çš„æœåŠ¡åˆ—è¡¨ã€‚\n\n\u0060\u0060\u0060bash\ncurl \u0027\u003chttps:\/\/saturn.tetrate.work\/ui\/graphql\u003e\u0027 \\\\\n  -H \u0027Accept-Language: en,zh-CN;q=0.9,zh;q=0.8,en-US;q=0.7,zh-TW;q=0.6\u0027 \\\\\n  -H \u0027Cache-Control: no-cache\u0027 \\\\\n  -H \u0027Client-Timestamp: 1686104776136\u0027 \\\\\n  -H \u0027Connection: keep-alive\u0027 \\\\\n  -H \u0027Content-Type: application\/json\u0027 \\\\\n  -H \u0027Cookie: ...\u0027 \\\\\n  -H \u0027Origin: \u003chttps:\/\/saturn.tetrate.work\u003e\u0027 \\\\\n  -H \u0027Pragma: no-cache\u0027 \\\\\n  -H \u0027Referer: \u003chttps:\/\/saturn.tetrate.work\/mp\/services\u003e\u0027 \\\\\n  -H \u0027Request-Id: ...\u0027 \\\\\n  -H \u0027Sec-Fetch-Dest: empty\u0027 \\\\\n  -H \u0027Sec-Fetch-Mode: cors\u0027 \\\\\n  -H \u0027Sec-Fetch-Site: same-origin\u0027 \\\\\n  -H \u0027User-Agent: Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/114.0.0.0 Safari\/537.36\u0027 \\\\\n  -H \u0027X-Bridge-Csrf-Token: IOmJszLAqY3TRIUNhTuGu7vQgnfQY1FtgYFm\u002bl\/\u002bMu4EmVQU5T8EaQ7bngkCv4hQ12ZGids\u002bI21pHMdepE9\/qQ==\u0027 \\\\\n  -H \u0027X-Csrf-Token: xTbxZerD3t8N3PaS7nbjKCfxk1Q9dtvvrx4D\u002bIJohHicb0VfB4iAZaP0zh1eXDWctQyCYZWaKLhAYT3M6Drk3A==\u0027 \\\\\n  -H \u0027accept: application\/json\u0027 \\\\\n  -H \u0027sec-ch-ua: \u0022Not.A\/Brand\u0022;v=\u00228\u0022, \u0022Chromium\u0022;v=\u0022114\u0022, \u0022Google Chrome\u0022;v=\u0022114\u0022\u0027 \\\\\n  -H \u0027sec-ch-ua-mobile: ?0\u0027 \\\\\n  -H \u0027sec-ch-ua-platform: \u0022macOS\u0022\u0027 \\\\\n  --data-raw $\u0027{\u0022query\u0022:\u0022query ServiceRegistryListMetrics(...)}\u0027 \\\\\n  --compressed\n\u0060\u0060\u0060\n\n**æ³¨æ„ï¼š** *ä¸Šä¾‹ä¸­çš„æŸäº›å­—æ®µå¤ªé•¿ï¼Œç”¨ç‚¹ (...) æ›¿æ¢*ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘å°†æŒ‡å¯¼ä½ æ„å»ºä¸€ä¸ªæŸ¥è¯¢æ¥æ£€ç´¢ç‰¹å®šæœåŠ¡çš„è´Ÿè½½æŒ‡æ ‡ã€‚\n\n## è·å– Bearer Token\n\né¦–å…ˆï¼Œä½ éœ€è¦è·å–ç½‘ç«™çš„ Bearer Tokenã€‚ç™»å½•åˆ° TSB UIï¼Œç‚¹å‡»å³ä¸Šè§’çš„ç”¨æˆ·æŒ‰é’®ï¼Œç„¶åç‚¹å‡»â€œShow token informationâ€ã€‚åœ¨å¼¹å‡ºçª—å£ä¸­ï¼Œä½ å°†çœ‹åˆ° Bearer Tokenï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å›¾ 2ï¼šä» TSB UI è·å– Bear Token](f2.jpg)\n\næ³¨æ„ï¼šBearer token çš„æœ‰æ•ˆæœŸæ¯”è¾ƒçŸ­ã€‚å½“å®ƒè¿‡æœŸæ—¶ï¼Œä½ éœ€è¦é‡æ–°ç™»å½• TSB ä»¥è·å–æ–°çš„ tokenã€‚\n\næˆ‘ä»¬å·²ç»é¢„å…ˆéƒ¨ç½²äº†[bookinfo åº”ç”¨ç¨‹åº](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/)å¹¶å‘é€äº†ä¸€äº›æµ‹è¯•æµé‡ã€‚è¦åœ¨ Postman å®¢æˆ·ç«¯ä¸­ä½¿ç”¨ GraphQL æŸ¥è¯¢\u0060reviews\u0060çš„è´Ÿè½½æŒ‡æ ‡ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š\n\n1. åˆ›å»ºä¸€ä¸ªæ–°çš„ GraphQL è¯·æ±‚ï¼Œå¹¶è¾“å…¥è¯·æ±‚ URLï¼š\u0060$TSB_ADDRESS\/graphql\u0060\n2. æ·»åŠ å¸¦æœ‰å€¼\u0060Bearer $TOKEN\u0060çš„\u0060Authorization\u0060å¤´\n3. ä½¿ç”¨ GraphQL Introspection æŸ¥çœ‹ SkyWalking GraphQL APIs çš„æ¨¡å¼ã€‚æŸ¥æ‰¾å¹¶å•å‡»\u0060readMetricsValues\u0060é¡¹ã€‚ä½ å°†åœ¨å³ä¾§çœ‹åˆ°å˜é‡ã€‚å¡«å†™\u0060condition\u0060å’Œ\u0060duration\u0060é¡¹ç›®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å›¾ 3ï¼šPostman æŸ¥è¯¢](f3.jpg)\n\nå˜é‡å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060graphql\nquery ReadMetricsValues {\n    readMetricsValues(condition: {\n    name: \u0022service_cpm\u0022, entity: {scope: Service, serviceName: \u0022reviews\u0022, normal: true}\n  }, duration: {\n    start: \u00222023-06-05 0625\u0022,\n    end: \u00222023-06-05 0627\u0022,\n    step: MINUTE\n  }) {\n        label\n        values {\n            values {\n                id\n                value\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nå•å‡» Query æŒ‰é’®ä»¥è·å–ç»“æœã€‚å®ƒåº”è¯¥ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š\n\n\u0060\u0060\u0060json\n{\n    \u0022data\u0022: {\n        \u0022readMetricsValues\u0022: {\n            \u0022label\u0022: null,\n            \u0022values\u0022: {\n                \u0022values\u0022: [\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050625_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050626_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050627_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    }\n                ]\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nä»¥ä¸Šæ˜¯ä½¿ç”¨ SkyWalking Demo ç¯å¢ƒæµ‹è¯• GraphQL æŸ¥è¯¢ã€‚TSE ä¹Ÿæ”¯æŒ GraphQL æŸ¥è¯¢ï¼Œå¹¶ä¸”ç«¯ç‚¹åœ°å€ä¸º\u0060$TSB_SERVER\/graphql\u0060ã€‚\n\næ³¨æ„ï¼šæ­¤å¤„çš„æŸ¥è¯¢ç«¯ç‚¹ä¸ DevTool ä¸­çœ‹åˆ°çš„ä¸åŒã€‚TSB UI ç‰¹å®šçš„ GraphQL æŸ¥è¯¢ç«¯ç‚¹æ˜¯\u0060$TSB_SERVER\/ui\/graphql\u0060ã€‚\n\næœ‰å…³ SkyWalking GraphQL æŸ¥è¯¢åè®®çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[GitHub](https:\/\/github.com\/apache\/skywalking-query-protocol\/tree\/master)ã€‚\n\n## æ€»ç»“\n\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº†å¦‚ä½•åœ¨ Postman ä¸­ä½¿ç”¨ GraphQL æŸ¥è¯¢åè®®æŸ¥è¯¢ SkyWalking ä¸­çš„æ•°æ®ã€‚ä½ å¯ä»¥æ ¹æ® SkyWalking çš„ GraphQL æ¨¡å¼æ„å»ºè‡ªå·±çš„æŸ¥è¯¢æ¡ä»¶ã€‚TSB \/ TSE ä¸­ä¹Ÿæä¾›äº†æ­¤åŠŸèƒ½ã€‚\n', '\/blog\/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ GraphQL ä» SkyWalking æŸ¥è¯¢å¯è§‚æµ‹æ€§æ•°æ®ã€‚å®ƒé¦–å…ˆä»‹ç»äº† GraphQL å’Œ SkyWalkingï¼Œç„¶åä»‹ç»äº†å¦‚ä½•è®¾ç½® Postman å‘é€ GraphQL æŸ¥è¯¢ï¼Œæœ€åæä¾›äº†ä¸€äº›ç¤ºä¾‹ GraphQL æŸ¥è¯¢ï¼Œå¯ç”¨äºä» SkyWalking æŸ¥è¯¢å¯è§‚æµ‹æ€§æ•°æ®ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">ä½¿ç”¨ Geneve éš§é“å®ç° Istio Ambient Mesh çš„æµé‡æ‹¦æˆª</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/03/24</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä½¿ç”¨ Geneve éš§é“å®ç° Istio Ambient Mesh çš„æµé‡æ‹¦æˆª', 'æœ¬æ–‡ä»‹ç»äº†ä»€ä¹ˆæ˜¯ Geneve éš§é“ï¼Œä¸ VXLAN çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒåœ¨ Istio Ambient Mesh ä¸­çš„åº”ç”¨ï¼Œæœ€åè°ˆåŠä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡æ‹¦æˆªã€‚', '\nåœ¨æˆ‘[ä¹‹å‰çš„åšå®¢](\/blog\/ambient-mesh-l4-traffic-path\/)åˆ†äº«ä¸­æåˆ° Istio Ambient Mesh ä½¿ç”¨ iptables å’Œ Geneve éš§é“å°†åº”ç”¨ç¨‹åº Pod ä¸­çš„æµé‡æ‹¦æˆªåˆ° Ztunnel ä¸­ã€‚å¾ˆå¤šè¯»è€…å¯èƒ½è¿˜ä¸äº†è§£è¿™ç§éš§é“åè®®ï¼Œæœ¬æ–‡å°†ä¸ºä½ ä»‹ç» Geneve éš§é“çš„å®šä¹‰ï¼ŒæŠ¥æ–‡ç»“æ„ï¼Œä»¥åŠä¸ VXLAN åè®®çš„æ¯”è¾ƒæœ‰å“ªäº›ä¼˜åŠ¿ã€‚æœ€åï¼Œæœ¬æ–‡å°†ä»‹ç» Istio Ambient Mesh å¦‚ä½•åº”ç”¨ Geneve éš§é“æ¥å®ç°æµé‡æ‹¦æˆªï¼Œä»¥åŠ Istio 1.18 ä¸­æ–°æ¨å‡ºçš„ eBPF æ¨¡å¼ã€‚\n\n## Geneve éš§é“ç®€ä»‹\n\nGENEVEï¼ˆGeneric Network Virtualization Encapsulationï¼‰æ˜¯ä¸€ç§ç½‘ç»œè™šæ‹ŸåŒ–å°è£…ï¼ˆéš§é“ï¼‰åè®®ï¼Œå®ƒçš„è®¾è®¡çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å½“å‰æ•°æ®ä¼ è¾“ç¼ºä¹çµæ´»æ€§å’Œå®‰å…¨æ€§çš„é—®é¢˜ã€‚Geneve åªå®šä¹‰äº†ä¸€ç§æ•°æ®å°è£…æ ¼å¼ï¼Œä¸åŒ…æ‹¬æ§åˆ¶å¹³é¢çš„ä¿¡æ¯ã€‚GENEVE ç›¸è¾ƒäº VXLAN å°è£…çš„å…³é”®ä¼˜åŠ¿åœ¨äºå…¶é€šè¿‡æ·»åŠ  TLV æ ¼å¼çš„é€‰é¡¹æ¥æ‰©å±•å¯å°è£…çš„åè®®ç±»å‹ã€‚\n\n## Geneve vs VXLAN\n\nVXLAN å’Œ Geneve éƒ½æ˜¯ç½‘ç»œè™šæ‹ŸåŒ–åè®®ï¼Œå®ƒä»¬ä¹‹é—´æœ‰å¾ˆå¤šå…±åŒç‚¹ã€‚è™šæ‹ŸåŒ–åè®®æ˜¯ä¸€ç§å°†è™šæ‹Ÿç½‘ç»œä¸ç‰©ç†ç½‘ç»œåˆ†ç¦»çš„æŠ€æœ¯ï¼Œå®ƒå…è®¸ç½‘ç»œç®¡ç†å‘˜åœ¨è™šæ‹Ÿç¯å¢ƒä¸­åˆ›å»ºå¤šä¸ªè™šæ‹Ÿç½‘ç»œï¼Œæ¯ä¸ªè™šæ‹Ÿç½‘ç»œéƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ VLAN æ ‡è¯†ç¬¦ã€IP åœ°å€å’Œè·¯ç”±ã€‚æ­¤å¤–ï¼ŒVXLAN å’Œ Geneve åè®®éƒ½ä½¿ç”¨ UDP å°è£…ï¼Œè¿™ä½¿å¾—å®ƒä»¬èƒ½å¤Ÿé€šè¿‡ç°æœ‰ç½‘ç»œåŸºç¡€è®¾æ–½è¿›è¡Œæ‰©å±•ã€‚VXLAN å’Œ Geneve åè®®è¿˜å…·æœ‰çµæ´»æ€§ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä¸åŒçš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥ä¸ä¸åŒçš„è™šæ‹ŸåŒ–å¹³å°å…¼å®¹ã€‚\n\nå›¾ 1 å±•ç¤ºäº† VXLAN ä¸ Geneve åè®®çš„æŠ¥æ–‡ç»“æ„åŠå…¶å„è‡ªçš„ Header åŒºåˆ«ã€‚\n\n![å›¾ 1ï¼šVXLAN ä¸ Geneve æŠ¥æ–‡æ ¼å¼ç¤ºæ„å›¾](vxlan-vs-geneve.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒVXLAN ä¸ Geneve éš§é“æŠ¥æ–‡çš„ç»“æ„ç±»ä¼¼ï¼Œå…¶ä¸»è¦åŒºåˆ«åœ¨äºä½¿ç”¨ä¸åŒçš„ UDP ç«¯å£å·å’Œåè®®å¤´ â€”â€”VXLAN ä½¿ç”¨ 4789 ç«¯å£ï¼ŒGeneve ä½¿ç”¨ 6081 ç«¯å£ï¼›Geneve åè®®å¤´æ¯” VXLAN æ›´å…·æ‰©å±•æ€§ã€‚\n\nGeneve éš§é“åè®®æ¯” VXLAN æ›´åŠ å¯æ‰©å±•æ˜¯å› ä¸º Geneve éš§é“åè®®ä¸­å¢åŠ äº†å˜é•¿é€‰é¡¹ï¼Œå®ƒå¯ä»¥åŒ…å«é›¶æˆ–å¤šä¸ª TLV æ ¼å¼çš„é€‰é¡¹æ•°æ®ã€‚TLV æ˜¯æŒ‡ç±»å‹ - é•¿åº¦ - å€¼ï¼ˆType-Length-Valueï¼‰æ ¼å¼ï¼Œç”¨äºä¼ è¾“å’Œè§£æç½‘ç»œåŒ…çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚åœ¨ Geneve åè®®ä¸­ï¼Œæ¯ä¸ªå…ƒæ•°æ®ä¿¡æ¯éƒ½ç”±ä¸€ä¸ª TLV æ ¼å¼çš„å­—æ®µç»„æˆï¼Œä»¥ä¾¿äºçµæ´»åœ°æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹è¿™äº›å…ƒæ•°æ®ã€‚\n\nå…·ä½“æ¥è¯´ï¼ŒTLV æ ¼å¼çš„å­—æ®µåŒ…æ‹¬ï¼š\n\n- Typeï¼š8 ä½çš„ç±»å‹å­—æ®µã€‚\n- Lengthï¼š5 ä½çš„é€‰é¡¹é•¿åº¦å­—æ®µï¼Œä»¥ 4 å­—èŠ‚å€æ•°è¡¨ç¤ºï¼Œä¸åŒ…æ‹¬é€‰é¡¹å¤´ã€‚\n- Dataï¼šå¯å˜é•¿çš„é€‰é¡¹æ•°æ®å­—æ®µï¼Œå¯ä»¥ä¸å­˜åœ¨æˆ–è€…ä¸º 4 åˆ° 128 å­—èŠ‚ä¹‹é—´ã€‚\n\né€šè¿‡ä½¿ç”¨ TLV æ ¼å¼ï¼ŒGeneve åè®®å¯ä»¥è½»æ¾åœ°æ‰©å±•å’Œä¿®æ”¹å…ƒæ•°æ®ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒå…¼å®¹æ€§å’Œçµæ´»æ€§ã€‚\n\nå…³äº VXLAN éš§é“æŠ¥æ–‡çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) ã€‚\n\nå…³äº Geneve éš§é“æŠ¥æ–‡çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i) ã€‚\n\n### å·¥ä½œåŸç†\n\nGeneve éš§é“ä¸»è¦åº”ç”¨åœ¨äº‘è®¡ç®—å’Œè™šæ‹ŸæœºåŒ–åœºæ™¯ï¼Œå®ƒå¯ä»¥å°†æ•°æ®åŒ…å°è£…åœ¨ä¸€ä¸ªæ–°çš„æ•°æ®åŒ…ä¸­ï¼Œä»¥ä¾¿åœ¨è™šæ‹Ÿç½‘ç»œä¸­ä¼ è¾“ã€‚Geneve éš§é“ä½¿ç”¨ä¸€ä¸ª 24 ä½çš„è™šæ‹Ÿç½‘ç»œæ ‡è¯†ç¬¦ (VNI)ï¼Œå°†æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œã€‚Geneve éš§é“è¿˜å¯ä»¥ä½¿ç”¨å®‰å…¨æ€§åè®®ï¼Œå¦‚ IPsecã€TLï¼Œæ¥ä¿æŠ¤æ•°æ®åŒ…çš„ä¼ è¾“ã€‚\n\nå½“æ•°æ®åŒ…åˆ°è¾¾ç›®çš„ä¸»æœºæ—¶ï¼ŒGeneve éš§é“åè®®ä¼šå°†æ•°æ®åŒ…ä» Geneve åè®®å¤´ä¸­è§£å°è£…å‡ºæ¥ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™è™šæ‹Ÿç½‘ç»œä¸­çš„ç›®çš„åœ°ã€‚åœ¨è§£å°è£…è¿‡ç¨‹ä¸­ï¼ŒGeneve åè®®å¤´ä¸­çš„ VNI ä¿¡æ¯ä¼šè¢«æ¥åˆ¤æ–­æ•°æ®åŒ…çš„ç›®çš„åœ°ï¼Œä»¥ç¡®ä¿æ•°æ®åŒ…è¢«æ­£ç¡®åœ°è·¯ç”±åˆ°è™šæ‹Ÿç½‘ç»œä¸­çš„ç›®çš„åœ°ã€‚\n\nå‡è®¾æœ‰ä¸€ä¸ªè™šæ‹Ÿç½‘ç»œï¼Œå…¶ VNI ä¸º 1001ã€‚å½“æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨éš§é“å°†æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéš§é“å°†æºç‰©ç†ç½‘ç»œå’Œç›®æ ‡ç‰©ç†ç½‘ç»œä¹‹é—´çš„è™šæ‹Ÿç½‘ç»œæ ‡è¯†ç¬¦ (VNI) è®¾ç½®ä¸º 1001ï¼Œä»¥ä¾¿åœ¨ä¼ è¾“æœŸé—´è·Ÿè¸ªæ•°æ®åŒ…ã€‚å½“æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡ç‰©ç†ç½‘ç»œæ—¶ï¼Œéš§é“å°† VNI ä»æ•°æ®åŒ…ä¸­åˆ é™¤ï¼Œå¹¶å°†æ•°æ®åŒ…ä¼ é€’ç»™ç›®æ ‡ç‰©ç†ç½‘ç»œã€‚\n\n### å®‰å…¨æ€§\n\nGeneve éš§é“åè®®æœ¬èº«å¹¶æ²¡æœ‰æä¾›ä»»ä½•å®‰å…¨æœºåˆ¶ï¼Œå› æ­¤åœ¨ Geneve éš§é“ä¸­ä¼ è¾“çš„æ•°æ®åŒ…å¯èƒ½ä¼šå—åˆ°å¨èƒï¼Œä¾‹å¦‚æ•°æ®åŒ…è¢«ç¯¡æ”¹ã€æˆªè·ã€é‡æ”¾ç­‰ã€‚\n\nä¸ºäº†ä¿éšœ Geneve éš§é“ä¸­ä¼ è¾“çš„æ•°æ®åŒ…çš„å®‰å…¨æ€§ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å®‰å…¨åè®®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å®‰å…¨åè®®ï¼š\n\n1. IPsecï¼ˆInternet Protocol Securityï¼‰ï¼šIPsec æ˜¯ä¸€ç§ç½‘ç»œå±‚å®‰å…¨åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†ã€è®¤è¯å’Œå®Œæ•´æ€§ä¿æŠ¤ã€‚ä½¿ç”¨ IPsec å¯ä»¥æä¾›ç«¯åˆ°ç«¯çš„å®‰å…¨æ€§ã€‚\n2. TLSï¼ˆTransport Layer Securityï¼‰ï¼šTLS æ˜¯ä¸€ç§åŸºäºä¼ è¾“å±‚çš„åŠ å¯†åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚ä½¿ç”¨ TLS å¯ä»¥æä¾›ç«¯åˆ°ç«¯çš„å®‰å…¨æ€§ã€‚\n3. MACSecï¼ˆMedia Access Control Securityï¼‰ï¼šMACSec æ˜¯ä¸€ç§æ•°æ®é“¾è·¯å±‚çš„å®‰å…¨åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚ä½¿ç”¨ MACSec å¯ä»¥æä¾›é“¾è·¯å±‚çš„å®‰å…¨æ€§ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šå®‰å…¨åè®®éƒ½éœ€è¦è¿›è¡Œç›¸åº”çš„é…ç½®å’Œéƒ¨ç½²ï¼Œä¸”å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚åœ¨é€‰æ‹©åˆé€‚çš„å®‰å…¨åè®®æ—¶ï¼Œéœ€è¦è€ƒè™‘å®‰å…¨æ€§ã€æ€§èƒ½ã€å¯ç®¡ç†æ€§ç­‰æ–¹é¢çš„å› ç´ ã€‚\n\n### ä¸ºä»€ä¹ˆé€‰æ‹© Geneveï¼Ÿ\n\nä¸‹è¡¨å¯¹æ¯”äº† VXLAN ä¸ Geneve åœ¨å¤šä¸ªæ–¹é¢çš„ç‰¹ç‚¹ã€‚\n\n| ç‰¹æ€§ | VXLAN | Geneve |\n| --- | --- | --- |\n| å¤´éƒ¨æ ¼å¼ | å›ºå®šæ ¼å¼ | å¯æ‰©å±•æ ¼å¼ |\n| å¯æ‰©å±•æ€§ | æ›´å¤šåœ°ä¸“æ³¨äº L2 æ‰©å±• | æ›´å¥½åœ°æ”¯æŒæ–°å…´ç½‘ç»œæœåŠ¡ |\n| å¯æ“ä½œæ€§ | è¾ƒéš¾ç®¡ç†å’Œæ‰©å±• | æ›´å®¹æ˜“ç®¡ç†å’Œæ‰©å±• |\n| æ€§èƒ½ | å¤´éƒ¨è¾ƒçŸ­ï¼Œæ€§èƒ½è¾ƒé«˜ | å¤´éƒ¨è¾ƒé•¿ï¼Œæ€§èƒ½ç•¥ä½ |\n\nä½¿ç”¨ Geneve åè®®çš„ä¸»è¦åŸå› æ˜¯å°†ç›®å‰ç½‘ç»œè™šæ‹ŸåŒ–å°è£…æŠ€æœ¯ï¼ˆä¾‹å¦‚ VXLANã€NVGRE å’Œ STTï¼‰ä¸­çš„ä¼˜ç‚¹åˆå¹¶åˆ°ä¸€ä¸ªåè®®ä¸­ã€‚æˆ‘ä»¬é€šè¿‡å¤šå¹´çš„ç½‘ç»œè™šæ‹ŸåŒ–å¼€å‘ç»éªŒå¾—çŸ¥ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„éœ€æ±‚æ˜¯å¯æ‰©å±•æ€§ã€‚Geneve åè®®ä½¿ç”¨å¯æ‰©å±•çš„ TLV ç»“æ„å¯¹å…ƒæ•°æ®è¿›è¡Œç¼–ç ï¼Œå› æ­¤å¯ä»¥ç‹¬ç«‹åœ°å‘å±•è½¯ä»¶å’Œç¡¬ä»¶ç«¯ç‚¹çš„åŠŸèƒ½ï¼Œä»¥æ»¡è¶³ä¸æ–­å¢é•¿çš„éœ€æ±‚ã€‚\n\n## Istio Ambient Mesh å¦‚ä½•åº”ç”¨ Geneve éš§é“\n\nåœ¨[ä¹‹å‰çš„åšå®¢](https:\/\/jimmysong.io\/blog\/ambient-mesh-l4-traffic-path\/)ä¸­ï¼Œæˆ‘è®²è§£äº† Istio Ambient Mesh å¦‚ä½•ä½¿ç”¨ Ztunnel å®ç° L4 ä»£ç†çš„ï¼Œå›¾ 2 å±•ç¤ºä½¿ç”¨ iptables å’Œ Geneve éš§é“çš„ L4 é€æ˜æµé‡åŠ«æŒè·¯å¾„ã€‚\n\n![å›¾ 2ï¼šä½¿ç”¨ iptables å’Œ Geneve éš§é“çš„ L4 é€æ˜æµé‡åŠ«æŒè·¯å¾„ç¤ºæ„å›¾](geneve-tunnel.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š\n\n- Istio CNI åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºÂ \u0060istioout\u0060Â ç½‘å¡å’Œ iptables è§„åˆ™ï¼Œå°†èŠ‚ç‚¹ä¸­çš„å‡ºç«™æµé‡é€æ˜åŠ«æŒåˆ°Â \u0060pistioout\u0060Â è™šæ‹Ÿç½‘å¡ï¼›\n- Istio CNI åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»º \u0060istioin\u0060 ç½‘å¡å’Œ iptables è§„åˆ™ï¼Œå°†èŠ‚ç‚¹ä¸­çš„å…¥ç«™æµé‡é€æ˜åŠ«æŒåˆ° \u0060pistioin\u0060 è™šæ‹Ÿç½‘å¡ï¼›\n- Istio CNI åœ¨ ztunnel ä¸­åˆ›å»º \u0060pistioin\u0060 å’Œ \u0060pistioout\u0060 ç½‘å¡ï¼Œç”¨äºæ¥æ”¶ Geneve éš§é“ä¸­çš„å‘æ¥çš„æ•°æ®åŒ…ï¼›\n\n\u0060pistioin\u0060 å’Œ \u0060pistioout\u0060 è¿™ä¸¤ä¸ªç½‘å¡æ˜¯ç”± ztunnel ä¸­çš„ init å®¹å™¨æˆ– Istio CNIï¼ˆè§ [\u0060CreateRulesWithinNodeProxyNS\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910) å‡½æ•°ï¼‰åˆ›å»ºçš„ï¼Œå…¶ IP åœ°å€å’Œç«¯å£ä¹Ÿæ˜¯å›ºå®šçš„ã€‚åº”ç”¨å®¹å™¨å‘å‡ºçš„æ•°æ®åŒ…éœ€è¦ç»è¿‡ \u0060istioout\u0060 ç½‘å¡å¹¶ä½¿ç”¨ Geneve éš§é“å°è£…åè½¬å‘ç»™ ztunnel å®¹å™¨ã€‚\n\n## ä½¿ç”¨ eBPF è¿›è¡Œé€æ˜æµé‡åŠ«æŒ\n\neBPFï¼ˆextended Berkeley Packet Filterï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥åœ¨ Linux å†…æ ¸ä¸­è¿è¡Œå®‰å…¨çš„ç”¨æˆ·æ€ç¨‹åºã€‚eBPF æœ€åˆæ˜¯ä¸€ç§ç”¨äºè¿‡æ»¤ç½‘ç»œæ•°æ®åŒ…çš„æŠ€æœ¯ï¼Œä½†ç°åœ¨å·²ç»æ‰©å±•åˆ°å…¶ä»–é¢†åŸŸï¼Œå¦‚è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ã€æ€§èƒ½åˆ†æå’Œå®‰å…¨ç›‘æ§ç­‰ã€‚eBPF çš„ä¼˜åŠ¿åœ¨äºå…¶è½»é‡çº§ã€é«˜æ•ˆã€å®‰å…¨å’Œå¯ç¼–ç¨‹æ€§ã€‚å®ƒå¯ä»¥è¢«ç”¨äºå®æ—¶ç›‘æ§ã€ç½‘ç»œå®‰å…¨ã€åº”ç”¨ç¨‹åºè°ƒè¯•å’Œä¼˜åŒ–ã€å®¹å™¨ç½‘ç»œç­‰å¤šä¸ªé¢†åŸŸã€‚\n\nåœ¨ Istio 1.18 ä¹‹å‰ï¼ŒAmbient æ¨¡å¼ä¸­ä½¿ç”¨ iptables å’Œ Geneve éš§é“å°†åº”ç”¨ç¨‹åºæµé‡é€æ˜åŠ«æŒåˆ° ztunnel ä¸­ã€‚åœ¨ Istio 1.18 ä¸­ï¼Œå¢åŠ äº† eBPF é€‰é¡¹ï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨ iptables æˆ– eBPF æ¥åšæµé‡åŠ«æŒã€‚å¦‚å›¾ 3 æ‰€ç¤ºï¼ŒeBPF ç¨‹åºç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºå†…æ ¸ï¼Œå°†åº”ç”¨ç¨‹åºçš„æµé‡è½¬å‘åˆ° ztunnel ä¸­ã€‚\n\n![å›¾ 3ï¼šä½¿ç”¨ eBPF åŠ«æŒåº”ç”¨ç¨‹åºçš„æµé‡](ebpf.svg)\n\nå›¾ 3ï¼šä½¿ç”¨ eBPF åŠ«æŒåº”ç”¨ç¨‹åºçš„æµé‡\n\n| å¯¹æ¯”é¡¹ | eBPF æ–¹å¼ | ä½¿ç”¨ iptables å’Œ Geneve éš§é“ |\n| --- | --- | --- |\n| æ•ˆç‡ | æ›´é«˜ | ç•¥ä½ |\n| å…¼å®¹æ€§ | éœ€è¦è¾ƒé«˜çš„ Linux å†…æ ¸ç‰ˆæœ¬ | æ›´å¥½ |\n| å®ç°éš¾åº¦ | è¾ƒé«˜ | è¾ƒä½ |\n| æ‰©å±•æ€§ | è¾ƒå¥½ | è¾ƒå·® |\n\næ ¹æ® [Istio å®˜æ–¹åšå®¢](https:\/\/istio.io\/latest\/blog\/2023\/ambient-ebpf-redirection\/)ä»‹ç»ï¼Œä½¿ç”¨ eBPF æ–¹å¼é¿å…äº†éƒ¨åˆ† iptables è§„åˆ™å’Œéš§é“å°è£…ï¼Œç›¸æ¯”ä½¿ç”¨ iptables å’Œ Geneve éš§é“æ›´åŠ é«˜æ•ˆã€‚ç„¶è€Œï¼ŒeBPF å¯¹ Linux å†…æ ¸ç‰ˆæœ¬çš„è¦æ±‚æ›´é«˜ï¼ˆè‡³å°‘ 4.20ï¼‰ï¼Œè€Œ iptables æ–¹å¼åˆ™å…·æœ‰æ›´å¥½çš„å…¼å®¹æ€§ã€‚æ­¤å¤–ï¼ŒeBPF æ–¹å¼çš„å®ç°éš¾åº¦è¾ƒé«˜ï¼Œä½†æ‰©å±•æ€§è¾ƒå¥½ã€‚\n\nè¦æƒ³ä½¿ç”¨ eBPF æ¨¡å¼è¿è¡Œ Ambient Meshï¼Œåªéœ€è¦åœ¨å®‰è£… Istio æ—¶è®¾ç½® \u0060values.cni.ambient.redirectMode\u0060 å‚æ•°å³å¯ï¼Œå¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## æ€»ç»“\n\næœ¬æ–‡ä»‹ç»äº† Geneve éš§é“åè®®çš„å·¥ä½œåŸç†ã€å®‰å…¨æ€§å’Œä¸ VXLAN çš„æ¯”è¾ƒã€‚æ­¤å¤–ï¼Œè¿˜ä»‹ç»äº† Istio Ambient Mesh å¦‚ä½•ä½¿ç”¨ Geneve éš§é“å®ç°æµé‡æ‹¦æˆªï¼Œå¹¶è®¨è®ºäº†ä½¿ç”¨ eBPF è¿›è¡Œé€æ˜æµé‡åŠ«æŒçš„ä¼˜ç¼ºç‚¹ã€‚Geneve éš§é“åè®®æ˜¯ä¸€ç§é€šç”¨çš„éš§é“åè®®ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿç½‘ç»œä¸­ä¼ è¾“æ•°æ®åŒ…ï¼Œå…·æœ‰æ›´å¤šçš„ä¼˜åŠ¿ï¼Œå› æ­¤åœ¨é€‰æ‹©éš§é“åè®®æ—¶ï¼Œç”¨æˆ·å¯ä»¥è€ƒè™‘ä½¿ç”¨ Geneve éš§é“ã€‚åœ¨ Istio 1.18 ä¸­æ–°æ¨å‡ºäº† Ambient Mesh çš„çš„ eBPF æ¨¡å¼ï¼Œå¯ä»¥æä¾›ç½‘ç»œæ•ˆç‡ï¼Œä½†å¯¹ Linux å†…æ ¸ç‰ˆæœ¬æœ‰æ›´é«˜è¦æ±‚ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µé€‰ç”¨ã€‚\n\n## å‚è€ƒ\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n', '\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»äº†ä»€ä¹ˆæ˜¯ Geneve éš§é“ï¼Œä¸ VXLAN çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒåœ¨ Istio Ambient Mesh ä¸­çš„åº”ç”¨ï¼Œæœ€åè°ˆåŠä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡æ‹¦æˆªã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/ocsp-stapling-for-istio-gateways/">Istio Gateway ä¸­å¯¹è¯ä¹¦æ’¤é”€çš„æ”¯æŒ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/02/06</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Gateway ä¸­å¯¹è¯ä¹¦æ’¤é”€çš„æ”¯æŒ', 'è¿™ç¯‡åšå®¢å°†å‘ä½ ä»‹ç»è¯ä¹¦æ’¤é”€çš„æ–¹å¼å’Œ Istio çš„è§£å†³æ–¹æ¡ˆã€‚', '\næœ€è¿‘ Istio ç¤¾åŒºæ­£åœ¨å¤„ç† [Issue 17763](https:\/\/github.com\/istio\/istio\/issues\/17763)ï¼Œä»¥å¢åŠ  Istio å¯¹è¯ä¹¦æ’¤é”€çš„æ”¯æŒï¼Œç›®å‰è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘å·¥ç¨‹ä¸­ï¼Œè§ [PR #42859 - OSCP Stapling](https:\/\/github.com\/istio\/istio\/pull\/42859) å’Œ [OCSP Stapling for Istio Gateways](https:\/\/docs.google.com\/document\/d\/15wwYyVyOluubL2KIM89b2X8NFwyhMVxq2_I1MESrZdI\/edit#)ã€‚è¿™ç¯‡åšå®¢å°†å‘ä½ ä»‹ç»è¯ä¹¦æ’¤é”€çš„æ–¹å¼å’Œ Istio çš„è§£å†³æ–¹æ¡ˆè¿›å±•ã€‚\n\nIstio ä½¿ç”¨ Envoy SDS åˆ†å‘è¯ä¹¦ï¼Œä¸€å…±æœ‰ä¸¤ç§æƒ…å½¢ï¼š\n\n- åˆ†å‘å†…éƒ¨è¯ä¹¦ï¼Œç”¨äº mTLSï¼Œè¿™ç§æƒ…å†µéœ€è¦åˆ†åˆ«éªŒè¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¯ä¹¦æ˜¯å¦è¢«æ’¤é”€\n- åˆ†å‘å¤–éƒ¨æœåŠ¡çš„è¯ä¹¦ç»™é›†ç¾¤å†…çš„æœåŠ¡ï¼Œç”¨äºå‘é›†ç¾¤å¤–çš„é€šä¿¡åŠ å¯†ï¼Œæ­¤æ—¶é›†ç¾¤å†…çš„æœåŠ¡ç›¸å½“äºå®¢æˆ·ç«¯ï¼Œä»…éœ€éªŒè¯æœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦è¢«æ’¤é”€\n\næœ¬æ–‡æ¢è®¨çš„æ˜¯ç¬¬äºŒç§æƒ…å½¢ï¼Œå³ Istio Gateway çš„è¯ä¹¦æ’¤é”€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![Istio Gateway çš„è¯ä¹¦æ’¤é”€ç¤ºæ„å›¾](cert-revoke.svg)\n\nCA é€šè¿‡è®¾ç½® TTL æ§åˆ¶è¯ä¹¦çš„å¯¿å‘½ï¼Œå¦‚æœè¦æå‰ç»“æŸè¯ä¹¦å¯ä»¥å°†è¯ä¹¦æ’¤é”€ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ’¤é”€è¯ä¹¦ï¼š\n\n1. é…ç½®è¯ä¹¦æ’¤é”€åˆ—è¡¨ï¼ˆCRLï¼‰\n2. åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®ï¼ˆOCSPï¼‰\n\n## CRLï¼ˆè¯ä¹¦æ’¤é”€åˆ—è¡¨ï¼‰\n\nCRLï¼ˆè¯ä¹¦åŠé”€åˆ—è¡¨ï¼‰æ˜¯ä¸€ç§ç”¨äºç®¡ç†å’ŒéªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§çš„æœºåˆ¶ã€‚å®ƒåŒ…å«ä¸€ä¸ªå·²è¢«æ’¤é”€çš„è¯ä¹¦åˆ—è¡¨ï¼Œé¢å‘æœºæ„ï¼ˆCAï¼‰å®šæœŸæ›´æ–°è¯¥åˆ—è¡¨ã€‚å½“éªŒè¯è¯ä¹¦çš„å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨ï¼‰æ”¶åˆ°è¯ä¹¦æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥è¯¥è¯ä¹¦æ˜¯å¦åœ¨ CRL ä¸­è¢«åˆ—ä¸ºå·²æ’¤é”€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯¥è¯ä¹¦è¢«è§†ä¸ºæ— æ•ˆã€‚\n\nCRL é€šå¸¸å­˜å‚¨åœ¨é¢å‘æœºæ„ï¼ˆCAï¼‰çš„æœåŠ¡å™¨ä¸Šï¼Œå¹¶å¯ä»¥é€šè¿‡äº’è”ç½‘å…¬å¼€è®¿é—®ã€‚éªŒè¯è¯ä¹¦çš„å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ï¼Œæµè§ˆå™¨ï¼‰å¯ä»¥ä¸‹è½½å¹¶æ£€æŸ¥ CRL ä»¥ç¡®å®šè¯ä¹¦æ˜¯å¦æœ‰æ•ˆã€‚CRL å¯ä»¥ä»¥å¤šç§æ ¼å¼ï¼ˆå¦‚ DER æˆ– PEMï¼‰å­˜å‚¨ï¼Œå¹¶é€šè¿‡ HTTPï¼ŒLDAP æˆ–å…¶ä»–åè®®å‘å¸ƒï¼Œä»¥ä¾¿è¿›è¡ŒéªŒè¯ã€‚\n\nCRL æ–‡ä»¶é€šå¸¸æ˜¯ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨çš„ï¼Œä¸æ˜¯ç›´æ¥å¯è¯»çš„æ–‡æœ¬æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·ï¼ˆä¾‹å¦‚ OpenSSLï¼‰è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼ï¼Œä¾‹å¦‚ PEMï¼Œä»¥æ–¹ä¾¿é˜…è¯»ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåä¸º \u0060crl.pem\u0060 çš„ CRL ç¤ºä¾‹æ–‡ä»¶ï¼Œä»¥ PEM æ ¼å¼è¡¨ç¤ºï¼š\n\n\u0060\u0060\u0060dockerfile\n-----BEGIN X509 CRL-----\nMIIBtjCBqwIBATANBgkqhkiG9w0BAQUFADBBMQswCQYDVQQGEwJVUzERMA8GA1UE\nCBMITmV3IFlvcmsxETAPBgNVBAcTCE5ldyBZb3JrMREwDwYDVQQKEwhNeSBDQTEQ\nMA4GA1UECxMHQ2VydGlmaWNhdGUxGDAWBgNVBAMTD01ZIEJ1c2luZXNzIENBMB4X\nDTA5MDUwMzE1MTQwMFoXDTEwMDUwMjE1MTQwMFqgLzAtMB8GA1UdIwQYMBaAFJ4f\n6Nz7Vuw\/NcZXG0U8O6OZ9XB0MAsGA1UdDwQEAwIFoDAdBgNVHQ4EFgQUU6G9fjRK\nop\u002bJU6vQPnnhxBxHtzUwDQYJKoZIhvcNAQEFBQADgYEAbYoLz7MnJ4ltIS\u002bnCquG\nN\/v\u002b8rE00\/N0pGzN\/dCv\/8t0W0tGTGr2zGRb0mv67MPOmWmHcZZq3sOxgEIp8T\u002bO\nOJxDCD\/xJN6hB0NgN\/Z0\u002bfX9hU6bL\/6zhwUy\/l51xddmSd5KKhJ7FmOh2Py5m9Au\n4fJh7w\u002bOLyjKV7rz55WKjvY=\n-----END X509 CRL-----\n\u0060\u0060\u0060\n\nä½¿ç”¨ OpenSSL å°†å…¶è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š\n\n\u0060\u0060\u0060bash\nopenssl crl -inform PEM -in crl.pem -noout -text\n\u0060\u0060\u0060\n\nè¾“å‡ºç»“æœä¸ºï¼š\n\n\u0060\u0060\u0060\nCertificate Revocation List (CRL):\n        Version 2 (0x1)\n    Signature Algorithm: sha256WithRSAEncryption\n        Issuer: \/C=US\/ST=New York\/L=New York\/O=My CA\/OU=Certificate\/CN=My Business CA\n        Last Update: May 3 11:40:00 2009 GMT\n        Next Update: May 2 11:40:00 2010 GMT\n    Revoked Certificates:\n        Serial Number: 1 (0x1)\n            Revocation Date: May 3 11:40:00 2009 GMT\n\u0060\u0060\u0060\n\n**æ³¨æ„**ï¼šè¯¥ CRL æ–‡ä»¶çš„åˆ—è¡¨ä¸­åªä¿å­˜äº†ä¸€ä¸ªæ’¤é”€è¯ä¹¦ã€‚\n\nCRL è™½è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†ä½¿ç”¨ CRL æ–‡ä»¶æ¥æ’¤é”€è¯ä¹¦å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š\n\n1. **æ—¶æ•ˆæ€§**ï¼šCRL æ–‡ä»¶å¿…é¡»å®šæœŸæ›´æ–°ï¼Œå¦åˆ™å°†æ— æ³•è¯†åˆ«è¿‘æœŸæ’¤é”€çš„è¯ä¹¦ï¼›\n2. **å¯ç”¨æ€§**ï¼šå¦‚æœæ— æ³•è®¿é—® CRL æœåŠ¡å™¨ï¼Œåˆ™æ— æ³•éªŒè¯è¯ä¹¦æ˜¯å¦å·²è¢«æ’¤é”€ï¼›\n3. **æ•ˆç‡**ï¼šCRL æ–‡ä»¶éšç€è¯ä¹¦æ•°é‡çš„å¢åŠ è€Œå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œå› æ­¤éªŒè¯è¯ä¹¦çš„è¿‡ç¨‹å¯èƒ½ä¼šå˜æ…¢ï¼›\n4. **å®‰å…¨æ€§**ï¼šCRL æ–‡ä»¶æœ¬èº«ä¹Ÿéœ€è¦å®‰å…¨ä¿æŠ¤ï¼Œå¦åˆ™æ”»å‡»è€…å¯èƒ½ä¼šç¯¡æ”¹ CRL ä»¥é€ƒé¿æ’¤é”€è¯ä¹¦çš„é™åˆ¶ï¼›\n\nå› æ­¤ï¼Œç°åœ¨æœ‰æ›´é«˜æ•ˆå’Œå®‰å…¨çš„è¯ä¹¦æ’¤é”€æœºåˆ¶ï¼Œä¾‹å¦‚ OCSPï¼ˆOnline Certificate Status Protocolï¼‰ï¼Œå®ƒå¯ä»¥å®æ—¶éªŒè¯è¯ä¹¦çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä¸éœ€è¦å­˜å‚¨æ‰€æœ‰å·²æ’¤é”€è¯ä¹¦çš„åˆ—è¡¨ã€‚\n\n## OCSP Stapling\n\nOCSP Staplingï¼ˆæ­£å¼åç§°ä¸º TLS è¯ä¹¦çŠ¶æ€æŸ¥è¯¢æ‰©å±•ï¼‰æ˜¯ä¸€ç§ TLSï¼ˆTransport Layer Securityï¼‰æ‰©å±•ï¼Œç”¨äºè¯æ˜è¯ä¹¦çš„çŠ¶æ€æ˜¯æœ‰æ•ˆçš„ã€‚å®ƒå…è®¸æœåŠ¡å™¨é¢„å…ˆæ£€ç´¢è¯ä¹¦çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶å°†è¯¥ä¿¡æ¯â€œé’‰â€åˆ° TLS è¯ä¹¦ä¸­ï¼Œä»¥å‡å°‘å¯¹è¯ä¹¦é¢å‘æœºæ„çš„ä¾èµ–ï¼Œå¹¶æé«˜è¯ä¹¦çŠ¶æ€éªŒè¯çš„æ•ˆç‡ã€‚å¯ä»£æ›¿ OCSP æ¥æŸ¥è¯¢ X.509 è¯ä¹¦çš„çŠ¶æ€ã€‚æœåŠ¡å™¨åœ¨ TLS æ¡æ‰‹æ—¶å‘é€äº‹å…ˆç¼“å­˜çš„ OCSP å“åº”ï¼Œç”¨æˆ·åªéœ€éªŒè¯è¯¥å“åº”çš„æœ‰æ•ˆæ€§è€Œä¸ç”¨å†å‘æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼‰å‘é€è¯·æ±‚ã€‚è¯¦è§[ç»´åŸºç™¾ç§‘](https:\/\/en.wikipedia.org\/wiki\/OCSP_stapling)ã€‚\n\nOCSP åªé€‚ç”¨äºå•ä¸ªè¯ä¹¦ï¼Œè€Œä¸æ˜¯åˆ—è¡¨ã€‚å®¢æˆ·ç«¯åœ¨æ”¶åˆ°è¯ä¹¦åï¼Œä¸ CA é€šä¿¡ä»¥æ£€æŸ¥æ’¤é”€çŠ¶æ€ã€‚å“åº”å¯ä»¥æ˜¯ \u0022good\u0022ã€\u0022revoked\u0022 æˆ– \u0022unknown\u0022 ä¹‹ä¸€ã€‚\n\nä½¿ç”¨ OSCP Stapling è™½ç„¶çœå»äº†ç»´æŠ¤ CRL çš„è´Ÿæ‹…ï¼Œä½†æ˜¯å®ƒä¾ç„¶æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š\n\n1. **é¢å¤–çš„èµ„æºå¼€é”€**ï¼šCA æœåŠ¡å™¨éœ€è¦ä¸æ–­åœ°å“åº” OCSP è´¨è¯¢ä»¥ç¡®ä¿è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼Œè¿™å°†å¯¹æœåŠ¡å™¨çš„ CPU å’Œç½‘ç»œå¸¦å®½é€ æˆé¢å¤–çš„å¼€é”€ï¼›\n2. **å¯ç”¨æ€§é—®é¢˜**ï¼šå¦‚æœ OCSP æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™å®¢æˆ·ç«¯å°†æ— æ³•è·å¾—è¯ä¹¦çš„æœ‰æ•ˆæ€§ä¿¡æ¯ï¼›\n3. **å®‰å…¨é—®é¢˜**ï¼šå¦‚æœ OCSP å“åº”è¢«ç¯¡æ”¹æˆ–æœåŠ¡å™¨ä¸å®‰å…¨ï¼Œåˆ™è¯ä¹¦çš„æœ‰æ•ˆæ€§ä¿¡æ¯å¯èƒ½è¢«ç¯¡æ”¹ï¼Œä»è€Œå½±å“å®‰å…¨ï¼›\n4. **å…¼å®¹æ€§é—®é¢˜**ï¼šOCSP Stapling ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒçš„åŠŸèƒ½ï¼Œå› æ­¤å¯èƒ½éœ€è¦åœ¨æ—§æµè§ˆå™¨ä¸Šå®ç°é¢å¤–çš„å…¼å®¹æ€§ã€‚\n\nOCSP çš„æŒ‘æˆ˜æ˜¯ï¼Œå®ƒç»™ CA å¸¦æ¥äº†å¾ˆå¤§çš„è´Ÿæ‹…ï¼Œå› ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦ç‹¬ç«‹åœ°è·å¾—è¯ä¹¦çš„éªŒè¯ã€‚æ€»ä½“è€Œè¨€ï¼ŒOCSP Stapling å¯ä»¥æé«˜è¯ä¹¦éªŒè¯çš„æ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å› æ­¤ï¼Œåœ¨é‡‡ç”¨è¯¥æŠ€æœ¯æ—¶éœ€è¦ç»¼åˆè€ƒè™‘å¤šæ–¹é¢çš„å› ç´ ã€‚\n\n## Istio å¯¹ OSCP Stapling æ”¯æŒ\n\nå¾ˆå¤š Web æœåŠ¡å™¨éƒ½æ”¯æŒ OSCP Staplingï¼Œäº‘åŸç”Ÿè¾¹ç¼˜ä»£ç† Envoy ä¹Ÿæ”¯æŒè¯¥åŠŸèƒ½ï¼Œéœ€è¦å¯¹ Envoy è¿›è¡Œä»¥ä¸‹é…ç½®ï¼š\n\n- é…ç½® [\u0060DownstreamTlsContext\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/transport_sockets\/tls\/v3\/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-downstreamtlscontext) ä¸­çš„ \u0060oscp_staple_policy\u0060ï¼š\n  - \u0060LENIENT_STAPLING\u0060ï¼šOCSP å“åº”æ˜¯å¯é€‰çš„ï¼Œæ­¤ä¸ºé»˜è®¤å€¼\n  - \u0060STRICT_STAPLING\u0060ï¼šOCSP å“åº”æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœå­˜åœ¨å¹¶ä¸”æœ‰æ•ˆï¼Œå°±ä¼šä½¿ç”¨ã€‚\n  - \u0060MUST_STAPLE\u0060: OCSP å“åº”æ˜¯å¿…éœ€çš„\n- é…ç½® [\u0060TlsCertificate\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/transport_sockets\/tls\/v3\/common.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-tlscertificate) ä¸­çš„ \u0060oscp_staple\u0060ï¼Œå“åº”å¿…é¡»æ˜¯ DER ç¼–ç çš„ï¼Œåªèƒ½é€šè¿‡æ–‡ä»¶åæˆ– \u0060inline_bytes\u0060 æä¾›ã€‚å“åº”å¯èƒ½åªä¸ä¸€ä¸ªè¯ä¹¦æœ‰å…³ã€‚\n\nç›®å‰ Envoy å·²æ”¯æŒ OSCP Staplingï¼Œå…¶ä½œä¸º Istio çš„æ•°æ®å¹³é¢å’Œ Istio Gateway ä¸­çš„ä»£ç†ï¼Œç†è®ºä¸Š Istio ä¹Ÿå¯ä»¥æ”¯æŒè¯¥åŠŸèƒ½ã€‚ä¸è¿‡ Istio çš„ OSCP Stapling è¯ä¹¦æ’¤é”€åŠŸèƒ½æ”¯æŒä»åœ¨è¿›è¡Œä¸­ï¼Œè¯¦è§ [PR #42859 - OSCP Stapling](https:\/\/github.com\/istio\/istio\/pull\/42859)ã€‚è¯¥åŠŸèƒ½çš„æ–°è¿›å±•å°†åœ¨æœ¬æ–‡ä¸­æ›´æ–°ï¼Œè¯·ä¿æŒå…³æ³¨ã€‚\n', '\/blog\/ocsp-stapling-for-istio-gateways\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">è¿™ç¯‡åšå®¢å°†å‘ä½ ä»‹ç»è¯ä¹¦æ’¤é”€çš„æ–¹å¼å’Œ Istio çš„è§£å†³æ–¹æ¡ˆã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/optimize-traffic-management-and-security-with-these-service-mesh-best-practices/">[è¯‘] æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§ä¼˜åŒ–æœ€ä½³å®è·µ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/02/01</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/optimize-traffic-management-and-security-with-these-service-mesh-best-practices/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§ä¼˜åŒ–æœ€ä½³å®è·µ', 'æœ¬æ–‡æ¨èäº†æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§ä¼˜åŒ–çš„ä¸€äº›æœ€ä½³å®è·µã€‚', '\nè¿™æ˜¯ [æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—æ–‡ç« ](https:\/\/tetrate.io\/blog\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) ä¸­çš„ç¬¬ä¸‰ç¯‡ï¼Œæ‘˜è‡ª Tetrate åˆ›å§‹å·¥ç¨‹å¸ˆ Zack Butcher å³å°†å‡ºç‰ˆçš„æ–°ä¹¦ Istio in Productionã€‚\n\nIstio å°±åƒä¸€ç»„ä¹é«˜ç§¯æœ¨ï¼šå®ƒå…·æœ‰è®¸å¤šåŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ç…§ä½ æƒ³è¦çš„ä»»ä½•æ–¹å¼è¿›è¡Œç»„è£…ã€‚å‡ºç°çš„ç»“æ„å–å†³äºä½ å¦‚ä½•ç»„è£…é›¶ä»¶ã€‚åœ¨ [ä¸Šä¸€ç¯‡ä¸­](..\/service-mesh-deployment-best-practices-for-security-and-high-availability\/)ï¼Œæˆ‘ä»¬æè¿°äº†ä¸€ç§è¿è¡Œæ—¶æ‹“æ‰‘ç»“æ„ï¼Œç”¨äºæ„å»ºå¥å£®ã€æœ‰å¼¹æ€§ä¸”å¯é çš„åŸºç¡€æ¶æ„ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°ä¸€ç»„ç½‘æ ¼é…ç½®ï¼Œä»¥å¸®åŠ©åœ¨è¿è¡Œæ—¶å®ç°ç¨³å¥æ€§ã€å¼¹æ€§ã€å¯é æ€§å’Œå®‰å…¨æ€§ã€‚\n\nIstio åœ¨å…¶æ‰€è°“çš„ [æ ¹å‘½åç©ºé—´](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-root_namespace) ä¸­æ”¯æŒå…¨å±€é»˜è®¤é…ç½® â€”â€” é»˜è®¤åœ¨ \u0060istio-system\u0060ã€‚åœ¨æ ¹å‘½åç©ºé—´ä¸­å‘å¸ƒçš„é…ç½®é»˜è®¤é€‚ç”¨äºæ‰€æœ‰æœåŠ¡ï¼Œä½†åœ¨æœ¬åœ°å‘½åç©ºé—´ä¸­å‘å¸ƒçš„ä»»ä½•é…ç½®éƒ½ä¼šè¦†ç›–å®ƒã€‚å› æ­¤ï¼Œä¸€äº›é…ç½®åº”è¯¥åœ¨æ ¹å‘½åç©ºé—´ä¸­å‘å¸ƒï¼Œå¹¶ä¸”ä¸å…è®¸åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹å‘å¸ƒï¼ˆä¾‹å¦‚ç”¨äºåœ¨ä¼ è¾“ä¸­å¼ºåˆ¶åŠ å¯†çš„ PeerAuthentication ç­–ç•¥ï¼‰ã€‚å…¶ä»–é…ç½®åº”è¯¥åœ¨æ¯ä¸ªæœåŠ¡è‡ªå·±çš„å‘½åç©ºé—´ä¸­ç¼–å†™ï¼ˆä¾‹å¦‚ VirtualService æ§åˆ¶å®ƒçš„å¼¹æ€§è®¾ç½®ï¼‰ã€‚\n\næˆ‘ä»¬çœ‹åˆ°çš„æœ€æˆåŠŸçš„ç½‘æ ¼é‡‡ç”¨å°†ç½‘æ ¼æœ¬èº«éšè—åœ¨å¦ä¸€ä¸ªç•Œé¢åé¢ï¼šä¾‹å¦‚ Helm æ¨¡æ¿ã€Terraform æˆ–æ›´é«˜çº§çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ [Tetrate Service Bridge (TSB)](https:\/\/tetrate.io\/tetrate-service-bridge\/)ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯åªå…¬å¼€åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜åº”è¯¥é…ç½®çš„ä¸€å°éƒ¨åˆ†ç½‘æ ¼åŠŸèƒ½ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨ä»–ä»¬ç†è§£çš„è¯­è¨€ï¼ˆä¾‹å¦‚ï¼ŒTSB å¯ä»¥ä½¿ç”¨ [å¸¦æ³¨é‡Šçš„ OpenAPI è§„èŒƒ](https:\/\/docs.tetrate.io\/service-bridge\/1.6.x\/en-us\/quickstart\/apps) è¿›è¡Œé…ç½®ï¼‰ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬é€šå¸¸åªå‘åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å…¬å¼€æµé‡è®¾ç½®å’Œæˆæƒã€‚èº«ä»½éªŒè¯å’Œé¥æµ‹ç”±å„è‡ªçš„å›¢é˜Ÿæˆ–ä»£è¡¨ä»–ä»¬çš„å¹³å°å›¢é˜Ÿé›†ä¸­æ§åˆ¶ã€‚[NIST SP800-204 ç³»åˆ—](https:\/\/tetrate.io\/blog\/nist-standards-for-zero-trust-the-sp-800-204-series\/)ï¼Œå°¤å…¶æ˜¯ [SP 800-204A](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204a\/final) å’Œ [SP 800-204B](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204b\/final)ã€‚Istio é¡¹ç›®ç«™ç‚¹ä¹Ÿæœ‰ä¸€ç»„ [æœ€ä½³å®è·µ](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/)ï¼Œä¹Ÿå€¼å¾—æ”¶è—ã€‚\n\n## æœåŠ¡ç½‘æ ¼å‘½åçº¦å®š\n\n**å»ºè®®**ï¼šä¸º Istio èµ„æºå¼€å‘å’Œç»´æŠ¤ä¸€è‡´çš„å‘½åæ–¹æ¡ˆï¼Œæœ€å¥½åŸºäºå®ƒä»¬é…ç½®çš„æœåŠ¡æˆ–ä¸»æœºã€‚\n\n**å»ºè®®**ï¼šä¸ºè·¨é›†ç¾¤çš„å›¢é˜Ÿä¿æŒä¸€è‡´çš„åç§°ã€‚å‘½åç©ºé—´åº”è¯¥ç”±ä¸€ä¸ªå›¢é˜Ÿæ‹¥æœ‰ã€‚\n\nIstio èµ„æºåº”è¯¥æ ¹æ®å®ƒä»¬é…ç½®çš„æœåŠ¡æˆ–ä¸»æœºæ¥å‘½åï¼š\u0060ServiceEntry\u0060 æ·»åŠ  \u0060api.example.com\u0060 åˆ°ç½‘æ ¼çš„åº”è¯¥å‘½åä¸º \u0060external-api-example-com\u0060ï¼›æœåŠ¡çš„ \u0060DestinationRule\u0060ã€\u0060VirtualService\u0060ã€\u0060PeerAuthentication\u0060 å’Œ \u0060Authorization\u0060 ç­–ç•¥ä¹Ÿéƒ½åº”è¯¥æœ‰ç›¸åŒçš„åç§°ã€‚PCI å‘½åç©ºé—´ä¸­çš„å†…éƒ¨æœåŠ¡ Paymentsï¼ˆåº”ç”¨ç¨‹åºä»£ç ä¸­çš„ hostname \u0060payments.pci\u0060ï¼‰åº”è¯¥è¢«å‘½åä¸º \u0060payment-pci\u0060ï¼Œå…¶æ‰€æœ‰çš„ç½‘æ ¼é…ç½®åç§°ä¹Ÿåº”è¯¥åŒ¹é…ã€‚è¿™äº›å‘½åæ–¹æ¡ˆå¹¶ä¸æ˜¯ç¡¬æ€§è§„å®šï¼Œä½†ä½ åº”è¯¥åœ¨ä½ çš„ç»„ç»‡å†…å»ºç«‹å¹¶åšæŒä¸€ä¸ªä¸€è‡´çš„æƒ¯ä¾‹ã€‚\n\nè¿™äº›èµ„æºåº”è¯¥å…¨éƒ¨å‘å¸ƒåœ¨å®ƒä»¬é…ç½®çš„æœåŠ¡çš„å‘½åç©ºé—´ä¸­ï¼Œæˆ–è€…å‘å¸ƒåœ¨ \u0060istio-system\u0060 å‘½åç©ºé—´ä¸­ä»¥è¿›è¡Œç½‘æ ¼èŒƒå›´çš„é…ç½®ã€‚å¤–éƒ¨æœåŠ¡é€šå¸¸å‘å¸ƒåˆ° \u0060istio-system\u0060 ä¸­å¹¶ç”±ä¸­å¿ƒå›¢é˜Ÿï¼ˆå¹³å°æˆ–å®‰å…¨å›¢é˜Ÿï¼‰ç®¡ç†ã€‚\n\næˆ‘ä»¬å»ºè®®è·¨é›†ç¾¤çš„å›¢é˜Ÿä½¿ç”¨ä¸€è‡´çš„åç§°ï¼šæ— è®ºé›†ç¾¤ç§Ÿæˆ·æ¨¡å‹å¦‚ä½•ï¼Œå‘½åç©ºé—´éƒ½åº”ç”±å•ä¸ªå›¢é˜Ÿæ‹¥æœ‰ï¼ˆè¯·å‚é˜…ä¸‹ä¸€èŠ‚ï¼‰ã€‚\n\n## æœåŠ¡ç½‘æ ¼å…¨å±€è®¾ç½®\n\n**é…ç½®å¯è§æ€§**ã€‚Istio æœ‰ä¸€ä¸ªé…ç½®å¯è§æ€§çš„æƒ³æ³•ï¼šé…ç½®å¯ä»¥é»˜è®¤åº”ç”¨äºæ•´ä¸ªé›†ç¾¤ï¼Œæˆ–è€…å®ƒå¯ä»¥åªåº”ç”¨äºæœ¬åœ°å‘½åç©ºé—´ï¼Œç”šè‡³å¯ä»¥åªåº”ç”¨äºå•ä¸ªæœåŠ¡ï¼ˆé€‰æ‹©å¯¹æ•´ä¸ªé›†ç¾¤å¯è§ï¼Œæˆ–è€…åªæ˜¯ç‰¹å®šçš„å‘½åç©ºé—´ï¼‰ã€‚ä¸ºäº†æ€§èƒ½å’Œå®‰å…¨ï¼Œä½ åº”è¯¥å°†è¯¥å­—æ®µé»˜è®¤ä¸º \u0060exportTo\u0060 æœ¬åœ°åç§°ç©ºé—´ï¼ˆâ€œ.â€ï¼‰ã€‚ä½ åº”è¯¥åœ¨å®‰è£…æ—¶ä¸º [*Services*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_service_export_to)ã€[*VirtualServices*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_virtual_service_export_to) å’Œ [*DestinationRules*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_destination_rule_export_to) è®¾ç½®è¿™ä¸ªé»˜è®¤å€¼ã€‚æŸ¥çœ‹ Istio çš„ [å…¨å±€é…ç½®](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_service_export_to) æ¥é…ç½®è¿™äº›é»˜è®¤å€¼ï¼š\n\n\u0060\u0060\u0060yaml\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n name: controlplane\n namespace: istio-system\nspec:\n # profile: default\n # ...\n meshConfig:\n   defaultServiceExportTo:\n   - \u0022.\u0022# only the namespace the resource is published in\n   defaultVirtualServiceExportTo:\n   - \u0022.\u0022\n   # equivalent, just different YAML syntax\n   defaultDestinationRuleExportTo: [\u0022.\u0022]\n\u0060\u0060\u0060\n\nç¤ºä¾‹ 1ï¼šé»˜è®¤å…¨å±€è®¾ç½®\n\n**æ¯ä¸ªå‘½åç©ºé—´çš„ Sidecar èµ„æºé…ç½®**ã€‚Istio çš„ \u0060Sidecar\u0060 ï¼ˆAPIï¼‰èµ„æºæ§åˆ¶ Istio å°†å“ªäº›é…ç½®å‘é€åˆ°æ¯ä¸ªå‘½åç©ºé—´ä¸­çš„ Sidecarã€‚ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½å’Œæœ€ä½å¼€é”€ï¼Œä½ åº”è¯¥ä¸ºæ¯ä¸ªå‘½åç©ºé—´ç®¡ç†ä¸€ä¸ªé…ç½®ï¼Œå¹¶ç®¡ç† egress éƒ¨åˆ†ä»¥ä»…åŒ…æ‹¬æœåŠ¡å¿…é¡»ä¸ä¹‹é€šä¿¡çš„ä¸»æœºã€‚è¿™å°†å¯¼è‡´ Istio å‘è¯¥å‘½åç©ºé—´ä¸­çš„ Envoy å®ä¾‹å‘é€æ›´å°‘çš„é…ç½®ï¼Œä»è€Œå‡å°‘å®ƒä»¬çš„å†…å­˜å’Œ CPU æ¶ˆè€—ã€‚ç»“åˆä»…æ³¨å†Œè¡¨å‡ºç«™æµé‡ç­–ç•¥ï¼ˆè§ä¸‹ä¸€æ¡ï¼‰ï¼ŒSidecar èµ„æºè¿˜å¯ä»¥å¸®åŠ©é™åˆ¶æ”»å‡»è€…é€šè¿‡ Envoy çš„è¡¨é¢åŒºåŸŸï¼Œå› ä¸ºä¸åœ¨ Sidecar çš„ egress éƒ¨åˆ†çš„ä¸»æœºå°†æ˜¯è¯¥ Envoy å®ä¾‹çš„ \u0022å‡ºç«™æµé‡\u0022ã€‚è¿™æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªè¶³å¤Ÿçš„å®‰å…¨ç­–ç•¥ï¼ˆè§ä¸‹é¢çš„å®‰å…¨éƒ¨åˆ†ï¼‰ï¼Œè€Œæ˜¯å¢åŠ äº†ä¸€ä¸ªæ”»å‡»è€…å¿…é¡»ç©¿è¶Šçš„é¢å¤–é˜²å¾¡å±‚ã€‚\n\n**ç¼–å†™æ˜ç¡®çš„å‡ºç«™ï¼ˆegressï¼‰æµé‡ç­–ç•¥**ã€‚Istio æä¾›äº†ä¸€äº›é€‰é¡¹æ¥é…ç½®å®ƒå¦‚ä½•å¤„ç†ç½‘æ ¼ä¸­çš„æœåŠ¡ï¼Œè¯¥æœåŠ¡è¯•å›¾ä¸ Istio æœªçŸ¥çš„ç«¯ç‚¹è¿›è¡Œé€šä¿¡ï¼š[Outbound Traffic Policy](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-OutboundTrafficPolicy-Mode)ã€‚Istio å¯ä»¥å…è®¸æ‰€æœ‰æµé‡ï¼Œä¹Ÿå¯ä»¥å°†æµé‡é™åˆ¶åœ¨ç½‘æ ¼å·²çŸ¥çš„æœåŠ¡ä¸Šã€‚ä½ åº”è¯¥åœ¨å®‰è£…æ—¶é…ç½® Istioï¼Œåªå…è®¸è¿æ¥åˆ°æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ã€‚æ­¤å¤–ï¼Œä½ åº”è¯¥å°†æ‰€æœ‰éœ€è¦ä¸ä¹‹é€šä¿¡çš„å¤–éƒ¨æœåŠ¡å»ºæ¨¡ä¸º Mesh ä¸­çš„ ServiceEntriesï¼ˆä¾‹å¦‚ï¼ŒSaaS æœåŠ¡çš„ DNS è§£æç­‰ï¼‰ï¼Œä½¿ç”¨ DestinationRules æ¥é…ç½®ä¸å®ƒä»¬é€šä¿¡çš„ TLSã€‚è¿™äº›å¤–éƒ¨æœåŠ¡åº”è¯¥ç”±å®‰å…¨å›¢é˜Ÿé›†ä¸­ç®¡ç†ï¼Œæˆ–è€…ç”±å¹³å°å›¢é˜Ÿä»£è¡¨ä»–ä»¬ç®¡ç†ã€‚\n\n## è¿è¡Œæ—¶æµé‡ç®¡ç†é…ç½®\n\n**ä¸ºæœåŠ¡ä½¿ç”¨ä¸€è‡´çš„å…¨å±€åç§°ï¼Œå¹¶ä½¿ç”¨ Istio å°†å®ƒä»¬æ˜ å°„åˆ°æœ¬åœ°å®ä¾‹**ã€‚ä½ åº”è¯¥ä½¿ç”¨ä¸€è‡´çš„å…¨å±€åç§°æ¥è®¿é—®æœåŠ¡ã€‚ä½ å¯ä»¥ä½¿ç”¨ Istio å°†è¿™äº›å…¨å±€åç§°æ˜ å°„åˆ°æœ¬åœ°å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œ\u0060payments.tetrate.internal\u0060 å¯ä»¥è¢«æ‰€æœ‰å†…éƒ¨åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œè€Œ Istio å¯ä»¥ç”¨æ¥å°†è¯¥åç§°æ˜ å°„åˆ°æœåŠ¡å®ä¾‹ï¼Œä¾‹å¦‚â€œåœ¨ \u0060us-east-2\u0060 Kubernetes é›†ç¾¤ä¸­çš„ \u0060payments.default.svc.cluster.local\u0060 æœåŠ¡â€ã€‚è¿™ç§å…¨å±€å‘½åæ–¹æ¡ˆä½¿å¼€å‘äººå‘˜å¯ä»¥åƒ SaaS ä¸€æ ·è€ƒè™‘æ‰€æœ‰æœåŠ¡ï¼Œè€Œæ— éœ€ä»”ç»†è€ƒè™‘è¿è¡Œæ—¶æ‹“æ‰‘çš„ç»†èŠ‚ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°æ‰§è¡Œæ•…éšœè½¬ç§»ã€é‡‘ä¸é›€å’Œè·¨é›†ç¾¤è·¯ç”±ç­‰æ“ä½œï¼Œä½œä¸ºä½ çš„ç½‘æ ¼ä½¿ç”¨æˆç†Ÿæˆ–ç»„ç»‡éœ€æ±‚æ¼”å˜ã€‚\n\n**åœ¨æ ¹é…ç½®ä¸­å®šä¹‰ç²—ç•¥çš„é»˜è®¤å¼¹æ€§è®¾ç½®**ã€‚ä½ åº”è¯¥ä¸ºç½‘æ ¼ä¸­çš„æ‰€æœ‰æœåŠ¡å®šä¹‰ç²—ç•¥çš„è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­å’Œå¼‚å¸¸å€¼æ£€æµ‹è®¾ç½®ã€‚ä½ å¯ä»¥åœ¨æ ¹é…ç½®å‘½åç©ºé—´ä¸­ä½¿ç”¨ \u0060VirtualService\u0060 æ¥å®ç°æ­¤ç›®çš„ã€‚å„ä¸ªå›¢é˜Ÿåº”åœ¨å…¶æœ¬åœ°å‘½åç©ºé—´ä¸­æŒ‡å®šè‡ªå·±çš„åç§°ä»¥è¦†ç›–é»˜è®¤å€¼ã€‚\n\n**ä¸ºåº”ç”¨ç¨‹åºå›¢é˜Ÿæä¾›ç®€åŒ–çš„â€œä½ \/ ä¸­ \/ é«˜â€å¼¹æ€§è®¾ç½®**ã€‚å°†ç½‘æ ¼çš„åº•å±‚ API éšè—åœ¨æ›´é«˜çº§åˆ«æ¥å£åé¢çš„ç³»ç»Ÿä¸­ï¼Œä¸ºé…ç½®é»˜è®¤æ–­è·¯å’Œå¼‚å¸¸å€¼æ£€æµ‹è®¾ç½®çš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æä¾›ç®€åŒ–çš„â€œä½ \/ ä¸­ \/ é«˜â€æ—‹é’®å¾ˆæœ‰ä»·å€¼ï¼Œå› ä¸ºå¾ˆå¤šé¢†åŸŸå®¹æ˜“é…ç½®é”™è¯¯ï¼Œå¯¼è‡´è¯¥åº”ç”¨ç¨‹åºæ€§èƒ½ä¸ä½³ã€‚\n\n## è¿è¡Œæ—¶å®‰å…¨é…ç½®\n\nä»¥ä¸‹å®‰å…¨å»ºè®®æ¥è‡ªæˆ‘ä»¬ä¸ºå¾®æœåŠ¡åº”ç”¨ç¨‹åºå»ºç«‹ç¾å›½å®‰å…¨æ ‡å‡†çš„å·¥ä½œï¼Œè¯¥æ ‡å‡†ç”±ç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶é™¢ï¼ˆNISTï¼‰åœ¨ [SP 800-204 ç³»åˆ—](https:\/\/tetrate.io\/blog\/nist-standards-for-zero-trust-the-sp-800-204-series\/) ä¸­å‘å¸ƒã€‚[ä½ å¯ä»¥åœ¨æˆ‘ä»¬çš„ç»¼åˆæŒ‡å—](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/) ä¸­é˜…è¯» NIST é’ˆå¯¹å¾®æœåŠ¡åº”ç”¨ç¨‹åºçš„æ‰€æœ‰å®‰å…¨å»ºè®®ã€‚\n\n**æœ€å°æ§åˆ¶**ã€‚è¿è¡Œæ—¶çš„é›¶ä¿¡ä»»è‡³å°‘éœ€è¦ä»¥ä¸‹äº”ä¸ªæ§åˆ¶ï¼š\n\n1. **åŠ å¯†ä¼ è¾“ä¸­çš„æ‰€æœ‰å†…å®¹**ï¼šæä¾›æ¶ˆæ¯çœŸå®æ€§å’Œçªƒå¬ä¿æŠ¤ï¼ˆ[SP 800-204ï¼ŒÂ§MS-SS-4](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n2. **éªŒè¯æœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡**ï¼šæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½åº”éªŒè¯ä¸ä¹‹é€šä¿¡çš„åº”ç”¨ç¨‹åºçš„èº«ä»½ï¼ˆ[SP 800-204Aï¼ŒÂ§SM-DR16ï¼›SP 800-204Bï¼ŒÂ§APE-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n3. **æˆæƒæœåŠ¡åˆ°æœåŠ¡è®¿é—®**ï¼šæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½åº”ä½¿ç”¨å…¶è¿è¡Œæ—¶èº«ä»½æˆæƒä¸ä¹‹é€šä¿¡çš„åº”ç”¨ç¨‹åºï¼ˆ[SP 800-204Bï¼ŒÂ§SAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n4. **éªŒè¯æœ€ç»ˆç”¨æˆ·èº«ä»½**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åœ¨æœåŠ¡è°ƒç”¨å›¾ä¸­çš„æ¯ä¸ªè·ƒç‚¹è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆ[SP 800-204Bï¼ŒÂ§EAUN-SR-1ï¼ŒÂ§EUAZ-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n5. **æˆæƒæœ€ç»ˆç”¨æˆ·è®¿é—®èµ„æº**ï¼šå¯¹æ¯ç§èµ„æºçš„æ¯æ¬¡è®¿é—®éƒ½åº”è·å¾—æˆæƒï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨å‰é—¨è®¿é—®ä¸€æ¬¡ï¼ˆ[SP 800-204Bï¼ŒÂ§EAUZ-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n\nIstio æä¾›ä¼ è¾“ä¸­çš„åŠ å¯†ï¼ˆæˆ‘ä»¬åœ¨ä¸Šé¢è®¨è®ºäº†å…¨å±€å¯ç”¨ï¼‰ï¼Œä»¥åŠå¯éªŒè¯çš„æœåŠ¡èº«ä»½ ([SPIFFE](https:\/\/tetrate.io\/blog\/why-would-you-need-spire-for-authentication-with-istio\/) ) å’ŒæœåŠ¡åˆ°æœåŠ¡çš„è®¿é—®æ§åˆ¶ (Istio \u0060AuthorizationPolicy\u0060)ã€‚æ­¤å¤–ï¼Œå®ƒå¯ä»¥é…ç½®ä¸ºä»£è¡¨åº”ç”¨ç¨‹åºï¼ˆJWTã€OIDC ä»¤ç‰Œï¼‰éªŒè¯æŸäº›å½¢å¼çš„æœ€ç»ˆç”¨æˆ·èº«ä»½ï¼Œæœ€å Istio æ”¯æŒå¯æ’æ‹”æˆæƒç³»ç»Ÿï¼ˆEnvoy çš„ \u0060ext_authz\u0060ï¼‰ä»¥å¼ºåˆ¶æœ€ç»ˆç”¨æˆ·è®¿é—®èµ„æºã€‚\n\n**å®‰è£…é™åˆ¶æ€§é»˜è®¤æˆæƒç­–ç•¥**ã€‚æ ¹æ® [Istio æœ€ä½³å®è·µ](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/#use-default-deny-patterns)ï¼Œä½ åº”è¯¥å®‰è£…ä¸€ä¸ªä¸å…è®¸æµé‡çš„é»˜è®¤æˆæƒç­–ç•¥ï¼Œä¸ºæ¯ä¸ªæœåŠ¡å‘å¸ƒå¯¹è±¡åˆ›å»º \u0060AuthorizationPolicy\u0060 å¯¹è±¡ä»¥ç®¡ç†å…è®¸å®ƒä»¬ä¸ä¹‹é€šä¿¡çš„å¯¹è±¡ï¼ˆ[SP 800-204Bï¼ŒSAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚æœ‰åŠ©äºå®ç°è¿™ä¸€ç›®æ ‡çš„ä¸¤ä¸ªæˆæƒç­–ç•¥ï¼š\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: deny-all-audit\n  namespace: istio-system\nspec:\n  action: AUDIT\n\u0060\u0060\u0060\n\nç¤ºä¾‹ 2ï¼š\u0060IstioAuthorizationPolicy\u0060ä¼šæ‹’ç»æ‰€æœ‰æµé‡ï¼Œå¹¶å®¡è®¡è®°å½•å®ƒã€‚ä½ å¯èƒ½ä¼šè¿è¡Œè¿™æ ·çš„ç­–ç•¥å‡ å‘¨ï¼Œä»¥äº†è§£åœ¨å¯ç”¨å¼ºåˆ¶æ‰§è¡Œä¹‹å‰ä½ éœ€è¦çš„ç­–ç•¥ã€‚\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: deny-all\n  namespace: istio-system\nspec:\n  {} # or action: ALLOW\n\u0060\u0060\u0060\n\nç¤ºä¾‹ 3ï¼šæ‹’ç»æ‰€æœ‰æµé‡çš„ Istio AuthorizationPolicyã€‚æˆ–è€…ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå…è®¸ä½†å…·æœ‰ç©ºè§„åˆ™é›†çš„ç­–ç•¥ï¼Œè¿™ä¸ç©ºä¸»ä½“ç›¸åŒã€‚\n\n**é»˜è®¤æƒ…å†µä¸‹éœ€è¦ mTLS è¿›è¡ŒæœåŠ¡åˆ°æœåŠ¡é€šä¿¡**ã€‚é€šè¿‡åœ¨ç”±å®‰å…¨æˆ–å¹³å°å›¢é˜Ÿç®¡ç†çš„æ ¹å‘½åç©ºé—´ä¸­é…ç½® \u0060PeerAuthentication\u0060 èµ„æºï¼Œåº”å°†ä¼ è¾“ä¸­çš„åŠ å¯†è®¾ç½®ä¸ºä¸¥æ ¼ï¼ˆå³ [éœ€è¦ mTLS æ‰èƒ½ä¸æœåŠ¡é€šä¿¡](https:\/\/tetrate.io\/blog\/how-istios-mtls-traffic-encryption-works-as-part-of-a-zero-trust-security-posture\/)ï¼‰ã€‚ç½‘æ ¼å¤–éƒ¨çš„æœåŠ¡è°ƒç”¨ç½‘æ ¼ä¸­çš„åº”ç”¨ç¨‹åºåº”è¯¥é€šè¿‡åº”ç”¨ç¨‹åºå…¥å£ç½‘å…³è¿›è¡Œé€šä¿¡ï¼Œå®ƒå¯ä»¥å‘å¤–éƒ¨æœåŠ¡æä¾›ç®€å•çš„ TLSï¼ˆç”šè‡³æ˜æ–‡ï¼‰ï¼Œå› ä¸ºå®ƒä¸å¤ªå¯èƒ½æœ‰è¯ä¹¦æ¥å¯¹ç½‘æ ¼æ‰§è¡Œ mTLSã€‚ç½‘æ ¼å†…éƒ¨çš„æœåŠ¡å‘¼å‡ºåº”é…ç½®ä¸ºä½¿ç”¨ç®€å•çš„ TLS æˆ–æ˜æ–‡ï¼Œå¹¶å¸¦æœ‰ç”¨äºå¤–éƒ¨æœåŠ¡çš„ DestinationRule çš„æ˜æ–‡ ([NIST SP 800-204A, Â§SM-DR8](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/) )ã€‚\n\n**TLS é…ç½®é»˜è®¤å€¼**ã€‚Istio å¼€ç®±å³ç”¨ï¼Œå…·æœ‰è‰¯å¥½çš„ TLS è®¾ç½®ï¼ˆ[TLS æœ€ä½ç‰ˆæœ¬ 1.2ï¼Œå…·æœ‰ä¸€ç»„æœ‰é™çš„å¯†ç å¥—ä»¶](https:\/\/istio.io\/latest\/docs\/concepts\/security\/#mutual-tls-authentication)ï¼‰ï¼Œä½†ä½ å¯èƒ½éœ€è¦æ ¹æ®ä½ çš„ç¯å¢ƒå¯¹å…¶è¿›è¡Œè°ƒæ•´ï¼ˆä¾‹å¦‚ï¼Œåœ¨ [FedRAMP](https:\/\/www.fedramp.gov\/) ç¯å¢ƒä¸­éµå®ˆ [FIPS 140-3](https:\/\/csrc.nist.gov\/publications\/detail\/fips\/140\/3\/final) ï¼‰ï¼š\n\n- Envoy æ”¯æŒé€šè¿‡é…ç½® [ç½‘å…³](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/gateway\/#ServerTLSSettings-cipher_suites) ä¸ºæ¯ä¸ªæœåŠ¡é…ç½®æœ€ä½ TLS ç‰ˆæœ¬å’Œä¸€ç»„å—æ”¯æŒçš„å¯†ç å¥—ä»¶ã€‚\n- å¦‚æœå¯èƒ½ï¼Œæˆ‘ä»¬å»ºè®®å°† **TLS 1.3 ä½œä¸ºæœ€ä½ç‰ˆæœ¬** æ‰§è¡Œï¼ˆå¦‚æœä½ åªæ‰§è¡Œ mTLS Envoy-to-Envoyï¼‰ï¼Œå¹¶ä¸ºéœ€è¦è¾ƒæ—§æˆ–å®‰å…¨æ€§è¾ƒä½çš„ TLS é…ç½®çš„å¤–éƒ¨æµé‡ä½¿ç”¨ç½‘å…³ã€‚\n\n**ä¸ºæ¯ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„è¿è¡Œæ—¶èº«ä»½ï¼Œä»¥ä¿ƒè¿›è¡¨è¾¾æ€§å¼ºã€ç»†ç²’åº¦çš„æˆæƒç­–ç•¥å¹¶é™åˆ¶æš´éœ²äºæ”»å‡»**ã€‚ä¸ºä½ æ­£åœ¨éƒ¨ç½²çš„æ¯ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„è¿è¡Œæ—¶æ ‡è¯†ã€‚åœ¨ Kubernetes ä¸­ï¼Œä¸è¦åœ¨æ¯ä¸ªå‘½åç©ºé—´ä¸­ä½¿ç”¨é»˜è®¤çš„ Kubernetes æœåŠ¡å¸æˆ·ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªå‘½åç©ºé—´ä¸­çš„æ¯ä¸ªæœåŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æœåŠ¡å¸æˆ·ã€‚æˆæƒç­–ç•¥åªèƒ½åœ¨èº«ä»½çš„ç²’åº¦ä¸Šè½»æ¾ç®¡ç†ã€‚å½“å¤šä¸ªè¿è¡Œæ—¶ç»„ä»¶å…±äº«ç›¸åŒçš„èº«ä»½æ—¶ï¼Œå¾ˆéš¾ç®¡ç†ä¸€ä¸ªè®¿é—®æ§åˆ¶ç­–ç•¥æ¥è¡¨è¾¾ä½ çš„é¢„æœŸè®¿é—®æƒé™ï¼ŒåŒæ—¶ä¸å…è®¸ä½¿ç”¨å…±äº«èº«ä»½çš„æŸäº›ç»„ä»¶è¿›è¡Œè¿‡äºå¹¿æ³›çš„è®¿é—®ã€‚è¿™å¯¼è‡´æ›´å¤§çš„è¡¨é¢ç§¯æš´éœ²ç»™å¯èƒ½å±åŠç³»ç»Ÿçš„ä¸€ä¸ªç»„ä»¶çš„æ”»å‡»è€…ï¼ˆ[NIST SP 800-204A Â§SM-DR11ï¼ŒÂ§SM-DR18](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n\n**å°†æœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡é™åˆ¶åœ¨æœ¬åœ°å‘½åç©ºé—´**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡é—´é€šä¿¡åº”é™åˆ¶åœ¨æœ¬åœ°åç§°ç©ºé—´å†…ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸èƒ½å†™ä¸ºæ ¹é…ç½®å‘½åç©ºé—´ä¸­çš„å•ä¸ª AuthorizationPolicyã€‚ç›¸åï¼Œå¯ä»¥å°†ä»…å…è®¸åœ¨æœ¬åœ°å‘½åç©ºé—´ä¸­è®¿é—®çš„é»˜è®¤ AuthorizationPolicy æ¨¡æ¿åŒ–ä¸ºé»˜è®¤å€¼ï¼Œå¹¶ä¸”åº”å…è®¸åº”ç”¨ç¨‹åºå›¢é˜Ÿç¼–å†™ä»–ä»¬è‡ªå·±çš„æ›´ä¸“ä¸šï¼ˆå—é™ï¼‰çš„ç­–ç•¥ï¼ˆ[NIST SP800-204Bï¼ŒÂ§SAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ï¼‰ã€‚\n\n## ä¸‹ä¸€æ­¥\n\næˆ‘ä»¬å¸Œæœ›ä»æˆ‘ä»¬å¤šå¹´å¸®åŠ©å®¢æˆ·æ„å»ºæˆåŠŸçš„æœåŠ¡ç½‘æ ¼å®è·µçš„ç»éªŒä¸­è·å¾—çš„è¿™äº›æœ€ä½³å®è·µå°†æœ‰åŠ©äºä¿ƒè¿›ä½ çš„éƒ¨ç½²ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ï¼Œè¯·æŸ¥çœ‹æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—ä¸­çš„å…¶ä»–å¸–å­ï¼š \n\n- [ç¬¬ 1 éƒ¨åˆ†ï¼šå¦‚ä½•å°†æœåŠ¡ç½‘æ ¼ä½œä¸ºå®‰å…¨æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œä»¥åˆ†å±‚å½¢å¼å°†å¾®æœåŠ¡å®‰å…¨ä¸ä¼ ç»Ÿå®‰å…¨ç»“åˆèµ·æ¥](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/)\n- [ç¬¬ 2 éƒ¨åˆ†ï¼šæœåŠ¡ç½‘æ ¼å®‰å…¨æ€§å’Œé«˜å¯ç”¨æ€§éƒ¨ç½²æœ€ä½³å®è·µ](\/trans\/service-mesh-deployment-best-practices-for-security-and-high-availability\/)\n\nå¦‚éœ€å…¨é¢äº†è§£ NIST å¾®æœåŠ¡å®‰å…¨æ ‡å‡†ï¼Œè¯· [ä¸‹è½½æˆ‘ä»¬çš„å…è´¹æŒ‡å—](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)ã€‚\n\n### æ¥ä¸‹æ¥ï¼šå¤šç§Ÿæˆ·çš„æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µ\n\nåœ¨æˆ‘ä»¬å…³äºæœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºæˆ‘ä»¬çœ‹åˆ°å®¢æˆ·æ­£åœ¨åŠªåŠ›è§£å†³çš„å¸¸è§ç§Ÿèµå†³ç­–ç‚¹ï¼Œå¹¶é‡ç‚¹å…³æ³¨ç½‘æ ¼å¦‚ä½•å¸®åŠ©ä¿ƒè¿›è¿™äº›å†³ç­–ã€‚æˆ‘ä»¬å°†æ¶µç›–çš„ä¸»é¢˜åŒ…æ‹¬ Kubernetes é›†ç¾¤æ‰€æœ‰æƒã€å‘½åç©ºé—´æ‰€æœ‰æƒã€é…ç½®æ‰€æœ‰æƒï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨æœåŠ¡ç½‘æ ¼åº”ç”¨ç¨‹åºç½‘å…³æ¥ç¼“è§£ä¸­æ–­ã€‚\n', '\/trans\/optimize-traffic-management-and-security-with-these-service-mesh-best-practices\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡æ¨èäº†æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§ä¼˜åŒ–çš„ä¸€äº›æœ€ä½³å®è·µã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/service-mesh-deployment-best-practices-for-security-and-high-availability/">[è¯‘] æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§å’Œé«˜å¯ç”¨æ€§éƒ¨ç½²æœ€ä½³å®è·µ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/30</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/service-mesh-deployment-best-practices-for-security-and-high-availability/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('æœåŠ¡ç½‘æ ¼å®‰å…¨æ€§å’Œé«˜å¯ç”¨æ€§éƒ¨ç½²æœ€ä½³å®è·µ', 'æœ¬æ–‡å¼ºè°ƒçš„æ˜¯æ§åˆ¶å¹³é¢åº”è¯¥å¦‚ä½•éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºé™„è¿‘ï¼Œå…¥å£åº”è¯¥å¦‚ä½•éƒ¨ç½²ä»¥ä¿ƒè¿›å®‰å…¨æ€§å’Œæ•æ·æ€§ï¼Œå¦‚ä½•ä½¿ç”¨ Envoy ä¿ƒè¿›è·¨é›†ç¾¤è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠç½‘æ ¼å†…éƒ¨å¦‚ä½•ä½¿ç”¨è¯ä¹¦ã€‚', '\nè¿™æ˜¯ [æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—æ–‡ç« ](https:\/\/tetrate.io\/blog\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) ä¸­çš„ç¬¬äºŒç¯‡ï¼Œæ‘˜è‡ª Tetrate åˆ›å§‹å·¥ç¨‹å¸ˆ Zack Butcher å³å°†å‡ºç‰ˆçš„ä¹¦ç± Istio in Productionã€‚\n\nå½“æ¶‰åŠåˆ°åœ¨å¤šé›†ç¾¤çš„åŸºç¡€è®¾æ–½ä¸­éƒ¨ç½²æœåŠ¡ç½‘æ ¼æ—¶ï¼Œæœ‰ä¸€äº›å¯ç§»åŠ¨çš„éƒ¨åˆ†ã€‚è¿™é‡Œä¸»è¦æƒ³å¼ºè°ƒçš„æ˜¯æ§åˆ¶å¹³é¢åº”è¯¥å¦‚ä½•éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºé™„è¿‘ï¼Œå…¥å£åº”è¯¥å¦‚ä½•éƒ¨ç½²ä»¥ä¿ƒè¿›å®‰å…¨æ€§å’Œæ•æ·æ€§ï¼Œå¦‚ä½•ä½¿ç”¨ Envoy ä¿ƒè¿›è·¨é›†ç¾¤è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠç½‘æ ¼å†…éƒ¨å¦‚ä½•ä½¿ç”¨è¯ä¹¦ã€‚\n\n## ä½¿æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢ä¸æ•…éšœåŸŸä¿æŒä¸€è‡´\n\n**å»ºè®®ï¼šå›´ç»•æ•…éšœåŸŸéƒ¨ç½²æ¾æ•£è€¦åˆçš„æ§åˆ¶å¹³é¢ä»¥å®ç°é«˜å¯ç”¨æ€§ã€‚**\n\næ„å»ºé«˜å¯ç”¨æ€§ç³»ç»Ÿå¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œè€Œä¸”é€šå¸¸æˆæœ¬å¾ˆé«˜ã€‚æˆ‘ä»¬çŸ¥é“çš„ä¸€ç§ç»è¿‡éªŒè¯çš„æŠ€æœ¯æ˜¯å›´ç»•æ•…éšœåŸŸæ„å»ºã€‚æ•…éšœåŸŸæ˜¯å½“å…³é”®ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶å—å½±å“çš„åŸºç¡€æ¶æ„éƒ¨åˆ†ã€‚æˆ‘ä»¬æ„å»ºå¯é ç³»ç»Ÿçš„åŸºæœ¬æ–¹æ³•æ˜¯å°†ç³»ç»Ÿè·¨è¶Šçš„æ•…éšœåŸŸåˆ†ç»„ä¸ºå¤šä¸ªç‹¬ç«‹çš„å­¤å²›ã€‚æœ€ç»ˆç³»ç»Ÿçš„æ•´ä½“å¯é æ€§å–å†³äºæˆ‘ä»¬å¯ä»¥ä½¿å­¤å²›çš„ç‹¬ç«‹ç¨‹åº¦ã€‚å®é™…ä¸Šï¼Œæ€»æ˜¯å­˜åœ¨ä¸€äº›ç›¸äº’ä¾èµ–æ€§ï¼Œå°†å…¶æœ€å°åŒ–æ€»æ˜¯æˆæœ¬ä¸å¯ç”¨æ€§çš„æƒè¡¡ã€‚\n\nåœ¨æ²¡æœ‰è€¦åˆæ•…éšœåŸŸçš„æƒ…å†µä¸‹åˆ›å»ºéš”ç¦»å­¤å²›çš„æœ€ç®€å•æ–¹æ³•æ˜¯åœ¨æ¯ä¸ªå­¤å²›ä¸­è¿è¡Œå…³é”®æœåŠ¡çš„ç‹¬ç«‹å‰¯æœ¬ã€‚æˆ‘ä»¬å¯ä»¥è¯´è¿™äº›å‰¯æœ¬æ˜¯ç­’ä»“çš„æœ¬åœ°å‰¯æœ¬ â€”â€” å®ƒä»¬å…±äº«ç›¸åŒçš„æ•…éšœåŸŸã€‚åœ¨äº‘åŸç”Ÿæ¶æ„ä¸­ï¼ŒKubernetes é›†ç¾¤å½¢æˆäº†æœ€è‡ªç„¶çš„ç­’ä»“è¾¹ç•Œã€‚Istio æ˜¯ä¸€é¡¹å…³é”®æœåŠ¡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºé›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ª Istio æ§åˆ¶å¹³é¢å®ä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬éƒ¨ç½² Istio ä½¿å…¶æ•…éšœåŸŸä¸ä½ çš„åº”ç”¨ç¨‹åºçš„æ•…éšœåŸŸä¿æŒä¸€è‡´ã€‚\n\næ­¤å¤–ï¼Œæˆ‘ä»¬ç¡®ä¿ Istio æ§åˆ¶å¹³é¢å®ä¾‹æ˜¯æ¾æ•£è€¦åˆçš„ï¼Œä¸éœ€è¦ç›´æ¥ä¸å…¶ä»–é›†ç¾¤é€šä¿¡ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°å‡å°‘å…¶ä¸å­¤å²›å¤–éƒ¨çš„é€šä¿¡ã€‚æœ‰å…³å¦‚ä½•å®ç°æ­¤ç›®çš„çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ä¸‹é¢çš„å¤šé›†ç¾¤éƒ¨åˆ†ã€‚\n\n## ä½¿ç”¨åº”ç”¨ç¨‹åºå…¥å£ç½‘å…³éš”ç¦»æ¯ä¸ªåº”ç”¨ç¨‹åºçš„æµé‡\n\n**å»ºè®®ï¼šä»æ¯ä¸ªåº”ç”¨ç¨‹åºæˆ–åº”ç”¨ç¨‹åºå›¢é˜Ÿçš„ç½‘å…³ï¼ˆåº”ç”¨ç¨‹åºå…¥å£ç½‘å…³ï¼‰å¼€å§‹ï¼Œä»¥å¸®åŠ©ç¼“è§£å…±äº«ä¸­æ–­ã€‚éšç€æ—¶é—´çš„æ¨ç§»ä½ æ“ä½œç»éªŒçš„å¢åŠ ï¼Œå°†åº”ç”¨ç¨‹åºå…¥å£åˆå¹¶åˆ°å…±äº«ç½‘å…³ä»¥ä¼˜åŒ–æˆæœ¬ã€‚**\n\nè™½ç„¶ Istio é»˜è®¤é™„å¸¦å…±äº« \u0060istio-ingressgateway\u0060ï¼Œä½†æˆ‘ä»¬ä¸å»ºè®®ä½¿ç”¨å…±äº«ç½‘å…³ã€‚å¤§å¤šæ•°é‡‡ç”¨ç½‘æ ¼çš„å›¢é˜Ÿéƒ½éœ€è¦æ—¶é—´æ¥æ„å»ºå®æ–½å…±äº«ç½‘å…³æ¨¡å‹æ‰€éœ€çš„å®¡æŸ¥å®è·µå’Œæ“ä½œï¼Œè€Œæ²¡æœ‰å…±äº«ä¸­æ–­çš„é£é™©ã€‚ç‰¹åˆ«æ˜¯åœ¨ Istio å®æ–½çš„æ—©æœŸï¼Œæˆ‘ä»¬å»ºè®®æ¯ä¸ªå›¢é˜Ÿéƒ¨ç½²ä¸€ä¸ª Envoy ç½‘å…³ã€‚æˆ‘ä»¬ç§°è¿™äº›ä¸ºåº”ç”¨ç¨‹åºå…¥å£ç½‘å…³ã€‚éšç€ä½ è·å¾—æ“ä½œç»éªŒï¼Œä½ å¯ä»¥å¼€å§‹å°†åº”ç”¨ç¨‹åºåˆå¹¶åˆ°å…±äº«ç½‘å…³ä¸Šä»¥ä¼˜åŒ–æˆæœ¬ã€‚\n\nä½¿ç”¨å…±äº«ç½‘å…³æ¨¡å‹å®ç°æ¯ä¸ªå›¢é˜Ÿéš”ç¦»çš„æ·å¾„æ˜¯ä¸ºæ¯ä¸ªå›¢é˜Ÿåˆ†é…ä¸€ä¸ªå•ç‹¬çš„ä¸»æœºåã€‚æŒ‰ä¸»æœºåéš”ç¦»çš„å›¢é˜Ÿå¯ä»¥æ›´å®‰å…¨åœ°é…ç½®å…±äº«ç½‘å…³å®ä¾‹ã€‚ç„¶è€Œï¼Œå…¶ä»–å…±åŒå‘½è¿çš„ä¸­æ–­é£é™©ä»ç„¶å­˜åœ¨ï¼Œä¾‹å¦‚å…¥å£ä»£ç†éƒ¨ç½²çš„é”™è¯¯é…ç½®ã€å˜ˆæ‚çš„é‚»å±…æ¶ˆè€—èµ„æºå’Œå¢åŠ æ‰€æœ‰åº”ç”¨ç¨‹åºçš„å»¶è¿Ÿç­‰ã€‚æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œæ¯ä¸ªå›¢é˜Ÿä¸€ä¸ªç½‘å…³çš„æ–¹æ³•ä¼šäº§ç”Ÿæœ€å¿«çš„å½±å“ï¼Œå¹¶ä¸”å¤±è´¥çš„æœºä¼šæœ€å°‘ï¼Œå¹¶ä¸”æ€»ä½“æˆæœ¬ç›¸å¯¹è¾ƒä½ã€‚\n\næˆ‘ä»¬æœŸæœ›æˆç†Ÿéƒ¨ç½²çš„æœ€ç»ˆçŠ¶æ€æ˜¯ 80-20 çš„æ¯”ä¾‹ï¼šå¤§å¤šæ•°åº”ç”¨ç¨‹åºå°†é€šè¿‡å…±äº«ç½‘å…³æ¥æ”¶æµé‡ï¼Œè€Œä¸€å°éƒ¨åˆ†é«˜åº¦å…³é”®æˆ–æ•æ„Ÿçš„åº”ç”¨ç¨‹åºå°†ä¿ç•™ä¸“ç”¨ç½‘å…³ã€‚\n\n## ä½¿ç”¨åº”ç”¨ç¨‹åºè¾¹ç¼˜ç½‘å…³åœ¨å¤šä¸ªé›†ç¾¤ä¹‹é—´åˆ†é…å…¥å£æµé‡\n\n**å»ºè®®ï¼šä½¿ç”¨åº”ç”¨ç¨‹åºè¾¹ç¼˜ç½‘å…³ä¸ºå®¢æˆ·ç«¯æä¾›å•ä¸€åœ°å€ï¼Œä»¥ä¾›å®¢æˆ·ç«¯ä½¿ç”¨å¹¶å°†æµé‡åˆ†é…åˆ°è·¨å¤šä¸ªé›†ç¾¤çš„åº”ç”¨ç¨‹åºå…¥å£ç½‘å…³ã€‚**\n\n![å›¾ 1ï¼šåŸºäº Envoy çš„åº”ç”¨ç¨‹åºè¾¹ç¼˜ç½‘å…³ã€‚](f1.png)\n\næˆ‘ä»¬ç»å¸¸çœ‹åˆ°å®¢æˆ·éœ€è¦è·¨å¤šä¸ªé›†ç¾¤åˆ†é…å…¥å£æµé‡ã€‚ä¾‹å¦‚ï¼Œä»–ä»¬å¯èƒ½å¸Œæœ›å¯ç”¨è“ \/ ç»¿åŸºç¡€è®¾æ–½å‡çº§ï¼Œä»¥ä¿ƒè¿›è·¨åŒºåŸŸæ•…éšœè½¬ç§»ï¼Œæˆ–è€…é€šè¿‡ä½¿ç”¨ Envoy çš„ L7 åŠŸèƒ½å°†æµé‡ä»å•ä½“è¿ç§»åˆ°å¾®æœåŠ¡æ¥å®ç°æ‰¼æ€æ¨¡å¼ã€‚æˆ‘ä»¬ç§°è¿™äº›ä¸ºåº”ç”¨ç¨‹åºè¾¹ç¼˜ç½‘å…³ã€‚\n\nä¸ºäº†å®ç°è¿™ä¸ªç”¨ä¾‹ï¼Œæˆ‘ä»¬å°†éƒ¨ç½² Envoyâ€”â€” åœ¨ä¸“ç”¨çš„ Kubernetes é›†ç¾¤ä¸­æˆ–ä½œä¸ºä¸€ç»„è™šæ‹Ÿæœº â€”â€” æ¥æ¥æ”¶å¤–éƒ¨æµé‡ã€‚è¿™äº› Envoy å®ä¾‹å°†é€šè¿‡å…¶ Kubernetes å…¥å£æˆ– VM VIP å°†æµé‡è½¬å‘åˆ°ä½ çš„åº”ç”¨ç¨‹åºã€‚è¿™ä¸ ingress-per-team æ–¹æ³•ååŒå·¥ä½œï¼šå¤šé›†ç¾¤ç½‘å…³ä¸ºå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªå•ä¸€åœ°å€ä»¥ä¾›ä½¿ç”¨ï¼Œæ ¹æ®ä½ çš„åŸºç¡€è®¾æ–½éœ€è¦æä¾›å°½å¯èƒ½å¤šçš„åº”ç”¨ç¨‹åºç½‘å…³å’Œé›†ç¾¤ã€‚\n\nè™½ç„¶æ­¤ç½‘å…³ç¡®å®å­˜åœ¨å…±äº«æ•…éšœåŸŸï¼Œä½†å…¶é…ç½®è¿œæ¯”æ¯ä¸ªåº”ç”¨ç¨‹åºä¸€ä¸ªå…¥å£ç½‘å…³çš„é…ç½®ç®€å•ã€‚å› æ­¤ï¼Œä½œä¸ºå…±äº«åŸºç¡€æ¶æ„è¿è¡Œèµ·æ¥æ›´å®¹æ˜“ï¼Œä¹Ÿæ›´å®‰å…¨ã€‚æ¯ä¸ªé›†ç¾¤éƒ½æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºå…¥å£ç½‘å…³çš„å…±äº«åº”ç”¨ç¨‹åºè¾¹ç¼˜ç½‘å…³æ˜¯ä¸€ç§å¼ºå¤§è€Œçµæ´»çš„æ¨¡å‹ï¼Œç”¨äºåœ¨ç½‘æ ¼ä¸Šéƒ¨ç½²å’Œæ“ä½œåº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥æ›´è½»æ¾åœ°æ“ä½œåº•å±‚åŸºç¡€è®¾æ–½ã€‚\n\n## è¯ä¹¦å’Œå…¬é’¥åŸºç¡€è®¾æ–½ (PKI) çš„å»ºè®®\n\n**å»ºè®®ï¼šä»ä½ ç°æœ‰çš„ä¼ä¸šæ ¹ç›®å½•ä¸ºç½‘æ ¼ mTLS åˆ›å»ºä¸€ä¸ªä¸­é—´ç­¾åè¯ä¹¦ã€‚**\n\nIstio ä½¿ç”¨å¸¸è§„ X.509 è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯å¹¶åœ¨ç½‘æ ¼ä¸­å¯ç”¨ä¼ è¾“åŠ å¯†ã€‚æˆ‘ä»¬å»ºè®®ä¸ºç°æœ‰ä¼ä¸šæ ¹ç›®å½•ä¸­çš„æ‰€æœ‰ç½‘æ ¼ mTLS åˆ›å»ºä¸€ä¸ªç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦ã€‚å¦‚æœæ¯ä¸ªç¯å¢ƒéƒ½æœ‰ä¸€ä¸ªæ ¹ï¼Œè¯·ä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»ºä¸€ä¸ªç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦ã€‚ä½¿ç”¨è¯¥ç½‘æ ¼ä¸­é—´é¢å‘è¯ä¹¦ä¸ºæ¯ä¸ª Istio å®‰è£…åˆ›å»ºä¸€ä¸ªç­¾åè¯ä¹¦ã€‚æˆ‘ä»¬å»ºè®®åˆ›å»ºä¸€ä¸ªç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦ï¼Œä»¥ä¾¿åœ¨ä»»ä½•ç‰¹å®šç¯å¢ƒä¸­ç½‘æ ¼çš„æ•´ä¸ª PKI æ˜¯ä¸€æ£µæ ‘ï¼Œå¦‚æœéœ€è¦å¯ä»¥ä¸€èµ·å¤±æ•ˆã€‚æˆæœ¬æ˜¯ä¸€äº›é¢å¤–çš„è¯ä¹¦ç®¡ç†ï¼Œä¸æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦ç›¸æ¯”ï¼Œåœ¨ç®¡ç†ç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦çš„ç”Ÿå‘½å‘¨æœŸæ—¶éœ€è¦æ›´åŠ å°å¿ƒã€‚\n\n![å›¾ 2. Tetrate æ¨èçš„å°†ç½‘æ ¼ä¸ç°æœ‰ PKI é›†æˆçš„æ–¹æ³•ï¼šåœ¨ç¯å¢ƒï¼ˆå¦‚ prodï¼‰ä¸­ä¸º Istio ç”Ÿæˆä¸­é—´ç­¾åè¯ä¹¦ï¼Œä½¿ç”¨å®ƒå‘è¯¥ç¯å¢ƒä¸­çš„æ¯ä¸ª Istio æ§åˆ¶å¹³é¢å®ä¾‹é¢å‘ç­¾åè¯ä¹¦ï¼Œå¹¶è®© Istio åƒå¾€å¸¸ä¸€æ ·å‘æ¯ä¸ªé›†ç¾¤ä¸­çš„æ‰€æœ‰ pod é¢å‘å·¥ä½œè´Ÿè½½ï¼ˆå¶ï¼‰è¯ä¹¦ã€‚](f2.png)\n\nIstio ç›‘è§†æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åœ¨æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹æ—¶é‡æ–°åŠ è½½å…¶ç­¾åè¯ä¹¦ã€‚å› æ­¤ï¼Œåªè¦ä½ æœ‰ä¸€ä¸ªæ‰¹å‡†çš„æœºåˆ¶æ¥å°†ç§˜å¯†åŠ è½½åˆ° *istiod* pod çš„æ–‡ä»¶ç³»ç»Ÿä¸­ â€”â€” æ¯”å¦‚ *cert-manager*ã€Vault çš„ *init-agent* æˆ– sidecarï¼Œæˆ–è€…åªæ˜¯å­˜å‚¨åœ¨åŠ å¯† *etcd* ä¸­çš„æ™®é€šæ—§ Kubernetes Secretâ€”â€” é›†æˆ Istio è¿›å…¥ä½ çš„ PKI åº”è¯¥å¾ˆå®¹æ˜“ã€‚æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦çš„è½®æ¢åº”ç”±ä½ çš„ PKI è‡ªåŠ¨æ‰§è¡Œã€‚\n\nIstio ä½¿ç”¨ä¼—æ‰€å‘¨çŸ¥çš„å¯†ç å­¦åº“ï¼šIstio çš„å†…éƒ¨ CA ä½¿ç”¨ Golang çš„å¯†ç å­¦å¥—ä»¶ï¼ŒEnvoyï¼ˆsidecar å’Œ ingressï¼‰ä½¿ç”¨ BoringSSL è¿›è¡Œè¯ä¹¦éªŒè¯å’Œä¼ è¾“ä¸­çš„åŠ å¯†ã€‚é€šè¿‡ Tetrate çš„å¼€æº Istio å‘è¡Œç‰ˆ [Tetrate Istio Distro](https:\/\/tetr8.io\/tid) ï¼Œç»è¿‡ FIPS éªŒè¯çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢æ„å»ºä¹Ÿä½œä¸º [Tetrate Istio è®¢é˜…](https:\/\/tetr8.io\/tis) çš„ä¸€éƒ¨åˆ†æä¾›ï¼Œå› æ­¤ä½ å¯èƒ½æœŸæœ›çš„æ‰€æœ‰ X.509 çº¦æŸï¼ˆåŸºæœ¬çº¦æŸï¼Œå¦‚ CA å’Œæ·±åº¦ï¼Œå¼€ç®±å³ç”¨åœ°æ”¯æŒå’Œå¼ºåˆ¶æ‰§è¡Œå‘½åçº¦æŸã€ç­–ç•¥çº¦æŸç­‰ï¼‰ã€‚\n\n### ä½¿ç”¨æçŸ­å¯¿å‘½çš„å·¥ä½œè´Ÿè½½è¯ä¹¦ä»¥è½»æ¾åŠé”€\n\n**å»ºè®®ï¼šä½¿ç”¨ Istio æ¥è‡ªåŠ¨åŒ–è¯ä¹¦ç®¡ç†ï¼Œä»¥ä¾¿è®¾ç½®æçŸ­çš„å·¥ä½œè´Ÿè½½è¯ä¹¦ TTL å˜å¾—åˆ‡å®å¯è¡Œï¼Œä»è€Œä½¿ [è¯ä¹¦æ’¤é”€åˆ—è¡¨ï¼ˆCRLï¼‰](https:\/\/csrc.nist.gov\/glossary\/term\/certificate_revocation_list) ä¿æŒç®€çŸ­ä¸”æ˜“äºç®¡ç†ã€‚**\n\nåœ¨è¯ä¹¦é¢å‘å’Œè½®æ¢ï¼ˆIstio ä¸ºä½ è‡ªåŠ¨æ‰§è¡Œï¼‰ä¹‹åï¼ŒPKI ä¸­æœ€å¤§çš„æŒ‘æˆ˜æ˜¯è¯ä¹¦åŠé”€ã€‚è¯ä¹¦åŠé”€æ˜¯é€šè¿‡è¯ä¹¦åŠé”€åˆ—è¡¨å®ç°çš„ï¼Œé€šå¸¸ CRL å…·æœ‰ 24 å°æ—¶çš„å¼ºåˆ¶æ‰§è¡Œ SLAï¼šæ·»åŠ åˆ°åˆ—è¡¨ä¸­çš„è¯ä¹¦åœ¨åŠé”€åæœ€å¤š 24 å°æ—¶å†…å¯èƒ½ä¼šè¢«åŸºç¡€è®¾æ–½è§†ä¸ºæœ‰æ•ˆã€‚æ­¤å¤–ï¼Œç”±äºåŠé”€çš„è¯ä¹¦å¿…é¡»åœ¨å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ (TTL) å†…ä¿ç•™åœ¨åˆ—è¡¨ä¸­ï¼Œå› æ­¤åŠé”€åˆ—è¡¨ä¼šå˜å¾—åºå¤§è€Œç¬¨æ‹™ã€‚\n\nIstio æä¾›çš„ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯è‡ªåŠ¨åŒ–è¯ä¹¦ç®¡ç†ï¼Œä»¥ä¾¿è®¾ç½®æçŸ­çš„å·¥ä½œè´Ÿè½½è¯ä¹¦ TTL æ˜¯åˆ‡å®å¯è¡Œçš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio é™„å¸¦ 24 å°æ—¶çš„å·¥ä½œè´Ÿè½½è¯ä¹¦ TTLã€‚è¿™è¶³å¤ŸçŸ­ï¼Œå¤§å¤šæ•°å®‰å…¨ç»„ç»‡å¯ä»¥é€‰æ‹©è®©å—æŸçš„è¯ä¹¦è¿‡æœŸï¼Œè€Œä¸æ˜¯æ˜ç¡®åœ°æ’¤é”€å®ƒä»¬ã€‚è€Œä¸”ï¼Œå½“ä½ å‘ CRL æ·»åŠ è¯ä¹¦æ—¶ï¼Œå®ƒåªéœ€è¦åœ¨é‚£é‡Œåœç•™å¾ˆçŸ­çš„æ—¶é—´ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦åœ¨ CRL ä¸Šä¿ç•™è¿‡æœŸçš„è¯ä¹¦ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç½‘æ ¼æœ‰åŠ©äºè§£å†³å¤§å¤šæ•°ç»„ç»‡é¢ä¸´çš„æœ€ç—›è‹¦çš„ PKI é—®é¢˜ï¼šå®ƒé¢å‘å’ŒåŠé”€çŸ­æœŸè¯ä¹¦ï¼Œè¿™æ„å‘³ç€åŠé”€åˆ—è¡¨å¯ä»¥åœ¨éœ€è¦æ—¶ä¿æŒç®€çŸ­ä¸”æ˜“äºç®¡ç†ã€‚\n\n**æ³¨æ„**ï¼šç”±äºç½‘æ ¼ä½¿ç”¨ mTLS è¯ä¹¦ä½œä¸ºèº«ä»½ï¼ŒIstio å°† Envoy é…ç½®ä¸ºè‡ªåŠ¨ä¸¢å¼ƒå·²å»ºç«‹çš„è¿æ¥ï¼Œä»¥å¼ºåˆ¶å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ä»»ä½•ä¸€æ–¹è½®æ¢è¯ä¹¦æ—¶é‡æ–°éªŒè¯å½¼æ­¤ã€‚è¿™æ˜¯ Istio å®ç°ä¸­çš„è®¾è®¡å†³ç­–ï¼Œé€šå¸¸é€šè¿‡ Istio çš„å¼¹æ€§åŠŸèƒ½å¯¹åº”ç”¨ç¨‹åºéšè—ï¼šå¯¹åº”ç”¨ç¨‹åºé€æ˜çš„è‡ªåŠ¨é‡è¯•é‡æ–°å»ºç«‹è¿æ¥ã€‚åœ¨ç½‘æ ¼ä¸­è®¾ç½®è¾ƒçŸ­çš„è¯ä¹¦ TTL ä¼šå¼ºåˆ¶è¿™äº›é‡æ–°è¿æ¥æ›´é¢‘ç¹åœ°å‘ç”Ÿã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§è¡Œä¸ºå¶å°”ä¼šä¸­æ–­ä¸€äº›æœŸæœ›é•¿æœŸ TCP è¿æ¥çš„åº”ç”¨ç¨‹åºã€‚\n\n### è¿›ä¸€æ­¥çš„è¯ä¹¦æ¨è\n\nä½ åº”è¯¥ä¸ä½ çš„å®‰å…¨å›¢é˜Ÿåè°ƒï¼Œä¸ºä½ çš„ç½‘æ ¼é¢å‘çš„è¯ä¹¦å»ºç«‹é€‚å½“çš„çº¦æŸã€‚æˆ‘ä»¬æ¨èçš„ä¸€äº›å¸¸è§çº¦æŸå¦‚ä¸‹ã€‚\n\n**è¯ä¹¦ç”Ÿå‘½å‘¨æœŸ (TTL)**ã€‚è¯·æ³¨æ„ï¼Œåªè¦è¯ä¹¦æ˜¯ä»åŒä¸€ä¸ªæ ¹é¢å‘çš„ï¼ŒIstio å°±æ”¯æŒæ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦å’Œå·¥ä½œè´Ÿè½½è¯ä¹¦çš„é›¶åœæœºè½®æ¢ã€‚æˆ‘ä»¬å»ºè®®æ¯ä¸ªçº§åˆ«çš„è¯ä¹¦ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š\n\n- ç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦ 1-3 å¹´\n- æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦ 3 ä¸ªæœˆ\n- å·¥ä½œè´Ÿè½½è¯ä¹¦éœ€è¦ 12-24 å°æ—¶\n\nIstio è‡ªåŠ¨å¤„ç†å·¥ä½œè´Ÿè½½è¯ä¹¦çš„è½®æ¢ã€‚è¿™äº›è¯ä¹¦ä¸Šçš„çŸ­ TTLï¼ˆå°‘äº 24 å°æ—¶ï¼‰æœ‰åŠ©äºé™åˆ¶å¯èƒ½è¢«ç›—çš„å‡­æ®è¿›è¡Œæ—¶é—´é™åˆ¶æ”»å‡»ï¼Œè¿˜å¯ä»¥å‡å°‘å¯¹ CRL çš„éœ€æ±‚ã€‚æ§åˆ¶å¹³é¢è¯ä¹¦åº”æŒ‰ä¸€ä¸ªæœˆçš„åç§»è½®æ¢ä»¥ç¡®ä¿å¹³ç¨³è¿‡æ¸¡ â€”â€” æ¢å¥è¯è¯´ï¼Œåœ¨ 3 ä¸ªæœˆçš„ TTL åˆ°æœŸå‰ 1 ä¸ªæœˆè½®æ¢æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦ã€‚ç±»ä¼¼åœ°ï¼Œå½“ç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦è¿˜å‰©ä¸€åŠåˆ°ä¸‰åˆ†ä¹‹ä¸€çš„ç”Ÿå‘½å‘¨æœŸæ—¶è½®æ¢ï¼ˆä¸€å¹´ TTL æå‰ 3-4 ä¸ªæœˆï¼Œä¸‰å¹´ TTL æå‰ 6-8 ä¸ªæœˆï¼‰ã€‚\n\n**åŸºç¡€ï¼ˆCA å’Œæ·±åº¦ï¼‰**ã€‚æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦åº”è¯¥åªèƒ½é¢å‘å¶è¯ä¹¦ï¼šç”¨äºå·¥ä½œè´Ÿè½½è¯†åˆ«çš„éç­¾åè¯ä¹¦ã€‚å› æ­¤ï¼Œåº”é…ç½®æ·±åº¦é™åˆ¶ä»¥é˜²æ­¢æ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦é¢å‘ä»»ä½•å…¶ä»–ç­¾åè¯ä¹¦ã€‚\n\nç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦éœ€è¦åˆ›å»ºæ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦ï¼Œå› æ­¤å®ƒåº”è¯¥é…ç½®ä¸€ä¸ªæ·±åº¦ï¼Œä»¥ä¾¿èƒ½å¤Ÿ**åœ¨å®ƒä¸‹é¢åˆ›å»ºä¸€ä¸ªçº§åˆ«çš„ç­¾åè¯ä¹¦ï¼Œè€Œä¸æ˜¯æ›´å¤š**ã€‚\n\n**åç§°çº¦æŸ**ã€‚Istio é¢å‘çš„å·¥ä½œè´Ÿè½½è¯ä¹¦ä¸ä¼šå¡«å…… X.509 ä¸»ä½“åç§° (SN) å­—æ®µï¼›ç½‘æ ¼èº«ä»½éªŒè¯ä¾èµ–äºä½œä¸ºä¸»ä½“å¤‡ç”¨åç§° (SAN) å­—æ®µæºå¸¦çš„ SPIFFE èº«ä»½ã€‚é˜…è¯» [SPIFFE è§„èŒƒä»¥è·å–æœ‰å…³éªŒè¯å’Œèº«ä»½éªŒè¯å·¥ä½œçš„ä¿¡æ¯](https:\/\/github.com\/spiffe\/spiffe\/blob\/main\/standards\/X509-SVID.md#4-constraints-and-usage)ï¼Œä»¥åŠ Istio çš„ [æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/concepts\/security\/#istio-identity) ä»¥äº†è§£ Istio å¦‚ä½•æ ¹æ® SPIFFE å¯¹èº«ä»½è¿›è¡Œç¼–ç ã€‚åœ¨ä¸ºç½‘æ ¼ä¸­é—´å’Œæ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦ç¼–å†™åç§°çº¦æŸæ—¶ï¼Œè¯·è®°ä½è¿™ä¸€ç‚¹ã€‚\n\n**å¯†é’¥ç”¨æ³•**ã€‚ \u0060keyCertSign\u0060 å¿…é¡»ä¸ºç½‘æ ¼ä¸­é—´ç­¾åè¯ä¹¦å’Œæ§åˆ¶å¹³é¢ç­¾åè¯ä¹¦è®¾ç½®ï¼Œä½†åº”ä¸ºå·¥ä½œè´Ÿè½½è¯ä¹¦ç¦ç”¨ã€‚æ¢å¥è¯è¯´ï¼Œç½‘æ ¼ä¸­é—´å’Œæ§åˆ¶å¹³é¢è¯ä¹¦æ˜¯ç­¾åè¯ä¹¦ï¼Œè€Œå·¥ä½œè´Ÿè½½è¯ä¹¦ä¸æ˜¯ã€‚\n\næ ¹æ® SPIFFE çš„å»ºè®®ï¼Œä¸åº”å°†ç­¾åè¯ä¹¦ç”¨äºä¼ è¾“ä¸­çš„åŠ å¯†ï¼Œå¹¶ä¸”åº”é…ç½®å¯†é’¥ä½¿ç”¨ä»¥é˜²æ­¢å®ƒï¼ˆé€šè¿‡åŠ å¯†çº¦æŸï¼‰ã€‚\n\n**æ‰©å±•å¯†é’¥ç”¨æ³•**ã€‚è™½ç„¶æ­¤å¤„æ²¡æœ‰å…·ä½“è¦æ±‚ï¼Œä½† SPIFFE X.509 SVID è§„èŒƒè¯´æ˜ \u0060id-kp-serverAuth\u0060 å’Œ \u0060id-kp-clientAuth\u0060 åº”é’ˆå¯¹å¶ï¼ˆå·¥ä½œè´Ÿè½½ï¼‰è¯ä¹¦è¿›è¡Œé…ç½®ã€‚\n\nSPIFFE è§„èŒƒè¿˜æ¨èäº† [å„ç§è¯ä¹¦çº¦æŸ](https:\/\/github.com\/spiffe\/spiffe\/blob\/main\/standards\/X509-SVID.md#4-constraints-and-usage)ï¼Œå°½ç®¡å…¶ä¸­å¤§éƒ¨åˆ†ä¸Šé¢å·²ç»çº¦æŸäº†ã€‚\n\n## ä¸‹ä¸€æ­¥\n\næˆ‘ä»¬å¸Œæœ›ä»å¤šå¹´å¸®åŠ©æˆ‘ä»¬çš„å®¢æˆ·å……åˆ†åˆ©ç”¨æœåŠ¡ç½‘æ ¼çš„ç»éªŒä¸­æ”¶é›†çš„è¿™äº›æœ€ä½³å®è·µå°†æœ‰åŠ©äºä¿ƒè¿›ä½ çš„éƒ¨ç½²ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ï¼Œè¯·æŸ¥çœ‹ [å¦‚ä½•å°†æœåŠ¡ç½‘æ ¼ä½œä¸ºå®‰å…¨æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œä»¥åˆ†å±‚å½¢å¼å°†å¾®æœåŠ¡å®‰å…¨ä¸ä¼ ç»Ÿå®‰å…¨ç»“åˆèµ·æ¥](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) è¿™ç¯‡æ–‡ç« ã€‚\n\næ¥ä¸‹æ¥ï¼šæœåŠ¡ç½‘æ ¼è¿è¡Œæ—¶é…ç½®å»ºè®®ã€‚åœ¨æˆ‘ä»¬çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è°ˆè®ºï¼š\n\n- å‘½åçº¦å®š\n- å…¨å±€è®¾ç½®\n- æµé‡ç®¡ç†\n- å®‰å…¨\n- é¥æµ‹\n\næ•¬è¯·å…³æ³¨ã€‚\n', '\/trans\/service-mesh-deployment-best-practices-for-security-and-high-availability\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡å¼ºè°ƒçš„æ˜¯æ§åˆ¶å¹³é¢åº”è¯¥å¦‚ä½•éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºé™„è¿‘ï¼Œå…¥å£åº”è¯¥å¦‚ä½•éƒ¨ç½²ä»¥ä¿ƒè¿›å®‰å…¨æ€§å’Œæ•æ·æ€§ï¼Œå¦‚ä½•ä½¿ç”¨ Envoy ä¿ƒè¿›è·¨é›†ç¾¤è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠç½‘æ ¼å†…éƒ¨å¦‚ä½•ä½¿ç”¨è¯ä¹¦ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/secure-ingress-gateway-of-istio/">ä½¿ç”¨ cert-manager ACME Issuer ä¸º Istio ä¸­çš„å…¥å£ç½‘å…³è®¾ç½®è¯ä¹¦</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/09</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä½¿ç”¨ cert-manager ACME Issuer ä¸º Istio ä¸­çš„å…¥å£ç½‘å…³è®¾ç½®è¯ä¹¦', 'æœ¬æ–‡å°±å°†ä½¿ç”¨ Let\u0027s Encryptã€cert-manager æ¥ç®¡ç† Istio ä¸­å…¥å£ç½‘å…³çš„è¯ä¹¦ã€‚', '\næœ¬æ–‡å°†ä»¥ Bookinfo åº”ç”¨ä¸ºä¾‹ï¼Œä¸º Istio çš„å…¥å£ç½‘å…³è®¾ç½®ä¸€ä¸ªçœŸå®çš„ TLS\/SSL è¯ä¹¦ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Let\u0027s Encryptã€cert-manager æ¥ç®¡ç† Istio ä¸­å…¥å£ç½‘å…³çš„è¯ä¹¦ã€‚\n\n## å‡†å¤‡ {#prerequisite}\n\nè¯·å…ˆå‚è€ƒ [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/zh\/docs\/setup\/)å®‰è£… Istio å’Œ [Bookinfo åº”ç”¨](https:\/\/istio.io\/latest\/zh\/docs\/examples\/bookinfo\/)ï¼Œç¬”è€…åœ¨ GKE ä¸­å®‰è£…äº† Istio 1.16ã€‚\n\næœ¬æ–‡ä¸­å®‰è£…çš„å„ç»„ä»¶ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\n\n- Kubernetes 1.24.7\n- Istio 1.16\n- Gateway API 0.5.1\n- cert-manager 1.10.1\n\n## æ¶æ„ {#arch}\n\næœ¬å®éªŒä¸­åŒ…å«ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š\n\n- ä½¿ç”¨ Cloudflare æä¾› DNS è§£æ\n- ä½¿ç”¨ Let\u0027s Encrypt åˆ›å»ºè¯ä¹¦\n- ä½¿ç”¨ cert-manager è‡ªåŠ¨ç”³è¯·å’Œç»­æœŸè¯ä¹¦\n- ä½¿ç”¨ Gateway API æ¥åˆ›å»ºå…¥å£ç½‘å…³\n- æ‰€æœ‰ç»„ä»¶éƒ¨ç½²åœ¨ GKE ä¸­\n\nå›¾ 1 å±•ç¤ºäº†æœ¬å®éªŒçš„æ¶æ„ä»¥åŠæµé‡è·¯ç”±è¿‡ç¨‹ã€‚\n\n![å›¾ 1ï¼šIstio å…¥å£ç½‘å…³è¯ä¹¦æŒ‚è½½æ¨¡å¼](arch.svg)\n\næµé‡è·¯ç”±è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n1. åœ¨ Gateway åˆ›å»ºå®Œæˆåé€šè¿‡ LoadBalancer æš´éœ²ç½‘å…³ IPï¼Œå°†è¯¥ IP é…ç½®åœ¨ DNS è§£æè®°å½•ä¸­ï¼›\n2. Gateway é€šè¿‡æ³¨è§£å¼•ç”¨ [ACME Issuer](https:\/\/cert-manager.io\/docs\/configuration\/acme\/)ï¼›\n3. ACME Issuer å‘ cert-manager å‘é€è¯·æ±‚è¯ä¹¦ï¼ˆ[order å’Œ challenge](https:\/\/cert-manager.io\/docs\/concepts\/acme-orders-challenges\/)ï¼‰ï¼Œå¹¶ä½¿ç”¨ [DNS01 Challenge Provider](https:\/\/cert-manager.io\/docs\/configuration\/acme\/dns01\/)ï¼›\n4. cert-manager å‘ ACME æœåŠ¡å™¨ Let\u0027s Encrypt è¯·æ±‚è¯ä¹¦å¹¶åˆ›å»º Kubernetes Secretï¼›\n5. åœ¨ Gateway ä¸­é€šè¿‡åº”ç”¨ Secret æŒ‚è½½ TLS è¯ä¹¦ï¼›\n6. HTTPRoute å°†å…¥å£æµé‡è·¯ç”±åˆ° productpage æœåŠ¡ï¼›\n\n## ACME Issuer\n\nIstio åŒ…å«äº†å¼€ç®±å³ç”¨çš„ mTLS æ”¯æŒï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨[è‡ªå®šä¹‰ CA](https:\/\/istio.io\/latest\/zh\/docs\/tasks\/security\/cert-management\/plugin-ca-cert\/) æˆ– [SPIRE](\/blog\/cert-manager-spire-istio\/) æ¥ç®¡ç†é›†ç¾¤å†…è¯ä¹¦ï¼Œä½†æ˜¯å¯¹äºå…¥å£ç½‘å…³çš„è¯ä¹¦ï¼Œå°±éœ€è¦æˆ‘ä»¬å•ç‹¬è®¾ç½®ã€‚ä½ å¯ä»¥[æ‰‹åŠ¨ä¸ºå…¥å£ç½‘å…³é…ç½®è¯ä¹¦](https:\/\/istio.tetratelabs.io\/zh\/istio-in-practice\/setting-up-ssl-certs\/)ï¼Œä¸è¿‡ç®¡ç†èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºä½ éœ€è¦è´Ÿè´£è¯ä¹¦çš„è½®æ¢ä»¥é˜²æ­¢è¯ä¹¦è¿‡æœŸï¼Œæˆ–ä½¿ç”¨ [Let\u0027s Encrypt](https:\/\/letsencrypt.org\/) è¿™æ ·çš„ ACME Issuer æ¥è‡ªåŠ¨åŒ–ç®¡ç†è¯ä¹¦ã€‚\n\nACME (Automated Certificate Management Environment) Issuer æ˜¯ä¸€ç§è®¤è¯æœºæ„ï¼Œå¯ä»¥ä½¿ç”¨ ACME åè®®ä¸ºå®¢æˆ·ç«¯ç”³è¯·å’Œç®¡ç†è¯ä¹¦ã€‚ACME æ˜¯ä¸€ç§ç”¨äºè‡ªåŠ¨åŒ– SSL\/TLS è¯ä¹¦é¢å‘å’Œç®¡ç†çš„å¼€æ”¾åè®®ã€‚å®ƒé€šå¸¸ç”¨äºç½‘ç«™æˆ–å…¶ä»–åœ¨çº¿æœåŠ¡çš„è¯ä¹¦ç®¡ç†ï¼Œä»¥ç¡®ä¿å®‰å…¨è¿æ¥ã€‚\n\nLet\u0027s Encrypt æ˜¯ä¸€ä¸ªéè¥åˆ©æ€§çš„ ACME Issuerï¼Œå¯ä»¥ä¸ºç½‘ç«™æä¾›å…è´¹çš„ SSL\/TLS è¯ä¹¦ã€‚å®ƒçš„ç›®æ ‡æ˜¯ä½¿åŠ å¯†æŠ€æœ¯æ™®åŠåŒ–ï¼Œå¹¶å¸®åŠ©æå‡ç½‘ç»œå®‰å…¨æ°´å¹³ã€‚Let\u0027s Encrypt ä½¿ç”¨ ACME åè®®ä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œå¯ä»¥ä¸ºå®¢æˆ·ç«¯ç”³è¯·å’Œç®¡ç†è¯ä¹¦ã€‚ACME åè®®æ˜¯å¼€æ”¾çš„ï¼Œå› æ­¤ä»»ä½•æœºæ„éƒ½å¯ä»¥æˆä¸º ACME Issuerï¼Œåªè¦å®ƒä»¬éµå®ˆ ACME åè®®çš„è§„å®šã€‚\n\n## è¯¦ç»†æ­¥éª¤ {#details-steps}\n\n1. å®‰è£… Gateway APIï¼š\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f https:\/\/github.com\/kubernetes-sigs\/gateway-api\/releases\/download\/v0.5.1\/standard-install.yaml\n   \u0060\u0060\u0060\n\n2. å®‰è£… cert-manager\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f https:\/\/gist.githubusercontent.com\/rootsongjc\/78487acdea70a3c27c1a1b794546d031\/raw\/0df08b91dfaff6412bbd891ccedffaa882a9a99f\/cert-manager.yaml\n   \u0060\u0060\u0060\n\n   å®ƒä¸º cert-manager Deployment å¢åŠ äº†ä»¥ä¸‹å¯åŠ¨é¡¹ï¼š\n\n   \u0060\u0060\u0060bash\n   args:\n     - --feature-gates=ExperimentalGatewayAPISupport=true\n   \u0060\u0060\u0060\n\n3. åœ¨ Cloudflare ä¸­åˆ›å»ºä¸€ä¸ªåä¸º \u0060lets-encrypt-token\u0060 çš„ API tokenï¼Œè‡ªå®šä¹‰æ¨¡æ¿è®¾ç½®å¦‚ä¸‹ï¼š\n\n   Permissionsï¼š\n\n   - \u0060Zone - DNS - Edit\u0060\n   - \u0060Zone - Zone - Read\u0060\n\n   Zone Resources:\n\n   - \u0060Include - All Zones\u0060\n\n   å°†è¯¥ token å­˜å‚¨åœ¨ä¸€ä¸ª Secret ä¸­ï¼š\n\n   \u0060\u0060\u0060yaml\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: v1\n   kind: Secret\n   metadata:\n     name: cloudflare-api-token-secret\n     namespace: istio-system\n   type: Opaque\n   stringData:\n     api-token: \u003cAPI Token\u003e\n   EOF\n   \u0060\u0060\u0060\n\n   {{\u003ccallout warning æ³¨æ„\u003e}}\n\n   æœ¬æ¬¡å®éªŒä¸­è¯¥ Token å®é™…ä¸Šå¹¶æ²¡èµ·åˆ°ä½œç”¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹ cert-manager ä¼šé€šè¿‡ Cloudflare API ä¸ Cloudflare äº¤äº’ï¼Œä¸ºæˆ‘ä»¬é…ç½® DNS è®°å½•ã€‚è¯¥é—®é¢˜è¿˜éœ€è¦è¿›ä¸€æ­¥æ’æŸ¥ã€‚\n\n   {{\u003c\/callout\u003e}}\n\n4. é…ç½® Let\u0027s Encrypt  Issuerï¼š\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: cert-manager.io\/v1\n   kind: Issuer\n   metadata:\n     name: letsencrypt\n   spec:\n     acme:\n       email: rootsongjc@gmail.com\n       server: https:\/\/acme-v02.api.letsencrypt.org\/directory\n       privateKeySecretRef:\n         name: lets-encrypt-issuer-account-key\n       solvers:\n       - dns01:\n           cloudflare:\n             apiTokenSecretRef:\n               name: cloudflare-api-token-secret\n               key: api-token\n         selector:\n           dnsNames:\n           - \u0027bookinfo.jimmysong.io\u0027\n   EOF\n   \u0060\u0060\u0060\n\n5. é…ç½® Gatewayï¼š\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1beta1\n   kind: Gateway\n   metadata:\n     name: bookinfo-gateway\n     annotations:\n       cert-manager.io\/issuer: letsencrypt\n   spec:\n     gatewayClassName: istio\n     listeners:\n     - name: http\n       hostname: bookinfo.jimmysong.io\n       port: 443\n       protocol: HTTPS\n       allowedRoutes:\n         namespaces:\n           from: Same\n       tls:\n         mode: Terminate\n         certificateRefs:\n           kind: Secret\n           group: \u0022\u0022\n           name: bookinfo-tls\n   EOF\n   \u0060\u0060\u0060\n\n   åœ¨ Gateway åˆ›å»ºå®Œæˆåï¼Œä¼šåœ¨ default å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªç½‘å…³ Pod ä»¥åŠ LoadBalancer èµ„æºçš„æœåŠ¡ã€‚\n\n   æŸ¥çœ‹ \u0060default\u0060 å‘½åç©ºé—´ä¸­çš„ Secretï¼Œä½ ä¼šå‘ç° \u0060bookinfo-tls\u0060ï¼Œå®ƒæ˜¯ç”± cert-manager åˆ›å»ºçš„ï¼ŒæŸ¥çœ‹è¯¥ Secret ä¸­ä¿å­˜çš„è¯ä¹¦ï¼Œä½ å°†ä¼šçœ‹åˆ°ç”± Let\u0027s Encrypt é¢å‘çš„è¯ä¹¦ä¿¡ä»»é“¾ï¼š\n\n   - \u0060bookinfo.jimmysong.io\u0060 \n   - \u0060ISRG Root X1\u0060\n   - \u0060DST Root CA X3\u0060\n\n6. é…ç½® HTTPRouteï¼š\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1beta1\n   kind: HTTPRoute\n   metadata:\n     name: bookinfo\n   spec:\n     parentRefs:\n     - name: bookinfo-gateway\n     rules:\n     - matches:\n       - path:\n           type: Exact\n           value: \/productpage\n       - path:\n           type: PathPrefix\n           value: \/static\n       - path:\n           type: Exact\n           value: \/login\n       - path:\n           type: Exact\n           value: \/logout\n       - path:\n           type: PathPrefix\n           value: \/api\/v1\/products\n       backendRefs:\n       - name: productpage\n         port: 9080\n   EOF\n   \u0060\u0060\u0060\n\n7. åœ¨ Cloudflare ä¸­é…ç½®åŸŸåè®°å½•ï¼šå°†ç½‘å…³æœåŠ¡çš„å¤–ç½‘ IP åŠåŸŸå \u0060bookinfo.jimmysong.io\u0060 æ·»åŠ åˆ° Cloudflare çš„ DNS è®°å½•ä¸­å°±å¯ä»¥å®ç°åŸŸåè§£æã€‚\n\n   {{\u003ccallout warning æ³¨æ„\u003e}}\n\n   æœ¬å®éªŒä¸­å‘ç°ç½‘å…³ Pod å¹¶æ²¡æœ‰æŒ‚è½½ \u0060bookinfo-tls\u0060  Secret ä¸­çš„è¯ä¹¦ï¼Œæˆ‘ä»¬åªå¥½é€šè¿‡ Cloudflare æ¥é…ç½® TLS è¯ä¹¦ï¼šä¸ºç½‘ç«™å¼€å¯å…¨ï¼ˆä¸¥æ ¼ï¼‰SSL\/TLSï¼Œè¿™å°†ä½¿ç”¨ Cloudflare é¢å‘çš„ TLS è¯ä¹¦ã€‚\n\n   {{\u003c\/callout\u003e}}\n\n8. åœ¨æµè§ˆå™¨ä¸­è®¿é—® \u003chttps:\/\/bookinfo.jimmysong.io\/productpage\u003e å°±å¯ä»¥è®¿é—® bookinfo åº”ç”¨äº†ã€‚\n\n## æ€»ç»“ {#summary}\n\næœ¬æ¬¡å®éªŒè™½ç„¶å®ç°äº†ç½‘å…³çš„ TLS åŠ å¯†ï¼Œä¹Ÿä¸ºç½‘å…³ç”Ÿæˆäº† TLS è¯ä¹¦ï¼Œä½†å®é™…ä¸Šç½‘å…³ä½¿ç”¨çš„æ˜¯ Cloudflare é¢å‘çš„è¯ä¹¦ã€‚è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æœ€åˆçš„ç›®æ ‡ï¼Œå³ä½¿ç”¨ ACME Serverï¼ˆLet\u0027s Encryptï¼‰ä¸ºç½‘å…³é¢å‘çš„è¯ä¹¦ã€‚ä¸ºä»€ä¹ˆç½‘å…³ Pod æ²¡æœ‰æŒ‚è½½æˆ‘ä»¬åº”ç”¨çš„ Secret ä¸­çš„è¯ä¹¦ï¼ŒCloudflare DNS01 Challenge Provider ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Œè¿™ä¸¤ä¸ªé—®é¢˜è¿˜éœ€è¦æˆ‘ä»¬è¿›ä¸€æ­¥è°ƒæŸ¥ã€‚\n\n## å‚è€ƒ {#reference}\n\n- [Acquire SSL Certificates In Kubernetes From Letâ€™s Encrypt With Cert-Manager - thinktecture.com](https:\/\/www.thinktecture.com\/en\/kubernetes\/ssl-certificates-with-cert-manager-in-kubernetes\/)\n- [How To Secure Kubernetes NGINX Ingress With Cert-Manager](https:\/\/getbetterdevops.io\/k8s-ingress-with-letsencrypt\/)\n- [Securing gateway.networking.k8s.io Gateway Resources - cert-manager.io](https:\/\/cert-manager.io\/docs\/usage\/gateway\/)\n', '\/blog\/secure-ingress-gateway-of-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡å°±å°†ä½¿ç”¨ Let&#39;s Encryptã€cert-manager æ¥ç®¡ç† Istio ä¸­å…¥å£ç½‘å…³çš„è¯ä¹¦ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely/">[è¯‘] å¦‚ä½•é€šè¿‡æœåŠ¡ç½‘æ ¼å¢å¼ºå¾®æœåŠ¡çš„å®‰å…¨æ€§</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/05</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('å¦‚ä½•é€šè¿‡æœåŠ¡ç½‘æ ¼å¢å¼ºå¾®æœåŠ¡çš„å®‰å…¨æ€§', 'æˆ‘ä»¬è®¤ä¸ºï¼ŒæœåŠ¡ç½‘æ ¼æœ€é€‚åˆä½œä¸ºç°æœ‰å®‰å…¨æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡åœ¨ä¼ ç»Ÿå®‰å…¨æ§åˆ¶ä¹‹ä¸Šæ·»åŠ æ›´ç»†ç²’åº¦çš„å®‰å…¨ç­–ç•¥æ¥å®ç°ã€‚', '\næœ¬æ–‡æ˜¯ Tetrate å³å°†å‡ºç‰ˆçš„ã€ŠIstio in Productionã€‹ä¸€ä¹¦ä¸­æ‘˜å½•çš„æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œä½œè€…æ˜¯ Tetrate åˆ›å§‹å·¥ç¨‹å¸ˆ Zack Butcherã€‚\n\næˆ‘ä»¬æ¥åˆ°è®¸å¤šå®æ–½ç½‘æ ¼çš„ä¼ä¸šçš„é—®é¢˜ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯â€œæˆ‘è¿˜éœ€è¦å“ªäº›æ§åˆ¶ï¼Œè€Œç½‘æ ¼æä¾›å“ªäº›æ§åˆ¶ï¼Ÿâ€æ¢å¥è¯è¯´ï¼Œä»–ä»¬æƒ³çŸ¥é“ç½‘æ ¼å¦‚ä½•é€‚åº”ç°æœ‰çš„å®‰å…¨æ¨¡å‹ã€‚æˆ‘ä»¬å‘ç°ï¼Œç½‘æ ¼æœ€é€‚åˆä½œä¸ºä¸€ç»„å®‰å…¨æ§åˆ¶çš„å†…åœˆï¼Œè¿™äº›æ§åˆ¶ä»ç‰©ç†ç½‘ç»œåˆ°åº”ç”¨æœ¬èº«çš„æ¯ä¸€å±‚éƒ½è¢«å®æ–½ã€‚\n\n## æœåŠ¡ç½‘æ ¼ä½œä¸ºé€šç”¨ç­–ç•¥æ‰§è¡Œç‚¹\n\næˆ‘ä»¬çœ‹åˆ°ç½‘æ ¼çš„ Sidecar ä½œä¸ºé€šç”¨ç­–ç•¥æ‰§è¡Œç‚¹ï¼ˆ[NIST SP 800-204Bï¼šä½¿ç”¨æœåŠ¡ç½‘æ ¼çš„åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204b\/final)ï¼‰ã€‚ç”±äºå®ƒæ‹¦æˆªäº†æ‰€æœ‰è¿›å‡ºåº”ç”¨ç¨‹åºçš„æµé‡ï¼ŒSidecar ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„ä½ç½®æ¥å®ç°å„ç§ç­–ç•¥ã€‚æˆ‘ä»¬å¯ä»¥å®ç°ä¼ ç»Ÿçš„å®‰å…¨ç­–ç•¥ï¼Œå¦‚åŸºäºåº”ç”¨ç¨‹åºæ ‡è¯†è€Œéç½‘ç»œä½ç½®çš„æ›´é«˜ä¿è¯çš„åº”ç”¨ç¨‹åºä¹‹é—´çš„æˆæƒã€‚ä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥å®æ–½ä¹‹å‰ä¸åˆ‡å®é™…æˆ–éœ€è¦ä¸åº”ç”¨ç¨‹åºæ·±åº¦å‚ä¸çš„ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œç½‘æ ¼å…è®¸ä½ ç¼–å†™ä»¥ä¸‹ç­–ç•¥ï¼šâ€œåç«¯å¯ä»¥ä»æ•°æ®åº“è¯»å–ï¼ˆä½¿ç”¨åº”ç”¨çº§èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒï¼‰ï¼Œä½†å‰ææ˜¯è¯·æ±‚å…·æœ‰æœ‰æ•ˆçš„æœ€ç»ˆç”¨æˆ·å‡­è¯å¹¶å…·æœ‰è¯»å–èŒƒå›´ï¼ˆä½¿ç”¨æœ€ç»ˆç”¨æˆ·èº«ä»½è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒï¼‰ã€‚â€\n\nè™½ç„¶æœåŠ¡ç½‘æ ¼æä¾›äº†ä¸€ä¸ªå¼ºå¤§ï¼ŒåŠ¨æ€å’Œä¸€è‡´çš„å®‰å…¨åŸºçº¿ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸Šæ„å»ºåº”ç”¨ç¨‹åºå®‰å…¨æ¨¡å‹ï¼Œä½†ç½‘æ ¼æœ¬èº«æ°¸è¿œæ— æ³•æä¾›åº”ç”¨ç¨‹åºæ‰€éœ€çš„ 100% è¿è¡Œæ—¶å®‰å…¨ã€‚ä¾‹å¦‚ï¼Œç”±äº Sidecar ä½äºç”¨æˆ·ç©ºé—´ä¸­ï¼Œç½‘æ ¼åœ¨å‡è½»è®¸å¤šç±»å‹çš„ç½‘ç»œæ‹’ç»æœåŠ¡æ”»å‡»æ–¹é¢ä¸å¦‚ä¼ ç»Ÿé˜²ç«å¢™æœºåˆ¶ã€‚å¦ä¸€æ–¹é¢ï¼Œç”±äºåŒæ ·çš„åŸå› ï¼Œç½‘æ ¼åœ¨å‡è½»è®¸å¤šåº”ç”¨çº§æ‹’ç»æœåŠ¡æ”»å‡»æ–¹é¢æ¯”ä¼ ç»ŸåŸºç¡€è®¾æ–½æ›´æœ‰æ•ˆã€‚\n\n## ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„ä¸­é—´å±‚\n\nç½‘æ ¼ä½œä¸ºåŸºç¡€æ¶æ„çš„å¼ºå¤§ä¸­é—´å±‚ï¼šä½äºç‰©ç†ç½‘ç»œå’Œæ‰€å®æ–½çš„ L3\/L4 æ§åˆ¶ä¹‹ä¸Šï¼Œä½†ä½äºåº”ç”¨ç¨‹åºä¹‹ä¸‹ã€‚è¿™å…è®¸æ›´è„†å¼±å’Œæ›´éš¾ä»¥æ”¹å˜çš„æ¾æ•£é…ç½® â€”â€” å…è®¸æ›´é«˜å±‚çš„æ›´å¤§æ•æ·æ€§ â€”â€” å› ä¸ºæ§åˆ¶ä½“ç³»åœ¨æ›´é«˜å±‚è¢«è€ƒè™‘ã€‚\n\n![å›¾ 1ï¼šå¢åŠ ç»†ç²’åº¦ç­–ç•¥å±‚ä»¥å¢å¼ºä¼ ç»Ÿå®‰å…¨ã€‚](f1.png)\n\nç½‘æ ¼æä¾›çš„ä¸»è¦å®‰å…¨åŠŸèƒ½æ˜¯ï¼š\n\n- ä½œä¸º X.509 è¯ä¹¦çš„**è¿è¡Œæ—¶èº«ä»½**ï¼Œç”¨äºåœ¨ä¼ è¾“æœŸé—´åŠ å¯†ï¼Œä»¥åŠæœåŠ¡ä¹‹é—´é€šä¿¡çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚\n- **ç­–ç•¥æ‰§è¡Œç‚¹**ï¼Œç”¨äºåœ¨ç½‘æ ¼ä¸­çš„æ‰€æœ‰åº”ç”¨ç¨‹åºä¸Šå®æ–½ä¸€è‡´çš„æœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯å’Œæˆæƒã€‚\n- æœåŠ¡èº«ä»½å’Œæœ€ç»ˆç”¨æˆ·èº«ä»½çš„**è¿è¡Œæ—¶ç­–ç•¥æ‰§è¡Œ**ï¼ˆä¾‹å¦‚ï¼Œâ€œA åªèƒ½ä½¿ç”¨å…·æœ‰è¯»å–èŒƒå›´çš„æœ‰æ•ˆæœ€ç»ˆç”¨æˆ·å‡­è¯ä¸ B è¿›è¡Œé€šä¿¡â€ï¼‰ã€‚\n- **é€Ÿç‡é™åˆ¶å’Œå¼¹æ€§åŠŸèƒ½**ï¼Œç”¨äºå‡è½»å¸¸è§çš„åº”ç”¨çº§æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œå¹¶ä¿æŠ¤å…å—å¸¸è§çš„çº§è”æ•…éšœæ¨¡å¼çš„å½±å“ã€‚\n- **WAF** å’Œå…¶ä»–**æ·±å±‚åŒ…æ£€æµ‹**åŠŸèƒ½ï¼Œç”¨äºå†…éƒ¨æµé‡ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨è¾¹ç¼˜ã€‚\n- æ¥è‡ªç½‘æ ¼ä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºçš„**ä¸€è‡´çš„æ“ä½œé¥æµ‹**ï¼Œå¯ç”¨äºç†è§£ã€å®æ–½å’Œå®¡æ ¸å®‰å…¨ç­–ç•¥ã€‚\n- å…·æœ‰åŠ¨æ€è¿è¡Œæ—¶æ›´æ–°çš„**ç­–ç•¥å³ä»£ç **ï¼ˆPolicy-as-codeï¼‰æ¨¡å‹ï¼Œç‹¬ç«‹äºåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸã€‚\n\n## æœåŠ¡ç½‘æ ¼ä½œä¸ºåˆ†å±‚é˜²å¾¡çš„ä¸€éƒ¨åˆ†\n\nè€ƒè™‘åˆ°ç½‘æ ¼çš„å®‰å…¨åŠŸèƒ½ï¼Œæˆ‘ä»¬è®¤ä¸ºï¼Œç»„ç»‡é‡‡ç”¨å®ƒä½œä¸ºåˆ†å±‚é˜²å¾¡æ–¹æ³•çš„ä¸€éƒ¨åˆ†æ˜¯æœ€åˆç†çš„ã€‚\n\n![å›¾ 2ï¼šæ¯å±‚ç­–ç•¥çš„ç¤ºä¾‹ä»¥åŠä¸€ä¸ªç¤ºä¾‹éƒ¨ç½²æ‹“æ‰‘ã€‚](f2.png)\n\n## L3 å±‚çš„æ•æ·æ€§ï¼šç²—ç²’åº¦çš„å…¥å£å’Œå‡ºå£ç­–ç•¥ä»¥åŠ L7 çš„ç»†ç²’åº¦æ§åˆ¶\n\nåœ¨è¾¹ç¼˜çš„ L3 æ§åˆ¶ï¼ˆå¦‚é˜²ç«å¢™ï¼‰åœ¨ç²—ç²’åº¦çš„å…¥å£å’Œå‡ºå£ç­–ç•¥æ–¹é¢ä»ç„¶æœ‰æ•ˆï¼Œä½†é€šå¸¸ä¼šå‡æ…¢åº”ç”¨ç¨‹åºå¼€å‘æ•æ·æ€§ã€‚ç”±äºç½‘æ ¼æä¾›äº†ç»†ç²’åº¦çš„æœåŠ¡é—´æˆæƒï¼Œæ‰€ä»¥å¯ä»¥åœ¨ L3 ä¸Šè®¾ç½®æ›´å¹¿æ³›çš„ç­–ç•¥ï¼Œä¸ºå¹³å°ã€å®‰å…¨å’Œåº”ç”¨ç¨‹åºå›¢é˜Ÿæä¾›æ›´å¤šæ•æ·æ€§ã€‚\n\n**å®æ–½å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®æ§åˆ¶**ã€‚ç½‘æ ¼çš„å‡ºå£ä»£ç†ç‰¹åˆ«é€‚ç”¨äºå®æ–½åº”ç”¨ç¨‹åºåˆ°å¤–éƒ¨æœåŠ¡çš„æ§åˆ¶ï¼Œè€Œåªæœ‰å‡ºå£ä»£ç†æœ¬èº«è¢«å¤–å‡ºé˜²ç«å¢™ allow-listedï¼šè¿™ä¸ºå¹³å°æˆ–å®‰å…¨å›¢é˜Ÿåœ¨ç®¡ç†å“ªäº›åº”ç”¨ç¨‹åºå…è®¸ä¸ä¼ä¸šåŸºç¡€æ¶æ„ä¹‹å¤–çš„é€šä¿¡æä¾›äº†å¾ˆå¤šæ•æ·æ€§ï¼ŒåŒæ—¶ä¿æŒç°æœ‰çš„åŸºäºå‘¨ç•Œçš„æ¨¡å‹ã€‚\n\n**ä½¿ç”¨åŠ å¯†å’ŒåŠ¨æ€è®¿é—®æ§åˆ¶ä»£æ›¿â€œå¯è¾¾æ€§å³æˆæƒâ€**ã€‚ç½‘æ ¼å¯ä»¥å¼€å§‹æœ‰æ•ˆåœ°å–ä»£ VPN å’ŒåŸºäº IPSec çš„ç½‘ç»œâ€œå¯è¾¾æ€§å³æˆæƒâ€æ¨¡å¼ï¼Œæä¾›ä¼ è¾“ä¸­çš„åŠ å¯†ï¼Œä»¥åŠæ¯ä¸ªåº”ç”¨è€Œä¸æ˜¯æ¯ä¸ªä¸»æœºçš„è®¤è¯å’Œæˆæƒã€‚\n\n## L4 å±‚çš„æ”¹è¿›ï¼šæ›´æ‰å¹³å’Œæ˜“äºç®¡ç†çš„ç½‘ç»œå¾®åˆ†æ®µ\n\nå¾®åˆ†æ®µä¹‹ç±»çš„æ§åˆ¶å¯ä»¥é€šè¿‡ç½‘æ ¼è¿›ä¸€æ­¥æ”¹è¿›ï¼šå°½ç®¡æˆ‘ä»¬å¯èƒ½å…è®¸æ•´ä¸ªï¼ˆå°ï¼‰å­ç½‘åœ¨åŸºäºåˆ†æ®µçš„ç­–ç•¥ä¸­è¿›è¡Œé€šä¿¡ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç½‘æ ¼æŒ‰æ–¹æ³•å’ŒåŠ¨è¯å¯¹å•ç‹¬çš„æœåŠ¡é—´é€šä¿¡è¿›è¡Œæ§åˆ¶ã€‚\n\n**è¡¥å……ç°æœ‰çš„å¾®åˆ†æ®µåŒæ—¶å±•å¹³ç½‘ç»œ**ã€‚é€šè¿‡æä¾›ç»†ç²’åº¦çš„æœåŠ¡é—´æ§åˆ¶ï¼Œç½‘æ ¼å¾€å¾€ä¼šè¡¥å……ç°æœ‰çš„å¾®åˆ†æ®µç­–ç•¥ï¼ŒåŒæ—¶ä½¿å¾—ç»„ç»‡æ›´å®¹æ˜“ç®¡ç†çš„è¾ƒå¹³çš„ç½‘ç»œå¾—ä»¥é‡‡ç”¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨äº‘ç¯å¢ƒä¸­ï¼‰ã€‚\n\n**ä½¿ç”¨å·¥ä½œè´Ÿè½½èº«ä»½å¯ç”¨ä¼ è¾“æœŸé—´çš„åŠ å¯†ï¼ˆmTLSï¼‰å’ŒæœåŠ¡çº§åˆ«è®¿é—®æ§åˆ¶**ã€‚ä¼ è¾“å±‚å‡ ä¹æ€»æ˜¯å¤„ç†åŠ å¯†ä¼ è¾“ï¼Œç½‘æ ¼é€šè¿‡æ ¹æ® SPIFFE è§„èŒƒå‘å¸ƒå’Œè½®æ¢çŸ­æœŸï¼ˆ\u003c24 å°æ—¶ï¼‰å·¥ä½œè´Ÿè½½èº«ä»½è¯ä¹¦æ¥ä¸ºåº”ç”¨ç¨‹åºå®ç°æ­¤åŠŸèƒ½ï¼Œä»è€Œå…è®¸ä¼ è¾“æœŸé—´çš„åŠ å¯†ä»¥åŠæœåŠ¡çº§åˆ«çš„èº«ä»½éªŒè¯å’Œæˆæƒã€‚\n\n## L7 å±‚çš„å¢å¼ºï¼šæ— å¤„ä¸åœ¨çš„è¾¹ç¼˜å’Œè®¿é—®æ§åˆ¶\n\n**ä¸ºæ‰€æœ‰æµé‡æä¾›è¾¹ç¼˜æ§åˆ¶**ã€‚L7 æ§åˆ¶ï¼Œå¦‚ Web åº”ç”¨ç¨‹åºé˜²ç«å¢™ï¼ˆWAFï¼‰ä»¥åŠâ€œAPI ç½‘å…³åŠŸèƒ½â€ï¼ˆå¦‚æµé‡é™åˆ¶ï¼‰å‡ ä¹æ€»æ˜¯åœ¨è¾¹ç¼˜å®æ–½ã€‚ç½‘æ ¼å¯ä»¥é€šè¿‡ä¸ºç½‘æ ¼ä¸­æ‰€æœ‰æµé‡ï¼ˆåŒ…æ‹¬å†…éƒ¨çš„â€œä¸œè¥¿â€é€šä¿¡ï¼‰å¯ç”¨ç›¸åŒçš„åŠŸèƒ½æ¥å¢å¼ºè¿™äº›ç°æœ‰éƒ¨ç½²ã€‚\n\n**ç®€åŒ–åº”ç”¨ç¨‹åºçš„è®¿é—®æ§åˆ¶**ã€‚é™¤äº†ä½¿è¾¹ç¼˜æ§åˆ¶æ— å¤„ä¸åœ¨ä¹‹å¤–ï¼Œç½‘æ ¼è¿˜å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçœ‹åˆ°è¯·æ±‚ä¹‹å‰æ‰§è¡Œç«¯ç”¨æˆ·èº«ä»½éªŒè¯å’Œç²—ç²’åº¦æˆæƒï¼Œä»è€Œå¤§å¤§ç®€åŒ–åº”ç”¨ç¨‹åºæœ¬èº«å¿…é¡»æ‰§è¡Œçš„è®¿é—®æ§åˆ¶ã€‚åœ¨æœªæ¥ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è¶Šæ¥è¶Šå¤šçš„è®¿é—®æ§åˆ¶åŠŸèƒ½ä»åº”ç”¨ç¨‹åºè¿ç§»åˆ°ç½‘æ ¼ä¸­ã€‚\n\n## æ€»ç»“å’Œå±•æœ›\n\næˆ‘ä»¬è®¤ä¸ºï¼ŒæœåŠ¡ç½‘æ ¼æœ€é€‚åˆä½œä¸ºç°æœ‰å®‰å…¨æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡åœ¨ä¼ ç»Ÿå®‰å…¨æ§åˆ¶ä¹‹ä¸Šæ·»åŠ æ›´ç»†ç²’åº¦çš„å®‰å…¨ç­–ç•¥æ¥å®ç°ã€‚ä½œä¸ºä¸€ä¸ªé€šç”¨ç­–ç•¥æ‰§è¡Œç‚¹ï¼Œç½‘æ ¼åœ¨æ›´æ”¹æœ€å›°éš¾çš„è¾ƒä½å±‚æä¾›äº†æ›´æ¾æ•£çš„ç­–ç•¥ï¼Œå°†æ•æ·æ€§æ¨å‘å †æ ˆçš„é¡¶éƒ¨ï¼Œå…¶ä¸­æ›´å¤šçš„ä¸Šä¸‹æ–‡å…è®¸åœ¨æ›´é«˜å±‚å®ç°æ›´ç‰¹å®šçš„æ§åˆ¶ã€‚è¿™ç§å¼ºå¤§çš„å®‰å…¨å±‚å¯¹äºå¤§å¤šæ•°ç»„ç»‡æ¥è¯´éƒ½æ˜¯é‡‡ç”¨åˆ†å±‚é˜²å¾¡æ·±åº¦æ–¹æ³•çš„æœ€ä½³é€‰æ‹©ã€‚\n\n## æ¥ä¸‹æ¥ï¼šæœåŠ¡ç½‘æ ¼éƒ¨ç½²æœ€ä½³å®è·µ\n\næˆ‘ä»¬æœåŠ¡ç½‘æ ¼æœ€ä½³å®è·µç³»åˆ—åšå®¢æ–‡ç« çš„ä¸‹ä¸€ç¯‡å°†è®¨è®ºéƒ¨ç½²æ‹“æ‰‘ã€‚åœ¨å¤šä¸ªé›†ç¾¤çš„çœŸå®åŸºç¡€æ¶æ„ä¸­éƒ¨ç½²æœåŠ¡ç½‘æ ¼æ—¶å­˜åœ¨ä¸€äº›ç§»åŠ¨éƒ¨åˆ†ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ç ”ç©¶ï¼š\n\n- æ§åˆ¶å¹³é¢åº”å¦‚ä½•éƒ¨ç½²åœ¨åº”ç”¨ç¨‹åºé™„è¿‘ã€‚ \n- åº”è¯¥å¦‚ä½•éƒ¨ç½²å…¥å£ï¼Œä»¥ä¿ƒè¿›å®‰å…¨å’Œæ•æ·æ€§ã€‚\n- å¦‚ä½•ä½¿ç”¨ Envoy ä¿ƒè¿›è·¨é›†ç¾¤çš„è´Ÿè½½å¹³è¡¡ã€‚\n- è¯ä¹¦åœ¨ç½‘æ ¼ä¸­åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚\n\n---\n\nå¦‚æœä½ ä¸ç†Ÿæ‚‰æœåŠ¡ç½‘æ ¼å’Œ Kubernetes å®‰å…¨æ€§ï¼Œæˆ‘ä»¬åœ¨ [Tetrate Academy](https:\/\/tetr8.io\/academy) æä¾›äº†ä¸€ç³»åˆ—å…è´¹åœ¨çº¿è¯¾ç¨‹ï¼Œå¯ä»¥è®©ä½ å¿«é€Ÿäº†è§£ Istio å’Œ Envoyã€‚\n\nå¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§å¿«é€Ÿå°† Istio æŠ•å…¥ç”Ÿäº§çš„æ–¹æ³•ï¼Œè¯·æŸ¥çœ‹ [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid)ã€‚TID æ˜¯ Tetrate çš„å¼ºåŒ–ã€å®Œå…¨ä¸Šæ¸¸çš„ Istio å‘è¡Œç‰ˆï¼Œå…·æœ‰ç»è¿‡ FIPS éªŒè¯çš„æ„å»ºå’Œæ”¯æŒã€‚è¿™æ˜¯å¼€å§‹ä½¿ç”¨ Istio çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºä½ çŸ¥é“ä½ æœ‰ä¸€ä¸ªå€¼å¾—ä¿¡èµ–çš„å‘è¡Œç‰ˆï¼Œæœ‰ä¸€ä¸ªæ”¯æŒä½ çš„ä¸“å®¶å›¢é˜Ÿï¼Œå¹¶ä¸”å¦‚æœéœ€è¦ï¼Œè¿˜å¯ä»¥é€‰æ‹©å¿«é€Ÿè·å¾— FIPS åˆè§„æ€§ã€‚\n\nä¸€æ—¦å¯åŠ¨å¹¶è¿è¡Œ Istioï¼Œä½ å¯èƒ½éœ€è¦æ›´ç®€å•çš„æ–¹æ³•æ¥ç®¡ç†å’Œä¿æŠ¤ä½ çš„æœåŠ¡ï¼Œè€Œä¸ä»…ä»…æ˜¯ Istio ä¸­å¯ç”¨çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯ Tetrate Service Bridge çš„ç”¨æ­¦ä¹‹åœ°ã€‚ä½ å¯ä»¥[åœ¨è¿™é‡Œ](https:\/\/tetr8.io\/tsb)è¯¦ç»†äº†è§£ Tetrate Service Bridge å¦‚ä½•ä½¿æœåŠ¡ç½‘æ ¼æ›´å®‰å…¨ã€æ›´æ˜“äºç®¡ç†å’Œå¼¹æ€§ï¼Œæˆ–[è”ç³»æˆ‘ä»¬è¿›è¡Œå¿«é€Ÿæ¼”ç¤º](https:\/\/tetr8.io\/contact)ã€‚\n', '\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æˆ‘ä»¬è®¤ä¸ºï¼ŒæœåŠ¡ç½‘æ ¼æœ€é€‚åˆä½œä¸ºç°æœ‰å®‰å…¨æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡åœ¨ä¼ ç»Ÿå®‰å…¨æ§åˆ¶ä¹‹ä¸Šæ·»åŠ æ›´ç»†ç²’åº¦çš„å®‰å…¨ç­–ç•¥æ¥å®ç°ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/cert-manager-spire-istio/">ä½¿ç”¨ cert-manager å’Œ SPIRE ç®¡ç† Istio ä¸­çš„è¯ä¹¦</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/12/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä½¿ç”¨ cert-manager å’Œ SPIRE ç®¡ç† Istio ä¸­çš„è¯ä¹¦', 'æœ¬æ–‡ä»‹ç»å¦‚ä½•é›†æˆ SPIRE å’Œä½¿ç”¨ cert-manager å®ç°ç»†ç²’åº¦çš„è¯ä¹¦ç®¡ç†ä»¥åŠè¯ä¹¦è½®æ¢ã€‚', '{{\u003ccallout warning\u0022æ³¨æ„\u0022\u003e}}\n\nä» v1.5.4 ç‰ˆæœ¬å¼€å§‹ï¼ŒSPIRE ç§»é™¤äº† Kubernetes Workload Registrar ç»„ä»¶ï¼Œæ”¹ç”¨ SPIRE Controller Managerï¼Œè¯¦è§ [spire\/spire issue #3853](https:\/\/github.com\/spiffe\/spire\/pull\/3853)ã€‚æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œæœ¬æ–‡ä¸­çš„ç¨‹åºåœ¨ v1.5.4 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šæ— æ³•æ‰§è¡Œï¼Œå› ä¸ºä¼šé‡åˆ°ä¸€ç³»åˆ—èº«ä»½éªŒè¯å¤±è´¥çš„é—®é¢˜ã€‚\n{{\u003c\/callout\u003e}}\n\nåœ¨[ä¸Šä¸€ç¯‡åšå®¢](\/blog\/istio-certificates-management\/)ä¸­æˆ‘ä»‹ç»äº† Istio ä¸­æ˜¯å¦‚ä½•ç®¡ç†è¯ä¹¦çš„ï¼Œè¿™ç¯‡æ–‡ç« å°†æŒ‡å¯¼ä½ å¦‚ä½•ä½¿ç”¨å¤–ç½® CAï¼Œé€šè¿‡é›†æˆ [SPIRE](https:\/\/spiffe.io\/) å’Œ [cert-manager](https:\/\/cert-manager.io\/) å®ç°ç»†ç²’åº¦çš„è¯ä¹¦ç®¡ç†å’Œè‡ªåŠ¨è¯ä¹¦è½®æ¢ã€‚\n\nå¦‚æœä½ è¿˜ä¸äº†è§£ä»€ä¹ˆæ˜¯ SPIRE ä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨ SPIREï¼Œæ¨èä½ é˜…è¯»ä»¥ä¸‹å†…å®¹ï¼š\n\n- [ä¸ºä»€ä¹ˆ Istio è¦ä½¿ç”¨ SPIRE åšèº«ä»½è®¤è¯ï¼Ÿ](\/blog\/why-istio-need-spire\/)\n- [å¦‚ä½•åœ¨ Istio ä¸­é›†æˆ SPIREï¼Ÿ](\/blog\/how-to-integrate-spire-with-istio\/)\n- [é›¶ä¿¡ä»»çš„åŸºçŸ³ï¼šä½¿ç”¨ SPIFFE ä¸ºåŸºç¡€è®¾æ–½åˆ›å»ºé€šç”¨èº«ä»½](\/book\/spiffe\/)\n\n## è¯ä¹¦ç­¾å‘ç®¡ç†æµç¨‹ç®€ä»‹ {#intro}\n\nä¸‹å›¾å±•ç¤ºäº†æœ¬æ–‡ä¸­ä½¿ç”¨çš„åŸºäº cert-manager å’Œ SPIRE çš„è¯ä¹¦ä¿¡ä»»é“¾ï¼š\n\n![åŸºäº cert-managerã€SPIRE çš„è¯ä¹¦ä¿¡ä»»é“¾](spire-chain-tree.svg)\n\nä»å›¾ä¸­ä½ å¯ä»¥çœ‹å‡ºï¼š\n\n- cert-manager ä½œä¸ºæ ¹ CA ä¸º *istiod* å’Œ SPIRE é¢å‘è¯ä¹¦ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†[è‡ªç­¾å Issuer](https:\/\/cert-manager.io\/docs\/configuration\/selfsigned\/)ï¼Œä½ è¿˜å¯ä»¥ä¸ºå…¶é…ç½®ä½¿ç”¨ Let\u0027s Encryptã€Vaultã€Venafi ç­‰å†…ç½® Issuerï¼Œæˆ–å…¶ä»–å¤–ç½®çš„ Issuerï¼›å¦å¤–ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨å…¶ä»– [UpstreamAuthority](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/)ï¼Œä¾‹å¦‚ Vaultã€SPIRE è”é‚¦ç­‰ï¼›\n- SPIRE ä¸º Istio ç½‘æ ¼å†…å·¥ä½œè´Ÿè½½å’Œ Ingress Gatewayã€Egress Gateway é¢å‘ SVID è¯ä¹¦ï¼Œç”¨äºæœåŠ¡é—´ mTLSï¼›\n- å…¶ä¸­ç½‘æ ¼å¤–è®¿é—® Ingress Gateway æ—¶çš„ä½¿ç”¨çš„è¯ä¹¦åŠ Egress Gateway è®¿é—®ç½‘æ ¼å¤–æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦éœ€è¦é¢å¤–é…ç½®ï¼›\n\nä¸‹å›¾å±•ç¤ºäº†åœ¨ Istio ä¸­é›†æˆ SPIRE å’Œ cert-manger åçš„è¯ä¹¦é¢å‘å’Œæ›´æ–°æµç¨‹ã€‚\n\n![Istio é›†æˆ SPIRE å’Œ cert-manager åçš„è¯ä¹¦é¢å‘å’Œæ›´æ–°æµç¨‹](cert-manager-spire-istio.svg)\n\n1. SPIRE Server ä¸­çš„ SPIRE Controller Manager è‡ªåŠ¨æ³¨å†Œ Kubernetes ä¸­çš„å·¥ä½œè´Ÿè½½ï¼Œä¸ºæ‰€æœ‰å·¥ä½œè´Ÿè½½ç”Ÿæˆ SPIFFE æ ‡å‡†çš„èº«ä»½ï¼›\n2. cert-manager ä¸º *istiod* é¢å‘å¹¶ç®¡ç† CA è¯ä¹¦ï¼›\n3. å·¥ä½œè´Ÿè½½ä¸­çš„ Envoy ä»£ç†é€šè¿‡ UNIX Domain Socketï¼ˆUDSï¼‰é€šè¿‡ SDS API å‘åŒèŠ‚ç‚¹ä¸Šçš„ SPIRE Agent å‘é€ CSR è¯·æ±‚ï¼›\n4. SPIRE Agent å‘ SPIRE Server å‘é€ CSRï¼›\n5. SPIRE Server å‘ SPIRE Agent è¿”å›ç­¾ååçš„è¯ä¹¦ï¼›\n6. SPIRE Agent å‘å·¥ä½œè´Ÿè½½è¿”å›ç­¾ååçš„è¯ä¹¦ï¼›\n7. SPIRE è´Ÿè´£å·¥ä½œè´Ÿè½½çš„è¯ä¹¦ç®¡ç†å’Œæ›´æ–°ï¼›\n\nåœ¨äº†è§£äº†å¤§è‡´æµç¨‹åï¼Œä¸‹é¢æˆ‘ä»¬å°†ä¾æ¬¡å®‰è£…å„ä¸ªç»„ä»¶ã€‚å„ä¸ªç»„ä»¶ç‰ˆæœ¬å¦‚ä¸‹ï¼š\n\n- cert-manager v1.15.1\n- SPIRE v1.2.0\n- Istio v1.21.1\n\n## å®‰è£… cert-manager {#install-cert-manager}\n\nè¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£… cert-managerï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥å®ç°è‡ªåŠ¨è¯ä¹¦è½®æ¢ï¼š\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/github.com\/cert-manager\/cert-manager\/releases\/download\/v1.15.1\/cert-manager.yaml\n\u0060\u0060\u0060\n\næ ¹ CA æ˜¯ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤é…ç½®æ ¹ CAï¼š\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Issuer\nmetadata:\n  name: selfsigned\n  namespace: cert-manager\nspec:\n  selfSigned: {}\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: selfsigned-ca\n  namespace: cert-manager\nspec:\n  isCA: true\n  duration: 21600h\n  secretName: selfsigned-ca\n  commonName: certmanager-ca\n  subject:\n    organizations:\n      - cert-manager\n  issuerRef:\n    name: selfsigned\n    kind: Issuer\n    group: cert-manager.io\n---\napiVersion: cert-manager.io\/v1\nkind: ClusterIssuer\nmetadata:\n  name: selfsigned-ca\nspec:\n  ca:\n    secretName: selfsigned-ca\nEOF\n\u0060\u0060\u0060\n\nç„¶åä¸º *istiod* é…ç½®è¯ä¹¦ï¼š\n\n\u0060\u0060\u0060yaml\nkubectl create namespace istio-system\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 1440h\n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\nç°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…å¥½äº† cert-managerï¼Œå¹¶åˆ›å»ºäº†åä¸º \u0060selfsigned-ca\u0060 çš„ \u0060clusterIssuer\u0060ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®‰è£… SPIRE å¹¶å°† cert-manager ä½œä¸º SPIRE çš„  [\u0060UpstreamAuthority\u0060](https:\/\/github.com\/spiffe\/spire\/blob\/main\/doc\/plugin_server_upstreamauthority_cert_manager.md)ã€‚\n\n## å®‰è£… SPIRE {#install-spire}\n\nè¿è¡Œä¸‹é¢çš„å‘½ä»¤å¿«é€Ÿå®‰è£… SPIREï¼š\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/jimmysong.io\/blog\/cert-manager-spire-istio\/manifests\/spire-with-cert-manager-upstream-authority-quick-start.yaml\n\u0060\u0060\u0060\n\nè¯¥ YAML æ–‡ä»¶æ¯”èµ· Istio å®‰è£…åŒ…ä¸­çš„ [\u0060samples\/security\/spire\/spire-quickstart.yaml\u0060](https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.22\/samples\/security\/spire\/spire-quickstart.yaml) æ–‡ä»¶å¢åŠ äº†å¯¹ cert-manager çš„é€‚é…ï¼Œå¦‚ï¼š\n\n- ä¸º \u0060spire-server-cluster-role\u0060 ClusterRole å¢åŠ äº†å¯¹ \u0060cert-manager.io\u0060 API ç»„çš„æƒé™ï¼›\n- åœ¨ SPIRE Server çš„é…ç½®ä¸­å¢åŠ äº† \u0060UpstreamAuthority \u0022cert-manager\u0022\u0060 é…ç½®ï¼› \n\n{{\u003ccallout note \u0022æ³¨æ„\u0022\u003e}}\n\nSPIRE Server é…ç½®ä¸­çš„ \u0060trust_domain\u0060 åº”ä¸å®‰è£… Istio æ—¶æŒ‡å®šçš„ \u0060TRUST_DOMAIN\u0060 ç¯å¢ƒå˜é‡çš„å€¼ä¿æŒä¸€è‡´ã€‚\n\n{{\u003c\/callout\u003e}}\n\nè¯¥å‘½ä»¤ä¸­ä¼šå®‰è£… SPIRE Controller Managerï¼Œè‡ªåŠ¨æ³¨å†Œ Kubernetes ä¸­çš„å·¥ä½œè´Ÿè½½ã€‚æ‰€æœ‰å·¥ä½œè´Ÿè½½å°†æ ¹æ®å…¶æœåŠ¡è´¦æˆ·æ³¨å†Œ SPIFFE æ ‡å‡†çš„æœåŠ¡èº«ä»½æ ¼å¼ \u0060spiffe:\/\/\u003ctrust-domain\u003e\/ns\/\u003cnamespace\u003e\/sa\/\u003cservice-account\u003e\u0060ã€‚\n\nå¦‚æœä½ æƒ³è°ƒæ•´ SPIRE CA å’Œ SVID è¯ä¹¦çš„ TTLï¼Œå¯ä»¥åœ¨ SPIRE Server çš„é…ç½®ä¸­ä¿®æ”¹ \u0060ca_ttl\u0060ï¼ˆé»˜è®¤ 24hï¼‰å’Œ \u0060default_svid_ttl\u0060ï¼ˆé»˜è®¤ 1hï¼‰ï¼Œè¯¦è§ [SPIRE Server é…ç½®](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/)ã€‚\n\n## å®‰è£… Istio {#install-istio}\n\nPod ä¸­çš„ Envoy ä»£ç†å°†å…±äº«æœ¬åœ° SPIRE Agent çš„ Unix Domain Socketï¼Œé€šè¿‡ Workload API ä¸ SPIRE Server é€šä¿¡è·å–è¯ä¹¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![SPIRE Agent æ¶æ„å›¾](spire-agent.svg)\n\nè¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£… Istio å¹¶å¯ç”¨ CA è¯ä¹¦è‡ªåŠ¨è½®æ¢ï¼š\n\n\u0060\u0060\u0060yaml\nistioctl install --skip-confirmation -f - \u003c\u003cEOF\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\nspec:\n  profile: default\n  meshConfig:\n    # ä¿¡ä»»åŸŸåº”ä¸ SPIRE Server ä¸­é…ç½®çš„ä¿¡ä»»åŸŸç›¸åŒ\n    trustDomain: example.org\n  values:\n    global:\n    # è‡ªå®šä¹‰ sidecar æ¨¡æ¿\n    sidecarInjectorWebhook:\n      templates:\n        spire: |\n          spec:\n            containers:\n            - name: istio-proxy\n              volumeMounts:\n              - name: workload-socket\n                mountPath: \/run\/secrets\/workload-spiffe-uds\n                readOnly: true\n            volumes:\n              - name: workload-socket\n                csi:\n                  driver: \u0022csi.spiffe.io\u0022\n                  readOnly: true\n  components:\n    pilot:\n      k8s:\n        env:\n          # å¦‚æœå¯ç”¨ï¼Œå¦‚æœç”¨æˆ·å¼•å…¥æ–°çš„ä¸­é—´æ’ä»¶ CAï¼Œç”¨æˆ·ä¸éœ€è¦é‡æ–°å¯åŠ¨ istiod æ¥è·å–è¯ä¹¦ã€‚Istiod ä¼šè·å–æ–°æ·»åŠ çš„ä¸­é—´æ’ä»¶ CA çš„è¯ä¹¦å¹¶æ›´æ–°å®ƒã€‚ä¸æ”¯æŒæ’å…¥æ–°çš„ Root-CAã€‚\n          - name: AUTO_RELOAD_PLUGIN_CERTS\n            value: \u0022true\u0022 \n    ingressGateways:\n      - name: istio-ingressgateway\n        enabled: true\n        label:\n          istio: ingressgateway\n        k8s:\n          overlays:\n            - apiVersion: apps\/v1\n              kind: Deployment\n              name: istio-ingressgateway\n              patches:\n                - path: spec.template.spec.volumes.[name:workload-socket]\n                  value:\n                    name: workload-socket\n                    csi:\n                      driver: \u0022csi.spiffe.io\u0022\n                      readOnly: true\n                - path: spec.template.spec.containers.[name:istio-proxy].volumeMounts.[name:workload-socket]\n                  value:\n                    name: workload-socket\n                    mountPath: \u0022\/run\/secrets\/workload-spiffe-uds\u0022\n                    readOnly: true\nEOF\n\u0060\u0060\u0060\n\nå› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨ Istio Operator ä¸­å£°æ˜çš„ \u0060spire\u0060 æ¨¡æ¿æ¥éƒ¨ç½²å·¥ä½œè´Ÿè½½ï¼Œå› æ­¤æˆ‘ä»¬è¿è¡Œä¸‹é¢çš„å‘½ä»¤éƒ¨ç½² Bookinfo åº”ç”¨ï¼š\n\n\u0060\u0060\u0060bash\nistioctl kube-inject -f bookinfo-with-spire-template.yaml | kubectl apply -n default -f -\n\u0060\u0060\u0060\n\n**æ³¨æ„**ï¼šä¸Šé¢å‘½ä»¤ä¸­ä½¿ç”¨çš„ \u0060bookinfo-with-spire-template.yaml\u0060 æ–‡ä»¶å¯ä»¥åœ¨[è¿™é‡Œ](.\/manifests\/bookinfo-with-spire-template.yaml)æ‰¾åˆ°ï¼Œä¸ Istio å®‰è£…åŒ…ä¸­çš„ [\u0060samples\/bookinfo\/platform\/kube\/bookinfo.yaml\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml) æ–‡ä»¶å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯æ¯ä¸ª Deployment çš„ template ä¸­éƒ½å¢åŠ äº†ä»¥ä¸‹æ³¨è§£ï¼š\n\n\u0060\u0060\u0060yaml\nannotations:\n  inject.istio.io\/templates: \u0022sidecar,spire\u0022\n\u0060\u0060\u0060\n\n## éªŒè¯ SPIRE {#validate-spire}\n\næˆ‘ä»¬å°†é€šè¿‡æ£€æŸ¥ productpage æœåŠ¡çš„èº«ä»½å’Œè¯ä¹¦é…ç½®æ¥éªŒè¯ SPIRE æ˜¯å¦ç”Ÿæ•ˆã€‚\n\nä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æ£€æŸ¥ SPIRE æ˜¯å¦ç»™å·¥ä½œè´Ÿè½½é¢å‘äº†èº«ä»½è¯æ˜ï¼š\n\n\u0060\u0060\u0060bash\nkubectl exec -i -t spire-server-0 -n spire -c spire-server -- \/bin\/sh -c \u0022bin\/spire-server entry show -socketPath \/run\/spire\/sockets\/server.sock -spiffeID spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\u0022\n\u0060\u0060\u0060\n\nä½ å¯ä»¥åœ¨è¾“å‡ºç»“æœä¸­çœ‹åˆ° protuctpage æœåŠ¡çš„èº«ä»½ä¿¡æ¯ï¼š\n\n\u0060\u0060\u0060\nFound 1 entry\nEntry ID         : 69fbf896-a296-4c3c-8179-44bf4e49e474\nSPIFFE ID        : spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\nParent ID        : spiffe:\/\/example.org\/k8s-workload-registrar\/demo-cluster\/node\/gke-cluster-1-default-pool-18d66649-z1lm\nRevision         : 1\nTTL              : default\nSelector         : k8s:node-name:gke-cluster-1-default-pool-18d66649-z1lm\nSelector         : k8s:ns:default\nSelector         : k8s:pod-uid:73347537-a3e5-4e43-b8c5-bd315c7385b7\nDNS name         : productpage-v1-7f444fc4dd-rq47m\nDNS name         : productpage.default.svc\n\u0060\u0060\u0060\n\næŸ¥çœ‹ \u0060productpage\u0060 pod çš„è¯ä¹¦ä¿¡ä»»é“¾ï¼š\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\næŸ¥çœ‹æ ¹è¯ä¹¦ï¼š\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes\u0027 | base64 --decode \u003e root.pem\n\u0060\u0060\u0060\n\n\u0060chain.pem\u0060 æ–‡ä»¶æ˜¯è¯ä¹¦ä¿¡ä»»é“¾ï¼Œå…¶ä¸­åŒ…å«ä¸¤ä¸ªè¯ä¹¦ï¼Œå°†å®ƒä»¬ä¿å­˜åˆ°ä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼š\n\n\u0060\u0060\u0060bash\nsplit -p \u0022-----BEGIN CERTIFICATE-----\u0022 chain.pem cert-\n\u0060\u0060\u0060\n\nåä½¿ç”¨ OpenSSL æŸ¥çœ‹æ‰€æœ‰è¯ä¹¦ï¼š\n\n\u0060\u0060\u0060\nopenssl x509 -noout -text -in cert-aa\nopenssl x509 -noout -text -in cert-ab\nopenssl x509 -noout -text -in root.pem\n\u0060\u0060\u0060\n\nä½ å°†çœ‹åˆ°å¦‚ä¸‹çš„è¯ä¹¦ä¿¡ä»»é“¾ \u0060root.pem\u0060 -\u003e \u0060cert-aa\u0060  -\u003e \u0060cert-ab\u0060ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![Productpage æœåŠ¡çš„è¯ä¹¦ä¿¡ä»»é“¾](spire-bookinfo-cert-chain.svg)\n\næŸ¥çœ‹ Istiod çš„è¯ä¹¦ï¼š\n\n\u0060\u0060\u0060bash\nistioctl -n istio-system proxy-config secret deployment\/istiod -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\nä»è¯ä¹¦ä¿¡ä»»é“¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š\n\n- cert-manager åšä¸º PKI çš„æ ¹èŠ‚ç‚¹ä¸º *istiod* é¢å‘è¯ä¹¦ï¼›\n- SPIRE ä½œä¸ºä¸­é—´ CA å†ä¸ºå„ä¸ªå·¥ä½œè´Ÿè½½é¢å‘è¯ä¹¦ï¼›\n- Istio ç½‘æ ¼ä¸­å·¥ä½œè´Ÿè½½çš„ X509 v3 ä¸»ä½“åˆ«åä¸­çš„ URI éµå¾ªäº† SPIFF èº«ä»½è§„èŒƒï¼›\n- Istio æœåŠ¡ç½‘æ ¼ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„èº«ä»½å’Œè¯ä¹¦éƒ½ç”± SPIRE æ¥ç®¡ç†ï¼›\n\n## è®¾ç½®è¯ä¹¦è‡ªåŠ¨è½®æ¢ {#cert-auto-rotate}\n\nå¦‚æœä½ è¦ä¿®æ”¹ *istiod* è¯ä¹¦çš„è½®æ¢å‘¨æœŸï¼Œä» 60 å¤©ï¼ˆ1440 å°æ—¶ï¼‰ç¼©çŸ­åˆ° 30 å¤©ï¼ˆ720 å°æ—¶ï¼‰ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 720h \n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\nè¿è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ *istiod* çš„æ—¥å¿—ï¼š\n\n\u0060\u0060\u0060bash\nkubectl logs -l app=istiod -n istio-system -f\n\u0060\u0060\u0060\n\nè¿‡ä¸¤åˆ†é’Ÿåï¼Œä½ å°†çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¯ä¹¦æ›´æ”¹è®°å½•ï¼š\n\n\u0060\u0060\u0060\n2022-12-23T03:48:42.697360Z\tinfo\tUpdate Istiod cacerts\n2022-12-23T03:48:42.697503Z\tinfo\tUsing kubernetes.io\/tls secret type for signing ca files\n2022-12-23T03:48:42.778241Z\tinfo\tIstiod has detected the newly added intermediate CA and updated its key and certs accordingly\n2022-12-23T03:48:42.779459Z\tinfo\tx509 cert - Issuer: \u0022CN=istiod.istio-system.svc\u0022, Subject: \u0022\u0022, SN: d7acac2301045f741e5e30cff380deaf, NotBefore: \u00222022-12-23T03:46:42Z\u0022, NotAfter: \u00222032-12-20T03:48:42Z\u0022\n2022-12-23T03:48:42.779561Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=istiod.istio-system.svc\u0022, SN: 164bf045670a1716ed3f0f1c89b56122, NotBefore: \u00222022-12-23T03:48:14Z\u0022, NotAfter: \u00222023-01-22T03:48:14Z\u0022\n2022-12-23T03:48:42.779642Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=certmanager-ca,O=cert-manager\u0022, SN: 8533dbfe0b84ed1fc4e3c76be7ef612f, NotBefore: \u00222022-12-20T07:50:12Z\u0022, NotAfter: \u00222025-06-07T07:50:12Z\u0022\n2022-12-23T03:48:42.779657Z\tinfo\tIstiod certificates are reloaded\n\u0060\u0060\u0060\n\nè¦ä¿®æ”¹å·¥ä½œè´Ÿè½½è¯ä¹¦çš„è‡ªåŠ¨è½®æ¢å‘¨æœŸï¼Œä½ å¯ä»¥è®¾ç½® \u0060pilot-agent\u0060 å‘½ä»¤çš„ç¯å¢ƒå˜é‡ \u0060SECRET_TTL\u0060ï¼Œé»˜è®¤å€¼ä¸º \u006024h0m0s\u0060ã€‚\n\n## æ€»ç»“ {#summary}\n\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† cert-manager ä½œä¸º PKIï¼Œå°† SPIRE é›†æˆåˆ°æˆ‘ä»¬çš„è¯ä¹¦ä¿¡ä»»é“¾ä¸­ï¼Œå¹¶ä¸º Istio ç½‘æ ¼ä¸­çš„å·¥ä½œè´Ÿè½½åˆ›å»ºèº«ä»½å’Œè¯ä¹¦ã€‚é€šè¿‡ä½¿ç”¨ cert-managerï¼Œä½ ä¸ç”¨æ‹…å¿ƒ *istiod* è¯ä¹¦è¿‡æœŸçš„é—®é¢˜ï¼Œè¿˜å¯ä»¥æ ¹æ®éœ€è¦æ›´æ–°è¯ä¹¦ã€‚ä½ è¿˜å¯ä»¥æ ¹æ®éœ€è¦å°† cert-manager é›†æˆåˆ°å…¶ä»–è¯ä¹¦ä¾›åº”å•†ï¼Œå¦‚ [Let\u0027s Encrypt](https:\/\/letsencrypt.org\/)ã€[HashiCorp Vault](https:\/\/www.vaultproject.io\/)ã€[Venafi](https:\/\/www.venafi.com\/) ç­‰ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [istio-csr](https:\/\/github.com\/cert-manager\/istio-csr) ç›´æ¥è®© cert-manager æ¥ç®¡ç† Istio ä¸­çš„è¯ä¹¦ï¼Œæˆ–[ä½¿ç”¨ Vault æ¥å­˜å‚¨è¯ä¹¦](https:\/\/cloudnative.to\/blog\/how-to-use-hashicorp-vault-as-a-more-secure-way-to-store-istio-certificates\/)ã€‚\n\n## å‚è€ƒ {#reference}\n\n- [å°† Istio çº³å…¥ä¿¡ä»»é“¾ï¼šä½¿ç”¨ç°æœ‰ PKI ä½œä¸ºä¿¡ä»»æ ¹ - cloudnative.to](https:\/\/cloudnative.to\/blog\/istio-trust\/)\n- [åœ¨ç”Ÿäº§ä¸­å¤§è§„æ¨¡è‡ªåŠ¨åŒ– Istio CA è½®æ¢ - cloudnative.to](https:\/\/cloudnative.to\/blog\/automate-istio-ca-rotation-in-production-at-scale\/)\n- [å¦‚ä½•ä½¿ç”¨ Hashicorp Vault ä½œä¸ºä¸€ç§æ›´å®‰å…¨çš„æ–¹å¼æ¥å­˜å‚¨ Istio è¯ä¹¦ - cloudnative.to](https:\/\/cloudnative.to\/blog\/how-to-use-hashicorp-vault-as-a-more-secure-way-to-store-istio-certificates\/)\n- [å¦‚ä½•åœ¨ Istio ä¸­é›†æˆ SPIRE - cloudnative.to](https:\/\/cloudnative.to\/blog\/istio-spire-integration\/)\n- [SPIRE Server Configuration Reference - spiffe.io](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/#built-in-plugins)\n- [Server plugin: UpstreamAuthority \u0022cert-manager\u0022 - github.com](https:\/\/github.com\/spiffe\/spire\/blob\/v1.5.3\/doc\/plugin_server_upstreamauthority_cert_manager.md)\n- [Configuring SPIRE - spiffe.io](https:\/\/spiffe.io\/docs\/latest\/deploying\/configuring\/)\n', '\/blog\/cert-manager-spire-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»å¦‚ä½•é›†æˆ SPIRE å’Œä½¿ç”¨ cert-manager å®ç°ç»†ç²’åº¦çš„è¯ä¹¦ç®¡ç†ä»¥åŠè¯ä¹¦è½®æ¢ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/categories/istio/">
         Â«Â«
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/categories/istio/page/4/" class="page-link">
         Â«
       </a>
     </li>
     
     
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/categories/istio/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/6/" class="page-link">
             6
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/7/" class="page-link">
             7
           </a>
         </li>
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/categories/istio/page/6/" class="page-link">
         Â»
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/categories/istio/page/9/">
         Â»Â»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      ä¸“æ 
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(82)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>éšç¬”</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>å…¶ä»–</span>
            <span>(19)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>ä¸šæ€</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>äº‘åŸç”Ÿ</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>å®‰å…¨</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>å¼€æº</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>æ—…è¡Œ</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%b7%a5%e5%85%b7" class="sidebar-item">
            <span>å·¥å…·</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>å¯è§‚æµ‹æ€§</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      èµ„æ–™
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>å‡ºç‰ˆç‰©</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘ç”µå­ä¹¦</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>ç¿»è¯‘æ–‡æ¡£</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘å›¾ä¹¦</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>åŸåˆ›å›¾ä¹¦</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>æ•™ç¨‹æ‰‹å†Œ</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">è”ç³»</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">å¾®ä¿¡å…¬ä¼—å·</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">åšå®¢</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-ext-proc-guide/">æ·±å…¥è§£æ Envoy å¤–éƒ¨å¤„ç†è¿‡æ»¤å™¨ï¼ˆext_procï¼‰</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-ambient-l7-flow-analysis/">æ·±å…¥ Istio Ambient æ¨¡å¼ï¼šä» ztunnel åˆ° Waypoint ä»£ç†çš„ L7 æµé‡è·¯å¾„è§£æ</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/building-private-ai-knowledge-base-anythingllm/">æ¢ç´¢ AnythingLLMï¼šå€ŸåŠ©å¼€æº AI æ‰“é€ ç§æœ‰åŒ–æ™ºèƒ½çŸ¥è¯†åº“</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é“¾æ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio æœåŠ¡ç½‘æ ¼
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate å…¬å¸
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå­¦é™¢|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå¼€æºé¡¹ç›®å¤§å…¨
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿç¤¾åŒºï¼ˆä¸­å›½ï¼‰
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">æ•™ç¨‹</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes åŸºç¡€æ•™ç¨‹
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  ç®€æ˜ Envoy æ•™ç¨‹
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é€šçŸ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">èµ„æ–™åˆ†äº«ï¼šäº‘åŸç”Ÿåº”ç”¨æœåŠ¡ç½‘æ ¼ä»£ç†æ¨¡å‹çš„å¨èƒåˆ†ææŒ‡å—</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024ï¼ˆé¦™æ¸¯ï¼‰</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">ç½‘ç«™æ”¹ç‰ˆé€šçŸ¥</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">Â© 2017-2024 Jimmy Song ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />










<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
