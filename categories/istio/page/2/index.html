<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Istio 专栏 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="欢迎来到 Istio 专栏，这里是关于服务网格 Istio 的全面资源和深入解读。涵盖了从入门到高级使用的各种主题，包括服务发现、负载均衡、流量管理、策略执行和可观测性。无论你是初学者还是资深用户，都能在这里找到有价值的内容。通过教程、指南和最佳实践，你将能够更好地理解和应用 Istio，提升你的微服务架构的可靠性和可管理性。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.145.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/categories/istio/" />
  <meta property="og:title" content="Istio 专栏 | Jimmy Song" />
  <meta property="twitter:title" content="Istio 专栏 | Jimmy Song" />

  
  <meta property="og:description" content="欢迎来到 Istio 专栏，这里是关于服务网格 Istio 的全面资源和深入解读。涵盖了从入门到高级使用的各种主题，包括服务发现、负载均衡、流量管理、策略执行和可观测性。无论你是初学者还是资深用户，都能在这里找到有价值的内容。通过教程、指南和最佳实践，你将能够更好地理解和应用 Istio，提升你的微服务架构的可靠性和可管理性。" />
  <meta property="twitter:description" content="欢迎来到 Istio 专栏，这里是关于服务网格 Istio 的全面资源和深入解读。涵盖了从入门到高级使用的各种主题，包括服务发现、负载均衡、流量管理、策略执行和可观测性。无论你是初学者还是资深用户，都能在这里找到有价值的内容。通过教程、指南和最佳实践，你将能够更好地理解和应用 Istio，提升你的微服务架构的可靠性和可管理性。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                资料
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="/book">书籍</a>
                
                <a class="dropdown-item" href="/slide">幻灯片</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/categories/istio/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Istio 专栏
                </p>
                <p class="page-description">
                    欢迎来到 Istio 专栏，这里是关于服务网格 Istio 的全面资源和深入解读。涵盖了从入门到高级使用的各种主题，包括服务发现、负载均衡、流量管理、策略执行和可观测性。无论你是初学者还是资深用户，都能在这里找到有价值的内容。通过教程、指南和最佳实践，你将能够更好地理解和应用 Istio，提升你的微服务架构的可靠性和可管理性。
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-traffic-interception/">Istio Ambient 模式中的透明流量拦截过程详解</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/11/18</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中的透明流量拦截过程详解', '本文是关于 Istio Ambient 模式的系列文章的第一篇，介绍了如何通过透明流量拦截实现无需 Sidecar 的服务网格。详细分析了 Istio CNI Node Agent、ztunnel 以及 Pod 网络命名空间的交互过程。', '\n这是我关于 Istio ambient 模式系列文章的第一篇。在接下来的几篇中，我将深入探讨 ambient 模式的关键组件及其工作原理，包括 ztunnel 如何将流量转发到 waypoint proxy，waypoint proxy 如何处理流量，以及通过 bookinfo 示例完整理解流量路径的操作。由于流量拦截是服务网格的基础功能，因此我选择从它开始，为大家提供扎实的理解基础。\n\nIstio ambient 模式是一种无需在每个 pod 中注入 sidecar 的服务网格实现方式。它通过在 pod 的网络命名空间内配置透明流量拦截和重定向，使应用程序无需修改即可享受服务网格的功能。以下内容将详细解析透明流量拦截的实现过程，涉及组件如 **Istio CNI Node Agent**、**ztunnel**、**网络命名空间** 和 **iptables 规则**，并通过流程图和示意图进行说明。\n\n## 背景知识\n\n### Linux 网络命名空间\n\n**网络命名空间（Network Namespace）** 是 Linux 内核的功能，用于隔离不同进程的网络环境。每个网络命名空间都有独立的网络设备、IP 地址、路由表和 iptables 规则。容器技术（如 Docker、Kubernetes）利用网络命名空间为每个容器（或 pod）提供独立的网络栈。\n\n### Istio CNI Node Agent\n\n**Istio CNI Node Agent** 是 ambient 模式中的核心组件之一，负责在 Kubernetes 节点上检测加入 ambient 网格的 pod，并为这些 pod 配置流量重定向规则。需要注意的是，这里使用的是 Istio CNI Node Agent，而非传统的 Istio CNI 插件。Node Agent 是一个守护进程，与 ztunnel 协同工作，而不是直接参与网络插件的工作。\n\n### ztunnel\n\n**ztunnel** 是 ambient 模式中的重要组件，以 DaemonSet 的形式运行在每个节点上，负责：\n\n- 接收并处理被重定向的流量；\n- 实现 L4 层的策略，如 mTLS 加密和访问控制；\n- 与控制平面通信以获取配置和证书。\n\n### HBONE（基于 HTTP 的隧道协议）\n\n**HBONE（HTTP-Based Overlay Network Encapsulation）** 是 Istio 引入的协议，用于在 ztunnel 和 waypoint proxy 之间传输任意 TCP 流量。HBONE 利用 HTTP\/2 和 HTTP\/3 的多路复用及加密特性，提高通信效率和安全性。\n\n## 流量拦截过程详解\n\n在 ambient 模式下，应用程序 pod 无需修改代码，也不需要注入 sidecar。流量拦截和重定向的主要过程发生在 **pod 的网络命名空间** 内部，这种方式避免了与底层 CNI 的冲突。以下是其步骤概览：\n\n\u0060\u0060\u0060mermaid \u0022Istio ambient 模式的流量拦截过程\u0022\nsequenceDiagram\n    participant Kubelet\n    participant NodeAgent as Istio CNI Node Agent\n    participant PodNetns as pod 网络命名空间\n    participant ztunnel\n    participant Pod as 应用程序 pod\n\n    Kubelet-\u003e\u003eNodeAgent: 通知新 pod 加入 ambient 网格\n    NodeAgent-\u003e\u003ePodNetns: 配置 iptables 规则\n    NodeAgent-\u003e\u003eztunnel: 传递 pod 网络命名空间 FD\n    ztunnel-\u003e\u003ePodNetns: 在 pod 网络命名空间内启动监听套接字\n    Pod-\u003e\u003ePodNetns: 应用程序发出流量\n    PodNetns-\u003e\u003eztunnel: 流量被重定向到 ztunnel\n    ztunnel-\u003e\u003e目标服务: 通过隧道转发流量\n    目标服务--\u003e\u003eztunnel: 返回响应\n    ztunnel--\u003e\u003ePod: 响应流量传递回应用程序\n\u0060\u0060\u0060\n\n![Istio ambient 模式的流量拦截过程](7b94ccedcde4f27f06d158187d7904e2.svg)\n\n### 流量拦截详细步骤\n\n1. **pod 启动与网络配置**：\n   - Kubernetes 创建 pod 时，通过 Container Runtime Interface（CRI）调用底层 CNI 插件（如 Calico、Cilium）为 pod 配置网络。\n   - 此时，pod 的网络命名空间（netns）已经建立。\n2. **Istio CNI Node Agent 配置流量重定向**：\n   - Istio CNI Node Agent 监测到新 pod 被标记为 ambient 模式（通过标签 \u0060istio.io\/dataplane-mode=ambient\u0060）。\n   - 进入 pod 的网络命名空间，设置 iptables 规则以拦截流量。\n   - 将网络命名空间的文件描述符（FD）传递给 ztunnel。\n3. **ztunnel 在 pod 网络命名空间中启动监听套接字**：\n   - ztunnel 接收到网络命名空间的 FD，在其中启动监听套接字以处理重定向的流量。\n4. **透明流量拦截与处理**：\n   - 应用程序发出的流量被 pod 内的 iptables 规则拦截，并透明地重定向到 ztunnel。\n   - ztunnel 对流量执行策略检查、加密等处理后转发到目标服务。\n   - 返回的响应流量通过 ztunnel 解密并返回给应用程序。\n\n想了解更多关于 Istio CNI 处理 iptables 的细节请见我的另一篇博客 [Istio ambient 模式中的 iptables 规则解析](\/blog\/istio-ambient-pod-iptables\/)。\n\n## ztunnel 日志分析\n\n你可以通过下面的命令查看所有 ztunnel 日志中有关流量拦截的记录，可以帮助你理解 ztunnel 的运行原理：\n\n\u0060\u0060\u0060bash\nkubectl -n istio-system logs -l app=ztunnel | grep -E \u0022inbound|outbound\u0022\n\u0060\u0060\u0060\n\n你将看到例如下面的输出，注意里面的 \u0060inbound\u0060 和 \u0060outbound\u0060 是相对于 ztunnel 而言的。\n\n**入站流量示例**\n\n\u0060\u0060\u0060text\n2024-11-16T10:33:01.410751Z\tinfo\taccess\tconnection complete\tsrc.addr=10.28.2.19:58000 src.workload=\u0022bookinfo-gateway-istio-64fc6d75d6-s442s\u0022 src.namespace=\u0022default\u0022 src.identity=\u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-gateway-istio\u0022 dst.addr=10.28.2.18:15008 dst.hbone_addr=10.28.2.18:9080 dst.service=\u0022productpage.default.svc.cluster.local\u0022 dst.workload=\u0022productpage-v1-57ffb6658c-tgbjs\u0022 dst.namespace=\u0022default\u0022 dst.identity=\u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022 direction=\u0022inbound\u0022 bytes_sent=9603 bytes_recv=2052 duration=\u00222110ms\u0022\n\u0060\u0060\u0060\n\n该日志描述了从 \u0060bookinfo-gateway-istio\u0060 到 \u0060productpage\u0060 的入站流量。流量经过 ztunnel 的 15008 端口，使用了 HBONE 隧道加密，身份通过 SPIFFE 确认。\n\n**出站流量示例**\n\n\u0060\u0060\u0060text\n2024-11-16T10:32:59.360677Z\tinfo\taccess\tconnection complete\tsrc.addr=10.28.2.18:51960 src.workload=\u0022productpage-v1-57ffb6658c-tgbjs\u0022 src.namespace=\u0022default\u0022 src.identity=\u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022 dst.addr=10.28.2.14:15008 dst.hbone_addr=34.118.226.6:9080 dst.service=\u0022details.default.svc.cluster.local\u0022 dst.workload=\u0022waypoint-7594b5b786-vgjwz\u0022 dst.namespace=\u0022default\u0022 dst.identity=\u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/waypoint\u0022 direction=\u0022outbound\u0022 bytes_sent=794 bytes_recv=414 duration=\u002240ms\u0022\n\u0060\u0060\u0060\n\n此日志描述了 \u0060productpage\u0060 pod 访问 \u0060details\u0060 服务时的出站流量。流量由 ztunnel 使用 HBONE 隧道转发到 waypoint pod（\u006015008\u0060 端口）。\n\n## 总结\n\nIstio ambient 模式通过 Istio CNI Node Agent 和 ztunnel 的协作，实现了无需 sidecar 的透明流量拦截。其关键特性包括：\n\n- **兼容性强**：避免与底层 CNI 冲突。\n- **简化运维**：无需修改应用程序代码，降低资源消耗。\n- **安全性高**：通过 HBONE 实现端到端的加密传输。\n\n后续文章中，我将进一步探讨 Istio ambient 模式的高级功能，包括 L7 流量路径分析和网络拓扑构建过程，敬请期待。\n\n## 参考\n\n- [Maturing Istio Ambient: Compatibility Across Various Kubernetes Providers and CNIs](https:\/\/istio.io\/latest\/blog\/2024\/inpod-traffic-redirection-ambient\/)\n- [Istio Ambient Mesh 介绍](https:\/\/istio.io\/latest\/blog\/2022\/introducing-ambient-mesh\/)\n- [Kubernetes 官方文档：网络插件](https:\/\/kubernetes.io\/docs\/concepts\/extend-kubernetes\/compute-storage-net\/network-plugins\/)\n- [HBONE](https:\/\/istio.io\/latest\/docs\/ambient\/architecture\/hbone\/)\n- [ztunnel traffic redirection](https:\/\/istio.io\/latest\/docs\/ambient\/architecture\/traffic-redirection\/)\n', '\/blog\/istio-ambient-traffic-interception\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文是关于 Istio Ambient 模式的系列文章的第一篇，介绍了如何通过透明流量拦截实现无需 Sidecar 的服务网格。详细分析了 Istio CNI Node Agent、ztunnel 以及 Pod 网络命名空间的交互过程。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-inpod-iptables/">Istio Ambient 模式中的 Pod 内 iptables 规则注入解析</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/11/18</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中的 Pod 内 iptables 规则注入解析', '深入解析 Istio ambient 模式下 pod 内部的 iptables 规则如何实现透明流量拦截和控制。', '\n在 [上一篇博客](\/blog\/istio-ambient-traffic-interception\/) 中，我概述了 Istio ambient 模式中 pod 网络命名空间内注入的 iptables 规则。本文将深入解析这些规则，探讨它们是如何在 pod 内实现透明流量拦截和重定向的。\n\n## Pod 内的 iptables 规则\n\n在 pod 的网络命名空间内，Istio CNI node agent 会设置一系列 iptables 规则，以实现流量的透明拦截与重定向。下面的规则展示了 Istio 在 mangle 和 nat 表中注入的内容，确保入站和出站流量经过适当的处理。\n\n\u0060\u0060\u0060python\n# Generated by iptables-save v1.8.9 (nf_tables) on Thu Nov 14 08:43:17 2024\n*mangle\n:PREROUTING ACCEPT [99138:22880045]  # mangle 表中的 PREROUTING 链，默认策略为 ACCEPT。\n:INPUT ACCEPT [0:0]  # mangle 表中的 INPUT 链，默认策略为 ACCEPT。\n:FORWARD ACCEPT [0:0]  # mangle 表中的 FORWARD 链，默认策略为 ACCEPT。\n:OUTPUT ACCEPT [100900:34940164]  # mangle 表中的 OUTPUT 链，默认策略为 ACCEPT。\n:POSTROUTING ACCEPT [0:0]  # mangle 表中的 POSTROUTING 链，默认策略为 ACCEPT。\n:ISTIO_OUTPUT - [0:0]  # 自定义的 ISTIO_OUTPUT 链，用于处理 Istio 的出站流量。\n:ISTIO_PRERT - [0:0]  # 自定义的 ISTIO_PRERT 链，用于处理 Istio 的预路由流量。\n-A PREROUTING -j ISTIO_PRERT  # 将所有 PREROUTING 流量跳转到 ISTIO_PRERT 链。\n-A OUTPUT -j ISTIO_OUTPUT  # 将所有 OUTPUT 流量跳转到 ISTIO_OUTPUT 链。\n-A ISTIO_OUTPUT -m connmark --mark 0x111\/0xfff -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff\n# 如果连接标记为 0x111\/0xfff，则恢复连接标记，用于连接追踪的一致性。\n\n-A ISTIO_PRERT -m mark --mark 0x539\/0xfff -j CONNMARK --set-xmark 0x111\/0xfff\n# 如果数据包标记为 0x539\/0xfff，在 PREROUTING 链中将其连接标记设置为 0x111\/0xfff。\n\nCOMMIT  # 应用 mangle 表规则。\n# Completed on Thu Nov 14 08:43:17 2024\n\n# Generated by iptables-save v1.8.9 (nf_tables) on Thu Nov 14 08:43:17 2024\n*nat\n:PREROUTING ACCEPT [2:120]  # nat 表中的 PREROUTING 链，默认策略为 ACCEPT。\n:INPUT ACCEPT [0:0]  # nat 表中的 INPUT 链，默认策略为 ACCEPT。\n:OUTPUT ACCEPT [119:9344]  # nat 表中的 OUTPUT 链，默认策略为 ACCEPT。\n:POSTROUTING ACCEPT [0:0]  # nat 表中的 POSTROUTING 链，默认策略为 ACCEPT。\n:ISTIO_OUTPUT - [0:0]  # 自定义的 ISTIO_OUTPUT 链，用于处理 Istio 的出站 NAT 流量。\n:ISTIO_PRERT - [0:0]  # 自定义的 ISTIO_PRERT 链，用于处理 Istio 的预路由 NAT 流量。\n-A PREROUTING -j ISTIO_PRERT  # 将所有 PREROUTING 流量跳转到 ISTIO_PRERT 链。\n-A OUTPUT -j ISTIO_OUTPUT  # 将所有 OUTPUT 流量跳转到 ISTIO_OUTPUT 链。\n-A ISTIO_OUTPUT -d 169.254.7.127\/32 -p tcp -m tcp -j ACCEPT\n# 如果目标地址为 169.254.7.127（可能是 Istio 内部地址），允许 TCP 流量通过。\n\n-A ISTIO_OUTPUT -p tcp -m mark --mark 0x111\/0xfff -j ACCEPT\n# 如果数据包标记为 0x111\/0xfff，允许 TCP 流量通过。\n\n-A ISTIO_OUTPUT ! -d 127.0.0.1\/32 -o lo -j ACCEPT\n# 允许发往本地回环接口（但不包括 127.0.0.1）的流量通过。\n\n-A ISTIO_OUTPUT ! -d 127.0.0.1\/32 -p tcp -m mark ! --mark 0x539\/0xfff -j REDIRECT --to-ports 15001\n# 将发往非 127.0.0.1 的出站 TCP 流量（且标记不是 0x539\/0xfff）重定向到端口 15001（Istio 出站流量入口）。\n\n-A ISTIO_PRERT -s 169.254.7.127\/32 -p tcp -m tcp -j ACCEPT\n# 如果源地址为 169.254.7.127，允许 TCP 流量通过 PREROUTING 链。\n\n-A ISTIO_PRERT ! -d 127.0.0.1\/32 -p tcp -m tcp ! --dport 15008 -m mark ! --mark 0x539\/0xfff -j REDIRECT --to-ports 15006\n# 将非 127.0.0.1 且目标端口不是 15008 的入站 TCP 流量（标记不是 0x539\/0xfff）重定向到端口 15006（Istio 入站流量入口）。\n\nCOMMIT  # 应用 nat 表规则。\n# Completed on Thu Nov 14 08:43:17 2024\n\u0060\u0060\u0060\n\n### 端口号的作用\n\n这些 iptables 规则通过特定的端口号来区分并处理不同类型的流量：\n\n- **15008 (HBONE socket)**：用于透明代理基于 HTTP 的流量，支持 HBONE 协议的透明传输。\n- **15006 (plaintext socket)**：用于处理未加密的网格内部流量，以实现 pod 之间的流量管理。\n- **15001 (outbound socket)**：用于管理出站流量，实现对外部服务访问的策略控制。\n\n这些端口使得 Istio 能够对入站、出站及内部流量进行透明的管理与控制，从而实现细粒度的安全策略与流量控制。更多关于端口号的使用请参考 [Istio 应用要求](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/application-requirements\/)。\n\n### 标记 \u00600x539\u0060 的作用\n\n\u00600x539\u0060 是用于标识 Istio 代理发出的流量的标记。这一标记在流量进入 iptables 规则时被设置，用于区分由代理（如 ztunnel）处理过的数据包，防止其被重复代理或误处理。\n\n### 标记 \u00600x111\u0060 的作用\n\n\u00600x111\u0060 用于连接级别的标记管理，在 Istio 网格中标识已由代理处理过的整个连接。通过 iptables 的 \u0060CONNMARK\u0060 模块，\u00600x111\u0060 标记能够从单个数据包扩展到整个连接的生命周期，从而加速后续数据包的匹配。\n\n## iptables 规则可视化\n\n下图展示了流量在 iptables 规则中的执行路径，帮助理解流量的匹配和重定向过程：\n\n\u0060\u0060\u0060mermaid \u0022Istio ambient pod 内 iptables 可视化\u0022\ngraph TD\nA[流量进入 Pod 网络命名空间] --\u003e B{流量方向}\nB -- 入站流量 --\u003e C[PREROUTING 链]\nC --\u003e D[跳转到 ISTIO_PRERT 链]\nD --\u003e E{源地址是 169.254.7.127\/32 吗?}\nE -- 是 --\u003e F[ACCEPT]\nE -- 否 --\u003e G{目的地址是 127.0.0.1\/32 吗?}\nG -- 是 --\u003e F[ACCEPT]\nG -- 否 --\u003e H{目的端口是 15008 吗?}\nH -- 是 --\u003e F[ACCEPT]\nH -- 否 --\u003e I{数据包是否标记为 0x539?}\nI -- 是 --\u003e F[ACCEPT]\nI -- 否 --\u003e J[REDIRECT 到 15006 端口]\nB -- 出站流量 --\u003e K[OUTPUT 链]\nK --\u003e L[跳转到 ISTIO_OUTPUT 链]\nL --\u003e M{目的地址是 169.254.7.127\/32 吗?}\nM -- 是 --\u003e N[ACCEPT]\nM -- 否 --\u003e O{数据包是否标记为 0x111?}\nO -- 是 --\u003e N[ACCEPT]\nO -- 否 --\u003e P{目的地址是 127.0.0.1\/32，且输出接口是 lo 吗?}\nP -- 是 --\u003e N[ACCEPT]\nP -- 否 --\u003e Q{数据包是否标记为 0x539?}\nQ -- 是 --\u003e N[ACCEPT]\nQ -- 否 --\u003e R[REDIRECT 到 15001 端口]\n\u0060\u0060\u0060\n\n![Istio ambient pod 内 iptables 可视化](b99dc3a72ccab48d71e6c502b1089d2d.svg)\n\n想进一步了解 Istio CNI 如何处理 iptables，请参考代码 [istio\/cni\/pkg\/iptables\/iptables.go at master · istio\/istio · GitHub](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/iptables\/iptables.go)。\n\n## 流量的路由可视化\n\n下面是以跨节点的 L4 加密流量路径的可视化图示：\n\n![跨节点的加密流量（L4）](ambient-traffic-on-the-different-node-l4.svg)\n\n\n1. **应用程序发出请求**：流量从应用程序进程发送，进入 Pod 的网络命名空间。\n2. **iptables 规则匹配**：\n   - **出站流量**在 \u0060OUTPUT\u0060 链中被匹配，符合条件的流量被重定向到 \u0060ISTIO_OUTPUT\u0060 链。\n   - 在 \u0060ISTIO_OUTPUT\u0060 链中，流量被标记并被接受。\n3. **REDIRECT 重定向**：流量被 iptables 捕获并重定向到 ztunnel 监听端口（明文流量为 15006，加密流量为 15008）。\n4. **ztunnel 处理流量**：ztunnel 接收到流量，进行策略检查和加密等操作。\n5. **流量转发到目标服务**：ztunnel 将处理后的流量通过 HBONE 隧道发送到目标服务所在节点的 ztunnel，然后解密发送到目标服务。\n\n关于对同节点、跨节点、L4、L7 层级的流量路由以及防止流量逃逸的详情请参考博客 [超越 Sidecar：深入解析 Istio Ambient Mode 的流量机制与成本效益](\/blog\/beyond-sidecar\/)。\n\n## 总结\n\n通过解析 Istio ambient 模式下的 iptables 规则，我们可以看到，Istio 通过 CNI 插件在 pod 内设置了一系列透明的流量拦截规则。这些规则确保了流量在进出 pod 时能够按预期被 ztunnel 代理处理，从而实现更细粒度的流量管理和安全策略应用。未来我们将继续探索更多关于 Istio ambient 模式下的网络细节，敬请关注。', '\/blog\/istio-ambient-inpod-iptables\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入解析 Istio ambient 模式下 pod 内部的 iptables 规则如何实现透明流量拦截和控制。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/migrating-from-aws-app-mesh-to-istio-a-comprehensive-guide/">从 AWS App Mesh 迁移到 Istio 全面指南</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/30</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('从 AWS App Mesh 迁移到 Istio 全面指南', '从 AWS App Mesh 迁移到 Istio 的指南，聚焦云原生、Kubernetes 友好的解决方案，探讨差异、高级特性及 Tetrate Istio 迁移工具，实现便捷高效的转移。', '\n随着 [AWS 宣布将在 2026 年 9 月 30 日停用 AWS App Mesh](https:\/\/aws.amazon.com\/cn\/blogs\/containers\/migrating-from-aws-app-mesh-to-amazon-ecs-service-connect\/)，许多企业正在评估继续使用服务网格的替代方案。如果您也在寻找替代方案，Istio 将是一个强大且功能丰富的选项，尤其适合 Kubernetes 原生环境。在本文中，我将介绍从 AWS App Mesh 迁移到 Istio 的过程，对比这两种服务网格，并介绍我们开发的 Tetrate Istio 迁移工具，帮助简化这一迁移过程。\n\n## App Mesh vs Istio：迁移准备\n\n由于 AWS App Mesh 即将停用，了解 App Mesh 和 Istio 之间的相似性和差异对于成功迁移至关重要。以下是一些关键比较点，帮助您将当前的基础设施与 Istio 提供的功能对齐：\n\n1. **全面的功能**：App Mesh 和 Istio 都提供流量管理、可观测性和安全功能，但 Istio 提供了更多可自定义的选项，包括高级流量路由和增强的遥测。\n2. **云无关性**：与紧密集成 AWS 的 App Mesh 不同，Istio 是云无关的，可在多云或混合环境中提供更大的灵活性。\n3. **高级安全**：Istio 默认支持 mTLS，与 App Mesh 相比，提供了更广泛的安全功能和策略。\n\nAWS 建议 ECS 客户迁移到 [Service Connect](https:\/\/docs.aws.amazon.com\/AmazonECS\/latest\/developerguide\/service-connect.html) 而 EKS 客户迁移到 [VPC Lattice](https:\/\/aws.amazon.com\/vpc\/lattice\/)。对于一个功能丰富的开源解决方案，Istio 是一个很有吸引力的选择。接下来，让我们深入了解从 AWS App Mesh 迁移到 Istio 的过程，并使用 Tetrate 的迁移工具进行支持。\n\n## 比较 App Mesh、Service Connect、VPC Lattice 和 Istio\n\n在开始迁移之前，了解 AWS App Mesh、Service Connect、VPC Lattice 和 Istio 之间的关键区别非常重要：\n\n| **功能**                 | **App Mesh**                                                   | **Service Connect**                                          | **VPC Lattice**                                              | **Istio**                                                    |\n| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| **网络可靠性**          | 使用 [Envoy](https:\/\/envoyproxy.io\/) 作为 Sidecar 代理，进行异常检测、健康检查和重试，支持精细调整。 | 使用 Envoy 作为 Sidecar 代理，仅支持超时调整。              | 内置健康检查和重试，由 AWS 管理的可靠性，不需要 Sidecar 代理。 | 支持 Sidecar 和 Ambient 模式，使用 Envoy 并完全支持精细化调整。 |\n| **高级流量路由**        | 支持高级流量路由，如 A\/B 测试和金丝雀发布。                 | 不支持高级流量路由。                                         | 支持基本的流量路由和负载均衡。                               | 支持包括 A\/B 测试和金丝雀发布在内的高级流量控制。             |\n| **可观测性**            | 需要手动收集和监控指标。                                     | 自动将指标发送到 Amazon CloudWatch。                         | 集成 AWS CloudWatch 和 X-Ray 监控。                          | 开箱即用的可观测性，支持 Prometheus、Grafana 和 Jaeger。      |\n| **服务发现**            | 集成 AWS Cloud Map。                                          | 使用 AWS Cloud Map。                                         | 使用 AWS 服务发现机制。                                      | 使用 Kubernetes 原生的服务发现机制。                         |\n| **安全性**              | 支持与 AWS PCA 的 TLS 和双向 TLS（mTLS）。                    | 支持 TLS，不支持 mTLS。                                       | 支持 mTLS。                                                  | 支持 mTLS 和细粒度的安全策略。                               |\n| **资源共享**            | 可以跨多个 AWS 账户共享网格。                                 | 不支持跨账户共享命名空间。                                   | 可以跨多个 AWS 账户共享资源。                                | 可以跨多个集群和云部署。                                     |\n\n## 介绍 Tetrate 的 Istio 迁移工具\n\n为了使迁移过程更加顺利，Tetrate 开发了一个 Istio 迁移工具包，目前处于私有状态，但可供内部或经过批准的客户通过 [此表单](https:\/\/resources.tetrate.dev\/app-mesh-istio?__hstc=218802950.edcf2542a8010c44aa57b98adaef028a.1721092227167.1729818643207.1730268606576.91\u0026__hssc=218802950.2.1730268606576\u0026__hsfp=872206273) 申请使用。该工具包帮助自动转换 AWS App Mesh 配置为 Istio 的等效配置，包括 Virtual Nodes、Virtual Routers 和其他网络结构。\n\n**关键考量**\n\n- **服务发现**：App Mesh 和 Istio 的服务发现方式不同。Istio 依赖 Kubernetes 原生的服务发现，而 App Mesh 则集成 AWS Cloud Map。迁移过程中，需相应调整服务定义。\n- **安全性**：Istio 原生支持服务之间的 mTLS。虽然 AWS App Mesh 也支持 mTLS，但迁移至 Istio 需要配置 CA（证书颁发机构）并更新证书以适应 Istio 的安全模型。\n- **流量管理**：Istio 的 Virtual Services 和 Destination Rules 提供了比 App Mesh 的 Virtual Routers 和 Nodes 更高级的流量路由能力。迁移过程中，需额外配置以建立类似的路由行为。\n\n## 使用 Tetrate 迁移工具逐步完成迁移\n\n下面是使用此工具的有效步骤：\n\n### 前提条件\n\n开始迁移之前，确保已安装以下工具：\n\n- [Go](https:\/\/golang.org\/doc\/install)\n- [kubectl](https:\/\/kubernetes.io\/docs\/tasks\/tools\/#kubectl)\n- [istioctl](https:\/\/istio.io\/latest\/docs\/setup\/getting-started\/#download)\n\n确保在 EKS 集群上正确安装和配置 AWS App Mesh。您还需要一个名为 tetrate-tis-creds 的 Kubernetes secret，用于 Istio 安装，详见工具文档。\n\n该工具还提供预检查命令，以识别迁移前的任何潜在阻碍因素。\n\n### 运行预检查\n\n为确保设置准备就绪，运行以下命令：\n\n\u0060\u0060\u0060bash\ntim precheck\n\u0060\u0060\u0060\n\n此命令将扫描 App Mesh 环境，标出任何需要调整的项，以确保成功迁移。\n\n### 迁移过程\n\n1. **安装 Istio**\n\n   使用 Istio 迁移工具包生成 IstioOperator 配置并安装 Istio：\n\n   \u0060\u0060\u0060bash\n   tim generate iop | istioctl install –skip-confirmation -f –\n   \u0060\u0060\u0060\n\n2. **应用 Istio 网络规则**\n\n   接下来，生成并应用 Istio 网络规则：\n\n   \u0060\u0060\u0060bash\n   tim generate networking | kubectl apply -f –\n   \u0060\u0060\u0060\n\n3. **移除 AWS App Mesh 标签**\n\n   从命名空间中移除现有的 App Mesh 标签。例如，对于 default 命名空间：\n\n   \u0060\u0060\u0060bash\n   kubectl label namespace default \u0022appmesh.k8s.aws\/sidecarInjectorWebhook-\u0022\n   \u0060\u0060\u0060\n\n4. **启用 Istio Sidecar 注入**\n\n   添加标签以启用 Istio 的自动 Sidecar 注入：\n\n   \u0060\u0060\u0060bash\n   kubectl label namespace default istio-injection=enabled\n   \u0060\u0060\u0060\n\n5. **重启部署**\n\n   为应用更改并启动新的 Envoy Sidecar 注入，重启部署：\n\n   \u0060\u0060\u0060bash\n   kubectl rollout restart deployment \u003cdeployment-name\u003e -n \u003cdeployment-namespace\u003e\n   \u0060\u0060\u0060\n\n### 迁移策略\n\n从 AWS App Mesh 迁移到 Istio 时，可以使用如原地迁移、金丝雀发布、蓝绿部署等策略，这些策略与迁移到 VPC Lattice 的策略相似。合适的策略取决于应用需求，如是否需要零停机或安排维护窗口。\n\n1. **原地迁移**：用配置为 Istio 的新 Pods 替换当前 App Mesh 的 Kubernetes Pods，适合可容忍迁移过程中的停机的应用。\n2. **蓝绿部署**：在新命名空间中配置为 Istio 的应用副本，而原始部署继续运行 App Mesh，无停机地逐步将流量从 App Mesh 迁移到 Istio。\n3. **金丝雀发布**：与 App Mesh 并行部署 Istio，逐步将少量流量转移到 Istio，监控性能和稳定性，逐步增加流量。\n\n4. **分阶段迁移**：逐步迁移组件或服务，而非一次性迁移，以减少风险并帮助识别潜在问题。\n5. **测试和验证**：在完全切换前，进行全面测试，验证服务功能、安全性和性能指标符合或超出预期。\n\n## 结论\n\n从 AWS App Mesh 迁移到 Istio 可以解锁流量管理、可观测性和安全方面的新功能。Tetrate 的 Istio 迁移工具简化了过程，提供了分步骤方法，减少手动配置，确保平稳过渡。\n\n如果您有兴趣试用 Tetrate 的 Istio 迁移工具，欢迎联系我们——该工具目前可私密使用，我们将很乐意讨论访问权限。\n\n此次迁移不仅是采用新的服务网格，更是一个充分利用 Istio 全面功能、支持多云部署、增强基础设施弹性的机会。\n\n*本文最初发表于 [tetrate.io](https:\/\/tetrate.io\/blog\/migrating-from-aws-app-mesh-to-istio-a-comprehensive-guide\/)。*', '\/blog\/migrating-from-aws-app-mesh-to-istio-a-comprehensive-guide\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">从 AWS App Mesh 迁移到 Istio 的指南，聚焦云原生、Kubernetes 友好的解决方案，探讨差异、高级特性及 Tetrate Istio 迁移工具，实现便捷高效的转移。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/multi-cluster-pki-istio-recipe/">多集群 PKI 与 Istio 实践：为服务网格构建可信且可扩展的 PKI</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('多集群 PKI 与 Istio 实践：为服务网格构建可信且可扩展的 PKI', '本文详细介绍了如何使用 EJBCA 和 cert-manager 在多集群 Istio 服务网格中实现可信且可扩展的 PKI 解决方案，包括环境设置、证书管理和自动续期等关键步骤。', '\n作者：Cristofer TenEyck（Keyfactor 高级解决方案工程师）和 Jimmy Song（Tetrate 布道师）\n\n## 引言\n\n在云原生应用程序不断发展的背景下，确保跨多个集群的服务网格安全对于保证安全性和合规性至关重要。Istio 作为领先的开源服务网格，提供了用于保护微服务之间通信的工具。然而，在此环境中实施一个强大且可扩展的公钥基础设施（PKI）来管理证书仍然是一个重大挑战。\n\n在本文中，我们将深入探讨使用 EJBCA 开源 PKI 为跨多个集群的 Istio 服务网格实现 PKI 解决方案。我们将重点介绍设置 EJBCA、配置 cert-manager 的 EJBCA 外部签发器，以及确保 Istio 工作负载的证书自动续期的过程。本指南将帮助你构建可信且可扩展的 PKI，实现安全、合规且具有弹性的服务网格。\n\n为什么选择多集群？随着组织扩大其 Kubernetes 基础设施，多集群部署正变得越来越流行。多集群 Istio 设置提供了增强的可用性、容错性以及跨集群的工作负载隔离。\n\n## 理解 PKI 及其在服务网格中的作用\n\nPKI 是现代数字安全的基石。它涉及管理密钥和证书，以确保用户、应用程序或服务等实体之间的安全通信。在像 Istio 这样的服务网格中，有效的 PKI 对于保护微服务之间的通信，尤其是在多集群环境中，至关重要。\n\nEJBCA 提供了一个用于大规模管理 PKI 的开源解决方案。与 OpenSSL 或 Istio 内置的 PKI 等其他选项相比，EJBCA 提供了一个功能齐全、企业级的 PKI，适用于从简单到更复杂和多用途的部署。EJBCA 的能力超越了仅仅签发 mTLS 证书，提供了合规性特性、安全的可扩展性、密码灵活性，以及与广泛的应用程序集成。\n\n## Istio、EJBCA 和 cert-manager\n\n使用 EJBCA 为多集群 Istio 环境设置 PKI。以下是包含的内容：\n\n1. **环境准备**：我们使用了由主集群和远程集群组成的 MicroK8s 多集群 Istio 设置。两个集群都配置为使用 EJBCA 作为根证书颁发机构（CA）。\n2. **cert-manager 集成**：我们展示了 cert-manager 与 EJBCA 的集成，包括 EJBCA 自定义签发器的配置。cert-manager 将处理证书的签发和续期。\n3. **自动证书续期**：PKI 管理中的一个关键挑战是确保证书在到期前自动续期。cert-manager 与 EJBCA 一起，可以在所有集群中实现无缝、对应用程序透明的证书续期。\n\n![架构图](arch.webp)\n\n## 使用 EJBCA 作为外部 CA 的 Istio 架构设置高级摘要\n\n本节概述了使用 EJBCA 作为外部证书颁发机构（CA）在 Kubernetes 集群上设置 Istio 的步骤。该设置涉及配置两个带有 MetalLB 用于负载均衡的 MicroK8s 集群，集成 EJBCA 进行证书管理，并使用 Helm 安装 Istio 组件。完整指南可在[此处](https:\/\/docs.keyfactor.com\/ejbca\/latest\/tutorial-deploy-istio-service-mesh-in-a-multi)找到。\n\n关键步骤包括：\n\n1. **安装和配置 Helm 仓库**：为 Istio、cert-manager 和 EJBCA 添加必要的 Helm 仓库。\n2. **部署 cert-manager 和 EJBCA**：在主集群和远程集群中使用 Helm 安装 cert-manager，然后部署带有自定义签发器的 EJBCA。此步骤还包括生成并将必要的证书存储为 Kubernetes 密钥。\n3. **使用 EJBCA 配置 Istio**：在 Kubernetes 中创建一个指向 EJBCA 实例的自定义签发器用于签发证书。然后将此签发器集成到 Istio 配置中。\n4. **安装 Istio 组件**：部署 cert-manager-istio-csr 以处理 Istio 的证书签名请求，然后安装 Istio 的基础组件、Istio CNI（容器网络接口）、Istiod（Istio 控制平面）和 Istio 入口网关。\n5. **自定义和覆盖**：应用自定义值以定制 Istio 的行为，例如特定的集群 ID、信任域和用于服务间安全通信的 DNS 配置。\n6. **自动证书续期**：设置配置为 cert-manager 在证书到期前自动续期，而不会对正在运行的应用程序造成中断。\n\n![证书更新流程图](cert-renew-flow.webp)\n\n上图是表示 Istio 中 mTLS 证书签发和续期流程的流程图。它展示了从 Istiod 控制平面推送 Envoy 配置到 EJBCA 最终签发证书的流程。\n\n## PKI 最佳实践和合规性\n\n为你的 Istio 服务网格构建安全的 PKI，不仅仅是设置任意 PKI 并开始签发证书。它需要遵循最佳实践并符合法规要求，以保持安全性和未来适用性。以下是一些需要考虑的关键点：\n\n1. **遵守法规**：确保你的 PKI 实施符合如欧盟网络弹性法案和美国提升国家网络安全的行政命令等法规要求。这包括实施弹性的架构，维护审计跟踪，并确保稳健的密钥管理实践。\n2. **密码灵活性和量子准备**：随着密码标准的发展，你的 PKI 必须具备足够的灵活性以适应新的算法和密钥长度。随着量子计算的潜在出现，具备量子准备性变得越来越重要。\n3. **与信息安全团队合作**：与你的信息安全（InfoSec）团队有效合作对于维护 PKI 的安全性和合规性至关重要。这包括定期审查安全策略、持续培训，以及确保 PKI 管理流程与组织的安全目标一致。\n\n## 结论\n\n在多集群环境中为 Istio 服务网格实施 PKI 看似艰巨，但使用正确的工具和实践，可以高效且有效地实现。EJBCA 结合 cert-manager，提供了一个用于大规模管理证书的解决方案，确保你的 Istio 服务网格 PKI 既安全又合规。\n\n通过遵循本指南中概述的步骤，你将能够建立一个可信的 PKI，实现无缝且强大的证书管理，并与你的信息安全团队有效合作，维护服务网格的安全性。\n\n有关本文中涵盖的主题的更多详细信息和进一步资源，请务必查看下面提供的链接和参考资料。\n\n## 资源\n\n- [教程——使用 EJBCA 作为外部 PKI 提供商在多集群 Kubernetes 环境中部署 Istio 服务网格](https:\/\/docs.keyfactor.com\/ejbca\/latest\/tutorial-deploy-istio-service-mesh-in-a-multi)\n- [Istio 文档](https:\/\/istio.io\/latest\/docs\/)\n- [EJBCA 社区版](https:\/\/www.ejbca.org\/)\n- [cert-manager 文档](https:\/\/cert-manager.io\/docs\/)\n- [欧盟网络弹性法案](https:\/\/digital-strategy.ec.europa.eu\/en\/policies\/cyber-resilience-act)\n- [美国网络安全行政命令](https:\/\/www.whitehouse.gov\/briefing-room\/statements-releases\/2021\/05\/12\/executive-order-on-improving-the-nations-cybersecurity\/)\n- [多集群 Istio 服务网格的跨集群无缝访问指南](\/blog\/seamless-cross-cluster-access-istio\/)\n\n---\n\n本文首发为英文版：[Multi-Cluster PKI \u002b Istio Recipe: Practical Example for a Trusted and Scalable PKI for Your Service Mesh](https:\/\/tetrate.io\/blog\/multi-cluster-pki-istio-recipe-practical-example-for-a-trusted-and-scalable-pki-for-your-service-mesh\/)\n', '\/blog\/multi-cluster-pki-istio-recipe\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细介绍了如何使用 EJBCA 和 cert-manager 在多集群 Istio 服务网格中实现可信且可扩展的 PKI 解决方案，包括环境设置、证书管理和自动续期等关键步骤。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-mesh-open-policy-agent-authorization/">[译] 在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/15</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tylerscha.de/articles/2024-09-22-opa-istio-ambient.html" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权', '本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。', '\n*这是关于在 Istio Ambient Mesh 中使用 Open Policy Agent (OPA) 的系列文章的第一篇。系列文章将涵盖如何使用 OPA 作为外部授权服务，建议的部署模式，以及提高可靠性和可扩展性的最佳架构。我们还将讨论使用 OPA 进行资源验证和控制 Istio 功能。*\n\n正如我在[之前的文章](https:\/\/tylerscha.de\/articles\/2024-08-29-five-things-i-like-lately.html)中提到的，我对 Istio Ambient Mesh 感到非常兴奋。这是服务网格的显著进步，我致力于帮助大家理解如何利用 Ambient 来实现目标。我认为目前关于 Ambient 的用例和教程内容还比较少，我希望能帮助填补这个空白。\n\n本文将介绍如何在 Istio Ambient Mesh 中设置 Open Policy Agent (OPA) 作为外部授权服务。授权是任何安全模型的重要组成部分，而 OPA 是实现细粒度访问控制策略的强大工具。通过将 OPA 用作外部授权服务，你可以强制执行比 Istio 内置授权策略更复杂的策略。\n\nOPA 具有插件模型，允许在基础策略引擎之上添加额外功能。虽然这是一个复杂的用例，但幸运的是，[OPA 社区已经创建并维护了](https:\/\/github.com\/open-policy-agent\/opa-envoy-plugin)实现 [Envoy 外部授权 API](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/ext_authz_filter) 的 OPA 引擎版本。因此，你无需编写任何自定义代码即可在 Istio Ambient Mesh 中使用 OPA 作为外部授权服务。\n\n#### 集群架构图\n\n![OPA 和 Istio Ambient](istio-ambient-opa-without-traffic.webp)\n\n在上图中，你可以看到我们集群中的资源架构。我们有三个命名空间：默认的 \u0060istio-system\u0060 命名空间（Istio 控制平面 istiod 和 ztunnel 代理运行的地方）、安装示例应用的 \u0060app\u0060 命名空间，以及 OPA 运行的 \u0060platform\u0060 命名空间。在这个例子中，我们将 OPA 部署为单个 Deployment。在后续文章中，我会介绍如何将 OPA 部署为 DaemonSet。\n\n#### 带有流量的集群架构图\n\n![OPA 和 Istio Ambient（带有流量）](istio-ambient-opa-with-traffic.webp)\n\n上图展示了与之前相同的集群，但此时有流量通过系统。在本教程中，我们将发送流量到 \u0060app\u0060 命名空间中的 Waypoint 代理，该代理会向 \u0060platform\u0060 命名空间中的 OPA 服务进行授权检查。OPA 服务根据定义的策略返回决策，允许或拒绝请求。如果请求被允许，Waypoint 代理会将请求转发到 \u0060app\u0060 命名空间中的目标服务，否则将返回 403 Forbidden 响应。\n\n### 集群安装与配置\n\n首先，让我们创建集群并使用 Ambient 模式安装 Istio，以及 Kubernetes Gateway API：\n\n\u0060\u0060\u0060bash\n# 创建集群\nkind create cluster --name istio-opa\n\n# 使用 Ambient 模式安装 Istio\nistioctl install --set profile=ambient --skip-confirmation\n\n# 安装 gateway-api CRD\nkubectl get crd gateways.gateway.networking.k8s.io \u0026\u003e \/dev\/null || \\\n    { kubectl apply -f https:\/\/github.com\/kubernetes-sigs\/gateway-api\/releases\/download\/v1.1.0\/standard-install.yaml; }\n\u0060\u0060\u0060\n\n接下来，创建 \u0060app\u0060 命名空间并安装 Istio 的 bookinfo 示例应用及 \u0060sleep\u0060 Pod，这将帮助我们进行集群内的测试：\n\n\u0060\u0060\u0060bash\n# 创建命名空间\nkubectl create namespace app\n\n# 安装 bookinfo 示例应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo-versions.yaml\n\n# 安装 sleep 应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/sleep\/sleep.yaml\n\u0060\u0060\u0060\n\n我们还需要创建 Waypoint 代理，作为集群入口网关，并为 \u0060app\u0060 命名空间配置 Ambient 模式：\n\n\u0060\u0060\u0060bash\n# 为 productpage 应用创建网关\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/gateway-api\/bookinfo-gateway.yaml\nistioctl waypoint apply -n app --enroll-namespace --wait\n\n# 为网关添加 ClusterIP 类型\nkubectl annotate gateway bookinfo-gateway networking.istio.io\/service-type=ClusterIP --namespace=app\n\n# 将命名空间标记为 Ambient 模式\nkubectl label namespace app istio.io\/dataplane-mode=ambient\n\u0060\u0060\u0060\n\n接下来，创建 \u0060platform\u0060 命名空间来运行 OPA 服务：\n\n\u0060\u0060\u0060bash\nkubectl create namespace platform\n\u0060\u0060\u0060\n\n### 部署 Open Policy Agent\n\n首先，部署 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: opa-istio\n  template:\n    metadata:\n      labels:\n        app: opa-istio\n    spec:\n      containers:\n      - name: opa-istio\n        image: openpolicyagent\/opa:0.68.0-istio-4-static\n        ports:\n        - containerPort: 9191\n        - containerPort: 8282\n        - containerPort: 8181\n        args:\n        - \u0022run\u0022\n        - \u0022--server\u0022\n        - \u0022--addr=0.0.0.0:8181\u0022\n        - \u0022--config-file=\/config\/config.yaml\u0022\n        - \u0022\/policy\/policy.rego\u0022\n        volumeMounts:\n        - name: opa-istio-config\n          mountPath: \/config\n        - name: opa-policy\n          mountPath: \/policy\nEOF\n\u0060\u0060\u0060\n\n接着，我们需要定义两个 ConfigMap 来配置 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-istio-config\n  namespace: platform\ndata:\n  config.yaml: |\n    plugins:\n      envoy_ext_authz_grpc:\n        addr: 0.0.0.0:9191\n        path: istio\/authz\/allow\n    decision_logs:\n      console: true\nEOF\n\u0060\u0060\u0060\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-policy\n  namespace: platform\ndata:\n  policy.rego: |\n    package istio.authz\n    import input.attributes.request.http as http_request\n    import input.parsed_path\n    default allow = false\n    allow { roles_for_user[r] required_roles[r] }\n    roles_for_user[r] { r := user_roles[user_name][_] }\n    required_roles[r] { perm := role_perms[r][_] perm.method = http_request.method perm.path = http_request.path }\n    user_name = parsed { [_, encoded] := split(http_request.headers.authorization, \u0022 \u0022) [parsed, _] := split(base64url.decode(encoded), \u0022:\u0022) }\n    user_roles = { \u0022alice\u0022: [\u0022guest\u0022], \u0022bob\u0022: [\u0022admin\u0022] }\n    role_perms = { \u0022guest\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, ], \u0022admin\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/api\/v1\/products\u0022 }, ], }\nEOF\n\u0060\u0060\u0060\n\n最后，为 OPA 创建服务并配置 Istio MeshConfig：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  ports:\n  - name: grpc\n    port: 9191\n    targetPort: 9191\n  selector:\n    app: opa-istio\nEOF\n\u0060\u0060\u0060\n\n编辑 Istio \u0060MeshConfig\u0060，将 OPA 注册为 \u0060extensionProvider\u0060：\n\n\u0060\u0060\u0060bash\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: istio\n  namespace: istio-system\ndata:\n  mesh: |-\n    extensionProviders:\n    - name: opa-ext-authz-grpc\n      envoyExtAuthzGrpc:\n        service: opa-istio.platform.svc.cluster.local\n        port: 9191\n\u0060\u0060\u0060\n\n### 测试\n\n通过 \u0060kubectl port-forward\u0060 命令，将 \u0060bookinfo-gateway\u0060 服务的端口转发到本地：\n\n\u0060\u0060\u0060bash\nkubectl port-forward -n app svc\/bookinfo-gateway-istio 8080:80\n\u0060\u0060\u0060\n\n然后，使用 Alice 和 Bob 用户发送请求，验证不同权限的访问控制：\n\n\u0060\u0060\u0060bash\ncurl --user alice:password -vik http:\/\/localhost\n\n:8080\/api\/v1\/products # 应返回 403\ncurl --user alice:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/api\/v1\/products # 应返回 JSON 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\n\u0060\u0060\u0060\n\n最后，应用 Istio 的 \u0060AuthorizationPolicy\u0060：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ext-authz\n  namespace: app\nspec:\n  action: CUSTOM\n  provider:\n    name: opa-ext-authz-grpc\n  rules:\n  - to:\n    - operation:\n        paths: [\u0022*\u0022]\nEOF\n\u0060\u0060\u0060\n\n通过上述步骤，你已经成功配置了 OPA 作为 Istio Ambient Mesh 中的外部授权服务。在后续文章中，我们将讨论 OPA 在 Waypoint 代理中的最佳实践。\n', '\/trans\/istio-ambient-mesh-open-policy-agent-authorization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-waypoint-proxy-deployment-model-explained/">[译] 解读 Istio Ambient Waypoint Proxy 部署模型</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://www.solo.io/blog/istio-ambient-waypoint-proxy-deployment-model-explained/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('解读 Istio Ambient Waypoint Proxy 部署模型', '本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。', '\n\u003e 译者注：Istio Ambient Waypoint Proxy 为服务网格的 L7 处理提供了灵活且高效的解决方案。通过了解不同的部署模式，团队可以根据自身需求选择最合适的架构，避免资源浪费和性能瓶颈。避免按节点部署 waypoint proxy，有助于降低故障域的影响，提升应用的稳定性和性能。正确地部署和配置 waypoint proxy，将有助于充分发挥 Istio Ambient 模式的优势，实现高效、安全的服务通信。\n\nAmbient 模式是 Istio 在 2022 年引入的新型无边车数据平面，并于今年 5 月达到 [Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 状态。Istio 社区正努力在下一个 Istio v1.24 版本中将 Ambient 推向 GA（一般可用）状态。Ambient 将 Istio 的功能分为两个独立的层：安全覆盖层和第 7 层处理层。在与许多试用 Ambient 的用户合作时，我想澄清关于 waypoint proxy 的一些常见问题和困惑。它是一个可选的基于 Envoy 的组件，负责处理其管理的工作负载的 L7 事务。\n\n## Waypoint Proxy 的常见部署模式是什么？\n\n### 理解 Waypoint Proxy\n\n你可以将 waypoint proxy 简单地视为一组目的地的网关，这些目的地可以是来自一个或多个命名空间的一个或多个服务和工作负载。除了处理集群内部的 L7 流量外，它与你的入口或出口网关没有太大区别。这也是为什么在部署 waypoint proxy 时需要使用 Kubernetes 的 Gateway 资源的原因。\n\n我非常喜欢 waypoint 架构的灵活性，你可以选择适合自己需求的架构。以下是一些常见的模式：\n\n### A: 针对命名空间的 Waypoint Proxy\n\n最常见的模式是，每个团队在集群中拥有一个命名空间，并管理该命名空间内的服务和部署。在这种模式下，我们期望每个团队都有自己的 waypoint proxy，供命名空间内的服务使用。按照这种模式，我们将默认的 waypoint 部署设计为命名空间范围，供命名空间内的所有服务使用。在下图中，服务 A、B、C 位于同一命名空间内。所有到服务 A、B 或 C 的 Ambient Mesh 客户端流量将通过命名空间的 waypoint proxy，由客户端的 ztunnel 进行编程。\n\n![Istio Ambient Waypoint 代理部署模型](f1.webp)\n\n注意：为简洁起见，省略了目的地端的 ztunnel\n\n### B: 针对部分服务的 Waypoint Proxy\n\n如果你不希望到服务 B 的流量经过 waypoint proxy 怎么办？一个常见的原因是，你只需要对服务 B 的流量进行 L4 层的控制，这样在调用它时就不需要通过 waypoint proxy。例如，你有一个调用 MySQL 数据库服务的 Web 服务，只需要对其进行 L4 控制。另一个例子是，当服务是“内部”的，只被命名空间内的其他服务调用，你只需要对跨命名空间边界的服务进行授权策略。例如，在著名的 [Bookinfo 应用程序](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/)中，你可以为 productpage 服务启用零信任，拒绝除端口 9080 上 GET 方法的流量之外的所有流量。对于所有内部服务，如 reviews 或 details 服务，你可以继续允许命名空间内的所有流量。\n\n另一个用例是，服务 A 的流量非常大，你希望有一个专用的 waypoint proxy 来处理其 L7 处理，以便调整资源配置来应对高负载。你可以配置服务 B 或 C 使用不同的 waypoint，避免受到服务 A 的影响，或根据需要跳过它。我们将在下面的部分中详细讨论这一点。\n\n![Istio ambient waypoint 代理部署模型](f2.webp)\n\n### C: 多个命名空间共享一个 Waypoint Proxy\n\n你也可以通过为命名空间添加 \u0060istio.io\/use-waypoint\u0060 标签，并在 Gateway 资源中配置 \u0060allowRoutes\u0060，来让多个命名空间共享一个 waypoint proxy。如果你运行的是小型集群，想要优化资源效率，并且对嘈杂邻居问题不太担心，你可能希望为整个集群使用一个 waypoint proxy。这种情况下的一个常见例子是所谓的 [K8S-at-the-edge](https:\/\/events.linuxfoundation.org\/kubecon-cloudnativecon-europe\/co-located-events\/kubernetes-on-edge-day\/#about)。\n\n\u003e “当应用程序跨越太多命名空间时，使用 waypoint 为多个命名空间服务更具资源效率，通过提升无边车服务网格的概念，并在不同的命名空间中使用集中式的 L7 功能，而不影响性能和应用可用性”，[Ahmad Al-Masry](https:\/\/www.linkedin.com\/in\/ahmad-al-masry-9ab90858\/)，DevSecOps 工程经理说道。\n\n另一个例子是，一个团队拥有几个组成单一信任域的命名空间，你希望通过共享一个 waypoint proxy 来降低资源成本。在下图中，ns-1 和 ns-2 命名空间中的所有服务都使用部署在 ns-1 命名空间中的 waypoint proxy：\n\n![Istio ambient waypoint 代理部署模型](f3.webp)\n\n由于 ns-2 与 ns-1 共享相同的 waypoint proxy，任何在 ns-1 中部署并附加到整个 waypoint 的策略都会影响两个命名空间。例如，如果你部署了一个附加到整个 waypoint 的 \u0060AuthorizationPolicy\u0060，该策略将在两个命名空间中的所有服务上由 waypoint 执行。\n\n## 为什么不简单地为每个节点部署一个 Waypoint Proxy？\n\n虽然将 waypoint proxy 配置为上述不同目的地范围的网关非常好，但你可能会想，为什么不保持简单，为每个节点部署一个 waypoint proxy 作为 Kubernetes [DaemonSet](https:\/\/kubernetes.io\/docs\/concepts\/workloads\/controllers\/daemonset\/) 来处理该节点的所有 L7 处理呢？\n\nWaypoint proxy 需要高度可配置，因为应用程序可能有完全不同的性能要求和运行时自定义。例如，你可以插入针对特定服务的外部授权策略或 WASM 扩展。一个租户的错误 Envoy 配置可能会导致节点代理崩溃，影响该节点上的所有工作负载。\n\n此外，需要在 waypoint proxy 上有大量处理的嘈杂邻居可能会导致另一个应用程序性能不佳，仅仅因为该应用程序也部署在同一节点上。通过为 waypoint proxy 每个节点部署 Envoy，实际上是强制节点上的所有应用程序共享相同的故障域，而不管它们的应用延迟或运行时要求。Envoy 没有租户控制，你无法划分其 CPU 或内存来防止嘈杂邻居抢占其他应用程序。具有复杂 L7 策略的高流量应用程序将需要更多的 CPU 和 waypoint 的内存。Kubernetes DaemonSet 的资源预留是固定的，无法在不增加所有 waypoint pod 的 CPU 和内存的情况下，根据流量负载水平水平或垂直扩展特定的 DaemonSet pod。成本分摊在此模型中也很困难，你无法正确地将 waypoint 引起的资源成本归因于每个租户。\n\n让我们通过一个具体的例子来说明。我在两个命名空间中部署了 Bookinfo 应用程序，每个命名空间都有其默认配置的命名空间 waypoint。我将每个命名空间的 waypoint proxy 配置为与各自的 \u0060productpage\u0060 pod 共置。在每个命名空间中，我部署了一个简单的 L7 \u0060AuthorizationPolicy\u0060，只允许特定命名空间执行 GET 方法：\n\n![Istio ambient waypoint 代理部署模型](f4.webp)\n\n注意：为简洁起见，省略了源和目的地端的 ztunnel\n\n当我从 Fortio 向第一个命名空间的 productpage 服务发送 6500 RPS 的请求，并在 3 秒后向第二个命名空间的 productpage 服务发送相同的请求时，平均响应时间分别为 30.8ms 和 30.4ms，如下图所示：\n\n![命名空间 1](f5.webp)\n\n命名空间 1：通过其 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2](f6.webp)\n\n命名空间 2：通过其 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n由于两个 Bookinfo 应用程序都有非常大的负载，每个应用程序都有自己的 waypoint proxy 是合理的，这样它们不会相互争抢资源。那么，如果 waypoint proxy 改为按节点部署会怎样？\n\n我可以手动将 waypoint proxy 作为 DaemonSet 部署，使用非常复杂的 Envoy 配置。在运行两个 productpage pod 的节点上，waypoint proxy pod 将被两个 productpage pod 使用。然而，这需要深入了解 Envoy 配置，这方面我并不擅长。一种简单的测试方法是，将两个命名空间配置为使用相同的 waypoint proxy，这对于不需要非常高负载或专用 waypoint proxy 的应用程序是推荐的（参见前面的模式 C 了解更多信息）。注意：对于这种情况，我不推荐模式 C，因为两个 Bookinfo 应用程序的负载非常大。\n\n在确保 ns-1 命名空间中的 waypoint proxy pod 也部署在与两个 productpage pod 相同的节点上后，我进行了一个简单的更改，将两个命名空间都配置为使用 ns-1 命名空间中的 waypoint proxy。这使我能够快速测试一个 waypoint proxy pod，被部署在同一节点上的两个 productpage pod 使用，就像我将 waypoint 作为 DaemonSet 部署一样。\n\n![5_Istio ambient waypoint proxy deployment model explained](f7.webp)\n\n当我从 Fortio 负载客户端向第一个命名空间的 productpage 服务发送 6500 RPS 时，平均响应时间从 30ms 增加到了 59ms！在 3 秒后向第二个命名空间的 productpage 发送相同的负载（基本上重复之前的测试，但这次使用共享的 waypoint），它报告了 32% 的错误，从之前的 0% 增加了！当它们共享同一节点上的同一个 waypoint proxy 时，对两者的影响有多大！由于两个应用程序在高负载下都变得非常嘈杂，waypoint proxy 达到了其默认的 CPU 限制（2 核）和 [上游连接限制](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/cluster\/v3\/circuit_breaker.proto#envoy-v3-api-field-config-cluster-v3-circuitbreakers-thresholds-max-connections)（1024），因此许多稍后开始的来自第二个命名空间的请求以高比例的错误失败。Kubernetes 工作节点仍然有充足的 CPU，在峰值时有约 50% 的 CPU 和 6% 的内存利用率。\n\n![命名空间 1.2](f8.webp)\n\n命名空间 1：通过共享的 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2.1](f9.webp)\n\n命名空间 2：通过共享的 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n这个实验表明，在节点上使用相同的 waypoint proxy 共享相同的故障域，可能很容易在嘈杂的邻居下触发故障场景，而这些可以通过为非常繁忙的租户提供专用的 waypoint 来避免。虽然在测试中使用了非常嘈杂的邻居，但也可能是错误的 Envoy 配置或特定的 Envoy 扩展，在多个租户共享相同的故障域时触发类似的问题。\n', '\/trans\/istio-ambient-waypoint-proxy-deployment-model-explained\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ambient-mesh-can-sidecar-less-istio-make-applications-faster/">[译] Istio Ambient 模式：无 Sidecar Istio 如何让应用更快？</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/05</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thenewstack.io/ambient-mesh-can-sidecar-less-istio-make-applications-faster/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式：无 Sidecar Istio 如何让应用更快？', '探索如何使用 Fortio 与 Istio 集成，在使用 Bookinfo 应用和流行的 DevOps 工具如 Kubernetes、Prometheus 和 Grafana 的微服务架构中进行高效的性能测试和监控。', '\nAmbient 模式是 2022 年在 [Istio](https:\/\/thenewstack.io\/simplifying-cluster-connectivity-with-istio-service-mesh\/) 中引入的新型无 sidecar 数据平面。当今年 5 月 [Ambient 模式](https:\/\/thenewstack.io\/ambient-mesh-sidestepping-the-sidecar\/) 达到 [Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 阶段时，我观察到用户开始试用并运行负载测试，以理解将应用添加到网格后的性能影响。\n\n受到 [Quentin Joly 的博客](https:\/\/a-cup-of.coffee\/blog\/istio\/#with-istio-ambient) 关于 Istio 在 Ambient 模式下的惊人性能的启发，以及来自社区其他用户有时应用在 [Ambient 模式](https:\/\/thenewstack.io\/istio-1-23-drops-the-sidecars-for-a-simpler-ambient-mesh\/) 下稍快的反馈，我决定自己验证这些结果。\n\n## 测试环境\n\n我使用了一个拥有 256GB RAM 和每个节点 32 核 CPU 的三节点 Kubernetes 集群。\n\n![](f1.webp)\n\nIstio 使用了一些工具来简化一致性的基准测试。首先，我们使用一个叫做 [Fortio](https:\/\/github.com\/fortio\/fortio) 的负载测试工具，它以指定的每秒请求数 (RPS) 运行，记录执行时间的直方图并计算百分位数，例如 P99，即 99% 的请求在此时间内完成。\n\n我们还提供了一个叫做 [Bookinfo](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/) 的示例应用，其中包括用 Python、Java、Node.js 和 Ruby 编写的微服务。\n\n每个 Bookinfo 部署都有两个副本，这些副本均匀分布在三个工作节点上。使用 [pod anti-affinity rule](https:\/\/kubernetes.io\/docs\/concepts\/scheduling-eviction\/assign-pod-node\/#affinity-and-anti-affinity)，我确保 Fortio 被放置在与 [details](https:\/\/github.com\/istio\/istio\/tree\/master\/samples\/bookinfo\/src\/details) 服务不同的节点上。\n\n## 初始测试结果\n\n我从 Istio v1.22.3 版本安装了 Bookinfo 应用。使用 Fortio 工具对单个 Bookinfo 服务（例如 details）或完整的 Bookinfo 应用进行负载驱动，我注意到在将所有服务添加到 ambient 网格后，延迟影响 **接近零**。大多数时间它们的增加范围在 0-5% 之间，用于平均值或 P90。我一致注意到 Istio 的 details 服务在 ambient 模式下稍微快一点，就像 Quentin 在他的博客中报告的那样。\n\n### 对 Details 服务进行负载测试\n\n我进行了与 Quentin 相同的测试，通过 10 个连接发送 100 RPS 到 details 服务，并收集了无网格和 ambient 的结果。\n\n![无网格：details 服务 100 RPS。](f2.webp)\n\n![Ambient：details 服务 100 RPS。](f3.webp)\n\n就像 Quentin 一样，我不得不进行多次测试以验证 ambient 模式比无网格模式略有性能提升——这很难让人相信！对于 Bookinfo 的 details 服务来说，加入 ambient 模式平均降低了 6-11% 的延迟——以及添加了 mTLS 和 L4 观测！\n\n| **Fortio 对 details** | **平均** | **P50** | **P75** | **P90** | **P99** | **差异**                  |\n| --------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------- |\n| **无网格运行 1**      | 0.89ms   | 0.64ms  | 0.74ms  | 0.85ms  | 2.67ms  | **平均慢 11%，P90 慢 5%** |\n| **Ambient 运行 1**    | 0.80ms   | 0.6ms   | 0.71ms  | 0.81ms  | 1.4ms   |                           |\n| **无网格运行 2**      | 0.86ms   | 0.65ms  | 0.75ms  | 0.86ms  | 1.71ms  | **平均慢 6%，P90 慢 4%**  |\n| **Ambient 运行 2**    | 0.81ms   | 0.61ms  | 0.72ms  | 0.83ms  | 1.56ms  |                           |\n| **无网格运行 3**      | 0.90ms   | 0.65ms  | 0.76ms  | 0.88ms  | 1.92ms  | **平均慢 10%，P90 慢 5%** |\n| **Ambient 运行 3**    | 0.82ms   | 0.63ms  | 0.72ms  | 0.84ms  | 1.5ms   |                           |\n\n*表 1: Fortio 对 details 服务 100 RPS 10 连接。*\n\n## 为什么应用有时在 Ambient Mesh 中更快？\n\n我们被教导说服务网格会增加延迟。Quentin 的结果，这里复制的结果，展示了一个工作负载在通过服务网格运行时*更快*的案例。这是怎么回事？\n\n### 第一种理论\n\n当您的应用位于 ambient 模式 中时，负载请求首先通过一个轻量级的本地节点代理叫做 [ztunnel](https:\/\/istio.io\/latest\/docs\/ambient\/overview\/#ztunnel)，然后传送到目的地 ztunnel，再向服务传送。details 服务使用带有 Webrick 库的 HTTP\/1.1，我们已经看到旧的或配置不良的 HTTP 库中存在连接管理和保持活动状态的行为不佳。我的第一个假设是，当客户端和服务器位于不同节点时，通过客户端和服务器 ztunnels 代理实际上可能更快，如果应用没有使用高效的 HTTP\/2 连接的话。Ztunnel 使用连接池和 [HTTP Connect](https:\/\/en.wikipedia.org\/wiki\/HTTP_tunnel) 建立节点之间的安全通道，以在负载下利用并行性和 HTTP\/2 流多路复用。\n\n![](f4.webp)\n\n然而，这个理论有一些挑战。为什么我只在 details 服务上一致观察到这个，而不是任何其他 Bookinfo 服务？\n\n进一步研究，我发现我们的 Fortio 负载工具默认启用了[连接保持活动](https:\/\/github.com\/fortio\/fortio\/blob\/8a7d9112667e637139c788b68cb063f456d20cb4\/bincommon\/commonflags.go#L55)。使用 10 个来自 Fortio 的连接到 details 服务和 details 服务（使用 WEBrick Ruby 库）尊重连接保持活动设置，连接可以有效地被重用，无需 ambient。\n\n### 用 Connection Close 进行负载测试\n\n接下来，我探索了使用设置 \u0060Connection: close\u0060 标头的同样负载测试。这强制禁用任何 HTTP 连接池，这是测试这个假设的好方法。\n\n\u0060\u0060\u0060bash\ncurl -v -d \u0027{\u0022metadata\u0022: {\u0022url\u0022:\u0022http:\/\/details:9080\/details\/0\u0022, \u0022c\u0022:\u002210\u0022, \u0022qps\u0022: \u0022100\u0022, \u0022n\u0022: \u00222000\u0022, \u0022async\u0022:\u0022on\u0022, \u0022save\u0022:\u0022on\u0022}}\u0027 \u0022localhost:8081\/fortio\/rest\/run?jsonPath=.metadata\u0022 -H \u0022Connection: close\u0022\n\u0060\u0060\u0060\n\n![无网格：details 服务 100 RPS 10 连接带有 connection close。](f5.webp)\n\n![Ambient：details 服务 100 RPS 10 连接带有 connection close。](f6.webp)\n\n| **Fortio 对** **details** | **平均** | **P50** | **P75** | **P90** | **P99** | **差异**                 |\n| ------------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------ |\n| **无网格**                | 1.90ms   | 1.72ms  | 2.28ms  | 2.77ms  | 3.98ms  |                          |\n| **Ambient**               | 2.06ms   | 2.15ms  | 2.65ms  | 2.94ms  | 4ms     | **平均慢 8%，P90 慢 6%** |\n\n*表 2: Fortio 对 details 服务 100 RPS 10 连接带有 connection close。*\n\n与表 1 的结果相比，表 2 的响应时间明显更高，这是预期的，因为每个连接在 details 服务响应后立即关闭。考虑到 P50、P75、P90 和 P99 都从带有 connection close 的 ambient 运行中变慢，似乎可以安全排除第一理论中的 ztunnel 连接池可能使请求更快。\n\n### 第二种理论\n\n我注意到在我们新的 Istio v1.23 版本中的 details 和 productpage 服务中有一个与性能相关的 [PR](https:\/\/github.com\/istio\/istio\/pull\/51428\/files)。对于 details 服务，PR 为 details WEBrick 服务器启用了 [TCP_NODELAY](https:\/\/brooker.co.za\/blog\/2024\/05\/09\/nagle.html) 标志，这将减少来自 details 服务响应时间的不必要延迟（高达 [40ms](https:\/\/vorner.github.io\/2020\/11\/06\/40-ms-bug.html)）。对于 productpage 服务，PR 在传入请求上启用了保持活动状态，这将重用现有的传入连接，从而提高性能。\n\n包含修复的新更新的 details 部署中，我重复了通过 10 个连接发送 100 RPS 到 details 服务的相同测试。无网格和 ambient 的结果非常接近，所以我进行了三次测试以确保结果的一致性。下面是每个场景的第一次运行的截图：\n\n![无网格：新 details 服务 100 RPS 10 连接。](f7.webp)\n\n![Ambient：新 details 服务 100 RPS 10 连接。](f8.webp)\n\n我为每个场景的三次运行建立了一个表格：\n\n![](t1.webp)\n\n*表 3: Fortio 对新 details 服务 100 RPS 10 连接。*\n\n与表 1 的先前结果相比，表 3 的无网格数字有了相当大的改进（在更高百分比下更显著地超过 ambient 数字），现在接近于 ambient 数字。Ztunnel 默认启用了 [TCP_NODELAY](https:\/\/github.com\/istio\/ztunnel\/pulls?q=is%3Apr\u002bis%3Aclosed\u002bTCP_NODELAY)，这有助于 ambient 性能在表 1 中超过无网格，当旧的 details 服务没有启用 TCP_NODELAY 时。当新的 details 服务启用了 TCP_NODELAY 时，它也稍微提高了 ambient 的响应时间。\n\n表 3 还显示，在此类型的负载测试中，无网格和 ambient 运行之间的平均、P50、P75 和 P90 几乎没有差异。这些运行之间的差异可能只是噪音，除了 P99，无网格始终比 ambient 慢 8% 或更多。\n\n### 第三种理论\n\n继续审查表 3 的测试结果，为什么在有额外跳转到 ztunnel pod 和 ambient 提供的如 mTLS 和 L4 观测等显著优势时，无网格和 ambient 之间的延迟相似？对于 P99 情况，为什么 details 服务在 ambient 模式下始终更快？\n\nZtunnel 提供了出色的读写缓冲管理，并通过 HTTP\/2 多路复用，可以有效地最小化或有时甚至消除通过客户端和服务器 ztunnel pod 的额外跳转所增加的开销。我决定通过在两个 Fortio 和 details 服务的 Kubernetes 工作节点上进入并附加 strace 来测量这一点，同时过滤掉无关的跟踪：\n\n\u0060\u0060\u0060bash\nstrace -fp {pid} -e trace=write,writev,read,recvfrom,sendto,readv\n\u0060\u0060\u0060\n\n无网格和 ambient 情况下的 details 服务的 strace 输出是相似的：\n\n\u0060\u0060\u0060\n…read(9, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 8192) = 118write(9, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 180) = 180write(9, \u0022{\u0022id\u0022:0,\u0022author\u0022:\u0022William Shakes\u0022..., 178) = 178write(2, \u0022192.168.239.19 - - [13\/Aug\/2024:\u0022..., 80) = 80…\n\u0060\u0060\u0060\n\n*输出 1: 无网格或 ambient —— 附加 strace 到 details 服务的 PID。*\n\n无网格和 ambient 情况下的 Fortio 服务的 strace 输出不同。在无网格情况下，我们看到 Fortio 执行了两次读取，一次用于 HTTP 头部，另一次用于正文。\n\n\u0060\u0060\u0060\n…read(13, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 4096) = 180read(13, \u0022{\u0022id\u0022:0,\u0022author\u0022:\u0022William Shakes\u0022..., 4096) = 178…write(19, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 118) = 118 …\n\u0060\u0060\u0060\n\n*输出 2: 无网格 —— 附加 strace 到 Fortio 的 PID。*\n\n在 ambient 情况下，我们始终只看到一个读取，用于同时获取头部和正文。\n\n\u0060\u0060\u0060\n…read(19, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 4096) = 358…write(19, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 118) = 118…\n\u0060\u0060\u0060\n\n*输出 3: Ambient 模式 —— 附加 strace 到 Fortio 的 PID。*\n\n为什么会这样？这是有道理的，因为 write 调用完全基于应用行为，而这在这种情况下没有变化。Ambient 将这些多个应用写入合并为单个网络写入，并隐含地在对等端进行单个读取。\n\n在上述测试场景中，我观察到 Fortio 服务在启用 ambient 时系统调用总数减少了 60%。这非常**重要**，并解释了在 peak 时 Fortio pod 的延迟和 CPU 使用量减少约 25% 的大部分原因。系统调用的减少超过了 mTLS 和 ztunnel 的其他功能的成本。我预计这种模式在企业中会相当常见，因为一些 HTTP 库和应用在缓冲和刷新方面做得更好，而一些则不太好。这通常与应用的年龄和它们构建时使用的 SDK 相关。\n\n![无网格和 ambient 运行：details 服务 100 QPS 10 连接。](f9.webp)\n\n## 整个 Bookinfo 应用怎么样？\n\n在更新了 details 和 productpage 部署之后，我开始通过 100 个连接发送 1000 RPS 到 Bookinfo 应用，并观察到无网格和 ambient 的优异结果。\n\n![无网格：新 Bookinfo 应用 1000 RPS 100 连接。](f10.webp)\n\n![无网格：新 Bookinfo 应用 1000 RPS 100 连接。](f11.webp)\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异**               |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | -------------------------- |\n| **无网格**             | 1.39ms   | 1.32ms  | 1.42ms  | 1.67ms  | 2.19ms  |                            |\n| **Ambient**            | 1.40ms   | 1.34ms  | 1.48ms  | 1.68ms  | 2.94ms  | **平均和 P90 均慢不到 1%** |\n\n*表 4: Fortio 对新 Bookinfo 应用 1000 RPS 100 连接。*\n\n作为对比，我还针对 v1.22.3 版本中附带的旧 Bookinfo 示例进行了同样的测试，你可以看到新 Bookinfo 在响应时间上取得了 **5-10 倍** 的提升，无论是无网格还是 ambient！\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异** |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | ------------ |\n| **无网格**             | 6.35ms   | 4.68ms  | 7.44ms  | 11.4ms  | 36.63ms |              |\n| **Ambient**            | 6.74ms   | 4.9ms   | 7.79ms  | 12.12ms | 41.14ms | **慢 6%**    |\n\n*表 5: Fortio 对旧 Bookinfo 应用 1000 RPS 100 连接。*\n\n将负载增加到 4000 RPS 和 400 连接，并使用新 Bookinfo 部署：\n\n![Ambient：新 Bookinfo 应用 4000 RPS 400 连接。](f12.webp)\n\n![Ambient：新 Bookinfo 应用 4000 RPS 400 连接。](f13.webp)\n\n响应时间依然很好，远远优于只有 1000 RPS 和 100 连接的旧 Bookinfo 应用（表 5）：\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异**             |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------ |\n| **无网格**             | 1.54ms   | 1.33ms  | 1.54ms  | 2.25ms  | 3.98ms  |                          |\n| **Ambient**            | 1.58ms   | 1.37ms  | 1.57ms  | 2.33ms  | 4.9ms   | **平均慢 3%，P90 慢 4%** |\n\n*表 6: Fortio 对新 Bookinfo 应用 4000 RPS 400 连接。*\n\n很高兴看到 Bookinfo 能够在 4000 RPS 下无错误地运行，而且 ambient 模式比无网格慢 3-4%，但带来了传输中加密的 mTLS 和 L4 观测的所有好处。我记得我之前只能在旧 Bookinfo 应用中达到最高 1200 RPS，这已经导致了少量的错误。现在我可以增加到 4000 或更高 RPS 而不出现错误。\n\n## 总结\n\n在 L4 上，Ambient 模式只引入了非常微小的影响——偶尔甚至可以自动**改善**！— 用户应用的延迟。结合简单的用户体验，通过标记命名空间以将您的应用注册到 ambient 而无需重启任何工作负载，它为用户提供了我们初衷中预期的愉快体验。\n\n我想感谢所有 Istio 维护者，他们构建了这样一个令人愉快的项目，以及为 Istio 项目提供测试基础设施的 [CNCF](https:\/\/www.cncf.io\/community-infrastructure-lab\/)。我还要感谢 Quentin Joly 和许多提供了“ambient 有时比无网格稍快”的反馈的用户，这促使我进行了上述基准测试，亲身体验了在负载下的改善或微小的延迟影响。\n', '\/trans\/ambient-mesh-can-sidecar-less-istio-make-applications-faster\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索如何使用 Fortio 与 Istio 集成，在使用 Bookinfo 应用和流行的 DevOps 工具如 Kubernetes、Prometheus 和 Grafana 的微服务架构中进行高效的性能测试和监控。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-configuration-safety-common-misconfigurations/">Istio 配置安全：如何避免错误配置</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/06</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 配置安全：如何避免错误配置', '探索常见的 Istio 配置错误及其解决方法，提高服务网格的安全性和稳定性。', '\nIstio 是一个功能强大的服务网格解决方案，提供零信任安全性、可观测性和高级流量管理等功能，且无需修改代码即可实现。然而，由于配置错误，我们经常会遇到意料之外的行为。本文将介绍几种常见的 Istio 配置错误，解析其背后的原理，并通过示意图展示如何识别和解决这些问题。我们还将介绍 Tetrate 提供的工具——[TIS Config Analyzer](https:\/\/docs.tetrate.io\/istio-subscription\/dashboard\/analyzers\/config)，这是一种优化 Istio 操作效率和安全性的工具。\n\n## 配置错误导致的事故案例\n\n以下是两个由于配置错误导致的典型事故案例：\n\n1. **[Amazon Web Services 2017 年停机事件](https:\/\/www.theverge.com\/2017\/3\/2\/14792442\/amazon-s3-outage-cause-typo-internet-server)**：一次简单的输入错误导致了广泛的服务中断，影响了数千个在线服务和应用，突显了即使在成熟的云基础设施中，一个小小的配置错误也会引发严重后果。\n\n2. **[GitLab 2017 年数据丢失事故](https:\/\/about.gitlab.com\/blog\/2017\/02\/01\/gitlab-dot-com-database-incident\/)**：由于配置错误，GitLab 在进行数据库维护时误删除了大量生产数据。尽管备份机制被配置好，但错误的配置阻止了数据的及时恢复。\n\n这些案例表明，正确的配置管理对于防止服务中断和数据丢失至关重要。\n\n## 常见的 Istio 配置错误类型\n\nIstio 配置错误主要分为以下几大类：\n\n1. **AuthorizationPolicy（授权策略）**：命名空间不存在、仅允许 HTTP 方法和完全限定的 gRPC 名称、主机没有匹配的服务注册表条目、字段需要启用 mTLS、未找到服务帐户等。\n2. **DestinationRule（目标规则）**：同一主机子集组合的多个目标规则、主机在服务注册表中没有匹配条目、子集标签在任何匹配主机中未找到等。\n3. **Gateway（网关）**：同一主机端口组合的多个网关、网关选择器在命名空间中未找到匹配的工作负载等。\n4. **Port（端口）**：端口名称必须遵循特定格式、端口的应用协议必须遵循特定格式等。\n5. **Service（服务）**：未找到暴露与服务相同端口的部署等。\n6. **VirtualService（虚拟服务）**：目标权重的路由没有有效的服务、指向不存在网关的虚拟服务等。\n\n## 常见的 Istio 配置错误示例\n\n在 Istio 的日常使用中，以下是一些最常见的配置错误：\n\n1. **虚拟服务指向不存在的网关：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: VirtualService\n    metadata:\n      name: details\n      namespace: bookinfo\n    spec:\n      hosts:\n        - details\n      gateways:\n        - non-existent-gateway\n    \u0060\u0060\u0060\n    在这种情况下，\u0060details\u0060 虚拟服务试图通过一个不存在的 \u0060non-existent-gateway\u0060 进行路由，导致流量管理失败。\n\n2. **虚拟服务引用不存在的服务子集：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: VirtualService\n    metadata:\n      name: details\n      namespace: bookinfo\n    spec:\n      hosts:\n        - details\n    \u0060\u0060\u0060\n    如果 \u0060details\u0060 服务没有定义相应的子集，请求将因无法找到正确的服务实例而被拒绝。\n\n3. **网关找不到指定的服务器凭证：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: Gateway\n    metadata:\n      name: cert-not-found-gateway\n      namespace: bookinfo\n    spec:\n      selector:\n        istio: ingressgateway\n      servers:\n        - port:\n            number: 443\n            name: https\n            protocol: HTTPS\n          tls:\n            mode: SIMPLE\n            credentialName: \u0022not-exist\u0022\n    \u0060\u0060\u0060\n    这会导致 TLS 握手失败，因为指定的凭证 \u0060not-exist\u0060 不存在。\n\n## 配置验证\n\n为了减少由于配置错误而导致的服务中断风险，配置验证成为了一个不可或缺的步骤。配置验证可以分为以下两种：\n\n- **静态配置验证**：在配置应用到系统之前进行验证。这包括检查语法错误、完整性以及配置项的有效性。\n- **按需配置验证**：在配置已经应用但可能需要根据实时数据进行调整时进行验证。这种类型的验证有助于适应动态环境中的变化，确保配置的持续正确性。\n\n### 推荐的配置验证工具\n\n#### \u0060istioctl validate\u0060\n\n\u0060istioctl validate\u0060 用于验证 Istio 配置文件（如 YAML 文件）的语法和基本结构，确保配置文件符合 Istio API 的规范。它可以在配置应用到集群之前检测出语法错误和格式问题，是一个静态分析工具，通常结合 CI 流程使用，防止无效配置文件应用到集群中。\n\n#### \u0060istioctl analyze\u0060\n\n[\u0060istioctl analyze\u0060](https:\/\/istio.io\/latest\/docs\/ops\/diagnostic-tools\/istioctl-analyze\/) 是一个强大的诊断工具，用于分析 Istio 集群的运行状态和配置一致性。它不仅检查配置文件的语法，还可以检查集群中实际应用的配置，找出潜在的问题和冲突。\u0060istioctl analyze\u0060 提供动态分析功能，能够识别集群运行时的配置错误和潜在问题。\n\n\u0060istioctl analyze\u0060 的配置流程如下：\n\n1. **收集配置数据**：首先，\u0060istioctl analyze\u0060 收集来自指定源的 Istio 配置数据。这些源可以是活动的 Kubernetes 集群，也可以是本地的配置文件。\n2. **解析和构建模型**：工具解析收集的配置数据，构建一个内部表示 Istio 配置的模型。\n3. **应用分析规则**：随后，它应用一系列预定义的规则来分析这个模型，检测潜在的配置问题。这些规则涵盖从安全漏洞到性能问题的各种潜在问题。\n4. **生成报告**：分析完成后，\u0060istioctl analyze\u0060 输出一个包含所有发现问题的详细报告。如果没有发现问题，它会通知用户配置看起来没有问题。\n\n下面是 \u0060istioctl analyze\u0060 的工作流程图：\n\n\u0060\u0060\u0060mermaid istio analyze 的工作流程\nflowchart TD\n    A[开始] --\u003e B[选择配置源]\n    B --本地文件--\u003e C[加载本地配置文件]\n    B --实时集群--\u003e D[连接 Kubernetes 集群]\n    B --两者--\u003e E[组合本地文件和集群配置]\n    C --\u003e F[解析配置数据]\n    D --\u003e F\n    E --\u003e F\n    F --\u003e G[构建内部配置模型]\n    G --\u003e H[应用分析规则]\n    H --\u003e I{发现问题?}\n    I --是--\u003e J[生成问题报告]\n    I --否--\u003e K[输出配置无问题]\n    J --\u003e L[结束]\n    K --\u003e L\n\u0060\u0060\u0060\n\n![istioctl analyze 的工作流程](4eb4d5bbb7c8856d609944835aa03993.svg)\n\n#### Kiali\n\n[Kiali](https:\/\/kiali.io) 是管理和可视化 Istio 服务网格的重要工具，提供对网格健康状况、性能和配置状态的实时洞察。通过将 Kiali 集成到 Istio 环境中，可以通过以下方式增强配置安全性：\n\n- **可视化**：Kiali 提供服务网格的图形表示，更容易发现配置错误，如路由错误或缺失的策略。\n- **验证**：有助于验证 Istio 配置，突出显示如配置错误的网关或目标规则等问题，以防这些问题引起麻烦。\n- **安全洞察**：Kiali 提供对安全策略的可见性，确保 mTLS 和授权设置正确实施。\n\n将 Kiali 与 \u0060istioctl validate\u0060 和 \u0060istioctl analyze\u0060 等工具结合使用，能确保更为稳健的方法来预防和解决 Istio 配置错误，进而提升服务网格的安全性和效率。\n\n## Tetrate 的 TIS 中的 Config Analyzer 工具介绍\n\n为了帮助开发者和运维人员避免常见的配置失误，Tetrate 开发了 TIS Dashboard 中的 [Config Analyzer](https:\/\/docs.tetrate.io\/istio-subscription\/dashboard\/analyzers\/config) 工具。该工具能够自动验证 Istio 的配置，根据最佳实践分析服务网格的配置问题，并提供优化建议。Config Analyzer 可以自动检测 Istio 服务网格中的配置问题，提供解释及解决方案，支持按需检测配置中的错误。\n\n![TIS Config Analyzer 可以按需检测配置中的问题](config-validate.png)\n\n## 总结\n\n正确配置 Istio 是确保服务网格健康运行的关键。通过了解和避免常见配置错误，以及利用如 Tetrate 的 TIS Config Analyzer 这样的高级工具，您可以确保 Istio 环境的稳定性和安全性。记住，一个小小的配置错误可能导致整个服务网格的故障，因此持续监控和审核配置是非常必要的。\n\n## 参考\n\n- [Validation - kiali.io](https:\/\/kiali.io\/docs\/features\/validations\/)', '\/blog\/istio-configuration-safety-common-misconfigurations\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索常见的 Istio 配置错误及其解决方法，提高服务网格的安全性和稳定性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">保障 Istio 安全：解决关键安全漏洞及最佳实践</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/25</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('保障 Istio 安全：解决关键安全漏洞及最佳实践', '探索 Istio 中的关键安全漏洞及其缓解措施，并结合多层安全策略的最佳实践。', '\n## 引言\n\n近期，Wiz 研究团队发布了[博客](\/trans\/sapwned-sap-ai-vulnerabilities-ai-security\/)，揭示了 AI 服务中的租户隔离漏洞，引起了广泛关注。该研究详细阐述了多个 AI 服务供应商存在的安全缺陷，特别是 SAP AI Core 平台。通过合法的 AI 训练过程，研究人员能够绕过 Istio 服务网格中的流量劫持，进而横向移动并接管服务，获取客户的私人文件和云环境凭证。这些发现凸显了当今云服务和管理平台在确保隔离和沙盒环境方面面临的挑战。\n\n{{\u003ccallout tip \u0022关于 UID 1337\u0022\u003e}}\nIstio 选择 UID 1337（leet 的变体）作为 \u0060istio-proxy\u0060 容器中的用户 ID 是为了便于配置并避免权限冲突。这个数字在技术和游戏文化中象征“精英”（elite），有助于防止与其他常规用户 ID 冲突，确保流量管理操作不受权限问题干扰。\n{{\u003c\/callout\u003e}}\n\n在这个背景下，Istio 作为一个重要的服务网格解决方案，同样面临着类似的安全问题，尤其是在 sidecar 注入和流量管理等关键功能上。这篇博客旨在探讨如何保护 Istio 服务网格的安全，并提供一套全面的缓解措施。我们还将讨论多层安全策略如何有效增强 Istio 的安全性，以应对类似 Wiz 报告中提到的挑战。\n\n## 概述\n\nIstio 主要用于管理 Kubernetes 中的东西向流量，提供详细的流量管理功能，如请求路由、负载均衡和故障恢复策略。虽然 Istio 提供了流量加密、认证和授权等安全功能，但它本身不应被视为防火墙。为了确保 Istio 网格中的服务安全，除了使用 Istio 自身的安全功能，还需要结合底层网络和基础设施的安全措施，比如 CNI 和安全容器。此外，微分段技术可以用来实现更细粒度的隔离，提高安全性。\n\n不论是 Sidecar 模式还是 Ambient 模式，都是通过劫持应用程序 Pod 的流量到数据平面代理中进行处理和转发的。如果没有成功拦截到应用程序流量或者被仿冒程序冒充了 Istio 而执行操作，就会有安全漏洞出现。\n\n下图展示了通过绕过或仿冒 Istio 系统用户而造成的安全漏洞存在的位置。\n\n![能够绕过 Istio 中流量劫持的“安全漏洞\u0022](bypass-sidecar-traffic-hijack.svg)\n\n接下来，我们将探讨“安全漏洞”产生的具体情况及应对策略。\n\n## 绕过 Istio Sidecar 注入\n\n### 在命名空间级别禁用注入\n\n- **场景**：应用团队滥用命名空间标签，在命名空间级别禁用 Istio Sidecar 注入。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes 命名空间资源的访问。\n- **监控**：使用策略引擎（如 OPA Gatekeeper）来确保命名空间标签的合规性，定期审查命名空间的配置。\n\n### 在 Pod 级别禁用注入\n\n- **场景**：应用团队滥用 Pod 标签，在 Pod 级别禁用 Istio Sidecar 注入。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：使用 Admission Webhook 强制启用 Sidecar 注入，禁止使用排除标签，定期扫描和审计所有 Pod，确保所有需要的 Pod 都注入了 Sidecar。\n\n## 绕过流量重定向到 Istio Sidecar\n\n### 滥用流量重定向注解\n\n- **场景**：应用团队滥用 Pod 注解，排除特定的入站或出站端口或 IP 地址，从而绕过流量重定向。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：使用策略引擎来检测和警告不合规的注解使用，定期审查 Pod 注解。\n\n### 滥用 Pod 的 UID\n\n- **场景**：应用团队滥用 UID 1337（sidecar 代理的 ID），绕过 Istio Iptables 重定向规则。\n- **缓解策略**：\n  - 强制所有 Pod 指定非 1337 的 UID。\n  - 检查所有容器镜像以检查 UID 1337 并拒绝这些镜像。此检查可以使用准入 Webhook 或由管理镜像注册表的中央团队来执行。\n- **监控**：禁用或限制 UID 1337 的使用，定期审计 Pod 的 UID 配置，确保没有绕过行为。\n\n### 滥用 Pod 能力（NET_ADMIN、NET_RAW）\n\n- **场景**：应用团队滥用 NET_ADMIN 和 NET_RAW 能力，移除 Istio Iptables 规则。\n- **缓解策略**：平台团队启用 Istio CNI（以避免授予应用团队提升的权限），并限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：定期审查和监控 Pod 的权限配置，确保没有越权行为。\n\n## 绕过入站流量约束\n\n### 滥用 PeerAuthentication\n\n- **场景**：应用团队创建一个针对每个命名空间\/每个工作负载的 PeerAuthentication 资源，启用 PERMISSIVE 认证模式。\n- **缓解策略**：平台团队限制对原始 Istio PeerAuthentication 资源的访问。\n- **监控**：定期审查 PeerAuthentication 配置，确保所有入站流量都按照要求加密。\n\n## 绕过出站流量约束\n\n### 滥用 ServiceEntry\n\n- **场景**：应用团队创建一个 ServiceEntry，直接访问外部服务，而无需经过 Egress 网关。\n- **缓解策略**：平台团队限制对原始 Istio ServiceEntry 资源的访问。\n- **监控**：定期审查 ServiceEntry 配置，确保没有绕过行为。\n\n### 滥用 ExternalName 服务\n\n- **场景**：应用团队创建一个类型为 ExternalName 的 Kubernetes Service，直接访问外部服务，而无需经过 Egress 网关。\n- **缓解策略**：平台团队限制对原始 Kubernetes Service 资源的访问。\n- **监控**：定期审查 Kubernetes Service 的类型配置，确保没有绕过行为。\n\n## 无法控制地更改 Istio Sidecar 配置\n\n### 滥用 Sidecar 资源\n\n- **场景**：应用团队创建一个针对每个工作负载的 Istio Sidecar 资源，并将 \u0060outboundTrafficPolicy\u0060 字段设置为 \u0060ALLOW_ANY\u0060（覆盖可能的全局值 \u0060REGISTRY_ONLY\u0060）。\n- **缓解策略**：平台团队限制对原始 Istio Sidecar 资源的访问。\n- **监控**：定期审查 Sidecar 资源配置，确保没有覆盖全局设置的行为。\n\n### 滥用 EnvoyFilter\n\n- **场景**：应用团队创建 EnvoyFilter，导致与现有 Istio 对象冲突，从而引发 DoS 攻击或违反安全策略。\n- **缓解策略**：平台团队限制对原始 Istio EnvoyFilter 资源的访问。\n- **监控**：定期审查 EnvoyFilter 配置，确保没有不当使用行为。\n\n## 服务网格应作为分层防御的一部分\n\n服务网格被描述为现有安全模型的一个补充层，通过在传统安全控制之上添加更细粒度的安全策略来增强微服务的安全性。然而，文章强调了服务网格无法独立保障微服务的全面安全，而是应当作为整体安全策略的一部分。\n\n![微服务安全分层架构](security-layers.svg)\n\n服务网格主要通过在每个服务实例旁部署一个轻量级的代理（sidecar），来管理和控制网络流量。这使得它能够在网络层面上实现精细的流量控制和策略执行，如流量加密、身份认证和授权。尽管服务网格能够提供诸如流量控制、服务发现和断路器等功能，这些功能本质上是对网络流量的管理，无法解决所有安全问题。例如，它不能替代应用层防火墙、入侵检测系统和数据安全等更传统的安全措施。\n\n此外，服务网格依赖于正确的配置和管理，配置不当可能导致安全漏洞。因此，尽管服务网格是现代微服务架构中不可或缺的一部分，它应该与传统的安全措施相结合，共同构成一个全面的、多层次的安全策略框架。参考[如何通过服务网格增强微服务的安全性](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/)以进一步了解如何加强服务网格的安全。\n\n## 长期解决方案和社区合作\n\nIstio 社区每年都会进行一次安全审计，见 [2021 年](https:\/\/istio.io\/latest\/blog\/2021\/ncc-security-assessment\/)、[2022 年](https:\/\/istio.io\/latest\/blog\/2023\/ada-logics-security-assessment\/) 的安全审计结果。从结果中我们可以看到，Istio 的安全态势有了很大的提升。确保你的 Istio 服务网格符合[安全最佳实践](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/)。另外，你还需要关注 [Istio CVE 公告栏](https:\/\/istio.io\/latest\/news\/security\/)，或者使用如 [Tetrate Istio Subscription](https:\/\/tetrate.io\/tetrate-istio-subscription\/) 这类工具来扫描 Istio 服务网格的各种 CVE，部署符合 FIPS 并经过 FIPS 验证的 Istio 发行版。\n\n## 结论\n\n服务网格通过在应用程序外部管理控制流，为微服务架构提供了额外的安全层。这允许在不影响应用程序性能的前提下，加强服务之间的通信安全。在部署服务网格时，推荐使用 Istio 的 Egress Gateway 来管理出口流量，结合 Kubernetes 的 NetworkPolicy，确保所有出口流量都必须经过网关，从而防止潜在的数据泄露和其他安全威胁。\n\n## 参考\n\n- [How to enforce egress traffic using Istio’s authorization policies - tetrate.io](https:\/\/tetrate.io\/blog\/istio-how-to-enforce-egress-traffic-using-istios-authorization-policies\/)\n- [Istio Security Best Practice - istio.io](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/)\n- [Optimize Traffic Management and Security with These Service Mesh Best Practices - tetrate.io](https:\/\/tetrate.io\/blog\/optimize-traffic-management-and-security-with-these-service-mesh-best-practices\/)\n- [Istio publishes results of 2022 security audit - istio.io](https:\/\/istio.io\/latest\/blog\/2023\/ada-logics-security-assessment\/)\n- [Announcing the results of Istio’s first security assessment - istio.io](https:\/\/istio.io\/latest\/blog\/2021\/ncc-security-assessment\/)\n', '\/blog\/securing-istio-addressing-critical-security-gaps-and-best-practices\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索 Istio 中的关键安全漏洞及其缓解措施，并结合多层安全策略的最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ztunnel-testing/">[译] 无需 Kubernetes 测试 Kubernetes 网络实现</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/23</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://blog.howardjohn.info/posts/ztunnel-testing/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('无需 Kubernetes 测试 Kubernetes 网络实现', '探讨如何在没有 Kubernetes 环境的情况下测试 Ztunnel 网络代理，该代理为 Istio 的新 Ambient 模式编写。', '\n由于在开发过程中我[真的不喜欢等待](https:\/\/blog.howardjohn.info\/posts\/ideal-ci\/)，所以在构建 Ztunnel（一个为 Istio 的新 [Ambient 模式](https:\/\/istio.io\/latest\/blog\/2022\/introducing-ambient-mesh\/)设计的底层网络代理）时，我的首要任务之一便是确保测试的快速进行（包括运行和编写测试），并且易于调试。\n\n这一任务颇为棘手，因为在大多数真实场景中，Ztunnel 高度依赖 Kubernetes。虽然它能够完全独立于 Kubernetes 运行，但许多关键代码路径的行为完全不同，使得仅通过这种方式进行测试变得不可行。\n\n下图为典型的 Ztunnel 部署架构：\n\n![Ztunnel 架构概览](ztunnel-architecture.svg)\n\n在此架构中，用户将运行一个包含多个节点的 Kubernetes 集群。每个节点上都运行着一个 Ztunnel，配置了宿主机和每个 pod 的网络栈。\n\n此外，Ztunnel 实际上进入了每个 pod 的网络命名空间，并代表其发送\/接收流量。这一点非常奇特且酷炫，但也大大增加了测试的难度！（[详细信息](https:\/\/www.youtube.com\/watch?v=cuMeEhpyH5s)）\n\n## 加速测试\n\n启动完整的 Kubernetes 环境、重建镜像、部署到每个节点的过程非常缓慢且难以调试。\n\n黄金标准应该是将所有操作运行在一个简单的单一二进制文件中——仅需执行 \u0060cargo test\u0060。这种方式避开了复杂的设置和缓慢的重建，并使调试变得轻而易举（当然，你可以将调试器连接到正在运行的 pod，但这很麻烦）。\n\n## 设置网络\n\n如果我们去除无尽的抽象层，Kubernetes pod 实际上只是几个 Linux 命名空间和挂载的组合。Docker 在这方面管理得很好，[bash](https:\/\/github.com\/p8952\/bocker) 也可以。\n\n我们特别关注的是[网络命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/network_namespaces.7.html)，它可以实现网络栈的隔离。每个 pod 都有自己的网络命名空间，通过各种机制连接，允许与同一节点上的其他 pod、其他节点以及外部目的地通信。\n\n好消息是创建网络命名空间非常简单。\n\n\u0060\u0060\u0060shell\n$ sudo ip netns add testing\n\u0060\u0060\u0060\n\n我们的最终目标是设置一系列的网络命名空间，外观与我们在 Kubernetes 上的真实架构类似：\n\n![所需的网络命名空间设置](ztunnel-network-namespaces.svg)\n\n在网络命名空间之间建立连接稍微复杂一些。像  [\u0060cnitool\u0060](https:\/\/www.cni.dev\/docs\/cnitool\/) 这样的工具可以帮助我们完成（它实际上执行了一些 Kubernetes 环境中用于设置网络的相同逻辑，但作为 CLI 工具），但你也可以完全手动操作。我们选择了后者。\n\n最终，我们的设置如下：\n\n- 每个测试都拥有自己的网络命名空间，通过一个桥接设备（\u0060br0\u0060）来促进节点之间的流量。\n- 每个节点配置了一个 \u0060veth\u0060 设备。一端成为节点上的 \u0060eth0\u0060，另一端连接到根命名空间中的 \u0060br0\u0060。\n- 每个 pod 都配置了一个 \u0060veth\u0060 设备。一端成为 pod 上的 \u0060eth0\u0060，另一端位于节点网络命名空间中。\n- 为每个 pod 设置路由以将流量发送到节点。\n- 为每对节点设置路由，以实现跨节点流量。\n\n![所需的网络连接设置](ztunnel-network-devices.svg)\n\n除了根命名空间\/桥接设备外，这与许多现实世界中的 Kubernetes 集群的运行方式相同（在现实世界中，根命名空间是两台机器之间的物理网络）。\n\n你可以在[这里](https:\/\/github.com\/istio\/ztunnel\/blob\/34fce85a6a2b2a85eb170a04096731e2ea4e0e9f\/src\/test_helpers\/netns.rs#L194)找到所有细节。\n\n## 运行测试\n\n一旦我们有了这些命名空间，我们仍然需要一种实际使用它们的方法。幸运的是，Linux 允许在运行时更改当前命名空间线程（这是接下来重要的内容）。这让我们建立了一个基本的帮助函数（真实的代码稍微更复杂）：\n\n\u0060\u0060\u0060rust\nfn run_in_namespace(namespace: Namespace, f: Fn()) { let original_namespace = get_current_namespace(); namespace.enter(); f(); original_namespace.enter(); }\n\u0060\u0060\u0060\n\n有了这个，我们可以轻松地从任意的“pods”或“nodes”执行代码。\n\n然而，我们仍然面临一个问题。我们的所有代码都运行在 [tokio](https:\/\/tokio.rs\/) 异步运行时中，它会根据需要将我们的各种任务安排到物理操作系统线程上（类似于 Go 运行时的工作方式）。由于网络命名空间是线程相关的，所以当我们的任务在线程之间跳转时，这一切都会崩溃。\n\n幸运的是，Rust 给了我们比 Go 更多的关于异步运行时的灵活性——我们可以同时拥有多个！借此，我们能够构建一个能够异步执行 \u0060run_in_namespace\u0060。对于我们想要执行的每个函数，我们启动一个新线程并构建一个专用的单线程异步运行时来处理它：\n\n\u0060\u0060\u0060rust\nasync fn async_run_in_namespace(namespace: Namespace, f: async Fn()) { thread::spawn(move || { run_in_namespace(namespace, || { let rt = tokio::runtime::Builder::new_current_thread().enable_all().build(); rt.block_on(f()) }) }); }\n\u0060\u0060\u0060\n\n我们为每个命名空间运行一次这个函数，因此这里的开销是最小的。如果我们想要运行许多小函数，可以在顶层构建一个抽象来发送工作到线程以执行。\n\n我们需要的最后一件事是一种合理的方法来识别如何调用每个目的地。虽然它们都会被分配一个 IP（基于我们代码中的简单 IPAM 策略），但我们不希望每个测试都必须猜测 IP。为了处理这个问题，我们构建了一个简单的名称解析器。这就像 DNS，但简单得多：对于我们创建的每个“pod”，我们记录一个\u0060name -\u003e IP\u0060的映射，并允许查找 IP。\n\n将所有这些放在一起，一个简单的测试启动了 3 个 pods（客户端、服务器和 ztunnel）在一个单一节点上看起来像这样：\n\n\u0060\u0060\u0060rust\n#[tokio::test] async fn simple_test(){ let ztunnel = manager.deploy_ztunnel(DEFAULT_NODE).await?; let server = manager .workload_builder(\u0022server\u0022, DEFAULT_NODE) .register() .await?; run_tcp_server(server)?; let client = manager .workload_builder(\u0022client\u0022, DEFAULT_NODE) .register() .await?; run_tcp_client(client, manager.resolve(\u0022server\u0022))?; \/\/ ... some assertions here }\n\u0060\u0060\u0060\n\n## 放弃权限\n\n上述设置效果很好，但也带来了一些问题。\n\n基本上设置的每一步都需要提升的 root 权限；这让简单的 \u0060cargo test\u0060 案例的开箱即用变得乏味，通常也不可取。\n\n此外，这会在主机环境中污染大量的命名空间。虽然我们有一些清理过程，但这些并不是 100% 可靠，可能会导致悬挂的命名空间阻碍未来的执行。\n\n解决拥有太多命名空间的问题的方法？更多的命名空间！为此，我们需要的不仅仅是网络命名空间。\n\n[用户命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/user_namespaces.7.html) 允许我们实质上假装是 UID 0 (root)，同时实际上将其映射回我们原始的 UID。这里的力量在于，在该命名空间中，我们可以做一些本来需要 root 权限的事情——特别是创建新的网络命名空间。\n\n然而，我们不能做的一件事是修改主机-root 拥有的文件（这将是明显的权限违规）。尽管我们可能可以绕过它们，但我们在测试中使用的很多工具喜欢触摸 root 文件。这再次可以通过 [mount 命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/mount_namespaces.7.html) 解决，它允许我们将我们拥有的文件绑定挂载到主机-root 拥有的文件上，而不会影响命名空间外的事物。\n\n将所有这些放在一起，我们有这样的东西：\n\n\u0060\u0060\u0060rust\nlet original_uid = get_uid(); \/\/ 首先，进入一个新的用户命名空间。unshare(CloneFlags::CLONE_NEWUSER).unwrap(); \/\/ 将用户命名空间中的 root 映射到我们原始的 UID File::create(\u0022\/proc\/self\/uid_map\u0022).write(format!(\u00220 {original_uid} 1\u0022)); \/\/ 设置一个新的网络命名空间 unshare(CloneFlags::CLONE_NEWNET).unwrap(); \/\/ 设置一个新的挂载命名空间 unshare(CloneFlags::CLONE_NEWNS).unwrap(); \/\/ 将一个文件夹在我们的每个测试目录中挂载到 \/var\/run\/netns mount(tmp_dir.join(\u0022netns\u0022), \u0022\/var\/run\/netns\u0022, MS_BIND); \/\/ 一个方便手动调试的好帮手信息，如果需要的话。let pid = get_pid(); eprintln!(\u0022Starting test in {tmp_dir}. Debug with \u0060sudo nsenter --mount --net -t {pid}\u0060\u0022);\n\u0060\u0060\u0060\n\n如上所述，一个技巧是，进入命名空间是按线程进行的。我们需要在生成任何额外线程之前设置这一点。\n\nRust 实际上为我们提供了这样做的能力，但这意味着我们失去了 \u0060#[tokio::test]\u0060 宏帮助。我们可以写自己的宏，但这有点痛苦。幸运的是，通过 [链接器的花招](https:\/\/crates.io\/crates\/ctor) 我们可以迫使我们的代码在进程执行的非常早期运行。\n\nGo 中的类似方法也有效（请参见 [我写的帮助库](https:\/\/github.com\/howardjohn\/unshare-go)），实际上在那里是必需的，因为设置必须在 Go 运行时启动之前完成（这通常在任何用户代码运行之前很久）。\n\n## 总结\n\n有了所有这些设备，一个完整的测试只需要大约 200 毫秒。一切都在一个单一进程中运行，使调试变得轻而易举。所有的测试也都是完全隔离的，因此可以完全并行运行测试（包括相同的测试，用于压力测试以消除测试缺陷）。\n', '\/trans\/ztunnel-testing\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探讨如何在没有 Kubernetes 环境的情况下测试 Ztunnel 网络代理，该代理为 Istio 的新 Ambient 模式编写。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/categories/istio/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/categories/istio/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/categories/istio/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/categories/istio/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/categories/istio/page/3/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/categories/istio/page/9/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(87)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(21)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(10)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%b7%a5%e5%85%b7" class="sidebar-item">
            <span>工具</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(6)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/kubecon-eu-2025-london-recap/">KubeCon EU 2025 参会报告：塑造云原生格局的洞察与趋势</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/mastering-github-copilot-for-open-source/">探索 GitHub Copilot：当 AI 成为你的贴身编码助手</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/beyond-sidecar/">超越 Sidecar：深入解析 Istio Ambient Mode 的流量机制与成本效益</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnativecn.com" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kcd-beijing-2025/">KCD Beijing 2025 - 提交议题及参会报名</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-community-domain-migration/">云原生社区网站域名变更通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2025 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />










<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
