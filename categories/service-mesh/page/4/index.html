<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>æœåŠ¡ç½‘æ ¼ä¸“æ  Â· Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="æ¬¢è¿æ¥åˆ°æœåŠ¡ç½‘æ ¼ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼æŠ€æœ¯çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€å®‰å…¨ç­–ç•¥å’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æˆ‘ä»¬çš„æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§ã€å¯ç®¡ç†æ€§å’Œå®‰å…¨æ€§ã€‚">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/categories/service-mesh/" />
  <meta property="og:title" content="æœåŠ¡ç½‘æ ¼ä¸“æ  | Jimmy Song" />
  <meta property="twitter:title" content="æœåŠ¡ç½‘æ ¼ä¸“æ  | Jimmy Song" />

  
  <meta property="og:description" content="æ¬¢è¿æ¥åˆ°æœåŠ¡ç½‘æ ¼ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼æŠ€æœ¯çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€å®‰å…¨ç­–ç•¥å’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æˆ‘ä»¬çš„æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§ã€å¯ç®¡ç†æ€§å’Œå®‰å…¨æ€§ã€‚" />
  <meta property="twitter:description" content="æ¬¢è¿æ¥åˆ°æœåŠ¡ç½‘æ ¼ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼æŠ€æœ¯çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€å®‰å…¨ç­–ç•¥å’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æˆ‘ä»¬çš„æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§ã€å¯ç®¡ç†æ€§å’Œå®‰å…¨æ€§ã€‚" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">åšå®¢</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">èµ„æ–™</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">å…¬å‘Š</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">è”ç³»</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">å…³äº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">ç¤¾åŒº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">è§†é¢‘ <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/categories/service-mesh/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>æœç´¢</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">âŒ˜</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>ç«™å†…æœç´¢</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="å…³é—­"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="è¯·è¾“å…¥æœç´¢è¯" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="è¯·è¾“å…¥æœç´¢è¯">
        
        <div class="mt-4">
          <span>æœç´¢ç±»å‹: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">æ‰€æœ‰</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">åŸåˆ›</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">è¯‘æ–‡</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">èµ„æ–™</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">å…¬å‘Š</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    æœåŠ¡ç½‘æ ¼ä¸“æ 
                </p>
                <p class="page-description">
                    æ¬¢è¿æ¥åˆ°æœåŠ¡ç½‘æ ¼ä¸“æ ï¼Œè¿™é‡Œæ˜¯å…³äºæœåŠ¡ç½‘æ ¼æŠ€æœ¯çš„å…¨é¢èµ„æºå’Œæ·±å…¥è§£è¯»ã€‚æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨çš„å„ç§ä¸»é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æµé‡ç®¡ç†ã€å®‰å…¨ç­–ç•¥å’Œå¯è§‚æµ‹æ€§ã€‚æ— è®ºä½ æ˜¯åˆå­¦è€…è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œéƒ½èƒ½åœ¨è¿™é‡Œæ‰¾åˆ°æœ‰ä»·å€¼çš„å†…å®¹ã€‚é€šè¿‡æˆ‘ä»¬çš„æ•™ç¨‹ã€æŒ‡å—å’Œæœ€ä½³å®è·µï¼Œä½ å°†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œæå‡ä½ çš„å¾®æœåŠ¡æ¶æ„çš„å¯é æ€§ã€å¯ç®¡ç†æ€§å’Œå®‰å…¨æ€§ã€‚
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/service-mesh-in-action-by-yangzhangxian-review/">ã€ŠService Mesh å®æˆ˜â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µã€‹è¯»åæ„Ÿ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2019/01/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ã€ŠService Mesh å®æˆ˜â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µã€‹è¯»åæ„Ÿ', 'é¡ºä¾¿å¯¹æ¯”äº†ä¸‹ Linkerd å’Œ Envoyï¼Œç»™è¯»è€…ä¸€äº›æˆ‘è‡ªå·±çš„å»ºè®®ã€‚', '\næœ€è¿‘åœ¨å›é¡¾ Service Mesh æŠ€æœ¯åœ¨ 2018 å¹´çš„å‘å±•ï¼Œæƒ³å†çœ‹çœ‹ Linkerdï¼Œæ­£å¥½**æ¨å½°æ˜¾**çš„è¿™æœ¬ã€ŠService Mesh å®æˆ˜â€”â€”åŸºäº Linkerd å’Œ Kubernetes çš„å¾®æœåŠ¡å®è·µã€‹ä¸Šå¸‚å‘å”®äº†ï¼Œ**æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾**çš„ç¼–è¾‘é€äº†æˆ‘ä¸€æœ¬ï¼ŒğŸ™**æ¨ç¦å·**ç¼–è¾‘ï¼Œæˆ‘çœ‹äº†ä¸‹æŠ½ç©ºå†™äº†ç‚¹è¯»åæ„Ÿï¼Œæˆ‘çœ‹äº†ä¸‹æŠ½ç©ºå†™äº†ç‚¹è¯»åæ„Ÿï¼Œå…¶å®ä¹Ÿè¯´ä¸ä¸Šæ˜¯è¯»åæ„Ÿï¼Œå°±å½“æ˜¯è‡ªå·±çš„ä¸€ç‚¹æ„Ÿæ‚Ÿå§ï¼Œå°±å½“æ‹¿æ­¤ä¹¦å€Ÿé¢˜å‘æŒ¥å§ï¼Œè¿™ä¸ªçŸ¥è¯†çˆ†ç‚¸çš„å¹´ä»£ï¼ŒæŠ€æœ¯å‘å±•å¦‚æ­¤è¿…é€Ÿï¼Œå¯ä»¥è¯´æ˜¯ IT äººå‘˜çš„å¹¸è¿ï¼Œä¹Ÿæ˜¯ä¸å¹¸ï¼æœ‰å¤šå°‘å†™å¼€æºè½¯ä»¶çš„ä¹¦æ¨å‡ºä¸€ç‰ˆåèƒ½æ’‘è¿‡ä¸‰å¹´çš„ï¼Ÿå¦‚æœè½¯ä»¶çº¢å¾—å‘ç´«ï¼ŒæŒç»­è¿­ä»£ N ä¸ªç‰ˆæœ¬ï¼Œä¾‹å¦‚ Kubernetesï¼Œæœ€è¿‘ä¸¤å¹´ä»¥æ¯ä¸‰ä¸ªæœˆä¸€ä¸ªç‰ˆæœ¬çš„é€Ÿåº¦è¿­ä»£ï¼Œä¹‹å‰çš„ä¹¦æ—©å°±è·Ÿä¸ä¸ŠèŠ‚å¥ï¼Œè¦ä¹ˆå°±è¦ä¸æ–­æ¨å‡ºæ–°ç‰ˆï¼Œç›´åˆ°è½¯ä»¶ç¨³å®šåä¸å†æœ‰å¤§çš„æ”¹åŠ¨ã€‚è¿˜æœ‰ç§å¯èƒ½å°±æ˜¯è½¯ä»¶æ¨å¹¿å’Œå‘å±•çš„ä¸ç†æƒ³ï¼Œæ— äººé—®æ´¥ï¼Œå†™è¿™æ ·è½¯ä»¶çš„ä¹¦å°±ä¸ä¼šæœ‰å†ç‰ˆäº†ã€‚\n\næ‹¿åˆ°æœ¬ä¹¦åæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯çœ‹çœ‹è¿™æœ¬ä¹¦å®šç¨¿çš„æ—¶å€™ Istio æ˜¯ä»€ä¹ˆç‰ˆæœ¬ï¼ŒLinkerd åˆæ˜¯ä»€ä¹ˆç‰ˆæœ¬ã€‚å› ä¸ºåœ¨è¿™ä¸€å¹´å†…ä¸¤æ¬¾å¼€æºè½¯ä»¶éƒ½æœ‰è¾ƒå¤§çš„ç‰ˆæœ¬å˜åŠ¨ï¼Œå¦‚æœä¹¦ç±å®šç¨¿çš„æ—¶å€™åŸºäºçš„è½¯ä»¶ç‰ˆæœ¬å¤ªä½ï¼Œè½¯ä»¶æ¶æ„å¯èƒ½ä¼šæœ‰è¾ƒå¤§çš„å˜åŒ–ï¼Œå½±å“ä¹¦ä¸­ç¤ºä¾‹å’Œéƒ¨åˆ†ç« èŠ‚çš„æ—¶æ•ˆæ€§ã€‚è¿™ä¹Ÿæ˜¯å¤§å¤šæŠ€æœ¯ä¹¦ç±åçŸ­çš„ç—‡ç»“æ‰€åœ¨ï¼ŒæŠ€æœ¯å‘å±•æ˜¯åœ¨å¤ªå¿«ï¼Œä¼ ç»Ÿçš„ä¹¦ç±å‡ºç‰ˆæµç¨‹å¾€å¾€è¿‡äºç¹çå’Œå†—é•¿ï¼Œç­‰åˆ°ä¹¦ç±å‡ºç‰ˆåæ‰€ä»‹ç»çš„è½¯ä»¶éƒ½å‡ºäº†å¥½å‡ ä¸ªç‰ˆæœ¬ã€‚ä¾‹å¦‚ Kubernetes è¿™ç§çš„è½¯ä»¶ï¼Œæ¯ä¸‰ä¸ªæœˆä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œå†™ä¸€èˆ¬ä¹¦ä»ç­–åˆ’åˆ°å‘è¡Œå°‘è¯´åŠå¹´ï¼Œä¸€èˆ¬ä¹Ÿè¦ä¸€å¹´çš„æ—¶é—´ã€‚\n\n## å…³äºä¹¦ç±å®šç¨¿æ—¶çš„è½¯ä»¶ç‰ˆæœ¬\n\n**Istio 0.8**\n\næœ¬ä¹¦ç¬¬ä¸€ç« ã€ŒService Mesh ç®€ä»‹ã€å¯¹ Service Mesh ç›¸å…³å¼€æºäº§å“ä»‹ç»æ—¶æåˆ°æœ¬ä¹¦å®šç¨¿æ—¶ Istio æ˜¯ 0.8 ç‰ˆæœ¬ï¼Œè€Œ Istio åœ¨ 2018 å¹´ 7 æœˆ 31 æ—¥å‘å¸ƒäº† 1.0 ç‰ˆæœ¬ã€‚\n\nè¿™æœ¬ä¹¦å®šç¨¿æ—¶ï¼ŒIstio çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.8ã€‚\n\n**Linkerd 1.3.6**\n\næœ¬ä¹¦ä»åºè¨€å¼€å§‹ä¸€ç›´åˆ°ç¬¬äºŒç« ç»“æŸä¹Ÿæ²¡æœ‰æåŠå†™ä½œæ—¶åŸºäºçš„ Linkerd ç‰ˆæœ¬ï¼Œæˆ‘åœ¨ç¬¬äºŒç« çš„å®‰è£…æ­¥éª¤ä¸­çœ‹åˆ°äº†è¯´æ˜ã€‚\n\nå¯ä»¥çœ‹åˆ°æœ¬ä¹¦å†™ä½œæ—¶æ˜¯åŸºäº Linkerd 1.3.6 ç‰ˆæœ¬ï¼Œè€Œ Linkerd åœ¨åŒå¹´çš„ 9 æœˆ 18 æ—¥å‘å¸ƒäº† [2.0 GA](https:\/\/cloudnative.to\/blog\/linkerd-2-0-in-general-availability\/)ï¼Œè¿™ä¸€ç‰ˆæœ¬è·Ÿ 1.x ç‰ˆæœ¬ç›¸æ¯”æœ‰é‡å¤§å˜åŒ–â€”â€”å®ƒè¿˜å°†é¡¹ç›®ä»é›†ç¾¤èŒƒå›´çš„ service mesh è½¬æ¢ä¸ºå¯ç»„åˆçš„ *service sidecar* ï¼Œæ—¨åœ¨ä¸ºå¼€å‘äººå‘˜å’ŒæœåŠ¡æ‰€æœ‰è€…æä¾›åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­æˆåŠŸæ‰€éœ€çš„å…³é”®å·¥å…·ã€‚\n\n## Linkerd vs Envoy\n\nLinkerd 2.0 çš„ service sidecar è®¾è®¡ä½¿å¼€å‘äººå‘˜å’ŒæœåŠ¡æ‰€æœ‰è€…èƒ½å¤Ÿåœ¨ä»–ä»¬çš„æœåŠ¡ä¸Šè¿è¡Œ Linkerdï¼Œæä¾›è‡ªåŠ¨å¯è§‚æµ‹æ€§ã€å¯é æ€§å’Œè¿è¡Œæ—¶è¯Šæ–­ï¼Œè€Œæ— éœ€æ›´æ”¹é…ç½®æˆ–ä»£ç ã€‚é€šè¿‡æä¾›è½»é‡çº§çš„å¢é‡è·¯å¾„æ¥è·å¾—å¹³å°èŒƒå›´çš„é¥æµ‹ã€å®‰å…¨æ€§å’Œå¯é æ€§çš„ä¼ ç»Ÿ service mesh åŠŸèƒ½ï¼Œservice sidecar æ–¹æ³•è¿˜é™ä½äº†å¹³å°æ‰€æœ‰è€…å’Œç³»ç»Ÿæ¶æ„å¸ˆçš„é£é™©ã€‚è¯¥ç‰ˆæœ¬è¿˜ç”¨ Rust é‡å†™äº†ä»£ç†éƒ¨åˆ†ï¼Œåœ¨å»¶è¿Ÿï¼Œååé‡å’Œèµ„æºæ¶ˆè€—æ–¹é¢äº§ç”Ÿäº†æ•°é‡çº§çš„æ”¹è¿›ã€‚\n\nè€Œ Linkerd 1.x ç»§æ‰¿è‡ª Twitter å¼€æºçš„ Finagle é«˜æ€§èƒ½ RPCï¼Œæ‰€æœ‰æƒ³è¦æ·±åº¦å­¦ä¹  Linkerd 1.x è¿˜éœ€è¦äº†è§£ Finagleï¼Œè¿™å°±è·Ÿ Istio å°† Envoy ä½œä¸ºé»˜è®¤çš„æ•°æ®å¹³é¢ä¸€æ ·ï¼Œè¦æƒ³æ·±åº¦å­¦ä¹  Istio å¿…é¡»äº†è§£ Envoyã€‚\n\näºŒè€…å‡ ä¹ä½¿ç”¨äº†å®Œå…¨ä¸åŒçš„æœ¯è¯­ï¼Œå‡å¦‚ä½ å·²ç»äº†è§£äº† [Envoy](https:\/\/envoyproxy.io) æƒ³è¦å†åˆ‡æ¢åˆ° Linkerd ä¸Šï¼Œé‚£ä¹ˆå°±è¦å†è´¹å¾ˆå¤šå¿ƒåŠ›æ¥å­¦ä¹ å®ƒçš„æ¦‚å¿µå’ŒåŸç†ï¼Œä¾‹å¦‚å¦‚ä¸‹è¿™äº›æœ¯è¯­æˆ–é…ç½®ï¼ˆLinkerd ä¸­ç‹¬æœ‰çš„é…ç½®ï¼‰ï¼š\n\n- **dtabï¼ˆå§”æ‰˜è¡¨ï¼‰**ï¼šç”±ä¸€ç³»åˆ—è·¯ç”±ç»„æˆï¼Œç”±ä¸€ç³»åˆ—è·¯ç”±è§„åˆ™ç»„æˆï¼Œä»¥é€»è¾‘è·¯å¾„ä¸ºè¾“å…¥ï¼Œç„¶åç»è¿‡è·¯ç”±è§„åˆ™åšä¸€ç³»åˆ—è½¬æ¢ç”Ÿæˆå…·ä½“åå­—ã€‚è¿™æ˜¯ Linkerd è·¯ç”±æœºåˆ¶çš„æ ¹æœ¬ï¼Œå°±åƒ Envoy ä¸­çš„ [xDS åè®®](https:\/\/jimmysong.io\/istio-handbook\/data-plane\/envoy-xds.html)ä¸€æ ·ï¼Œæœ¬ä¹¦çš„ç¬¬å››ç« ã€Œæ·±å…¥ Linkerd æ•°æ®è®¿é—®æµã€ä¸“é—¨è®²è§£äº† dtab çš„å®ç°æœºåˆ¶ã€‚\n- **dentryï¼ˆå§”æ‰˜è¡¨è®°å½•ï¼‰**ï¼šå§”æ‰˜è¡¨çš„æ¯æ¡è·¯ç”±è§„åˆ™ç§°ä¸º dentryï¼Œå¦‚ \/consul =\u003e \/#\/io.l5d.consul\/dc1ã€‚\n- **namer**ï¼šé…ç½® Linkerd æ”¯æŒçš„æœåŠ¡å‘ç°å·¥å…·ã€‚\n- **namerd**ï¼šLinkerd çš„æ§åˆ¶å¹³é¢ï¼Œç›¸å½“äº Istio ä¸­çš„ Pilotï¼Œå¯¹æ¥å„ç§æœåŠ¡å‘ç°ã€‚å½“ç„¶ Linkerd ä¹Ÿå¯ä»¥ç›´æ¥ä¸æŸä¸ªæœåŠ¡å‘ç°å¹³å°å¯¹æ¥å¦‚ consulï¼Œè€Œä¸ä½¿ç”¨ namerd è¿™ä¸ªé›†ä¸­è·¯ç”±å’Œé…ç½®ç®¡ç†ç»„ä»¶ã€‚\n- **interpreter**ï¼šinterpreter å†³å®šå¦‚ä½•è§£ææœåŠ¡åå­—å’Œå®¢æˆ·ç«¯åå­—ã€‚\n\nè™½ç„¶ Linkerd ä¹Ÿæ˜¯ [CNCF ä¸­çš„é¡¹ç›®](https:\/\/www.cncf.io\/projects\/)ï¼Œä½†å®ƒç›®å‰è¿˜å¤„äºå­µåŒ–é˜¶æ®µï¼Œè€Œ Envoy çš„ [xDS åè®®](https:\/\/jimmysong.io\/istio-handbook\/data-plane\/envoy-xds.html)å·²ç»è¢«ä¼—å¤šå¼€æºé¡¹ç›®æ‰€æ”¯æŒï¼Œå¦‚ [Istio](https:\/\/istio.io\/zh)ã€[SOFAMesh](https:\/\/github.com\/alipay\/sofa-mesh)ã€[NginxMesh](https:\/\/github.com\/nginxinc\/nginmesh) ç­‰ï¼Œä¸” Envoy å·²ç»ä» CNCF ä¸­æ¯•ä¸šï¼Œä»¥åå¯èƒ½æˆä¸º Service Mesh é¢†åŸŸçš„æ ‡å‡†åè®®ï¼ŒLinkerd çš„ç”Ÿå­˜çŠ¶å†µå ªå¿§ã€‚\n\n## å…³äºæœ¬ä¹¦\n\næœ¬ä¹¦ä¸­æ‰€æœ‰ç¤ºä¾‹éƒ½æä¾›äº†è™šæ‹Ÿæœºçš„å¿«é€Ÿä¸Šæ‰‹ç¯å¢ƒï¼Œåªè¦ä½¿ç”¨ Vagrant å³å¯åˆ›å»ºè™šæ‹Ÿæœºå’Œåº”ç”¨ï¼Œæ‰€ä»¥åœ¨æœ¬ä¹¦çš„[ç¤ºä¾‹ä»£ç ](https:\/\/github.com\/yangzhares\/linkerd-in-action)æœ‰å¤§é‡çš„ Vagrantfileã€‚\n\næœ¬ä¹¦ç¬¬ä¸‰éƒ¨åˆ†ã€Œå®æˆ˜ç¯‡ã€èŠ±äº†å¤§é‡ç¯‡å¹…ï¼ˆæœ¬ä¹¦ä¸€åŠçš„é¡µæ•°ï¼‰æ¥è®²è§£å¦‚ä½•ä½¿ç”¨ Linkerd å’Œ Kubernetes æ¥ç®¡ç†å¾®æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒæˆ‘ 2017 å¹´ 8 æœˆ 1 æ—¥å†™çš„è¿™ç¯‡[å¾®æœåŠ¡ç®¡ç†æ¡†æ¶ service meshâ€”â€”Linkerd å®‰è£…è¯•ç”¨ç¬”è®°](https:\/\/jimmysong.io\/posts\/linkerd-user-guide\/)ï¼Œé‚£æ—¶å€™è¿˜æ˜¯åŸºäº Linkerd 1.1.2ï¼Œè¿˜æœ‰ [Linkerd å®˜æ–¹ç¤ºä¾‹](https:\/\/github.com\/linkerd\/linkerd-examples\/)ï¼Œè¿™äº›ç¤ºä¾‹åŸºæœ¬éƒ½ä¸æ€ä¹ˆæ›´æ–°äº†ã€‚\n\nå› ä¸ºè¯¥ä¹¦å®šç¨¿æ—¶æ‰€åŸºäºçš„ Linkerd ç‰ˆæœ¬è·ç¦»æœ¬ä¹¦å‘å”®æ—¶çš„ Linkerd å·²ç»è½åä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼ˆæœ€æ–°ç‰ˆæœ¬æ˜¯ [Linkerd 2.1](https:\/\/blog.linkerd.io\/2018\/12\/06\/announcing-linkerd-2-1\/)ï¼‰ï¼Œæ‰€ä»¥è¯»è€…ä¸€å®šè¦æ³¨æ„è¿™ä¸€ç‚¹ï¼Œè€å®è¯´æˆ‘åªèŠ±äº†ä¸¤ä¸ªå¤œæ™šå¿«é€Ÿè¿‡äº†ä¸€ä¸‹æœ¬ä¹¦ï¼Œæ— æ³•å¯¹æœ¬ä¹¦å†…å®¹ç»™å‡ºå…·ä½“è¯„è®ºï¼Œæ‰€ä»¥æœ¬ä¹¦æ˜¯å¦æ˜¯ä½ æ‰€éœ€è¦çš„å°±è¦ä½ è‡ªå·±å»æ€è€ƒäº†ã€‚\n\n', '\/blog\/service-mesh-in-action-by-yangzhangxian-review\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">é¡ºä¾¿å¯¹æ¯”äº†ä¸‹ Linkerd å’Œ Envoyï¼Œç»™è¯»è€…ä¸€äº›æˆ‘è‡ªå·±çš„å»ºè®®ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-sidecar-routing-of-istio-service-mesh-deep-dive/">ç†è§£ Istio Service Mesh ä¸­ Envoy Sidecar ä»£ç†çš„è·¯ç”±è½¬å‘</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/12/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ç†è§£ Istio Service Mesh ä¸­ Envoy Sidecar ä»£ç†çš„è·¯ç”±è½¬å‘', 'Sidecar proxy ä¸­ Indbound\/Outbound æµé‡å¤„ç†è¿‡ç¨‹è¯¦è§£ã€‚', '\næœ¬æ–‡ä»¥ Istio å®˜æ–¹çš„ [bookinfo ç¤ºä¾‹](https:\/\/preliminary.istio.io\/zh\/docs\/examples\/bookinfo)æ¥è®²è§£åœ¨è¿›å…¥ Pod çš„æµé‡è¢« iptables è½¬äº¤ç»™ Envoy sidecar åï¼ŒEnvoy æ˜¯å¦‚ä½•åšè·¯ç”±è½¬å‘çš„ï¼Œè¯¦è¿°äº† Inbound å’Œ Outbound å¤„ç†è¿‡ç¨‹ã€‚å…³äºæµé‡æ‹¦æˆªçš„è¯¦ç»†åˆ†æè¯·å‚è€ƒ[ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ](https:\/\/jimmysong.io\/posts\/envoy-sidecar-injection-in-istio-service-mesh-deep-dive\/)ã€‚\n\nä¸‹é¢æ˜¯ Istio å®˜æ–¹æä¾›çš„ bookinfo çš„è¯·æ±‚æµç¨‹å›¾ï¼Œå‡è®¾ bookinfo åº”ç”¨çš„æ‰€æœ‰æœåŠ¡ä¸­æ²¡æœ‰é…ç½® DestinationRuleã€‚\n\n![Bookinfo ç¤ºä¾‹](006tNbRwgy1fvlwjd3302j31bo0ro0x5.jpg)\n\nä¸‹é¢æ˜¯ Istio è‡ªèº«ç»„ä»¶ä¸ Bookinfo ç¤ºä¾‹çš„è¿æ¥å…³ç³»å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ HTTP è¿æ¥éƒ½åœ¨ 9080 ç«¯å£ç›‘å¬ã€‚\n\n![Bookinfo ç¤ºä¾‹ä¸ Istio ç»„ä»¶è¿æ¥å…³ç³»å›¾](006tNbRwly1fyitp0jsghj31o70u0x6p.jpg)\n\n\nå¯ä»¥åœ¨ [Google Drive](https:\/\/drive.google.com\/open?id=19ed3_tkjf6RgGboxllMdt_Ytd5_cocib) ä¸Šä¸‹è½½åŸå›¾ã€‚\n\n## Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒæ­¥éª¤æ¦‚è¿°\n\nä¸‹é¢æ˜¯ä» Sidecar æ³¨å…¥ã€Pod å¯åŠ¨åˆ° Sidecar proxy æ‹¦æˆªæµé‡åŠ Envoy å¤„ç†è·¯ç”±çš„æ­¥éª¤æ¦‚è§ˆã€‚\n\n**1.** Kubernetes é€šè¿‡ Admission Controller è‡ªåŠ¨æ³¨å…¥ï¼Œæˆ–è€…ç”¨æˆ·ä½¿ç”¨ \u0060istioctl\u0060 å‘½ä»¤æ‰‹åŠ¨æ³¨å…¥ sidecar å®¹å™¨ã€‚\n\n**2.** åº”ç”¨ YAML é…ç½®éƒ¨ç½²åº”ç”¨ï¼Œæ­¤æ—¶ Kubernetes API server æ¥æ”¶åˆ°çš„æœåŠ¡åˆ›å»ºé…ç½®æ–‡ä»¶ä¸­å·²ç»åŒ…å«äº† Init å®¹å™¨åŠ sidecar proxyã€‚\n\n**3.** åœ¨ sidecar proxy å®¹å™¨å’Œåº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œé¦–å…ˆè¿è¡Œ Init å®¹å™¨ï¼ŒInit å®¹å™¨ç”¨äºè®¾ç½® iptablesï¼ˆIstio ä¸­é»˜è®¤çš„æµé‡æ‹¦æˆªæ–¹å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ BPFã€IPVS ç­‰æ–¹å¼ï¼‰å°†è¿›å…¥ pod çš„æµé‡åŠ«æŒåˆ° Envoy sidecar proxyã€‚æ‰€æœ‰ TCP æµé‡ï¼ˆEnvoy ç›®å‰åªæ”¯æŒ TCP æµé‡ï¼‰å°†è¢« sidecar åŠ«æŒï¼Œå…¶ä»–åè®®çš„æµé‡å°†æŒ‰åŸæ¥çš„ç›®çš„åœ°è¯·æ±‚ã€‚\n\n**4.** å¯åŠ¨ Pod ä¸­çš„ Envoy sidecar proxy å’Œåº”ç”¨ç¨‹åºå®¹å™¨ã€‚è¿™ä¸€æ­¥çš„è¿‡ç¨‹è¯·å‚è€ƒ[é€šè¿‡ç®¡ç†æ¥å£è·å–å®Œæ•´é…ç½®](https:\/\/zhaohuabing.com\/post\/2018-09-25-istio-traffic-management-impl-intro\/#%E9%80%9A%E8%BF%87%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE)ã€‚\n\n\u003e **Sidecar proxy ä¸åº”ç”¨å®¹å™¨çš„å¯åŠ¨é¡ºåºé—®é¢˜**\n\u003e\n\u003e å¯åŠ¨ sidecar proxy å’Œåº”ç”¨å®¹å™¨ï¼Œç©¶ç«Ÿå“ªä¸ªå®¹å™¨å…ˆå¯åŠ¨å‘¢ï¼Ÿæ­£å¸¸æƒ…å†µæ˜¯ Envoy Sidecar å’Œåº”ç”¨ç¨‹åºå®¹å™¨å…¨éƒ¨å¯åŠ¨å®Œæˆåå†å¼€å§‹æ¥æ”¶æµé‡è¯·æ±‚ã€‚ä½†æ˜¯æˆ‘ä»¬æ— æ³•é¢„æ–™å“ªä¸ªå®¹å™¨ä¼šå…ˆå¯åŠ¨ï¼Œé‚£ä¹ˆå®¹å™¨å¯åŠ¨é¡ºåºæ˜¯å¦ä¼šå¯¹ Envoy åŠ«æŒæµé‡æœ‰å½±å“å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä¸è¿‡åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µã€‚\n\u003e\n\u003e **æƒ…å†µ 1ï¼šåº”ç”¨å®¹å™¨å…ˆå¯åŠ¨ï¼Œè€Œ sidecar proxy ä»æœªå°±ç»ª**\n\u003e\n\u003e è¿™ç§æƒ…å†µä¸‹ï¼Œæµé‡è¢« iptables è½¬ç§»åˆ° 15001 ç«¯å£ï¼Œè€Œ Pod ä¸­æ²¡æœ‰ç›‘å¬è¯¥ç«¯å£ï¼ŒTCP é“¾æ¥å°±æ— æ³•å»ºç«‹ï¼Œè¯·æ±‚å¤±è´¥ã€‚\n\u003e\n\u003e **æƒ…å†µ 2ï¼šSidecar å…ˆå¯åŠ¨ï¼Œè¯·æ±‚åˆ°è¾¾è€Œåº”ç”¨ç¨‹åºä»æœªå°±ç»ª**\n\u003e\n\u003e è¿™ç§æƒ…å†µä¸‹è¯·æ±‚ä¹Ÿè‚¯å®šä¼šå¤±è´¥ï¼Œè‡³äºæ˜¯åœ¨å“ªä¸€æ­¥å¼€å§‹å¤±è´¥çš„ï¼Œç•™ç»™è¯»è€…æ¥æ€è€ƒã€‚\n\n**é—®é¢˜**ï¼šå¦‚æœä¸º sidecar proxy å’Œåº”ç”¨ç¨‹åºå®¹å™¨æ·»åŠ [å°±ç»ªå’Œå­˜æ´»æ¢é’ˆ](https:\/\/jimmysong.io\/kubernetes-handbook\/guide\/configure-liveness-readiness-probes.html)æ˜¯å¦å¯ä»¥è§£å†³è¯¥é—®é¢˜å‘¢ï¼Ÿ\n\n**5.** ä¸è®ºæ˜¯è¿›å…¥è¿˜æ˜¯ä» Pod å‘å‡ºçš„ TCP è¯·æ±‚éƒ½ä¼šè¢« iptables åŠ«æŒï¼Œinbound æµé‡è¢«åŠ«æŒåç» Inbound Handler å¤„ç†åè½¬äº¤ç»™åº”ç”¨ç¨‹åºå®¹å™¨å¤„ç†ï¼Œoutbound æµé‡è¢« iptables åŠ«æŒåè½¬äº¤ç»™ Outbound Handler å¤„ç†ï¼Œå¹¶ç¡®å®šè½¬å‘çš„ upstream å’Œ Endpointã€‚\n\n**6.** Sidecar proxy è¯·æ±‚ Pilot ä½¿ç”¨ xDS åè®®åŒæ­¥ Envoy é…ç½®ï¼Œå…¶ä¸­åŒ…æ‹¬ LDSã€EDSã€CDS ç­‰ï¼Œä¸è¿‡ä¸ºäº†ä¿è¯æ›´æ–°çš„é¡ºåºï¼ŒEnvoy ä¼šç›´æ¥ä½¿ç”¨ ADS å‘ Pilot è¯·æ±‚é…ç½®æ›´æ–°ã€‚\n\n## Envoy å¦‚ä½•å¤„ç†è·¯ç”±è½¬å‘\n\n ä¸‹å›¾å±•ç¤ºçš„æ˜¯ \u0060productpage\u0060 æœåŠ¡è¯·æ±‚è®¿é—® \u0060http:\/\/reviews.default.svc.cluster.local:9080\/\u0060ï¼Œå½“æµé‡è¿›å…¥ \u0060reviews\u0060 æœåŠ¡å†…éƒ¨æ—¶ï¼Œ\u0060reviews\u0060 æœåŠ¡å†…éƒ¨çš„ Envoy Sidecar æ˜¯å¦‚ä½•åšæµé‡æ‹¦æˆªå’Œè·¯ç”±è½¬å‘çš„ã€‚å¯ä»¥åœ¨ [Google Drive](https:\/\/drive.google.com\/file\/d\/1n-h235tm8DnL_RqxTTA95rgGtrLkBsyr\/view?usp=sharing) ä¸Šä¸‹è½½åŸå›¾ã€‚\n\n![Envoy sidecar æµé‡åŠ«æŒä¸è·¯ç”±è½¬å‘ç¤ºæ„å›¾](envoy-sidecar-traffic-interception-zh-20210818.png)\n\n\nç¬¬ä¸€æ­¥å¼€å§‹æ—¶ï¼Œ\u0060productpage\u0060 Pod ä¸­çš„ Envoy sidecar å·²ç»é€šè¿‡ EDS é€‰æ‹©å‡ºäº†è¦è¯·æ±‚çš„ \u0060reviews\u0060 æœåŠ¡çš„ä¸€ä¸ª Podï¼ŒçŸ¥æ™“äº†å…¶ IP åœ°å€ï¼Œå‘é€ TCP è¿æ¥è¯·æ±‚ã€‚\n\nIstio å®˜ç½‘ä¸­çš„ Envoy é…ç½®æ·±åº¦è§£æä¸­æ˜¯ä»¥å‘èµ· HTTP è¯·æ±‚çš„ä¸€æ–¹æ¥è¯¦è¿° Envoy åšæµé‡è½¬å‘çš„è¿‡ç¨‹ï¼Œè€Œæœ¬æ–‡ä¸­è€ƒè™‘çš„æ˜¯æ¥å— downstream çš„æµé‡çš„ä¸€æ–¹ï¼Œå®ƒæ—¢è¦æ¥æ”¶ downstream å‘æ¥çš„è¯·æ±‚ï¼Œè‡ªå·±è¿˜éœ€è¦è¯·æ±‚å…¶ä»–æœåŠ¡ï¼Œä¾‹å¦‚ \u0060reviews\u0060 æœåŠ¡ä¸­çš„ Pod è¿˜éœ€è¦è¯·æ±‚ \u0060ratings\u0060 æœåŠ¡ã€‚\n\n\u0060reviews\u0060 æœåŠ¡æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä¸‰ä¸ªç‰ˆæœ¬ä¸­çš„ sidecar å·¥ä½œæ­¥éª¤ç±»ä¼¼ï¼Œä¸‹æ–‡åªä»¥ \u0060reviews-v1-cb8655c75-b97zc\u0060 è¿™ä¸€ä¸ª Pod ä¸­çš„ Sidecar æµé‡è½¬å‘æ­¥éª¤æ¥è¯´æ˜ã€‚\n\n## ç†è§£ Inbound Handler\n\nInbound handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„ downstream çš„æµé‡è½¬äº¤ç»™ localhostï¼Œä¸ Pod å†…çš„åº”ç”¨ç¨‹åºå®¹å™¨å»ºç«‹è¿æ¥ã€‚\n\næŸ¥çœ‹ä¸‹ \u0060reviews-v1-cb8655c75-b97zc\u0060 pod ä¸­çš„ Listenerã€‚\n\nè¿è¡Œ \u0060istioctl pc listener reviews-v1-cb8655c75-b97zc\u0060 æŸ¥çœ‹è¯¥ Pod ä¸­çš„å…·æœ‰å“ªäº› Listenerã€‚\n\n\u0060\u0060\u0060ini\nADDRESS            PORT      TYPE \n172.33.3.3         9080      HTTP \u003c--- æ¥æ”¶æ‰€æœ‰ Inbound HTTP æµé‡ï¼Œè¯¥åœ°å€å³ä¸ºå½“å‰ Pod çš„ IP åœ°å€\n10.254.0.1         443       TCP  \u003c--\u002b\n10.254.4.253       80        TCP     |\n10.254.4.253       8080      TCP     |\n10.254.109.182     443       TCP     |\n10.254.22.50       15011     TCP     |\n10.254.22.50       853       TCP     |\n10.254.79.114      443       TCP     | \n10.254.143.179     15011     TCP     |\n10.254.0.2         53        TCP     | æ¥æ”¶ä¸ 0.0.0.0_15001 ç›‘å¬å™¨é…å¯¹çš„ Outbound é HTTP æµé‡\n10.254.22.50       443       TCP     |\n10.254.16.64       42422     TCP     |\n10.254.127.202     16686     TCP     |\n10.254.22.50       31400     TCP     |\n10.254.22.50       8060      TCP     |\n10.254.169.13      14267     TCP     |\n10.254.169.13      14268     TCP     |\n10.254.32.134      8443      TCP     |\n10.254.118.196     443       TCP  \u003c--\u002b\n0.0.0.0            15004     HTTP \u003c--\u002b\n0.0.0.0            8080      HTTP    |\n0.0.0.0            15010     HTTP    | \n0.0.0.0            8088      HTTP    |\n0.0.0.0            15031     HTTP    |\n0.0.0.0            9090      HTTP    | \n0.0.0.0            9411      HTTP    | æ¥æ”¶ä¸ 0.0.0.0_15001 é…å¯¹çš„ Outbound HTTP æµé‡\n0.0.0.0            80        HTTP    |\n0.0.0.0            15030     HTTP    |\n0.0.0.0            9080      HTTP    |\n0.0.0.0            9093      HTTP    |\n0.0.0.0            3000      HTTP    |\n0.0.0.0            8060      HTTP    |\n0.0.0.0            9091      HTTP \u003c--\u002b    \n0.0.0.0            15001     TCP  \u003c--- æ¥æ”¶æ‰€æœ‰ç» iptables æ‹¦æˆªçš„ Inbound å’Œ Outbound æµé‡å¹¶è½¬äº¤ç»™è™šæ‹Ÿç›‘å¬å™¨å¤„ç†\n\u0060\u0060\u0060\n\nå½“æ¥è‡ª \u0060productpage\u0060 çš„æµé‡æŠµè¾¾ \u0060reviews\u0060 Pod çš„æ—¶å€™å·²ç»ï¼Œdownstream å¿…é¡»æ˜ç¡®çŸ¥é“ Pod çš„ IP åœ°å€ä¸º \u0060172.33.3.3\u0060 æ‰€ä»¥æ‰ä¼šè®¿é—®è¯¥ Podï¼Œæ‰€ä»¥è¯¥è¯·æ±‚æ˜¯ \u0060172.33.3.3:9080\u0060ã€‚\n\n**\u0060virtual\u0060 Listener**\n\nä»è¯¥ Pod çš„ Listener åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ0.0.0.0:15001\/TCP çš„ Listenerï¼ˆå…¶å®é™…åå­—æ˜¯ \u0060virtual\u0060ï¼‰ç›‘å¬æ‰€æœ‰çš„ Inbound æµé‡ï¼Œä¸‹é¢æ˜¯è¯¥ Listener çš„è¯¦ç»†é…ç½®ã€‚\n\n\u0060\u0060\u0060json\n{\n    \u0022name\u0022: \u0022virtual\u0022,\n    \u0022address\u0022: {\n        \u0022socketAddress\u0022: {\n            \u0022address\u0022: \u00220.0.0.0\u0022,\n            \u0022portValue\u0022: 15001\n        }\n    },\n    \u0022filterChains\u0022: [\n        {\n            \u0022filters\u0022: [\n                {\n                    \u0022name\u0022: \u0022envoy.tcp_proxy\u0022,\n                    \u0022config\u0022: {\n                        \u0022cluster\u0022: \u0022BlackHoleCluster\u0022,\n                        \u0022stat_prefix\u0022: \u0022BlackHoleCluster\u0022\n                    }\n                }\n            ]\n        }\n    ],\n    \u0022useOriginalDst\u0022: true\n}\n\u0060\u0060\u0060\n\n**UseOriginalDst**ï¼šä»é…ç½®ä¸­å¯ä»¥çœ‹å‡º \u0060useOriginalDst\u0060 é…ç½®æŒ‡å®šä¸º \u0060true\u0060ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç¼ºçœä¸º falseï¼Œä½¿ç”¨ iptables é‡å®šå‘è¿æ¥æ—¶ï¼Œproxy æ¥æ”¶çš„ç«¯å£å¯èƒ½ä¸åŸå§‹ç›®çš„åœ°å€çš„ç«¯å£ä¸ä¸€æ ·ï¼Œå¦‚æ­¤å¤„ proxy æ¥æ”¶çš„ç«¯å£ä¸º 15001ï¼Œè€ŒåŸå§‹ç›®çš„åœ°ç«¯å£ä¸º 9080ã€‚å½“æ­¤æ ‡å¿—è®¾ç½®ä¸º true æ—¶ï¼ŒListener å°†è¿æ¥é‡å®šå‘åˆ°ä¸åŸå§‹ç›®çš„åœ°å€å…³è”çš„ Listenerï¼Œæ­¤å¤„ä¸º \u0060172.33.3.3:9080\u0060ã€‚å¦‚æœæ²¡æœ‰ä¸åŸå§‹ç›®çš„åœ°å€å…³è”çš„ Listenerï¼Œåˆ™è¿æ¥ç”±æ¥æ”¶å®ƒçš„ Listener å¤„ç†ï¼Œå³è¯¥ \u0060virtual\u0060 Listenerï¼Œç»è¿‡ \u0060envoy.tcp_proxy\u0060 è¿‡æ»¤å™¨å¤„ç†è½¬å‘ç»™ \u0060BlackHoleCluster\u0060ï¼Œè¿™ä¸ª Cluster çš„ä½œç”¨æ­£å¦‚å®ƒçš„åå­—ï¼Œå½“ Envoy æ‰¾ä¸åˆ°åŒ¹é…çš„è™šæ‹Ÿç›‘å¬å™¨æ—¶ï¼Œå°±ä¼šå°†è¯·æ±‚å‘é€ç»™å®ƒï¼Œå¹¶è¿”å› 404ã€‚è¿™ä¸ªå°†äºä¸‹æ–‡æåˆ°çš„ Listener ä¸­è®¾ç½® \u0060bindToPort\u0060 ç›¸å‘¼åº”ã€‚\n\n**æ³¨æ„**ï¼šè¯¥å‚æ•°å°†è¢«åºŸå¼ƒï¼Œè¯·ä½¿ç”¨åŸå§‹ç›®çš„åœ°å€çš„ Listener filter æ›¿ä»£ã€‚è¯¥å‚æ•°çš„ä¸»è¦ç”¨é€”æ˜¯ï¼šEnvoy é€šè¿‡ç›‘å¬ 15001 ç«¯å£å°† iptables æ‹¦æˆªçš„æµé‡ç»ç”±å…¶ä»– Listener å¤„ç†è€Œä¸æ˜¯ç›´æ¥è½¬å‘å‡ºå»ï¼Œè¯¦æƒ…è§ [Virtual Listener](https:\/\/zhaohuabing.com\/post\/2018-09-25-istio-traffic-management-impl-intro\/#virtual-listener)ã€‚\n\n**Listener 172.33.3.3_9080**\n\nä¸Šæ–‡è¯´åˆ°è¿›å…¥ Inbound handler çš„æµé‡è¢« \u0060virtual\u0060 Listener è½¬ç§»åˆ° \u0060172.33.3.3_9080\u0060 Listenerï¼Œæˆ‘ä»¬åœ¨æŸ¥çœ‹ä¸‹è¯¥ Listener é…ç½®ã€‚\n\nè¿è¡Œ \u0060istioctl pc listener reviews-v1-cb8655c75-b97zc --address 172.33.3.3 --port 9080 -o json\u0060 æŸ¥çœ‹ã€‚\n\n\u0060\u0060\u0060json\n[{\n    \u0022name\u0022: \u0022172.33.3.3_9080\u0022,\n    \u0022address\u0022: {\n        \u0022socketAddress\u0022: {\n            \u0022address\u0022: \u0022172.33.3.3\u0022,\n            \u0022portValue\u0022: 9080\n        }\n    },\n    \u0022filterChains\u0022: [\n        {\n            \u0022filterChainMatch\u0022: {\n                \u0022transportProtocol\u0022: \u0022raw_buffer\u0022\n            },\n            \u0022filters\u0022: [\n                {\n                    \u0022name\u0022: \u0022envoy.http_connection_manager\u0022,\n                    \u0022config\u0022: {\n                        ... \n                        \u0022route_config\u0022: {\n                            \u0022name\u0022: \u0022inbound|9080||reviews.default.svc.cluster.local\u0022,\n                            \u0022validate_clusters\u0022: false,\n                            \u0022virtual_hosts\u0022: [\n                                {\n                                    \u0022domains\u0022: [\n                                        \u0022*\u0022\n                                    ],\n                                    \u0022name\u0022: \u0022inbound|http|9080\u0022,\n                                    \u0022routes\u0022: [\n                                        {\n                                            ...\n                                            \u0022route\u0022: {\n                                                \u0022cluster\u0022: \u0022inbound|9080||reviews.default.svc.cluster.local\u0022,\n                                                \u0022max_grpc_timeout\u0022: \u00220.000s\u0022,\n                                                \u0022timeout\u0022: \u00220.000s\u0022\n                                            }\n                                        }\n                                    ]\n                                }\n                            ]\n                        },\n                        \u0022use_remote_address\u0022: false,\n                        ...\n                    }\n                }\n            ]ï¼Œ\n            \u0022deprecatedV1\u0022: {\n                \u0022bindToPort\u0022: false\n            }\n        ...\n        },\n        {\n            \u0022filterChainMatch\u0022: {\n                \u0022transportProtocol\u0022: \u0022tls\u0022\n            },\n            \u0022tlsContext\u0022: {...\n            },\n            \u0022filters\u0022: [...\n            ]\n        }\n    ],\n...\n}]\n\u0060\u0060\u0060\n\n**bindToPort**ï¼šæ³¨æ„å…¶ä¸­æœ‰ä¸€ä¸ª [\u0060bindToPort\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.6.0\/api-v1\/listeners\/listeners) çš„é…ç½®ï¼Œå…¶å€¼ä¸º \u0060false\u0060ï¼Œè¯¥é…ç½®çš„ç¼ºçœå€¼ä¸º \u0060true\u0060ï¼Œè¡¨ç¤ºå°† Listener ç»‘å®šåˆ°ç«¯å£ä¸Šï¼Œæ­¤å¤„è®¾ç½®ä¸º \u0060false\u0060 åˆ™è¯¥ Listener åªèƒ½å¤„ç†å…¶ä»– Listener è½¬ç§»è¿‡æ¥çš„æµé‡ï¼Œå³ä¸Šæ–‡æ‰€è¯´çš„ \u0060virtual\u0060 Listenerï¼Œæˆ‘ä»¬çœ‹å…¶ä¸­çš„ filterChains.filters ä¸­çš„ \u0060envoy.http_connection_manager\u0060 é…ç½®éƒ¨åˆ†ï¼š\n\n\u0060\u0060\u0060json\n\u0022route_config\u0022: {\n                            \u0022name\u0022: \u0022inbound|9080||reviews.default.svc.cluster.local\u0022,\n                            \u0022validate_clusters\u0022: false,\n                            \u0022virtual_hosts\u0022: [\n                                {\n                                    \u0022domains\u0022: [\n                                        \u0022*\u0022\n                                    ],\n                                    \u0022name\u0022: \u0022inbound|http|9080\u0022,\n                                    \u0022routes\u0022: [\n                                        {\n                                            ...\n                                            \u0022route\u0022: {\n                                                \u0022cluster\u0022: \u0022inbound|9080||reviews.default.svc.cluster.local\u0022,\n                                                \u0022max_grpc_timeout\u0022: \u00220.000s\u0022,\n                                                \u0022timeout\u0022: \u00220.000s\u0022\n                                            }\n                                        }\n                                    ]\n                                }\n                            ]\n                        }\n\u0060\u0060\u0060\n\nè¯¥é…ç½®è¡¨ç¤ºæµé‡å°†è½¬äº¤ç»™ Cluster \u0060inbound|9080||reviews.default.svc.cluster.local\u0060 å¤„ç†ã€‚\n\n**Cluster \u0060inbound|9080||reviews.default.svc.cluster.local\u0060**\n\nè¿è¡Œ \u0060istioctl pc cluster reviews-v1-cb8655c75-b97zc --fqdn reviews.default.svc.cluster.local --direction inbound -o json\u0060 æŸ¥çœ‹è¯¥ Cluster çš„é…ç½®å¦‚ä¸‹ã€‚\n\n\u0060\u0060\u0060json\n[\n    {\n        \u0022name\u0022: \u0022inbound|9080||reviews.default.svc.cluster.local\u0022,\n        \u0022connectTimeout\u0022: \u00221.000s\u0022,\n        \u0022hosts\u0022: [\n            {\n                \u0022socketAddress\u0022: {\n                    \u0022address\u0022: \u0022127.0.0.1\u0022,\n                    \u0022portValue\u0022: 9080\n                }\n            }\n        ],\n        \u0022circuitBreakers\u0022: {\n            \u0022thresholds\u0022: [\n                {}\n            ]\n        }\n    }\n]\n\u0060\u0060\u0060\n\nå¯ä»¥çœ‹åˆ°è¯¥ Cluster çš„ Endpoint ç›´æ¥å¯¹åº”çš„å°±æ˜¯ localhostï¼Œå†ç»è¿‡ iptables è½¬å‘æµé‡å°±è¢«åº”ç”¨ç¨‹åºå®¹å™¨æ¶ˆè´¹äº†ã€‚\n\n## ç†è§£ Outbound Handler\n\nå› ä¸º \u0060reviews\u0060 ä¼šå‘ \u0060ratings\u0060 æœåŠ¡å‘é€ HTTP è¯·æ±‚ï¼Œè¯·æ±‚çš„åœ°å€æ˜¯ï¼š\u0060http:\/\/ratings.default.svc.cluster.local:9080\/\u0060ï¼ŒOutbound handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„æœ¬åœ°åº”ç”¨ç¨‹åºå‘å‡ºçš„æµé‡ï¼Œç»ç”± Envoy åˆ¤æ–­å¦‚ä½•è·¯ç”±åˆ° upstreamã€‚\n\nåº”ç”¨ç¨‹åºå®¹å™¨å‘å‡ºçš„è¯·æ±‚ä¸º Outbound æµé‡ï¼Œè¢« iptables åŠ«æŒåè½¬ç§»ç»™ Envoy  Outbound handler å¤„ç†ï¼Œç„¶åç»è¿‡ \u0060virtual\u0060 Listenerã€\u00600.0.0.0_9080\u0060 Listenerï¼Œç„¶åé€šè¿‡ Route 9080 æ‰¾åˆ° upstream çš„ clusterï¼Œè¿›è€Œé€šè¿‡ EDS æ‰¾åˆ° Endpoint æ‰§è¡Œè·¯ç”±åŠ¨ä½œã€‚è¿™ä¸€éƒ¨åˆ†å¯ä»¥å‚è€ƒ Istio å®˜ç½‘ä¸­çš„ Envoy æ·±åº¦é…ç½®è§£æã€‚\n\n**Route 9080**\n\n\u0060reviews\u0060 ä¼šè¯·æ±‚ \u0060ratings\u0060 æœåŠ¡ï¼Œè¿è¡Œ \u0060istioctl proxy-config routes reviews-v1-cb8655c75-b97zc --name 9080 -o json\u0060 æŸ¥çœ‹ route é…ç½®ï¼Œå› ä¸º Envoy ä¼šæ ¹æ® HTTP header ä¸­çš„ domains æ¥åŒ¹é… VirtualHostï¼Œæ‰€ä»¥ä¸‹é¢åªåˆ—ä¸¾äº† \u0060ratings.default.svc.cluster.local:9080\u0060 è¿™ä¸€ä¸ª VirtualHostã€‚\n\n\u0060\u0060\u0060json\n[{\n    \u0022name\u0022: \u0022ratings.default.svc.cluster.local:9080\u0022,\n    \u0022domains\u0022: [\n        \u0022ratings.default.svc.cluster.local\u0022,\n        \u0022ratings.default.svc.cluster.local:9080\u0022,\n        \u0022ratings\u0022,\n        \u0022ratings:9080\u0022,\n        \u0022ratings.default.svc.cluster\u0022,\n        \u0022ratings.default.svc.cluster:9080\u0022,\n        \u0022ratings.default.svc\u0022,\n        \u0022ratings.default.svc:9080\u0022,\n        \u0022ratings.default\u0022,\n        \u0022ratings.default:9080\u0022,\n        \u002210.254.234.130\u0022,\n        \u002210.254.234.130:9080\u0022\n    ],\n    \u0022routes\u0022: [\n        {\n            \u0022match\u0022: {\n                \u0022prefix\u0022: \u0022\/\u0022\n            },\n            \u0022route\u0022: {\n                \u0022cluster\u0022: \u0022outbound|9080||ratings.default.svc.cluster.local\u0022,\n                \u0022timeout\u0022: \u00220.000s\u0022,\n                \u0022maxGrpcTimeout\u0022: \u00220.000s\u0022\n            },\n            \u0022decorator\u0022: {\n                \u0022operation\u0022: \u0022ratings.default.svc.cluster.local:9080\/*\u0022\n            },\n            \u0022perFilterConfig\u0022: {...\n            }\n        }\n    ]\n},\n..]\n\u0060\u0060\u0060\n\nä»è¯¥ Virtual Host é…ç½®ä¸­å¯ä»¥çœ‹åˆ°å°†æµé‡è·¯ç”±åˆ° Cluster \u0060outbound|9080||ratings.default.svc.cluster.local\u0060ã€‚\n\n**Endpoint \u0060outbound|9080||ratings.default.svc.cluster.local\u0060**\n\nIstio 1.1 ä»¥å‰ç‰ˆæœ¬ä¸æ”¯æŒä½¿ç”¨ \u0060istioctl\u0060 å‘½ä»¤ç›´æ¥æŸ¥è¯¢ Cluster çš„ Endpointï¼Œå¯ä»¥ä½¿ç”¨æŸ¥è¯¢ Pilot çš„ debug ç«¯ç‚¹çš„æ–¹å¼æŠ˜ä¸­ã€‚\n\n\u0060\u0060\u0060bash\nkubectl exec reviews-v1-cb8655c75-b97zc -c istio-proxy curl http:\/\/istio-pilot.istio-system.svc.cluster.local:9093\/debug\/edsz \u003e endpoints.json\n\u0060\u0060\u0060\n\n\u0060endpoints.json\u0060 æ–‡ä»¶ä¸­åŒ…å«äº†æ‰€æœ‰ Cluster çš„ Endpoint ä¿¡æ¯ï¼Œæˆ‘ä»¬åªé€‰å–å…¶ä¸­çš„ \u0060outbound|9080||ratings.default.svc.cluster.local\u0060 Cluster çš„ç»“æœå¦‚ä¸‹ã€‚\n\n\u0060\u0060\u0060json\n{\n  \u0022clusterName\u0022: \u0022outbound|9080||ratings.default.svc.cluster.local\u0022,\n  \u0022endpoints\u0022: [\n    {\n      \u0022locality\u0022: {\n\n      },\n      \u0022lbEndpoints\u0022: [\n        {\n          \u0022endpoint\u0022: {\n            \u0022address\u0022: {\n              \u0022socketAddress\u0022: {\n                \u0022address\u0022: \u0022172.33.100.2\u0022,\n                \u0022portValue\u0022: 9080\n              }\n            }\n          },\n          \u0022metadata\u0022: {\n            \u0022filterMetadata\u0022: {\n              \u0022istio\u0022: {\n                  \u0022uid\u0022: \u0022kubernetes:\/\/ratings-v1-8558d4458d-ns6lk.default\u0022\n                }\n            }\n          }\n        }\n      ]\n    }\n  ]\n}\n\u0060\u0060\u0060\n\nEndpoint å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªï¼ŒEnvoy å°†æ ¹æ®ä¸€å®šè§„åˆ™é€‰æ‹©é€‚å½“çš„ Endpoint æ¥è·¯ç”±ã€‚\n\n**æ³¨**ï¼šIstio 1.1 å°†æ”¯æŒ \u0060istioctl pc endpoint\u0060 å‘½ä»¤æ¥æŸ¥è¯¢ Endpointã€‚\n\n## å‚è€ƒ\n\n- è°ƒè¯• Envoy å’Œ Pilot - istio.io\n- [ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ - jimmysong.io](https:\/\/jimmysong.io\/posts\/envoy-sidecar-injection-in-istio-service-mesh-deep-dive\/)\n- [Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ - zhaohuabing.com](https:\/\/zhaohuabing.com\/post\/2018-09-25-istio-traffic-management-impl-intro\/)\n\n', '\/blog\/envoy-sidecar-routing-of-istio-service-mesh-deep-dive\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Sidecar proxy ä¸­ Indbound/Outbound æµé‡å¤„ç†è¿‡ç¨‹è¯¦è§£ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-service-and-traffic-model/">Istio ä¸­çš„æœåŠ¡å’Œæµé‡çš„æŠ½è±¡æ¨¡å‹</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/12/17</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio ä¸­çš„æœåŠ¡å’Œæµé‡çš„æŠ½è±¡æ¨¡å‹', 'æœ¬æ–‡ä»‹ç»äº† Istio å’Œ Kubernetes ä¸­çš„ä¸€äº›æœåŠ¡å’Œæµé‡çš„æŠ½è±¡æ¨¡å‹ã€‚', '\næœ¬æ–‡ä»‹ç»äº† Istio å’Œ Kubernetes ä¸­çš„ä¸€äº›æœåŠ¡å’Œæµé‡çš„æŠ½è±¡æ¨¡å‹ã€‚è™½ç„¶ Istio ä¸€å¼€å§‹ç¡®å®šçš„æŠ½è±¡æ¨¡å‹ä¸å¯¹æ¥çš„åº•å±‚å¹³å°æ— å…³ï¼Œä½†ç›®å‰æ¥çœ‹åŸºæœ¬ç»‘å®š Kubernetesï¼Œæœ¬æ–‡ä»…ä»¥ Kubernetes è¯´æ˜ã€‚å¦å¤–åœ¨ ServiceMesher ç¤¾åŒºä¸­æœ€è¿‘æœ‰å¾ˆå¤šå…³äº Istioã€Envoyã€Kubernetes ä¹‹ä¸­çš„æœåŠ¡æ¨¡å‹å…³ç³»çš„è®¨è®ºï¼Œæœ¬æ–‡ä½œä¸ºä¸€ä¸ªå¼€ç¯‡è¯´æ˜ï¼ŒKubernetes å’Œ Isito ä¹‹é—´æœ‰å“ªäº›å…±æœ‰çš„æœåŠ¡æ¨¡å‹ï¼ŒIstio åœ¨ Kubernetes çš„æœåŠ¡æ¨¡å‹ä¹‹ä¸Šåˆå¢åŠ äº†ä»€ä¹ˆã€‚\n\n**æœåŠ¡å…·æœ‰å¤šä¸ªç‰ˆæœ¬ã€‚** åœ¨ CI\/CD è¿‡ç¨‹ä¸­ï¼ŒåŒä¸€ä¸ªæœåŠ¡å¯èƒ½åŒæ—¶éƒ¨ç½²åœ¨å¤šä¸ªç¯å¢ƒä¸­ï¼Œå¦‚å¼€å‘ã€ç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒç­‰ï¼Œè¿™äº›æœåŠ¡ç‰ˆæœ¬ä¸ä¸€å®šå…·æœ‰ä¸åŒçš„ APIï¼Œå¯èƒ½åªæ˜¯ä¸€äº›å°çš„æ›´æ”¹å¯¼è‡´çš„è¿­ä»£ç‰ˆæœ¬ã€‚åœ¨ A\/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒä¸­ç»å¸¸é‡åˆ°è¿™ç§æƒ…å†µã€‚\n\n## Kubernetes ä¸ Istio ä¸­å…±æœ‰çš„æ¨¡å‹\n\nå› ä¸º Istio åŸºæœ¬å°±æ˜¯ç»‘å®šåœ¨ Kubernetes ä¸Šï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„ Kubernetes åŠ Istio ä¸­å…±æœ‰çš„æœåŠ¡æ¨¡å‹ã€‚\n\nKubernetes ä¸­ iptables ä»£ç†æ¨¡å¼ï¼ˆå¦å¤–è¿˜æœ‰ IPVS æ¨¡å¼ï¼‰ä¸‹çš„ serviceï¼Œç®¡ç†å‘˜å¯ä»¥åœ¨ kube-proxy ä¸­é…ç½®ç®€å•çš„è´Ÿè½½å‡è¡¡ï¼Œå¯¹æ•´ä¸ª node ç”Ÿæ•ˆï¼Œæ— æ³•é…ç½®åˆ°å•ä¸ªæœåŠ¡çš„è´Ÿè½½å‡è¡¡å’Œå…¶ä»–å¾®æœåŠ¡çš„é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚ç†”æ–­ã€é™æµã€è¿½è¸ªç­‰ï¼Œè¿™äº›åŠŸèƒ½åªèƒ½åœ¨åº”ç”¨ä¸­å®ç°äº†ï¼Œè€Œåœ¨ Istio çš„æ¦‚å¿µæ¨¡å‹ä¸­å®Œå…¨å»æ‰äº† \u0060kube-proxy\u0060  è¿™ä¸ªç»„ä»¶ï¼Œå°†å…¶åˆ†æ•£åˆ°æ¯ä¸ªåº”ç”¨ Pod ä¸­åŒæ—¶éƒ¨ç½²çš„ Envoy ä¸­å®ç°ã€‚\n\nä¸‹é¢åˆ—ä¸¾çš„æ˜¯ Kubernetes å’Œ Istio ä¸­å…±æœ‰çš„æ¨¡å‹ã€‚\n\n### Service\n\nè¿™å®é™…ä¸Šè·Ÿ Kubernetes ä¸­çš„ service æ¦‚å¿µæ˜¯ä¸€è‡´çš„ï¼Œè¯·å‚è€ƒ [Kubernetes ä¸­çš„ service](https:\/\/jimmysong.io\/kubernetes-handbook\/concepts\/service.html)ã€‚Istio æ¨å‡ºäº†æ¯” service æ›´å¤æ‚çš„æ¨¡å‹ \u0060VirtualService\u0060ï¼Œè¿™ä¸å•çº¯æ˜¯å®šä¹‰ä¸€ä¸ªæœåŠ¡äº†ï¼Œè€Œæ˜¯åœ¨æœåŠ¡ä¹‹ä¸Šå®šä¹‰äº†è·¯ç”±è§„åˆ™ã€‚\n\næ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªå®Œå…¨é™å®šçš„åŸŸåï¼ˆFQDNï¼‰ï¼Œç›‘å¬ä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ã€‚æœåŠ¡è¿˜å¯ä»¥æœ‰ä¸å…¶ç›¸å…³è”çš„å•ä¸ªè´Ÿè½½å‡è¡¡å™¨æˆ–è™šæ‹Ÿ IP åœ°å€ã€‚é’ˆå¯¹ FQDN çš„ DNS æŸ¥è¯¢å°†è§£æä¸ºè¯¥è´Ÿè½½å‡è¡¡å™¨æˆ–è€…è™šæ‹Ÿ IP çš„åœ°å€ã€‚\n\nä¾‹å¦‚ Kubernetes ä¸­ä¸€ä¸ªæœåŠ¡ä¸º \u0060foo.default.svc.cluster.local\u0060 ï¼Œè™šæ‹Ÿ IP \/ClusterIP æ˜¯ 10.0.1.1ï¼Œç›‘å¬çš„ç«¯å£æ˜¯ 80 å’Œ 8080ã€‚\n\n### Endpoint\n\nè¿™é‡ŒæŒ‡çš„æ˜¯ Kubernetes ä¸­çš„ endpointï¼Œä¸€ä¸ª endpoint æ˜¯å®ç°äº†æŸæœåŠ¡çš„å…·ä½“å®ä¾‹ï¼Œä¸€ä¸ªæœåŠ¡å¯èƒ½æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª Endpointï¼Œè¡¨ç¤ºä¸º IP åœ°å€åŠ ç«¯å£ï¼Œä¹Ÿå¯ä»¥ä¸º DNS åç§°åŠ ç«¯å£ã€‚\n\nå…¶å®åˆ°åº•å“ªäº›å®ä¾‹å±äºåŒä¸€ä¸ª serviceï¼Œè¿˜æ˜¯éœ€è¦ é€šè¿‡ label åŒ¹é…æ¥é€‰æ‹©ã€‚\n\n### Label\n\næœåŠ¡çš„ç‰ˆæœ¬ã€å¯¹åº”çš„å¼•ç”¨åç§°ç­‰æ˜¯é€šè¿‡ label æ¥æ ‡è®°çš„ï¼Œä¾‹å¦‚ä¸‹é¢ Kubernetes ä¸­ä¸€ä¸ªåº”ç”¨çš„ YAML é…ç½®ã€‚\n\n\u0060\u0060\u0060yaml\napiVersion: extensions\/v1beta1\nkind: Deployment\nmetadata:\n  name: ratings-v1\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: ratings\n        version: v1\n    spec:\n      containers:\n      - name: ratings\n        image: istio\/examples-bookinfo-ratings-v1:1.8.0\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 9080\n\u0060\u0060\u0060\n\n \u0060version: v1\u0060 æ ‡è®°è¯¥æœåŠ¡æ˜¯ v1 ç‰ˆæœ¬ï¼Œ\u0060version\u0060 æ˜¯ä¸€ä¸ªçº¦å®šä¿—ç§°çš„æ ‡ç­¾ï¼Œå»ºè®®å¤§å®¶çš„æœåŠ¡ä¸Šéƒ½å¸¦ä¸Šè¯¥æ ‡ç­¾ã€‚\n\nå½“ç„¶æœåŠ¡çš„ label å¯ä»¥è®¾ç½®ä»»æ„å¤šä¸ªï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯åœ¨åšè·¯ç”±çš„æ—¶å€™å¯ä»¥æ ¹æ®æ ‡ç­¾åŒ¹é…æ¥åšç»†ç²’åº¦çš„æµé‡åˆ’åˆ†ã€‚\n\n## æ•°æ®å¹³é¢ Envoy\n\nEnvoy æ˜¯ Istio ä¸­é»˜è®¤çš„ sidecar proxyï¼Œè´Ÿè´£æœåŠ¡é—´çš„æµé‡ç®¡æ§ã€è®¤è¯ä¸å®‰å…¨åŠ å¯†ã€å¯è§‚æµ‹æ€§ç­‰ã€‚\n\nä¸‹é¢æ˜¯ Envoy çš„æ¶æ„å›¾ã€‚\n\n![Envoy æ¶æ„å›¾](envoy-arch-20190114.png)\n\næˆ‘å†ç»™å¤§å®¶ä»‹ç» Envoy ä¸­çš„å¦‚ä¸‹å‡ ä¸ªé‡è¦æ¦‚å¿µã€‚\n\n### Cluster\n\né›†ç¾¤ï¼ˆclusterï¼‰æ˜¯ Envoy è¿æ¥åˆ°çš„ä¸€ç»„é€»è¾‘ä¸Šç›¸ä¼¼çš„ä¸Šæ¸¸ä¸»æœºã€‚Envoy é€šè¿‡æœåŠ¡å‘ç°å‘ç°é›†ç¾¤ä¸­çš„æˆå‘˜ã€‚Envoy å¯ä»¥é€šè¿‡ä¸»åŠ¨è¿è¡ŒçŠ¶å†µæ£€æŸ¥æ¥ç¡®å®šé›†ç¾¤æˆå‘˜çš„å¥åº·çŠ¶å†µã€‚Envoy å¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤æˆå‘˜ç”±è´Ÿè½½å‡è¡¡ç­–ç•¥ç¡®å®šã€‚\n\nè¿™ä¸ªä¸ Kubernetes ä¸­çš„ Service æ¦‚å¿µç±»ä¼¼ï¼Œåªä¸è¿‡ Kubernetes ä¸­çš„æœåŠ¡å‘ç°ä¸­å¹¶ä¸åŒ…å«å¥åº·çŠ¶å†µæ£€æŸ¥ï¼Œè€Œæ˜¯é€šè¿‡[é…ç½® Pod çš„ liveness å’Œ readiness æ¢é’ˆ](https:\/\/jimmysong.io\/kubernetes-handbook\/guide\/configure-liveness-readiness-probes.html)æ¥å®ç°ï¼ŒæœåŠ¡å‘ç°é»˜è®¤ä¹Ÿæ˜¯é€šè¿‡ DNS æ¥å®ç°ã€‚\n\n### Listener\n\nç›‘å¬å™¨ï¼ˆlistenerï¼‰æ˜¯å¯ä»¥ç”±ä¸‹æ¸¸å®¢æˆ·ç«¯è¿æ¥çš„å‘½åç½‘ç»œä½ç½®ï¼ˆä¾‹å¦‚ï¼Œç«¯å£ã€unix åŸŸå¥—æ¥å­—ç­‰ï¼‰ã€‚Envoy å…¬å¼€ä¸€ä¸ªæˆ–å¤šä¸ªä¸‹æ¸¸ä¸»æœºè¿æ¥çš„ä¾¦å¬å™¨ã€‚ä¸€èˆ¬æ˜¯æ¯å°ä¸»æœºè¿è¡Œä¸€ä¸ª Envoyï¼Œä½¿ç”¨å•è¿›ç¨‹è¿è¡Œï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¯åŠ¨ä»»æ„æ•°é‡çš„ Listenerï¼ˆç›‘å¬å™¨ï¼‰ï¼Œç›®å‰åªç›‘å¬ TCPï¼Œæ¯ä¸ªç›‘å¬å™¨éƒ½ç‹¬ç«‹é…ç½®ä¸€å®šæ•°é‡çš„ï¼ˆL3\/L4ï¼‰ç½‘ç»œè¿‡æ»¤å™¨ã€‚Listenter ä¹Ÿå¯ä»¥é€šè¿‡ Listener Discovery Serviceï¼ˆ**LDS**ï¼‰åŠ¨æ€è·å–ã€‚\n\n### Listener filter\n\nListener ä½¿ç”¨ listener filterï¼ˆç›‘å¬å™¨è¿‡æ»¤å™¨ï¼‰æ¥æ“ä½œé“¾æ¥çš„å…ƒæ•°æ®ã€‚å®ƒçš„ä½œç”¨æ˜¯åœ¨ä¸æ›´æ”¹ Envoy çš„æ ¸å¿ƒåŠŸèƒ½çš„æƒ…å†µä¸‹æ·»åŠ æ›´å¤šçš„é›†æˆåŠŸèƒ½ã€‚Listener filter çš„ API ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºè¿™äº›è¿‡æ»¤å™¨æœ€ç»ˆæ˜¯åœ¨æ–°æ¥å—çš„å¥—æ¥å­—ä¸Šè¿è¡Œã€‚åœ¨é“¾ä¸­å¯ä»¥äº’ç›¸è¡”æ¥ä»¥æ”¯æŒæ›´å¤æ‚çš„åœºæ™¯ï¼Œä¾‹å¦‚è°ƒç”¨é€Ÿç‡é™åˆ¶ã€‚Envoy å·²ç»åŒ…å«äº†å¤šä¸ªç›‘å¬å™¨è¿‡æ»¤å™¨ã€‚\n\n## Istio ä¸­å¢åŠ çš„æµé‡æ¨¡å‹\n\n\u0060VirtualService\u0060ã€\u0060DestinationRule\u0060ã€\u0060Gateway\u0060ã€\u0060ServiceEntry\u0060 å’Œ \u0060EnvoyFilter\u0060 éƒ½æ˜¯ Istio ä¸­ä¸ºæµé‡ç®¡ç†æ‰€åˆ›å»ºçš„ CRDï¼Œè¿™äº›æ¦‚å¿µå…¶å®æ˜¯åšè·¯ç”±é…ç½®å’Œæµé‡ç®¡ç†çš„ï¼Œè€Œ Kubernetes ä¸­çš„ service åªæ˜¯ç”¨æ¥åšæœåŠ¡å‘ç°ã€‚Service Mesh ä¸­çœŸæ­£çš„æœåŠ¡æ¨¡å‹åº”è¯¥æ˜¯ Envoy çš„ [xDS åè®®](https:\/\/cloudnative.to\/blog\/envoy-xds-protocol\/)ï¼Œå…¶ä¸­åŒ…æ‹¬äº†æœåŠ¡çš„æµé‡æ²»ç†ï¼ŒæœåŠ¡çš„ç«¯ç‚¹æ˜¯é€šè¿‡ EDS æ¥é…ç½®çš„ã€‚\n\n![Istio pilot æ¶æ„å›¾](istio-pilot.png)\n\nä¸Šå›¾æ˜¯ Pilot è®¾è®¡å›¾ï¼Œæ¥è‡ª[Istio Pilot design overview](https:\/\/github.com\/istio\/old_pilot_repo\/blob\/master\/doc\/design.md)ã€‚\n\n### Routing\n\nKubernetes ä¸­çš„ service æ˜¯æ²¡æœ‰ä»»ä½•è·¯ç”±å±æ€§å¯ä»¥é…ç½®çš„ï¼ŒIstio åœ¨è®¾è®¡ä¹‹åˆå°±é€šè¿‡åœ¨åŒä¸€ä¸ª Pod ä¸­ï¼Œåœ¨åº”ç”¨å®¹å™¨æ—è¿è¡Œä¸€ä¸ª sidecar proxy æ¥é€æ˜å¾—å®ç°ç»†ç²’åº¦çš„è·¯ç”±æ§åˆ¶ã€‚\n\n### VirtualService\n\n\u0060VirtualService\u0060 å®šä¹‰é’ˆå¯¹æŒ‡å®šæœåŠ¡æµé‡çš„è·¯ç”±è§„åˆ™ã€‚æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½é’ˆå¯¹ç‰¹å®šåè®®çš„åŒ¹é…è§„åˆ™ã€‚å¦‚æœæµé‡ç¬¦åˆè¿™äº›ç‰¹å¾ï¼Œå°±ä¼šæ ¹æ®è§„åˆ™å‘é€åˆ°æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ç›®æ ‡æœåŠ¡ï¼ˆæˆ–è€…ç›®æ ‡æœåŠ¡çš„å­é›†æˆ–ç‰ˆæœ¬ï¼‰ã€‚å¯¹äº A\/B æµ‹è¯•å’Œç°åº¦å‘å¸ƒç­‰åœºæ™¯ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨åˆ’åˆ† \u0060subset\u0060ï¼ŒVirtualService ä¸­æ ¹æ® destination ä¸­çš„ subset é…ç½®æ¥é€‰æ‹©è·¯ç”±ï¼Œä½†æ˜¯è¿™äº› subset ç©¶ç«Ÿå¯¹åº”å“ªäº›æœåŠ¡ç¤ºä¾‹ï¼Œè¿™å°±éœ€è¦ \u0060DestionationRule\u0060ã€‚\n\n### DestinationRule\n\n\u0060DestinationRule\u0060 æ‰€å®šä¹‰çš„ç­–ç•¥ï¼Œå†³å®šäº†ç»è¿‡è·¯ç”±å¤„ç†ä¹‹åçš„æµé‡çš„è®¿é—®ç­–ç•¥ã€‚è¿™äº›ç­–ç•¥ä¸­å¯ä»¥å®šä¹‰è´Ÿè½½å‡è¡¡é…ç½®ã€è¿æ¥æ± å°ºå¯¸ä»¥åŠå¤–éƒ¨æ£€æµ‹ï¼ˆç”¨äºåœ¨è´Ÿè½½å‡è¡¡æ± ä¸­å¯¹ä¸å¥åº·ä¸»æœºè¿›è¡Œè¯†åˆ«å’Œé©±é€ï¼‰é…ç½®ã€‚\n\n### Gateway\n\n\u0060Gateway\u0060 æè¿°äº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨äºæ‰¿è½½ç½‘æ ¼è¾¹ç¼˜çš„è¿›å…¥å’Œå‘å‡ºè¿æ¥ã€‚è¿™ä¸€è§„èŒƒä¸­æè¿°äº†ä¸€ç³»åˆ—å¼€æ”¾ç«¯å£ï¼Œä»¥åŠè¿™äº›ç«¯å£æ‰€ä½¿ç”¨çš„åè®®ã€è´Ÿè½½å‡è¡¡çš„ SNI é…ç½®ç­‰å†…å®¹ã€‚\n\nè¿™ä¸ªå®é™…ä¸Šå°±æ˜¯å®šä¹‰æœåŠ¡ç½‘æ ¼çš„è¾¹ç¼˜è·¯ç”±ã€‚\n\n### ServiceEntry\n\n\u0060ServiceEntry\u0060 èƒ½å¤Ÿåœ¨ Istio å†…éƒ¨çš„æœåŠ¡æ³¨å†Œè¡¨ä¸­åŠ å…¥é¢å¤–çš„æ¡ç›®ï¼Œä»è€Œè®©ç½‘æ ¼ä¸­è‡ªåŠ¨å‘ç°çš„æœåŠ¡èƒ½å¤Ÿè®¿é—®å’Œè·¯ç”±åˆ°è¿™äº›æ‰‹å·¥åŠ å…¥çš„æœåŠ¡ã€‚\u0060ServiceEntry\u0060 æè¿°äº†æœåŠ¡çš„å±æ€§ï¼ˆDNS åç§°ã€VIPã€ç«¯å£ã€åè®®ä»¥åŠç«¯ç‚¹ï¼‰ã€‚è¿™ç±»æœåŠ¡å¯èƒ½æ˜¯ç½‘æ ¼å¤–çš„ APIï¼Œæˆ–è€…æ˜¯å¤„äºç½‘æ ¼å†…éƒ¨ä½†å´ä¸å­˜åœ¨äºå¹³å°çš„æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ¡ç›®ï¼ˆä¾‹å¦‚éœ€è¦å’Œ Kubernetes æœåŠ¡æ²Ÿé€šçš„ä¸€ç»„è™šæ‹ŸæœºæœåŠ¡ï¼‰ã€‚\n\nå¦‚æœæ²¡æœ‰é…ç½® ServiceEntry çš„è¯ï¼ŒIstio å®é™…ä¸Šæ˜¯æ— æ³•å‘ç°æœåŠ¡ç½‘æ ¼å¤–éƒ¨çš„æœåŠ¡çš„ã€‚\n\n### EnvoyFilter\n\n\u0060EnvoyFilter\u0060 å¯¹è±¡æè¿°äº†é’ˆå¯¹ä»£ç†æœåŠ¡çš„è¿‡æ»¤å™¨ï¼Œè¿™äº›è¿‡æ»¤å™¨å¯ä»¥å®šåˆ¶ç”± Istio Pilot ç”Ÿæˆçš„ä»£ç†é…ç½®ã€‚è¿™ä¸€åŠŸèƒ½ä¸€å®šè¦è°¨æ…ä½¿ç”¨ã€‚é”™è¯¯çš„é…ç½®å†…å®¹ä¸€æ—¦å®Œæˆä¼ æ’­ï¼Œå¯èƒ½ä¼šä»¤æ•´ä¸ªæœåŠ¡ç½‘æ ¼è¿›å…¥ç˜«ç—ªçŠ¶æ€ã€‚\n\nEnvoy ä¸­çš„ listener å¯ä»¥é…ç½®å¤šä¸ª filterï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§é€šè¿‡ Istio æ¥æ‰©å±• Envoy çš„æœºåˆ¶ã€‚\n\n## å‚è€ƒ\n\n- [Kubernetes ä¸­çš„ service - jimmysong.io](https:\/\/jimmysong.io\/kubernetes-handbook\/concepts\/service.html)\n- [Istio services model - github.com](https:\/\/github.com\/istio\/old_pilot_repo\/blob\/master\/doc\/service-registry.md)\n- [Istio æ–‡æ¡£ - istio.io](https:\/\/istio.io)\n', '\/blog\/istio-service-and-traffic-model\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»äº† Istio å’Œ Kubernetes ä¸­çš„ä¸€äº›æœåŠ¡å’Œæµé‡çš„æŠ½è±¡æ¨¡å‹ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/09/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ', 'ä»¥å¾€æœ‰å¾ˆå¤šæ–‡ç« è®²è§£ Istio æ˜¯å¦‚ä½•åš Sidecar æ³¨å…¥çš„ï¼Œä½†æ˜¯æ²¡æœ‰è®²è§£æ³¨å…¥ä¹‹å Sidecar å·¥ä½œçš„ç»†èŠ‚ã€‚æœ¬æ–‡å°†å¸¦å¤§å®¶è¯¦ç»†äº†è§£ Istio æ˜¯å¦‚ä½•å°† Envoy ä½œä¸º Sidecar çš„æ–¹å¼æ³¨å…¥åˆ°åº”ç”¨ç¨‹åº Pod ä¸­ï¼ŒåŠ Sidecar æ˜¯å¦‚ä½•åšåŠ«æŒæµé‡çš„ã€‚', '\næœ¬æ–‡æœ€æ–°æ›´æ–°äº 2022 å¹´ 3 æœˆ 7 æ—¥ã€‚\n\n\u003e ä»¥å¾€æœ‰å¾ˆå¤šæ–‡ç« è®²è§£ Istio æ˜¯å¦‚ä½•åš Sidecar æ³¨å…¥çš„ï¼Œä½†æ˜¯æ²¡æœ‰è®²è§£æ³¨å…¥ä¹‹å Sidecar å·¥ä½œçš„ç»†èŠ‚ã€‚æœ¬æ–‡å°†å¸¦å¤§å®¶è¯¦ç»†äº†è§£ Istio æ˜¯å¦‚ä½•å°† Envoy ä½œä¸º Sidecar çš„æ–¹å¼æ³¨å…¥åˆ°åº”ç”¨ç¨‹åº Pod ä¸­ï¼ŒåŠ Sidecar æ˜¯å¦‚ä½•åšåŠ«æŒæµé‡çš„ã€‚\n\nåœ¨è®²è§£ Istio å¦‚ä½•å°† Envoy ä»£ç†æ³¨å…¥åˆ°åº”ç”¨ç¨‹åº Pod ä¸­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š\n\n- Sidecar æ¨¡å¼ï¼šå®¹å™¨åº”ç”¨æ¨¡å¼ä¹‹ä¸€ï¼ŒService Mesh æ¶æ„çš„ä¸€ç§å®ç°æ–¹å¼ã€‚\n- Init å®¹å™¨ï¼šPod ä¸­çš„ä¸€ç§ä¸“ç”¨çš„å®¹å™¨ï¼Œåœ¨åº”ç”¨ç¨‹åºå®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œç”¨æ¥åŒ…å«ä¸€äº›åº”ç”¨é•œåƒä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–å®‰è£…è„šæœ¬ã€‚\n- iptablesï¼šæµé‡åŠ«æŒæ˜¯é€šè¿‡ iptables è½¬å‘å®ç°çš„ã€‚\n\næŸ¥çœ‹ç›®å‰ \u0060reviews-v1-745ffc55b7-2l2lw\u0060 Pod ä¸­è¿è¡Œçš„å®¹å™¨ï¼š\n\n\u0060\u0060\u0060bash\n$ kubectl -n default get pod reviews-v1-745ffc55b7-2l2lw -o=jsonpath=\u0027{..spec.containers[*].name}\u0027\nreviews istio-proxy\n\u0060\u0060\u0060\n\n\u0060reviews\u0060 å³åº”ç”¨å®¹å™¨ï¼Œ\u0060istio-proxy\u0060 å³ Envoy ä»£ç†çš„ sidecar å®¹å™¨ã€‚å¦å¤–è¯¥ Pod ä¸­å®é™…ä¸Šè¿˜è¿è¡Œè¿‡ä¸€ä¸ª Init å®¹å™¨ï¼Œå› ä¸ºå®ƒæ‰§è¡Œç»“æŸå°±è‡ªåŠ¨ç»ˆæ­¢äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸åˆ°è¯¥å®¹å™¨çš„å­˜åœ¨ã€‚å…³æ³¨ \u0060jsonpath\u0060 çš„ç”¨æ³•è¯·å‚è€ƒ [JSONPath Support](https:\/\/kubernetes.io\/docs\/reference\/kubectl\/jsonpath\/)ã€‚\n\n## Sidecar æ¨¡å¼\n\nåœ¨äº†è§£ Istio ä½¿ç”¨ Sidecar æ³¨å…¥ä¹‹å‰ï¼Œéœ€è¦å…ˆè¯´æ˜ä¸‹ä»€ä¹ˆæ˜¯ Sidecar æ¨¡å¼ã€‚Sidecar æ˜¯å®¹å™¨åº”ç”¨æ¨¡å¼çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯åœ¨ Service Mesh ä¸­å‘æ‰¬å…‰å¤§çš„ä¸€ç§æ¨¡å¼ã€‚\n\nä½¿ç”¨ Sidecar æ¨¡å¼éƒ¨ç½²æœåŠ¡ç½‘æ ¼æ—¶ï¼Œæ— éœ€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä»£ç†ï¼ˆå› æ­¤æ‚¨ä¸éœ€è¦åŸºç¡€ç»“æ„çš„åä½œï¼‰ï¼Œä½†æ˜¯é›†ç¾¤ä¸­å°†è¿è¡Œå¤šä¸ªç›¸åŒçš„ Sidecar å‰¯æœ¬ã€‚ä»å¦ä¸€ä¸ªè§’åº¦çœ‹ï¼šæˆ‘å¯ä»¥ä¸ºä¸€ç»„å¾®æœåŠ¡éƒ¨ç½²åˆ°ä¸€ä¸ªæœåŠ¡ç½‘æ ¼ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥éƒ¨ç½²ä¸€ä¸ªæœ‰ç‰¹å®šå®ç°çš„æœåŠ¡ç½‘æ ¼ã€‚åœ¨ Sidecar éƒ¨ç½²æ–¹å¼ä¸­ï¼Œä½ ä¼šä¸ºæ¯ä¸ªåº”ç”¨çš„å®¹å™¨éƒ¨ç½²ä¸€ä¸ªä¼´ç”Ÿå®¹å™¨ã€‚Sidecar æ¥ç®¡è¿›å‡ºåº”ç”¨å®¹å™¨çš„æ‰€æœ‰æµé‡ã€‚åœ¨ Kubernetes çš„ Pod ä¸­ï¼Œåœ¨åŸæœ‰çš„åº”ç”¨å®¹å™¨æ—è¾¹è¿è¡Œä¸€ä¸ª Sidecar å®¹å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸¤ä¸ªå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œå¯ä»¥å¹¿ä¹‰çš„å°†è¿™ä¸ªæ³¨å…¥äº† Sidecar å®¹å™¨çš„ Pod ç†è§£ä¸ºä¸€å°ä¸»æœºï¼Œä¸¤ä¸ªå®¹å™¨å…±äº«ä¸»æœºèµ„æºã€‚\n\nä¸‹å›¾å±•ç¤ºçš„æ˜¯ Service Mesh çš„æ¶æ„å›¾ï¼Œå…¶ä¸­çš„ä½äºæ¯ä¸ª Pod ä¸­çš„ proxy  ç»„æˆäº†æ•°æ®å¹³é¢ï¼Œè€Œè¿™äº› proxy æ­£æ˜¯ä»¥ sidecar æ¨¡å¼è¿è¡Œçš„ã€‚\n\n![Istio æ¶æ„](istio-sidecar.jpg)\n\n**æ³¨æ„**ï¼šä¸‹æ–‡ä¸­æ‰€æŒ‡çš„ Sidecar éƒ½æ˜¯æŒ‡çš„ Envoy ä»£ç†å®¹å™¨ã€‚\n\n## Init å®¹å™¨\n\nInit å®¹å™¨æ˜¯ä¸€ç§ä¸“ç”¨å®¹å™¨ï¼Œå®ƒåœ¨åº”ç”¨ç¨‹åºå®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œç”¨æ¥åŒ…å«ä¸€äº›åº”ç”¨é•œåƒä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–å®‰è£…è„šæœ¬ã€‚\n\nä¸€ä¸ª Pod ä¸­å¯ä»¥æŒ‡å®šå¤šä¸ª Init å®¹å™¨ï¼Œå¦‚æœæŒ‡å®šäº†å¤šä¸ªï¼Œé‚£ä¹ˆ Init å®¹å™¨å°†ä¼šæŒ‰é¡ºåºä¾æ¬¡è¿è¡Œã€‚åªæœ‰å½“å‰é¢çš„ Init å®¹å™¨å¿…é¡»è¿è¡ŒæˆåŠŸåï¼Œæ‰å¯ä»¥è¿è¡Œä¸‹ä¸€ä¸ª Init å®¹å™¨ã€‚å½“æ‰€æœ‰çš„ Init å®¹å™¨è¿è¡Œå®Œæˆåï¼ŒKubernetes æ‰åˆå§‹åŒ– Pod å’Œè¿è¡Œåº”ç”¨å®¹å™¨ã€‚\n\nInit å®¹å™¨ä½¿ç”¨ Linux Namespaceï¼Œæ‰€ä»¥ç›¸å¯¹åº”ç”¨ç¨‹åºå®¹å™¨æ¥è¯´å…·æœ‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚å› æ­¤ï¼Œå®ƒä»¬èƒ½å¤Ÿå…·æœ‰è®¿é—® Secret çš„æƒé™ï¼Œè€Œåº”ç”¨ç¨‹åºå®¹å™¨åˆ™ä¸èƒ½ã€‚\n\nåœ¨ Pod å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒInit å®¹å™¨ä¼šæŒ‰é¡ºåºåœ¨ç½‘ç»œå’Œæ•°æ®å·åˆå§‹åŒ–ä¹‹åå¯åŠ¨ã€‚æ¯ä¸ªå®¹å™¨å¿…é¡»åœ¨ä¸‹ä¸€ä¸ªå®¹å™¨å¯åŠ¨ä¹‹å‰æˆåŠŸé€€å‡ºã€‚å¦‚æœç”±äºè¿è¡Œæ—¶æˆ–å¤±è´¥é€€å‡ºï¼Œå°†å¯¼è‡´å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œå®ƒä¼šæ ¹æ® Pod çš„ \u0060restartPolicy\u0060 æŒ‡å®šçš„ç­–ç•¥è¿›è¡Œé‡è¯•ã€‚ç„¶è€Œï¼Œå¦‚æœ Pod çš„ \u0060restartPolicy\u0060 è®¾ç½®ä¸º Alwaysï¼ŒInit å®¹å™¨å¤±è´¥æ—¶ä¼šä½¿ç”¨ \u0060RestartPolicy\u0060 ç­–ç•¥ã€‚\n\nåœ¨æ‰€æœ‰çš„ Init å®¹å™¨æ²¡æœ‰æˆåŠŸä¹‹å‰ï¼ŒPod å°†ä¸ä¼šå˜æˆ \u0060Ready\u0060 çŠ¶æ€ã€‚Init å®¹å™¨çš„ç«¯å£å°†ä¸ä¼šåœ¨ Service ä¸­è¿›è¡Œèšé›†ã€‚æ­£åœ¨åˆå§‹åŒ–ä¸­çš„ Pod å¤„äº \u0060Pending\u0060 çŠ¶æ€ï¼Œä½†åº”è¯¥ä¼šå°† \u0060Initializing\u0060 çŠ¶æ€è®¾ç½®ä¸º trueã€‚Init å®¹å™¨è¿è¡Œå®Œæˆä»¥åå°±ä¼šè‡ªåŠ¨ç»ˆæ­¢ã€‚\n\nå…³äº Init å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [Init å®¹å™¨ - Kubernetes ä¸­æ–‡æŒ‡å—\/äº‘åŸç”Ÿåº”ç”¨æ¶æ„å®è·µæ‰‹å†Œ](\/book\/kubernetes-handbook\/objects\/init-containers\/)ã€‚\n\n## Sidecar æ³¨å…¥ç¤ºä¾‹åˆ†æ\n\næœ¬æ–‡æˆ‘ä»¬å°†ä»¥ Istio å®˜æ–¹ç¤ºä¾‹ \u0060bookinfo\u0060 ä¸­ \u0060reivews\u0060 æœåŠ¡ä¸ºä¾‹ï¼Œæ¥æ¥è®²è§£ Sidecar å®¹å™¨æ³¨å…¥çš„é¢æµç¨‹ï¼Œæ¯ä¸ªæ³¨å…¥äº† Sidecar çš„ Pod ä¸­é™¤äº†åŸå…ˆåº”ç”¨çš„åº”ç”¨æœ¬èº«çš„å®¹å™¨å¤–ï¼Œéƒ½ä¼šå¤šå‡ºæ¥è¿™æ ·ä¸¤ä¸ªå®¹å™¨ï¼š\n\n- \u0060istio-init\u0060ï¼šç”¨äºç»™ Sidecar å®¹å™¨å³ Envoy ä»£ç†åšåˆå§‹åŒ–ï¼Œè®¾ç½® iptables ç«¯å£è½¬å‘\n- \u0060istio-proxy\u0060ï¼šEnvoy ä»£ç†å®¹å™¨ï¼Œè¿è¡Œ Envoy ä»£ç†\n\næ¥ä¸‹æ¥å°†åˆ†åˆ«è§£æä¸‹è¿™ä¸¤ä¸ªå®¹å™¨ã€‚\n\n### Init å®¹å™¨è§£æ\n\nIstio åœ¨ Pod ä¸­æ³¨å…¥çš„ Init å®¹å™¨åä¸º \u0060istio-init\u0060ï¼Œå¦‚æœä½ æŸ¥çœ‹ \u0060reviews\u0060 Deployment é…ç½®ï¼Œä½ å°†çœ‹åˆ°å…¶ä¸­ \u0060initContaienrs\u0060 çš„å¯åŠ¨å‚æ•°ï¼š\n\n\u0060\u0060\u0060bash\n      initContainers:\n        - name: istio-init\n          image: docker.io\/istio\/proxyv2:1.13.1\n          args:\n            - istio-iptables\n            - \u0027-p\u0027\n            - \u002715001\u0027\n            - \u0027-z\u0027\n            - \u002715006\u0027\n            - \u0027-u\u0027\n            - \u00271337\u0027\n            - \u0027-m\u0027\n            - REDIRECT\n            - \u0027-i\u0027\n            - \u0027*\u0027\n            - \u0027-x\u0027\n            - \u0027\u0027\n            - \u0027-b\u0027\n            - \u0027*\u0027\n            - \u0027-d\u0027\n            - 15090,15021,15020\n\u0060\u0060\u0060\n\næˆ‘ä»¬çœ‹åˆ° \u0060istio-init\u0060 å®¹å™¨çš„å…¥å£æ˜¯ \u0060istio-iptables\u0060 å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æ˜¯ç”¨äºåˆå§‹åŒ–è·¯ç”±è¡¨çš„ã€‚\n\n### Init å®¹å™¨å¯åŠ¨å…¥å£\n\nInit å®¹å™¨çš„å¯åŠ¨å…¥å£æ˜¯ \u0060\/usr\/local\/bin\/istio-iptable\u0060 å‘½ä»¤ï¼Œè¯¥å‘½ä»¤çš„ç”¨æ³•å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060bash\n$ istio-iptables -p PORT -u UID -g GID [-m mode] [-b ports] [-d ports] [-i CIDR] [-x CIDR] [-h]\n  -p: æŒ‡å®šé‡å®šå‘æ‰€æœ‰ TCP æµé‡çš„ Envoy ç«¯å£ï¼ˆé»˜è®¤ä¸º $ENVOY_PORT = 15001ï¼‰\n  -u: æŒ‡å®šæœªåº”ç”¨é‡å®šå‘çš„ç”¨æˆ·çš„ UIDã€‚é€šå¸¸ï¼Œè¿™æ˜¯ä»£ç†å®¹å™¨çš„ UIDï¼ˆé»˜è®¤ä¸º $ENVOY_USER çš„ uidï¼Œistio_proxy çš„ uid æˆ– 1337ï¼‰\n  -g: æŒ‡å®šæœªåº”ç”¨é‡å®šå‘çš„ç”¨æˆ·çš„ GIDã€‚ï¼ˆä¸ -u param ç›¸åŒçš„é»˜è®¤å€¼ï¼‰\n  -m: æŒ‡å®šå…¥ç«™è¿æ¥é‡å®šå‘åˆ° Envoy çš„æ¨¡å¼ï¼Œâ€œREDIRECTâ€ æˆ– â€œTPROXYâ€ï¼ˆé»˜è®¤ä¸º $ISTIO_INBOUND_INTERCEPTION_MODE)\n  -b: é€—å·åˆ†éš”çš„å…¥ç«™ç«¯å£åˆ—è¡¨ï¼Œå…¶æµé‡å°†é‡å®šå‘åˆ° Envoyï¼ˆå¯é€‰ï¼‰ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰ç«¯å£ã€‚ä¸ºç©ºæ—¶è¡¨ç¤ºç¦ç”¨æ‰€æœ‰å…¥ç«™é‡å®šå‘ï¼ˆé»˜è®¤ä¸º $ISTIO_INBOUND_PORTSï¼‰\n  -d: æŒ‡å®šè¦ä»é‡å®šå‘åˆ° Envoy ä¸­æ’é™¤ï¼ˆå¯é€‰ï¼‰çš„å…¥ç«™ç«¯å£åˆ—è¡¨ï¼Œä»¥é€—å·æ ¼å¼åˆ†éš”ã€‚ä½¿ç”¨é€šé…ç¬¦â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å…¥ç«™æµé‡ï¼ˆé»˜è®¤ä¸º $ISTIO_LOCAL_EXCLUDE_PORTSï¼‰\n  -i: æŒ‡å®šé‡å®šå‘åˆ° Envoyï¼ˆå¯é€‰ï¼‰çš„ IP åœ°å€èŒƒå›´ï¼Œä»¥é€—å·åˆ†éš”çš„ CIDR æ ¼å¼åˆ—è¡¨ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å‡ºç«™æµé‡ã€‚ç©ºåˆ—è¡¨å°†ç¦ç”¨æ‰€æœ‰å‡ºç«™é‡å®šå‘ï¼ˆé»˜è®¤ä¸º $ISTIO_SERVICE_CIDRï¼‰\n  -x: æŒ‡å®šå°†ä»é‡å®šå‘ä¸­æ’é™¤çš„ IP åœ°å€èŒƒå›´ï¼Œä»¥é€—å·åˆ†éš”çš„ CIDR æ ¼å¼åˆ—è¡¨ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å‡ºç«™æµé‡ï¼ˆé»˜è®¤ä¸º $ISTIO_SERVICE_EXCLUDE_CIDRï¼‰ã€‚\n  -z: æ‰€æœ‰å…¥ç«™ TCP æµé‡é‡å®šå‘ç«¯å£ï¼ˆé»˜è®¤ä¸º $INBOUND_CAPTURE_PORT 15006ï¼‰\n\u0060\u0060\u0060\n\nå…³äºè¯¥å‘½ä»¤çš„è¯¦ç»†ä»£ç è¯·[æŸ¥çœ‹ GitHubï¼š\u0060tools\/istio-iptables\/pkg\/cmd\/root.go\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/tools\/istio-iptables\/pkg\/cmd\/root.go)ã€‚\n\nå†å‚è€ƒ \u0060istio-init\u0060 å®¹å™¨çš„å¯åŠ¨å‚æ•°ï¼Œå®Œæ•´çš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060bash\n$ \/usr\/local\/bin\/istio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i \u0027*\u0027 -x \u0022\u0022 -b * -d \u002215090,15201,15020\u0022\n\u0060\u0060\u0060\n\nè¯¥å®¹å™¨å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯è®© Envoy ä»£ç†å¯ä»¥æ‹¦æˆªæ‰€æœ‰çš„è¿›å‡º Pod çš„æµé‡ï¼Œå³å°†å…¥ç«™æµé‡é‡å®šå‘åˆ° Sidecarï¼Œå†æ‹¦æˆªåº”ç”¨å®¹å™¨çš„å‡ºç«™æµé‡ç»è¿‡ Sidecar å¤„ç†åå†å‡ºç«™ã€‚\n\n**å‘½ä»¤è§£æ**\n\nè¿™æ¡å¯åŠ¨å‘½ä»¤çš„ä½œç”¨æ˜¯ï¼š\n\n- å°†åº”ç”¨å®¹å™¨çš„æ‰€æœ‰æµé‡éƒ½è½¬å‘åˆ° Envoy çš„ 15006 ç«¯å£ã€‚\n- ä½¿ç”¨ \u0060istio-proxy\u0060 ç”¨æˆ·èº«ä»½è¿è¡Œï¼ŒUID ä¸º 1337ï¼Œå³ Envoy æ‰€å¤„çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ \u0060istio-proxy\u0060 å®¹å™¨é»˜è®¤ä½¿ç”¨çš„ç”¨æˆ·ï¼Œè§ YAML é…ç½®ä¸­çš„ \u0060runAsUser\u0060 å­—æ®µã€‚\n- ä½¿ç”¨é»˜è®¤çš„ \u0060REDIRECT\u0060 æ¨¡å¼æ¥é‡å®šå‘æµé‡ã€‚\n- å°†æ‰€æœ‰å‡ºç«™æµé‡éƒ½é‡å®šå‘åˆ° Envoy ä»£ç†ã€‚\n- å°†é™¤äº† 15090ã€15201ã€15020 ç«¯å£ä»¥å¤–çš„æ‰€æœ‰ç«¯å£çš„æµé‡é‡å®šå‘åˆ° Envoy ä»£ç†ã€‚\n\nå› ä¸º Init å®¹å™¨åˆå§‹åŒ–å®Œæ¯•åå°±ä¼šè‡ªåŠ¨ç»ˆæ­¢ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ç™»é™†åˆ°å®¹å™¨ä¸­æŸ¥çœ‹ iptables ä¿¡æ¯ï¼Œä½†æ˜¯ Init å®¹å™¨åˆå§‹åŒ–ç»“æœä¼šä¿ç•™åˆ°åº”ç”¨å®¹å™¨å’Œ Sidecar å®¹å™¨ä¸­ã€‚\n\n### istio-proxy å®¹å™¨è§£æ\n\nä¸ºäº†æŸ¥çœ‹ iptables é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦ç™»é™†åˆ° Sidecar å®¹å™¨ä¸­ä½¿ç”¨ root ç”¨æˆ·æ¥æŸ¥çœ‹ï¼Œå› ä¸º \u0060kubectl\u0060 æ— æ³•ä½¿ç”¨ç‰¹æƒæ¨¡å¼æ¥è¿œç¨‹æ“ä½œ docker å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç™»é™†åˆ° \u0060reviews\u0060 Pod æ‰€åœ¨çš„ä¸»æœºä¸Šä½¿ç”¨ \u0060docker\u0060 å‘½ä»¤ç™»é™†å®¹å™¨ä¸­æŸ¥çœ‹ã€‚\n\næŸ¥çœ‹ \u0060reviews\u0060 Pod æ‰€åœ¨çš„ä¸»æœºã€‚\n\n\u0060\u0060\u0060bash\n$ kubectl -n default get pod -l app=reviews -o wide\nNAME                              READY     STATUS    RESTARTS   AGE       IP             NODE\nreviews-v1-745ffc55b7-2l2lw   2\/2       Running   0          1d        172.33.78.10   node3\n\u0060\u0060\u0060\n\nä»è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ°è¯¥ Pod è¿è¡Œåœ¨ \u0060node3\u0060 ä¸Šï¼Œä½¿ç”¨ \u0060vagrant\u0060 å‘½ä»¤ç™»é™†åˆ° \u0060node3\u0060 ä¸»æœºä¸­å¹¶åˆ‡æ¢ä¸º root ç”¨æˆ·ã€‚\n\n\u0060\u0060\u0060bash\n$ vagrant ssh node3\n$ sudo -i\n\u0060\u0060\u0060\n\næŸ¥çœ‹ iptables é…ç½®ï¼Œåˆ—å‡º NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå› ä¸ºåœ¨ Init å®¹å™¨å¯åŠ¨çš„æ—¶å€™é€‰æ‹©ç»™  \u0060istio-iptables.sh\u0060 ä¼ é€’çš„å‚æ•°ä¸­æŒ‡å®šå°†å…¥ç«™æµé‡é‡å®šå‘åˆ° Envoy çš„æ¨¡å¼ä¸ºâ€œREDIRECTâ€ï¼Œå› æ­¤åœ¨ iptables ä¸­å°†åªæœ‰ NAT è¡¨çš„è§„æ ¼é…ç½®ï¼Œå¦‚æœé€‰æ‹© \u0060TPROXY\u0060 è¿˜ä¼šæœ‰ \u0060mangle\u0060 è¡¨é…ç½®ã€‚\u0060iptables\u0060 å‘½ä»¤çš„è¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ [iptables](https:\/\/wangchujiang.com\/linux-command\/c\/iptables.html)ï¼Œè§„åˆ™é…ç½®è¯·å‚è€ƒ [iptables è§„åˆ™é…ç½®](http:\/\/www.zsythink.net\/archives\/1517)ã€‚\n\n## ç†è§£ iptables\n\n\u0060iptables\u0060 æ˜¯ Linux å†…æ ¸ä¸­çš„é˜²ç«å¢™è½¯ä»¶ netfilter çš„ç®¡ç†å·¥å…·ï¼Œä½äºç”¨æˆ·ç©ºé—´ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ netfilter çš„ä¸€éƒ¨åˆ†ã€‚Netfilter ä½äºå†…æ ¸ç©ºé—´ï¼Œä¸ä»…æœ‰ç½‘ç»œåœ°å€è½¬æ¢çš„åŠŸèƒ½ï¼Œä¹Ÿå…·å¤‡æ•°æ®åŒ…å†…å®¹ä¿®æ”¹ã€ä»¥åŠæ•°æ®åŒ…è¿‡æ»¤ç­‰é˜²ç«å¢™åŠŸèƒ½ã€‚\n\nåœ¨äº†è§£ Init å®¹å™¨åˆå§‹åŒ–çš„ iptables ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ iptables å’Œè§„åˆ™é…ç½®ã€‚\n\nä¸‹å›¾å±•ç¤ºäº† iptables è°ƒç”¨é“¾ã€‚\n\n![iptables è°ƒç”¨é“¾](iptables_packetflow.png)\n\n### iptables ä¸­çš„è¡¨\n\nInit å®¹å™¨ä¸­ä½¿ç”¨çš„çš„ iptables ç‰ˆæœ¬æ˜¯ \u0060v1.6.0\u0060ï¼Œå…±åŒ…å« 5 å¼ è¡¨ï¼š\n\n1. \u0060raw\u0060 ç”¨äºé…ç½®æ•°æ®åŒ…ï¼Œ\u0060raw\u0060 ä¸­çš„æ•°æ®åŒ…ä¸ä¼šè¢«ç³»ç»Ÿè·Ÿè¸ªã€‚\n2. \u0060filter\u0060 æ˜¯ç”¨äºå­˜æ”¾æ‰€æœ‰ä¸é˜²ç«å¢™ç›¸å…³æ“ä½œçš„é»˜è®¤è¡¨ã€‚\n3. \u0060nat\u0060 ç”¨äº [ç½‘ç»œåœ°å€è½¬æ¢](https:\/\/en.wikipedia.org\/wiki\/Network_address_translation)ï¼ˆä¾‹å¦‚ï¼šç«¯å£è½¬å‘ï¼‰ã€‚\n4. \u0060mangle\u0060 ç”¨äºå¯¹ç‰¹å®šæ•°æ®åŒ…çš„ä¿®æ”¹ï¼ˆå‚è€ƒ[æŸåæ•°æ®åŒ…](https:\/\/en.wikipedia.org\/wiki\/Mangled_packet)ï¼‰ã€‚\n5. \u0060security\u0060 ç”¨äº[å¼ºåˆ¶è®¿é—®æ§åˆ¶](https:\/\/wiki.archlinux.org\/index.php\/Security#Mandatory_access_control) ç½‘ç»œè§„åˆ™ã€‚\n\n**æ³¨**ï¼šåœ¨æœ¬ç¤ºä¾‹ä¸­åªç”¨åˆ°äº† \u0060nat\u0060 è¡¨ã€‚\n\nä¸åŒçš„è¡¨ä¸­çš„å…·æœ‰çš„é“¾ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\n\n| è§„åˆ™åç§°    | raw  | filter | nat  | mangle | security |\n| ----------- | ---- | ------ | ---- | ------ | -------- |\n| PREROUTING  | âœ“    |        | âœ“    | âœ“      |          |\n| INPUT       |      | âœ“      | âœ“    | âœ“      | âœ“        |\n| OUTPUT      |      | âœ“      | âœ“    | âœ“      | âœ“        |\n| POSTROUTING |      |        | âœ“    | âœ“      |          |\n| FORWARD     | âœ“    | âœ“      |      | âœ“      | âœ“        |\n\nä¸‹å›¾æ˜¯ iptables çš„è°ƒç”¨é“¾é¡ºåºã€‚\n\n![iptables è°ƒç”¨é“¾é¡ºåº](iptables-chains.jpg)\n\n\n### iptables å‘½ä»¤\n\n\u0060iptables\u0060 å‘½ä»¤çš„ä¸»è¦ç”¨é€”æ˜¯ä¿®æ”¹è¿™äº›è¡¨ä¸­çš„è§„åˆ™ã€‚\u0060iptables\u0060 å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060bash\n$ iptables [-t è¡¨å] å‘½ä»¤é€‰é¡¹ï¼»é“¾å]ï¼»æ¡ä»¶åŒ¹é…ï¼½[-j ç›®æ ‡åŠ¨ä½œæˆ–è·³è½¬ï¼½\n\u0060\u0060\u0060\n\nInit å®¹å™¨ä¸­çš„ \u0060\/istio-iptables.sh\u0060 å¯åŠ¨å…¥å£è„šæœ¬å°±æ˜¯æ‰§è¡Œ iptables åˆå§‹åŒ–çš„ã€‚\n\n### ç†è§£ iptables è§„åˆ™\n\næŸ¥çœ‹ \u0060istio-proxy\u0060 å®¹å™¨ä¸­çš„é»˜è®¤çš„ iptables è§„åˆ™ï¼Œé»˜è®¤æŸ¥çœ‹çš„æ˜¯ filter è¡¨ä¸­çš„è§„åˆ™ã€‚\n\n\u0060\u0060\u0060bash\n$ iptables -L -v\nChain INPUT (policy ACCEPT 350K packets, 63M bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 18M packets, 1916M bytes)\n pkts bytes target     prot opt in     out     source               destination\n\u0060\u0060\u0060\n\næˆ‘ä»¬çœ‹åˆ°ä¸‰ä¸ªé»˜è®¤çš„é“¾ï¼Œåˆ†åˆ«æ˜¯ INPUTã€FORWARD å’Œ OUTPUTï¼Œæ¯ä¸ªé“¾ä¸­çš„ç¬¬ä¸€è¡Œè¾“å‡ºè¡¨ç¤ºé“¾åç§°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º INPUT\/FORWARD\/OUTPUTï¼‰ï¼Œåè·Ÿé»˜è®¤ç­–ç•¥ï¼ˆACCEPTï¼‰ã€‚\n\næ¯æ¡é“¾ä¸­éƒ½å¯ä»¥æ·»åŠ å¤šæ¡è§„åˆ™ï¼Œè§„åˆ™æ˜¯æŒ‰ç…§é¡ºåºä»å‰åˆ°åæ‰§è¡Œçš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è§„åˆ™çš„è¡¨å¤´å®šä¹‰ã€‚\n\n- **pkts**ï¼šå¤„ç†è¿‡çš„åŒ¹é…çš„æŠ¥æ–‡æ•°é‡\n- **bytes**ï¼šç´¯è®¡å¤„ç†çš„æŠ¥æ–‡å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰\n- **target**ï¼šå¦‚æœæŠ¥æ–‡ä¸è§„åˆ™åŒ¹é…ï¼ŒæŒ‡å®šç›®æ ‡å°±ä¼šè¢«æ‰§è¡Œã€‚\n- **prot**ï¼šåè®®ï¼Œä¾‹å¦‚ \u0060tdp\u0060ã€\u0060udp\u0060ã€\u0060icmp\u0060 å’Œ \u0060all\u0060ã€‚ \n- **opt**ï¼šå¾ˆå°‘ä½¿ç”¨ï¼Œè¿™ä¸€åˆ—ç”¨äºæ˜¾ç¤º IP é€‰é¡¹ã€‚\n- **in**ï¼šå…¥ç«™ç½‘å¡ã€‚\n- **out**ï¼šå‡ºç«™ç½‘å¡ã€‚\n- **source**ï¼šæµé‡çš„æº IP åœ°å€æˆ–å­ç½‘ï¼Œåè€…æ˜¯ \u0060anywhere\u0060ã€‚\n- **destination**ï¼šæµé‡çš„ç›®çš„åœ° IP åœ°å€æˆ–å­ç½‘ï¼Œæˆ–è€…æ˜¯ \u0060anywhere\u0060ã€‚\n\nè¿˜æœ‰ä¸€åˆ—æ²¡æœ‰è¡¨å¤´ï¼Œæ˜¾ç¤ºåœ¨æœ€åï¼Œè¡¨ç¤ºè§„åˆ™çš„é€‰é¡¹ï¼Œä½œä¸ºè§„åˆ™çš„æ‰©å±•åŒ¹é…æ¡ä»¶ï¼Œç”¨æ¥è¡¥å……å‰é¢çš„å‡ åˆ—ä¸­çš„é…ç½®ã€‚\u0060prot\u0060ã€\u0060opt\u0060ã€\u0060in\u0060ã€\u0060out\u0060ã€\u0060source\u0060 å’Œ \u0060destination\u0060 å’Œæ˜¾ç¤ºåœ¨ \u0060destination\u0060 åé¢çš„æ²¡æœ‰è¡¨å¤´çš„ä¸€åˆ—æ‰©å±•æ¡ä»¶å…±åŒç»„æˆåŒ¹é…è§„åˆ™ã€‚å½“æµé‡åŒ¹é…è¿™äº›è§„åˆ™åå°±ä¼šæ‰§è¡Œ \u0060target\u0060ã€‚\n\n\n**target æ”¯æŒçš„ç±»å‹**\n\n\u0060target\u0060 ç±»å‹åŒ…æ‹¬ ACCEPT\u0060ã€REJECT\u0060ã€\u0060DROP\u0060ã€\u0060LOG\u0060 ã€\u0060SNAT\u0060ã€\u0060MASQUERADE\u0060ã€\u0060DNAT\u0060ã€\u0060REDIRECT\u0060ã€\u0060RETURN\u0060 æˆ–è€…è·³è½¬åˆ°å…¶ä»–è§„åˆ™ç­‰ã€‚åªè¦æ‰§è¡Œåˆ°æŸä¸€æ¡é“¾ä¸­åªæœ‰æŒ‰ç…§é¡ºåºæœ‰ä¸€æ¡è§„åˆ™åŒ¹é…åå°±å¯ä»¥ç¡®å®šæŠ¥æ–‡çš„å»å‘äº†ï¼Œé™¤äº† \u0060RETURN\u0060 ç±»å‹ï¼Œç±»ä¼¼ç¼–ç¨‹è¯­è¨€ä¸­çš„ \u0060return\u0060 è¯­å¥ï¼Œè¿”å›åˆ°å®ƒçš„è°ƒç”¨ç‚¹ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ã€‚\u0060target\u0060 æ”¯æŒçš„é…ç½®è¯¦è§£è¯·å‚è€ƒ [iptables è¯¦è§£ï¼ˆ1ï¼‰ï¼šiptables æ¦‚å¿µ](http:\/\/www.zsythink.net\/archives\/1199)ã€‚\n\nä»è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ° Init å®¹å™¨æ²¡æœ‰åœ¨ iptables çš„é»˜è®¤é“¾è·¯ä¸­åˆ›å»ºä»»ä½•è§„åˆ™ï¼Œè€Œæ˜¯åˆ›å»ºäº†æ–°çš„é“¾è·¯ã€‚\n\n## æŸ¥çœ‹ iptables nat è¡¨ä¸­æ³¨å…¥çš„è§„åˆ™\n\nInit å®¹å™¨é€šè¿‡å‘ iptables nat è¡¨ä¸­æ³¨å…¥è½¬å‘è§„åˆ™æ¥åŠ«æŒæµé‡çš„ï¼Œä¸‹å›¾æ˜¾ç¤ºçš„æ˜¯ä¸‰ä¸ª reviews æœåŠ¡ç¤ºä¾‹ä¸­çš„æŸä¸€ä¸ª Podï¼Œå…¶ä¸­æœ‰ init å®¹å™¨ã€åº”ç”¨å®¹å™¨å’Œ sidecar å®¹å™¨ï¼Œå›¾ä¸­å±•ç¤ºäº† iptables æµé‡åŠ«æŒçš„è¯¦ç»†è¿‡ç¨‹ã€‚\n\n![Envoy sidecar æµé‡åŠ«æŒä¸è·¯ç”±è½¬å‘ç¤ºæ„å›¾](istio-iptables.svg)\n\nInit å®¹å™¨å¯åŠ¨æ—¶å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šäº† \u0060REDIRECT\u0060 æ¨¡å¼ï¼Œå› æ­¤åªåˆ›å»ºäº† NAT è¡¨è§„åˆ™ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŸ¥çœ‹ä¸‹ NAT è¡¨ä¸­åˆ›å»ºçš„è§„åˆ™ï¼Œè¿™æ˜¯å…¨æ–‡ä¸­çš„**é‡ç‚¹éƒ¨åˆ†**ï¼Œå‰é¢è®²äº†é‚£ä¹ˆå¤šéƒ½æ˜¯ä¸ºå®ƒåšé“ºå«çš„ã€‚\n\n### è¿›å…¥åˆ° reviews pod\n\nReviews æœåŠ¡æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°å…¶ä¸­ä»»æ„ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¾‹å¦‚ reviews-1ï¼Œé¦–å…ˆä½ éœ€è¦ææ¸…æ¥šè¿™ä¸ª pod è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼ŒçŸ¥é“é‚£ä¸ªå®¹å™¨çš„å…·ä½“ IDï¼Œç„¶åä½¿ç”¨ SSH ç™»å½•é‚£ä¸ªèŠ‚ç‚¹ï¼Œä½¿ç”¨ \u0060ps\u0060 å‘½ä»¤æŸ¥çœ‹åˆ°é‚£ä¸ªå®¹å™¨çš„å…·ä½“ IPï¼Œä½¿ç”¨ \u0060nsenter\u0060 å‘½ä»¤è¿›å…¥è¯¥å®¹å™¨ã€‚\n\n\u0060\u0060\u0060sh\nnsenter -t{PID} -n\n\u0060\u0060\u0060\n\n**ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ kubectl è¿›å…¥å®¹å™¨ï¼Ÿ**\n\nIstio å‘ pod ä¸­è‡ªåŠ¨æ³¨å…¥çš„ sidecar å®¹å™¨ï¼ˆåä¸º \u0060istio-proxy\u0060ï¼‰å…¶ä¸­é»˜è®¤çš„ç”¨æˆ·æ˜¯ \u0060istio-proxy\u0060ï¼Œè¯¥ç”¨æˆ·æ²¡æœ‰æƒé™æŸ¥çœ‹è·¯ç”±è¡¨è§„åˆ™ï¼Œå³å½“ä½ åœ¨è¯¥å®¹å™¨ä¸­è¿è¡Œ \u0060iptabes\u0060 å‘½ä»¤æ—¶ä¼šå¾—åˆ° \u0060iptables -t nat -L -v\u0060 è¿™æ ·çš„ç»“æœï¼Œè€Œä¸”ä½ åˆæ²¡æœ‰ root æƒé™ã€‚å¯¹äº reviews å®¹å™¨ä¹Ÿæ˜¯ä¸€æ ·ï¼Œé»˜è®¤ç”¨æˆ·çš„ UID æ˜¯ \u00601000\u0060ï¼Œè€Œä¸”è¿™ä¸ªç”¨æˆ·åˆæ²¡æœ‰åå­—ï¼Œä¸€æ ·ä¹Ÿæ— æ³•åˆ‡æ¢ä¸º root ç”¨æˆ·ï¼Œç³»ç»Ÿä¸­é»˜è®¤æ²¡æœ‰å®‰è£… iptabels å‘½ä»¤ã€‚æ‰€ä»¥æˆ‘ä»¬åªèƒ½ç™»å½•åˆ° Pod çš„å®¿ä¸»èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨ \u0060nsenter\u0060 å‘½ä»¤è¿›å…¥å®¹å™¨å†…éƒ¨ã€‚\n\n### æŸ¥çœ‹è·¯ç”±è¡¨\n\nä¸‹é¢æ˜¯æŸ¥çœ‹ nat è¡¨ä¸­çš„è§„åˆ™ï¼Œå…¶ä¸­é“¾çš„åå­—ä¸­åŒ…å« \u0060ISTIO\u0060 å‰ç¼€çš„æ˜¯ç”± Init å®¹å™¨æ³¨å…¥çš„ï¼Œè§„åˆ™åŒ¹é…æ˜¯æ ¹æ®ä¸‹é¢æ˜¾ç¤ºçš„é¡ºåºæ¥æ‰§è¡Œçš„ï¼Œå…¶ä¸­ä¼šæœ‰å¤šæ¬¡è·³è½¬ã€‚\n\n\u0060\u0060\u0060bash\n# æŸ¥çœ‹ NAT è¡¨ä¸­è§„åˆ™é…ç½®çš„è¯¦ç»†ä¿¡æ¯\n$ iptables -t nat -L -v\n# PREROUTING é“¾ï¼šç”¨äºç›®æ ‡åœ°å€è½¬æ¢ï¼ˆDNATï¼‰ï¼Œå°†æ‰€æœ‰å…¥ç«™ TCP æµé‡è·³è½¬åˆ° ISTIO_INBOUND é“¾ä¸Š\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    2   120 ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere\n\n# INPUT é“¾ï¼šå¤„ç†è¾“å…¥æ•°æ®åŒ…ï¼Œé TCP æµé‡å°†ç»§ç»­ OUTPUT é“¾\nChain INPUT (policy ACCEPT 2 packets, 120 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\n# OUTPUT é“¾ï¼šå°†æ‰€æœ‰å‡ºç«™æ•°æ®åŒ…è·³è½¬åˆ° ISTIO_OUTPUT é“¾ä¸Š\nChain OUTPUT (policy ACCEPT 41146 packets, 3845K bytes)\n pkts bytes target     prot opt in     out     source               destination\n   93  5580 ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere\n\n# POSTROUTING é“¾ï¼šæ‰€æœ‰æ•°æ®åŒ…æµå‡ºç½‘å¡æ—¶éƒ½è¦å…ˆè¿›å…¥POSTROUTING é“¾ï¼Œå†…æ ¸æ ¹æ®æ•°æ®åŒ…ç›®çš„åœ°åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬å‘å‡ºå»ï¼Œæˆ‘ä»¬çœ‹åˆ°æ­¤å¤„æœªåšä»»ä½•å¤„ç†\nChain POSTROUTING (policy ACCEPT 41199 packets, 3848K bytes)\n pkts bytes target     prot opt in     out     source               destination\n\n# ISTIO_INBOUND é“¾ï¼šå°†æ‰€æœ‰ç›®çš„åœ°ä¸º 9080 ç«¯å£çš„å…¥ç«™æµé‡é‡å®šå‘åˆ° ISTIO_IN_REDIRECT é“¾ä¸Š\nChain ISTIO_INBOUND (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   120 ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere             tcp dpt:9080\n\n# ISTIO_IN_REDIRECT é“¾ï¼šå°†æ‰€æœ‰çš„å…¥ç«™æµé‡è·³è½¬åˆ°æœ¬åœ°çš„ 15006 ç«¯å£ï¼Œè‡³æ­¤æˆåŠŸçš„æ‹¦æˆªäº†æµé‡åˆ° Envoy \nChain ISTIO_IN_REDIRECT (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    2   120 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15006\n\n# ISTIO_OUTPUT é“¾ï¼šé€‰æ‹©éœ€è¦é‡å®šå‘åˆ° Envoyï¼ˆå³æœ¬åœ°ï¼‰ çš„å‡ºç«™æµé‡ï¼Œæ‰€æœ‰é localhost çš„æµé‡å…¨éƒ¨è½¬å‘åˆ° ISTIO_REDIRECTã€‚ä¸ºäº†é¿å…æµé‡åœ¨è¯¥ Pod ä¸­æ— é™å¾ªç¯ï¼Œæ‰€æœ‰åˆ° istio-proxy ç”¨æˆ·ç©ºé—´çš„æµé‡éƒ½è¿”å›åˆ°å®ƒçš„è°ƒç”¨ç‚¹ä¸­çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œæœ¬ä¾‹ä¸­å³ OUTPUT é“¾ï¼Œå› ä¸ºè·³å‡º ISTIO_OUTPUT è§„åˆ™ä¹‹åå°±è¿›å…¥ä¸‹ä¸€æ¡é“¾ POSTROUTINGã€‚å¦‚æœç›®çš„åœ°é localhost å°±è·³è½¬åˆ° ISTIO_REDIRECTï¼›å¦‚æœæµé‡æ˜¯æ¥è‡ª istio-proxy ç”¨æˆ·ç©ºé—´çš„ï¼Œé‚£ä¹ˆå°±è·³å‡ºè¯¥é“¾ï¼Œè¿”å›å®ƒçš„è°ƒç”¨é“¾ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ï¼ˆOUPT çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œæ— éœ€å¯¹æµé‡è¿›è¡Œå¤„ç†ï¼‰ï¼›æ‰€æœ‰çš„é istio-proxy ç”¨æˆ·ç©ºé—´çš„ç›®çš„åœ°æ˜¯ localhost çš„æµé‡å°±è·³è½¬åˆ° ISTIO_REDIRECT\nChain ISTIO_OUTPUT (1 references)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 ISTIO_REDIRECT  all  --  any    lo      anywhere            !localhost\n   40  2400 RETURN     all  --  any    any     anywhere             anywhere             owner UID match istio-proxy\n    0     0 RETURN     all  --  any    any     anywhere             anywhere             owner GID match istio-proxy\t\n    0     0 RETURN     all  --  any    any     anywhere             localhost\n   53  3180 ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere\n\n# ISTIO_REDIRECT é“¾ï¼šå°†æ‰€æœ‰æµé‡é‡å®šå‘åˆ° Envoyï¼ˆå³æœ¬åœ°ï¼‰ çš„ 15001 ç«¯å£\nChain ISTIO_REDIRECT (2 references)\n pkts bytes target     prot opt in     out     source               destination\n   53  3180 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15001\n\u0060\u0060\u0060\n\n\u0060iptables\u0060 æ˜¾ç¤ºçš„é“¾çš„é¡ºåºï¼Œå³æµé‡è§„åˆ™åŒ¹é…çš„é¡ºåºã€‚å…¶ä¸­è¦ç‰¹åˆ«æ³¨æ„ \u0060ISTIO_OUTPUT\u0060 é“¾ä¸­çš„è§„åˆ™é…ç½®ã€‚ä¸ºäº†é¿å…æµé‡ä¸€ç›´åœ¨ Pod ä¸­æ— é™å¾ªç¯ï¼Œæ‰€æœ‰åˆ° istio-proxy ç”¨æˆ·ç©ºé—´çš„æµé‡éƒ½è¿”å›åˆ°å®ƒçš„è°ƒç”¨ç‚¹ä¸­çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œæœ¬ä¾‹ä¸­å³ OUTPUT é“¾ï¼Œå› ä¸ºè·³å‡º \u0060ISTIO_OUTPUT\u0060 è§„åˆ™ä¹‹åå°±è¿›å…¥ä¸‹ä¸€æ¡é“¾ \u0060POSTROUTING\u0060ã€‚\n\n\u0060ISTIO_OUTPUT\u0060 é“¾è§„åˆ™åŒ¹é…çš„è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n- å¦‚æœç›®çš„åœ°é localhost å°±è·³è½¬åˆ° ISTIO_REDIRECT é“¾\n- æ‰€æœ‰æ¥è‡ª istio-proxy ç”¨æˆ·ç©ºé—´çš„é localhost æµé‡è·³è½¬åˆ°å®ƒçš„è°ƒç”¨ç‚¹ \u0060OUTPUT\u0060 ç»§ç»­æ‰§è¡Œ \u0060OUTPUT\u0060 é“¾çš„ä¸‹ä¸€æ¡è§„åˆ™ï¼Œå› ä¸º \u0060OUTPUT\u0060 é“¾ä¸­æ²¡æœ‰ä¸‹ä¸€æ¡è§„åˆ™äº†ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ‰§è¡Œ \u0060POSTROUTING\u0060 é“¾ç„¶åè·³å‡º iptablesï¼Œç›´æ¥è®¿é—®ç›®çš„åœ°\n- å¦‚æœæµé‡ä¸æ˜¯æ¥è‡ª istio-proxy ç”¨æˆ·ç©ºé—´ï¼Œåˆæ˜¯å¯¹ localhost çš„è®¿é—®ï¼Œé‚£ä¹ˆå°±è·³å‡º iptablesï¼Œç›´æ¥è®¿é—®ç›®çš„åœ°\n- å…¶å®ƒæ‰€æœ‰æƒ…å†µéƒ½è·³è½¬åˆ° \u0060ISTIO_REDIRECT\u0060 é“¾\n\nå…¶å®åœ¨æœ€åè¿™æ¡è§„åˆ™å‰è¿˜å¯ä»¥å¢åŠ  IP åœ°å€è¿‡æ»¤ï¼Œè®©æŸäº› IP åœ°å€æ®µä¸é€šè¿‡ Envoy ä»£ç†ã€‚\n\nä»¥ä¸Š iptables è§„åˆ™éƒ½æ˜¯ Init å®¹å™¨å¯åŠ¨çš„æ—¶ä½¿ç”¨ [istio-iptables](https:\/\/github.com\/istio\/istio\/tree\/master\/tools\/istio-iptables) å‘½ä»¤ç”Ÿæˆçš„ï¼Œè¯¦ç»†è¿‡ç¨‹å¯ä»¥æŸ¥çœ‹è¯¥å‘½ä»¤è¡Œç¨‹åºã€‚\n\n## å‚è€ƒ\n\n- [Init å®¹å™¨ - Kubernetes ä¸­æ–‡æŒ‡å—\/äº‘åŸç”Ÿåº”ç”¨æ¶æ„å®è·µæ‰‹å†Œ - jimmysong.io](\/book\/kubernetes-handbook\/objects\/init-containers\/)\n- [JSONPath Support - kubernetes.io](https:\/\/kubernetes.io\/docs\/reference\/kubectl\/jsonpath\/)\n- [iptables å‘½ä»¤ä½¿ç”¨è¯´æ˜ - wangchujiang.com](https:\/\/wangchujiang.com\/linux-command\/c\/iptables.html)\n- [How To List and Delete Iptables Firewall Rules - digitalocean.com](https:\/\/www.digitalocean.com\/community\/tutorials\/how-to-list-and-delete-iptables-firewall-rules)\n- [ä¸€å¥ä¸€å¥è§£è¯´ iptables çš„è¯¦ç»†ä¸­æ–‡æ‰‹å†Œ - cnblog.com](https:\/\/www.cnblogs.com\/fhefh\/archive\/2011\/04\/04\/2005249.html)\n', '\/blog\/envoy-sidecar-injection-in-istio-service-mesh-deep-dive\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">ä»¥å¾€æœ‰å¾ˆå¤šæ–‡ç« è®²è§£ Istio æ˜¯å¦‚ä½•åš Sidecar æ³¨å…¥çš„ï¼Œä½†æ˜¯æ²¡æœ‰è®²è§£æ³¨å…¥ä¹‹å Sidecar å·¥ä½œçš„ç»†èŠ‚ã€‚æœ¬æ–‡å°†å¸¦å¤§å®¶è¯¦ç»†äº†è§£ Istio æ˜¯å¦‚ä½•å°† Envoy ä½œä¸º Sidecar çš„æ–¹å¼æ³¨å…¥åˆ°åº”ç”¨ç¨‹åº Pod ä¸­ï¼ŒåŠ Sidecar æ˜¯å¦‚ä½•åšåŠ«æŒæµé‡çš„ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/sofamesh-and-mosn-proxy-sidecar-service-mesh-by-ant-financial/">èš‚èšé›†å›¢å¼€æº SOFAMesh</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/07/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('èš‚èšé›†å›¢å¼€æº SOFAMesh', 'èš‚èšé›†å›¢å¼€æº SOFAMeshâ€”ä¸€æ¬¾åŸºäº Istio æ”¹è¿›å’Œæ‰©å±•è€Œæ¥çš„ Service Mesh å¤§è§„æ¨¡è½åœ°å®è·µæ–¹æ¡ˆã€‚', '\n{{\u003ccallout warning æ³¨æ„\u003e}}\n\nSOFAMesh å·²é—­æºï¼Œæœ¬æ–‡å·²è¿‡æ—¶ã€‚\n\n{{\u003c\/callout\u003e}}\n\n4 æœˆï¼Œèš‚èšé›†å›¢è‡ªä¸»ç ”å‘çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼ˆScalable Open Financial Architectureï¼Œä»¥ä¸‹ç®€ç§° SOFAï¼‰å¯åŠ¨å¼€æºè®¡åˆ’ï¼Œå¹¶å¼€æ”¾å¤šä¸ªç»„ä»¶ï¼Œï¼ˆç›¸å…³èƒŒæ™¯è¯·ç‚¹å‡»é“¾æ¥é˜…è¯»ã€Š[å¼€æº | èš‚èšé›†å›¢å¯åŠ¨åˆ†å¸ƒå¼ä¸­é—´ä»¶å¼€æºè®¡åˆ’ï¼Œç”¨äºå¿«é€Ÿæ„å»ºé‡‘èçº§äº‘åŸç”Ÿæ¶æ„](http:\/\/mp.weixin.qq.com\/s?__biz=MzI0Nzc3MTQyMw==\u0026mid=2247484729\u0026idx=1\u0026sn=0d8dbee2739fb0eef3e4ad699661fd13\u0026chksm=e9abbd49dedc345fd5d6898fd1989710f249d6386bf3d52ae1603365a4a1c3696538bc8b9a8f\u0026scene=21#wechat_redirect) ã€‹ã€ã€Š[å¼€æº | èš‚èšé›†å›¢åˆ†å¸ƒå¼ä¸­é—´ä»¶å¼€æºç¬¬äºŒå¼¹ï¼šä¸°å¯Œå¾®æœåŠ¡æ¶æ„ä½“ç³»](http:\/\/mp.weixin.qq.com\/s?__biz=MzI0Nzc3MTQyMw==\u0026mid=2247485026\u0026idx=1\u0026sn=0a367bc67d5fe3a268e3715b17e020ab\u0026chksm=e9abbe12dedc370489102d9307b832457891fdb0530eec5c35c0fb82bc2a3e6dbbc7db8436c4\u0026scene=21#wechat_redirect) ã€‹ï¼‰ï¼Œè¿™ä¸€ç³»åˆ—çš„åŠ¨ä½œå—åˆ°å¤§å®¶çš„å…³æ³¨å’Œæ”¯æŒï¼ŒSOFA ç¤¾åŒºä¹Ÿæ—¥ç›Šå£®å¤§ã€‚\n\nåœ¨ä¸¤è½®å¼€æºä¹‹åï¼Œèš‚èšé›†å›¢è‡ªä¸»ç ”å‘çš„åˆ†å¸ƒå¼ä¸­é—´ä»¶ï¼ˆScalable Open Financial Architectureï¼Œä»¥ä¸‹ç®€ç§° SOFAï¼‰åœ¨ä»Šå¤©æ¨å‡ºäº†**ç¬¬ä¸‰è½®çš„å¼€æºäº§å“ï¼šSOFAMesh**ã€‚å’Œå‰ä¸¤è½®å¼€æºçš„å†ç»å¤šå¹´æ²‰æ·€å’Œæ‰“ç£¨çš„æˆç†Ÿäº§å“ä¸åŒï¼Œæœ¬è½®çš„å¼€æºä¸»è§’ SOFAMeshï¼Œå°†æ¢ç´¢ä¸€æ¡å’Œä»¥å¾€äº§å“æœ‰æ‰€ä¸åŒçš„å¼€æºé“è·¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹åˆ°åº•æœ‰å“ªäº›ä¸åŒå§ï¼\n\n## SOFAMesh çš„å¼€æºæ¢ç´¢ä¹‹è·¯\n\nSOFAMesh å°è¯•åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œè‡ªæˆ‘çªç ´å’Œå‹‡æ•¢æ¢ç´¢ï¼š\n\n**å…¨æ–°çš„æŠ€æœ¯é¢†åŸŸ**\n\nService Mesh æ˜¯ç›®å‰æŠ€æœ¯ç¤¾åŒºæœ€ä¸ºç‚™æ‰‹å¯çƒ­çš„æ–°æŠ€æœ¯æ–¹å‘ï¼Œæœ‰ä¸‹ä¸€ä»£å¾®æœåŠ¡çš„æ˜æ˜¾è¶‹åŠ¿ã€‚ä½†æ˜¯ç›®å‰ Service Mesh æŠ€æœ¯è¿˜å¤„äºå‘å±•æ—©æœŸï¼Œæš‚æ—¶è¿˜æ²¡æœ‰æˆç†Ÿçš„äº§å“ï¼Œå°¤å…¶ç¼ºä¹å¤§è§„æ¨¡çš„è½åœ°å®è·µã€‚\n\n**è¾ƒæ—©çš„å¼€æºæ—¶é—´**\n\nåœ¨ä¸Šè¿°èƒŒæ™¯ä¸‹ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å°†å¯åŠ¨ä¸ä¹…çš„ Service Mesh äº§å“å¼€æºåœ¨å¼€å‘æ—©æœŸï¼Œä¹Ÿå°±æ˜¯è¿˜æœªæˆç†Ÿä¹‹æ—¶ï¼Œå°±å¯¹ç¤¾åŒºå¼€æ”¾ï¼Œå¼€æ”¾æºç å¹¶å¯»æ±‚ç¤¾åŒºåˆä½œã€‚\n\n**æ›´åŠ å¼€æ”¾çš„æ€åº¦**\n\nåœ¨ SOFAMesh ä¸Šï¼Œæˆ‘ä»¬æ„¿æ„ä»¥å¼€æºå…±å»ºçš„æ–¹å¼æ¥å’Œç¤¾åŒºä¸€èµ·æ¨è¿› Service Mesh æŠ€æœ¯çš„æ›´å¥½å‘å±•å’Œå®ç°è½åœ°å®è·µï¼Œå…±åŒæ‰“é€ ä¸€ä¸ªæŠ€æœ¯å…ˆè¿›ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œå…·å¤‡è‰¯å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œå¯ä»¥å®å®åœ¨åœ¨çš„ç”Ÿäº§è½åœ°çš„ä¼˜ç§€äº§å“ã€‚æ¬¢è¿å›½å†…æŠ€æœ¯ç¤¾åŒºçš„æœ‹å‹ä»¬å’Œæˆ‘ä»¬å¼€å±•ä¸åŒå±‚é¢çš„äº¤æµä¸åˆä½œã€‚\n\n**åŠ¡å®çš„äº§å“è·¯çº¿**\n\nSOFAMesh åœ¨äº§å“è·¯çº¿ä¸Šï¼Œé€‰æ‹©äº†è·Ÿéšç¤¾åŒºä¸»æµï¼Œæˆ‘ä»¬é€‰æ‹©äº†ç›®å‰ Service Mesh ä¸­æœ€æœ‰å½±å“åŠ›å’Œå‰æ™¯çš„ Istioã€‚SOFAMesh ä¼šåœ¨ Istio çš„åŸºç¡€ä¸Šï¼Œæå‡æ€§èƒ½ï¼Œå¢åŠ æ‰©å±•æ€§ï¼Œå¹¶åœ¨è½åœ°å®è·µä¸Šåšæ¢ç´¢å’Œè¡¥å……ï¼Œä»¥å¼¥è¡¥ç›®å‰ Istio çš„ä¸è¶³ï¼ŒåŒæ—¶ä¿æŒä¸ Istio ç¤¾åŒºçš„æ­¥éª¤ä¸€è‡´å’ŒæŒç»­è·Ÿè¿›ã€‚\n\n## SOFAMesh ä»‹ç»\n\nSOFAMesh å°†åœ¨å…¼å®¹ Istio æ•´ä½“æ¶æ„å’Œåè®®çš„åŸºç¡€ä¸Šï¼Œåšå‡ºéƒ¨åˆ†è°ƒæ•´ï¼š\n\n1. ä½¿ç”¨ Golang è¯­è¨€å¼€å‘å…¨æ–°çš„ Sidecarï¼Œæ›¿ä»£ Envoy\n2. ä¸ºäº†é¿å… Mixer å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆï¼Œåˆå¹¶ Mixer éƒ¨åˆ†åŠŸèƒ½è¿›å…¥ Sidecar\n3. Pilot å’Œ Citadel æ¨¡å—è¿›è¡Œäº†å¤§å¹…çš„æ‰©å±•å’Œå¢å¼º\n\næˆ‘ä»¬çš„ç›®æ ‡ï¼šæ‰“é€ ä¸€ä¸ªæ›´åŠ åŠ¡å®çš„ Istio è½åœ°ç‰ˆæœ¬ï¼\n\n{{\u003ccallout note å¤‡æ³¨\u003e}}\n\nä»¥ä¸Šæ¶æ„è°ƒæ•´çš„ç»†èŠ‚ä»¥åŠæˆ‘ä»¬åšè°ƒæ•´çš„å‡ºå‘ç‚¹å’ŒåŸå› ï¼Œè¯·æµè§ˆ [èš‚èšé›†å›¢å¤§è§„æ¨¡å¾®æœåŠ¡æ¶æ„ä¸‹çš„ Service Mesh æ¢ç´¢ä¹‹è·¯](https:\/\/cloudnative.to\/blog\/the-way-to-service-mesh-in-ant-financial\/) ä¸€æ–‡ï¼Œæœ‰éå¸¸è¯¦å°½çš„è§£é‡Šã€‚\n\n{{\u003c\/callout\u003e}}\n\n## å¼€æºå†…å®¹\n\nåœ¨æœ¬è½®å¼€æºä¸­ï¼Œæˆ‘ä»¬å°†æ¨å‡º SOFAMesh ç›®å‰æ­£åœ¨å¼€å‘çš„ä¸¤å¤§æ¨¡å—ï¼šMOSN å’Œ SOFAPilotã€‚\n\n## MOSN\n\nSOFAMesh ä¸­ Golang ç‰ˆæœ¬çš„ Sidecarï¼Œæ˜¯ä¸€ä¸ªåä¸º MOSN (Modular Observable Smart Netstub) çš„å…¨æ–°å¼€å‘çš„æ¨¡å—ï¼Œå®ç° Envoy çš„åŠŸèƒ½ï¼Œå…¼å®¹ Envoy çš„ APIï¼Œå¯ä»¥å’Œ Istio é›†æˆã€‚\n\n![MOSN æ¶æ„å›¾](mosn-with-service-mesh.png)\n\næ­¤å¤–ï¼Œæˆ‘ä»¬ä¼šå¢åŠ å¯¹ SOFARPCã€Dubbo ç­‰é€šè®¯åè®®çš„æ”¯æŒï¼Œä»¥ä¾¿æ›´å¥½çš„è¿åˆå›½å†…ç”¨æˆ·åŒ…æ‹¬æˆ‘ä»¬è‡ªèº«çš„å®é™…éœ€æ±‚ã€‚\n\nç”±äº Sidecar ç›¸å¯¹ç‹¬ç«‹ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿé¢„æœŸä¼šæœ‰å•ç‹¬ä½¿ç”¨ MOSN çš„åœºæ™¯ï¼Œå› æ­¤ MOSN çš„ä»£ç ä»“åº“æ˜¯ç‹¬ç«‹äº SOFAMesh çš„ï¼Œåœ°å€ä¸ºï¼šhttps:\/\/github.com\/mosn\/mosn\n\næ¬¢è¿å¤§å®¶ä½¿ç”¨ï¼Œæä¾›éœ€æ±‚ã€åé¦ˆé—®é¢˜ã€è´¡çŒ®ä»£ç æˆ–è€…åˆä½œå¼€å‘ã€‚\n\n## SOFAPilot\n\næˆ‘ä»¬å°†å¤§å¹…æ‰©å±•å’Œå¢å¼º Istio ä¸­çš„ Pilot æ¨¡å—ï¼š\n\n1. å¢åŠ  SOFARegistry çš„ Adapterï¼Œæä¾›è¶…å¤§è§„æ¨¡æœåŠ¡æ³¨å†Œå’Œå‘ç°çš„è§£å†³æ–¹æ¡ˆ\n2. å¢åŠ æ•°æ®åŒæ­¥æ¨¡å—ï¼Œä»¥å®ç°å¤šä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚\n3. å¢åŠ  Open Service Registry APIï¼Œæä¾›æ ‡å‡†åŒ–çš„æœåŠ¡æ³¨å†ŒåŠŸèƒ½\n\nMOSN å’Œ SOFAPilot é…åˆï¼Œå°†å¯ä»¥æä¾›è®©ä¼ ç»Ÿä¾µå…¥å¼æ¡†æ¶ï¼ˆå¦‚ Spring Cloudï¼ŒDubboï¼ŒSOFA RPC ç­‰ï¼‰å’Œ Service Mesh äº§å“å¯ä»¥ç›¸äº’é€šè®¯çš„åŠŸèƒ½ï¼Œä»¥ä¾¿å¯ä»¥å¹³æ»‘çš„å‘ Service Mesh äº§å“æ¼”è¿›å’Œè¿‡æ¸¡ã€‚\n\n**Pilot å’Œåé¢ä¼šé™†ç»­å¼€æ”¾çš„ Mixerï¼ŒCitadel ç­‰ Istio æ¨¡å—**ï¼Œä¼šç»Ÿä¸€å­˜æ”¾åœ¨åŒä¸€ä¸ªä» Istio Fork å‡ºæ¥çš„ä»£ç ä»“åº“ä¸­ã€‚æœªæ¥ä¼šæŒç»­æ›´æ–° Istio æœ€æ–°ä»£ç ï¼Œä»¥ä¿æŒå’Œ Istio çš„ä¸€è‡´ã€‚\n\n## é™„å½•\n\næœ¬æ–‡ä¸­æåˆ°çš„é“¾æ¥åœ°å€é›†åˆï¼š\n\n- [MOSN](https:\/\/github.com\/mosn\/mosn)\n- [èš‚èšé›†å›¢å¤§è§„æ¨¡å¾®æœåŠ¡æ¶æ„ä¸‹çš„ Service Mesh æ¢ç´¢ä¹‹è·¯](https:\/\/cloudnative.to\/blog\/the-way-to-service-mesh-in-ant-financial\/)\n', '\/blog\/sofamesh-and-mosn-proxy-sidecar-service-mesh-by-ant-financial\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">èš‚èšé›†å›¢å¼€æº SOFAMeshâ€”ä¸€æ¬¾åŸºäº Istio æ”¹è¿›å’Œæ‰©å±•è€Œæ¥çš„ Service Mesh å¤§è§„æ¨¡è½åœ°å®è·µæ–¹æ¡ˆã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/tracing-grpc-with-istio/">[è¯‘] åœ¨ Istio ä¸­è·Ÿè¸ª gRPC</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/06/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('åœ¨ Istio ä¸­è·Ÿè¸ª gRPC', 'æœ¬æ–‡ä»‹ç»çš„æ˜¯å¦‚ä½•åœ¨ Istio ä¸­ä½¿ç”¨ grpc å¹¶è®¾ç½®è·Ÿè¸ªï¼ˆtracingï¼‰ä¸ header ä¼ æ’­ï¼ŒåŒ…æ‹¬ gRPC åˆ° grpc è¯·æ±‚ä¼ æ’­ headerã€gRPC åˆ° HTTP è¯·æ±‚ä¼ æ’­ headerã€ä½¿ç”¨ grpc-gateway æ—¶ä¼ æ’­ header ç­‰', '\nAspen Mesh å¾ˆå–œæ¬¢ç”¨[gRPC](https:\/\/grpc.io\/docs\/)ã€‚Apen Mesh é¢å‘å…¬ä¼—çš„ API å’Œè®¸å¤šå†…éƒ¨ API å¤§å¤šéƒ½æ˜¯ä½¿ç”¨ gRPC æ„å»ºçš„ã€‚å¦‚æœæ‚¨è¿˜æ²¡æœ‰å¬è¯´è¿‡ gRPCï¼ˆç†Ÿç»ƒæŒæ¡ gRPC çœŸçš„å¾ˆéš¾ï¼‰ï¼Œé‚£ä¹ˆæˆ‘å…ˆä¸ºæ‚¨ç®€å•çš„ä»‹ç»ä¸‹ï¼Œå®ƒæ˜¯ä¸€ç§æ–°å‹ã€é«˜æ•ˆå’Œä¼˜åŒ–çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ã€‚gRPC åŸºäº[protocol buffer](https:\/\/developers.google.com\/protocol-buffers\/)åºåˆ—åŒ–æ ¼å¼å’Œ[HTTP\/2](https:\/\/http2.github.io\/)ç½‘ç»œåè®®ã€‚\n\nä½¿ç”¨ HTTP\/2 åè®®ï¼ŒgRPC åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨å¤šè·¯å¤ç”¨è¯·æ±‚æ˜¾è‘—æé«˜è¿æ¥åˆ©ç”¨ç‡ï¼Œè€Œä¸”æ¯”èµ·å¦‚ HTTP\/1.1 ç­‰[å…¶ä»–åè®®](https:\/\/http2.github.io\/faq\/)å…·æœ‰æ›´å¤šå¢å¼ºåŠŸèƒ½ã€‚æ­¤å¤–ï¼Œprotocal buffer æ˜¯ä»¥äºŒè¿›åˆ¶æ–¹å¼å¯¹ç»“æ„åŒ–æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œè¿™æ¯”èµ·åŸºäºæ–‡æœ¬çš„åºåˆ—åŒ–æ–¹å¼æ›´ç®€å•ä¸”å¯æ‰©å±•ï¼Œè¿˜å¯ä»¥æ˜¾ç€æé«˜æ€§èƒ½ã€‚å°†è¿™ä¸¤ä¸ªç»“æœç»„åˆåœ¨ä¸€ä¸ªä½å»¶è¿Ÿå’Œé«˜åº¦å¯æ‰©å±•çš„ RPC æ¡†æ¶ä¸­ï¼Œè¿™å®è´¨ä¸Šå°±æ˜¯ gRPCã€‚æ­¤å¤–ï¼Œä¸æ–­å¢é•¿çš„ gRPC ç”Ÿæ€æ”¯æŒä½¿ç”¨å¤šç§è¯­è¨€ç¼–å†™åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚ï¼ˆC \u002b\u002bã€Javaã€Go ç­‰ï¼‰ï¼Œè¿˜åŒ…æ‹¬å¤§é‡ç¬¬ä¸‰æ–¹[åº“](https:\/\/github.com\/grpc-ecosystem)ã€‚\n\né™¤äº†ä¸Šé¢åˆ—å‡ºçš„å¥½å¤„ä¹‹å¤–ï¼ŒgRPC è®©æˆ‘æœ€å–œæ¬¢çš„ä¸€ç‚¹æ˜¯å¯ä»¥è®©æˆ‘ä»¥ç®€å•ç›´è§‚çš„æ–¹å¼æŒ‡å®š RPCï¼ˆä½¿ç”¨ protobuf IDLï¼‰ä»¥åŠå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡å™¨ç«¯çš„æ–¹æ³•ï¼Œå°±å¥½åƒæ˜¯è°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ã€‚å¾ˆå¤šä»£ç ï¼ˆæœåŠ¡æè¿°å’Œå¤„ç†ç¨‹åºã€å®¢æˆ·ç«¯æ–¹æ³•ç­‰ï¼‰éƒ½å¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œè¿™ä½¿å¾— gRPC éå¸¸å¥½ç”¨ã€‚\n\nç°åœ¨æˆ‘å·²ç»ä»‹ç»äº† gRPC çš„ä¸€äº›èƒŒæ™¯çŸ¥è¯†ï¼Œæˆ‘ä»¬å†æŠŠæ³¨æ„åŠ›è½¬å›åˆ°åšå®¢çš„ä¸»é¢˜ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•åœ¨åŸºäº gRPC çš„åº”ç”¨ç¨‹åºä¸­æ·»åŠ è·Ÿè¸ªï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ‚¨ä½¿ç”¨ Istio æˆ– Aspen Meshã€‚\n\nè·Ÿè¸ªï¼ˆTracingï¼‰éå¸¸é€‚åˆäºè°ƒè¯•å’Œç†è§£åº”ç”¨ç¨‹åºçš„è¡Œä¸ºã€‚ç†è§£æ‰€æœ‰è·Ÿè¸ªæ•°æ®çš„å…³é”®æ˜¯èƒ½å¤Ÿå…³è”æ¥è‡ªä¸å•ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ç›¸å…³çš„å¤šä¸ªä¸åŒå¾®æœåŠ¡çš„è·¨åº¦ï¼ˆspanï¼‰ã€‚\n\nä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å¾®æœåŠ¡åº”è¯¥ä¼ æ’­è·Ÿè¸ª headerã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯åƒ Istio æˆ– Aspen Mesh è¿™æ ·çš„æœåŠ¡ç½‘æ ¼ï¼Œingress å’Œ sidecar ä»£ç†ä¼šè‡ªåŠ¨æ·»åŠ é€‚å½“çš„è·Ÿè¸ª headerï¼Œå¹¶å°†è¿™äº› span æŠ¥å‘Šç»™è·Ÿè¸ªæ”¶é›†å™¨åç«¯ï¼Œå¦‚ Jaeger æˆ– Zipkinã€‚åº”ç”¨ç¨‹åºå”¯ä¸€è¦åšçš„å°±æ˜¯å°†ä¼ å…¥è¯·æ±‚ï¼ˆsidecar æˆ– ingress ä»£ç†æ·»åŠ çš„ï¼‰çš„è·Ÿè¸ª header ä¼ æ’­åˆ°å…¶å¯¹å…¶ä»–å¾®æœåŠ¡çš„æ‰€æœ‰ä¼ å‡ºè¯·æ±‚ã€‚\n\n## gRPC åˆ° grpc è¯·æ±‚ä¼ æ’­ header\n\nä½¿ç”¨ gRPCï¼Œè·Ÿè¸ª header ä¼ æ’­çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨[grpc opentracing middleware](https:\/\/github.com\/grpc-ecosystem\/go-grpc-middleware\/tree\/master\/tracing\/opentracing)åº“çš„å®¢æˆ·ç«¯æ‹¦æˆªå™¨ã€‚å¦‚æœæ‚¨çš„ gRPC åº”ç”¨ç¨‹åºåœ¨æ”¶åˆ°ä¼ å…¥è¯·æ±‚æ—¶å‘å‡ºæ–°çš„å‡ºç«™ gRPC è¯·æ±‚ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯å°†ä¼ å…¥çš„è·Ÿè¸ª header æ­£ç¡®ä¼ æ’­åˆ°ä¼ å‡ºçš„ gRPC è¯·æ±‚çš„ç¤ºä¾‹ä»£ç ï¼š\n\n\u0060\u0060\u0060go\n  import (\n    \u0022golang.org\/x\/net\/context\u0022\n    \u0022github.com\/grpc-ecosystem\/go-grpc-middleware\/tracing\/opentracing\u0022\n    \u0022ot \u0022github.com\/opentracing\/opentracing-go\u0022\n  )\n\n  \/\/ ctx is the incoming gRPC request\u0027s context\n  \/\/ addr is the address for the new outbound request\n  func createGRPCConn(ctx context.Context, addr string) (*grpc.ClientConn, error) {\n  \tvar opts []grpc.DialOption\n  \topts = append(opts, grpc.WithStreamInterceptor(\n  \t\tgrpc_opentracing.StreamClientInterceptor(\n  \t\t\tgrpc_opentracing.WithTracer(ot.GlobalTracer()))))\n  \topts = append(opts, grpc.WithUnaryInterceptor(\n  \t\tgrpc_opentracing.UnaryClientInterceptor(\n  \t\t\tgrpc_opentracing.WithTracer(ot.GlobalTracer()))))\n  \tconn, err := grpc.DialContext(ctx, addr, opts...)\n  \tif err != nil {\n  \t\tglog.Error(\u0022Failed to connect to application addr: \u0022, err)\n  \t\treturn nil, err\n  \t}\n  \treturn conn, nil\n  }\n\u0060\u0060\u0060\n\nå¾ˆç®€å•å¯¹å§ï¼Ÿ\n\næ·»åŠ  opentracing å®¢æˆ·ç«¯æ‹¦æˆªå™¨å¯ç¡®ä¿åœ¨å®¢æˆ·ç«¯è¿æ¥ä¸Šåˆ›å»ºä»»ä½•æ–°çš„ä¸€å…ƒï¼ˆunaryï¼‰æˆ–æµå¼ gRPC è¯·æ±‚æ³¨å…¥æ­£ç¡®çš„è·Ÿè¸ª headerã€‚å¦‚æœä¼ é€’çš„ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨è·Ÿè¸ª headerï¼ˆå¦‚ä½¿ç”¨ Aspen Mesh æˆ– Istio ä¼ å…¥å…¥ç«™ gRPC è¯·æ±‚ä¸Šä¸‹æ–‡ï¼‰ï¼Œåˆ™æ–°åˆ›å»ºçš„ span å°†ä½œä¸ºä¼ é€’çš„ä¸Šä¸‹æ–‡ä¸­å·²å­˜åœ¨çš„ span çš„å­ spanã€‚å¦å¤–ï¼Œå¦‚æœä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰è·Ÿè¸ªä¿¡æ¯ï¼Œåˆ™ä¼šä¸ºå‡ºç«™ gRPC è¯·æ±‚åˆ›å»ºæ–°çš„æ ¹ spanã€‚\n\n## gRPC åˆ° HTTP è¯·æ±‚ä¼ æ’­ header\n\næˆ‘ä»¬å†æ¥çœ‹ä¸‹è¿™ä¸ªåœºæ™¯ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨æ”¶åˆ°ä¸€ä¸ªæ–°ä¼ å…¥çš„ gRPC è¯·æ±‚æ—¶å‘å‡ºä¸€ä¸ªå‡ºç«™ HTTP\/1.1 è¯·æ±‚ã€‚ä»¥ä¸‹æ˜¯åœ¨æ­¤æƒ…å†µä¸‹å®Œæˆ header ä¼ æ’­çš„ç¤ºä¾‹ä»£ç ï¼š\n\n\u0060\u0060\u0060go\n  import (\n    \u0022net\/http\u0022\n    \u0022golang.org\/x\/net\/context\u0022\n    \u0022golang.org\/x\/net\/context\/ctxhttp\u0022\n    \u0022ot \u0022github.com\/opentracing\/opentracing-go\u0022\n  )\n\n  \/\/ ctx is the incoming gRPC request\u0027s context\n  \/\/ addr is the address of the application being requested\n  func makeNewRequest(ctx context.Context, addr string) {\n    if span := ot.SpanFromContext(ctx); span != nil {\n      req, _ := http.NewRequest(\u0022GET\u0022, addr, nil)\n\n      ot.GlobalTracer().Inject(\n        span.Context(),\n        ot.HTTPHeaders,\n        ot.HTTPHeadersCarrier(req.Header))\n\n      resp, err := ctxhttp.Do(ctx, nil, req)\n      \/\/ Do something with resp\n    }\n  }\n\u0060\u0060\u0060\n\nè¿™æ˜¯åºåˆ—åŒ–ä¼ å…¥è¯·æ±‚ï¼ˆHTTP æˆ– gRPCï¼‰ä¸Šä¸‹æ–‡ä¸­è·Ÿè¸ª header çš„æ ‡å‡†æ–¹å¼ã€‚\n\nå¾ˆå¥½ï¼Œè‡³æ­¤æˆ‘ä»¬å·²ç»èƒ½å¤Ÿä½¿ç”¨åº“æˆ–æ ‡å‡†å®ç”¨ç¨‹åºä»£ç æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚\n\n## ä½¿ç”¨ grpc-gateway æ—¶ä¼ æ’­ header\n\ngRPC åº”ç”¨ç¨‹åºä¸­æœ‰ä¸€ä¸ªå¸¸ç”¨çš„åº“[grpc-gateway](https:\/\/github.com\/grpc-ecosystem\/grpc-gateway)ï¼Œå¯ä»¥å°† gRPC æœåŠ¡ä½œä¸º RESTful JSON API æš´éœ²å‡ºæ¥ã€‚å½“æ‚¨æƒ³è¦äº†è§£ gRPC æˆ–ç»´æŠ¤ RESTful æ¶æ„ï¼Œä½¿ç”¨ curlã€web æµè§ˆå™¨ç­‰å®¢æˆ·ç«¯æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨\u0060grpc-gateway\u0060ä» gRPC ä¸­æš´éœ² RESTful API çš„æ›´å¤šç»†èŠ‚è¯·å‚è€ƒ[è¿™ä¸ªåšå®¢](https:\/\/coreos.com\/blog\/grpc-protobufs-swagger.html)ã€‚å¦‚æœæ‚¨å¯¹æ­¤æ¶æ„ä¸ç†Ÿæ‚‰ï¼Œæˆ‘å¼ºçƒˆå»ºè®®æ‚¨é˜…è¯»ã€‚\n\nå½“æ‚¨å¼€å§‹ä½¿ç”¨\u0060grpc-gateway\u0060å¹¶æƒ³ä¼ æ’­è·Ÿè¸ª header æ—¶ï¼Œæœ‰ä¸€äº›å€¼å¾—ä¸€æçš„éå¸¸æœ‰è¶£çš„äº¤äº’ã€‚ \u0060grpc-gateway\u0060 [æ–‡æ¡£](https:\/\/github.com\/grpc-ecosystem\/grpc-gateway#mapping-grpc-to-http)æŒ‡å‡ºï¼Œä½œä¸º gRPC è¯·æ±‚ headerï¼Œæ‰€æœ‰ IANAï¼ˆäº’è”ç½‘å·ç åˆ†é…å±€ï¼‰æ°¸ä¹… HTTP header éƒ½ä»¥\u0060grpcgateway-\u0060ä½œä¸ºå‰ç¼€å¹¶æ·»åŠ ã€‚è¿™å¾ˆå¥½ï¼Œä½†æ˜¯åƒ\u0060x-b3-traceid\u0060ã€\u0060x-b3-spanid\u0060ç­‰è·Ÿè¸ª header ä¸æ˜¯ IANA è®¤å¯çš„æ°¸ä¹… HTTP headerï¼Œå½“\u0060grpc-gateway\u0060ä»£ç† HTTP è¯·æ±‚æ—¶ï¼Œå®ƒä»¬ä¸ä¼šè¢«å¤åˆ¶åˆ° gRPC è¯·æ±‚ä¸­ã€‚è¿™æ„å‘³ç€åªè¦å°†\u0060grpc-gateway\u0060æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ï¼Œheader ä¼ æ’­é€»è¾‘å°±ä¼šåœæ­¢å·¥ä½œã€‚\n\nè¿™æ˜¯ä¸ªç‰¹ä¾‹å—ï¼Ÿæ·»åŠ ä¸€ä¸ªä¸œè¥¿æ‰“æ–­äº†å½“å‰çš„å·¥ä½œã€‚ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä¸ºæ‚¨è§£å†³é—®é¢˜ï¼\n\nè¿™æ˜¯ä¸€ç§ç¡®ä¿ä½¿ç”¨\u0060grpc-gateway\u0060åœ¨ HTTP å’Œ gRPC ä¹‹é—´è¿›è¡Œä»£ç†æ—¶ä¸ä¼šä¸¢å¤±è·Ÿè¸ªä¿¡æ¯çš„æ–¹æ³•ï¼š\n\n\u0060\u0060\u0060go\n  import (\n    \u0022net\/http\u0022\n    \u0022golang.org\/x\/net\/context\u0022\n    \u0022google.golang.org\/grpc\/metadata\u0022\n    \u0022github.com\/grpc-ecosystem\/grpc-gateway\/runtime\u0022\n  )\n\n  const (\n  \tprefixTracerState  = \u0022x-b3-\u0022\n  \tzipkinTraceID      = prefixTracerState \u002b \u0022traceid\u0022\n  \tzipkinSpanID       = prefixTracerState \u002b \u0022spanid\u0022\n  \tzipkinParentSpanID = prefixTracerState \u002b \u0022parentspanid\u0022\n  \tzipkinSampled      = prefixTracerState \u002b \u0022sampled\u0022\n  \tzipkinFlags        = prefixTracerState \u002b \u0022flags\u0022\n  )\n\n  var otHeaders = []string{\n  \tzipkinTraceID,\n  \tzipkinSpanID,\n  \tzipkinParentSpanID,\n  \tzipkinSampled,\n  \tzipkinFlags}\n\n  func injectHeadersIntoMetadata(ctx context.Context, req *http.Request) metadata.MD {\n  \tpairs := []string{}\n  \tfor _, h := range otHeaders {\n  \t\tif v := req.Header.Get(h); len(v) \u003e 0 {\n  \t\t\tpairs = append(pairs, h, v)\n  \t\t}\n  \t}\n  \treturn metadata.Pairs(pairs...)\n  }\n\n  type annotator func(context.Context, *http.Request) metadata.MD\n\n  func chainGrpcAnnotators(annotators ...annotator) annotator {\n  \treturn func(c context.Context, r *http.Request) metadata.MD {\n  \t\tmds := []metadata.MD{}\n  \t\tfor _, a := range annotators {\n  \t\t\tmds = append(mds, a(c, r))\n  \t\t}\n  \t\treturn metadata.Join(mds...)\n  \t}\n  }\n\n  \/\/ Main function of your application. Insert tracing headers into gRPC\n  \/\/ metadata using annotators\n  func run() {\n    ...\n\t  annotators := []annotator{injectHeadersIntoMetadata}\n\n\t  gwmux := runtime.NewServeMux(\n\t\t  runtime.WithMetadata(chainGrpcAnnotators(annotators...)),\n\t  )\n    ...\n  }\n\u0060\u0060\u0060\n\nåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†\u0060grpc-gateway\u0060åº“ä¸­çš„[\u0060runtime.WithMetadata\u0060](https:\/\/github.com\/grpc-ecosystem\/grpc-gateway\/blob\/master\/runtime\/mux.go#L88)ã€‚è¯¥ API ä» HTTP è¯·æ±‚ä¸­è¯»å–å±æ€§å¹¶å°†å…¶æ·»åŠ åˆ° gRPC å…ƒæ•°æ®ä¸­ï¼Œè¿™ä¸€ç‚¹éå¸¸æœ‰ç”¨ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼è™½ç„¶å¤šäº†ä¸€æ­¥ï¼Œä½†ä»ç„¶ä½¿ç”¨åº“æä¾›çš„ APIã€‚\n\n\u0060injectHeadersIntoMetadata\u0060æ³¨è§£å™¨åœ¨ HTTP è¯·æ±‚ä¸­æŸ¥æ‰¾è·Ÿè¸ª header å¹¶å°†å…¶é™„åŠ åˆ° gRPC å…ƒæ•°æ®ä¸­ï¼Œä»è€Œç¡®ä¿è·Ÿè¸ª header å¯ä»¥ä½¿ç”¨å‰é¢éƒ¨åˆ†ä¸­æåˆ°çš„æŠ€æœ¯ä» gRPC è¿›ä¸€æ­¥ä¼ æ’­åˆ°å‡ºç«™è¯·æ±‚ã€‚\n\næ‚¨å¯èƒ½è§‚å¯Ÿåˆ°çš„å¦ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯\u0060chainGrpcAnnotators\u0060åŒ…è£…å‡½æ•°ã€‚\u0060runtime.WithMetadata\u0060 API åªå…è®¸æ·»åŠ ä¸€ä¸ªæ³¨é‡Šå™¨ï¼Œè¿™å¯èƒ½ä¸è¶³ä»¥æ»¡è¶³æ‰€æœ‰åœºæ™¯ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè·Ÿè¸ªæ³¨é‡Šå™¨ï¼ˆå¦‚ä¸Šé¢çš„ä¸€ä¸ªç¤ºä¾‹ï¼‰å’Œä¸€ä¸ªè®¤è¯æ³¨é‡Šå™¨ï¼Œå®ƒå°†æ¥è‡ª HTTP è¯·æ±‚çš„è®¤è¯æ•°æ®é™„åŠ åˆ° gRPC å…ƒæ•°æ®ã€‚ä½¿ç”¨\u0060chainGrpcAnnotators\u0060å…è®¸æ‚¨æ·»åŠ å¤šä¸ªæ³¨é‡Šå™¨ï¼Œå¹¶ä¸”åŒ…è£…å‡½æ•°å°†æ¥è‡ªå„ç§æ³¨é‡Šå™¨çš„å…ƒæ•°æ®åŠ å…¥åˆ° gRPC è¯·æ±‚çš„å•ä¸ªå…ƒæ•°æ®ä¸­ã€‚\n', '\/trans\/tracing-grpc-with-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»çš„æ˜¯å¦‚ä½•åœ¨ Istio ä¸­ä½¿ç”¨ grpc å¹¶è®¾ç½®è·Ÿè¸ªï¼ˆtracingï¼‰ä¸ header ä¼ æ’­ï¼ŒåŒ…æ‹¬ gRPC åˆ° grpc è¯·æ±‚ä¼ æ’­ headerã€gRPC åˆ° HTTP è¯·æ±‚ä¼ æ’­ headerã€ä½¿ç”¨ grpc-gateway æ—¶ä¼ æ’­ header ç­‰</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-tutorial/">Istio Service Mesh æ•™ç¨‹</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/04/18</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Service Mesh æ•™ç¨‹', 'æœ¬æ–‡æ˜¯ Istio ç®¡ç† Java å¾®æœåŠ¡çš„æ¡ˆä¾‹æ•™ç¨‹ã€‚', '\næœ¬æ–‡æ˜¯ Istio ç®¡ç† Java å¾®æœåŠ¡çš„æ¡ˆä¾‹æ•™ç¨‹ï¼Œä½¿ç”¨çš„æ‰€æœ‰å·¥å…·å’Œè½¯ä»¶å…¨éƒ¨åŸºäºå¼€æºæ–¹æ¡ˆï¼Œæ›¿æ¢äº† [redhat-developer-demos\/istio-tutorial](https:\/\/github.com\/redhat-developer-demos\/istio-tutorial) ä¸­çš„ minishift ç¯å¢ƒï¼Œä½¿ç”¨ [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) æ›¿ä»£ï¼Œæ²¿ç”¨äº†åŸæœ‰çš„å¾®æœåŠ¡ç¤ºä¾‹ï¼Œä½¿ç”¨ Zipkin åšåˆ†å¸ƒå¼è¿½è¸ªè€Œä¸æ˜¯ Jaegerã€‚\n\næœ¬æ–‡ä¸­çš„ä»£ç å’Œ YAML æ–‡ä»¶è§ \u003chttps:\/\/github.com\/rootsongjc\/istio-tutorial\u003eã€‚\n\n## å‡†å¤‡ç¯å¢ƒ\n\nåœ¨è¿›è¡Œæœ¬æ•™ç¨‹å‰éœ€è¦å…ˆå‡†å¤‡ä»¥ä¸‹å·¥å…·å’Œç¯å¢ƒã€‚\n\n- 8G ä»¥ä¸Šå†…å­˜\n- Vagrant 2.0\u002b\n- Virtualbox 5.0 \u002b\n- æå‰ä¸‹è½½ kubernetes1.9.1 çš„ release å‹ç¼©åŒ…\n- docker 1.12\u002b\n- kubectl 1.9.1\u002b\n- maven 3.5.2\u002b\n- istioctl 0.7.1\n- git\n- curlã€gzipã€tar\n- [kubetail](https:\/\/github.com\/johanhaleby\/kubetail)\n- [siege](https:\/\/github.com\/JoeDog\/siege)\n\n## å®‰è£… Kubernetes\n\nè¯·å‚è€ƒ [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) åœ¨æœ¬åœ°å¯åŠ¨æ‹¥æœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„ kubernetes é›†ç¾¤ã€‚\n\n\u0060\u0060\u0060bash\ngit clone https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster.git\ncd kubernetes-vagrant-centos-cluster\nvagrant up\n\u0060\u0060\u0060\n\n## å®‰è£… Istio\n\nåœ¨ [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) ä¸­çš„åŒ…å« Istio 0.7.1 çš„å®‰è£… YAML æ–‡ä»¶ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤å®‰è£… Istioã€‚\n\n\u0060\u0060\u0060bash\nkubectl apply -f addon\/istio\/\n\u0060\u0060\u0060\n\n**è¿è¡Œç¤ºä¾‹**\n\n\u0060\u0060\u0060bash\nkubectl apply -n default -f \u003c(istioctl kube-inject -f yaml\/istio-bookinfo\/bookinfo.yaml)\n\u0060\u0060\u0060\n\nåœ¨æ‚¨è‡ªå·±çš„æœ¬åœ°ä¸»æœºçš„\u0060\/etc\/hosts\u0060æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®é¡¹ã€‚\n\n\u0060\u0060\u0060ini\n172.17.8.102 grafana.istio.jimmysong.io\n172.17.8.102 servicegraph.istio.jimmysong.io\n172.17.8.102 zipkin.istio.jimmysong.io\n\u0060\u0060\u0060\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ URL åœ°å€è®¿é—®ä»¥ä¸Šçš„æœåŠ¡ã€‚\n\n| Service      | URL                                                          |\n| ------------ | ------------------------------------------------------------ |\n| grafana      | \u0060http:\/\/grafana.istio.jimmysong.io\u0060                          |\n| servicegraph | \u0060http:\/\/servicegraph.istio.jimmysong.io\/dotviz\u0060ï¼Œ\u0060http:\/\/servicegraph.istio.jimmysong.io\/graph\u0060 |\n| zipkin       | \u0060http:\/\/zipkin.istio.jimmysong.io\u0060                           |\n\nè¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/)ã€‚\n\n## éƒ¨ç½²ç¤ºä¾‹åº”ç”¨\n\nåœ¨æ‰“åŒ…æˆé•œåƒéƒ¨ç½²åˆ° kubernetes é›†ç¾¤ä¸Šè¿è¡Œä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨æœ¬åœ°è¿è¡Œæ‰€æœ‰ç¤ºä¾‹ã€‚\n\næœ¬æ•™ç¨‹ä¸­ä¸‰ä¸ªæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060ini\ncustomer â†’ preference â†’ recommendation\n\u0060\u0060\u0060\n\n\u0060customer\u0060 å’Œ \u0060preference\u0060 å¾®æœåŠ¡æ˜¯åŸºäº Spring Boot æ„å»ºçš„ï¼Œ\u0060recommendation\u0060 å¾®æœåŠ¡æ˜¯åŸºäº [vert.x](https:\/\/vertx.io) æ„å»ºçš„ã€‚\n\n\u0060customer\u0060 å’Œ \u0060preference\u0060 å¾®æœåŠ¡çš„ \u0060pom.xml\u0060 æ–‡ä»¶ä¸­éƒ½å¼•å…¥äº† OpenTracing å’Œ Jeager çš„ä¾èµ–ã€‚\n\n\u0060\u0060\u0060xml\n\u003cdependency\u003e\n\t\u003cgroupId\u003eio.opentracing.contrib\u003c\/groupId\u003e\n\t\u003cartifactId\u003eopentracing-spring-cloud-starter\u003c\/artifactId\u003e\n\t\u003cversion\u003e0.1.7\u003c\/version\u003e\n\u003c\/dependency\u003e\n\u003cdependency\u003e\n\t\u003cgroupId\u003ecom.uber.jaeger\u003c\/groupId\u003e\n\t\u003cartifactId\u003ejaeger-tracerresolver\u003c\/artifactId\u003e\n    \u003cversion\u003e0.25.0\u003c\/version\u003e\n\u003c\/dependency\u003e\n\u0060\u0060\u0060\n\n### æœ¬åœ°è¿è¡Œ\n\næˆ‘ä»¬é¦–å…ˆåœ¨æœ¬åœ°ç¡®å®šæ‰€æœ‰çš„å¾®æœåŠ¡éƒ½å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œç„¶åå†æ‰“åŒ…é•œåƒåœ¨ kubernetes é›†ç¾¤ä¸Šè¿è¡Œã€‚\n\n**å¯åŠ¨ Jaeger**\n\nä½¿ç”¨ docker æ¥è¿è¡Œ jaggerã€‚\n\n\u0060\u0060\u0060bash\ndocker run -d \\\n  --rm \\\n  -p5775:5775\/udp \\\n  -p6831:6831\/udp \\\n  -p6832:6832\/udp \\\n  -p16686:16686 \\\n  -p14268:14268 \\\n  jaegertracing\/all-in-one:1.3\n\u0060\u0060\u0060\n\nJaeger UI åœ°å€ \u0060http:\/\/localhost:16686\u0060\n\n**Customer**\n\n\u0060\u0060\u0060bash\ncd customer\/java\/springboot\nJAEGER_SERVICE_NAME=customer mvn \\\n  spring-boot:run \\\n  -Drun.arguments=\u0022--spring.config.location=src\/main\/resources\/application-local.properties\u0022\n\u0060\u0060\u0060\n\næœåŠ¡è®¿é—®åœ°å€ï¼š \u0060http:\/\/localhost:8280\u0060\n\n**Preference**\n\n\u0060\u0060\u0060bash\ncd preference\/java\/springboot\nJAEGER_SERVICE_NAME=preference mvn \\\n  spring-boot:run \\\n  -Drun.arguments=\u0022--spring.config.location=src\/main\/resources\/application-local.properties\u0022\n\u0060\u0060\u0060\n\næœåŠ¡è®¿é—®åœ°å€ï¼š\u0060http:\/\/localhost:8180\u0060\n\n**Recommendation**\n\n\u0060\u0060\u0060bash\ncd recommendation\/java\/vertx\nmvn vertx:run\n\u0060\u0060\u0060\n\næœåŠ¡è®¿é—®åœ°å€ï¼š\u0060http:\/\/localhost:8080\u0060\n\næ‰€æœ‰æœåŠ¡éƒ½å¯åŠ¨ä¹‹åï¼Œæ­¤æ—¶è®¿é—® \u0060http:\/\/localhost:8280\u0060 å°†ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºã€‚\n\n\u0060\u0060\u0060bash\ncustomer =\u003e preference =\u003e recommendation v1 from \u0027unknown\u0027: 1\n\u0060\u0060\u0060\n\næ¯è®¿é—®ä¸€æ¬¡æœ€åçš„æ•°å­—å°±ä¼šåŠ  1ã€‚\n\n**Jaeger**\n\næ­¤æ—¶è®¿é—® \u0060http:\/\/localhost:16686\u0060 å°†çœ‹åˆ° Jaeger query UIï¼Œæ‰€æœ‰åº”ç”¨å°† metrics å‘é€åˆ° Jeager ä¸­ã€‚\n\nå¯ä»¥åœ¨ Jaeger UI ä¸­æœç´¢ \u0060customer\u0060 å’Œ \u0060preference\u0060 service çš„ trace å¹¶æŸ¥çœ‹æ¯æ¬¡è¯·æ±‚çš„ tracingã€‚\n\n![Jaeger query UI](jaeger-query-ui.webp)\n\n### æ„å»ºé•œåƒ\n\nåœ¨æœ¬åœ°è¿è¡Œæµ‹è¯•æ— è¯¯ä¹‹åå°±å¯ä»¥æ„å»ºé•œåƒäº†ã€‚æœ¬æ•™ç¨‹ä¸­çš„å®¹å™¨é•œåƒéƒ½æ˜¯åœ¨ [fabric8\/java-jboss-openjdk8-jdk](https:\/\/hub.docker.com\/r\/fabric8\/java-jboss-openjdk8-jdk\/~\/dockerfile\/) çš„åŸºç¡€ä¸Šæ„å»ºçš„ã€‚åªè¦å°† Java åº”ç”¨æ„å»ºå‡º Jar åŒ…ç„¶åæ”¾åˆ° \u0060\/deployments\u0060 ç›®å½•ä¸‹åŸºç¡€é•œåƒå°±å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°ç€å‡ ä¸ªåº”ç”¨çš„ \u0060Dockerfile\u0060 æ–‡ä»¶ä¸­éƒ½æ²¡æœ‰æ‰§è¡Œå…¥å£ï¼ŒçœŸæ­£çš„æ‰§è¡Œå…¥å£æ˜¯ [run-java.sh](https:\/\/github.com\/fabric8io-images\/java\/blob\/master\/images\/jboss\/openjdk8\/jdk\/run-java.sh)ã€‚\n\n**Customer**\n\næ„å»º Customer é•œåƒã€‚\n\n\u0060\u0060\u0060bash\ncd customer\/java\/springboot\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-customer:v1 .\ndocker push jimmysong\/istio-tutorial-customer:v1\n\u0060\u0060\u0060\n\nç¬¬ä¸€æ¬¡æ„å»ºå’Œä¸Šä¼ éœ€è¦èŠ±è´¹ä¸€ç‚¹æ—¶é—´ï¼Œä¸‹ä¸€æ¬¡æ„å»ºå°±ä¼šå¾ˆå¿«ã€‚\n\n**Preference**\n\næ„å»º Preference é•œåƒã€‚\n\n\u0060\u0060\u0060bash\ncd preference\/java\/springboot\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-preference:v1 .\ndocker push jimmysong\/istio-tutorial-preference:v1\n\u0060\u0060\u0060\n\n**Recommendation**\n\næ„å»º Recommendation é•œåƒã€‚\n\n\u0060\u0060\u0060bash\ncd recommendation\/java\/vertx\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-recommendation:v1 .\ndocker push jimmysong\/istio-tutorial-recommendation:v1\n\u0060\u0060\u0060\n\nç°åœ¨ä¸‰ä¸ª docker é•œåƒéƒ½æ„å»ºå®Œæˆäº†ï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ã€‚\n\n\u0060\u0060\u0060bash\n$ docker images | grep istio-tutorial\nREPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE\njimmysong\/istio-tutorial-recommendation   v1                  d31dd858c300        51 seconds ago      443MB\njimmysong\/istio-tutorial-preference       v1                  e5f0be361477        6 minutes ago       459MB\njimmysong\/istio-tutorial-customer         v1                  d9601692673e        13 minutes ago      459MB\n\u0060\u0060\u0060\n\n### éƒ¨ç½²åˆ° Kubernetes\n\nä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†ä»¥ä¸ŠæœåŠ¡éƒ¨ç½²åˆ° kubernetesã€‚\n\n\u0060\u0060\u0060bash\n# create new namespace\nkubectl create ns istio-tutorial\n\n# deploy recommendation\nkubectl apply -f \u003c(istioctl kube-inject -f recommendation\/kubernetes\/Deployment.yml) -n istio-tutorial\nkubectl apply -f recommendation\/kubernetes\/Service.yml\n\n# deploy preferrence\nkubectl apply -f \u003c(istioctl kube-inject -f preference\/kubernetes\/Deployment.yml) -n istio-tutorial\nkubectl apply -f preference\/kubernetes\/Service.yml\n\n# deploy customer\nkubectl apply -f \u003c(istioctl kube-inject -f customer\/kubernetes\/Deployment.yml) -n istio-tutorial\nkubectl apply -f customer\/kubernetes\/Service.yml\n\u0060\u0060\u0060\n\n**æ³¨æ„ï¼š**\u0060preference\u0060 å’Œ \u0060customer\u0060 åº”ç”¨å¯åŠ¨é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæˆ‘ä»¬å°† livenessProb é…ç½®ä¸­çš„ \u0060initialDelaySeconds\u0060 è®¾ç½®ä¸º **20** ç§’ã€‚\n\næŸ¥çœ‹ Pod å¯åŠ¨çŠ¶æ€ï¼š\n\n\u0060\u0060\u0060bash\nkubectl get pod -w -n istio-tutorial\n\u0060\u0060\u0060\n\n### å¢åŠ  Ingress é…ç½®\n\nä¸ºäº†åœ¨ kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—® customer æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ  ingress é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nkubectl apply -f ingress\/ingress.yaml\n\u0060\u0060\u0060\n\nä¿®æ”¹æœ¬åœ°çš„ \u0060\/etc\/hosts\u0060 æ–‡ä»¶ï¼Œå¢åŠ ä¸€æ¡é…ç½®ã€‚\n\n\u0060\u0060\u0060ini\n172.17.8.102 customer.istio-tutorial.jimmysong.io\n\u0060\u0060\u0060\n\nç°åœ¨è®¿é—® \u0060http:\/\/customer.istio-tutorial.jimmysong.io\u0060 å°†çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š\n\n\u0060\u0060\u0060ini\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 1\n\u0060\u0060\u0060\n\næ‰¹é‡è®¿é—®è¯¥åœ°å€ã€‚\n\n\u0060\u0060\u0060bash\n.\/bin\/poll_customer.sh\n\u0060\u0060\u0060\n\nè®¿é—® \u0060http:\/\/servicegraph.istio.jimmysong.io\/dotviz\u0060 æŸ¥çœ‹æœåŠ¡çš„åˆ†å¸ƒå¼è¿½è¸ªå’Œä¾èµ–å…³ç³»ã€‚\n\n![åˆ†å¸ƒå¼è¿½è¸ª](istio-tutorial-zipkin-trace.webp)\n\n![ä¾èµ–å…³ç³»](istio-tutorial-zipkin-dependency.webp)\n\nè®¿é—® \u0060http:\/\/servicegraph.istio.jimmysong.io\/dotviz\u0060 æŸ¥çœ‹æœåŠ¡é—´çš„å…³ç³»å›¾å’Œ QPSã€‚\n\n![æœåŠ¡å…³ç³»å›¾å’Œ QPS](istio-tutorial-Servicegraph-dotviz.webp)\n\nè®¿é—® \u0060http:\/\/grafana.istio.jimmysong.io\u0060 æŸ¥çœ‹ Service Mesh çš„ç›‘æ§ä¿¡æ¯ã€‚\n\n![Grafana ç›‘æ§](istio-tutorial-grafana.webp)\n\n## Istio ä½¿ç”¨ç¤ºä¾‹\n\nä¸ºäº†è¯•ç”¨ Istio ä¸­çš„å„ç§åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåº”ç”¨æ„å»ºå¤šä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸º recommendation æ„å»º v2 ç‰ˆæœ¬çš„é•œåƒï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Istio æ§åˆ¶å¾®æœåŠ¡çš„æµé‡ã€‚\n\n### æ„å»º recommendation:v2\n\næˆ‘ä»¬å°†æ„å»ºæ–°ç‰ˆçš„ \u0060recommendation\u0060 æœåŠ¡çš„é•œåƒï¼Œå¹¶è§‚å¯Ÿ \u0060customer\u0060 å¯¹ä¸åŒç‰ˆæœ¬çš„ \u0060recommendataion\u0060 æœåŠ¡çš„è®¿é—®é¢‘ç‡ã€‚\n\nä¿®æ”¹ \u0060recommendation\/java\/vertx\/src\/main\/java\/com\/redhat\/developer\/demos\/recommendation\/RecommendationVerticle.java\u0060 ç¨‹åºä¸­ä»£ç ã€‚\n\nå°† \u0060private static final String RESPONSE_STRING_FORMAT = \u0022recommendation v1 from \u0027%s\u0027: %d\\n\u0022;\u0060 ä¿®æ”¹ä¸º \u0060private static final String RESPONSE_STRING_FORMAT = \u0022recommendation v2 from \u0027%s\u0027: %d\\n\u0022;\u0060\n\nå¹¶æ„å»º \u0060recommendation:v2\u0060 é•œåƒã€‚\n\n\u0060\u0060\u0060bash\ncd recommendation\/java\/vertx\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-recommendation:v2 .\ndocker push jimmysong\/istio-tutorial-recommendation:v2\n\u0060\u0060\u0060\n\nå°†åº”ç”¨éƒ¨ç½²åˆ° kubernetesã€‚\n\n\u0060\u0060\u0060bash\n# deploy recommendation\nkubectl apply -f \u003c(istioctl kube-inject -f recommendation\/kubernetes\/Deployment-v2.yml) -n istio-tutorial\n\u0060\u0060\u0060\n\nç°åœ¨å†è®¿é—® \u0060customer\u0060 æœåŠ¡ï¼Œå°†çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 1\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3581\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 2\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3582\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 3\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3583\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 4\n\u0060\u0060\u0060\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ° v1 å’Œ v2 ç‰ˆæœ¬çš„ \u0060recommendation\u0060 æœåŠ¡ä¼šè¢«é—´éš”è®¿é—®åˆ°ã€‚\n\næˆ‘ä»¬å†å°† v2 ç‰ˆæœ¬çš„ \u0060recommendation\u0060 å®ä¾‹æ•°è®¾ç½®æˆ 2 ä¸ªã€‚\n\n\u0060\u0060\u0060bash\nkubectl scale --replicas=2 deployment\/recommendation-v2 -n istio-tutorial\nkubectl get pod -w -n istio-tutorial\n\u0060\u0060\u0060\n\nè§‚å¯Ÿ \u0060recommendation-v2\u0060 Pod è¾¾åˆ°ä¸¤ä¸ªä¹‹åå†è®¿é—® \u0060customer\u0060 æœåŠ¡ã€‚\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-j9fgj\u0027: 1\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 71\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3651\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-j9fgj\u0027: 2\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 72\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3652\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-j9fgj\u0027: 3\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 73\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3653\n\u0060\u0060\u0060\n\nè§‚å¯Ÿè¾“å‡ºä¸­ v1 å’Œ v2 ç‰ˆæœ¬ \u0060recommendation\u0060 çš„è®¿é—®é¢‘ç‡ã€‚\n\nå°† \u0060recommendataion\u0060 æœåŠ¡çš„å®ä¾‹æ•°æ¢å¤ä¸º 1ã€‚\n\n\u0060\u0060\u0060bash\nkubectl scale --replicas=1 deployment\/recommendation-v2\n\u0060\u0060\u0060\n\n### ä¿®æ”¹ Istio RouteRules\n\nä»¥ä¸‹æ‰€æœ‰è·¯æœ‰è§„åˆ™éƒ½æ˜¯é’ˆå¯¹ \u0060recommendation\u0060 æœåŠ¡ï¼Œå¹¶åœ¨ repo çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œã€‚\n\n**å°†æ‰€æœ‰æµé‡æ‰“ç»™ v2**\n\nä¸‹é¢å°†æ¼”ç¤ºå¦‚ä½•åŠ¨æ€çš„åˆ’åˆ†ä¸åŒç‰ˆæœ¬æœåŠ¡é—´çš„æµé‡ï¼Œå°†æ‰€æœ‰çš„æµé‡éƒ½æ‰“åˆ° \u0060recommendation:v2\u0060ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v2.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nç°åœ¨å†è®¿é—® \u0060customer\u0060 æœåŠ¡å°†çœ‹åˆ°æ‰€æœ‰çš„æµé‡éƒ½ä¼šæ‰“åˆ° \u0060recommendation:v2\u0060ã€‚\n\nåˆ é™¤ RouteRules åå†è®¿é—® \u0060customer\u0060 æœåŠ¡å°†çœ‹åˆ°åˆæ¢å¤äº† v1 å’Œ v2 ç‰ˆæœ¬çš„ \u0060recommendation\u0060 æœåŠ¡çš„é—´éš”è®¿é—®ã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-default\n\u0060\u0060\u0060\n\n**åˆ‡åˆ†æµé‡**\n\nå°† 90% çš„æµé‡ç»™ v1ï¼Œ10% çš„æµé‡ç»™ v2ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v1_and_v2.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næ‰§è¡Œ\u0060bin\/poll_customer.sh\u0060 è§‚å¯Ÿè®¿é—®æƒ…å†µã€‚\n\nè¦æƒ³åŠ¨æ€åˆ‡åˆ†æµé‡åªè¦ä¿®æ”¹ RouteRules ä¸­çš„ \u0060weight\u0060 é…ç½®å³å¯ã€‚\n\n\u0060\u0060\u0060yaml\napiVersion: config.istio.io\/v1alpha2\nkind: RouteRule\nmetadata:\n  name: recommendation-v1-v2\nspec:\n  destination:\n    namespace: istio-tutorial\n    name: recommendation\n  precedence: 5\n  route:\n  - labels:\n      version: v1\n    weight: 90\n  - labels:\n      version: v2\n    weight: 10\n\u0060\u0060\u0060\n\nå› ä¸º RouteRule æœ‰ä¼˜å…ˆçº§ï¼Œä¸ºäº†ç»§ç»­åé¢çš„å®éªŒï¼Œåœ¨éªŒè¯å®Œæˆååˆ é™¤è¯¥ RouteRuleã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-v1-v2 -n istio-tutorial\n\u0060\u0060\u0060\n\n### æ•…éšœæ³¨å…¥\n\næœ‰æ—¶å€™æˆ‘ä»¬ä¸ºäº†å¢å¼ºç³»ç»Ÿçš„å¥å£®æ€§ï¼Œéœ€è¦å¯¹ç³»ç»Ÿåšæ··æ²Œå·¥ç¨‹ï¼Œæ•…æ„æ³¨å…¥æ•…éšœï¼Œå¹¶ä¿éšœæœåŠ¡å¯ä»¥è‡ªåŠ¨å¤„ç†è¿™äº›æ•…éšœã€‚\n\n**æ³¨å…¥ HTTP 503 é”™è¯¯**\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-503.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næœ‰ 50% çš„å‡ ç‡æŠ¥ 503 é”™è¯¯ã€‚\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 135\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3860\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 136\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 3861\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\ncustomer =\u003e preference =\u003e recommendation v2 from \u002777b9f6cc68-5xs27\u0027: 137\ncustomer =\u003e 503 preference =\u003e 503 fault filter abort\n\u0060\u0060\u0060\n\næ¸…ç† RouteRuleã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-503 -n istio-tutorial\n\u0060\u0060\u0060\n\n### å¢åŠ å»¶è¿Ÿ\n\nå¢åŠ æœåŠ¡çš„è®¿é—®å»¶è¿Ÿã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-delay.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nä¼šæœ‰ 50% çš„å‡ ç‡è®¿é—® \u0060recommendation\u0060 æœåŠ¡æœ‰ 7 ç§’çš„å»¶è¿Ÿã€‚ç™¾åˆ†æ¯”å’Œå»¶è¿Ÿæ—¶é—´å¯ä»¥åœ¨ RouteRule ä¸­é…ç½®ã€‚\n\næ¸…ç† RouteRuleã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-delay -n istio-tutorial\n\u0060\u0060\u0060\n\n### é‡è¯•\n\nè®©æœåŠ¡ä¸æ˜¯ç›´æ¥å¤±è´¥ï¼Œè€Œæ˜¯å¢åŠ é‡è¯•æœºåˆ¶ã€‚\n\næˆ‘ä»¬ä¸‹é¢å°†åŒæ—¶åº”ç”¨ä¸¤æ¡ RouteRuleï¼Œè®©è®¿é—® \u0060recommendation\u0060 æœåŠ¡æ—¶æœ‰ 50% çš„å‡ ç‡å‡ºç° 503 é”™è¯¯ï¼Œå¹¶åœ¨å‡ºç°é”™è¯¯çš„æ—¶å€™å°è¯•è®¿é—® v2 ç‰ˆæœ¬ï¼Œè¶…æ—¶æ—¶é—´ä¸º 2 ç§’ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v2_503.yml -n istio-tutorial\nistioctl create -f istiofiles\/route-rule-recommendation-v2_retry.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næ‰§è¡Œ \u0060bin\/poll_customer.sh\u0060 æˆ‘ä»¬çœ‹åˆ°ä¸€å¼€å§‹æœ‰äº› 503 é”™è¯¯ï¼Œç„¶åæ‰€æœ‰çš„æµé‡éƒ½æµå‘äº† v2ã€‚\n\næ¸…ç† RouteRulesã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-v2-retry -n istio-tutorial\nistioctl delete routerule recommendation-v2-503 -n istio-tutorial\n\u0060\u0060\u0060\n\n### è¶…æ—¶\n\nè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåªæœ‰æœåŠ¡è®¿é—®è¶…æ—¶æ‰è®¤å®šæœåŠ¡è®¿é—®å¤±è´¥ã€‚\n\nå–æ¶ˆæ³¨é‡Š \u0060recommendation\/java\/vertx\/src\/main\/java\/com\/redhat\/developer\/demos\/recommendation\/RecommendationVerticle.java\u0060 ä¸­çš„ä¸‹é¢ä¸€è¡Œï¼Œå¢åŠ è¶…æ—¶æ—¶é—´ä¸º 3 ç§’ã€‚\n\n\u0060\u0060\u0060java\nrouter.get(\u0022\/\u0022).handler(this::timeout);\n\u0060\u0060\u0060\n\né‡æ–°ç”Ÿæˆé•œåƒã€‚\n\n\u0060\u0060\u0060bash\ncd recommendation\/java\/vertx\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-recommendation:v2 .\ndocker push jimmysong\/istio-tutorial-recommendation:v2\n\u0060\u0060\u0060\n\né‡æ–°éƒ¨ç½²åˆ° kubernetesã€‚\n\n\u0060\u0060\u0060bash\nkubectl delete -f recommendation\/kubernetes\/Deployment-v2.yml\n\u0060\u0060\u0060\n\nå› ä¸ºæˆ‘ä»¬é‡æ–°æ„å»ºçš„é•œåƒä½¿ç”¨äº†åŒæ ·çš„åå­—å’Œ tagï¼Œè€Œä¹‹å‰åœ¨ \u0060Deployment-v2.yml\u0060 ä¸­é…ç½®çš„é•œåƒæ‹‰å–ç­–ç•¥æ˜¯ \u0060IfNotPresent\u0060ï¼Œè¿™æ ·çš„è¯å³ä½¿æˆ‘ä»¬æ„å»ºäº†æ–°çš„é•œåƒä¹Ÿæ— æ³•åº”ç”¨åˆ°é›†ç¾¤ä¸Šï¼Œå› æ­¤å°†é•œåƒæ‹‰å–ç­–ç•¥æ”¹æˆ \u0060Always\u0060 ç¡®ä¿æ¯æ¬¡å¯åŠ¨ Pod çš„æ—¶å€™éƒ½ä¼šæ‹‰å–é•œåƒã€‚\n\n\u0060\u0060\u0060bash\nkubectl apply -f \u003c(istioctl kube-inject -f recommendation\/kubernetes\/Deployment-v2.yml) -n istio-tutorial\n\u0060\u0060\u0060\n\nå¯ç”¨è¶…æ—¶ RouteRulesã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-timeout.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nè®¿é—® \u0060customer\u0060 æœåŠ¡å°†çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e 503 preference =\u003e 504 upstream request timeout\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 4002\ncustomer =\u003e 503 preference =\u003e 504 upstream request timeout\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 4003\ncustomer =\u003e 503 preference =\u003e 504 upstream request timeout\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 4004\n\u0060\u0060\u0060\n\næ¸…ç† RouteRulesã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-timeout -n istio-tutorial\n\u0060\u0060\u0060\n\n### åŸºäº user-agent çš„æ™ºèƒ½è·¯ç”±ï¼ˆé‡‘ä¸é›€å‘å¸ƒï¼‰\n\nUser-agent æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«äº†æµè§ˆå™¨çš„ä¿¡æ¯ï¼Œè®¿é—® https:\/\/www.whoishostingthis.com\/tools\/user-agent è·å–ä½ çš„ user-agentã€‚\n\næˆ‘çš„ user-agent æ˜¯ï¼š\n\n\u0060\u0060\u0060ini\nMozilla\/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/65.0.3325.181 Safari\/537.36\n\u0060\u0060\u0060\n\nå°†æ‰€æœ‰çš„æµé‡æ‰“åˆ° v1ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v1.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nå°†ä½¿ç”¨ Safari æµè§ˆå™¨è®¿é—®çš„æµé‡æ‰“åˆ° v2ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-safari-recommendation-v2.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nè°ç”¨ Safari æˆ–è€… Chromeï¼ˆChrome æµè§ˆå™¨çš„ user-agent ä¸­ä¹ŸåŒ…å« Safari å­—æ®µï¼‰è®¿é—® \u0060http:\/\/customer.istio-tutorial.jimmysong.io\/\u0060 åœ¨ç»è¿‡ 3 ç§’é’Ÿï¼ˆæˆ‘ä»¬åœ¨å‰é¢é‡æ–°ç¼–è¯‘ v2 é•œåƒï¼Œè®¾ç½®äº† 3 ç§’è¶…æ—¶æ—¶é—´ï¼‰åå°†çœ‹åˆ°è®¿é—® v2 çš„è¾“å‡ºã€‚\n\næˆ–è€…ä½¿ç”¨ curl è®¿é—®ã€‚\n\n\u0060\u0060\u0060bash\ncurl -A Safari http:\/\/customer.istio-tutorial.jimmysong.io\/\ncurl -A Firefox http:\/\/customer.istio-tutorial.jimmysong.io\/\n\u0060\u0060\u0060\n\nè§‚å¯Ÿè¿”å›çš„ç»“æœã€‚\n\nå°†ç§»åŠ¨ç«¯ç”¨æˆ·çš„æµé‡å¯¼åˆ° v2ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-mobile-recommendation-v2.yml -n istio-tutorial\n\ncurl -A \u0022Mozilla\/5.0 (iPhone; U; CPU iPhone OS 4(KHTML, like Gecko) Version\/5.0.2 Mobile\/8J2 Safari\/6533.18.5\u0022 http:\/\/customer.istio-tutorial.jimmysong.io\/\n\u0060\u0060\u0060\n\nè§‚å¯Ÿè¾“å‡ºçš„ç»“æœã€‚\n\næ¸…ç† RouteRulesã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-mobile -n istio-tutorial\nistioctl delete routerule recommendation-safari -n istio-tutorial\nistioctl delete routerule recommendation-default -n istio-tutorial\n\u0060\u0060\u0060\n\n### é•œåƒæµé‡\n\nç¡®ä¿å½“å‰è‡³å°‘è¿è¡Œäº†ä¸¤ä¸ªç‰ˆæœ¬çš„ \u0060recommendation\u0060 æœåŠ¡ï¼Œå¹¶ä¸”æ²¡æœ‰ RouteRuleã€‚\n\næ³¨ï¼šå¯ä»¥ä½¿ç”¨ \u0060istioctl get routerule\u0060 è·å– RouteRuleã€‚\n\nè®¾ç½®æµé‡é•œåƒï¼Œå°†æ‰€æœ‰ v1 çš„æµé‡éƒ½è¢«é•œåƒåˆ° v2ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v1-mirror-v2.yml -n istio-tutorial\nbin\/poll_customer.sh\n\u0060\u0060\u0060\n\næŸ¥çœ‹ recommendation-v2 çš„æ—¥å¿—ã€‚\n\n\u0060\u0060\u0060bash\nkubectl logs -f \u0060oc get pods|grep recommendation-v2|awk \u0027{ print $1 }\u0027\u0060 -c recommendation\n\u0060\u0060\u0060\n\n### è®¿é—®æ§åˆ¶\n\nIstio å¯ä»¥è®¾ç½®æœåŠ¡è®¿é—®çš„é»‘ç™½åå•ï¼Œå¦‚æœæ²¡æœ‰æƒé™çš„è¯ä¼šè¿”å› HTTP 404 Not Foundã€‚\n\n#### ç™½åå•\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/acl-whitelist.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næ­¤æ—¶è®¿é—® \u0060customer\u0060 æœåŠ¡ã€‚\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e 404 NOT_FOUND:preferencewhitelist.listchecker.istio-tutorial:customer is not whitelisted\n\u0060\u0060\u0060\n\né‡ç½®ç¯å¢ƒã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete -f istiofiles\/acl-whitelist.yml -n istio-tutorial\n\u0060\u0060\u0060\n\n#### é»‘åå•\n\nè®¾ç½®é»‘åå•ï¼Œæ‰€æœ‰ä½äºé»‘åå•ä¸­çš„æµé‡å°†è·å¾— 403 Forbidden è¿”å›ç ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/acl-blacklist.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næ­¤æ—¶è®¿é—® \u0060customer\u0060 æœåŠ¡ã€‚\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e 403 PERMISSION_DENIED:denycustomerhandler.denier.istio-tutorial:Not allowed\n\u0060\u0060\u0060\n\né‡ç½®ç¯å¢ƒã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete -f istiofiles\/acl-blacklist.yml -n istio-tutorial\n\u0060\u0060\u0060\n\n### è´Ÿè½½å‡è¡¡\n\nKubernetes ä¸­é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯ round-robinï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Istio æŠŠå®ƒä¿®æ”¹æˆ randomã€‚\n\nå¢åŠ  v1 çš„å®ä¾‹æ•°ã€‚\n\n\u0060\u0060\u0060bash\nkubectl scale deployment recommendation-v1 --replicas=2 -n istio-tutorial\n\u0060\u0060\u0060\n\næŒç»­è®¿é—® \u0060customer\u0060 æœåŠ¡ã€‚\n\n\u0060\u0060\u0060bash\nbin\/poll_customer.sh\n\u0060\u0060\u0060\n\nä¿æŒå‰å°è¾“å‡ºï¼Œè§‚å¯Ÿæµé‡çš„è¡Œä¸ºã€‚\n\nåº”ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/recommendation_lb_policy_app.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nè§‚å¯Ÿä¸€æ®µæ—¶é—´æµé‡çš„è¡Œä¸ºåï¼Œé‡ç½®ç¯å¢ƒã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete -f istiofiles\/recommendation_lb_policy_app.yml -n istio-tutorial\nkubectl scale deployment recommendation-v1 --replicas=1 -n istio-tutorial\n\u0060\u0060\u0060\n\n### é€Ÿç‡é™åˆ¶\n\næš‚æ—¶ä¸å¯ç”¨\n\n### æ–­è·¯å™¨\n\nå½“è¾¾åˆ°æœ€å¤§è¿æ¥æ•°å’Œæœ€å¤§æŒ‚èµ·è¯·æ±‚æ•°æ—¶å¿«é€Ÿå¤±è´¥ã€‚\n\nå°†æµé‡åœ¨ v1 å’Œ v2 ä¹‹é—´å‡åˆ†ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v1_and_v2_50_50.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næœªå¼€å¯æ–­è·¯å™¨çš„æ—¶å€™å¯åŠ¨è´Ÿè½½æµ‹è¯•ã€‚\n\n\u0060\u0060\u0060bash\n$ siege -r 2 -c 20 -v customer.istio-tutorial.jimmysong.io\nNew configuration template added to \/Users\/jimmysong\/.siege\nRun siege -C to view the current settings in that file\n** SIEGE 4.0.4\n** Preparing 20 concurrent users for battle.\nThe server is now under siege...\nHTTP\/1.1 200     0.10 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.12 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.13 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.13 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.13 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.17 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.12 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.14 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.15 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.15 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.17 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.17 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.20 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.20 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.05 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.12 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.15 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.25 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.26 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.14 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.58 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.15 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.16 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.03 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.06 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.04 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.11 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.09 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.15 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     6.71 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     3.52 secs:      75 bytes ==\u003e GET  \/\n^C\nLifting the server siege...\nTransactions:\t\t          31 hits\nAvailability:\t\t      100.00 %\nElapsed time:\t\t        7.99 secs\nData transferred:\t        0.00 MB\nResponse time:\t\t        2.99 secs\nTransaction rate:\t        3.88 trans\/sec\nThroughput:\t\t        0.00 MB\/sec\nConcurrency:\t\t       11.60\nSuccessful transactions:          31\nFailed transactions:\t           0\nLongest transaction:\t        6.71\nShortest transaction:\t        0.05\n\u0060\u0060\u0060\n\næ‰€æœ‰çš„è¯·æ±‚éƒ½æˆåŠŸäº†ï¼Œä½†æ˜¯æ€§èƒ½å¾ˆå·®ï¼Œå› ä¸º v2 ç‰ˆæœ¬è®¾ç½®äº† 3 ç§’çš„è¶…æ—¶æ—¶é—´ã€‚\n\næˆ‘ä»¬å¯ç”¨ä¸‹æ–­è·¯å™¨ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/recommendation_cb_policy_version_v2.yml -n istio-tutorial\n\u0060\u0060\u0060\n\né‡æ–°æµ‹è¯•ä¸€ä¸‹ã€‚\n\n\u0060\u0060\u0060bash\n$ siege -r 2 -c 20 -v customer.istio-tutorial.jimmysong.io\n** SIEGE 4.0.4\n** Preparing 20 concurrent users for battle.\nThe server is now under siege...\nHTTP\/1.1 200     0.07 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.07 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.07 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.12 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.12 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.16 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.16 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.21 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.21 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.24 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.24 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.14 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.29 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.13 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.18 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.13 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.11 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.39 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.24 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.44 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.43 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.44 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.40 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.47 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.42 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.42 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.06 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.07 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.15 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.12 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.57 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.18 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.52 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.65 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.42 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.09 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.43 secs:      75 bytes ==\u003e GET  \/\nHTTP\/1.1 503     0.04 secs:      92 bytes ==\u003e GET  \/\nHTTP\/1.1 200     4.15 secs:      74 bytes ==\u003e GET  \/\nHTTP\/1.1 200     0.01 secs:      75 bytes ==\u003e GET  \/\n\nTransactions:\t\t          19 hits\nAvailability:\t\t       47.50 %\nElapsed time:\t\t        4.16 secs\nData transferred:\t        0.00 MB\nResponse time:\t\t        0.72 secs\nTransaction rate:\t        4.57 trans\/sec\nThroughput:\t\t        0.00 MB\/sec\nConcurrency:\t\t        3.31\nSuccessful transactions:          19\nFailed transactions:\t          21\nLongest transaction:\t        4.15\nShortest transaction:\t        0.01\n\u0060\u0060\u0060\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å¯ç”¨äº†æ–­è·¯å™¨åå„é¡¹æ€§èƒ½éƒ½æœ‰æé«˜ã€‚\n\næ¸…ç†é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete routerule recommendation-v1-v2 -n istio-tutorial\nistioctl delete -f istiofiles\/recommendation_cb_policy_version_v2.yml -n istio-tutorial\n\u0060\u0060\u0060\n\n### Pool Ejection\n\næ‰€è°“çš„ Pool Ejection å°±æ˜¯å½“æŸäº›å®ä¾‹å‡ºç°é”™è¯¯ï¼ˆå¦‚è¿”å› 5xx é”™è¯¯ç ï¼‰ä¸´æ—¶å°†è¯¥å®ä¾‹å¼¹å‡ºä¸€æ®µæ—¶é—´åï¼ˆçª—å£æœŸï¼Œå¯é…ç½®ï¼‰ï¼Œç„¶åå†å°†å…¶åŠ å…¥åˆ°è´Ÿè½½å‡è¡¡æ± ä¸­ã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­é…ç½®çš„çª—å£æœŸæ˜¯ 15 ç§’ã€‚\n\nå°† v1 å’Œ v2 çš„æµé‡å‡åˆ†ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/route-rule-recommendation-v1_and_v2_50_50.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nå¢åŠ  v2 çš„å®ä¾‹ä¸ªæ•°ã€‚\n\n\u0060\u0060\u0060bash\nkubectl scale deployment recommendation-v2 --replicas=2 -n istio-tutorial\nkubectl get pods -w\n\u0060\u0060\u0060\n\nç­‰å¾…æ‰€æœ‰çš„ Pod çš„çŠ¶æ€éƒ½å¯åŠ¨å®Œæˆã€‚\n\nç°åœ¨åˆ° v2 çš„å®¹å™¨ä¸­æ“ä½œã€‚\n\n\u0060\u0060\u0060bash\n$ kubectl exec recommendation-v2-785465d9cd-225ms -c recommendation \/bin\/bash\n$ curl localhost:8080\/misbehave\nFollowing requests to \u0027\/\u0027 will return a 503\n\u0060\u0060\u0060\n\nå¢åŠ  Pool Ejection é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/recommendation_cb_policy_pool_ejection.yml -n istio-tutorial\n\u0060\u0060\u0060\n\næ­¤æ—¶å†è®¿é—® \u0060customer\u0060 æœåŠ¡ã€‚\n\n\u0060\u0060\u0060bash\n$ bin\/poll_customer.sh\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 10505\ncustomer =\u003e preference =\u003e recommendation v2 from \u0027785465d9cd-225ms\u0027: 2407\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 10506\ncustomer =\u003e preference =\u003e recommendation v2 from \u0027785465d9cd-225ms\u0027: 2408\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 10507\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 10508\ncustomer =\u003e preference =\u003e recommendation v1 from \u00276fc97476f8-m2ntp\u0027: 10509\ncustomer =\u003e 503 preference =\u003e 503 recommendation misbehavior from \u0027785465d9cd-ldc6j\u0027\ncustomer =\u003e preference =\u003e recommendation v2 from \u0027785465d9cd-225ms\u0027: 2409\ncustomer =\u003e preference =\u003e recommendation v2 from \u0027785465d9cd-225ms\u0027: 2410\n\u0060\u0060\u0060\n\næˆ‘ä»¬çœ‹åˆ°çª—å£æœŸç”Ÿæ•ˆäº†ï¼Œå½“å‡ºç° 503 é”™è¯¯åè‡³å°‘ 15 ç§’åæ‰ä¼šå‡ºç°ç¬¬äºŒæ¬¡ã€‚\n\nå³ä½¿æœ‰äº†è´Ÿè½½å‡è¡¡æ± å¼¹å‡ºç­–ç•¥å¯¹äºç³»ç»Ÿçš„å¼¹æ€§æ¥è¯´ä¾ç„¶è¿˜ä¸å¤Ÿï¼Œå¦‚æœä½ çš„æœåŠ¡æœ‰å¤šä¸ªå¯ç”¨å®ä¾‹ï¼Œå¯ä»¥å°†**æ–­è·¯å™¨**ã€**é‡è¯•**ã€**Pool Ejection** ç­‰ç­–ç•¥ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚\n\nä¾‹å¦‚åœ¨ä»¥ä¸Šçš„ Pool Ejection çš„åŸºç¡€ä¸Šå¢åŠ é‡è¯•ç­–ç•¥ã€‚\n\n\u0060\u0060\u0060bash\nistioctl replace -f istiofiles\/route-rule-recommendation-v1_and_v2_retry.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nç°åœ¨å†è®¿é—® \u0060customer\u0060 æœåŠ¡å°±çœ‹ä¸åˆ° 503 é”™è¯¯äº†ã€‚\n\næ¸…ç†é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nkubectl scale deployment recommendation-v2 --replicas=1 -n istio-tutorial\nistioctl delete routerule recommendation-v1-v2 -n istio-tutorial\nistioctl delete -f istiofiles\/recommendation_cb_policy_pool_ejection.yml -n istio-tutorial\n\u0060\u0060\u0060\n\n### Egress\n\nEgress æ˜¯ç”¨æ¥é…ç½® Istio Service mesh ä¸­çš„æœåŠ¡å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®ç­–ç•¥ã€‚\n\nå…·ä½“é…ç½®è¯·å‚è€ƒ [æ§åˆ¶ Egress æµé‡](http:\/\/istio.doczh.cn\/docs\/tasks\/traffic-management\/egress.html)ã€‚\n\nä»¥ä¸‹ç¤ºä¾‹è¿˜æœ‰é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸å·¥ä½œã€‚\n\næ„å»ºç¤ºä¾‹é•œåƒ egresshttpbinã€‚\n\n\u0060\u0060\u0060bash\ncd egress\/egresshttpbin\/\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-egresshttpbin:v1 .\ndocker push jimmysong\/istio-tutorial-egresshttpbin:v1\n\u0060\u0060\u0060\n\néƒ¨ç½²åˆ° Kubernetesã€‚\n\n\u0060\u0060\u0060bash\nkubectl apply -f \u003c(istioctl kube-inject -f egress\/egresshttpbin\/src\/main\/kubernetes\/Deployment.yml) -n istio-toturial\nkubectl create -f egress\/egresshttpbin\/src\/main\/kubernetes\/Service.yml\n\u0060\u0060\u0060\n\nä¸ºäº†åœ¨ kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œä¿®æ”¹å¢åŠ  ingress é…ç½®å¹¶ä¿®æ”¹æœ¬åœ°çš„\u0060\/etc\/hosts\u0060 æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨å‰é¢å·²ç»å®Œæˆäº†ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚\n\næ„å»ºç¤ºä¾‹é•œåƒ egressgithubã€‚\n\n\u0060\u0060\u0060bash\ncd egress\/egressgithub\nmvn clean package\ndocker build -t jimmysong\/istio-tutorial-egressgithub:v1 .\ndocker push jimmysong\/istio-tutorial-egressgithub:v1\n\u0060\u0060\u0060\n\néƒ¨ç½²åˆ° Kubernetesã€‚\n\n\u0060\u0060\u0060bash\nkubectl apply -f \u003c(istioctl kube-inject -f egress\/egressgithub\/src\/main\/kubernetes\/Deployment.yml) -n istio-tutorial\nkubectl create -f egress\/egressgithub\/src\/main\/kubernetes\/Service.yml\n\u0060\u0060\u0060\n\nå¢åŠ  Egress é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/egress_httpbin.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nåˆ° egresshttpbin å®¹å™¨ä¸­æµ‹è¯•ã€‚\n\n\u0060\u0060\u0060bash\nkubectl exec -it $(oc get pods -o jsonpath=\u0022{.items[*].metadata.name}\u0022 -l app=egresshttpbin,version=v1) -c egresshttpbin \/bin\/bash\n\ncurl localhost:8080\n\ncurl httpbin.org\/user-agent\n\ncurl httpbin.org\/headers\n\nexit\n\u0060\u0060\u0060\n\nå¢åŠ å¯¹ [jimmysong.io](https:\/\/jimmysong.io) çš„ egress é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\ncat \u003c\u003cEOF | istioctl create -f -\napiVersion: config.istio.io\/v1alpha2\nkind: EgressRule\nmetadata:\n  name: jimmysong-egress-rule\n  namespace: istio-tutorial\nspec:\n  destination:\n    service: jimmysong.io\n  ports:\n    - port: 443\n      protocol: https\nEOF\n\u0060\u0060\u0060\n\nå¢åŠ  Egress é…ç½®ã€‚\n\n\u0060\u0060\u0060bash\nistioctl create -f istiofiles\/egress_github.yml -n istio-tutorial\n\u0060\u0060\u0060\n\nåˆ° egressgithub å®¹å™¨ä¸­æµ‹è¯•ã€‚\n\n\u0060\u0060\u0060bash\nkubectl exec -it $(oc get pods -o jsonpath=\u0022{.items[*].metadata.name}\u0022 -l app=egressgithub,version=v1) -c egressgithub \/bin\/bash\n\ncurl http:\/\/jimmysong:443\n\nexit\n\u0060\u0060\u0060\n\næ¸…ç†ç¯å¢ƒã€‚\n\n\u0060\u0060\u0060bash\nistioctl delete egressrule httpbin-egress-rule jimmysong-egress-rule github-egress-rule -n istio-tutorial\n\u0060\u0060\u0060\n\n## å‚è€ƒ\n\n- https:\/\/github.com\/redhat-developer-demos\/istio-tutorial\n- [Book - Introducing Istio Service Mesh for Microservices](https:\/\/developers.redhat.com\/books\/introducing-istio-service-mesh-microservices\/)\n', '\/blog\/istio-tutorial\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡æ˜¯ Istio ç®¡ç† Java å¾®æœåŠ¡çš„æ¡ˆä¾‹æ•™ç¨‹ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-community-tips/">Istio ç¤¾åŒºä»‹ç»ä¸ç¤¾åŒºå‚ä¸æ³¨æ„äº‹é¡¹</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/04/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio ç¤¾åŒºä»‹ç»ä¸ç¤¾åŒºå‚ä¸æ³¨æ„äº‹é¡¹', 'æœ¬æ–‡è®²è¿°äº†å‚ä¸ Istio ç¤¾åŒºå’Œè¿›è¡Œ Istio å¼€å‘æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚', '\næœ¬æ–‡è®²è¿°äº†å‚ä¸ Istio ç¤¾åŒºå’Œè¿›è¡Œ Istio å¼€å‘æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚\n\n### å·¥ä½œç»„\n\nç»å¤§å¤šæ•°å¤æ‚çš„å¼€æºé¡¹ç›®éƒ½æ˜¯ä»¥å·¥ä½œç»„çš„æ–¹å¼ç»„ç»‡çš„ï¼Œè¦æƒ³ä¸º Istio ç¤¾åŒºåšè´¡çŒ®å¯ä»¥åŠ å…¥åˆ°ä»¥ä¸‹çš„å·¥ä½œç»„ï¼ˆWorking Groupï¼‰ï¼š\n\n- [API Management](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#api-management)\n- [Config](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#config)\n- [Environments](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#environments)\n- [Networking](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#networking)\n- [Performance \u0026 Scalability](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#performance-and-scalability)\n- [Policies \u0026 Telemetry](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#policies-and-telemetry)\n- [Security](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#security)\n- [Test \u0026 Release](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUPS.md#test-and-release)\n\n### ä»£ç è§„èŒƒ\n\nIstio çš„ä»£ç è§„èŒƒæ²¿ç”¨ [CNCF ç¤¾åŒºçš„ä»£ç è§„èŒƒ](https:\/\/github.com\/cncf\/foundation\/blob\/master\/code-of-conduct.md)ã€‚\n\n### å¼€å‘æŒ‡å—\n\nè¿›è¡Œ Istio å¼€å‘ä¹‹å‰éœ€è¦åšä¸‹é¢å‡ ä»¶äº‹æƒ…ï¼š\n\n- é…ç½®åŸºç¡€ç¯å¢ƒï¼Œå¦‚ Kubernetes\n- é…ç½®ä»£ç åº“ã€ä¸‹è½½ä¾èµ–å’Œæµ‹è¯•\n- é…ç½® CircleCI é›†æˆç¯å¢ƒ\n- ç¼–å†™å‚è€ƒæ–‡æ¡£\n- Git workflow é…ç½®\n\nè¯¦è§ [Dev Guide wiki](https:\/\/github.com\/istio\/istio\/wiki\/Dev-Guide)ã€‚\n\n### è®¾è®¡æ–‡æ¡£\n\næ‰€æœ‰çš„è®¾è®¡æ–‡æ¡£éƒ½ä¿å­˜åœ¨ [Google Drive](https:\/\/drive.google.com\/drive\/u\/0\/folders\/0AIS5p3eW9BCtUk9PVA) ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹èµ„æºï¼š\n\n- Technical Oversight Committeeï¼šToC ç®¡ç†çš„æ–‡æ¡£\n- Miscï¼šä¸€äº›æ‚é¡¹\n- Working Groupsï¼šæœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå„ä¸ªå·¥ä½œç»„ç›¸å…³çš„è®¾è®¡æ–‡æ¡£\n- Presentationsï¼šIstio ç›¸å…³çš„æ¼”è®²å¹»ç¯ç‰‡ï¼Œä»è¿™äº›æ–‡ç¨¿ä¸­å¯ä»¥å¿«é€Ÿäº†è§£ Istio\n- Logoï¼šIstio logo\n- Engï¼šç¤¾åŒºç›¸å…³çš„ç»´æŠ¤æ–‡æ¡£\n\n### ç¤¾åŒºè§’è‰²åˆ’åˆ†\n\næ ¹æ®å¯¹å¼€å‘è€…å’Œè¦æ±‚å’Œè´¡çŒ®ç¨‹åº¦çš„ä¸åŒï¼ŒIstio ç¤¾åŒºä¸­åŒ…å«ä»¥ä¸‹è§’è‰²ï¼š\n\n- [Collaborator](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#collaborator)ï¼šéæ­£å¼è´¡çŒ®è€…ï¼Œå¶å°”è´¡çŒ®ï¼Œä»»ä½•äººéƒ½å¯ä»¥æˆä¸ºè¯¥è§’è‰²\n- [Member](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#member)ï¼šæ­£å¼è´¡çŒ®è€…ï¼Œç»å¸¸è´¡çŒ®ï¼Œå¿…é¡»æœ‰ 2 ä¸ªå·²æœ‰çš„ member æå\n- [Approver](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#approver)ï¼šè€æ‰‹ï¼Œå¯ä»¥æ‰¹å‡† member çš„è´¡çŒ®\n- [Lead](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#lead)ï¼šç®¡ç†åŠŸèƒ½ã€é¡¹ç›®å’Œæè®®ï¼Œå¿…é¡»ç”± [ToC](https:\/\/github.com\/istio\/community\/blob\/master\/WORKING-GROUP-PROCESSES.md) æå\n- [Administrator](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#administrator)ï¼šç®¡ç†å‘˜ï¼Œç®¡ç†å’Œæ§åˆ¶æƒé™ï¼Œå¿…é¡»ç”± ToC æå\n- [Vendor](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md#vendor)ï¼šè´¡çŒ® Istio é¡¹ç›®çš„æ‰©å±•\n\nè¯¦è§ [Istio Community Roles](https:\/\/github.com\/istio\/community\/blob\/master\/ROLES.md)ã€‚\n\n### å„ç§åŠŸèƒ½çš„çŠ¶æ€\n\nIstio ä¸­çš„æ‰€æœ‰ feature æ ¹æ®**æ˜¯å¦ç”Ÿäº§å¯ç”¨**ã€**API å…¼å®¹æ€§**ã€**æ€§èƒ½**ã€**ç»´æŠ¤ç­–ç•¥**åˆ†ä¸ºä¸‰ç§çŠ¶æ€ï¼š\n\n- Alphaï¼šä»…ä»…å¯ä»¥ä½œä¸º demoï¼Œæ— æ³•ç”Ÿäº§ä¸Šä½¿ç”¨ï¼Œä¹Ÿæ²¡æœ‰æ€§èƒ½ä¿è¯ï¼Œéšæ—¶éƒ½å¯èƒ½ä¸ç»´æŠ¤\n- Betaï¼šå¯ä»¥åœ¨ç”Ÿäº§ä¸Šä½¿ç”¨äº†ï¼Œä¹Ÿæœ‰ç‰ˆæœ¬åŒ–çš„ API ä½†æ˜¯æ— æ³•ä¿è¯æ€§èƒ½ï¼Œä¿è¯ä¸‰ä¸ªæœˆçš„ç»´æŠ¤\n- Stableï¼šå¯ä»¥ä¸Šç”Ÿäº§è€Œä¸”è¿˜èƒ½ä¿è¯æ€§èƒ½ï¼ŒAPI å‘åå…¼å®¹ï¼Œä¿è¯ä¸€å¹´çš„ç»´æŠ¤\n\nIstio çš„ feature åˆ†ä¸ºå››å¤§ç±»ï¼š\n\n- æµé‡ç®¡ç†ï¼šå„ç§åè®®çš„æ”¯æŒã€è·¯ç”±è§„åˆ™é…ç½®ã€Ingress TLS ç­‰\n- å¯è§‚æµ‹æ€§ï¼šç›‘æ§ã€æ—¥å¿—ã€åˆ†å¸ƒå¼è¿½è¸ªã€æœåŠ¡ä¾èµ–æ‹“æ‰‘\n- å®‰å…¨æ€§ï¼šå„ç§ checker å’Œå®‰å…¨æ€§é…ç½®\n- Coreï¼šæ ¸å¿ƒåŠŸèƒ½\n\nåŠŸèƒ½åˆ’åˆ†ä¸å„ç§åŠŸèƒ½çš„çŠ¶æ€è¯¦æƒ…è¯·è§ï¼š\u003chttps:\/\/istio.io\/latest\/about\/feature-stages\/\u003e\n\n### äº‘åŸç”Ÿç¤¾åŒº Istio è®¨è®ºç»„\n\n[äº‘åŸç”Ÿç¤¾åŒº](https:\/\/cloudnative.to)ä¸“é—¨æˆç«‹é‡Œ Istio SIGï¼ˆå¾®ä¿¡è®¨è®ºç¾¤ï¼‰ï¼Œå°†åŸæ¥ ServiceMesher ä¸­å…³æ³¨ Istio çš„äººç¾¤ä¸“é—¨é›†ä¸­åˆ°ä¸€ä¸ªè®¨è®ºç»„ä¸­ï¼Œå…¶ä¸­åŒ…å«äº†ç™¾åº¦ã€é˜¿é‡Œå·´å·´ã€è…¾è®¯ã€ç½‘æ˜“ã€Tetrateã€Intelã€å­—èŠ‚è·³åŠ¨ç­‰å…¬å¸çš„æœåŠ¡ç½‘æ ¼ä¸“å®¶åŠä¼—å¤šçš„ç»ˆç«¯ç”¨æˆ·ï¼Œæ¬¢è¿å¤§å®¶[ç”³è¯·åŠ å…¥ç¾¤èŠ](https:\/\/i.cloudnative.to\/istio)ã€‚\n', '\/blog\/istio-community-tips\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡è®²è¿°äº†å‚ä¸ Istio ç¤¾åŒºå’Œè¿›è¡Œ Istio å¼€å‘æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/what-is-a-service-mesh/">ä»€ä¹ˆæ˜¯ Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰ï¼Ÿ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2017/09/20</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä»€ä¹ˆæ˜¯ Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰ï¼Ÿ', 'æœ¬æ–‡ä»‹ç»äº† Service Mesh æ˜¯ä»€ä¹ˆï¼Œå…¶å·¥ä½œåŸç†å¹¶æä¾›äº†ä¸€äº›æœ‰ç”¨çš„é“¾æ¥ã€‚', '\nService Mesh åˆè¯‘ä½œâ€œæœåŠ¡ç½‘æ ¼â€ï¼Œä½œä¸ºæœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚Buoyant å…¬å¸çš„ CEO Willian Morgan åœ¨ä»–çš„è¿™ç¯‡æ–‡ç«  WHATâ€™S A Service Mesh? AND WHY DO I NEED ONE? ä¸­è§£é‡Šäº†ä»€ä¹ˆæ˜¯ Service Meshï¼Œä¸ºä»€ä¹ˆäº‘åŸç”Ÿåº”ç”¨éœ€è¦ Service Meshã€‚\n\nä¸‹é¢æ˜¯ [Willian Morgan](https:\/\/twitter.com\/wm) å¯¹ Service Mesh çš„è§£é‡Šã€‚\n\n\u003e A Service Mesh is a dedicated infrastructure layer for handling service-to-service communication. Itâ€™s responsible for the reliable delivery of requests through the complex topology of services that comprise a modern, cloud native application. In practice, the Service Mesh is typically implemented as an array of lightweight network proxies that are deployed alongside application code, without the application needing to be aware.\n\nç¿»è¯‘æˆä¸­æ–‡æ˜¯ï¼š\n\n\u003e æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰æ˜¯å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚å®ƒè´Ÿè´£æ„æˆç°ä»£äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„å¤æ‚æœåŠ¡æ‹“æ‰‘æ¥å¯é åœ°äº¤ä»˜è¯·æ±‚ã€‚åœ¨å®è·µä¸­ï¼ŒService Mesh é€šå¸¸ä»¥è½»é‡çº§ç½‘ç»œä»£ç†é˜µåˆ—çš„å½¢å¼å®ç°ï¼Œè¿™äº›ä»£ç†ä¸åº”ç”¨ç¨‹åºä»£ç éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œå¯¹åº”ç”¨ç¨‹åºæ¥è¯´æ— éœ€æ„ŸçŸ¥ä»£ç†çš„å­˜åœ¨ã€‚\n\n## Service Mesh çš„ç‰¹ç‚¹\n\nService Mesh æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š\n\n- åº”ç”¨ç¨‹åºé—´é€šä¿¡çš„ä¸­é—´å±‚\n- è½»é‡çº§ç½‘ç»œä»£ç†\n- åº”ç”¨ç¨‹åºæ— æ„ŸçŸ¥\n- è§£è€¦åº”ç”¨ç¨‹åºçš„é‡è¯•\/è¶…æ—¶ã€ç›‘æ§ã€è¿½è¸ªå’ŒæœåŠ¡å‘ç°\n\nç›®å‰ä¸¤æ¬¾æµè¡Œçš„ Service Mesh å¼€æºè½¯ä»¶ [Istio](https:\/\/istio.io) å’Œ [Linkerd](https:\/\/linkerd.io) éƒ½å¯ä»¥ç›´æ¥åœ¨ Kubernetes ä¸­é›†æˆï¼Œå…¶ä¸­ Linkerd å·²ç»æˆä¸º CNCF ä¸­çš„é¡¹ç›®ã€‚\n\n## ç†è§£ Service Mesh\n\nå¦‚æœç”¨ä¸€å¥è¯æ¥è§£é‡Šä»€ä¹ˆæ˜¯ Service Meshï¼Œå¯ä»¥å°†å®ƒæ¯”ä½œæ˜¯åº”ç”¨ç¨‹åºæˆ–è€…è¯´å¾®æœåŠ¡é—´çš„ TCP\/IPï¼Œè´Ÿè´£æœåŠ¡ä¹‹é—´çš„ç½‘ç»œè°ƒç”¨ã€é™æµã€ç†”æ–­å’Œç›‘æ§ã€‚å¯¹äºç¼–å†™åº”ç”¨ç¨‹åºæ¥è¯´ä¸€èˆ¬æ— é¡»å…³å¿ƒ TCP\/IP è¿™ä¸€å±‚ï¼ˆæ¯”å¦‚é€šè¿‡ HTTP åè®®çš„ RESTful åº”ç”¨ï¼‰ï¼ŒåŒæ ·ä½¿ç”¨ Service Mesh ä¹Ÿå°±æ— é¡»å…³å¿ƒæœåŠ¡ä¹‹é—´çš„é‚£äº›åŸæœ¬é€šè¿‡æœåŠ¡æ¡†æ¶å®ç°çš„äº‹æƒ…ï¼Œæ¯”å¦‚ Spring Cloudã€Netflix OSS å’Œå…¶ä»–ä¸­é—´ä»¶ï¼Œç°åœ¨åªè¦äº¤ç»™ Service Mesh å°±å¯ä»¥äº†ã€‚\n\n[Phil CalÃ§ado](http:\/\/philcalcado.com\/) åœ¨ä»–çš„è¿™ç¯‡åšå®¢ [Pattern: Service Mesh](http:\/\/philcalcado.com\/2017\/08\/03\/pattern_service_mesh.html) ä¸­è¯¦ç»†è§£é‡Šäº† Service Mesh çš„æ¥é¾™å»è„‰ï¼š\n\n1. ä»æœ€åŸå§‹çš„ä¸»æœºä¹‹é—´ç›´æ¥ä½¿ç”¨ç½‘çº¿ç›¸è¿\n2. ç½‘ç»œå±‚çš„å‡ºç°\n3. é›†æˆåˆ°åº”ç”¨ç¨‹åºå†…éƒ¨çš„æ§åˆ¶æµ\n4. åˆ†è§£åˆ°åº”ç”¨ç¨‹åºå¤–éƒ¨çš„æ§åˆ¶æµ\n5. åº”ç”¨ç¨‹åºçš„ä¸­é›†æˆæœåŠ¡å‘ç°å’Œæ–­è·¯å™¨\n6. å‡ºç°äº†ä¸“é—¨ç”¨äºæœåŠ¡å‘ç°å’Œæ–­è·¯å™¨çš„è½¯ä»¶åŒ…\/åº“ï¼Œå¦‚ [Twitter çš„ Finagle](https:\/\/finagle.github.io\/) å’Œ [Facebook  çš„ Proxygen](https:\/\/code.facebook.com\/posts\/1503205539947302)ï¼Œè¿™æ—¶å€™è¿˜æ˜¯é›†æˆåœ¨åº”ç”¨ç¨‹åºå†…éƒ¨\n7. å‡ºç°äº†ä¸“é—¨ç”¨äºæœåŠ¡å‘ç°å’Œæ–­è·¯å™¨çš„å¼€æºè½¯ä»¶ï¼Œå¦‚ [Netflix OSS](http:\/\/netflix.github.io\/)ã€Airbnb çš„ [synapse](https:\/\/github.com\/airbnb\/synapse) å’Œ [nerve](https:\/\/github.com\/airbnb\/nerve)\n8. æœ€åä½œä¸ºå¾®æœåŠ¡çš„ä¸­é—´å±‚ Service Mesh å‡ºç°\n\nService Mesh çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![Service Mesh æ¶æ„å›¾](service-mesh-arch.png)\n\nå›¾ç‰‡æ¥è‡ªï¼š[Pattern: Service Mesh](http:\/\/philcalcado.com\/2017\/08\/03\/pattern_service_mesh.html)\n\nService Mesh ä½œä¸º sidecar è¿è¡Œï¼Œå¯¹åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯é€æ˜ï¼Œæ‰€æœ‰åº”ç”¨ç¨‹åºé—´çš„æµé‡éƒ½ä¼šé€šè¿‡å®ƒï¼Œæ‰€ä»¥å¯¹åº”ç”¨ç¨‹åºæµé‡çš„æ§åˆ¶éƒ½å¯ä»¥åœ¨ Service mesh ä¸­å®ç°ã€‚\n\n## Service Mesh å¦‚ä½•å·¥ä½œï¼Ÿ\n\nä¸‹é¢ä»¥ Istio ä¸ºä¾‹è®²è§£ Service Mesh å¦‚ä½•å·¥ä½œï¼Œåç»­æ–‡ç« å°†ä¼šè¯¦è§£ Istio å¦‚ä½•åœ¨ Kubernetes ä¸­å·¥ä½œã€‚\n\n1. Sidecarï¼ˆIstio ä¸­ä½¿ç”¨ [Envoy](https:\/\/envoyproxy.io) ä½œä¸º sidecar ä»£ç†ï¼‰å°†æœåŠ¡è¯·æ±‚è·¯ç”±åˆ°ç›®çš„åœ°å€ï¼Œæ ¹æ®è¯·æ±‚ä¸­çš„å‚æ•°åˆ¤æ–­æ˜¯åˆ°ç”Ÿäº§ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒè¿˜æ˜¯ staging ç¯å¢ƒä¸­çš„æœåŠ¡ï¼ˆæœåŠ¡å¯èƒ½åŒæ—¶éƒ¨ç½²åœ¨è¿™ä¸‰ä¸ªç¯å¢ƒä¸­ï¼‰ï¼Œæ˜¯è·¯ç”±åˆ°æœ¬åœ°ç¯å¢ƒè¿˜æ˜¯å…¬æœ‰äº‘ç¯å¢ƒï¼Ÿæ‰€æœ‰çš„è¿™äº›è·¯ç”±ä¿¡æ¯å¯ä»¥åŠ¨æ€é…ç½®ï¼Œå¯ä»¥æ˜¯å…¨å±€é…ç½®ä¹Ÿå¯ä»¥ä¸ºæŸäº›æœåŠ¡å•ç‹¬é…ç½®ã€‚è¿™äº›é…ç½®æ˜¯ç”±æœåŠ¡ç½‘æ ¼çš„æ§åˆ¶å¹³é¢æ¨é€ç»™å„ä¸ª sidecar çš„ï¼Œ\n2. å½“ sidecar ç¡®è®¤äº†ç›®çš„åœ°å€åï¼Œå°†æµé‡å‘é€åˆ°ç›¸åº”æœåŠ¡å‘ç°ç«¯ç‚¹ï¼Œåœ¨ Kubernetes ä¸­æ˜¯ serviceï¼Œç„¶å service ä¼šå°†æœåŠ¡è½¬å‘ç»™åç«¯çš„å®ä¾‹ã€‚\n3. Sidecar æ ¹æ®å®ƒè§‚æµ‹åˆ°æœ€è¿‘è¯·æ±‚çš„å»¶è¿Ÿæ—¶é—´ï¼Œé€‰æ‹©å‡ºæ‰€æœ‰åº”ç”¨ç¨‹åºçš„å®ä¾‹ä¸­å“åº”æœ€å¿«çš„å®ä¾‹ã€‚\n4. Sidecar å°†è¯·æ±‚å‘é€ç»™è¯¥å®ä¾‹ï¼ŒåŒæ—¶è®°å½•å“åº”ç±»å‹å’Œå»¶è¿Ÿæ•°æ®ã€‚\n5. å¦‚æœè¯¥å®ä¾‹æŒ‚äº†ã€ä¸å“åº”äº†æˆ–è€…è¿›ç¨‹ä¸å·¥ä½œäº†ï¼Œsidecar ä¼šå°†æŠŠè¯·æ±‚å‘é€åˆ°å…¶ä»–å®ä¾‹ä¸Šé‡è¯•ã€‚\n6. å¦‚æœè¯¥å®ä¾‹æŒç»­è¿”å› errorï¼Œsidecar ä¼šå°†è¯¥å®ä¾‹ä»è´Ÿè½½å‡è¡¡æ± ä¸­ç§»é™¤ï¼Œç¨åå†å‘¨æœŸæ€§å¾—é‡è¯•ã€‚\n7. å¦‚æœè¯·æ±‚çš„æˆªæ­¢æ—¶é—´å·²è¿‡ï¼Œsidecar ä¸»åŠ¨æ ‡è®°è¯¥è¯·æ±‚ä¸ºå¤±è´¥ï¼Œè€Œä¸æ˜¯å†æ¬¡å°è¯•æ·»åŠ è´Ÿè½½ã€‚\n8. SIdecar ä»¥ metric å’Œåˆ†å¸ƒå¼è¿½è¸ªçš„å½¢å¼æ•è·ä¸Šè¿°è¡Œä¸ºçš„å„ä¸ªæ–¹é¢ï¼Œè¿™äº›è¿½è¸ªä¿¡æ¯å°†å‘é€åˆ°é›†ä¸­ metric ç³»ç»Ÿã€‚\n\n## ä¸ºä½•ä½¿ç”¨ Service Meshï¼Ÿ\n\nService Mesh å¹¶æ²¡æœ‰ç»™æˆ‘ä»¬å¸¦æ¥æ–°åŠŸèƒ½ï¼Œå®ƒæ˜¯ç”¨äºè§£å†³å…¶ä»–å·¥å…·å·²ç»è§£å†³è¿‡çš„é—®é¢˜ï¼Œåªä¸è¿‡è¿™æ¬¡æ˜¯åœ¨ä»¥ Kubernetes ä¸ºåŸºç¡€çš„äº‘åŸç”Ÿç”Ÿæ€ç¯å¢ƒä¸‹çš„å®ç°ã€‚\n\nåœ¨ä¼ ç»Ÿçš„ MVC ä¸‰å±‚ Web åº”ç”¨ç¨‹åºæ¶æ„ä¸‹ï¼ŒæœåŠ¡ä¹‹é—´çš„é€šè®¯å¹¶ä¸å¤æ‚ï¼Œåœ¨åº”ç”¨ç¨‹åºå†…éƒ¨è‡ªå·±ç®¡ç†å³å¯ï¼Œä½†æ˜¯åœ¨ç°ä»Šçš„å¤æ‚çš„å¤§å‹ç½‘ç«™æƒ…å†µä¸‹ï¼Œå•ä½“åº”ç”¨è¢«åˆ†è§£ä¸ºä¼—å¤šçš„å¾®æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´çš„ä¾èµ–å’Œé€šè®¯ååˆ†å¤æ‚ï¼Œå‡ºç°äº† twitter å¼€å‘çš„ [Finagle](https:\/\/twitter.github.io\/finagle\/)ã€Netflix å¼€å‘çš„ [Hystrix](https:\/\/github.com\/Netflix\/Hystrix) å’Œ Google çš„ Stubby è¿™æ ·çš„â€œèƒ–å®¢æˆ·ç«¯â€åº“ï¼Œè¿™äº›å°±æ˜¯æ—©æœŸçš„ Service Meshï¼Œä½†æ˜¯å®ƒä»¬éƒ½ä»…é€‚ç”¨äºç‰¹å®šçš„ç¯å¢ƒå’Œç‰¹å®šçš„å¼€å‘è¯­è¨€ï¼Œå¹¶ä¸èƒ½ä½œä¸ºå¹³å°çº§çš„ Service Mesh æ”¯æŒã€‚\n\nåœ¨ Cloud Native æ¶æ„ä¸‹ï¼Œå®¹å™¨çš„ä½¿ç”¨èµ‹äºˆäº†å¼‚æ„åº”ç”¨ç¨‹åºæ›´å¤šçš„å¯èƒ½æ€§ï¼ŒKubernetes å¢å¼ºäº†åº”ç”¨çš„æ¨ªå‘æ‰©å®¹èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥å¿«é€Ÿçš„ç¼–æ’å‡ºå¤æ‚ç¯å¢ƒã€å¤æ‚ä¾èµ–å…³ç³»çš„åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶å¼€å‘è€…åˆæ— é¡»è¿‡åˆ†å…³å¿ƒåº”ç”¨ç¨‹åºçš„ç›‘æ§ã€æ‰©å±•æ€§ã€æœåŠ¡å‘ç°å’Œåˆ†å¸ƒå¼è¿½è¸ªè¿™äº›ç¹ççš„äº‹æƒ…ï¼Œè¿›è€Œä¸“æ³¨äºç¨‹åºå¼€å‘ï¼Œèµ‹äºˆå¼€å‘è€…æ›´å¤šçš„åˆ›é€ æ€§ã€‚\n\n## å‚è€ƒ\n\n- What\u0027s a Service Mesh? And why do I need one?\n- [So what even is a Service Mesh? Hot take on Istio and Linkerd](http:\/\/redmonk.com\/jgovernor\/2017\/05\/31\/so-what-even-is-a-service-mesh-hot-take-on-istio-and-linkerd)\n- [linkerd: A Service Mesh for AWS ECS](https:\/\/medium.com\/attest-engineering\/linkerd-a-service-mesh-for-aws-ecs-937f201f847a)\n- [Introducing Istio: A robust Service Mesh for microservices](https:\/\/istio.io\/blog\/istio-service-mesh-for-microservices.html)\n- [Application Network Functions With ESBs, API Management, and Now.. Service Mesh?](http:\/\/blog.christianposta.com\/microservices\/application-network-functions-with-esbs-api-management-and-now-service-mesh\/)\n- [Pattern: Service Mesh](http:\/\/philcalcado.com\/2017\/08\/03\/pattern_service_mesh.html)\n- [Envoy å®˜æ–¹æ–‡æ¡£](https:\/\/envoyproxy.io)\n- [Istio å®˜æ–¹æ–‡æ¡£](https:\/\/istio.io\/)\n\n', '\/blog\/what-is-a-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»äº† Service Mesh æ˜¯ä»€ä¹ˆï¼Œå…¶å·¥ä½œåŸç†å¹¶æä¾›äº†ä¸€äº›æœ‰ç”¨çš„é“¾æ¥ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/categories/service-mesh/">
         Â«Â«
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/categories/service-mesh/page/3/" class="page-link">
         Â«
       </a>
     </li>
     
     
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/categories/service-mesh/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/categories/service-mesh/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/categories/service-mesh/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item page-item active ">
           <a href="/categories/service-mesh/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
     
     
     
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      ä¸“æ 
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(69)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(39)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(24)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>éšç¬”</span>
            <span>(21)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>ä¸šæ€</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>å…¶ä»–</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(16)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>äº‘åŸç”Ÿ</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>å®‰å…¨</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>å¼€æº</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>å¯è§‚æµ‹æ€§</span>
            <span>(5)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>æ—…è¡Œ</span>
            <span>(4)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      èµ„æ–™
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>å‡ºç‰ˆç‰©</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘ç”µå­ä¹¦</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>ç¿»è¯‘æ–‡æ¡£</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘å›¾ä¹¦</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>åŸåˆ›å›¾ä¹¦</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>æ•™ç¨‹æ‰‹å†Œ</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">è”ç³»</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">å¾®ä¿¡å…¬ä¼—å·</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">åšå®¢</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/kubecon-china-2024-recap/">KubeCon China 2024 å›é¡¾ï¼šå¼•é¢†äº‘åŸç”ŸæŠ€æœ¯çš„å‰æ²¿åŠ¨æ€</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/black-myth-wukong-game-life/">ä»é»‘ç¥è¯æ‚Ÿç©ºèŠèµ·ï¼šæˆ‘å¿ƒç›®ä¸­çš„ 3A å¤§ä½œ</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-gateway-integration-istio-mesh/">é›†æˆ Envoy Gateway ä½œä¸º Istio æœåŠ¡ç½‘æ ¼ä¸­çš„å…¥å£ç½‘å…³</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é“¾æ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio æœåŠ¡ç½‘æ ¼
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate å…¬å¸
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå­¦é™¢|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå¼€æºé¡¹ç›®å¤§å…¨
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿç¤¾åŒºï¼ˆä¸­å›½ï¼‰
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">æ•™ç¨‹</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes åŸºç¡€æ•™ç¨‹
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é€šçŸ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024ï¼ˆé¦™æ¸¯ï¼‰</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">ç½‘ç«™æ”¹ç‰ˆé€šçŸ¥</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 å¤§è¿äº‘åŸç”ŸæŠ€æœ¯å¼€æ”¾æ—¥</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">Â© 2017-2024 Jimmy Song ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
