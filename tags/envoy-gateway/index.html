<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Envoy Gateway · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="宋净超的博客">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.6fb3e96087b14e4e93b1864f8131c7847fc003876bec82f602ff6e89143fedc8.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.6fb3e96087b14e4e93b1864f8131c7847fc003876bec82f602ff6e89143fedc8.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/tags/envoy-gateway/" />
  <meta property="og:title" content="Envoy Gateway | Jimmy Song" />
  <meta property="twitter:title" content="Envoy Gateway | Jimmy Song" />

  
  <meta property="og:description" content="宋净超的博客" />
  <meta property="twitter:description" content="宋净超的博客" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/tags/envoy-gateway/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Envoy Gateway
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/explore-tetrate-enterprise-gateway/">介绍 Tetrate Enterprise Gateway 及与 Istio 集成：云原生应用的全面网关解决方案</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/22</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('介绍 Tetrate Enterprise Gateway 及与 Istio 集成：云原生应用的全面网关解决方案', '深入了解 Tetrate Enterprise Gateway (TEG) 及其如何与 Istio 服务网格集成 —— 一种基于 Envoy 的企业级网关解决方案，包括它的架构、基本功能以及如何在 Kubernetes 中使用 TEG 来暴露和管理应用。', '\n## TEG 简介\n\nTetrate Enterprise Gateway（TEG）是基于 [Envoy Gateway](https:\/\/gateway.envoyproxy.io\/) (EG) 的企业级解决方案，专门针对 Envoy Proxy 设计，通过 [Kubernetes Gateway API](https:\/\/gateway-api.sigs.k8s.io\/) 提供更易于消费的 Envoy 代理配置和管理包。TEG 结合了 Kubernetes Gateway API 的特性，支持在 Kubernetes 中轻松暴露服务和应用程序。\n\nTEG 相对于 Envoy Gateway 的主要新增特性包括：\n\n1. **全局速率限制（Rate Limiting）**：TEG 支持基于 IP 5-tuple、请求头等进行流量控制，需要通过 Redis 实例管理。\n2. **WAF 功能（Web Application Firewall）**：TEG 提供了与 \u0060mod_security\u0060 兼容的 WAF 功能，增强了安全防护能力。\n3. **OIDC\/OAuth2认证**：支持在网关级别进行 OIDC\/OAuth2 认证，应用程序可以按路由配置认证方式。\n4. **使用 Kubernetes Gateway API**：相较于其他 API，Kubernetes Gateway API 的设计更加现代，结合了众多 Ingress 实现的经验，将网关的配置与流量的路由分离，使平台所有者可以管理网关，而应用团队可以掌控流量路由。\n\nTEG 将 Envoy 的高级网络流量处理能力带入 Kubernetes 环境，提供了一种简化的方法来部署和管理负载平衡、API 网关功能、安全控制等，同时支持现代的、开放的应用程序暴露 API，如 Kubernetes Gateway API。这些特性使 TEG 成为一个功能丰富、易于管理的企业级网关解决方案。\n\n## TEG 的能力\n\nTetrate Enterprise Gateway for Envoy (TEG) 构建于 Envoy Gateway 项目之上，提供了一种易于使用和操作的入口，具有先进的按请求流量控制功能、与现有环境的轻松集成，以及一流的可观测性，以理解应用流量和入口健康状况。\n\n### 易于安装、操作和升级\n\nTEG 从头到尾注重易用性：从首次安装到启用应用团队，从故障排查到执行升级。TEG 的初始安装只需几分钟，你就可以开始使用高级功能，如速率限制、单点登录和金丝雀流量路由。TEG 还简化了运维流程，与你现有的指标、跟踪和日志记录管道相适应，我们还提供了一个完整的、预配置的可观测性堆栈，以评估 EG 产生的数据，并帮助你计划如何将 TEG 集成到你的现有指标堆栈中。\n\n### 操作性：一流的功能\n\nTEG 由在生产环境中运行大型、关键系统的经验丰富团队构建。TEG 简化了漏洞检查和持续升级过程，与你现有的指标和跟踪提供商轻松集成，并为你现有的 Grafana 部署提供了一套强大的入口可观测性仪表板。\n\n### 与现有的环境集成\n\nTEG 不仅适用于绿地部署的启动，还可以直接与传统环境以及现代云原生环境集成。它可以帮助你在现有的应用生态系统和你正在构建的云原生目标之间架起桥梁。\n\n### 引入现有的可观测性堆栈\n\n你的组织可能已经有一个可观测性系统，你的应用和运营团队已经训练有素地使用它。TEG 可以轻松地嵌入到现有的基础设施中，并在你的组织中运行。TEG 将使 Envoy 的丰富指标集导出，让你的应用团队对其应用流量的行为有最佳的洞察，并看到他们所做配置更改的效果。TEG 还为运行它的平台团队提供了仪表板和警报功能，使你能够自信地操作并快速解决发现的问题。\n\n### 简单的负载平衡\n\nEnvoy 非常强大，但要使其启动并运行简单用例可能很难——像 Istio 这样的系统提供 Envoy 入口管理作为更广泛功能套件的一部分，也附带了许多与简单、流畅的操作体验相冲突的额外功能。这就是 Envoy Gateway 存在的原因：使 Envoy 的强大功能易于用于入口用例。\n\n### 简单的 API 网关\n\n组织中绝大多数 API 网关的使用归结为三件事：认证发起请求的用户；限制用户对服务的访问；在此 API 端点的服务实例之间进行负载平衡。TEG 简化了在传统和云原生环境中完成这三项任务的过程。\n\n## TEG 的架构\n\n下图展示的是 TEG 的架构图。\n\n![TEG 架构图](teg-architecture.svg)\n\n从架构图中可以看出，Tetrate Enterprise Gateway for Envoy (TEG) 的架构设计包括以下主要组件和流程：\n\n### 主要组件\n\n1. **Kubernetes Cluster**\n   - **Envoy Gateway**：作为控制平面，配置和管理 Envoy 代理，消费 Kubernetes Gateway API 的配置。\n   - **Metrics Collection**：使用 Prometheus 或 OpenTelemetry (OTEL) 作为指标收集点，用于监控 Envoy Proxy 的性能和健康状态。\n\n2. **Envoy Proxy**\n   - 作为数据平面，直接处理所有进入的流量，支持基于 Kubernetes Gateway API 的配置。\n\n3. **Coraza WAF**\n   - 作为 TEG 的一部分部署，执行 WAF 规则以保护应用免受恶意请求攻击。\n\n4. **Redis Rate Limit Store**\n   - 作为全局速率限制的存储解决方案，用于跨所有 Envoy 实例维护统一的速率限制计数。\n\n5. **Your OIDC Server**\n   - 处理 OAuth2.0 和 OIDC 认证流程，确保只有经过认证的用户可以访问特定的路由和服务。\n\n### 工作流程\n\n1. **流量入口**\n   - 所有外部流量首先通过上游的负载均衡器，然后被路由到 Envoy Proxy。\n\n2. **Envoy Proxy 处理**\n   - Envoy Proxy 根据 Kubernetes Cluster 中的 Envoy Gateway 的配置处理流量。\n   - 配置信息包括路由规则、安全策略（如 WAF 和速率限制）等。\n\n3. **安全和认证**\n   - **Coraza WAF**：在流量到达应用前，根据配置的 WAF 规则进行检查和过滤，提高安全性。\n   - **OIDC 认证**：OIDC Server 处理认证，Envoy Proxy 根据 OIDC Server 的验证结果决定是否允许访问。\n\n4. **速率限制**\n   - 使用 Redis 存储进行速率限制，Envoy Proxy 将根据从 Redis 获取的数据执行速率限制策略。\n\n5. **性能监控**\n   - Envoy Proxy 的性能和健康状态通过集成的指标收集系统（Prometheus 或 OTEL）进行监控。\n\n### 配置和管理\n\n- 用户可以通过 Kubernetes Gateway API 定义和应用 Envoy Proxy 的配置。\n- 这包括定义专用网关的具体配置，如安全规则、路由策略等。\n\n这种架构设计利用了 Kubernetes 的灵活性和扩展性，并通过 Envoy 提供了强大的流量管理和安全功能。\n\n## 部署 TEG\n\n执行下面的命令部署 TEG V0.0.0：\n\n\u0060\u0060\u0060bash\nexport REGISTRY=\u0022oci:\/\/docker.io\/tetrate\u0022\nexport CHART_VERSION=\u0022v0.0.0-latest\u0022\nhelm install teg ${REGISTRY}\/teg-envoy-gateway-helm \\\n --version ${CHART_VERSION} \\\n -n envoy-gateway-system --create-namespace\n\u0060\u0060\u0060\n\n检查部署：\n\n\u0060\u0060\u0060bash\nkubectl get pod -n envoy-gateway-system\n\u0060\u0060\u0060\n\n你将看到下面的结果：\n\n\u0060\u0060\u0060\nNAMESPACE              NAME                                                       READY   STATUS    RESTARTS        AGE\nenvoy-gateway-system   envoy-gateway-596dfbcb88-tx7xb                             1\/1     Running   0               3m55s\nenvoy-gateway-system   envoy-ratelimit-674b8c955c-jhlfn                           2\/2     Running   2 (3m48s ago)   3m54s\nenvoy-gateway-system   teg-envoy-gateway-64fd8c8fbb-59b4l                         1\/1     Running   0               3m55s\nenvoy-gateway-system   teg-redis-86bb7d9b9d-27n44                                 1\/1     Running   0               3m55s\n\u0060\u0060\u0060\n\n部署示例应用：\n\n\u0060\u0060\u0060bash\nkubectl create namespace httpbin\nkubectl apply -n httpbin -f https:\/\/raw.githubusercontent.com\/istio\/istio\/master\/samples\/httpbin\/httpbin.yaml\n\u0060\u0060\u0060\n\n部署 Envoy Proxy：\n\n\u0060\u0060\u0060bash\ncat \u003c\u003cEOF | kubectl apply -f -\napiVersion: gateway.networking.k8s.io\/v1\nkind: Gateway\nmetadata:\n  name: dedicated-gateway\n  namespace: httpbin\nspec:\n  gatewayClassName: teg\n  listeners:\n    - name: http\n      protocol: HTTP\n      port: 80\nEOF\n\u0060\u0060\u0060\n\n然后你会在 \u0060envoy-gateway-system\u0060 命名空间下看到一个新的 Envoy 代理。\n\n部署 HTTPRoute，给网关配置路由：\n\n\u0060\u0060\u0060bash\ncat \u003c\u003cEOF | kubectl apply -f -\napiVersion: gateway.networking.k8s.io\/v1\nkind: HTTPRoute\nmetadata:\n  name: httpbin\n  namespace: httpbin\nspec:\n  parentRefs:\n    - group: gateway.networking.k8s.io\n      kind: Gateway\n      name: dedicated-gateway\n  rules:\n    - matches:\n        - path:\n            type: PathPrefix\n            value: \/httpbin\/\n      filters:\n        - type: URLRewrite\n          urlRewrite:\n            path:\n              type: ReplacePrefixMatch\n              replacePrefixMatch: \/\n      backendRefs:\n        - group: \u0022\u0022\n          kind: Service\n          name: httpbin\n          port: 8000\nEOF\n\u0060\u0060\u0060\n\n这个路由配置中有一个 URLRewrite filter，重写 URL 前缀，去掉了 \u0060\/httpbin\/\u0060 部分。\n\n发送流量测试：\n\n\u0060\u0060\u0060bash\nexport DEDICATED_GATEWAY_IP=$(kubectl get gateway\/dedicated-gateway -n httpbin -o jsonpath=\u0027{.status.addresses[0].value}\u0027)\ncurl -i http:\/\/${DEDICATED_GATEWAY_IP}\/httpbin\/get\n\u0060\u0060\u0060\n\n{{\u003ccallout note \u0022为什么使用 \u0060\/httpbin\/get\u0060?\u0022\u003e}}\n\n在通过 Tetrate Enterprise Gateway for Envoy (TEG) 暴露 \u0060httpbin\u0060 应用时，选择 \u0060\/httpbin\/get\u0060 作为访问路径的原因主要是为了在同一个 Envoy 网关下能够同时支持多个应用或服务，并能根据不同的路径将流量正确地路由到指定的服务。\n\n这种路径前缀的设置方法允许系统管理员或开发人员为每个服务配置独立的路径前缀，从而通过单一的入口点（即 Envoy 网关）来管理对多个后端服务的访问。这样的配置增加了路由的灵活性，使得在不更改现有服务配置的情况下，轻松地扩展或修改服务的暴露方式。\n\n{{\u003c\/callout\u003e}}\n\n## 作为 Istio 的入口网关\n\nIstio 提供了成熟且灵活的入口网关支持，基于与 Tetrate Enterprise Gateway（TEG）相同的 Envoy 代理。Istio 主要专注于处理集群内服务之间的通信。相较之下，TEG 设计用于向外界暴露应用，处理人类用户的请求，并支持如 OIDC 单点登录等高级功能。通过结合 Istio 网格和 TEG 的高级网关功能，两者可以共同使用，以提升整体应用的可访问性和安全性。\n\n以下图示展示了 Istio 网格中入口网关的流量路径。\n\n![Istio 中入口网关的流量路径](istio-ingress-sidecar.svg)\n\n下图展示了在引入 TEG 之后，流量如何从 Istio 网格边缘进入到内部。\n\n![引入 TEG 后流量从 Istio 网格边缘进入内部的流量路径](istio-teg-integration.svg)\n\n将 TEG 集成到 Istio 网格中，通过在 TEG 上配置 sidecar 来颁发证书，同时避免 sidecar 拦截 TEG 中的流量。然后通过 Envoy Gateway 控制入口网关的流量路径。\n\n### 为 TEG 与 Istio 的互操作做准备\n\n为了使 TEG 作为 Istio 的入口网关，应注意以下关键点：\n\n- 在安装 Istio 时，避免启用 Ingress Gateway。我们将手动安装并配置 TEG 作为 Istio 的入口网关。\n- 由于 Istio 和 TEG 都使用 Envoy 作为代理，我们需要让 Istio 为 TEG 的网关 Pod 注入 Envoy sidecar，以便 TEG 可以安全地与 Istio 数据平面通信。\n- 配置 Envoy Gateway 创建的 Envoy 代理的[路由类型](https:\/\/gateway.envoyproxy.io\/latest\/api\/extension_types\/#routingtype)为 \u0060Service\u0060 而非 \u0060Endpoint\u0060，确保 Envoy 代理能正确找到路由。\n\n为 TEG 的命名空间添加标签，以确保数据平面获得 Istio sidecar 的注入。\n\n\u0060\u0060\u0060bash\nkubectl label namespace envoy-gateway-system --overwrite=true istio-injection=enabled\n\u0060\u0060\u0060\n\n我们还需要配置 TEG 的 sidecar，使其不处理进入网关的 Envoy 流量。注入 sidecar 的目的是使 Envoy Gateway 的组件及其创建的代理能够被纳入 Istio 网格，并挂载正确的证书进行安全通信。\n\n{{\u003c include_code file=\u0022control-plane-tls.yaml\u0022 \u003e}}\n\n\u0060\u0060\u0060bash\nkubectl patch service -n envoy-gateway-system envoy-gateway \\\n     --type strategic --patch-file control-plane-tls.yaml\n\u0060\u0060\u0060\n\n配置 Envoy Gateway 中的 sidecar 不拦截流量：\n\n{{\u003c include_code file=\u0022teg-sidecars-no-inbound.yaml\u0022 \u003e}}\n\n\u0060\u0060\u0060bash\nkubectl apply -f teg-sidecars-no-inbound.yaml\n\u0060\u0060\u0060\n\n修改 GatewayClass 的配置，将上述 sidecar 配置应用到 Envoy Gateway 数据平面的所有 \u0060EnvoyProxy\u0060 上：\n\n{{\u003cinclude_code file=\u0022gtwcls-use-envoyproxy.yaml\u0022\u003e}}\n\n\u0060\u0060\u0060bash\nkubectl patch gatewayclass teg --patch-file gtwcls-use-envoyproxy.yaml --type merge\n\u0060\u0060\u0060\n\n### 安装 Istio\n\n使用 minimal profile 部署 Istio，从而不部署 Ingress Gateway：\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=demo\n\u0060\u0060\u0060\n\n### 重启 TEG 控制平面\n\n现在 Istio 的 sidecar 注入已准备就绪，我们将重启所有 TEG 控制平面 Pods，它们将带有 sidecar 重新启动。\n\n\u0060\u0060\u0060bash\nfor d in envoy-gateway envoy-ratelimit teg-envoy-gateway teg-redis; \\\n    do kubectl rollout restart deployment -n envoy-gateway-system $d; \\\n    done\n\u0060\u0060\u0060\n\n### 部署测试应用\n\n此步应在安装 Istio 之后进行，以确保它们也获得 sidecar 的注入。\n\n\u0060\u0060\u0060bash\nkubectl create namespace httpbin\nkubectl label namespace httpbin --overwrite=true istio-injection=enabled\nkubectl apply -n httpbin -f https:\/\/raw.githubusercontent.com\/istio\/istio\/master\/samples\/httpbin\/httpbin.yaml\n\u0060\u0060\u0060\n\n### 配置 TEG\n\n现在我们配置 TEG 处理边缘流量。\n\n{{\u003cinclude_code file=\u0022apps-gateway.yaml\u0022\u003e}}\n\n\u0060\u0060\u0060bash\nkubectl apply -f apps-gateway.yaml\n\u0060\u0060\u0060\n\n部署应用网关，包含以下容器：\n\n- \u0060istio-init\u0060：由 Istio 注入，负责修改 pod 中的 iptables\n- \u0060envoy\u0060：由 TEG 控制，作为入口网关\n- \u0060istio-proxy\u0060：由 Istio 注入，负责与集群内部 pod 联系\n- \u0060shutdown-manager\u0060：由 TEG 控制，负责 Pod 启停\n\n创建 HTTP 路由：\n\n{{\u003cinclude_code file=\u0022httpbin-route.yaml\u0022\u003e}}\n\n\u0060\u0060\u0060bash\nkubectl apply -f httpbin-route.yaml\n\u0060\u0060\u0060\n\n### 发送测试请求\n\n获取网关的负载均衡器 IP 地址，并发送测试请求：\n\n\u0060\u0060\u0060bash\nexport GATEWAY_URL=$(kubectl get svc -n envoy-gateway-system -l gateway.envoyproxy.io\/owning-gateway-name=apps -o jsonpath=\u0027{.items[0].status.loadBalancer.ingress[0].ip}\u0027)\ncurl -v -H Host:www.example.com http:\/\/$GATEWAY_URL\/httpbin\/get\n\u0060\u0060\u0060\n\n你将看到来自 \u0060httpbin\u0060 服务的正确响应。\n\n### 启用严格的 mTLS\n\n测试 Istio 网格启用严格的 mTLS：\n\n{{\u003cinclude_code file=\u0022strict-mtls.yaml\u0022\u003e}}\n\n\u0060\u0060\u0060bash\nkubectl apply -f strict-mtls.yaml\n\u0060\u0060\u0060\n\n因为我们在客户端请求时没有配置证书，启用 mTLS 后，对 httpbin 服务的请求将返回 503 错误。\n\n## 总结\n\nTetrate Enterprise Gateway 为企业提供了一种强大的网关解决方案，能够在云原生环境中高效地暴露和管理应用服务。通过其基于 Envoy 的架构和对 Kubernetes Gateway API 的支持，TEG 不仅确保了高性能的流量管理，还大幅简化了网关的部署和维护。无论是面对复杂的安全需求还是高流量的业务场景，TEG 都能提供可靠的支持，帮助企业实现其业务连续性和技术创新。\n\n## 参考\n\n- https:\/\/docs.tetrate.io\/envoy-gateway\/v0.0.0-latest\/howto\/eg-and-istio\n', '\/blog\/explore-tetrate-enterprise-gateway\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入了解 Tetrate Enterprise Gateway (TEG) 及其如何与 Istio 服务网格集成 —— 一种基于 Envoy 的企业级网关解决方案，包括它的架构、基本功能以及如何在 Kubernetes 中使用 TEG 来暴露和管理应用。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-contributor-guide/">如何参与 Envoy Gateway 社区：贡献或提交代码指南</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/17</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('如何参与 Envoy Gateway 社区：贡献或提交代码指南', '本指南提供了如何参与 Envoy Gateway 开源项目的详细步骤，包括设置开发环境、代码贡献、PR 流程以及与社区互动的方法。', '\nEnvoy Gateway 是由 Envoy Proxy 社区推动的一个开源 API 网关项目，结合了 Contour、Emissary 等项目力量。这个指南将帮助你理解如何贡献代码和参与社区。\n\n## 开始之前\n\n了解项目的[目标和愿景](https:\/\/github.com\/envoyproxy\/gateway\/blob\/main\/GOALS.md)是非常重要的。Envoy Gateway 旨在作为一个独立或基于 Kubernetes 的应用程序网关，使用 Gateway API 资源来管理 Envoy 代理。\n\n## 如何参与\n\n### 1. 沟通协作\n\n在开发前，建议通过[GitHub](https:\/\/github.com\/envoyproxy\/gateway)或[Slack](https:\/\/communityinviter.com\/apps\/envoyproxy\/envoy)与社区交流。始终创建一个 GitHub Issue 来讨论你的想法。\n\n### 2. 贡献准则\n\n遵守[贡献准则](https:\/\/gateway.envoyproxy.io\/contributions\/contributing\/)，它包括代码规范和社区行为准则。\n\n### 3. 提交代码\n\n- **签署 DCO**：确保你的提交信息包含 DCO 签名。\n- **创建 PR**：Fork 仓库后，提交 PR。确保通过所有自动化测试。\n- **代码审查**：PR 会被维护人员审查，一旦满足条件，将会被合并。\n\n## 构建和测试指南\n\n### 环境准备\n\n- **必需工具**：\n  - Go（版本 1.22\u002b）\n  - Make（版本 4.0\u002b）\n  - Docker（可选，版本 20.10.16\u002b，用于构建镜像）\n  - Python3\n- **设置步骤**：确保所有工具均已安装并配置好环境变量。\n\n### 代码构建\n\n- **构建命令**：\n  - 构建全部二进制文件：\u0060make build\u0060\n  - 仅构建 Envoy Gateway：\u0060make build BINS=\u0022envoy-gateway\u0022\u0060\n  - 构建控制工具 \u0060egctl\u0060：\u0060make build BINS=\u0022egctl\u0022\u0060\n\n### 测试\n\n- **运行测试**：执行 \u0060make test\u0060 来进行 Go 语言的测试。\n- **生成测试数据**：执行 \u0060make testdata\u0060 来生成 YAML 格式的测试数据。\n\n### Lint 检查\n\n- **执行 Lint**：运行 \u0060make lint\u0060 确保代码风格和标准一致性（注意修正现有的拼写错误）。\n\n### 镜像操作\n\n- **构建镜像**：\u0060IMAGE=docker.io\/\u003cdockerhub-id\u003e\/gateway-dev make image\u0060\n- **推送多架构镜像**：\u0060IMAGE=docker.io\/\u003cdockerhub-id\u003e\/gateway-dev make push-multiarch\u0060\n\n### 部署和调试\n\n- **本地集群创建**：使用 \u0060make create-cluster\u0060 在 Kind 上创建测试\/开发用的集群。\n- **部署到 Kubernetes**：使用 \u0060IMAGE=docker.io\/\u003cdockerhub-id\u003e\/gateway-dev TAG=\u003cimage-tag\u003e make kube-deploy\u0060 将 Envoy Gateway 部署至 Kubernetes。\n- **部署示例应用**：执行 \u0060make kube-demo\u0060 部署 demo 后端服务及相关网络资源。\n- **删除部署**：执行 \u0060make kube-demo-undeploy\u0060 删除示例应用。执行 \u0060make kube-undeploy\u0060 删除 Envoy Gateway。\n\n{{\u003ccallout note \u0022Kind 中运行的 Pod 列表\u0022\u003e}}\n当你完成 Envoy Gateway 和示例应用部署后，运行 \u0060kubectl get pod -A\u0060 命令，你将看到如下所示的 Pod 列表。\n{{\u003cdetail \u0022查看 Kind 中运行的 Pod\u0022\u003e}}\n     NAMESPACE              NAME                                                  READY   STATUS    RESTARTS      AGE\n     default                backend-96f75bbf-tcdf7                                1\/1     Running   1 (97s ago)   13h\n     envoy-gateway-system   envoy-default-eg-e41e7b31-668f754989-wb7xr            2\/2     Running   2 (97s ago)   13h\n     envoy-gateway-system   envoy-gateway-b457dc69b-l77cr                         1\/1     Running   2 (97s ago)   13h\n     kube-system            coredns-5dd5756b68-b494d                              1\/1     Running   1 (97s ago)   14h\n     kube-system            coredns-5dd5756b68-j46bx                              1\/1     Running   1 (97s ago)   14h\n     kube-system            etcd-envoy-gateway-control-plane                      1\/1     Running   1 (97s ago)   14h\n     kube-system            kindnet-sq4b4                                         1\/1     Running   1 (97s ago)   14h\n     kube-system            kube-apiserver-envoy-gateway-control-plane            1\/1     Running   1 (97s ago)   14h\n     kube-system            kube-controller-manager-envoy-gateway-control-plane   1\/1     Running   2 (97s ago)   14h\n     kube-system            kube-proxy-4x72s                                      1\/1     Running   1 (97s ago)   14h\n     kube-system            kube-scheduler-envoy-gateway-control-plane            1\/1     Running   2 (97s ago)   14h\n     local-path-storage     local-path-provisioner-6f8956fb48-shjcz               1\/1     Running   2 (59s ago)   14h\n     metallb-system         controller-5c6b6c8447-kjl4n                           1\/1     Running   2 (59s ago)   14h\n     metallb-system         speaker-6zlrb                                         1\/1     Running   1 (97s ago)   14h\n{{\u003c\/detail\u003e}}\n{{\u003c\/callout\u003e}}\n\n### 调试 Envoy 配置\n\n- **端口转发设置**：\n  \u0060\u0060\u0060bash\n  export ENVOY_DEPLOYMENT=$(kubectl get deploy -n envoy-gateway-system --selector=gateway.envoyproxy.io\/owning-gateway-namespace=default,gateway.envoyproxy.io\/owning-gateway-name=eg -o jsonpath=\u0027{.items[0].metadata.name}\u0027)\n  kubectl port-forward deploy\/${ENVOY_DEPLOYMENT} -n envoy-gateway-system 19000:19000\n    \u0060\u0060\u0060\n- **访问**：在浏览器中打开 \u0060http:\/\/localhost:19000\u0060 访问 Envoy 管理界面进行配置调试。\n- **网络环境适配**：在中国大陆进行构建和推送镜像时，可能需要设置 Docker 代理以确保依赖的镜像能够下载。详细操作可参考[设置 Docker 代理](https:\/\/docs.docker.com\/network\/proxy\/)。\n\n{{\u003ccallout warning 注意事项\u003e}}\n若你在中国大陆的网络环境下构建和推送镜像，需要为 Docker 设置代理，否则你将无法下载一些依赖镜像。你可以将它们下载到本地后再用 \u0060kind load\u0060 命令加载到 kind 里。需要下载和加载到 kind 里的镜像见下面的代码。\n\n{{\u003cdetail \u0022pull-and-load-images-for-kind.sh\u0022\u003e}}\n\n{{\u003c include_code file=\u0022pull-and-load-images-for-kind.sh\u0022 \u003e}}\n\n{{\u003c\/detail\u003e}}\n\n{{\u003c\/callout\u003e}}\n\n### 更多资源\n\n想深入了解如何进行高级测试和贡献，详见 [Envoy Gateway 开发文档](https:\/\/gateway.envoyproxy.io\/contributions\/develop\/)。\n\n加入我们，与全球开发者共同推进 Envoy Gateway 的成长，同时提升你的开发技能和对开源社区的理解。\n\n## 加入 Envoy Gateway 中文交流群\n\n为了便于中文和中国时区的用户交流，Envoy Gateway 社区成立的微信群，详见[通知](\/notice\/envoy-gateway-group\/)，该群成立于 2023 年 4 月，目前已有 400 多名成员。你可以联系[联系我](\/contact\/)、[刘训灼](https:\/\/www.liuxunzhuo.com\/)、[赵化冰](https:\/\/zhaohuabing.com\/)等入群。\n\n## 参考\n\n- [Envoy Gateway Developer Guide - gateway.envoyproxy.io](https:\/\/gateway.envoyproxy.io\/contributions\/develop\/)', '\/blog\/envoy-gateway-contributor-guide\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本指南提供了如何参与 Envoy Gateway 开源项目的详细步骤，包括设置开发环境、代码贡献、PR 流程以及与社区互动的方法。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-oidc/">如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/05/24</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？', '本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。', '\n在[微服务中常见的认证方式详解](\/blog\/microservice-auth-methods\/)这篇博客中我们介绍到了 OAuth 2.0 认证，该身份认证协议有多种实现方式，其中最流行的就是 OpenID Connect（OIDC）认证。OIDC 能够为用户提供身份验证和授权。本文将介绍如何使用 Envoy Gateway 在 API 网关级别实现 OIDC 认证。\n\n## Envoy Gateway 支持的认证方式 {#auth-methods}\n\nEnvoy Gateway 是一个使用 Envoy 实现的高性能的 API 网关，支持多种认证方式来保护 API 和微服务：\n\n1. **JWT 认证**: 使用 JSON Web Tokens（JWT）进行认证。\n2. **mTLS（双向 TLS）**: 使用双向 TLS 确保客户端和服务器之间的安全通信。\n3. **HTTP Basic 认证**: 使用用户名和密码进行基本认证。\n4. **OIDC 认证**: 使用 OpenID Connect 协议进行身份验证和授权。\n5. **外部认证**：外部认证调用外部 HTTP 或 gRPC 服务来检查传入的 HTTP 请求是否经过认证。\n\n本文重点介绍如何在 Envoy Gateway 中配置和使用 OIDC 认证从而在网关侧实现单点登录。\n\n## 什么是 OIDC？{#what-is-oidc}\n\nOpenID Connect（OIDC）是一个基于 [OAuth 2.0](\/blog\/microservice-auth-methods\/#oauth-20) 的身份验证协议。它允许客户端通过认证服务器验证用户身份，并获取有关用户的信息。\n\nOIDC 认证流程如下图所示：\n\n\u0060\u0060\u0060mermaid \u0022OIDC 认证流程图\u0022\nsequenceDiagram\n    participant User\n    participant Client\n    participant AuthServer\n    participant ResourceServer\n\n    User -\u003e\u003e Client: 请求访问受保护资源\n    Client -\u003e\u003e AuthServer: 请求认证（带有客户端 ID）\n    AuthServer -\u003e\u003e User: 请求用户登录\n    User -\u003e\u003e AuthServer: 用户登录并授权\n    AuthServer -\u003e\u003e Client: 返回授权码\n    Client -\u003e\u003e AuthServer: 交换授权码获取访问令牌和 ID 令牌\n    AuthServer -\u003e\u003e Client: 返回访问令牌和 ID 令牌\n    Client -\u003e\u003e ResourceServer: 请求受保护资源（带有访问令牌）\n    ResourceServer -\u003e\u003e AuthServer: 验证访问令牌\n    AuthServer -\u003e\u003e ResourceServer: 验证成功\n    ResourceServer -\u003e\u003e Client: 返回受保护资源\n    Client -\u003e\u003e User: 返回受保护资源\n\u0060\u0060\u0060\n\n![OIDC 认证流程图](83b3c4d30c57805947a314f67c7aa8c1.svg)\n\nOIDC 为 OAuth 2.0 增加了身份验证层，通过引入 ID Token 和标准化的 UserInfo Endpoint，使 OAuth 2.0 不仅能够用于授权，还可以用于安全地验证用户身份，从而实现单点登录（SSO）和用户身份信息的获取。\n\n## 为什么要实现单点登录？{#why-sso}\n\n单点登录（Single Sign-On, SSO）是一种身份验证方式，它允许用户使用一个账户登录多个独立的应用系统，通过一次身份验证即可无缝访问所有相关应用，减少重复输入用户名和密码的麻烦，从而提升用户体验。SSO 集中管理用户身份和认证，增强了系统安全性，并简化了 IT 管理流程。\n\n对于微服务架构，SSO 尤其重要，因为它在各个微服务之间实现统一的认证和授权，避免了每个服务单独实现身份验证逻辑的需求，减少了用户重复登录的麻烦，并提高了用户体验。集中管理的方式还可以统一应用安全策略，更有效地监控和响应安全事件，提升系统的整体安全性。同时，通过使用标准化的令牌（如 JWT），SSO 简化了微服务之间的身份验证过程，提高了开发效率，让开发人员能够专注于业务逻辑的实现。\n\n## 示例：使用 Envoy Gateway 和 Auth0 的单点登录 {#demo}\n\n接下来我们将使用 Auth0 作为身份供应商，演示如何使用 Envoy Gateway 在 API 网关端实现单点登录。\n\n你可以在 [Bilibili](https:\/\/www.bilibili.com\/video\/BV11m421K7ZW\/?share_source=copy_web\u0026vd_source=87728cb6b1b0090fc617caf07a40b236) 上查看该示例演示。\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=1604968380\u0026bvid=BV11m421K7ZW\u0026cid=1557352862\u0026p=1\u0022 aspectRatio=\u002262.5%\u0022 \u003e}}\n\n### 基于 Auth0 实现单点登录 {#auth0-sequence}\n\n首先我们先说明下示例中 Envoy Gateway 基于 Auth0 实现单点登录的详细流程，如下图所示。\n\n\u0060\u0060\u0060mermaid \u0022Envoy Gateway 基于 Auth0 实现单点登录的流程图\u0022\nsequenceDiagram\n    participant 用户\n    participant 浏览器\n    participant Envoy Gateway\n    participant Auth0\n    participant 应用程序\n\n    用户 -\u003e\u003e 浏览器: 打开 https:\/\/www.example.com\n    浏览器 -\u003e\u003e Envoy Gateway: 请求 https:\/\/www.example.com\n    Envoy Gateway -\u003e\u003e 浏览器: 在 cookie 中未找到 ID token\n    Envoy Gateway -\u003e\u003e 浏览器: 重定向到 Auth0\n    浏览器 -\u003e\u003e Auth0: 请求 \/authorize?response_type=code\u0026client_id=${CLIENT_ID}\u0026redirect_uri=https:\/\/www.example.com\/myapp\/oauth2\/callback\n    Auth0 -\u003e\u003e 浏览器: 重定向到用户登录页面\n    浏览器 -\u003e\u003e 用户: 输入用户名和密码\n    用户 -\u003e\u003e 浏览器: 用户登录\n    浏览器 -\u003e\u003e Auth0: 提交凭证\n    Auth0 -\u003e\u003e 浏览器: 重定向到 https:\/\/www.example.com\/myapp\/oauth2\/callback?code=xxxx\u0026state=xxx\n    浏览器 -\u003e\u003e Envoy Gateway: 请求 https:\/\/www.example.com\/myapp\/oauth2\/callback?code=xxxx\n    Envoy Gateway -\u003e\u003e Auth0: 使用代码交换 ID Token\n    Envoy Gateway -\u003e\u003e 浏览器: 设置 cookie: ID Token\n    Envoy Gateway -\u003e\u003e 浏览器: 重定向到 https:\/\/www.example.com\n    浏览器 -\u003e\u003e Envoy Gateway: 请求 https:\/\/www.example.com\n    Envoy Gateway -\u003e\u003e Envoy Gateway: 验证 ID Token\n    Envoy Gateway -\u003e\u003e 应用程序: 路由到 Backend service\n\u0060\u0060\u0060\n\n![Envoy Gateway 基于 Auth0 实现单点登录的流程图](0f2852499a637280acfa600e992fd2c8.svg)\n\n步骤说明：\n\n1. **用户访问网站**：用户通过浏览器访问 \u0060https:\/\/www.example.com\u0060。\n2. **请求转发**：浏览器向 Envoy Gateway 发送 GET 请求。\n3. **检查 ID 令牌**：Envoy Gateway 检查用户请求的 cookie 是否包含有效的 ID 令牌。\n4. **重定向到身份提供商**：如果没有找到 ID 令牌，Envoy Gateway 将用户重定向到身份提供商（Identity Provider，IdP）的授权端点，在这里是 Auth0，关于 Auth0 如何实现 Login 的详细信息请查看 [Auth0 文档](https:\/\/auth0.com\/docs\/api\/authentication#login)。\n5. **用户登录**：用户在身份提供商的登录页面输入用户名和密码，并提交凭证进行登录。\n6. **获取授权码**：用户成功登录后，身份提供商将用户重定向回 Envoy Gateway，并在 URL 中包含授权码。\n7. **交换 ID 令牌**：Envoy Gateway 使用授权码向身份提供商请求 ID 令牌。\n8. **设置 Cookie**：身份提供商返回 ID 令牌，Envoy Gateway 将其设置为用户的 cookie。\n9. **重定向**：Envoy Gateway 将 URL 重定向到 \u0060https:\/\/www.example.com\u0060。\n10. **验证 ID 令牌**：Envoy Gateway 验证用户请求中的 ID 令牌。\n11. **路由请求**：验证通过后，Envoy Gateway 将请求路由到后端应用（App）。\n\n通过上述流程，Envoy Gateway 实现了单点登录功能。用户的 HTTP 请求在没有得到授权的情况下都会被转发单点登录页面。除了 Auth0 以外，Envoy Gateway 还支持多个身份提供商，如 Azure AD、Keycloak、Okta、OneLogin、Salesforce、UAA 等。\n\n下面我们将按照时序图中的流程配置 Auth0 和 Envoy Gateway。\n\n### 在 Auth0 上创建应用 {#auth0}\n\n请参考以下步骤在 Auth0 上设置一个 Regular Web Application：\n\n1. 访问 [Auth0](https:\/\/auth0.com\/) 并注册一个免费账户。\n2. 创建一个新的应用，并选择常规 Web 应用程序。\n3. 在应用设置中，记录或设置以下字段：\n   - **Domain** ：\u0060{DOMAIN}\u0060\n   - **Client ID**：\u0060{CLIENT_ID}\u0060\n   - **Client Secret**：\u0060{CLIENT_SECRET}\u0060\n   - **Allowed Callback URLs**：\u0060https:\/\/www.example.com\/oauth2\/myapp\/callback\u0060\n   - **Allowed Logout URLs**：\u0060https:\/\/www.example.com\/myapp\/logout\u0060\n\n记住上面的 Auth0 字段，我们将用它们来配置 Envoy Gateway 的安全策略。\n\n{{\u003ccallout note 提示\u003e}}\n这里的 Logout URL 不起实际作用，应为在我们的下面示例中的 backend 服务并没有实现 Auth0 的 logout 接口。我们只是按照习惯在此添加该字段，以待未来实现。\n{{\u003c\/callout\u003e}}\n\n下面展示的是 Auth0 的配置页面截图，在设置好用户后并创建普通 Web 应用后，你只需要配置这两个地方。\n\n![Auth0 配置页面 1](auth0-1.webp)\n\n![Auth0 配置页面 2](auth0-2.webp)\n\n以上就是 Auth0 的全部配置，接下来我们将安装和配置 Envoy Gateway。\n\n### 安装 Envoy Gateway {#install-envoy-gateway}\n\n参考 [Envoy Gateway 快速开始](\/blog\/envoy-gateway-introduction\/#envoy-gateway-quick-start)在 minikube 上安装 Envoy Gateway：\n\n\u0060\u0060\u0060bash\nminikube start --driver=docker --cpus=2 --memory=2g\nhelm install eg oci:\/\/docker.io\/envoyproxy\/gateway-helm --version v1.0.1 -n envoy-gateway-system --create-namespace\nkubectl apply -f https:\/\/github.com\/envoyproxy\/gateway\/releases\/download\/v1.0.1\/quickstart.yaml -n default\n\u0060\u0060\u0060\n\n参考安全网关，为 Envoy Gateway 配置 TLS：\n\n\u0060\u0060\u0060bash\n# 创建根证书和私钥来签署证书\nopenssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj \u0027\/O=example Inc.\/CN=example.com\u0027 -keyout example.com.key -out example.com.crt\n\n# 为 www.example.com 创建证书和私钥\nopenssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj \u0022\/CN=www.example.com\/O=example organization\u0022\nopenssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in www.example.com.csr -out www.example.com.crt\n\n# 将证书\/密钥存储在 Secret 中\nkubectl create secret tls example-cert --key=www.example.com.key --cert=www.example.com.crt\n\u0060\u0060\u0060\n\n更新快速开始中创建的网关，使其包含 \u0060443\u0060 端口并引用 \u0060example-cert\u0060 Secret 的 HTTPS Listener：\n\n\u0060\u0060\u0060bash\necho \u0027[\n  {\n    \u0022op\u0022: \u0022add\u0022,\n    \u0022path\u0022: \u0022\/spec\/listeners\/-\u0022,\n    \u0022value\u0022: {\n      \u0022name\u0022: \u0022https\u0022,\n      \u0022protocol\u0022: \u0022HTTPS\u0022,\n      \u0022port\u0022: 443,\n      \u0022tls\u0022: {\n        \u0022mode\u0022: \u0022Terminate\u0022,\n        \u0022certificateRefs\u0022: [\n          {\n            \u0022kind\u0022: \u0022Secret\u0022,\n            \u0022group\u0022: \u0022\u0022,\n            \u0022name\u0022: \u0022example-cert\u0022\n          }\n        ]\n      }\n    }\n  }\n]\u0027 | kubectl patch gateway eg --type=json --patch-file \/dev\/stdin\n\u0060\u0060\u0060\n\n创建 HTTPRoute，为 \u0060\/myapp\u0060 端点增加一条到\u0060backend\u0060 服务的路由：\n\n\u0060\u0060\u0060bash\ncat \u003c\u003cEOF | kubectl apply -f -\napiVersion: gateway.networking.k8s.io\/v1\nkind: HTTPRoute\nmetadata:\n  name: myapp\nspec:\n  parentRefs:\n  - name: eg\n  hostnames: [\u0022www.example.com\u0022]\n  rules:\n  - matches:\n    - path:\n        type: PathPrefix\n        value: \/myapp\n    backendRefs:\n    - name: backend\n      port: 3000\nEOF\n\u0060\u0060\u0060\n\n### 配置 Envoy Gateway 的 OIDC 认证 {#envoy-gateway-oidc}\n\n创建一个 Kubernetes Secret，用于存储 OAuth Client 的 Client Secret：\n\n\u0060\u0060\u0060bash\nkubectl create secret generic auth0-client-secret --from-literal=client-secret=${CLIENT_SECRET}\n\u0060\u0060\u0060\n\n{{\u003ccallout note 注意\u003e}}\n将 \u0060${CLIENT_SECRET}\u0060 替换成你的 Auth0 Client Secret。\n{{\u003c\/callout\u003e}}\n\n创建一个安全策略（SecurityPolicy）：\n\n\u0060\u0060\u0060bash\ncat \u003c\u003cEOF | kubectl apply -f -\napiVersion: gateway.envoyproxy.io\/v1alpha1\nkind: SecurityPolicy\nmetadata:\n  name: oidc-example\nspec:\n  targetRef:\n    group: gateway.networking.k8s.io\n    kind: Gateway\n    name: eg\n  oidc:\n    provider:\n      issuer: \u0022https:\/\/${DOMAIN}\u0022\n    clientID: \u0022${CLIENT_ID}\u0022\n    clientSecret:\n      name: \u0022auth0-client-secret\u0022\n    redirectURL: \u0022https:\/\/www.example.com\/myapp\/oauth2\/callback\u0022\n    logoutPath: \u0022\/myapp\/logout\u0022\nEOF\n\u0060\u0060\u0060\n\n**注意事项**\n\n- 此处的 \u0060issuer\u0060 应该填写成 Auth0 Domain。\n- \u0060redirectURL\u0060 的值需要出现在 Auth0 配置的 Allowed Callback URLs 中。\n- \u0060logoutPath\u0060 是必须的，即使其 URL 端点并为实现 logout 逻辑。\n\n在这个示例中我们为 Envoy Gateway 网关设置了 OIDC，修改 \u0060targetRef\u0060 到 HTTPRoute，也可以为单个路由设置 OIDC。关于 ODIC 的具体配置，请参考 Envoy Gateway API 文档。\n\n### 验证单点登录：登入 {#login}\n\n将 \u0060www.example.com\u0060 添加到本地的 \u0060\/etc\/hosts\u0060 文件中：\n\n\u0060\u0060\u0060bash\necho \u0022127.0.0.1 www.example.com\u0022 | sudo tee -a \/etc\/hosts\n\u0060\u0060\u0060\n\n配置应用程序的端口转发，以便你可以在本地通过域名访问示例应用：\n\n\u0060\u0060\u0060bash\nexport ENVOY_SERVICE=$(kubectl get svc -n envoy-gateway-system --selector=gateway.envoyproxy.io\/owning-gateway-namespace=default,gateway.envoyproxy.io\/owning-gateway-name=eg -o jsonpath=\u0027{.items[0].metadata.name}\u0027)\n\nsudo kubectl -n envoy-gateway-system port-forward service\/${ENVOY_SERVICE} 443:443\n\u0060\u0060\u0060\n\n现在在浏览器中访问 \u003chttps:\/\/www.example.com\u003e，跳过证书风险提示，页面将跳转到 Auth0 的登录界面，如下图所示，选择使用 Google 账户登录。\n\n![登录界面](login.webp)\n\n在登录完成后，浏览器将跳转会 \u003chttps:\/\/www.example.com\u003e 页面，并展示 HTTP 请求结果，如下面的 JSON 代码所示。\n\n\u0060\u0060\u0060json\n{\n  \u0022path\u0022: \u0022\/\u0022,\n  \u0022host\u0022: \u0022www.example.com\u0022,\n  \u0022method\u0022: \u0022GET\u0022,\n  \u0022proto\u0022: \u0022HTTP\/1.1\u0022,\n  \u0022headers\u0022: {\n    \/*Omit*\/\n    \u0022Authorization\u0022: [\n      \u0022Bearer eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ\u0022\n    ],\n    \u0022Cookie\u0022: [\n      \u0022OauthHMAC-167a6c5=RPdscXEBap0NeSIppJXoxkHt0qvMz4fNHXo2uvgDgIY=; OauthExpires-167a6c5=1716540771; BearerToken-167a6c5=eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ; IdToken-167a6c5=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFKWkxWbnNrai0tYmhsNlJzVm51OCJ9.eyJpc3MiOiJodHRwczovL2Rldi1hd2hqbXkzOGdnNXF6eDd1LnVzLmF1dGgwLmNvbS8iLCJhdWQiOiJUZzhlNWVoa0xKM2hka3cxTzREMTBQd21QeTcxZHZtdiIsImlhdCI6MTcxNjQ1NDM3MSwiZXhwIjoxNzE2NDkwMzcxLCJzdWIiOiJnb29nbGUtb2F1dGgyfDExMjc0NDc3OTAyMjMzMTA0ODY0MCIsInNpZCI6IjRlSjhDZnZuZjd5Mm1kaE94QXBTY0JiUEhjOS1rZUVLIn0.r9dwIy_HeiO5_I3UlohLkeRES5FGoxqQnwmcA00cA_kdc5mUxgeVopXIhBUjJnTKv7bOUVJvFw21ew4gqVRJfllDyG-s_XfhSW1-lEXmCc2bGYDtOzva6k2S_VRgyMKfG04_DWFuTgO_pLtix28aYq8cGzKJ_VglT_KgRhoktzJu4Js5iCv9JPnydRJmpvRJwX3tDv_Q3mmUSazaLkhOTdiBJFrGlS07qEzJ_iWANZgR8uDNhpXdmlcqpb3MZkkMulr5-jXIgEhBQKpw28tUiSlzh6EpAVuBH9T1w8bUmFRzCc6JPPamJRfflYW5onNgYHDfcU0RpvpsCHRHRAZbdA\u0022\n    ],\n    \/*Omit*\/\n    \u0022User-Agent\u0022: [\n      \u0022Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/125.0.0.0 Safari\/537.36\u0022\n    ],\n    \u0022X-Envoy-Internal\u0022: [\n      \u0022true\u0022\n    ],\n    \u0022X-Forwarded-For\u0022: [\n      \u002210.244.0.51\u0022\n    ],\n    \u0022X-Forwarded-Proto\u0022: [\n      \u0022https\u0022\n    ],\n    \u0022X-Request-Id\u0022: [\n      \u0022c1e64057-c5c8-4fb2-a304-25c291eeed32\u0022\n    ]\n  },\n  \u0022namespace\u0022: \u0022default\u0022,\n  \u0022ingress\u0022: \u0022\u0022,\n  \u0022service\u0022: \u0022\u0022,\n  \u0022pod\u0022: \u0022backend-55d64d8794-4qvgd\u0022\n}\n\u0060\u0060\u0060\n\n此时通过 Chrome 浏览器的  *Inspector - Application - Cookies* 查看到 ID Token 如下图所示：\n\n![在 Chrome Inspector 中查看 ID Token](inspector.webp)\n\n编写代码 Python 代码，\u0060validate_id_token.py\u0060，解析 ID Token 并验证其有效性：\n\n{{\u003c include_code file=\u0022validate_id_token.py\u0022 \u003e}}\n\n安装依赖的包：\n\n\u0060\u0060\u0060bash\npip install pyjwt requests\n\u0060\u0060\u0060\n\n运行代码：\n\n\u0060\u0060\u0060bash\npython validate_id_token.py ${ID_TOKEN}\n\u0060\u0060\u0060\n\n你将看到类似下面的输出：\n\n\u0060\u0060\u0060ini\nToken is valid. Decoded payload:\niss: https:\/\/dev-awhjmy38gg5qzx7u.us.auth0.com\/\naud: Tg8e5ehkLJ3hdkw1O4D10PwmPy71dvmv\niat: 1716470905\nexp: 1716506905\nsub: google-oauth2|112744779022331048640\nsid: 4W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N\n\u0060\u0060\u0060\n\n通过该 ID Token 的值可以得出：\n\n- 该令牌由 Auth0 签发（\u0060iss\u0060 字段）。\n- 该令牌的受众是特定的应用或 API（\u0060aud\u0060 字段），对于 Auth0，这个值是 Client ID。\n- 令牌是在 2024 年 5 月 23 日 04:08:25 UTC 签发的（\u0060iat\u0060 字段），并将在 2024 年 5 月 23 日 14:08:25 UTC 过期（\u0060exp\u0060 字段）。\n- 令牌所代表的主体（用户）的唯一标识符是 \u0060google-oauth2|112744779022331048640\u0060（\u0060sub\u0060 字段）。在这里，这个标识符表明使用 Google OAuth2 登录的用户\n- 会话 ID 是 \u00604W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N\u0060（\u0060sid\u0060 字段），用于会话管理。\n\n### 验证单点登录：登出 {#logout}\n\n由于我们的示例应用中没有实现 Auth0 的 Logout 逻辑，所以我们需要通过 HTTP 请求明确告知 Auth0 要 logout，在浏览器中访问该 URL：\n\n\u0060\u0060\u0060bash\nhttps:\/\/${DOMAIN}\/v2\/logout?client_id=${CLIENT_ID}\n\u0060\u0060\u0060\n\n请将 \u0060${DOMAIN}\u0060 和 \u0060${CLIENT_ID\u0060 修改为你的 Auth0 应用程序的[配置项](#auth0)。关于 Auth0 如何登出 OIDC 端点的详细说明请查看 [Auth0 文档](https:\/\/auth0.com\/docs\/api\/authentication#logout)。\n\n登出后，页面将再次跳转到登录页面，在登录后，页面将重定向到 \u003chttps:\/\/www.example.com\u003e。\n\n## 总结 {#summary}\n\n通过以上步骤，你可以在 Envoy Gateway 中实现 OIDC 认证，确保 API 的安全性。这种方法不仅能提供灵活的身份验证机制，还能简化应用程序的身份管理。通过集成 Auth0 等身份提供商，Envoy Gateway 可以轻松实现单点登录，提升用户体验和系统安全性。未来，你可以根据需求进一步配置和优化 Envoy Gateway，充分利用其强大的认证和授权功能，以满足更复杂的安全要求和业务需求。\n\n## 参考 {#reference}\n\n- Envoy Gateway OIDC Authentication - gateway.envoyproxy.io\n- [Log Users Out of Auth0 with OIDC Endpoint - auth0.com](https:\/\/auth0.com\/docs\/authenticate\/login\/logout\/log-users-out-of-auth0)\n', '\/blog\/envoy-gateway-oidc\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-introduction/">Envoy Gateway 概述——使用 Gateway API 的现代 Kubernetes 入口</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/05/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy Gateway 概述——使用 Gateway API 的现代 Kubernetes 入口', '本文将探讨 Envoy Gateway 在 Kubernetes 上部署的优势，及其它与服务网格的关系，展示为何它是暴露服务到公网的理想选择。', '\n在 Kubernetes 环境下选择正确的网络通信工具至关重要。根据[Tetrate 的讨论](https:\/\/tetrate.io\/blog\/do-i-need-a-gateway-or-a-service-mesh\/)，选择取决于网络通信的类型：南北向流量还是东西向流量。对于主要处理外部请求的服务，Envoy Gateway 是理想选择，它不仅高效管理流量，还能在你向微服务架构过渡时提供无缝集成。\n\n本文将探讨 Envoy Gateway 在 Kubernetes 上部署的优势，及其它与服务网格的关系，展示为何它是暴露服务到公网的理想选择。\n\n## Envoy Gateway 及其在服务网格中的角色概述 {#overview}\n\nEnvoy Gateway 是一个围绕 Envoy Proxy 构建的 Kubernetes 原生 API 网关，它旨在降低用户采用 Envoy 作为 API 网关的难度，并为供应商建立 API 网关（例如 [Tetrate Enterprise Gateway for Envoy](https:\/\/tetrate.io\/tetrate-enterprise-gateway-for-envoy\/)）增值产品奠定基础。\n\nEnvoy Gateway 不仅是管理南北流量的理想选择，也可作为连接和保护服务网格中服务的关键组件。它还通过提供安全的数据传输、流量路由、负均衡及故障恢复等功能，增强了微服务之间的通信效率和安全性。Envoy Gateway 利用其内置的 Envoy Proxy 技术，可以处理大量的并发连接和复杂的流量管理策略，同时保持较低的延迟和高吞吐量。\n\n此外，Envoy Gateway 与 Kubernetes Gateway API 的紧密集成使得它能够以声明式的方式进行配置和管理，极大简化了服务网格中网关的部署和更新过程。这种集成不仅提升了操作效率，还使得 Envoy Gateway 能够在不增加额外复杂性的前提下，与服务网格如 Istio 这样的解决方案无缝协作。\n\n下图展示了 Envoy Gateway 与服务网格的关系。\n\n\u0060\u0060\u0060mermaid \u0022Envoy Gateway 与服务网格的关系\u0022\ngraph TB\n    subgraph Kubernetes[\u0022Kubernetes 集群\u0022]\n        eg[\u0022Envoy Gateway\u0022]\n        svcs[\u0022服务\u0022]\n        pods[\u0022Pod\u0022]\n        gwapi[\u0022Kubernetes Gateway API\u0022]\n        eg -- \u0022管理南北向流量\u0022 --\u003e svcs\n        eg -- \u0022由...配置\u0022 --\u003e gwapi\n        gwapi -. \u0022定义路由规格\u0022 .-\u003e svcs\n    end\n\n    subgraph SM[\u0022服务网格\u0022]\n        smc[\u0022服务网格控制平面（如 Istio、Linkerd）\u0022]\n        smp[\u0022服务网格数据平面（Envoy Sidecars）\u0022]\n        smc -- \u0022配置\u0022 --\u003e smp\n        smp -- \u0022处理东西向流量\u0022 --\u003e pods\n    end\n\n    eg -.-\u003e smp\n    svcs -. \u0022是...的一部分\u0022 .-\u003e SM\n    svcs -- \u0022连接到\u0022 --\u003e pods\n\u0060\u0060\u0060\n\n![Envoy Gateway 与服务网格的关系](8691fed7a410e3a8f45252cc5c8e11db.svg)\n\n在 Kubernetes 集群中，Envoy Gateway 负责管理南北向流量，即进出集群的流量，并通过 Kubernetes Gateway API 进行配置，后者定义了服务的路由规格。集群内服务直接连接到 Pods。服务网格部分，由控制平面（如 Istio 或 Linkerd）配置数据平面中的 Envoy Sidecars，这些 Sidecars 负责处理集群内部的东西向流量。在这个系统中，Envoy Gateway 可以与服务网格相互协作，但它们各自独立地管理不同方向的流量。\n\n设想一下，Envoy Gateway 像是一个城市的主要入口（比如海关），所有的数据流，就像各种车辆，都得通过这个大门进出。它就像一个严格的守门员，负责审查、指导，确保每个数据包，就像每个乘客，都能被准确地送到目的地。在 Kubernetes 这座城市中，Envoy Gateway 管理着所有进城的流量，它确保数据流可以安全、高效地进入城市，并被准确地送达给城市内部的服务。\n\n进入城市之后，服务网格就接管了，这就像城市内部的一系列交通网络。服务网格中的 Envoy sidecars 就好比是这座城市内部的出租车或者公交车，负责把数据包从海带到它们在城市内部的具体目的地。Envoy Gateway 负责将外部请求顺利引入，之后服务网格负责在集群内部继续高效地处理这些请求。\n\nEnvoy Gateway 对 Kubernetes Gateway API 的支持，可以看作是对我们城市交通信号系统的一个重大升级。这不仅为进入城市的数据流提供了更加清晰和个性化的指引，而且让整个城市的交通运行更加智能化。\n\n## Envoy Gateway 的核心功能和优势 {#pros}\n\nEnvoy Gateway 提供了几个核心功能，使其成为 API 网关的突出选择：\n\n- **简化配置**：通过与 Kubernetes Gateway API 直接集成，Envoy Gateway 允许开发者使用 Kubernetes 自定义资源以声明方式配置路由规则、安全策略和流量管理。\n- **性能和可扩展性**：基于经过实战测试的 Envoy Proxy，它提供卓越的性能和可扩展性，轻松处理数千个服务和每秒数百万个请求。\n- **安全功能**：内置支持各种安全措施，如 SSL\/TLS 终止、OAuth2、OIDC 认证以及细粒度访问控制。\n- **可观测性**：提供全面的监控能力，包括详细的度量、日志和追踪，这对于诊断和理解流量行为至关重要。\n\n## 与 Gateway API 的关系 {#gateway-api}\n\n在 Kubernetes 环境中引入的 Gateway API 为集成和配置 Ingress 网关提供了一种新的强大方法，它与传统的 Ingress 相比具有更高的灵活性和功能性。正如我在 [Gateway API：Kubernetes 和服务网格入口中网关的未来](\/blog\/why-gateway-api-is-the-future-of-ingress-and-mesh\/) 中所讨论的，Gateway API 通过区分角色和提供跨命名空间支持，更适应多云环境，且已被多数 API 网关采用。这种 API 设计支持了 ingress 网关（南北向流量）与服务网格（东西向流量，跨集群路由）的融合，使得 Envoy Gateway 成为 Kubernetes 和服务网格中统一未来的网关解决方案。通过引入 Gateway API，Envoy Gateway 强化了其作为云原生环境中前沿代理的角色，使得用户能够更灵活地管理其流量和策略。\n\nKubernetes Gateway API 是 Envoy Gateway 的基石，它提供了一种更具表达性、灵活性和以角色为导向的方式来配置 Kubernetes 生态系统中的网关和路由。该 API 提供了如 GatewayClass、Gateway、HTTPRoute 等自定义资源定义（CRD），Envoy Gateway 利用这些资源创建用户友好且一致的配置模型，与 Kubernetes 的原生原则保持一致。\n\n{{\u003ccallout note \u0022什么是 API Gateway？\u0022\u003e}}\n\nAPI Gateway 是对 API 的全面管理和托管服务。它作为应用程序与后端服务之间的中间层，不仅处理创建、维护、发布、运行和下线等生命周期事件，还承担着更多关键职能。一个完善的 API Gateway 应该提供以下功能来丰富和扩展其基本定义：\n\n1. **流量控制**：API Gateway 应能够处理并控制到后端服务的流量，包括请求路由、负载均衡、熔断机制以及速率限制，以保证后端服务的稳定性和高可用性。\n2. **安全性保障**：应具备鉴权、授权和加密功能，能够有效地管理和保护 API 的安全。这涉及到身份验证机制、API 密钥管理、OAuth、JWT、mTLS 等，以确保只有授权的用户和服务能够访问 API。\n3. **监控和分析**：提供实时监控和日志记录功能，能够跟踪 API 的使用情况、性能指标、异常检测和分析流量模式，从而优化 API 的性能和响应能力。\n4. **变更管理**：支持对 API 变更进行管理，包括版本控制和渐进式部署（如蓝绿部署或金丝雀发布），以无缝过渡新版本且最小化对最终用户的影响。\n5. **请求和响应的转换**：允许对传入和传出的 API 调用进行转换，比如从 REST 到 GraphQL 的转换，或是添加、删除和修改请求头和响应头。\n6. **跨域资源共享（CORS）支持**：管理和控制跨域请求，允许不同域的前端应用安全地调用后端 API。\n7. **配额和计费**：为 API 使用设定配额限制，同时支持计费功能，以适用于商业化的 API 提供。\n8. **用户友好的开发者门户**：提供一个面向开发者的门户，使得第三方开发者可以轻松地发现、测试和集成 API。\n9. **协议支持**：支持各种网络协议，包括 HTTP\/HTTPS、WebSocket、gRPC 等，确保与多种客户端和服务的兼容性。\n10. **插件化和扩展性**：允许通过插件或中间件来扩展 API Gateway 的功能，使其可以根据业务需求灵活适配各种中间件服务。\n11. **服务治理**：集成服务注册和发现机制，以适应微服务架构下服务的动态性。\n\n综上所述，API Gateway 的角色远远超越了简单的 API 生命周期管理。它是实现微服务架构、确保服务安全性、提高运维效率和优化用户体验的关键组件。通过这些广泛的功能，API Gateway 成为现代云原生应用不可或缺的一部分。\n\n{{\u003c\/callout\u003e}}\n\n## Envoy Gateway 架构概览 {#arch}\n\nEnvoy Gateway 的架构设计旨在轻量级和简洁。它包括一个动态配置运行作为数据平面的 Envoy 代理的控制平面。这种关注点的分离确保了网关可以随着流量的增长而扩展，而不影响控制平面的效率。\n\nEnvoy Gateway 的架构图如下所示。\n\n![Envoy Gateway 架构图](envoy-gateway-arch.svg)\n\n在这个架构图的核心是 Envoy Gateway，它是 Envoy 代理的执行实例，负责处理从 Kubernetes 集群进出的所有流量。初始启动时，Envoy Gateway 通过配置文件提供静态配置，建立其操作的基本参数。\n\nEnvoy Gateway 配置的动态方面由提供者处理，该提供者定义了网关与 Kubernetes 或其他动态配置输入源的交互。资源监视器负责监视 Kubernetes 资源的更改，特别关注与自定义资源定义（CRD）相关的 CRUD 操作。\n\n随着更改的发生，资源转换器介入将这些外部资源转换为 Envoy Gateway 可以理解的形式。这一转换过程进一步由特定于提供者的基础设施管理器促进，后者负责管理与特定云或基础设施提供商相关的资源，塑造中间表示形式的基础设施，这对于网关的功能至关重要。\n\n然后，该中间表示形式转变为 xDS 中间表示形式，作为 Envoy 理解和执行的最终 xDS 配置的先导。xDS 翻译器承担将这种中间表示形式转换为具体的 xDS 配置的角色。\n\n这些配置由 xDS 服务器交付并执行，该服务器作为服务，根据其收到的 xDS 配置，认真管理 Envoy 实例。Envoy 作为实际运行的代理，最终从 xDS 服务器接收这些配置，解释并实现它们以有效管理流量请求。\n\n最终，所有请求经过 Envoy 的处理后被重定向到了 Envoy Gateway 路由的流量的最终目的地，也就是后端服务。\n\n## 与其他网关的比较 {#comparations}\n\n与 Istio 的入口网关或 NGINX Ingress 等其他流行解决方案相比，Envoy Gateway 凭借其与 Kubernetes 的原生集成以及利用 Envoy 全部潜力的专注，而脱颖而出。下图从多方面对比了目前流行的一些开源的 API 网关。\n\n{{\u003ctable \u0022开源 API 网关对比\u0022\u003e}}\n| API 网关      | 支持的认证和授权策略                                         | 支持的服务发现组件                     | 支持的协议                       | 控制平面配置分发方法 | 支持的插件扩展机制   | 组织隶属               |\n| ------------- | ------------------------------------------------------------ | -------------------------------------- | -------------------------------- | -------------------- | -------------------- | -------------------------- |\n| Envoy Gateway | OAuth2, JWT, mTLS, OIDC                                      | Kubernetes, EDS                        | HTTP, HTTPS, gRPC                | xDS                  | 基于 Envoy Filter | CNCF                       |\n| Kuma          | mTLS, JWT                                                    | Kubernetes, Consul                     | HTTP, HTTPS, gRPC, TCP           | REST, gRPC           | 基于 Lua, Go       | CNCF                       |\n| NGINX Ingress | RBAC                                                         | Kubernetes                             | HTTP, HTTPS, TCP, UDP            | Kubernetes CRD       | 基于 Nginx 模块    | N\/A                        |\n| APISIX        | OAuth2, JWT, Key Auth, Basic Auth, mTLS, OIDC, LDAP, OpenID 等 | Kubernetes, DNS, Consul, Nacos, Eureka | HTTP, HTTPS, TCP, UDP, WebSocket | REST, CLI, Web UI    | 基于 Lua, Wasm    | Apache Software Foundation |\n| Kong          | OAuth2, JWT, Basic Auth, Key Auth                            | Kubernetes, DNS, Consul                | HTTP, HTTPS, gRPC, WebSocket     | REST, gRPC, Web UI   | 基于 Lua          | N\/A                        |\n| Emissary      | Basic Auth                                                   | Kubernetes                             | HTTP, HTTPS, gRPC                | Kubernetes CRD       | 基于 Lua, Go      | CNCF                       |\n{{\u003c\/table\u003e}}\n\n## 快速开始使用 Envoy Gateway {#envoy-gateway-quick-start}\n\n要快速上手 Envoy Gateway，你可以通过以下简化步骤快速搭建一个本地实验环境。首先，启动一个本地 Kubernetes 集群：\n\n\u0060\u0060\u0060bash\nminikube start --driver=docker --cpus=2 --memory=2g\n\u0060\u0060\u0060\n\n接下来，部署 Gateway API CRD 和 Envoy Gateway 本身：\n\n\u0060\u0060\u0060bash\nhelm install eg oci:\/\/docker.io\/envoyproxy\/gateway-helm --version v1.0.1 -n envoy-gateway-system --create-namespace\n\u0060\u0060\u0060\n\n然后，安装网关配置并部署一个示例应用：\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/github.com\/envoyproxy\/gateway\/releases\/download\/v1.0.1\/quickstart.yaml -n default\n\u0060\u0060\u0060\n\n为了暴露 LoadBalancer 服务，这里我们使用端口转发作为示例。你也可以选择使用 \u0060minikube tunnel\u0060 或安装 [MetalLB](https:\/\/metallb.universe.tf\/installation\/) 作为负载均衡器：\n\n\u0060\u0060\u0060bash\nexport ENVOY_SERVICE=$(kubectl get svc -n envoy-gateway-system --selector=gateway.envoyproxy.io\/owning-gateway-namespace=default,gateway.envoyproxy.io\/owning-gateway-name=eg -o jsonpath=\u0027{.items[0].metadata.name}\u0027)\nkubectl -n envoy-gateway-system port-forward service\/${ENVOY_SERVICE} 8888:80 \u0026\n\u0060\u0060\u0060\n\n通过以下命令测试你的 Envoy Gateway 是否正常工作：\n\n\u0060\u0060\u0060bash\ncurl --verbose --header \u0022Host: www.example.com\u0022 http:\/\/localhost:8888\/get\n\u0060\u0060\u0060\n\n想了解更多详细的安装和配置步骤，请访问 Envoy Gateway 网站。通过这些步骤，你可以快速开始探索 Envoy Gateway 的功能。\n\n## 总结 {#summary}\n\nEnvoy Gateway 不仅优化了云原生时代的七层网关配置，而且为从边缘网关向服务网格过渡提供了一个平滑的道路。由于服务网格的推广面临一些挑战，如对应用的侵入性和运维团队推动问题，边缘网关则更易于被开发团队接受。Envoy Gateway 采用简化的 Kubernetes Gateway API，提高了流量管理和可观测性的能力。此外，Envoy Gateway 到 Istio 的过渡对于已熟悉 Envoy 功能的团队来说，将是一个自信的技术进步，同时还支持从标准的 Kubernetes Gateway API 到 Istio Ingress Gateway 的无缝切换，或者作为一个定制解决方案继续与 Istio 协作。这些特点使得 Envoy Gateway 成为一个在云原生时代值得投资的网关选择。\n\n请继续关注本系列博客的后续部分，我们将深入探讨如何配置和优化 Envoy Gateway，提供实用指南并展示更广泛的实际应用案例。\n', '\/blog\/envoy-gateway-introduction\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文将探讨 Envoy Gateway 在 Kubernetes 上部署的优势，及其它与服务网格的关系，展示为何它是暴露服务到公网的理想选择。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-customization/">Envoy Gateway 0.4.0 发布：自定义 API 扩展</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/05/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy Gateway 0.4.0 发布：自定义 API 扩展', 'Envoy Gateway 是一款基于 Envoy 代理和 Kubernetes Gateway API 开发的开源 API 网关，最近发布了 0.4.0 版本。此次发布的版本着重于自定义功能，旨在为最终用户提供更多的用例。在本文中，我们将讨论此版本中可用的新自定义选项及其对用户的重要性。', '\n[Envoy Gateway](https:\/\/github.com\/envoyproxy\/gateway) 是一款基于 Envoy 代理和 [Kubernetes Gateway API](https:\/\/gateway-api.sigs.k8s.io\/) 开发的开源 API 网关，最近发布了 0.4.0 版本。此次发布的版本着重于自定义功能，旨在为最终用户提供更多的用例。在本文中，我们将讨论此版本中可用的新自定义选项及其对用户的重要性。\n\n## 自定义 Envoy 代理架构 {#customization}\n\n此次版本中最主要的自定义功能之一是配置 EnvoyProxy（Envoy Gateway 定义的 CRD）部署的确切类型。你可以定义 EnvoyProxy 部署的副本数、镜像和资源限制。还可以向 EnvoyProxy 部署和服务添加注解（Annotation）。这使得不同的用例成为可能，例如：\n\n- 将 Envoy Gateway 与 AWS、NLB、ELB 和 GCP 等外部负载均衡器链接起来。\n- 在 EnvoyProxy 旁边注入 Sidecar，这对于 Ingress 层管理南北向流量的 Envoy Gateway 和服务网格层用于管理东西向流量互联 TLS（mTLS）的 Envoy Sidecar 非常有用。此自定义功能消除了用户创建自己证书的需要，因为它基于历史的证书管理。\n\n{{\u003ccallout note 注意\u003e}}\n关于 Envoy Gateway 的更多自定义功能请参考 Envoy Gateway 文档。\n{{\u003c\/callout\u003e}}\n\n此外，Envoy Gateway 除了默认的 Kubernetes 单租户模式以外还新增其他部署模式支持，例如多租户，如下图所示。\n\n![Envoy Gateway 的多租户模式示意图](eg-multi-tenancy.svg)\n\n分别在每个租户的 namespace 部署一个 Envoy Gateway Controller，它们监视 Kubernetes 中的 HTTPRoute 和 Service 资源，并在各自的 namespace 中创建和管理 EnvoyProxy 部署。\n\n## 自定义 Envoy xDS 引导程序 {#bootstrap}\n\n此版本中的另一个重要自定义功能是自定义 Envoy xDS 引导程序。使用此功能，用户可以提供引导配置，在启动 EnvoyProxy 时配置一些静态资源。例如配置访问日志记录、跟踪和指标以发送到 SkyWalking（可以作为 APM）非常有用。此外，此版本添加了大量 CLI 工具，以帮助验证用户配置。用户可以将 CLI 用作干运行以更改引导程序中的特定字段，如果配置在语法上不正确，则将失败。\n\n## 扩展控制平面 {#extend-control-plane}\n\nEnvoy Gateway 现在允许供应商和扩展开发人员在 Envoy Gateway 管道的不同阶段添加 gRPC 钩子，以进一步扩展其功能，允许用户做一些事情，比如增强发送给 EnvoyProxy 的 xDS 配置，这在以前是不可能的。\n\n## 总结 {#summary}\n\n最后，Envoy Gateway 0.4.0 扩展了自定义 API，并为最终用户提供了更多用例。新的自定义功能包括自定义 Envoy 部署、Envoy xDS 引导程序以及扩展控制平面。这些新功能消除了用户创建自己的证书的需要，配置访问日志记录、跟踪和指标，并使供应商能够扩展 XDS 翻译用例。通过此版本的发布，Envoy Gateway 正变得更加用户友好，成为 Istio 的绝佳替代品。\n', '\/blog\/envoy-gateway-customization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Envoy Gateway 是一款基于 Envoy 代理和 Kubernetes Gateway API 开发的开源 API 网关，最近发布了 0.4.0 版本。此次发布的版本着重于自定义功能，旨在为最终用户提供更多的用例。在本文中，我们将讨论此版本中可用的新自定义选项及其对用户的重要性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/why-gateway-api-is-the-future-of-ingress-and-mesh/">Gateway API：Kubernetes 和服务网格入口中网关的未来</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/11/02</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/kubernetes"> 
             Kubernetes
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Gateway API：Kubernetes 和服务网格入口中网关的未来', '本文介绍 Kubernetes 中的入口网关及 Gateway API，入口网关与服务网格融合的新趋势。', '\n本文将以 Kubernetes Ingress、Istio 和 Envoy Gateway 为例，向你介绍 Kubernetes 中的入口网关和 Gateway API，同时介绍 Gateway API 使得 Kubernetes 和服务网格入口网关融合的新趋势。\n\n## 本文观点\n\n- Ingress 作为 Kubernetes 的初代入口网关，它的资源模型过于简单以致于无法适应当今的可编程网络；\n- Gateway API 作为 Kubernetes 入口网关的最新成果，它通过角色划分将关注点分离，并提供跨 namespace 支持使其更适应多云环境，已获得大多数 API 网关的支持；\n- 入口网关（南北向）与服务网格（东西向，集群内路由）存在部分功能重叠，Gateway API 为两者的融合提供了新的参考模型；\n\n## Kubernetes 入口网关的历史\n\n2014 年 6 月 Kubernetes 开源，起初只能使用 NodePort 和 LoadBalancer 类型的 Service 对象来暴露集群内服务，后来才诞生了 [Ingress](https:\/\/kubernetes.io\/zh-cn\/docs\/concepts\/services-networking\/ingress\/)，两年后（Kubernetes 1.2）Ingress API 进入 Beta 版本，随后为了保持其轻量和可移植的特性，Ingress API 相较于 Kubernetes 其他 API 发展得比较缓慢，直到 Kubernetes 1.19 它才升级到 GA。\n\nIngress 的主要目标是用简单的、声明性的语法来暴露 HTTP 应用。你可以在 Kubernetes 中部署多种 Ingress Controller，并在创建 Ingress 的时候通过 IngressClass 指定该网关使用的控制器，或者在 Kubernetes 中设置默认的默认的 IngressClass。Kubernetes 默认只支持 AWS、GCE 和 Nginx Ingress Controller，同时还支持大量的[第三方 Ingress Controller](https:\/\/kubernetes.io\/docs\/concepts\/services-networking\/ingress-controllers\/#additional-controllers)。\n\n下图展示了 Kubernetes Ingress 的工作流程。\n\n![Kubernetes Ingress 工作流程](ingress-flow.svg)\n\n详细流程如下：\n\n1. Kubernetes 集群管理员在 Kubernetes 中部署 Ingress Controller；\n2. Ingress Controller 会持续监视 Kubernetes  API Server 中的 IngressClass 和 Ingress 对象的变动；\n3. 管理员应用 IngressClass 和 Ingress 来部署网关；\n4. Ingress Controller 会根据管理员的配置来创建对应的入口网关并配置路由规则；\n5. 如果在云中，客户端会访问该入口网关的负载均衡器；\n6. 网关将根据 HTTP 请求中的 host 和 path 将流量路由到对应的后端服务；\n\nIstio 同时支持 Ingress 和 Gateway API，下面是一个使用 Istio 入口网关的配置示例，在后文中会使用 Gateway API 创建该配置。\n\n\u0060\u0060\u0060yaml\napiVersion: networking.k8s.io\/v1\nkind: IngressClass\nmetadata:\n  name: istio\nspec:\n  controller: istio.io\/ingress-controller\n---\napiVersion: networking.k8s.io\/v1\nkind: Ingress\nmetadata:\n  name: ingress\nspec:\n  ingressClassName: istio\n  rules:\n  - host: httpbin.example.com\n    http:\n      paths:\n      - path: \/\n        pathType: Prefix\n        backend:\n          service:\n            name: httpbin\n            port: 8000\n\u0060\u0060\u0060\n\n注意：Ingress 的 spec 中必须在 \u0060ingressClassName\u0060 字段中指定使用的 \u0060IngressClass\u0060，否则将无法创建对应的入口网关。\n\n## Kubernetes Ingress 的局限性\n\n虽然 \u0060IngressClass\u0060 实现了入口网关与后台实现的解耦，但是它仍然有着巨大的局限性：\n\n- Ingress 的配置过于简单，仅支持 HTTP 协议路由；\n- HTTP 路由仅支持 host 和 path 匹配，对于高级路由功能没有通用配置，只能通过 annotation 来实现，比如[使用 Nginx Ingress Controller 实现 URL 重定向](https:\/\/help.aliyun.com\/document_detail\/86533.html#section-xsg-g5g-1uy)，需要配置 \u0060nginx.ingress.kubernetes.io\/rewrite-target\u0060 annotation，已经无法适应可编程路由的需求；\n- 不同命名空间中的服务要绑定到同一个网关中的情况在实际情况下经常出现，而入口网关无法在多个命名空间中共享；\n- 入口网关的创建和管理的职责没有划分界限，导致开发者不仅要配置网关路由，还需要自己创建和管理网关；\n\n## Kubernetes Gateway API\n\nGateway API 是一个 API 资源的集合 —— \u0060GatewayClass\u0060、\u0060Gateway\u0060、\u0060HTTPRoute\u0060、\u0060TCPRoute\u0060、\u0060ReferenceGrant\u0060 等。Gateway API 暴露了一个更通用的代理 API，可以用于更多的协议，而不仅仅是 HTTP，并为更多的基础设施组件建模，为集群运营提供更好的部署和管理选项。\n\n另外 Gateway API 通过将资源对象分离，实现配置上的解耦，可以由不同的角色的人员来管理，其中的 API 对象如下图所示。\n\n![Gateway API 及角色](gateway-api-roles.svg)\n\n下面是在 Istio 中使用 Gateway API 的示例。\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.networking.k8s.io\/v1alpha2\nkind: Gateway\nmetadata:\n  name: gateway\n  namespace: istio-ingress\nspec:\n  gatewayClassName: istio\n  listeners:\n  - name: default\n    hostname: \u0022*.example.com\u0022\n    port: 80\n    protocol: HTTP\n    allowedRoutes:\n      namespaces:\n        from: All\n---\napiVersion: gateway.networking.k8s.io\/v1alpha2\nkind: HTTPRoute\nmetadata:\n  name: http\n  namespace: default\nspec:\n  parentRefs:\n  - name: gateway\n    namespace: istio-ingress\n  hostnames: [\u0022httpbin.example.com\u0022]\n  rules:\n  - matches:\n    - path:\n        type: PathPrefix\n        value: \/\n    backendRefs:\n    - name: httpbin\n      port: 8000\n\u0060\u0060\u0060\n\n与 Ingress 类似，Gateway 使用 \u0060gatewayClassName\u0060 声明其使用的控制器，该控制器需要平台管理员创建，并允许客户端对 \u0060*.example.com\u0060 域名的请求。应用开发者可以在其服务所在的命名空间中，在此示例中是 \u0060default\u0060 创建路由规则，并通过 \u0060parentRefs\u0060 绑定到 Gateway 上，当然这必须是在 Gateway 明确允许其绑定的情况下（通过 \u0060allowRoutes\u0060 字段中的规则设置）。\n\n当你应用上面的配置后，Istio 会自动为你创建一个负载均衡网关，下图展示了 Gateway API 的工作流程。\n\n![Gateway API 工作流程](gateway-api-flow.svg)\n\n详细流程如下：\n\n1. 基础设施供应商提供了 \u0060GatewayClass\u0060 和 Gateway 控制器；\n2. 平台运维部署 Gateway（可以部署多个，或使用不同的 \u0060GatewayClass\u0060）；\n3. Gateway Controller 会持续监视 Kubernetes  API Server 中的 \u0060GatewayClass\u0060 和 \u0060Gateway\u0060 对象的变动；\n4. Gateway Controller 会根据集群运维的配置来创建对应的网关；\n5. 应用开发者应用 xRoute 并绑定服务上；\n6. 如果在云中，客户端会访问该入口网关的负载均衡器；\n7. 网关将根据流量请求中的匹配条件将路由到对应的后端服务；\n\n从以上步骤中我们可以看出 Gateway API 相比 Ingress 有了明确的角色划分，而且路由规则可以与网关配置解耦，这大大增加了管理的灵活性。\n\n下图展示了流量接入网关后经过处理的流程。\n\n![网关处理流程图](traffic-flow.svg)\n\n从图中我们可以看出路由是与网关绑定的，路由一般与其后端服务部署在同一个命名空间中，如果在不同的命名空间中时，需要在 [\u0060ReferenceGrant\u0060](https:\/\/gateway-api.sigs.k8s.io\/api-types\/referencegrant\/) 中明确赋予该路由跨命名空间的引用权限，例如下面的 \u0060foo\u0060 命名空间中的 HTTPRoute \u0060foo\u0060 可以引用 \u0060bar\u0060 命名空间中的 \u0060bar\u0060 服务。\n\n\u0060\u0060\u0060yaml\nkind: HTTPRoute\nmetadata:\n  name: foo\n  namespace: foo\nspec:\n  rules:\n  - matches:\n    - path: \/bar\n    forwardTo:\n      backend:\n      - name: bar\n        namespace: bar\n---\nkind: ReferenceGrant\nmetadata:\n  name: bar\n  namespace: bar\nspec:\n  from:\n  - group: networking.gateway.k8s.io\n    kind: HTTPRoute\n    namespace: foo\n  to:\n  - group: \u0022\u0022\n    kind: Service\n\u0060\u0060\u0060\n\n目前，Gateway API 仅支持 \u0060HTTPRoute\u0060，\u0060TCPRoute\u0060、\u0060UDPRoute\u0060、\u0060TLSRoute\u0060 和 \u0060GRCPRoute\u0060 还在实验阶段。Gateway API 已经得到了大量的网关和服务网格项目的支持，请[在 Gateway 官方文档中查看支持状况](https:\/\/gateway-api.sigs.k8s.io\/implementations\/)。\n\n## 入口网关与服务网格\n\n服务网格主要关注的是东西向流量，即 Kubernetes 集群内部的流量，但是大部分服务网格同样提供了入口网关功能，例如 Istio。但是 Istio 的功能和 API 过于复杂，在本文中我们就以 SMI 为例来说明入口网关和服务网格的关系。\n\n[SMI](https:\/\/smi-spec.io\/)（Service Mesh Interface）是 CNCF 的孵化项目，开源与 2019 年，它定义了独立于供应商的在 Kubernetes 中运行的服务网格通用标准。\n\n下图说明 Gateway API 与服务网格 API 的重叠点。\n\n![Gateway API 与 SMI 有部分重合](gateway-smi-overlay.svg)\n\n从图中我们可以看到 Gateway API 与 SMI 在流量规范部分有明显的重叠。这些重叠导致同样的功能，需要在 Gateway API 和服务网格中重复实现。\n\n### Istio 服务网格\n\n当然，并不是所有的服务网格是完全符合 SMI 标准，Istio 是目前最流行的服务网格实现，它提供了丰富的流量管理功能，但是没有对这些功能制定单独的策略 API，而是耦合在 \u0060VirtualService\u0060 和 \u0060DestinationRule\u0060 中，如下所示。\n\n**VirtualService**\n\n- 路由：金丝雀发布、基于用户身、URI、Header 等匹配路由等；\n- 错误注入：HTTP 错误代码注入、HTTP 延时注入；\n- 流量切分：基于百分比的流量切分路由；\n- 流量镜像：将一定百分比的流量镜像发送到其他集群；\n- 超时：设置超时时间，超过设置的时间请求将失败；\n- 重试：设置重试策略，如触发条件、重试次数、间隔时间等；\n\n**DestinationRule**\n\n- 负载均衡：设置负载均衡策略，如简单负载均衡、区域感知负载均衡、区域权重负载均衡；\n- 熔断（Circuit Breaking）：通过异常点检测（Outlier Detection）和连接池设置将异常节点从负载均衡池中剔除；\n\n\u0060VirtualService\u0060 主要处理路由相关功能，而 \u0060DestinationRule\u0060 负责集群节点的开合和负载均衡。\n\n### Gateway API 融合 Kubernetes 和服务网格的入口网关\n\n正如上文所述，Gateway API 与服务网格之间有部分功能交集，为了减少重复开发，促成对 Gateway API 与服务网格之间共同关注点的建模，Gateway API 工作组提出了 [GAMMA](https:\/\/gateway-api.sigs.k8s.io\/contributing\/gamma\/)（Gateway API Mesh Management and Administration）倡议。\n\n在该倡议的倡导下，那些在不同网关实现中的细节各不相同的高级流量管理功能，例如超时、重试、健康检查等，全部通过[策略附件](https:\/\/gateway-api.sigs.k8s.io\/references\/policy-attachment\/)（Policy Attachment）的方式将由各个提供商来实现。你可以通过通过 \u0060targetRef\u0060 字段指定策略附件所附加到的资源对象，例如下所示：\n\n\u0060\u0060\u0060yaml\napiVersion: networking.acme.io\/v1alpha1\nkind: RetryPolicy\nmetadata:\n  name: foo\nspec:\n  override:\n    maxRetries: 10\n  default:\n    maxRetries: 5\n  targetRef:\n    group: gateway.networking.k8s.io\/v1alpha2\n    kind: HTTPRoute\n    name: foo\n\u0060\u0060\u0060\n\n在这里例子中重试策略被附加到了名为 \u0060foo\u0060 和 \u0060HTTPRoute\u0060 上。策略附件附加到不同的资源对象上，其生效的优先级也不同，例如 GatewayClass 是集群级的资源，如果策略附件覆盖在它上面的话，将优先生效。\n\n你可以给附加策略指定 \u0060override\u0060 和 \u0060default\u0060 值，其在入口和网格内不同资源上的层次结构的优先级是如下图所示。\n\n![Kubernetes 入口与网格中的覆盖和默认值的优先级](policy-attachment-priority.svg)\n\n目前，Gateway API 正在探索用来处理网格流量，并提出了一些[设计方案](https:\/\/docs.google.com\/document\/d\/1T_DtMQoq2tccLAtJTpo3c0ohjm25vRS35MsestSL9QU\/edit#heading=h.6ks49gf06yii)。\n\n## Envoy Gateway\n\n2022 年 10 月 Envoy Gateway 首个开源版本 [v0.2 发布](\/blog\/envoy-gateway-release\/)，这是一个基于 Envoy 代理的遵循 Gateway API 而创建的网关，[Tetrate](https:\/\/tetrate.io) 是该项目的核心发起者之一。Envoy Gateway 的目标是降低用户采用 Envoy 作为 API 网关的障碍，以吸引更多用户采用 Envoy。它通过入口和 L4\/L7 流量路由，表达式、可扩展、面向角色的 API 设计，使其成为供应商建立 API 网关增值产品的基础。\n\n早在 Envoy Gateway 发布之前，Envoy 作为最流行了云原生代理之一，已被大规模采用，有多款 Gateway 软件基于 Envoy 构建，Istio 服务网格使用它作为默认的 sidecar 代理，并通过 xDS 协议来配置这些分布式代理。在 Envoy Gateway 中，它同样使用 xDS 来配置 Envoy 集群，下图展示了 Envoy Gateway 的架构。\n\n![Envoy Gateway 架构图](envoy-gateway-arch.svg)\n\n基础设施供应商会为你提供 \u0060GatewayGlass\u0060，你可以通过创建一个 Gateway 声明来创建一个 Envoy Gateway，你在 Gateway 中的路由和策略附件会通过 xDS 协议发送给 Envoy 集群。\n\n关于 Envoy Gateway 的进一步介绍，请阅读：\n\n- [使用 Envoy Gateway 0.2 体验新的 Kubernetes Gateway API](https:\/\/cloudnative.to\/blog\/hands-on-with-envoy-gateway\/)\n- [面向未来的网关：新的 Kubernetes Gateway API 和 Envoy Gateway 0.2 介绍](https:\/\/cloudnative.to\/blog\/envoy-gateway-to-the-future\/)\n\n## 总结\n\nGateway API 作为下一代 Kubernetes Ingress API，为 Kubernetes 网关供应商提供一定程度上的 API 规范，在保证其可移植性的前提下丰富了入口网关的功能，同时通过关注点分离方便不同角色的人员对网关进行管理。最后 GAMMA 倡议正在促进服务网格的入口网关与 Gateway API 的融合，策略附件可能将 Gateway API 的功能进一步扩展到东西向网关，我们拭目以待。\n\n## 参考\n\n- [Gateway API - jimmysong.io](\/book\/kubernetes-handbook\/service-discovery\/gateway\/)\n- [一文搞懂 Kubernetes Gateway API 的 Policy Attachment - atbug.com](https:\/\/atbug.com\/explore-k8s-gateway-api-policy-attachment\/)\n- [SMI 与 Gateway API 的 GAMMA 倡议意味着什么？- atbug.com](https:\/\/atbug.com\/why-smi-collaborating-in-gateway-api-gamma\/)\n- [Evolving the Kubernetes Ingress APIs to GA and Beyond - Christopher M Luciano, IBM \u0026 Bowei Du, Google](https:\/\/kccncna19.sched.com\/#)\n', '\/blog\/why-gateway-api-is-the-future-of-ingress-and-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍 Kubernetes 中的入口网关及 Gateway API，入口网关与服务网格融合的新趋势。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-release/">Envoy Gateway 首个正式开源版本介绍</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/10/21</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy Gateway 首个正式开源版本介绍', '今天 Envoy Gateway v0.2 发布，本文将为你介绍什么是 Envoy Gateway，它的架构、快速入门和使用指南。', '\n今年五月 Envoy 社区宣布成立一个新的项目 [Envoy Gateway](https:\/\/github.com\/envoyproxy\/gateway)，经过五个月时间的开发，今天它的首个开源版本 v0.2 发布，本文将为你介绍什么是 Envoy Gateway，它的架构、快速入门和使用指南。\n\n## 什么是 Envoy Gateway？{#what-is-envoy-gateway}\n\nEnvoy Gateway 是一个用于管理 Envoy Proxy 的开源项目，可单独使用或作为 Kubernetes 中应用的网关。它通过了 Gateway API 核心一致性测试，使用 [Gateway API](https:\/\/gateway-api.sigs.k8s.io\/) 作为其唯一的配置语言来管理 Envoy 代理，支持 \u0060GatewayClass\u0060、Gateway、\u0060HTTPRoute\u0060 和 \u0060TLSRoute\u0060 资源。\n\nEnvoy Gateway 的目标是降低用户采用 Envoy 作为 API 网关的障碍，以吸引更多用户采用 Envoy。它通过入口和 L4\/L7 流量路由，表达式、可扩展、面向角色的 API 设计，使其成为供应商建立 API 网关增值产品的基础。\n\nEnvoy Gateway 的核心优势是轻量级、开放、可动态编程，尤其是为后端增加了安全功能，这些优势使得它很适合作为后端 API 网关。\n\n## 架构 {#architecture}\n\n下图展示的是 Envoy Gateway 的架构，图中的阴影部分表示是 Envoy Gateway。你可以通过静态和动态两种方式来配置它，其中的 Provider 是针对不同的供应商开发的。\n\n![Envoy Gateway 架构图](envoy-gateway-arch.svg)\n\n该架构图参考了 [Envoy Gateway 文档](https:\/\/gateway.envoyproxy.io\/contributions\/design\/system-design\/#architecture)。\n\n## 配置流程\n\n下面是配置 Envoy Gateway 的流程：\n\n1. 你可以通过配置文件为其 Provider 提供静态配置（目前仅支持 Kubernetes 和文件方式，将来有可能支持更多不同平台供应商），在 Envoy Gateway 启动后，你还可以通过 Kubernetes 动态配置 Provider；\n2. 这些配置会被 Provider 中的资源监视器看到后应用到 Envoy Gateway 的资源转义器上；\n3. 资源转义器将配置分别转义为针对不同 Provider 开发的基础设施管理器的中间表示（Infra IR）和 xDS 中间表示（xDS IR）；\n4. 两种中间表示（IR）分别应用到其对应的基础设施管理器和 xDS 转义上；\n5. 基础设施通过增删改查（CRDU）Kubernetes Deployment、Service 等资源来运行 Envoy，xDS 管理器通过将 xDS 协议配置 xDS Server 的方式配置 Envoy 代理；\n6. 对于 Envoy 代理的流量请求将应用以上配置并转发到对应的后端；\n\n以上就是对 Envoy Gateway 配置的流程，关于 Envoy 代理设计的更多细节请参考 [Envoy Gateway 文档](https:\/\/gateway.envoyproxy.io\/contributions\/design\/system-design\/)。\n\n## 快速开始 {#quick-start}\n\n下面我们将在 Kubernetes 集群中安装 Envoy Gateway 并部署一个测试网站来看看它是否可以正常运行。\n\n### 前提 {#prerequisites}\n\n在使用 Envoy Gateway 前，请注意它的兼容性问题，参考兼容性矩阵。\n\n| Envoy Gateway 版本 | Envoy 代理版本   | Gateway API 版本 | Kubernetes 最低版本 |\n| ------------------ | ---------------- | ---------------- | ------------------- |\n| v0.2.0             | **v1.23 - 最新** | **v0.5.1**       | v1.24               |\n\n### 安装 {#setup}\n\n因为在 Kubernetes 集群中 Gateway API 不是默认安装的，因此你需要手动安装 Gateway CRD。执行下面的命令安装 Gateway CRD 和 Envoy Gateway：\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/github.com\/envoyproxy\/gateway\/releases\/download\/v0.2.0\/install.yaml\n\u0060\u0060\u0060\n\n该命令将为你创建 \u0060envoy-gateway-system\u0060、\u0060gateway-system\u0060 两个命令空间，同时创了一系列 CRD。还有一些 Envoy Gateway 运行所需要的 ConfigMap、服务账户、RBAC、角色等。\n\n### 测试 {#test}\n\n执行下面的命令安装 GatewayClass、Gateway、HTTPRoute 和示例应用程序：\n\n\u0060\u0060\u0060 bash\nkubectl apply -f https:\/\/github.com\/envoyproxy\/gateway\/releases\/download\/v0.2.0\/quickstart.yaml\n\u0060\u0060\u0060\n\n端口转发到 Envoy 服务：\n\n\u0060\u0060\u0060bash\nkubectl -n envoy-gateway-system port-forward service\/${ENVOY_SERVICE} 8888:8080 \u0026\n\u0060\u0060\u0060\n\n通过 Envoy 代理 curl 示例应用程序：\n\n\u0060\u0060\u0060bash\ncurl --verbose --header \u0022Host: www.example.com\u0022 http:\/\/localhost:8888\/get\n\u0060\u0060\u0060\n\n你将看到如下输出：\n\n\u0060\u0060\u0060\n*   Trying 127.0.0.1:8888...\n* Connected to localhost (127.0.0.1) port 8888 (#0)\n\u003e GET \/get HTTP\/1.1\n\u003e Host: www.example.com\n\u003e User-Agent: curl\/7.79.1\n\u003e Accept: *\/*\n\u003e\n* Mark bundle as not supporting multiuse\n\u003c HTTP\/1.1 200 OK\n\u003c content-type: application\/json\n\u003c x-content-type-options: nosniff\n\u003c date: Sat, 22 Oct 2022 07:10:34 GMT\n\u003c content-length: 513\n\u003c x-envoy-upstream-service-time: 22\n\u003c server: envoy\n\u003c x-envoy-decorator-operation: backend.default.svc.cluster.local:3000\/*\n\u003c\n{\n \u0022path\u0022: \u0022\/get\u0022,\n \u0022host\u0022: \u0022www.example.com\u0022,\n \u0022method\u0022: \u0022GET\u0022,\n \u0022proto\u0022: \u0022HTTP\/1.1\u0022,\n \u0022headers\u0022: {\n  \u0022Accept\u0022: [\n   \u0022*\/*\u0022\n  ],\n  \u0022User-Agent\u0022: [\n   \u0022curl\/7.79.1\u0022\n  \/\/内容省略...\n },\n \u0022namespace\u0022: \u0022default\u0022,\n \u0022ingress\u0022: \u0022\u0022,\n \u0022service\u0022: \u0022\u0022,\n \u0022pod\u0022: \u0022backend-764c65b4dd-lp6jw\u0022\n* Connection #0 to host localhost left intact\n}\n\u0060\u0060\u0060\n\n如果你看到以上输出就证明你的 Envoy Gateway 安装成功并可正常运行。\n\n如果你的 Kubernetes 集群部署在云上，可以使用云负载均衡器的 IP 地址来访问测试：\n\n\u0060\u0060\u0060bash\nexport GATEWAY_HOST=$(kubectl get svc\/${ENVOY_SERVICE} -n envoy-gateway-system -o jsonpath=\u0027{.status.loadBalancer.ingress[0].ip}\u0027)\ncurl --verbose --header \u0022Host: www.example.com\u0022 http:\/\/$GATEWAY_HOST:8080\/get\n\u0060\u0060\u0060\n\n笔者使用的 GKE，运行上面的命令，\u0060GATEWAY_HOST\u0060 环境变量的值几位负载均衡器的 IP 地址，最后同样可以类似上文的 \u0060curl\u0060 输出。\n\n## Envoy Gateway 中使用的 CRD 简介 {#isito-gateway-crd}\n\n上文说到安装 Envoy Gateway 的时候创建了一系列 CRD，在此我们将简要介绍一下这些 CRD：\n\n- \u0060envoyproxies.config.gateway.envoyproxy.io\u0060：Envoy Proxy API 的 Schema。\n- \u0060gatewayclasses.gateway.networking.k8s.io\u0060：GatewayClass 描述了用户可用于创建 Gateway 资源的一类 Gateways。建议将该资源作为 Gateway 的模板。这意味着一个 Gateway 是基于创建时 GatewayClass 的状态，对 GatewayClass 或相关参数的改变不会向下传播到现有的 Gateway。这项建议的目的是限制 GatewayClass 或相关参数的变化的爆炸半径。如果实现者选择将 GatewayClass 的变化传播给现有 Gateway，实现者必须清楚地记录这一点。每当一个或多个 Gateway 使用一个 GatewayClass 时，实现必须在相关的 GatewayClass 上添加 \u0060gateway-exists-finalizer.gateway.networking.k8s.io\u0060 finalizer。这可以确保与 Gateway 相关的 GatewayClass 在使用中不会被删除。GatewayClass 是一个集群级的资源。\n- \u0060gateways.gateway.networking.k8s.io\u0060：Gateway 通过将 Listener 与一组 IP 地址绑定，代表了一个服务流量处理基础设施的实例。\n- \u0060httproutes.gateway.networking.k8s.io\u0060：HTTPRoute 提供了一种路由 HTTP 请求的方法。这包括通过主机名、路径、标头或查询参数来匹配请求的能力。过滤器可以用来指定额外的处理步骤。后端指定匹配的请求应该被路由到哪里。\n- \u0060referencegrants.gateway.networking.k8s.io\u0060：\u0060ReferenceGrant\u0060 标识了其他命名空间中的资源种类，这些资源被信任为引用与策略相同的名称空间中的指定资源种类。每个 \u0060ReferenceGrant\u0060 都可以用来代表一个独特的信任关系。额外的引用授权可以用来添加到它们所定义的命名空间的入站引用的信任源集合中。Gateway API 中的所有跨命名空间引用（除了跨命名空间的 Gateway-route 附件）都需要一个 \u0060ReferenceGrant\u0060。\n- \u0060referencepolicies.gateway.networking.k8s.io\u0060：该资源已被重新命名为 ReferenceGrant，且将在 Gateway API v0.6.0 中被删除，而采用相同的 ReferenceGrant 资源。\n- \u0060tcproutes.gateway.networking.k8s.io\u0060：TCPRoute 提供了一种路由 TCP 请求的方法。当与 Gateway 监听器结合使用时，它可以用来将监听器指定的端口上的连接转发到 TCPRoute 指定的一组后端。\n- \u0060tlsroutes.gateway.networking.k8s.io\u0060：TLSRoute 资源与 TCPRoute 类似，但可以配置为与 TLS 特定的元数据相匹配。这使得为特定的 TLS 监听器匹配数据流时有更大的灵活性。如果你需要将流量转发到一个 TLS 监听器的单一目标，你可以选择同时使用 TCPRoute 和 TLS 监听器。\n- \u0060udproutes.gateway.networking.k8s.io\u0060：UDPRoute 提供了一种路由 UDP 流量的方法。当与网关监听器结合使用时，它可以用来将监听器指定的端口上的流量转发到 UDPRoute 指定的一组后端。\n\n关于这些 CRD 的具体用法以及 Envoy Gateway 的用户指南，将在以后的文章中分享。\n\n下面两篇我同事写的关于 Envoy Gateway 的文章推荐给大家阅读：\n\n- [使用 Envoy Gateway 0.2 体验新的 Kubernetes Gateway API](https:\/\/cloudnative.to\/blog\/hands-on-with-envoy-gateway\/)\n- [面向未来的网关：新的 Kubernetes Gateway API 和 Envoy Gateway 0.2 介绍](https:\/\/cloudnative.to\/blog\/envoy-gateway-to-the-future\/)\n\n## 参考 {#reference}\n\n- [开源项目 Envoy Gateway 简介 - cloudnative.to](https:\/\/cloudnative.to\/blog\/introducing-envoy-gateway\/)\n- [Envoy API Gateway—— 推动网关的进一步发展 - cloudnative.to](https:\/\/cloudnative.to\/blog\/the-gateway-to-a-new-frontier\/)\n- [Envoy Gateway 官方网站 - gateway.envoyproxy.io](https:\/\/gateway.envoyproxy.io\/)\n', '\/blog\/envoy-gateway-release\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">今天 Envoy Gateway v0.2 发布，本文将为你介绍什么是 Envoy Gateway，它的架构、快速入门和使用指南。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(68)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(38)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(24)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(20)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(15)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(13)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(13)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
      
        <a href="/categories/%e5%ae%b9%e5%99%a8" class="sidebar-item">
            <span>容器</span>
            <span>(4)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(4)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">保障 Istio 安全：解决关键安全漏洞及最佳实践</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/ulanqab-trip/">乌兰察布之旅：探索火山与失落的村庄</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/explore-tetrate-enterprise-gateway/">介绍 Tetrate Enterprise Gateway 及与 Istio 集成：云原生应用的全面网关解决方案</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024 圆桌论坛预告：Istio 和现代 API 网关——引领服务网格的未来</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 大连云原生技术开放日</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
