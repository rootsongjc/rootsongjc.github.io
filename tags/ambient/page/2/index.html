<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Ambient - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="宋净超的博客">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/tags/ambient/" />
  <meta property="og:title" content="Ambient | Jimmy Song" />
  <meta property="twitter:title" content="Ambient | Jimmy Song" />

  
  <meta property="og:description" content="宋净超的博客" />
  <meta property="twitter:description" content="宋净超的博客" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/tags/ambient/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Ambient
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ztunnel-testing/">[译] 无需 Kubernetes 测试 Kubernetes 网络实现</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/23</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://blog.howardjohn.info/posts/ztunnel-testing/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('无需 Kubernetes 测试 Kubernetes 网络实现', '探讨如何在没有 Kubernetes 环境的情况下测试 Ztunnel 网络代理，该代理为 Istio 的新 Ambient 模式编写。', '\n由于在开发过程中我[真的不喜欢等待](https:\/\/blog.howardjohn.info\/posts\/ideal-ci\/)，所以在构建 Ztunnel（一个为 Istio 的新 [Ambient 模式](https:\/\/istio.io\/latest\/blog\/2022\/introducing-ambient-mesh\/)设计的底层网络代理）时，我的首要任务之一便是确保测试的快速进行（包括运行和编写测试），并且易于调试。\n\n这一任务颇为棘手，因为在大多数真实场景中，Ztunnel 高度依赖 Kubernetes。虽然它能够完全独立于 Kubernetes 运行，但许多关键代码路径的行为完全不同，使得仅通过这种方式进行测试变得不可行。\n\n下图为典型的 Ztunnel 部署架构：\n\n![Ztunnel 架构概览](ztunnel-architecture.svg)\n\n在此架构中，用户将运行一个包含多个节点的 Kubernetes 集群。每个节点上都运行着一个 Ztunnel，配置了宿主机和每个 pod 的网络栈。\n\n此外，Ztunnel 实际上进入了每个 pod 的网络命名空间，并代表其发送\/接收流量。这一点非常奇特且酷炫，但也大大增加了测试的难度！（[详细信息](https:\/\/www.youtube.com\/watch?v=cuMeEhpyH5s)）\n\n## 加速测试\n\n启动完整的 Kubernetes 环境、重建镜像、部署到每个节点的过程非常缓慢且难以调试。\n\n黄金标准应该是将所有操作运行在一个简单的单一二进制文件中——仅需执行 \u0060cargo test\u0060。这种方式避开了复杂的设置和缓慢的重建，并使调试变得轻而易举（当然，你可以将调试器连接到正在运行的 pod，但这很麻烦）。\n\n## 设置网络\n\n如果我们去除无尽的抽象层，Kubernetes pod 实际上只是几个 Linux 命名空间和挂载的组合。Docker 在这方面管理得很好，[bash](https:\/\/github.com\/p8952\/bocker) 也可以。\n\n我们特别关注的是[网络命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/network_namespaces.7.html)，它可以实现网络栈的隔离。每个 pod 都有自己的网络命名空间，通过各种机制连接，允许与同一节点上的其他 pod、其他节点以及外部目的地通信。\n\n好消息是创建网络命名空间非常简单。\n\n\u0060\u0060\u0060shell\n$ sudo ip netns add testing\n\u0060\u0060\u0060\n\n我们的最终目标是设置一系列的网络命名空间，外观与我们在 Kubernetes 上的真实架构类似：\n\n![所需的网络命名空间设置](ztunnel-network-namespaces.svg)\n\n在网络命名空间之间建立连接稍微复杂一些。像  [\u0060cnitool\u0060](https:\/\/www.cni.dev\/docs\/cnitool\/) 这样的工具可以帮助我们完成（它实际上执行了一些 Kubernetes 环境中用于设置网络的相同逻辑，但作为 CLI 工具），但你也可以完全手动操作。我们选择了后者。\n\n最终，我们的设置如下：\n\n- 每个测试都拥有自己的网络命名空间，通过一个桥接设备（\u0060br0\u0060）来促进节点之间的流量。\n- 每个节点配置了一个 \u0060veth\u0060 设备。一端成为节点上的 \u0060eth0\u0060，另一端连接到根命名空间中的 \u0060br0\u0060。\n- 每个 pod 都配置了一个 \u0060veth\u0060 设备。一端成为 pod 上的 \u0060eth0\u0060，另一端位于节点网络命名空间中。\n- 为每个 pod 设置路由以将流量发送到节点。\n- 为每对节点设置路由，以实现跨节点流量。\n\n![所需的网络连接设置](ztunnel-network-devices.svg)\n\n除了根命名空间\/桥接设备外，这与许多现实世界中的 Kubernetes 集群的运行方式相同（在现实世界中，根命名空间是两台机器之间的物理网络）。\n\n你可以在[这里](https:\/\/github.com\/istio\/ztunnel\/blob\/34fce85a6a2b2a85eb170a04096731e2ea4e0e9f\/src\/test_helpers\/netns.rs#L194)找到所有细节。\n\n## 运行测试\n\n一旦我们有了这些命名空间，我们仍然需要一种实际使用它们的方法。幸运的是，Linux 允许在运行时更改当前命名空间线程（这是接下来重要的内容）。这让我们建立了一个基本的帮助函数（真实的代码稍微更复杂）：\n\n\u0060\u0060\u0060rust\nfn run_in_namespace(namespace: Namespace, f: Fn()) { let original_namespace = get_current_namespace(); namespace.enter(); f(); original_namespace.enter(); }\n\u0060\u0060\u0060\n\n有了这个，我们可以轻松地从任意的“pods”或“nodes”执行代码。\n\n然而，我们仍然面临一个问题。我们的所有代码都运行在 [tokio](https:\/\/tokio.rs\/) 异步运行时中，它会根据需要将我们的各种任务安排到物理操作系统线程上（类似于 Go 运行时的工作方式）。由于网络命名空间是线程相关的，所以当我们的任务在线程之间跳转时，这一切都会崩溃。\n\n幸运的是，Rust 给了我们比 Go 更多的关于异步运行时的灵活性——我们可以同时拥有多个！借此，我们能够构建一个能够异步执行 \u0060run_in_namespace\u0060。对于我们想要执行的每个函数，我们启动一个新线程并构建一个专用的单线程异步运行时来处理它：\n\n\u0060\u0060\u0060rust\nasync fn async_run_in_namespace(namespace: Namespace, f: async Fn()) { thread::spawn(move || { run_in_namespace(namespace, || { let rt = tokio::runtime::Builder::new_current_thread().enable_all().build(); rt.block_on(f()) }) }); }\n\u0060\u0060\u0060\n\n我们为每个命名空间运行一次这个函数，因此这里的开销是最小的。如果我们想要运行许多小函数，可以在顶层构建一个抽象来发送工作到线程以执行。\n\n我们需要的最后一件事是一种合理的方法来识别如何调用每个目的地。虽然它们都会被分配一个 IP（基于我们代码中的简单 IPAM 策略），但我们不希望每个测试都必须猜测 IP。为了处理这个问题，我们构建了一个简单的名称解析器。这就像 DNS，但简单得多：对于我们创建的每个“pod”，我们记录一个\u0060name -\u003e IP\u0060的映射，并允许查找 IP。\n\n将所有这些放在一起，一个简单的测试启动了 3 个 pods（客户端、服务器和 ztunnel）在一个单一节点上看起来像这样：\n\n\u0060\u0060\u0060rust\n#[tokio::test] async fn simple_test(){ let ztunnel = manager.deploy_ztunnel(DEFAULT_NODE).await?; let server = manager .workload_builder(\u0022server\u0022, DEFAULT_NODE) .register() .await?; run_tcp_server(server)?; let client = manager .workload_builder(\u0022client\u0022, DEFAULT_NODE) .register() .await?; run_tcp_client(client, manager.resolve(\u0022server\u0022))?; \/\/ ... some assertions here }\n\u0060\u0060\u0060\n\n## 放弃权限\n\n上述设置效果很好，但也带来了一些问题。\n\n基本上设置的每一步都需要提升的 root 权限；这让简单的 \u0060cargo test\u0060 案例的开箱即用变得乏味，通常也不可取。\n\n此外，这会在主机环境中污染大量的命名空间。虽然我们有一些清理过程，但这些并不是 100% 可靠，可能会导致悬挂的命名空间阻碍未来的执行。\n\n解决拥有太多命名空间的问题的方法？更多的命名空间！为此，我们需要的不仅仅是网络命名空间。\n\n[用户命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/user_namespaces.7.html) 允许我们实质上假装是 UID 0 (root)，同时实际上将其映射回我们原始的 UID。这里的力量在于，在该命名空间中，我们可以做一些本来需要 root 权限的事情——特别是创建新的网络命名空间。\n\n然而，我们不能做的一件事是修改主机-root 拥有的文件（这将是明显的权限违规）。尽管我们可能可以绕过它们，但我们在测试中使用的很多工具喜欢触摸 root 文件。这再次可以通过 [mount 命名空间](https:\/\/man7.org\/linux\/man-pages\/man7\/mount_namespaces.7.html) 解决，它允许我们将我们拥有的文件绑定挂载到主机-root 拥有的文件上，而不会影响命名空间外的事物。\n\n将所有这些放在一起，我们有这样的东西：\n\n\u0060\u0060\u0060rust\nlet original_uid = get_uid(); \/\/ 首先，进入一个新的用户命名空间。unshare(CloneFlags::CLONE_NEWUSER).unwrap(); \/\/ 将用户命名空间中的 root 映射到我们原始的 UID File::create(\u0022\/proc\/self\/uid_map\u0022).write(format!(\u00220 {original_uid} 1\u0022)); \/\/ 设置一个新的网络命名空间 unshare(CloneFlags::CLONE_NEWNET).unwrap(); \/\/ 设置一个新的挂载命名空间 unshare(CloneFlags::CLONE_NEWNS).unwrap(); \/\/ 将一个文件夹在我们的每个测试目录中挂载到 \/var\/run\/netns mount(tmp_dir.join(\u0022netns\u0022), \u0022\/var\/run\/netns\u0022, MS_BIND); \/\/ 一个方便手动调试的好帮手信息，如果需要的话。let pid = get_pid(); eprintln!(\u0022Starting test in {tmp_dir}. Debug with \u0060sudo nsenter --mount --net -t {pid}\u0060\u0022);\n\u0060\u0060\u0060\n\n如上所述，一个技巧是，进入命名空间是按线程进行的。我们需要在生成任何额外线程之前设置这一点。\n\nRust 实际上为我们提供了这样做的能力，但这意味着我们失去了 \u0060#[tokio::test]\u0060 宏帮助。我们可以写自己的宏，但这有点痛苦。幸运的是，通过 [链接器的花招](https:\/\/crates.io\/crates\/ctor) 我们可以迫使我们的代码在进程执行的非常早期运行。\n\nGo 中的类似方法也有效（请参见 [我写的帮助库](https:\/\/github.com\/howardjohn\/unshare-go)），实际上在那里是必需的，因为设置必须在 Go 运行时启动之前完成（这通常在任何用户代码运行之前很久）。\n\n## 总结\n\n有了所有这些设备，一个完整的测试只需要大约 200 毫秒。一切都在一个单一进程中运行，使调试变得轻而易举。所有的测试也都是完全隔离的，因此可以完全并行运行测试（包括相同的测试，用于压力测试以消除测试缺陷）。\n', '\/trans\/ztunnel-testing\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探讨如何在没有 Kubernetes 环境的情况下测试 Ztunnel 网络代理，该代理为 Istio 的新 Ambient 模式编写。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/what-is-new-in-istio-1-22/">深入解析 Istio 1.22：新特性和实际应用建议</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/06/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('深入解析 Istio 1.22：新特性和实际应用建议', '探索 Istio 1.22 的新特性与实用建议，包括增量 xDS、路径模板支持及 API 升级等，助力优化服务网格管理。', '\n最近 [Istio 1.22 发布](https:\/\/istio.io\/latest\/news\/releases\/1.22.x\/announcing-1.22\/)包含大量的重大更新，本文将为你分享这个发布带来的新特性及应用建议。\n\n## Ambient 模式进入 Beta 阶段\n\n虽然 Ambient 模式现已进入 Beta 阶段，但这并不意味着我们可以完全告别 Sidecar。尽管 Istio 官方宣称 Ambient 模式可以简化操作并显著减少内存和 CPU 使用，但它仍然存在局限性和潜在的复杂性问题。例如，虽然取消了 Sidecar，但需引入新的 ztunnel 和 waypoint 组件，这可能带来新的挑战。关于 Ambient 模式进入 Beta 模式的详细信息请参阅 [Istio 官方博客](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/)。\n\n**Ambient 模式带来的新的挑战**\n\n- Ambient mode 对 L7 流量的管理仍未成熟\n- mTLS 被强制在 namespace 级别开启，也就是说使用 Ambient 模式你无法关闭 mTLS\n- Ambient 模式的无宕机升级仍未解决\n- 缺少 与 Sidecar 模式共存和迁移的最佳实践\n\n关于 Sidecar 模式和 Ambient 模式的对比，详见 [Istio Ambient 模式的局限性解析](\/blog\/istio-ambient-mode-limitations\/)。\n\n{{\u003ccallout note \u0022建议\u0022\u003e}}\n如果是刚开始使用 Istio，尤其是你只需要为服务自动开启 mTLS 的情况下，当前阶段可以尝试使用 Ambient 模式。但是对于 L7 功能，建议等到 Ambient 模式完全成熟后再考虑生产上使用。\n{{\u003c\/callout\u003e}}\n\n## Istio API 升级\n\nIstio Istio 1.22 版本中，关键 API 如流量管理、安全、Telemetry 相关的 API 都已正式升级到 \u0060v1\u0060 版本。你只需要将原有配置的 API 版本修改为 \u0060v1\u0060 即可，除此之外不需要任何更改。这些 API 早已成熟，你可以放心的使用 \u0060v1\u0060 版本，对于对稳定性要求较高的环境，Istio 添加了[验证准入策略](https:\/\/kubernetes.io\/docs\/reference\/access-authn-authz\/validating-admission-policy\/)确保只有 \u0060v1\u0060 API 和字段可以在 Istio API 中使用。\n\n例如下面的 AuthorizationPolicy 示例。\n\n\u0060\u0060\u0060yaml {linenos=table,hl_lines=1}\napiVersion: security.istio.io\/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: finance-to-supply-chain\n  namespace: finance\nspec:\n  selector:\n    matchLabels:\n      app: finance-app\n  action: ALLOW\n  rules:\n  - from:\n    - source:\n        namespaces: [\u0022finance\u0022]\n    to:\n    - operation:\n        methods: [\u0022GET\u0022, \u0022POST\u0022]\n        paths: [\u0022\/api\/supply1\u0022, \u0022\/api\/supply2\u0022]\n    when:\n    - key: request.headers[:authority]\n      values: [\u0022supply-chain-service.supply-chain.svc.cluster.local\u0022]\n\u0060\u0060\u0060\n\n其他扩展类的 API 如 \u0060EnvoyFilter\u0060、\u0060WasmPlugin\u0060、\u0060ProxyConfig\u0060 还未成熟，因此还停留在 alpha 或 beta 阶段。关于 API 升级的更多信息，请参考 [v1 API 博客](https:\/\/istio.io\/latest\/blog\/2024\/v1-apis\/)。\n\n{{\u003ccallout note \u0022建议\u0022\u003e}}\n对于常用功能可以放心使用 \u0060v1\u0060 API，扩展类 API 尚未稳定为了保证系统稳定性，可以开启验证准入策略。\n{{\u003c\/callout\u003e}}\n\n## Gateway API 升级\n\n[Gateway API](\/blog\/why-gateway-api-is-the-future-of-ingress-and-mesh\/) 已更新至版本 1.1.0，现已普遍可用。这一更新扩展了 Istio 的流量管理能力，但需要注意 Istio 原生 API 与 Gateway API 的兼容性问题。在迁移到新 API 时应谨慎，以避免依赖尚未完全成熟的特性。更多详情，请查看 [Gateway API v1.1 博客](https:\/\/istio.io\/latest\/blog\/2024\/gateway-mesh-ga\/)。\n\n{{\u003ccallout note \u0022建议\u0022\u003e}}\n对于已经稳定使用 Istio API 的现有部署，可以继续使用，尤其是在需要使用到高级功能的场景下。对于新部署优先考虑使用稳定版的 Gateway API，以利用其现代化的流量管理功能。因为二者现存的兼容性问题，不要冒然迁移到 Gateway API，否则得不偿失。\n{{\u003c\/callout\u003e}}\n\n## 增量 xDS 默认启动\n\nIstio 1.22 版本默认启用了增量 xDS，这是一个优化配置分发的机制。与传统的 State of the World（SotW）模式相比，增量 xDS 仅将变更的配置发送给 Envoy 代理，从而显著减少了网络传输的数据量和控制平面的资源消耗。这一变更尤其适用于配置频繁更新的大规模部署环境，能够提高配置更新的效率和性能。此外，增量 xDS 还有助于在网络环境复杂或配置动态变化的情况下，更高效地管理服务网格的配置更新。\n\n{{\u003ccallout note \u0022建议\u0022\u003e}}\n增量 xDS 早在 Istio 的几个版本前就已经开发完成，只是没有默认开启，现在该功能已经稳定，可以放心使用。\n{{\u003c\/callout\u003e}}\n\n更多关于 xDS 的介绍请参考[Envoy xDS 及 Istio 中的配置分发流程介绍](\/blog\/istio-delta-xds-for-envoy\/)。\n\n### AuthorizationPolicy 的路径模板支持通配符\n\n在 Istio 1.22 中，\u0060AuthorizationPolicy\u0060 新增了对[路径模板](https:\/\/istio.io\/latest\/docs\/reference\/config\/security\/authorization-policy\/#Operation)的支持，极大增强了路径匹配的灵活性和精确性。而在此之前，\u0060AuthorizationPolicy\u0060 的路径配置并不支持通配符。此功能允许使用基于 Envoy 的 URI 模板匹配来定义 HTTP 请求中的路径。路径可以包括简单的通配符（\u0060*\u0060 和 \u0060**\u0060）或具名变量，从而精确匹配单个或多个路径组件。例如，路径模板 \u0060\/foo\/{*}\u0060 能匹配 \u0060\/foo\/bar\u0060 但不匹配 \u0060\/foo\/bar\/baz\u0060，而 \u0060\/foo\/{**}\/\u0060 则可以匹配任何以 \u0060\/foo\/\u0060 开头的路径。这种灵活的路径模板设计，特别适用于动态和复杂的路由规则，进一步加强了 Istio 的安全策略工具箱。\n\n下图展示了 AuthorizationPolicy 的路径匹配的通配符规则。\n\n\u0060\u0060\u0060mermaid \u0022AuthorizationPolicy 的路径匹配通配符规则\u0022\ngraph LR\n    A[AuthorizationPolicy 路径匹配] --\u003e B(定义路径模板)\n    B --\u003e C{路径模板操作符}\n    C --\u003e D[\u0022*（匹配单个段）\u0022]\n    C --\u003e E[\u0022**（匹配多个段）\u0022]\n    C --\u003e F[\u0022{name}（命名变量匹配单个段）\u0022]\n    C --\u003e G[\u0022{name=**}（命名变量匹配多个段）\u0022]\n\n    D --\u003e H[\u0022\/foo\/{*} 匹配 \/foo\/bar\u0022]\n    E --\u003e I[\u0022\/foo\/{**}\/ 匹配 \/foo\/bar\/、\/foo\/bar\/baz.txt\u0022]\n    F --\u003e J[\u0022\/videos\/{file} 匹配 \/videos\/1080p5000_00001.m4s\u0022]\n    G --\u003e K[\u0022\/**.mpd 匹配 \/content\/123\/india\/dash\/55\/manifest.mpd\u0022]\n\u0060\u0060\u0060\n\n![AuthorizationPolicy 的路径匹配通配符规则](f96fd4f3843d3d7b7c13b0a5083f00f4.svg)\n\n了解更多关于路径模板的具体应用和规则，你可以参考 [Envoy 的官方文档](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/path\/match\/uri_template\/v3\/uri_template_match.proto)。\n\n{{\u003ccallout note \u0022提示\u0022\u003e}}\n\u0060AuthorizationPolicy\u0060 中的路径匹配终于支持模板了，你不需要再在配置中一个一个地手动加入路径了。\n{{\u003c\/callout\u003e}}\n\n## 总结\n\nIstio 1.22 版本引入了多项重要更新和改进，尽管某些特性被广泛宣传，但在实际使用中需要进行详细评估和适当的测试。希望本篇博客能帮助你更深入地理解和应用这些新特性，以在实际操作中获得最佳效果。\n\n## 参考\n\n- [Gateway API v1.1: Service mesh, GRPCRoute, and a whole lot more - kubernetes.io](https:\/\/kubernetes.io\/blog\/2024\/05\/09\/gateway-api-v1-1\/)', '\/blog\/what-is-new-in-istio-1-22\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索 Istio 1.22 的新特性与实用建议，包括增量 xDS、路径模板支持及 API 升级等，助力优化服务网格管理。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-mode-limitations/">Istio Ambient 模式的局限性解析</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/05/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式的局限性解析', '深入探讨 Istio 1.22 版本中的 Ambient 模式，与传统 Sidecar 模式的对比及其限制。', '\n[Istio 1.22](https:\/\/istio.io\/latest\/news\/releases\/1.22.x\/announcing-1.22\/) 版本的发布标志着 Ambient 模式正式进入 beta 阶段，随之发布了一篇标题为 [告别 Sidecar：Istio 的 Ambient 模式在 v1.22 中达到 Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 的博客，声称 Layer 4 和 Layer 7 的功能现已可用于生产环境。其实社区早在一个月前的 KubeCon EU 上就宣布了这一里程碑。这种激动人心的宣传似乎在暗示我们可以彻底抛弃 Sidecar 模式，但事实真是如此吗？\n\n### 为什么不急于告别 Sidecar 模式？\n\n虽然我对新技术持开放态度，但完全告别 Sidecar 模式可能为时尚早。每种模式都有其特定的应用场景和优缺点。下面，我将详细分享 Ambient 模式相较于 Sidecar 模式的一些限制，帮助大家更好地理解两者之间的差异。\n\n### Ambient 模式与 Sidecar 模式的关键区别\n\n#### 流量管理\n\nAmbient 模式的 L7 流量管理支持尚未成熟，尚未达到生产环境的可用水平。相较之下，Sidecar 模式在这方面更为稳定和可靠。\n\n#### 安全性\n\n在 Ambient 模式下，mTLS 被强制在 namespace 级别开启，而 Sidecar 模式则赋予用户更大的灵活性，可以选择是否启用 mTLS。这种灵活性对于某些应用场景尤为重要。\n\n#### 可观测性\n\n对于 L7 层的遥测数据，Ambient 模式能否像 Sidecar 模式一样对每个 pod 进行精确的监控和追踪仍是一个疑问。Sidecar 模式在可观测性方面已被广泛验证，其能力更为成熟。\n\n#### 运维\n\n部署方面，Ambient 模式推荐使用 Helm，仅支持 Kubernetes 平台，而 Sidecar 模式还支持虚拟机和混合云环境。此外，Ambient 模式尚未得到主要云厂商的官方支持。在升级过程中，Ambient 模式的爆炸半径更大，暂不支持金丝雀发布，推荐使用蓝绿部署。对于从 Sidecar 模式向 Ambient 模式的迁移或二者共存，仍缺乏最佳实践。\n\n#### 扩展性\n\n目前对于 Wasm 插件的支持，Ambient 模式仍不明确，而 Sidecar 模式在这方面已经有了较为完善的支持。\n\n#### 其他功能特性\n\nDual Stack 模式在 Sidecar 模式下虽然仍处于实验阶段，但至少已有一定的实现，而 Ambient 模式是否支持这一特性仍不明朗。\n\n### 总结\n\n虽然 Istio 1.22 带来了令人兴奋的 Ambient 模式，但在完全告别 Sidecar 模式之前，我们需要慎重考虑这些限制和差异。每种模式都有其独特的优势和适用场景，用户应根据自身需求做出明智的选择。我将继续对 Ambient 模式进行测试和追踪，更多深入解读敬请关注本博客。', '\/blog\/istio-ambient-mode-limitations\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入探讨 Istio 1.22 版本中的 Ambient 模式，与传统 Sidecar 模式的对比及其限制。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-cni-deep-dive/">深入解析 Istio CNI：赋能无侵入式流量管理与强化服务网格安全</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/04/17</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('深入解析 Istio CNI：赋能无侵入式流量管理与强化服务网格安全', '本文详细解释了 Istio CNI 插件的设计理念、实现方式以及如何通过 Ambient Mode 提升安全性和权限管理。', '\n本文将深入探讨 Istio CNI 插件的设计理念、实现方式以及如何通过 Ambient Mode 来解决传统模式中存在的安全和权限问题。本文内容包括：\n\n- Init 容器的安全风险及其解决方案。\n- Istio CNI 的工作原理及其优势。\n- Ambient Mode 的实现机制及其与 CNI 的集成。\n\n## Istio 网络要求与解决方案概览 {#overview}\n\nIstio 服务网格通过 Sidecar 模式实现应用流量的拦截和管理。该模式通过在应用程序 Pod 中注入 Sidecar Proxy 和 init 容器，并使用 iptables 规则来管理网络流量。详细的部署和操作过程请参见 [Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解](\/blog\/sidecar-injection-iptables-and-traffic-routing\/)。虽然此方法在多数 Kubernetes 平台上有效，但对高权限的依赖在多租户环境中引发了安全方面的担忧。\n\n### Istio-init 的局限性 {#istio-init}\n\nIstio 在其网络配置初期采用了 \u0060istio-init\u0060 容器来初始化流量拦截规则，这需要容器具有高级权限来修改网络配置，如 IPTables 规则。虽然这种方法实现了对流量的有效管理，但它也显著提高了权限需求并增加了安全风险。根据 [Istio 官方文档](https:\/\/istio.io\/latest\/zh\/docs\/setup\/additional-setup\/cni\/)，\u0060istio-init\u0060 容器默认被注入到 Istio 网格中的 Pod 里，以便将网络流量劫持到 Istio 的 Sidecar 代理。这一过程需要对部署 Pod 的 Service Account 赋予 [\u0060NET_ADMIN\u0060 容器权限](https:\/\/kubernetes.io\/zh-cn\/docs\/tasks\/configure-pod-container\/security-context\/#set-capabilities-for-a-container)，可能与某些组织的安全政策相悖。\n\n### Istio CNI 插件 {#istio-cni-plugin}\n\n为响应这一挑战，Istio 社区推出了 [Istio CNI](https:\/\/github.com\/istio\/istio\/tree\/master\/cni) 插件，该插件避免了对 init 容器的需求，允许直接在 Kubernetes 的网络层面操作，从而降低权限需求并简化部署流程，但是存在 CNI 兼容性问题。\n\n### Ambient 模式的引入 {#ambient-mode}\n\nIstio 的 Ambient Mode 是一种创新的无 sidecar 方案，它通过 [使用 Geneve 隧道](\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/) 或 Istio CNI 提高网络的灵活性和安全性。\n\n直到最近 Istio 社区才推出[适配任意 CNI](https:\/\/istio.io\/latest\/zh\/blog\/2024\/inpod-traffic-redirection-ambient\/) 的通用的解决方案。此模式解决了与任意 CNI 的兼容性问题，使 Istio 能够在不影响现有网络策略的前提下，更有效地管理服务间的流量。\n\n## NET_ADMIN 权限的安全考虑 {#net-admin}\n\n在 Kubernetes 和 Docker 等容器化环境中，\u0060NET_ADMIN\u0060 权限允许容器内的进程执行广泛的网络相关操作。这包括修改 iptables 规则、更改网络接口配置、管理 IP 路由表，以及控制网络相关的内核参数。然而，这种权限的使用引发了安全上的考虑，特别是在权限过度和潜在的攻击面方面。\n\n**最佳实践包括**：\n\n- **限制使用范围**：只在必要时授予 \u0060NET_ADMIN\u0060 权限，并通过 Kubernetes 网络策略加以限制。\n- **持续监控与审计**：对使用 \u0060NET_ADMIN\u0060 权限的容器进行严格的日志记录和监控。\n\n## Istio CNI 插件的工作原理 {#istio-cni-principal}\n\nIstio CNI 插件是一个二进制文件，作为代理安装在每个节点的文件系统中。以下流程图说明了 Istio CNI 节点代理的工作原理：\n\n\u0060\u0060\u0060mermaid \u0022Istio CNI 插件的工作原理\u0022\nflowchart TB\n    subgraph istio_cni_node_agent[Istio CNI 节点代理]\n        direction LR\n        install_plugin[安装 Istio CNI 插件]\n        update_config[更新节点 CNI 配置位于 \/etc\/cni\/net.d]\n        monitor_paths[监控插件和配置路径]\n        \n        subgraph sidecar_mode[\u0022Sidecar 模式\u0022]\n            sidecar_setup[为 Pod 配置 iptables]\n        end\n        \n        subgraph ambient_mode[\u0022Ambient 模式\u0022]\n            ambient_server[Ambient 监控服务器]\n            sync_events[同步 Pod 事件]\n            configure_iptables[在 Pod 内配置 iptables]\n        end\n\n        install_plugin --\u003e update_config\n        update_config --\u003e monitor_paths\n        monitor_paths --\u003e sidecar_mode\n        monitor_paths --\u003e ambient_mode\n        ambient_mode --\u003e ambient_server\n        ambient_server --\u003e sync_events\n        sync_events --\u003e configure_iptables\n    end\n\u0060\u0060\u0060\n\n![Istio CNI 插件的工作原理](fb607dc081ac2cb19c109626ccfe368b.svg)\n\n\n\n- Istio CNI Node Agent 充当安装在每个节点上的代理。\n- 安装 Istio CNI 插件并更新节点的 CNI 配置。\n- 代理监控 CNI 插件和配置路径的更改。\n- 在 Sidecar 模式下，它使用 pod 的 iptables 处理 sidecar 网络设置。\n- 在 Ambient 模式下，它将 pod 事件同步到环境监控服务器，然后该服务器在 pod 内配置 iptables。\n- 节点需要提升权限，例如 \u0060CAP_SYS_ADMIN\u0060 、 \u0060CAP_NET_ADMIN\u0060 和 \u0060CAP_NET_RAW\u0060 才能在任一模式下运行。\n\n## 解析 Istio Ambient Mode 与 Kubernetes CNI 的冲突 {#confilct}\n\nIstio 的 Ambient Mode 是为了适配所有 CNI 而设计的一种模式，它通过 ztunnel 来透明地处理 Pod 内的流量转发，而不影响现有的 CNI 配置。这种模式下，Ambient Mode 通过 ztunnel 管理流量，使其流经 Istio 服务网格，而标准的 CNI 则侧重于为 Pod 提供标准化的网络接入。\n\nCNI 的主要职责是解决 Kubernetes Pod 之间的网络连通性，例如分配 IP 地址和转发数据包。相比之下，Ambient Mode 需要将流量导入 ztunnel，这与 CNI 的网络配置可能存在不兼容，主要问题包括：\n\n- 主流 CNI 的网络配置可能会与 Istio 的 CNI 扩展冲突，导致流量处理中断。\n- 如果部署的网络策略依赖于 CNI，那么使用 Istio CNI 时可能会影响这些策略的执行。\n\n为解决这些问题，可以通过将 ztunnel 运行在与 Pod 相同的用户空间中，避免与 CNI 修改过的内核空间的冲突。这样，Pod 可以直接连接到 ztunnel，绕过 CNI 的影响。\n\n下面的时序图描述了 Ambient mode 下的流程：\n\n\u0060\u0060\u0060mermaid \u0022Amibent mode 的运行流程\u0022\nsequenceDiagram\n    participant K8s_API as Kubernetes API\n    participant Plugin as CNI Plugin\n    participant Agent as Ambient CNI Agent\n    participant Server as Ambient Watch Server\n    participant Ztunnel as ztunnel\n\n    Plugin-\u003e\u003eAgent: CmdAdd (Pod 调度)\n    Agent-\u003e\u003eServer: 通知新的 Pod\n    Server-\u003e\u003eK8s_API: 检索 Pod 信息\n    K8s_API--\u003e\u003eServer: Pod 详情\n    Server-\u003e\u003eZtunnel: 设置 iptables\n    Ztunnel-\u003e\u003eServer: 确认设置\n    Server-\u003e\u003eAgent: 配置完成\n    Agent-\u003e\u003ePlugin: CmdDel (Pod 移除)\n    Server-\u003e\u003eZtunnel: 移除 iptables\n    Ztunnel--\u003e\u003eServer: 确认\n\u0060\u0060\u0060\n\n![Amibent mode 的运行流程](a513f6cb6fbbf1fd242a46a962706dd8.svg)\n\n\n\n- **Ambient CNI 代理** 通过监听信号着 Pod 创建的 UDS 事件来启动交互。\n- **Ambient 监控服务器** 根据需要修改 Pod 内的 iptables，将流量重定向到 ztunnel。\n- **ztunnel** 在 Kubernetes 集群内建立连接，并处理网络流量的重定向。\n\n## 解决 Istio Ambient Mode 和 Kubernetes CNI 的冲突 {#resolution}\n\n为缓解这些冲突，Istio 的 Ambient Mode 避免了对 CNI 修改过的内核空间的依赖：\n\n- **在用户空间运行 ztunnel**：这一策略让 ztunnel 与 Pod 运行在同一用户空间，避免了与 CNI 的直接冲突。\n- **确保 CNI 兼容性**：Istio CNI 配置必须在不影响现有 CNI 插件配置的前提下进行，确保 Pod 间的正常通信和流量管理。\n\n这些措施帮助 Istio 的 Ambient Mode 在不干扰现有 CNI 插件的情况下，有效管理服务间流量。\n\n## Istio Ambient Mode 的流量管理优化 {#optimization}\n\nAmbient Mode 在 Istio 中通过 **node-local Ztunnel** 实现了改进的流量转发机制，允许在 Pod 的网络命名空间中设置侦听套接字，实现从服务网格内部的加密（mTLS）和明文流量的有效重定向。这种方法不仅提高了流量管理的灵活性，还避免了与现有的 CNI 插件之间的潜在冲突。下面是该模式的具体实现流程：\n\n\u0060\u0060\u0060mermaid \u0022Ambient mode 的实现流程\u0022\ngraph TD\n    subgraph Kubernetes 集群\n    A[带有 istio.io\/dataplane-mode=ambient 的 Pod] --\u003e|被检测到| B(istio-cni 节点代理)\n    B --\u003e C{Pod 状态}\n    C --\u003e|新启动| D[CNI 插件触发]\n    C --\u003e|已运行| E[新 Pod 事件]\n    D \u0026 E --\u003e F[配置重定向]\n    F --\u003e|进入 Pod 的网络命名空间| G[建立网络重定向]\n    G --\u003e H[通知节点 Ztunnel]\n    H --\u003e|在 Pod 的命名空间中创建监听套接字| I[节点本地 Ztunnel 代理实例]\n    I --\u003e J[流量重定向已建立]\n    end\n\n    J --\u003e K{流量类型}\n    K --\u003e|mTLS| L[网格内的加密流量]\n    K --\u003e|明文| M[明文流量处理]\n\u0060\u0060\u0060\n\n![Ambient mode 的实现流程](37dcdcfa80a406219ebe4b580345b04d.svg)\n\n\n\n具体步骤如下：\n\n1. **侦测标记**：Istio CNI 节点代理侦测标记为 \u0060istio.io\/dataplane-mode=ambient\u0060 的 Pod。\n2. **触发 CNI 插件**：根据 Pod 事件（新启动或现有 Pod 加入网格）触发 CNI 插件，这一步会触发 Istio CNI 节点代理进行流量重定向配置。\n3. **配置重定向规则**：在 Pod 的网络命名空间内配置网络重定向规则，以便拦截并重定向至 node-local ztunnel 代理。\n4. **建立侦听套接字**：node-local ztunnel 在 Pod 的网络命名空间中创建侦听套接字，实现流量的重定向。\n5. **流量处理**：node-local ztunnel 处理网格内的加密（mTLS）和明文流量，确保数据传输的安全性和高效性。\n\n通过这种方法，Istio Ambient Mode 为 Kubernetes 环境中的服务间流量管理提供了一种更为高效和安全的解决方案。\n\n## 总结 {#summary}\n\n本文全面解析了 Istio CNI 插件的设计理念、实现方式和优势，特别是 Istio CNI 如何解决了传统 \u0060istio-init\u0060 方法中存在的权限和安全问题。通过这些创新，Istio 在网络安全和操作简便性上取得了重大进步，为 Kubernetes 环境中实施 Istio 提供了更灵活和高效的方法。\n', '\/blog\/istio-cni-deep-dive\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细解释了 Istio CNI 插件的设计理念、实现方式以及如何通过 Ambient Mode 提升安全性和权限管理。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/ambient-mesh-l7-traffic-path/">Istio Ambient 模式中的七层流量路由路径详解</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/11/17</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中的七层流量路由路径详解', '本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的七层（L7）流量路径。', '\n在[上一篇博客中](\/blog\/ambient-mesh-l4-traffic-path\/)我介绍了 Ambient 模式中的透明流量劫持和四层流量路由，在这一篇博客中，我将向你介绍在 Istio 的 Ambient 模式中，七层流量是如何路由的。\n\n下图展示了 Ambient 模式中七层网络流量路径。\n\n![Ambient Mesh 中的七层网络流量路径](ambient-mesh-l7-traffic-path.svg)\n\n注意：Waypoint Proxy 可以位于应用程序所在节点，甚至图中的服务 A、服务 B 和 Waypoint Proxy 都可以位于同一个节点，之所以将它们画在三个节点上是为了方便展示，但是对于实际的流量路径没有大的影响，只不过是不再通过 eth0 发送到另外一个节点。\n\n下文我们将从手操作探究图中过程。\n\n## 环境说明 {#environment}\n\n我们继续使用上一篇博客中部署的 Ambient 模式的 Istio，[查看环境说明](\/blog\/ambient-mesh-l4-traffic-path\/#environment)。为了说明七层网路路由，我们需要在此基础上再创建一个 Gateway：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: gateway.networking.k8s.io\/v1alpha2\nkind: Gateway\nmetadata:\n name: productpage\n annotations:\n   istio.io\/service-account: bookinfo-productpage\nspec:\n gatewayClassName: istio-mesh\nEOF\n\u0060\u0060\u0060\n\n执行完该命令后，\u0060default\u0060 命名空间下会创建了一个 Waypoint proxy，在我的环境中这个 pod 的名字是 \u0060bookinfo-productpage-waypoint-proxy-6f88c55d59-4dzdx\u0060，专门用于处理发往 productpage 服务（服务 B）的 L7 流量，我将它称之为 Waypoint Proxy B。\n\nWaypoint 代理可以位于与工作负载相同或者不同的节点上，它也可以部署在独立的命名空间中，不论它位于哪个节点，对于 L7 流量路径没有影响。\n\nAmbient mesh 中透明流量的方式在 L4 和 L7 网络中没有什么不同，因此在这篇博客中我们将略过 Inbound 和 Outbound 流量劫持部分，你可以查看[上一篇博客](\/blog\/ambient-mesh-l4-traffic-path\/)了解详情。\n\n下面我们将直接从流量被劫持到 Ztunnel A 后，被转发到 Envoy 的 15006 端口开始。\n\n## Ztunnel A 上的出站流量路由 {#ztunel-a-outbound}\n\n使用下面的命令导出 Ztunnel A 上的 Envoy 代理配置：\n\n\u0060\u0060\u0060bash\nkubectl exec -n istio-system ztunnel-hptxk -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003eztunnel-a-all-include-eds.json\n\u0060\u0060\u0060\n\n查看 \u0060ztunnel-a-all-include-eds.json\u0060 文件中的 Listener 配置部分，根据目的端口和来源 IP 的匹配关系，你将看到 \u0060ztunnel_outbound\u0060 监听器中有如下配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=2 12 18\u0022\u003e}}\n{\n  \u002210.8.14.226\u0022: {\n    \u0022matcher\u0022: {\n    \u0022matcher_tree\u0022: {\n      \u0022input\u0022: {\n      \u0022name\u0022: \u0022port\u0022,\n      \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput\u0022\n      }\n      },\n      \u0022exact_match_map\u0022: {\n      \u0022map\u0022: {\n        \u00229080\u0022: {\n        \u0022action\u0022: {\n          \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022,\n          \u0022typed_config\u0022: {\n          \u0022@type\u0022: \u0022type.googleapis.com\/google.protobuf.StringValue\u0022,\n          \u0022value\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022\n          }\n        }\n        }\n      }\n      }\n    }\n    }\n  }\n}\n{{\u003c\/highlight\u003e}}\n\n\u006010.8.14.226\u0060 是目标服务的 Cluster  IP，服务端口是 9080。流量将被路由到 \u0060spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0060 集群，查看该集群的配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022,\n  \u0022type\u0022: \u0022EDS\u0022,\n  \u0022eds_cluster_config\u0022: {\n   \u0022eds_config\u0022: {\n    \u0022ads\u0022: {},\n    \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n    \u0022resource_api_version\u0022: \u0022V3\u0022\n   }\n  },\n  \/* 省略 *\/\n}\n{{\u003c\/highlight\u003e}}\n\n该集群使用 EDS 服务发现。查看该集群的 EDS 信息：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=11 12\u0022\u003e}}\n{ \n \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.endpoint.v3.ClusterLoadAssignment\u0022,\n \u0022endpoints\u0022: [\n  {\n   \u0022locality\u0022: {},\n   \u0022lb_endpoints\u0022: [\n    {\n     \u0022endpoint\u0022: {\n      \u0022address\u0022: {\n       \u0022socket_address\u0022: {\n        \u0022address\u0022: \u002210.4.3.14\u0022,\n        \u0022port_value\u0022: 15006\n       }\n      },\n      \u0022health_check_config\u0022: {}\n     },\n     \u0022health_status\u0022: \u0022HEALTHY\u0022,\n     \u0022load_balancing_weight\u0022: 1\n    }\n   ]\n  }\n ],\n \u0022policy\u0022: {\n  \u0022overprovisioning_factor\u0022: 140\n }\n}\n{{\u003c\/highlight\u003e}}\n\n注意：这里还是缺少输出 \u0060cluster_name\u0060 字段。\n\n在这里直接将流量转发给 Waypoint Proxy 的端点 \u006010.4.3.14:15006\u0060。\n\n## Waypoint Proxy B 上的流量转发 {#waypoint-proxy-b}\n\n我们再导出 Waypoint Proxy B 中的 Envoy 配置：\n\n\u0060\u0060\u0060bash\nkubectl exec -n default bookinfo-productpage-waypoint-proxy-6f88c55d59-4dzdx -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003ewaypoint-a-all-include-eds.json\n\u0060\u0060\u0060\n\n查看 \u0060inbound_CONNECT_terminate\u0060 监听器的配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=7 10 11 39 44 58 62\u0022\u003e}}\n{\n  \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022,\n  \u0022active_state\u0022: {\n    \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n    \u0022listener\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n    \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022,\n    \u0022address\u0022: {\n      \u0022socket_address\u0022: {\n      \u0022address\u0022: \u00220.0.0.0\u0022,\n      \u0022port_value\u0022: 15006\n      }\n    },\n    \u0022filter_chains\u0022: [{\n      \u0022filters\u0022: [{\n        \u0022name\u0022: \u0022capture_tls\u0022,\n        \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n        \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.CaptureTLS\u0022\n        }\n      },\n      {\n        \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n        \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n        \u0022stat_prefix\u0022: \u0022inbound_hcm\u0022,\n        \u0022route_config\u0022: {\n          \u0022name\u0022: \u0022local_route\u0022,\n          \u0022virtual_hosts\u0022: [{\n          \u0022name\u0022: \u0022connect\u0022,\n          \u0022domains\u0022: [\n            \u0022*\u0022\n          ],\n          \u0022routes\u0022: [{...},\n            {\n            \u0022match\u0022: {\n              \u0022headers\u0022: [{\n              \u0022name\u0022: \u0022:authority\u0022,\n              \u0022exact_match\u0022: \u002210.8.14.226:9080\u0022\n              }],\n              \u0022connect_matcher\u0022: {}\n            },\n            \u0022route\u0022: {\n              \u0022cluster\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n              \u0022upgrade_configs\u0022: [{\n              \u0022upgrade_type\u0022: \u0022CONNECT\u0022,\n              \u0022connect_config\u0022: {}\n              }]\n            }\n            }\n          ]\n          }],\n          \u0022validate_clusters\u0022: false\n        },\n        \u0022http_filters\u0022: [...],\n        \u0022tracing\u0022: {...},\n        \u0022http2_protocol_options\u0022: {\n          \u0022allow_connect\u0022: true\n        },\n        \u0022use_remote_address\u0022: false,\n        \u0022upgrade_configs\u0022: [{\n          \u0022upgrade_type\u0022: \u0022CONNECT\u0022\n        }],\n        \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n        \u0022normalize_path\u0022: true,\n        \u0022request_id_extension\u0022: {...},\n        \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n        }\n      }\n      ],\n      \u0022transport_socket\u0022: {...},\n      \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022\n    }]\n    },\n    \u0022last_updated\u0022: \u00222022-11-17T06:24:51.467Z\u0022\n  }\n}\n{{\u003c\/highlight\u003e}}\n\n目的地为 \u006010.8.14.226:9080\u0060 的 TCP 流量将被转发到 \u0060inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0060，并将 HTTP 类型修改为 \u0060CONNECT\u0060，查看该集群的配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6 37\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n  \u0022type\u0022: \u0022STATIC\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022passthrough_metadata\u0022: [\n     {\n      \u0022kind\u0022: {\n       \u0022cluster\u0022: {}\n      },\n      \u0022name\u0022: \u0022istio\u0022\n     }\n    ],\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {},\n  \u0022load_assignment\u0022: {\n   \u0022cluster_name\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n   \u0022endpoints\u0022: [\n    {\n     \u0022lb_endpoints\u0022: [\n      {\n       \u0022endpoint\u0022: {\n        \u0022address\u0022: {\n         \u0022envoy_internal_address\u0022: {\n          \u0022server_listener_name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022\n         }\n        }\n       }\n      }\n     ]\n    }\n   ]\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.137Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n该集群的端点是一个内部监听器 \u0060inbound-vip|9080||productpage.default.svc.cluster.local\u0060：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=21-47 73-80\u0022\u003e}}\n{\n \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022,\n   \u0022filter_chains\u0022: [{\n    \u0022filters\u0022: [{\n      \u0022name\u0022: \u0022restore_tls\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n       \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.RestoreTLS\u0022\n      }\n     },\n     {\n      \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n       \u0022stat_prefix\u0022: \u0022inbound_0.0.0.0_9080\u0022,\n       \u0022route_config\u0022: {\n        \u0022name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n        \u0022virtual_hosts\u0022: [{\n         \u0022name\u0022: \u0022inbound|http|9080\u0022,\n         \u0022domains\u0022: [\n          \u0022*\u0022\n         ],\n         \u0022routes\u0022: [{\n          \u0022match\u0022: {\n           \u0022prefix\u0022: \u0022\/\u0022\n          },\n          \u0022route\u0022: {\n           \u0022cluster\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n           \u0022timeout\u0022: \u00220s\u0022,\n           \u0022max_stream_duration\u0022: {\n            \u0022max_stream_duration\u0022: \u00220s\u0022,\n            \u0022grpc_timeout_header_max\u0022: \u00220s\u0022\n           }\n          },\n          \u0022decorator\u0022: {\n           \u0022operation\u0022: \u0022:9080\/*\u0022\n          },\n          \u0022name\u0022: \u0022default\u0022\n         }]\n        }],\n        \u0022validate_clusters\u0022: false\n       }\n      },\n      \u0022server_name\u0022: \u0022istio-envoy\u0022,\n      \u0022use_remote_address\u0022: false,\n      \u0022forward_client_cert_details\u0022: \u0022APPEND_FORWARD\u0022,\n      \u0022set_current_client_cert_details\u0022: {\n       \u0022subject\u0022: true,\n       \u0022dns\u0022: true,\n       \u0022uri\u0022: true\n      },\n      \u0022upgrade_configs\u0022: [{\n       \u0022upgrade_type\u0022: \u0022websocket\u0022\n      }],\n      \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n      \u0022normalize_path\u0022: true,\n      \u0022request_id_extension\u0022: {\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig\u0022,\n        \u0022use_request_id_for_trace_sampling\u0022: true\n       }\n      },\n      \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n     }\n    ],\n    \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local-http\u0022\n   }],\n   \u0022listener_filters\u0022: [{\n     \u0022name\u0022: \u0022set_dst_address\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n      \u0022value\u0022: {}\n     }\n    },\n    {\n     \u0022name\u0022: \u0022envoy.filters.listener.metadata_to_peer_node\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.telemetry.metadatatopeernode.v1.Config\u0022\n     }\n    }\n   ],\n   \u0022traffic_direction\u0022: \u0022INBOUND\u0022,\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.300Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\n数据包被转发到 \u0060inbound-vip|9080|http|productpage.default.svc.cluster.local\u0060 集群：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n  \u0022type\u0022: \u0022EDS\u0022,\n  \u0022eds_cluster_config\u0022: {\n   \u0022eds_config\u0022: {\n    \u0022ads\u0022: {},\n    \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n    \u0022resource_api_version\u0022: \u0022V3\u0022\n   },\n   \u0022service_name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022\n  },\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022metadata\u0022: {\n   \u0022filter_metadata\u0022: {\n    \u0022istio\u0022: {\n     \u0022services\u0022: [{\n      \u0022namespace\u0022: \u0022default\u0022,\n      \u0022name\u0022: \u0022productpage\u0022,\n      \u0022host\u0022: \u0022productpage.default.svc.cluster.local\u0022\n     }]\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {}\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.138Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n该集群是 EDS 类型，查看 Endpoint 配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=14\u0022\u003e}}\n{\n \u0022endpoint_config\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.endpoint.v3.ClusterLoadAssignment\u0022,\n  \u0022cluster_name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n  \u0022endpoints\u0022: [{\n   \u0022locality\u0022: {\n    \u0022region\u0022: \u0022us-west2\u0022,\n    \u0022zone\u0022: \u0022us-west2-a\u0022\n   },\n   \u0022lb_endpoints\u0022: [{\n    \u0022endpoint\u0022: {\n     \u0022address\u0022: {\n      \u0022envoy_internal_address\u0022: {\n       \u0022server_listener_name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022\n      }\n     },\n     \u0022health_check_config\u0022: {}\n    },\n    \u0022health_status\u0022: \u0022HEALTHY\u0022,\n    \u0022metadata\u0022: {\n     \u0022filter_metadata\u0022: {\n      \u0022istio\u0022: {\n       \u0022workload\u0022: \u0022productpage-v1;default;productpage;v1;Kubernetes\u0022\n      }\n     }\n    },\n    \u0022load_balancing_weight\u0022: 1\n   }]\n  }],\n  \u0022policy\u0022: {\n   \u0022overprovisioning_factor\u0022: 140\n  }\n }\n}\n{{\u003c\/highlight\u003e}}\n\n数据包被转发到 \u0060inbound-pod|9080||10.4.0.5\u0060 监听器：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=33\u0022\u003e}}\n\n{\n \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n   \u0022filter_chains\u0022: [{\n    \u0022filters\u0022: [{\n      \u0022name\u0022: \u0022restore_tls\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n       \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.RestoreTLS\u0022\n      }\n     },\n     {\n      \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n       \u0022stat_prefix\u0022: \u0022inbound_0.0.0.0_9080\u0022,\n       \u0022route_config\u0022: {\n        \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n        \u0022virtual_hosts\u0022: [{\n         \u0022name\u0022: \u0022inbound|http|9080\u0022,\n         \u0022domains\u0022: [\n          \u0022*\u0022\n         ],\n         \u0022routes\u0022: [{\n          \u0022match\u0022: {\n           \u0022prefix\u0022: \u0022\/\u0022\n          },\n          \u0022route\u0022: {\n           \u0022cluster\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n           \u0022timeout\u0022: \u00220s\u0022,\n           \u0022max_stream_duration\u0022: {\n            \u0022max_stream_duration\u0022: \u00220s\u0022,\n            \u0022grpc_timeout_header_max\u0022: \u00220s\u0022\n           }\n          },\n          \u0022decorator\u0022: {\n           \u0022operation\u0022: \u0022:9080\/*\u0022\n          },\n          \u0022name\u0022: \u0022default\u0022\n         }]\n        }],\n        \u0022validate_clusters\u0022: false\n       },\n       \u0022http_filters\u0022: [{\n        \u0022name\u0022: \u0022envoy.filters.http.rbac\u0022,\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.http.rbac.v3.RBAC\u0022,\n         \u0022rules\u0022: {\n          \u0022policies\u0022: {\n           \u0022ns[default]-policy[productpage-viewer]-rule[0]\u0022: {\n            \u0022permissions\u0022: [{\n             \u0022and_rules\u0022: {\n              \u0022rules\u0022: [{\n               \u0022any\u0022: true\n              }]\n             }\n            }],\n            \u0022principals\u0022: [{\n             \u0022and_ids\u0022: {\n              \u0022ids\u0022: [{\n               \u0022or_ids\u0022: {\n                \u0022ids\u0022: [{\n                  \u0022authenticated\u0022: {\n                   \u0022principal_name\u0022: {\n                    \u0022exact\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022\n                   }\n                  }\n                 },\n                 {\n                  \u0022authenticated\u0022: {\n                   \u0022principal_name\u0022: {\n                    \u0022exact\u0022: \u0022spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\u0022\n                   }\n                  }\n                 }\n                ]\n               }\n              }]\n             }\n            }]\n           }\n          }\n         },\n         \u0022shadow_rules_stat_prefix\u0022: \u0022istio_dry_run_allow_\u0022\n        }\n       }],\n       \u0022server_name\u0022: \u0022istio-envoy\u0022,\n       \u0022use_remote_address\u0022: false,\n       \u0022forward_client_cert_details\u0022: \u0022APPEND_FORWARD\u0022,\n       \u0022set_current_client_cert_details\u0022: {\n        \u0022subject\u0022: true,\n        \u0022dns\u0022: true,\n        \u0022uri\u0022: true\n       },\n       \u0022upgrade_configs\u0022: [{\n        \u0022upgrade_type\u0022: \u0022websocket\u0022\n       }],\n       \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n       \u0022normalize_path\u0022: true,\n       \u0022request_id_extension\u0022: {\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig\u0022,\n         \u0022use_request_id_for_trace_sampling\u0022: true\n        }\n       },\n       \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n      }\n     }\n    ],\n    \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5-http\u0022\n   }],\n   \u0022listener_filters\u0022: [{\n    \u0022name\u0022: \u0022set_dst_address\u0022,\n    \u0022typed_config\u0022: {\n     \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n     \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n     \u0022value\u0022: {}\n    }\n   }],\n   \u0022traffic_direction\u0022: \u0022INBOUND\u0022,\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.339Z\u0022\n }\n}\n\n{{\u003c\/highlight\u003e}}\n\n数据包被转发到 \u0060inbound-pod|9080||10.4.0.5\u0060 集群：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6 43 48-55\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n  \u0022type\u0022: \u0022STATIC\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022passthrough_metadata\u0022: [\n     {\n      \u0022kind\u0022: {\n       \u0022host\u0022: {}\n      },\n      \u0022name\u0022: \u0022tunnel\u0022\n     },\n     {\n      \u0022kind\u0022: {\n       \u0022host\u0022: {}\n      },\n      \u0022name\u0022: \u0022istio\u0022\n     }\n    ],\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {},\n  \u0022load_assignment\u0022: {\n   \u0022cluster_name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n   \u0022endpoints\u0022: [\n    {\n     \u0022lb_endpoints\u0022: [\n      {\n       \u0022endpoint\u0022: {\n        \u0022address\u0022: {\n         \u0022envoy_internal_address\u0022: {\n          \u0022server_listener_name\u0022: \u0022inbound_CONNECT_originate\u0022,\n          \u0022endpoint_id\u0022: \u002210.4.0.5:9080\u0022\n         }\n        }\n       },\n       \u0022metadata\u0022: {\n        \u0022filter_metadata\u0022: {\n         \u0022tunnel\u0022: {\n          \u0022destination\u0022: \u002210.4.0.5:9080\u0022,\n          \u0022address\u0022: \u002210.4.0.5:15008\u0022\n         }\n        }\n       }\n      }\n     ]\n    }\n   ]\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.139Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n该集群是 \u0060STATIC\u0060 类型，其中包含了 HBONE 隧道配置（HTTP\/2 CONNECT 地址是 \u006010.4.0.15008\u0060），端点是 Envoy 内部监听器 \u0060inbound_CONNECT_originate\u0060：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=16-27 33 36\u0022\u003e}}\n{\n \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n   \u0022filter_chains\u0022: [\n    {\n     \u0022filters\u0022: [\n      {\n       \u0022name\u0022: \u0022envoy.filters.network.tcp_proxy\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy\u0022,\n        \u0022stat_prefix\u0022: \u0022inbound_CONNECT_originate\u0022,\n        \u0022cluster\u0022: \u0022inbound_CONNECT_originate\u0022,\n        \u0022tunneling_config\u0022: {\n         \u0022hostname\u0022: \u0022%DYNAMIC_METADATA(tunnel:destination)%\u0022,\n         \u0022headers_to_add\u0022: [\n          {\n           \u0022header\u0022: {\n            \u0022key\u0022: \u0022x-envoy-original-dst-host\u0022,\n            \u0022value\u0022: \u0022%DYNAMIC_METADATA([\\\u0022tunnel\\\u0022, \\\u0022destination\\\u0022])%\u0022\n           }\n          }\n         ]\n        }\n       }\n      }\n     ]\n    }\n   ],\n   \u0022use_original_dst\u0022: false,\n   \u0022listener_filters\u0022: [\n    {\n     \u0022name\u0022: \u0022set_dst_address\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n      \u0022value\u0022: {}\n     }\n    }\n   ],\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.339Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- \u0060listener_filters\u0060 中的 \u0060set_dst_address\u0060 将目的地地址设置为 \u006010.4.0.5.15008\u0060；\n- 在隧道中新增了一个 Header：\u0060x-envoy-original-dst-host\u0060，它的值是 \u006010.4.0.5:9080\u0060；\n- 该集群的端点是 \u0060inbound_CONNECT_originate\u0060 集群；\n\n查看 \u0060inbound_CONNECT_originate\u0060 集群：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n  \u0022type\u0022: \u0022ORIGINAL_DST\u0022,\n  \u0022connect_timeout\u0022: \u00222s\u0022,\n  \u0022lb_policy\u0022: \u0022CLUSTER_PROVIDED\u0022,\n  \u0022cleanup_interval\u0022: \u002260s\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.tls\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext\u0022,\n    \u0022common_tls_context\u0022: {\n     \u0022tls_params\u0022: {\n      \u0022tls_minimum_protocol_version\u0022: \u0022TLSv1_3\u0022,\n      \u0022tls_maximum_protocol_version\u0022: \u0022TLSv1_3\u0022\n     },\n     \u0022alpn_protocols\u0022: [\n      \u0022h2\u0022\n     ],\n     \u0022tls_certificate_sds_secret_configs\u0022: [\n      {\n       \u0022name\u0022: \u0022default\u0022,\n       \u0022sds_config\u0022: {\n        \u0022api_config_source\u0022: {\n         \u0022api_type\u0022: \u0022GRPC\u0022,\n         \u0022grpc_services\u0022: [\n          {\n           \u0022envoy_grpc\u0022: {\n            \u0022cluster_name\u0022: \u0022sds-grpc\u0022\n           }\n          }\n         ],\n         \u0022set_node_on_first_message_only\u0022: true,\n         \u0022transport_api_version\u0022: \u0022V3\u0022\n        },\n        \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n        \u0022resource_api_version\u0022: \u0022V3\u0022\n       }\n      }\n     ],\n     \u0022combined_validation_context\u0022: {\n      \u0022default_validation_context\u0022: {\n       \u0022match_subject_alt_names\u0022: [\n        {\n         \u0022prefix\u0022: \u0022spiffe:\/\/cluster.local\/\u0022\n        }\n       ]\n      },\n      \u0022validation_context_sds_secret_config\u0022: {\n       \u0022name\u0022: \u0022ROOTCA\u0022,\n       \u0022sds_config\u0022: {\n        \u0022api_config_source\u0022: {\n         \u0022api_type\u0022: \u0022GRPC\u0022,\n         \u0022grpc_services\u0022: [\n          {\n           \u0022envoy_grpc\u0022: {\n            \u0022cluster_name\u0022: \u0022sds-grpc\u0022\n           }\n          }\n         ],\n         \u0022set_node_on_first_message_only\u0022: true,\n         \u0022transport_api_version\u0022: \u0022V3\u0022\n        },\n        \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n        \u0022resource_api_version\u0022: \u0022V3\u0022\n       }\n      }\n     }\n    }\n   }\n  },\n  \u0022typed_extension_protocol_options\u0022: {\n   \u0022envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022,\n    \u0022explicit_http_config\u0022: {\n     \u0022http2_protocol_options\u0022: {\n      \u0022allow_connect\u0022: true\n     }\n    }\n   }\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.140Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n该集群的类型是 \u0060ORIGINAL_DST\u0060，直接与上游建立 HBONE 隧道，将数据包发送到 Pod B 的 15008 端口。在节点 B 的 Ztunnel 的流量劫持和路由方式就跟 L4 是一样的了，在这里不再赘述。\n\n## 总结 {#summary}\n\nL7 流量路由是在 L4 的基础上增加了 Waypoint 代理，该代理中 Envoy 处理比较复杂。Waypoint 代理使用 Gateway API 生成基于 Deployment 部署的，我们可以根据个别服务的负载情况，单独扩缩容其 Waypoint 代理，也可以创建 HPA 来动态扩容。\n\n## 参考 {#reference}\n\n- [Original destination - envoyproxy.io](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/upstream\/service_discovery#arch-overview-service-discovery-types-original-destination)\n- [一文读懂 Ambient Mesh 七层服务治理 - mp.weixin.qq.com](https:\/\/mp.weixin.qq.com\/s\/TXMyxbzBSfuYNquOZJmZTg)\n', '\/blog\/ambient-mesh-l7-traffic-path\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的七层（L7）流量路径。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/ambient-mesh-l4-traffic-path/">Istio Ambient 模式中的透明流量劫持四层网络路由路径详解</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/11/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中的透明流量劫持四层网络路由路径详解', '本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。', '\n本文通过动手操作，带领读者一步步了解 Istio ambient 模式中的四层流量路径。如果你还不了解什么是 Ambient 模式，以下文章可以帮助你了解：\n\n- [关于 Istio 推出 Ambient 数据平面模式的看法](\/blog\/istio-ambient-mode\/)\n- [Istio 无 sidecar 代理数据平面 ambient 模式简介](https:\/\/cloudnative.to\/blog\/introducing-ambient-mesh\/)\n- [Istio 服务网格 ambient 模式安全详解](https:\/\/cloudnative.to\/blog\/ambient-security\/)\n- [什么是 Ambient Mesh，它与 sidecar 模式有什么区别？](https:\/\/cloudnative.to\/blog\/what-is-ambient-mesh\/)\n\n如果你想略过实际动手步骤，只是想知道 Ambient 模式中的四层流量路径，请看下面服务 A 的一个 Pod 访问不同节点上服务 B 的 Pod 的四层流量路径图。\n\n![Ambient 模式中的四层流量路径](ambient-mesh-l4-traffic-path.svg)\n\n## 原理 {#principles}\n\nAmbient 模式使用 **tproxy** 和 **HBONE** 这两个关键技术实现透明流量劫持和路由的：\n\n- 使用 tproxy 将主机 Pod 中的流量劫持到 Ztunnel（Envoy Proxy）中，实现透明流量劫持；\n- 使用 HBONE 建立在 Ztunnel 之间传递 TCP 数据流隧道；\n\n### 什么是 tproxy？{#what-is-tproxy}\n\n\u0060tproxy\u0060 是 Linux 内核自 2.2 版本以来支持的透明代理（Transparent proxy），其中的 t 代表 transparent，即透明。你需要在内核配置中启用 \u0060NETFILTER_TPROXY\u0060 和策略路由。通过 tproxy，Linux 内核就可以作为一个路由器，将数据包重定向到用户空间。详见 [tproxy 文档](http:\/\/lxr.linux.no\/linux\u002bv3.10\/Documentation\/networking\/tproxy.txt) 。\n\n### 什么是 HBONE？{#what-is-hbone}\n\nHBONE 是 HTTP-Based Overlay Network Environment 的缩写，是一种使用 HTTP 协议提供隧道能力的方法。客户端向 HTTP 代理服务器发送 HTTP CONNECT 请求（其中包含了目的地址）以建立隧道，代理服务器代表客户端与目的地建立 TCP 连接，然后客户端就可以通过代理服务器透明的传输 TCP 数据流到目的服务器。在 Ambient 模式中，Ztunnel（其中的 Envoy）实际上是充当了透明代理，它使用 [Envoy Internal Listener](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/other_features\/internal_listener) 来接收 HTTP CONNECT 请求和传递 TCP 流给上游集群。\n\n## 环境说明 {#environment}\n\n在开始动手操作之前，需要先说明一下笔者的演示环境，本文中对应的对象名称：\n\n| 代号           | 名称                                         | IP            |\n| -------------- | -------------------------------------------- | ------------- |\n| 服务 A Pod     | sleep-5644bdc767-2dfg7                       | 10.4.4.19     |\n| 服务 B Pod     | productpage-v1-5586c4d4ff-qxz9f              | 10.4.3.20     |\n| Ztunnel A Pod  | ztunnel-rts54                                | 10.4.4.18     |\n| Ztunnel B Pod  | ztunnel-z4qmh                                | 10.4.3.14     |\n| 节点 A         | gke-jimmy-cluster-default-pool-d5041909-d10i | 10.168.15.222 |\n| 节点 B         | gke-jimmy-cluster-default-pool-d5041909-c1da | 10.168.15.224 |\n| 服务 B Cluster | productpage                                  | 10.8.14.226   |\n\n注意：因为这些名称将在后续的命令行中用到，文中将使用代称，以便你在自己的环境中实验。\n\n笔者在 GKE 中安装了 Ambient 模式的 Istio，请参考[该步骤](\/blog\/istio-ambient-mode\/#setup)安装，注意不要安装 Gateway，以免启用 L7 功能，否则流量路径将于 L4 流量不同。\n\n下面我们将动手实验，深入探究 \u0060sleep\u0060 服务的 Pod 访问不同节点上 \u0060productpage\u0060 服务的 Pod 的四层流量路径。我们将分别检视 Pod 的 outbound 和 inbound 流量。\n\n## Outbound 流量劫持 {#outbound}\n\nAmbient mesh 的 pod 出站流量的透明流量劫持流程如下：\n\n1. Istio CNI 在节点上创建 \u0060istioout\u0060 网卡和 iptables 规则，将 Ambient mesh 中的 Pod IP 加入 [IP 集](https:\/\/ipset.netfilter.org\/)，并通过 netfilter \u0060nfmark\u0060 标记和路由规则，将 Ambient mesh 中的出站流量通过 Geneve 隧道透明劫持到 \u0060pistioout\u0060 虚拟网卡；\n2. ztunnel 中的 init 容器创建 iptables 规则，将 \u0060pistioout\u0060 网卡中的所有流量转发到 ztunnel 中的 Envoy 代理的 15001 端口；\n3. Envoy 对数据包进行处理，并与上游端点建立 HBONE 隧道（HTTP CONNECT），将数据包转发到上游。\n\n### 检查节点 A 上的路由规则 {#node-a-rules}\n\n登录到服务 A 所在的节点 A，使用 \u0060iptables-save\u0060 查看规则：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=3 4 6 35\u0022\u003e}}\n$ iptables-save\n\/* 省略 *\/\n-A PREROUTING -j ztunnel-PREROUTING\n-A PREROUTING -m comment --comment \u0022kubernetes service portals\u0022 -j KUBE-SERVICES\n-A ztunnel-POSTROUTING -m mark --mark 0x100\/0x100 -j ACCEPT\n-A ztunnel-PREROUTING -m mark --mark 0x100\/0x100 -j ACCEPT\n\/* 省略 *\/\n*mangle\n\/* 省略 *\/\n-A PREROUTING -j ztunnel-PREROUTING\n-A INPUT -j ztunnel-INPUT\n-A FORWARD -j ztunnel-FORWARD\n-A OUTPUT -j ztunnel-OUTPUT\n-A OUTPUT -s 169.254.169.254\/32 -j DROP\n-A POSTROUTING -j ztunnel-POSTROUTING\n-A ztunnel-FORWARD -m mark --mark 0x220\/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220\n-A ztunnel-FORWARD -m mark --mark 0x210\/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210\n-A ztunnel-INPUT -m mark --mark 0x220\/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220\n-A ztunnel-INPUT -m mark --mark 0x210\/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210\n-A ztunnel-OUTPUT -s 10.4.4.1\/32 -j MARK --set-xmark 0x220\/0xffffffff\n-A ztunnel-PREROUTING -i istioin -j MARK --set-xmark 0x200\/0x200\n-A ztunnel-PREROUTING -i istioin -j RETURN\n-A ztunnel-PREROUTING -i istioout -j MARK --set-xmark 0x200\/0x200\n-A ztunnel-PREROUTING -i istioout -j RETURN\n-A ztunnel-PREROUTING -p udp -m udp --dport 6081 -j RETURN\n-A ztunnel-PREROUTING -m connmark --mark 0x220\/0x220 -j MARK --set-xmark 0x200\/0x200\n-A ztunnel-PREROUTING -m mark --mark 0x200\/0x200 -j RETURN\n-A ztunnel-PREROUTING ! -i veth300a1d80 -m connmark --mark 0x210\/0x210 -j MARK --set-xmark 0x40\/0x40\n-A ztunnel-PREROUTING -m mark --mark 0x40\/0x40 -j RETURN\n-A ztunnel-PREROUTING ! -s 10.4.4.18\/32 -i veth300a1d80 -j MARK --set-xmark 0x210\/0x210\n-A ztunnel-PREROUTING -m mark --mark 0x200\/0x200 -j RETURN\n-A ztunnel-PREROUTING -i veth300a1d80 -j MARK --set-xmark 0x220\/0x220\n-A ztunnel-PREROUTING -p udp -j MARK --set-xmark 0x220\/0x220\n-A ztunnel-PREROUTING -m mark --mark 0x200\/0x200 -j RETURN\n-A ztunnel-PREROUTING -p tcp -m set --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100\/0x100\n{{\u003c\/highlight\u003e}}\n\niptables 规则说明：\n\n- 第 3 行：PREROUTING 链是最先运行的，所有数据包将先进入 \u0060ztunnel-PREROUTING\u0060 链；\n- 第 4 行：将数据包发往 \u0060KUBE-SERVICES\u0060 链，在那里将 Kubernetes Service 的 Cluster IP 进行 DNAT 转换为 Pod IP；\n- 第 6 行：带有 \u00600x100\/0x100\u0060 标记的数据包通过 PREROUTING 链，不再经过 \u0060KUBE-SERVICES\u0060 链；\n- 第 35 行：这是添加到 \u0060ztunnel-PREROUTING\u0060 链上的最后一条规则，进入 \u0060ztunnel-PREROUTING\u0060 链中的在 \u0060ztunnel-pods-ips\u0060 IP 集中的所有 TCP 数据包都会被打上 \u00600x100\/0x100\u0060 的标记，它将覆盖前面的所有标记；\n\n{{\u003ccallout note \u0022关于 iptables 设置 mark 和 xmark 标记\u0022\u003e}}\n\n\u0060MARK\u0060 这个扩展目标可以用来给数据包打标记，标记分两种：一种是用于标记链接的 \u0060ctmark\u0060，一种是用于标记数据包的 \u0060nfmark\u0060 。\u0060nfmark\u0060占四个字节共 32 位，我们可以把它看成是一个长度为 32 位的无符号整数，一般用 16 进制来表示。\n\nMark 的设置一共有五个选项，分别是 \u0060--set-xmark\u0060、\u0060--set-mark\u0060、\u0060--and-mark\u0060、\u0060--and-mark\u0060、\u0060--or-mark\u0060 和 \u0060--xor-mark\u0060。在本文用到了前两种，下面将分别为大家介绍。\n\n**\u0060--set-xmark value[\/mask]\u0060**\n\n上面的 \u0060value\u0060 和掩码 \u0060mask\u0060 都是 32 位无符号整数，一般用 16 进制表示。内核设置数据包 nfmark 值的流程分为两步：\n\n1. 首先，内核会先用 mask 预处理数据包原来的 nfmark，处理方法是：如果 mask 的第 N 位（二进制）为 1，则将数据包的 nfmark 第的 N 位（二进制）清零（Zero out） ，如果 mask 的第 N 位为 0，那么数据包的 nfmark 位保持不变\n2. 再用上面预处理后的 nfmark 和 value 做异或运算，得到数据包最后的 nfmark 值。\n\n举个例子：假设我们设置了 \u0060--set-xmark 0x4000\/0xffffffff\u0060，掩码为 \u00600xffffffff\u0060，掩码表示为二进制的话 32 位每一位都是 \u00601\u0060，那么内核首先会将数据包原来的 \u0060nfmark\u0060 所有的位都清零（异或运算，相当于是先把 \u0060nfmark\u0060 置 0），然后再和 value 做异或操作，那么得到的最后的 \u0060nfmark\u0060 值就是 \u00600x4000\u0060。所以，数据包经过这条规则后，它的 nfmark 值就是 \u00600x4000\u0060。\n\n上面的掩码 \u0060mask\u0060 是个可选项，如果没有设置的话，默认为 \u00600xffffffff\u0060。\n\n根据上面的规则，省略 \u0060mask\u0060 的值或者将 \u0060mask\u0060 和 \u0060value\u0060 的值设置成一样可以快速设置数据包的 \u0060nfmark\u0060 值为 \u0060value\u0060。读者可以自己推导一下：\u0060value XOR 0xFFFFFFFF XOR value =value\u0060，\u0060value XOR value XOR value = value\u0060。\n\n**\u0060--set-mark value[\/mask]\u0060**\n\n设置步骤与上文类似。第一步预处理也是将原来的 \u0060nfmark\u0060 与 mask 进行异或运算，第二步不同，该方法是将预处理的 nfmark 和 value 做或（OR）运算。\n\n根据上面的规则，省略 \u0060mask\u0060 的值，或者将 \u0060mask\u0060 与 \u0060value\u0060 值设置成一样可以快速设置数据包的 \u0060nfmark\u0060 值为 \u0060value\u0060。读者可以自己推导一下：\u0060value XOR 0xFFFFFFFF OR value = value\u0060，\u00600 OR value = value\u0060）。\n\n查看 [netfilter 文档](https:\/\/ipset.netfilter.org\/iptables-extensions.man.html#lbDD) 了解详情。\n\n{{\u003c\/callout\u003e}}\n\n通过执行以上 iptables 规则，可以确保 Ambient Mesh 仅拦截 \u0060ztunnel-pods-ips\u0060 IP 集 Pod 中的数据包并给数据包打上 \u00600x100\/0x100\u0060 标记（\u0060nfmark\u0060，格式为 \u0060值\/掩码\u0060，值和掩码都是 32 位的二进制整数，），而不影响其他 Pod。\n\n{{\u003ccallout note \u0022关于 ztunnel-pods-ips IP 集\u0022\u003e}}\n\n\u0060ztunnel-pods-ips\u0060 是由 Istio CNI 创建的 [IP 集（IP Set）](https:\/\/ipset.netfilter.org\/)，这里面保存着该节点上 Ambient Mesh 中的所有 Pod 的 IP 地址。IP 集是 Linux 内核中的一个框架，可由 [ipset](https:\/\/ipset.netfilter.org\/ipset.man.html) 实用程序管理。IP 集可以存储不同类型的数据，例如 IP 地址、网络、（TCP\/UDP）端口号、MAC 地址、接口名称或它们的组合，从而确保在条目与集合匹配时具有闪电般的速度。\n\n{{\u003c\/callout\u003e}}\n\n{{\u003cdetail \u0022用 \u0060iptables -t nat -L\u0060 按顺序查看 iptables 规则，将可以更明显的看到路由路径。\u0022\u003e}}\n\n\u0060\u0060\u0060bash\n$ iptables -t nat -L\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination\n# 数据包首先进入 ztunnel-PREROUTING 链处理\nztunnel-PREROUTING  all  --  anywhere             anywhere\n# 然后进入 KUBE-SERVICES 链处理\nKUBE-SERVICES  all  --  anywhere             anywhere             \/* kubernetes service portals *\/\n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination         \n\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination         \nKUBE-SERVICES  all  --  anywhere             anywhere             \/* kubernetes service portals *\/\n\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination         \nztunnel-POSTROUTING  all  --  anywhere             anywhere            \nKUBE-POSTROUTING  all  --  anywhere             anywhere             \/* kubernetes postrouting rules *\/\nIP-MASQ    all  --  anywhere             anywhere             \/* ip-masq: ensure nat POSTROUTING directs all non-LOCAL destination traffic to our custom IP-MASQ chain *\/ ADDRTYPE match dst-type !LOCAL\n\n\/* Omit KUBE-SVC chains *\/\n\nChain ztunnel-POSTROUTING (1 references)\ntarget     prot opt source               destination         \nACCEPT     all  --  anywhere             anywhere             mark match 0x100\/0x100\n\nChain ztunnel-PREROUTING (1 references)\ntarget     prot opt source               destination   \n# 通过所有被打上 0x100\/0x100 标记的数据包\nACCEPT     all  --  anywhere             anywhere             mark match 0x100\/0x100\n\u0060\u0060\u0060\n\n{{\u003c\/detail\u003e}}\n\n我们再查看一下该节点的路由规则：\n\n\u0060\u0060\u0060bash\n$ ip rule\n0:      from all lookup local\n100:    from all fwmark 0x200\/0x200 goto 32766\n101:    from all fwmark 0x100\/0x100 lookup 101\n102:    from all fwmark 0x40\/0x40 lookup 102\n103:    from all lookup 100\n32766:  from all lookup main\n32767:  from all lookup default\n\u0060\u0060\u0060\n\n路由表将按顺序执行，第一列表示的是路由表的优先级，第二列表示要查找或跳转的路由表。你会看到所有带有 \u00600x100\/0x100\u0060 标记的数据包将查找 101 路由表。我们再查看一下该路由表：\n\n\u0060\u0060\u0060bash\n$ ip route show table 101\ndefault via 192.168.127.2 dev istioout \n10.4.4.18 dev veth52b75946 scope link \n\u0060\u0060\u0060\n\n你会看到 \u0060101\u0060 路由表中带有关键字 \u0060via\u0060 ，这表示数据包将通过网关传输，查看 [ip route 命令的用法](http:\/\/linux-ip.net\/html\/tools-ip-route.html#tools-ip-route-show)。所有数据包被通过 \u0060istioout\u0060 网卡发送到网关（IP 是 \u0060192.168.127.2\u0060）。另一行表示是当前节点上 ztunnel pod 的路由链路。\n\n{{\u003ccallout note  \u0022关于 101 路由表\u0022\u003e}}\n所谓路由表（Routing Table），指的是路由器或者其他互联网网络设备上存储的表，该表中存有到达特定网络终端的路径。路由器的主要工作就是为经过路由器的每个数据包寻找一条最佳的传输路径，并将该数据有效地传送到目的站点。为了完成这项工作，在路由器中保存着各种传输路径的相关数据，供路由选择时使用，表中包含的信息决定了数据转发的策略。路由表根据其建立的方法，可以分为**动态路由表**和**静态路由表**。\n\n101 路由表是由 Istio CNI 创建的，它的作用是将带有 \u00600x100\/0x00\u0060 fwmark 的数据包转发到 ztunnel 中。\n\n在 Linux 系统中，用户可以自定义编号 1 到 252 的路由表，Linux 系统维护了 4 个路由表：\n\n- 0：系统保留表\n- 253：defulte 表，没特别指定的默认路由都放在改表\n- 254：main 表，没指明路由表的所有路由放在该表，默认表，我们使用 \u0060ip route list\u0060 或 \u0060route -n\u0060 或 \u0060netstat -rn\u0060 查看的路由记录即为 main 表中的记录\n- 255：locale 表，保存本地接口地址，广播地址、NAT 地址 由系统维护，用户不得更改\n\n{{\u003c\/callout\u003e}}\n\n我们再查看一下 \u0060istioout\u0060 网卡的详细信息：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=4 5\u0022\u003e}}\n$ ip -d addr show istioout\n24: istioout: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1410 qdisc noqueue state UNKNOWN group default \n    link\/ether 62:59:1b:ad:79:01 brd ff:ff:ff:ff:ff:ff\n    geneve id 1001 remote 10.4.4.18 ttl auto dstport 6081 noudpcsum udp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n    inet 192.168.127.1\/30 brd 192.168.127.3 scope global istioout\n       valid_lft forever preferred_lft forever\n    inet6 fe80::6059:1bff:fead:7901\/64 scope link \n       valid_lft forever preferred_lft forever\n{{\u003c\/highlight\u003e}}\n\nPod A 中的 \u0060istioout\u0060 网卡通过 Geneve tunnel 与 ztunnel A 中的 \u0060pstioout\u0060 网卡连通。\n\n{{\u003ccallout note \u0022关于 istioout 网卡\u0022\u003e}}\n\n\u0060istioout\u0060 是一个 [Geneve（Generic Network Virtualization Encapsulation）](https:\/\/datatracker.ietf.org\/doc\/html\/draft-gross-geneve-00)类型的虚拟网卡，它的 IP 是 \u0060192.168.127.1\u0060，远端是 \u006010.4.2.19\u0060（节点 A 上的 ztunnel Pod 的 IP），网关是 \u0060192.168.127.2\u0060（节点 A 上 ztunnel Pod 中 \u0060pistioout\u0060 网卡的 IP，在下文会看到）。\n\n{{\u003c\/callout\u003e}}\n\n### 检查 Ztunnel A 上的路由规则 {#ztunnel-a-rules}\n\n进入 Ztunnel A Pod，使用 \u0060ip -d a\u0060 命令检查它的网卡信息：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=11-20\u0022\u003e}}\n$ ip -d a\n1: lo: \u003cLOOPBACK,UP,LOWER_UP\u003e mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link\/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 minmtu 0 maxmtu 0 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n    inet 127.0.0.1\/8 scope host lo\n       valid_lft forever preferred_lft forever\n2: eth0@if16: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1460 qdisc noqueue state UP group default \n    link\/ether 06:3e:d1:5d:95:16 brd ff:ff:ff:ff:ff:ff link-netnsid 0 promiscuity 0 minmtu 68 maxmtu 65535 \n    veth numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n    inet 10.4.2.1\/24 brd 10.4.4.255 scope global eth0\n       valid_lft forever preferred_lft forever\n3: pistioin: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1410 qdisc noqueue state UNKNOWN group default qlen 1000\n    link\/ether 06:18:ee:29:7e:e4 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65485 \n    geneve id 1000 remote 10.4.2.1 ttl auto dstport 6081 noudpcsum udp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n    inet 192.168.126.2\/30 scope global pistioin\n       valid_lft forever preferred_lft forever\n4: pistioout: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1410 qdisc noqueue state UNKNOWN group default qlen 1000\n    link\/ether aa:40:40:7c:07:b2 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65485 \n    geneve id 1001 remote 10.4.2.1 ttl auto dstport 6081 noudpcsum udp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n    inet 192.168.127.2\/30 scope global pistioout\n       valid_lft forever preferred_lft forever\n{{\u003c\/highlight\u003e}}\n\n你将发现其中有两个网卡：\n\n- \u0060pistioin\u0060 ：IP 为 \u0060192.168.126.2\u0060\n- \u0060pistioout\u0060：IP 为 \u0060192.168.127.2\u0060\n\n{{\u003ccallout note \u0022关于 pistioin 和 pistioout 网卡\u0022\u003e}}\n\n这两个网卡都是由 ztunnel 中的 init 容器创建的 Geneve 类型的虚拟网卡，其 IP 地址也是固定的，如果你查看 ztunnel 的 YAML 配置将发现其中的网卡创建命令，在此我们按下不表，因为 Ambient 模式还在开发初期，这些启动命令未来可能有很大变化，感兴趣的读者可以自行查阅。\n\n{{\u003c\/callout\u003e}}\n\n自 Pod A 的流量进入 ztunnel 之后，如何对流量进行处理呢？答案是 iptables，查看 ztunnel A 中的 iptables 规则：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=11\u0022\u003e}}\n$ iptables-save\n\/* 省略 *\/\n*mangle\n:PREROUTING ACCEPT [185880:96984381]\n:INPUT ACCEPT [185886:96984813]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [167491:24099839]\n:POSTROUTING ACCEPT [167491:24099839]\n-A PREROUTING -j LOG --log-prefix \u0022mangle pre [ ztunnel-rts54] \u0022\n-A PREROUTING -i pistioin -p tcp -m tcp --dport 15008 -j TPROXY --on-port 15008 --on-ip 127.0.0.1 --tproxy-mark 0x400\/0xfff\n-A PREROUTING -i pistioout -p tcp -j TPROXY --on-port 15001 --on-ip 127.0.0.1 --tproxy-mark 0x400\/0xfff\n-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port 15006 --on-ip 127.0.0.1 --tproxy-mark 0x400\/0xfff\n\/* 省略 *\/\n{{\u003c\/highlight\u003e}}\n\n可以看到 ztunnel A 中的所有发往 \u0060pistioin\u0060 网卡的 TCP 流量透明转发到 \u006015001\u0060 端口（Envoy 的 outbound 端口），并打上了 \u00600x400\/0xfff\u0060 的标记。这个标记可以保证数据包发往正确的网卡。\n\n{{\u003ccallout note \u0022关于 tproxy\u0022\u003e}}\n\n\u0060tproxy\u0060 是 Linux 内核自 2.2 版本以来支持的透明代理（Transparent proxy），其中的 t 代表 transparent，即透明。你需要在内核配置中启用 \u0060NETFILTER_TPROXY\u0060 和策略路由。通过 tproxy，Linux 内核就可以作为一个路由器，将数据包重定向到用户空间。详见 [tproxy 文档](http:\/\/lxr.linux.no\/linux\u002bv3.10\/Documentation\/networking\/tproxy.txt)。\n\n{{\u003c\/callout\u003e}}\n\n查看 Ztunnel A 中的路由表。\n\n\u0060\u0060\u0060bash\n$ ip rule\n0:      from all lookup local\n20000:  from all fwmark 0x400\/0xfff lookup 100\n20001:  from all fwmark 0x401\/0xfff lookup 101\n20002:  from all fwmark 0x402\/0xfff lookup 102\n20003:  from all fwmark 0x4d3\/0xfff lookup 100\n32766:  from all lookup main\n32767:  from all lookup default\n\u0060\u0060\u0060\n\n你会看到所有标记 \u00600x400\/0xfff\u0060 的数据包应用 101 路由表，我们查看该路由表详情：\n\n\u0060\u0060\u0060bash\n$ ip route show table 100\nlocal default dev lo scope host \n\u0060\u0060\u0060\n\n你会看到这是一条本地路由，数据包发送到本地的回环网卡，即 \u0060127.0.0.1\u0060。\n\n以上就是 Pod 中出站流量的透明劫持过程。\n\n## Ztunnel A 上的出站流量路由 {#ztunnel-a-outbound}\n\n出站流量在被劫持到 Ztunnel 上，进入 Envoy 的 15001 端口处理。下面我们来查看 Ztunnel 如何路由出站流量。\n\n注意：Ztunnel 中的 Envoy 过滤器规则与 Sidecar 模式中的 Envoy 过滤器规则完全不同，我们不使用 \u0060istioctl proxy-config\u0060 命令来检视 Listener、Cluster、Endpoint 等配置，而是直接导出 ztunnel 中的 Envoy 完整配置。 \n\n我们直接在自己的本地机器上远程获取 ztunnel A 中的 Envoy 配置：\n\n\u0060\u0060\u0060bash\nkubectl exec -n istio-system ztunnel-hptxk -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003eztunnel-a-all-include-eds.json\n\u0060\u0060\u0060\n\n注意：不要使用 \u0060istioctl proxy-config all ztunnel-rts54 -n istio-system\u0060 命令来获取 Envoy 配置，因为这样获取的配置中不包含 EDS 部分。导出的 Json 文件将有上万行，为了便于阅读，建议使用 [fx](https:\/\/github.com\/antonmedv\/fx) 或其他工具来解析该文件。\n\n### ztunnel_outbound 监听器 {#ztunnel_outbound-listener}\n\n在这个 Envoy 配置中包含了该节点上的所有 Pod 访问的流量规则配置，查看 \u0060ztunnel_outbound\u0060 Listener 部分配置（因配置太多，省略部分内容）：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=7 10 11 14 43 59 62 64 69 76 82 85 88-123\u0022\u003e}}\n{\n \u0022name\u0022: \u0022ztunnel_outbound\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-11T07:10:40Z\/13\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022ztunnel_outbound\u0022,\n   \u0022address\u0022: {\n    \u0022socket_address\u0022: {\n     \u0022address\u0022: \u00220.0.0.0\u0022,\n     \u0022port_value\u0022: 15001\n    }\n   },\n   \u0022filter_chains\u0022: [{...},...],\n   \u0022use_original_dst\u0022: true,\n   \u0022listener_filters\u0022: [\n    {\n     \u0022name\u0022: \u0022envoy.filters.listener.original_dst\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.listener.original_dst.v3.OriginalDst\u0022\n     }\n    },\n    {\n     \u0022name\u0022: \u0022envoy.filters.listener.original_src\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.listener.original_src.v3.OriginalSrc\u0022,\n      \u0022mark\u0022: 1234\n     }\n    },\n    {\n     \u0022name\u0022: \u0022envoy.filters.listener.workload_metadata\u0022,\n     \u0022config_discovery\u0022: {\n      \u0022config_source\u0022: {\n       \u0022ads\u0022: {},\n       \u0022initial_fetch_timeout\u0022: \u002230s\u0022\n      },\n      \u0022type_urls\u0022: [\n       \u0022type.googleapis.com\/istio.telemetry.workloadmetadata.v1.WorkloadMetadataResources\u0022\n      ]\n     }\n    }\n   ],\n   \u0022transparent\u0022: true,\n   \u0022socket_options\u0022: [\n    {\n     \u0022description\u0022: \u0022Set socket mark to packets coming back from outbound listener\u0022,\n     \u0022level\u0022: \u00221\u0022,\n     \u0022name\u0022: \u002236\u0022,\n     \u0022int_value\u0022: \u00221025\u0022\n    }\n   ],\n   \u0022access_log\u0022: [{...}],\n   \u0022default_filter_chain\u0022: {\u0022filters\u0022: [...], ...},\n   \u0022filter_chain_matcher\u0022: {\n    \u0022matcher_tree\u0022: {\n     \u0022input\u0022: {\n      \u0022name\u0022: \u0022port\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput\u0022\n      }\n     },\n     \u0022exact_match_map\u0022: {\n      \u0022map\u0022: {\n       \u002215001\u0022: {\n        \u0022action\u0022: {\n         \u0022name\u0022: \u0022BlackHoleCluster\u0022,\n         \u0022typed_config\u0022: {\n          \u0022@type\u0022: \u0022type.googleapis.com\/google.protobuf.StringValue\u0022,\n          \u0022value\u0022: \u0022BlackHoleCluster\u0022\n         }\n        }\n       }\n      }\n     }\n    },\n    \u0022on_no_match\u0022: {\n     \u0022matcher\u0022: {\n      \u0022matcher_tree\u0022: {\n       \u0022input\u0022: {\n        \u0022name\u0022: \u0022source-ip\u0022,\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.SourceIPInput\u0022\n        }\n       },\n       \u0022exact_match_map\u0022: {\n        \u0022map\u0022: {\n         \u002210.168.15.222\u0022: {...},\n         \u002210.4.4.19\u0022: {\n          \u0022matcher\u0022: {\n           \u0022matcher_tree\u0022: {\n            \u0022input\u0022: {\n             \u0022name\u0022: \u0022ip\u0022,\n             \u0022typed_config\u0022: {\n              \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.DestinationIPInput\u0022\n             }\n            },\n            \u0022exact_match_map\u0022: {\n             \u0022map\u0022: {\n              \u002210.8.4.226\u0022: {\n               \u0022matcher\u0022: {\n                \u0022matcher_tree\u0022: {\n                 \u0022input\u0022: {\n                  \u0022name\u0022: \u0022port\u0022,\n                  \u0022typed_config\u0022: {\n                   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput\u0022\n                  }\n                 },\n                 \u0022exact_match_map\u0022: {\n                  \u0022map\u0022: {\n                   \u00229080\u0022: {\n                    \u0022action\u0022: {\n                     \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal\u0022,\n                     \u0022typed_config\u0022: {\n                      \u0022@type\u0022: \u0022type.googleapis.com\/google.protobuf.StringValue\u0022,\n                      \u0022value\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal\u0022\n                     }\n                    }\n                   }\n                  }\n                 }\n                }\n               }\n              },\n              {...}\n             }\n            }\n           }\n          }\n         },\n         \u002210.4.4.7\u0022: {...},\n         \u002210.4.4.11\u0022: {...},\n        }\n       }\n      },\n      \u0022on_no_match\u0022: {\n       \u0022action\u0022: {\n        \u0022name\u0022: \u0022PassthroughFilterChain\u0022,\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/google.protobuf.StringValue\u0022,\n         \u0022value\u0022: \u0022PassthroughFilterChain\u0022\n        }\n       }\n      }\n     }\n    }\n   }\n  },\n  \u0022last_updated\u0022: \u00222022-11-11T07:33:10.485Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n- 第 10、11、59、62、64、69、76、82、85 行：Envoy 监听 15001 端口，处理内核中使用 tproxy 转发的流量；对于目的地是 15001 端口的数据包直接抛弃，对于目的地是其他端口的流量再根据源 IP 地址匹配决定数据包去向；\n- 第 43 行：使用 \u0060IP_TRANSPARENT\u0060 套接字选项，开启 tproxy 透明代理，转发目的地非 ztunnel IP 的流量包；\n-  第 88 到 123 行：根据源 IP（\u006010.4.4.19\u0060 是 Pod A 的 IP）、目的 IP（\u006010.8.14.226\u0060 是服务 B 的 Cluster IP）和端口（9080）规则匹配，数据包将被发往 \u0060spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal\u0060 集群。\n\n### Sleep 集群\n\n我们再查看一下该集群的配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=5 6 18 23-37\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-08T06:40:06Z\/63\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal\u0022,\n  \u0022type\u0022: \u0022EDS\u0022,\n  \u0022eds_cluster_config\u0022: {\n   \u0022eds_config\u0022: {\n    \u0022ads\u0022: {},\n    \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n    \u0022resource_api_version\u0022: \u0022V3\u0022\n   }\n  },\n  \u0022transport_socket_matches\u0022: [\n   {\n    \u0022name\u0022: \u0022internal_upstream\u0022,\n    \u0022match\u0022: {\n     \u0022tunnel\u0022: \u0022h2\u0022\n    },\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n      \u0022passthrough_metadata\u0022: [\n       {\n        \u0022kind\u0022: {\n         \u0022host\u0022: {}\n        },\n        \u0022name\u0022: \u0022tunnel\u0022\n       },\n       {\n        \u0022kind\u0022: {\n         \u0022host\u0022: {}\n        },\n        \u0022name\u0022: \u0022istio\u0022\n       }\n      ],\n      \u0022transport_socket\u0022: {\n       \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n       }\n      }\n     }\n    }\n   },\n   {\n    \u0022name\u0022: \u0022tlsMode-disabled\u0022,\n    \u0022match\u0022: {},\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  ]\n },\n \u0022last_updated\u0022: \u00222022-11-08T06:40:06.619Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- 第 6 行：该 Cluster 配置使用 EDS 获取端点\n- 第 18 行：对所有具有 \u0060tunnel: h2\u0060 元数据的字节流应用 [\u0060InternalUpstreamTransport\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/transport_sockets\/internal_upstream\/v3\/internal_upstream.proto#envoy-v3-api-msg-extensions-transport-sockets-internal-upstream-v3-internalupstreamtransport)，用于内部地址，定义位于同一代理实例中的环回用户空间 socket。除了常规字节流之外，该扩展还允许跨用户空间 socket 传递额外的结构化状态（\u0060passthrough_metadata\u0060）。目的是促进下游过滤器和上游内部连接之间的通信。与上游连接共享的所有过滤器状态对象也通过此传输 socket 与下游内部连接共享。\n- 第 23 到 37 行：向上游传递的结构化数据；\n\n### Sleep 集群的端点 {#sleep-endpoints}\n\n我们再检查下 EDS，你会发现在众多的 \u0060endpoint_config\u0060 中有这样一条：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=4 13 20-30\u0022\u003e}}\n{\n \u0022endpoint_config\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.endpoint.v3.ClusterLoadAssignment\u0022,\n  \u0022cluster_name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal\u0022,\n  \u0022endpoints\u0022: [\n   {\n    \u0022locality\u0022: {},\n    \u0022lb_endpoints\u0022: [\n     {\n      \u0022endpoint\u0022: {\n       \u0022address\u0022: {\n        \u0022envoy_internal_address\u0022: {\n         \u0022server_listener_name\u0022: \u0022outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n         \u0022endpoint_id\u0022: \u002210.4.3.20:9080\u0022\n        }\n       },\n       \u0022health_check_config\u0022: {}\n      },\n      \u0022health_status\u0022: \u0022HEALTHY\u0022,\n      \u0022metadata\u0022: {\n       \u0022filter_metadata\u0022: {\n        \u0022envoy.transport_socket_match\u0022: {\n         \u0022tunnel\u0022: \u0022h2\u0022\n        },\n        \u0022tunnel\u0022: {\n         \u0022address\u0022: \u002210.4.3.20:15008\u0022,\n         \u0022destination\u0022: \u002210.4.3.20:9080\u0022\n        }\n       }\n      },\n      \u0022load_balancing_weight\u0022: 1\n     }\n    ]\n   }\n  ],\n  \u0022policy\u0022: {\n   \u0022overprovisioning_factor\u0022: 140\n  }\n }\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- 第 4 行：截止 2022 年 11 月 14 日，实际在导出 Envoy 配置的时候并没有该字段，但是理应有这个字段，否则无法判断 Endpoint 属于哪个 Cluster；\n- 第 13 行：该端点的地址是一个 \u0060envoy_internal_address\u0060，Envoy 内部监听器 \u0060outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0060；\n- 第 20 - 30 行：定义过滤器元数据，使用 HBONE 隧道传递给 Envoy 内部监听器；\n\n{{\u003ccallout warning \u0022关于 endpoint_config 中未显示 cluster_name 字段的问题\u0022\u003e}}\n\n这里的 [\u0060endpoint_config\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/endpoint\/v3\/endpoint.proto) 中缺少了必选的 \u0060cluster_name\u0060 字段，这可能是 Ambient 模式的一个 bug 导致了在导出 Envoy 的配置时缺少了该字段。我在 GItHub 上创建了一个 Issue 来追踪这个问题，详见 [Istio Issue-42022](https:\/\/github.com\/istio\/istio\/issues\/42022)。\n\n{{\u003c\/callout\u003e}}\n\n### 通过 Envoy 内部监听器建立 HBONE 隧道 {#sleep-internal-upstream}\n\n我们再看下这个监听器 \u0060outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0060：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=16 18-28 40\u0022\u003e}}\n{\n \u0022name\u0022: \u0022outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-08T06:40:06Z\/63\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n   \u0022filter_chains\u0022: [\n    {\n     \u0022filters\u0022: [\n      {\n       \u0022name\u0022: \u0022envoy.filters.network.tcp_proxy\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy\u0022,\n        \u0022stat_prefix\u0022: \u0022outbound_tunnel_lis_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n        \u0022cluster\u0022: \u0022outbound_tunnel_clus_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n        \u0022access_log\u0022: [{...}, ...],\n        \u0022tunneling_config\u0022: {\n         \u0022hostname\u0022: \u0022%DYNAMIC_METADATA(tunnel:destination)%\u0022,\n         \u0022headers_to_add\u0022: [\n          {\n           \u0022header\u0022: {\n            \u0022key\u0022: \u0022x-envoy-original-dst-host\u0022,\n            \u0022value\u0022: \u0022%DYNAMIC_METADATA([\\\u0022tunnel\\\u0022, \\\u0022destination\\\u0022])%\u0022\n           }\n          }\n         ]\n        }\n       }\n      }\n     ]\n    }\n   ],\n   \u0022use_original_dst\u0022: false,\n   \u0022listener_filters\u0022: [\n    {\n     \u0022name\u0022: \u0022set_dst_address\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n      \u0022value\u0022: {}\n     }\n    }\n   ],\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-08T06:40:06.750Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- 第 14 行：数据包将被转发到 \u0060outbound_tunnel_clus_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0060 集群；\n- 第 18 - 28 行： [\u0060tunneling_config\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/filters\/network\/tcp_proxy\/v3\/tcp_proxy.proto#envoy-v3-api-msg-extensions-filters-network-tcp-proxy-v3-tcpproxy-tunnelingconfig) ，用来配置上游 HTTP CONNECT 隧道。另外该监听器中的 \u0060TcpProxy\u0060 过滤器将流量传给上游 \u0060outbound_tunnel_clus_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0060 集群。TCP 过滤器上设置了 HTTP CONNECT 隧道（承载发送到 \u006010.4.3.20:9080\u0060 的流量），供 \u0060productpage\u0060 所在节点的 ztunnel 使用。有多少个端点，就会创建多少条隧道。HTTP 隧道是 Ambient 组件之间安全通信的承载协议。同时在隧道中的数据包添加了 \u0060x-envoy-original-dst-host\u0060 header，根据上一步 EDS 中选择的端点的 \u0060metadata\u0060 里的参数设置目的地址。前面 EDS  选择的端点是 \u006010.4.3.20:9080\u0060 ，那么这里的 tunnel 监听器就会 header 的值设置为 \u006010.4.3.20:9080\u0060，请留意这个 header，它会在隧道的另一端被用到；\n- 第 40 行：监听器中首先执行监听器过滤器，\u0060set_dst_address\u0060 过滤器将上游地址设置为下游的目的地址。\n\n{{\u003ccallout note \u0022关于 HBONE 隧道\u0022\u003e}}\n\nHBONE 是 HTTP-Based Overlay Network Environment 的缩写，是一种使用 HTTP 协议提供隧道能力的方法。客户端向 HTTP 代理服务器发送 HTTP CONNECT 请求（其中包含了目的地址）以建立隧道，代理服务器代表客户端与目的地建立 TCP 连接，然后客户端就可以通过代理服务器透明的传输 TCP 数据流到目的服务器。在 Ambient 模式中，Ztunnel（其中的 Envoy）实际上是充当了透明代理，它使用 [Envoy Internal Listener](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/other_features\/internal_listener) 来接收 HTTP CONNECT 请求和传递 TCP 流给上游集群。\n\n{{\u003c\/callout\u003e}}\n\n### Sleep 集群的 HBONE 隧道端点 {#sleep-tunnel-cluster}\n\n我们再查看一下 \u0060outbound_tunnel_clus_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0060 集群的配置：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6 22-41 45-47\u0022\u003e}}\n {\n \u0022version_info\u0022: \u00222022-11-11T07:30:10Z\/37\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022outbound_pod_tunnel_clus_spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022,\n  \u0022type\u0022: \u0022ORIGINAL_DST\u0022,\n  \u0022connect_timeout\u0022: \u00222s\u0022,\n  \u0022lb_policy\u0022: \u0022CLUSTER_PROVIDED\u0022,\n  \u0022cleanup_interval\u0022: \u002260s\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.tls\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext\u0022,\n    \u0022common_tls_context\u0022: {\n     \u0022tls_params\u0022: {\n      \u0022tls_minimum_protocol_version\u0022: \u0022TLSv1_3\u0022,\n      \u0022tls_maximum_protocol_version\u0022: \u0022TLSv1_3\u0022\n     },\n     \u0022alpn_protocols\u0022: [\n      \u0022h2\u0022\n     ],\n     \u0022tls_certificate_sds_secret_configs\u0022: [\n      {\n       \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep~sleep-5644bdc767-2dfg7~85c8c34e-7ae3-4d29-9582-0819e2b10c69\u0022,\n       \u0022sds_config\u0022: {\n        \u0022api_config_source\u0022: {\n         \u0022api_type\u0022: \u0022GRPC\u0022,\n         \u0022grpc_services\u0022: [\n          {\n           \u0022envoy_grpc\u0022: {\n            \u0022cluster_name\u0022: \u0022sds-grpc\u0022\n           }\n          }\n         ],\n         \u0022set_node_on_first_message_only\u0022: true,\n         \u0022transport_api_version\u0022: \u0022V3\u0022\n        },\n        \u0022resource_api_version\u0022: \u0022V3\u0022\n       }\n      }\n     ]\n    }\n   }\n  },\n  \u0022original_dst_lb_config\u0022: {\n   \u0022upstream_port_override\u0022: 15008\n  },\n  \u0022typed_extension_protocol_options\u0022: {\n   \u0022envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022,\n    \u0022explicit_http_config\u0022: {\n     \u0022http2_protocol_options\u0022: {\n      \u0022allow_connect\u0022: true\n     }\n    }\n   }\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-11T07:30:10.754Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- 第 6 行：该集群的类型是 \u0060ORIGINAL_DST\u0060，即前文中 EDS 获取到的地址 \u006010.4.3.20:9080\u0060；\n- 第 22 - 41 行：配置了上游的 TLS 证书；\n- 第 45 - 48 行：将上游端口修改为 15008；\n\n以上就是使用 tproxy 和 HBONE 隧道实现的出站流量透明劫持的全过程。\n\n## Inbound 流量劫持 {#inbound}\n\n节点 B 接收节点 A 对 \u006010.4.3.20:15008\u0060 的请求。Ambient 模式的入站流量劫持与出站流量类似，同样使用 tproxy 和 HBONE 实现透明流量劫持。\n\nAmbient mesh 的 pod 入站流量的透明流量劫持流程如下：\n\n1. Istio CNI 在节点上创建 \u0060istioin\u0060 网卡和 iptables 规则，将 Ambient mesh 中的 Pod IP 加入 IP 集，并通过 netfilter \u0060nfmark\u0060 标记和路由规则，将 Ambient mesh 中的出站流量通过 Geneve 隧道透明劫持到 \u0060pistioin\u0060 虚拟机网卡；\n2. ztunnel 中的 init 容器创建 iptables 规则，将 \u0060pistioin\u0060 网卡中的所有流量转发到 ztunnel 中的 Envoy 代理的 15008 端口；\n3. Envoy 对数据包进行处理后转发给 Pod B。\n\n因为操作步骤与上文中的检查出站流量时相同，因此下文将省略部分输出。\n\n### 检查节点 B 上的路由规则 {#node-b-rules}\n\n登录到服务 B 所在的节点 B，查看节点上的 iptables：\n\n\u0060\u0060\u0060bash\n$ iptables-save\n\/* 省略 *\/\n-A ztunnel-PREROUTING -m mark --mark 0x200\/0x200 -j RETURN\n-A ztunnel-PREROUTING -p tcp -m set --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100\/0x100\n\/* 省略 *\/\n\u0060\u0060\u0060\n\n你将看到在前文中提到的给所有 \u0060ztunnel-pods-ips\u0060 IP 集中 Pod 发送的数据包打上 \u00600x100\/0x100\u0060 标记的上一条命令：给所有数据包打上 \u00600x200\/0x200\u0060 标记，然后继续执行 iptables。\n\n查看节点 B 上的路由表：\n\n\u0060\u0060\u0060bash\n0:      from all lookup local\n100:    from all fwmark 0x200\/0x200 goto 32766\n101:    from all fwmark 0x100\/0x100 lookup 101\n102:    from all fwmark 0x40\/0x40 lookup 102\n103:    from all lookup 100\n32766:  from all lookup main\n32767:  from all lookup default\n\u0060\u0060\u0060\n\n所有 Ambient Mesh 节点中的路由表数量和规则是一样的，路由表规则将按顺序执行，首先查找 \u0060local\u0060 表，然后所有带有 \u00600x200\/0x200\u0060 标记的数据包将首先跳转到 \u0060main\u0060 表（其中定义了 veth 路由），然后查找 \u0060100\u0060 表，在 \u0060100\u0060 表中有以下规则：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=8\u0022\u003e}}\n$ ip route show table 100\n10.4.3.14 dev veth28865c45 scope link \n10.4.3.15 via 192.168.126.2 dev istioin src 10.4.3.1\n10.4.3.16 via 192.168.126.2 dev istioin src 10.4.3.1\n10.4.3.17 via 192.168.126.2 dev istioin src 10.4.3. \n10.4.3.18 via 192.168.126.2 dev istioin src 10.4.3. \n10.4.3.19 via 192.168.126.2 dev istioin src 10.4.3.1\n10.4.3.20 via 192.168.126.2 dev istioin src 10.4.3.1\n{{\u003c\/highlight\u003e}}\n\n你会看到发往 \u006010.4.3.20\u0060 的数据包将被路由到 \u0060istioin\u0060 网卡上的 \u0060192.168.126.2\u0060 网关。\n\n查看 \u0060istioin\u0060 网卡的详细信息：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=4 5\u0022\u003e}}\n$ ip -d addr show istioin \n17: istioin: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1410 qdisc noqueue state UNKNOWN group default \n    link\/ether 36:2a:2f:f1:5c:97 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65485 \n    geneve id 1000 remote 10.4.3.14 ttl auto dstport 6081 noudpcsum udp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n    inet 192.168.126.1\/30 brd 192.168.126.3 scope global istioin\n       valid_lft forever preferred_lft forever\n    inet6 fe80::342a:2fff:fef1:5c97\/64 scope link \n       valid_lft forever preferred_lft forever\n{{\u003c\/highlight\u003e}}\n\n从输出中可以看到，\u0060istioin\u0060 是一个 Geneve 类型虚拟网卡，它创建了一个 Geneve 隧道，远端的 IP 是 \u006010.4.3.14 \u0060，这是 Ztunnel B 的 Pod IP。\n\n### 检查 Ztunnel B Pod 上的路由规则 {#ztunnel-b-rules}\n\n进入 Ztunnel B Pod，使用 \u0060ip -d a\u0060 命令检查它的网卡信息，你会看到有一个 \u0060pistioout\u0060 网卡，它的 IP 为 \u0060192.168.127.2\u0060，这正是与 \u0060istioout\u0060 虚拟网卡建立的 Geneve 隧道的远端。\n\n使用 \u0060iptables-save\u0060 查看 Pod 内的 iptables 规则，你会看到：\n\n\u0060\u0060\u0060bash\n-A PREROUTING -i pistioin -p tcp -m tcp --dport 15008 -j TPROXY --on-port 15008 --on-ip 127.0.0.1 --tproxy-mark 0x400\/0xfff\n-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port 15006 --on-ip 127.0.0.1 --tproxy-mark 0x400\/0xfff\n\u0060\u0060\u0060\n\n所有发往 \u006010.4.3.20:15008\u0060 的流量将使用 tproxy 被路由到 15008 端口。\n\n{{\u003ccallout note \u0022关于 15006 和 15008 端口\u0022\u003e}}\n\n- 15006 端口用于处理非加密的（plain）TCP 数据包。\n- 15008 端口用于处理加密的（TLS）TCP 数据包。\n\n{{\u003c\/callout\u003e}}\n\n以上就是 Pod 中入站流量的透明劫持过程。\n\n## Ztunnel B 上的入站流量路由 {#ztunnel-b-inbound}\n\n出站的 TLS 加密流量在被劫持到 Ztunnel 上，进入 Envoy 的 15008 端口处理。下面我们来查看 Ztunnel 如何路由入站流量。\n\n我们直接在自己的本地机器上远程获取 ztunnel B 中的 Envoy 配置：\n\n\u0060\u0060\u0060bash\nkubectl exec -n istio-system \tztunnel-z4qmh -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003eztunnel-b-all-include-eds.json\n\u0060\u0060\u0060\n\n### ztunnel_inbound 监听器 {#ztunnel_inbound-listener}\n\n查看 \u0060ztunnel_inbound\u0060 监听器的详细信息：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=7 10 11 17-22 39-65 78-82\u0022\u003e}}\n\n{\n \u0022name\u0022: \u0022ztunnel_inbound\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-11T07:12:01Z\/16\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022ztunnel_inbound\u0022,\n   \u0022address\u0022: {\n    \u0022socket_address\u0022: {\n     \u0022address\u0022: \u00220.0.0.0\u0022,\n     \u0022port_value\u0022: 15008\n    }\n   },\n   \u0022filter_chains\u0022: [\n    {\n     \u0022filter_chain_match\u0022: {\n      \u0022prefix_ranges\u0022: [\n       {\n        \u0022address_prefix\u0022: \u002210.4.3.20\u0022,\n        \u0022prefix_len\u0022: 32\n       }\n      ]\n     },\n     \u0022filters\u0022: [\n      {\n       \u0022name\u0022: \u0022envoy.filters.network.rbac\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.rbac.v3.RBAC\u0022,\n        \u0022rules\u0022: {...},\n        \u0022stat_prefix\u0022: \u0022tcp.\u0022,\n        \u0022shadow_rules_stat_prefix\u0022: \u0022istio_dry_run_allow_\u0022\n       }\n      },\n      {\n       \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n        \u0022stat_prefix\u0022: \u0022inbound_hcm\u0022,\n        \u0022route_config\u0022: {\n         \u0022name\u0022: \u0022local_route\u0022,\n         \u0022virtual_hosts\u0022: [\n          {\n           \u0022name\u0022: \u0022local_service\u0022,\n           \u0022domains\u0022: [\n            \u0022*\u0022\n           ],\n           \u0022routes\u0022: [\n            {\n             \u0022match\u0022: {\n              \u0022connect_matcher\u0022: {}\n             },\n             \u0022route\u0022: {\n              \u0022cluster\u0022: \u0022virtual_inbound\u0022,\n              \u0022upgrade_configs\u0022: [\n               {\n                \u0022upgrade_type\u0022: \u0022CONNECT\u0022,\n                \u0022connect_config\u0022: {}\n               }\n              ]\n             }\n            }\n           ]\n          }\n         ]\n        },\n        \u0022http_filters\u0022: [\n         {\n          \u0022name\u0022: \u0022envoy.filters.http.router\u0022,\n          \u0022typed_config\u0022: {\n           \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.http.router.v3.Router\u0022\n          }\n         }\n        ],\n        \u0022http2_protocol_options\u0022: {\n         \u0022allow_connect\u0022: true\n        },\n        \u0022access_log\u0022: [{...}],\n        \u0022upgrade_configs\u0022: [\n         {\n          \u0022upgrade_type\u0022: \u0022CONNECT\u0022\n         }\n        ]\n       }\n      }\n     ],\n     \u0022transport_socket\u0022: {\n      \u0022name\u0022: \u0022envoy.transport_sockets.tls\u0022,\n      \u0022typed_config\u0022: {...} \n     },\n     \u0022name\u0022: \u0022inbound_10.4.3.20\u0022\n    },\n    {...}\n   ],\n   \u0022use_original_dst\u0022: true,\n   \u0022listener_filters\u0022: [{},...],\n   \u0022transparent\u0022: true,\n   \u0022socket_options\u0022: [{...}}],\n   \u0022access_log\u0022: [{...} ]\n  },\n  \u0022last_updated\u0022: \u00222022-11-14T03:54:07.040Z\u0022\n }\n}\n\n{{\u003c\/highlight\u003e}}\n\n从上面的配置中可以看出：\n\n- 发往 \u006010.4.3.20\u0060 的流量将被路由到 \u0060virtual_inbound\u0060 集群；\n- 第 78 - 82 行：[\u0060upgrade_type: \u0022CONNECT\u0022\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/route\/v3\/route_components.proto#config-route-v3-routeaction-upgradeconfig) 为 Envoy 的 HCM 启用 HTTP Connect 隧道，将该隧道中的 TCP 数据发送到上游；\n\n### virtual_inbound 集群 {#virtual_inbound-cluster}\n\n查看 \u0060virtual_inbound\u0060 集群的信息：\n\n{{\u003chighlight bash \u0022linenos=table,hl_lines=6 9\u0022\u003e}}\n\n{\n \u0022version_info\u0022: \u00222022-11-11T07:10:40Z\/13\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022virtual_inbound\u0022,\n  \u0022type\u0022: \u0022ORIGINAL_DST\u0022,\n  \u0022lb_policy\u0022: \u0022CLUSTER_PROVIDED\u0022,\n  \u0022original_dst_lb_config\u0022: {\n   \u0022use_http_header\u0022: true\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-11T07:10:42.111Z\u0022\n}\n\n{{\u003c\/highlight\u003e}}\n\n说明：\n\n- 第 7 行：该集群的类型是 \u0060ORIGINAL_DST\u0060，表示使用下游的原始目的地作为路由目的地，即 \u006010.4.3.20:15008\u0060，显然这个地址中的端口不正确；\n- 第 9 行：[\u0060use_http_header\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/cluster\/v3\/cluster.proto#config-cluster-v3-cluster-originaldstlbconfig) 为 \u0060true\u0060 时将使用 HTTP header [\u0060x-envoy-original-dst-host\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#config-http-conn-man-headers-x-envoy-original-dst-host) 作为目的地址，而这个 header [在出站的 Ztunnel 中已设置](\/#sleep-internal-upstream)为 \u006010.4.3.20:9080\u0060，它将覆盖之前设置的目的地址；\n\n至此，入站流量被 ztunnel 准确地路由到了目的地。以上就是 Ambient 模式中不同节点间 L4 流量劫持和路由流程。\n\n## 总结 {#summary}\n\n为了方便演示，本文中展示的是不同节点上的服务 L4 网络访问数据包的路径，即使两个服务在同一个节点上路径也是类似的。根据本文中提供的操作说明，读者可以在自己的环境中尝试。Istio 的 Ambient 模式还在初级阶段，在笔者测试过程中，也发现导出的 Envoy 配置中 EDS 缺少 \u0060cluster_name\u0060 字段的问题（[Issue Istio-42022](https:\/\/github.com\/istio\/istio\/issues\/42022)）。另外 Ambient 模式使用 Istio CNI 在节点中注入 iptables 规则，通过设置 \u0060nfmark\u0060 的方式拦截 Pod 的流量到 Ztunnel 中，这种方式可能造成对其他 CNI 的兼容性问题，[Merbridge](https:\/\/merbridge.io\/zh\/blog\/2022\/11\/11\/ambient-mesh-support\/) 项目正在寻求使用 eBPF 来绕过 IPtables，从而无需安装 Istio CNI，这样也就不会存在 CNI 兼容性问题。\n\n在了解了 L4 流量路径之后，今后笔者会再分享 Ambient 模式中的 L7 流量路径，欢迎关注。\n\n## 参考{#reference}\n\n- [安装 Ambient Mesh - istio.io](https:\/\/istio.io\/latest\/blog\/2022\/get-started-ambient\/)\n- [深入 Ambient Mesh - 流量路径 - mp.weixin.qq.com](https:\/\/mp.weixin.qq.com\/s\/PpP0pmxdJR8PknHeR-pVHQ)\n- [一文读懂 Ambient Mesh 七层服务治理 - mp.weixin.qq.com](https:\/\/mp.weixin.qq.com\/s\/TXMyxbzBSfuYNquOZJmZTg)\n- [深度剖析！Istio 共享代理新模式 Ambient Mesh - mp.weixin.qq.com](https:\/\/mp.weixin.qq.com\/s\/B0q73ACAvmY4SjW42A2GVw)\n- [Istio Ambient 模式流量管理实现机制详解（一）- zhaohuabing.com](https:\/\/www.zhaohuabing.com\/post\/2022-09-11-ambient-deep-dive-1\/)\n- [Istio Ambient 模式流量管理实现机制详解（二） - zhaohuabing.com](https:\/\/www.zhaohuabing.com\/post\/2022-09-11-ambient-deep-dive-2\/)\n- [Istio Ambient 模式流量管理实现机制详解（三）- zhaohuabing.com](https:\/\/www.zhaohuabing.com\/post\/2022-10-17-ambient-deep-dive-3\/)\n- [Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！- merbridge.io](https:\/\/merbridge.io\/zh\/blog\/2022\/11\/11\/ambient-mesh-support\/)\n', '\/blog\/ambient-mesh-l4-traffic-path\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-mesh-introduction/">[译] 全面解析 Istio 新型部署模式：环境模式</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/10/28</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('全面解析 Istio 新型部署模式：环境模式', '本文详细介绍了 Istio 的新型部署模式——环境模式（Ambient Mesh），这是一种实验性的无 sidecar 部署模式，旨在提高服务网格的性能和可靠性。', '\nIstio [最近宣布了“环境模式”](https:\/\/istio.io\/latest\/blog\/2022\/introducing-ambient-mesh\/)——一种实验性的、无 sidecar 的部署模式。我们最近在[如何从服务网格中获得最大性能和弹性](https:\/\/tetrate.io\/blog\/ebpf-and-sidecars-getting-the-most-performance-and-resiliency-out-of-the-service-mesh\/)的背景下讨论了 sidecar 与无 sidecar。在本文中，我们将特别介绍环境模式。\n\n## 什么是环境模式？\n\n环境模式是 Istio 最近引入的一种新的实验性部署模式。它将原本由 Envoy sidecar 执行的职责分解为两个独立的组件：一个节点级的加密组件（称为“ztunnel”）和一个每个服务部署的 L7 Envoy 实例，用于处理所有其他的流程（称为“waypoint”）。环境模式模型试图在生命周期和资源管理上获得一些效率提升——至少，这是其动机。\n\n## 为什么应该关心环境模式？\n\n对于大多数服务网格用户来说，Istio 数据平面的确切部署模式可能不是你需要过多考虑的问题。默认设置可能就足够好。对于*一些*服务网格用户，特别是那些有大量横向扩展且服务数量少的用户——在这种情况下，waypoint 架构最能获得效率提升——环境模式模式随着其成熟为生产就绪的基础设施软件，将会变得有用。\n\n## 简要总结\n\n- 环境模式部署模式相较于 sidecar 模式在生命周期管理、资源利用、故障排除和安全姿态方面做了一些权衡。两者并没有明显的优劣。\n- 环境模式是一项实验，最早将在 2023 年前成为生产就绪——即，**现在还不能在生产中使用**。当前的性能更差，功能不那么丰富，广泛使用的技术如 CNI 行为不明确。然而，我们预计随着实现的加固，这种情况将在未来几个月迅速改善。\n- 你关心的许多网格功能——如每次请求的流量管理和安全控制、分布式跟踪和应用级 RED 指标——都在 L7 层发生。目前尚不清楚仅 L4 部分的环境模式的适用范围有多广，以及分解这些数据平面职责将在多大程度上帮助推动网格的采用。\n\n本文的其余部分是我们对环境模型与 Istio 现有的 sidecar 部署模型的权衡，以及哪一个可能更适合你以及何时使用。\n\n## Istio 中的 L4 和 L7 处理是如何工作的？\n\n由于环境模式将 L4 和 L7 处理分开，了解每一层中发生的网格行为是很重要的：\n\n|                                  | **L4**                                                       | **L7**                                                       |\n| -------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| **安全性**                       |                                                              |                                                              |\n| 服务对服务认证                   | [SPIFFE](https:\/\/spiffe.io\/), 通过 mTLS 证书。Istio 发行一个编码了 pod 服务账户身份的短期 X.509 证书。 | N\/A—服务身份在 Istio 中基于 TLS。                            |\n| 服务对服务授权                   | 基于网络的授权，加上基于身份的策略，例如：*A* 只能接受来自“10.2.0.0\/16”的入站调用；*A* 可以调用 *B*。 | 完整策略，例如：*A* 只能在拥有有效的终端用户凭据且包含 READ 范围时，从 *B* 获取 \/foo。 |\n| 终端用户认证                     | N\/A—我们无法应用每个用户的设置。                             | 本地认证 JWT，支持通过 OAuth 和 OIDC 流程的远程认证。        |\n| 终端用户授权                     | N\/A—见上文。                                                 | 服务对服务策略可以扩展到要求[具有特定范围、发行者、主体、受众等的终端用户凭据](https:\/\/istio.io\/latest\/docs\/reference\/config\/security\/conditions\/)—但它不能用于全面的用户对资源的访问控制。全面的用户对资源的访问控制应该使用外部授权来实现。 |\n| Envoy 的外部授权 API (ext_authz) | 不能执行任何每次请求的策略；ext_authz API 只能配置用于 L7 流量。 | 执行每次请求的策略，决策来自一个外部服务，例如 OPA。         |\n| **可观测性**                     |                                                              |                                                              |\n| 日志记录                         | 基本网络信息：网络 5 元组，发送\/接收的字节等。[参见 Envoy 文档](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/observability\/access_log\/usage#command-operators)。 | [完整的请求元数据日志记录](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/observability\/access_log\/usage#command-operators)，除了基本网络信息。 |\n| 跟踪                             | 今天不可行；可能最终通过 HBONE 实现。                        | Envoy 参与分布式跟踪。[参见 Istio 跟踪概述](https:\/\/istio.io\/latest\/docs\/tasks\/observability\/distributed-tracing\/overview\/)。 |\n| 指标                             | 仅 TCP（发送\/接收的字节，数据包数量等）。                    | L7 RED 指标：请求率、错误率、请求持续时间（延迟）。          |\n| **流量管理**                     |                                                              |                                                              |\n| 负载均衡                         | 仅在连接级别。[参见 TCP 流量转移任务](https:\/\/istio.io\/latest\/docs\/tasks\/traffic-management\/tcp-traffic-shifting\/)。 | 每次请求，启用例如金丝雀部署、gRPC 流量等。[参见 HTTP 流量转移任务](https:\/\/istio.io\/latest\/docs\/tasks\/traffic-management\/traffic-shifting\/)。 |\n| 断路器                           | [仅 TCP](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/destination-rule\/#ConnectionPoolSettings-TCPSettings)。 | [HTTP 设置](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/destination-rule\/#ConnectionPoolSettings-HTTPSettings) 除了 TCP。 |\n| 异常检测                         | 在连接建立\/失败时。                                          | 在请求成功\/失败时。                                          |\n| 速率限制                         | [仅在连接建立时，L4 连接数据的速率限制](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/listeners\/network_filters\/rate_limit_filter#config-network-filters-rate-limit)，有全局和本地速率限制选项。 | [每次请求的 L7 请求元数据的速率限制](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/rate_limit_filter#config-http-filters-rate-limit)。 |\n| 超时 | 仅在连接建立时（通过断路器设置配置连接保持活动）。 | 每次请求。 |\n| 重试 | 重试连接建立。 | 重试每次请求失败。 |\n| 故障注入 | N\/A—TCP 连接上不能配置故障注入。 | 全面的应用和连接级故障（[超时、延迟、特定响应码](https:\/\/istio.io\/latest\/docs\/tasks\/traffic-management\/fault-injection\/)）。 |\n| 流量镜像 | N\/A—仅 HTTP。 | [请求的百分比基础镜像到多个后端](https:\/\/istio.io\/latest\/docs\/tasks\/traffic-management\/mirroring\/)。 |\n\n值得记住的是，一个在 L7 操作的代理可以执行 L4 *和* L7 栏中的所有操作，而一个仅在 L4 操作的代理只能执行 L4 栏中的操作。了解何处发生了什么以及 L4 与 L7 的限制，我们可以看看环境模式与 sidecar 模型相比的权衡。\n\n## 现在可以使用环境模式吗？（还不行）\n\n截至其 2022 年 9 月的公告，环境模式是一个实验性的概念验证。根据[几乎所有的度量](https:\/\/github.com\/istio\/istio\/tree\/experimental-ambient#limitations)，它的表现不如 sidecar，并且有不少[限制](https:\/\/github.com\/istio\/istio\/tree\/experimental-ambient#limitations)。环境模式**还没有准备好**在生产环境中使用（对我们的客户来说——大型企业的平台团队——应用开发和测试环境也算是生产环境）。\n\n然而，我们预计这种状态会相对快速地改变，因为整个社区的工程师正在努力改进这种部署模型。它将像[所有其他 Istio 功能](https:\/\/istio.io\/latest\/docs\/releases\/feature-stages\/)一样，通过功能阶段发展。关注[Istio 功能列表](https:\/\/istio.io\/latest\/docs\/releases\/feature-stages\/#istio-features)，环境模式可能在 2023 年某个时候被提升为 Alpha 状态。我们预计它会在 2023 年底或 2024 年初离开 Beta，并且我们不建议在那之前将其用于生产环境。\n\n## 关于服务网格和 Istio 的环境模式假设\n\n总结环境模式公告博客文章，驱动架构的核心假设是：\n\n1. **假设**：Envoy 的 L7 功能是使新应用加入网格变得困难的原因。\n2. **假设**：Envoy 的 L7 功能是发现 CVE 的地方（绝大多数 Envoy CVE 都在 L7 代码中，而不是处理 TLS 和连接的 L4 代码），因此，在节点级别保持多个容器的证书在严格的 L4 代理中是可接受的，而在节点级别进行 L7 处理则不是。\n3. **假设**：sidecar 常常导致资源过度分配。\n4. **假设**：额外的网络跳数比 Envoy 进行 L7 计算更便宜（从两个 L7 sidecar 转到一个 L7 waypoint 增加了一个跳数，但减少了一个执行 L7 处理的 Envoy）。\n5. **假设**：Istio 最有价值的功能是传输中的加密，因此，优化使这一用例易于实现是有价值的。\n\n## 环境模式假设与客户现场的经验如何匹配\n\n我们与世界上一些最大的企业紧密合作，以促进服务网格的采用，这些经验并没有完全证明这些激励思想：\n\n1. **L7 功能**：网格的一些 L7 功能*可以*使应用的采用更加困难，但根据我们的经验，应用入网的更多破坏是由于连接寿命的变化或双重加密的问题造成的。这些问题无论是 sidecar 还是节点级代理都会以类似的方式表现出来，但在节点部署模型中（通常缺乏权限检查特权\/节点级组件的日志）对应用团队来说更难排查问题。深入了解[节点级代理与 sidecar](https:\/\/tetrate.io\/blog\/ebpf-and-sidecars-getting-the-most-performance-and-resiliency-out-of-the-service-mesh\/)的区别，请参阅我们之前提到的博客文章。\n\n2. **L7 CVE**: 查看这些，我们看到：\n\n   - 三十三个与 L7 处理相关，主要是解析或 HTTP 处理。\n   - 剩下的 12 个是 L4 或 Envoy 固有的（连接处理、证书处理、噪声邻居 DOS、缓冲区溢出等）。\n   - L7 CVEs 的平均严重性高于非 L7 CVE。\n\n   一个仅 L4 的 Envoy *确实*提供了相比 L7 Envoy 更小的攻击面，因为代码更少（CVEs 也更少）。是否这样的攻击面足够低以证明在节点上保持每个 pod 的身份是个问题。环境模式安全模型的核心在于我们对 ztunnel 组件的信任程度——这是社区打算首先发展的组件。总体而言，环境的安全模型最好是与 sidecar 模型相比的一种侧步，但在将其纳入现有安全模型时，边界更难以推理。\n   \n3. **资源利用**：的确，如果没有配置 pod 资源请求，sidecar 可以导致资源利用不良，如果不使用[配置资源可见性](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/traffic-management\/#cross-namespace-configuration)或[sidecar API 资源](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/sidecar\/)等技术。然而，我们在严格控制资源可见性并通过 sidecar API 资源限制配置范围的 Istio 部署中的经验是，sidecar 资源利用非常低，我们可以为每个 sidecar 设置比 Istio 默认配置文件更小的资源请求。手动维护这种配置类型的 sidecar API 资源*非常具有挑战性*——这就是为什么 [Tetrate Service Bridge](https:\/\/tetrate.io\/tetrate-service-bridge\/) 根据更高级别的访问构造自动生成它。\n\n   我们很高兴看到环境部署模型带来的资源利用改进——因为一个独立的 waypoint Envoy 通常可以处理比单个服务实例（及其 sidecar）看到的流量显著更多。\n\n4. **额外的网络跳数与 sidecar**：环境部署模型提供的最有趣的可能性之一是在 sidecar 架构中移除额外的 L7 Envoy。因为网格中的通信是 sidecar 对 sidecar，客户端和\n\n服务器都应用 L7 策策，我们必须对每个请求进行两次 L7 处理。在环境模式中，该策略将由服务器的 Waypoint 执行——所以 L7 处理只发生一次。然而，连接的两侧仍有 ztunnel 进行 L4 处理。\n\n   这种交易——一个网络跳数而不是 Envoy 进行 L7 处理——是否总体上值得仍有待观察。当然在同一可用区的云提供商网络中，由于延迟低且连接可靠，它可能是值得的。然而，我们的许多客户在预置和各种物理站点上部署服务网格，这些站点通常看起来不像云提供商网络。\n\n5. **mTLS**：Istio 的传输中加密无疑是其最强大的功能之一。它被用于（[以 FIPS 验证的形式](https:\/\/tetrate.io\/blog\/tetrate-istio-distro-achieves-fips-certification\/)）[FIPS 合规](https:\/\/tetrate.io\/blog\/tetrate-first-to-provide-hardened-istio-to-dods-iron-bank\/)、[PCI 合规](https:\/\/tetrate.io\/resource\/meeting-pci-compliance-standards\/) 和在各种安全优先的环境中。然而，当我们看到网格的能力时，通常加密本身并不是采用的原因：通常是加密与 L7 策略（包括流量控制）和可观测性一起激励技术投资。从上表中可以看出，这些能力不能仅靠 ztunnel 实现——它们需要一个 L7 Envoy。事实上，我们今天看到的大多数网格使用都需要一个 L7 Envoy。我们对任何使网格采用更容易的事情都感到非常热情，但我们还没有信心环境模式的部署模型将在这方面显著提供。\n\n## 关于环境模式的最后思考\n\n环境模式是对无 sidecar 服务网格模型的一种有趣看法。我们很期待看到它的发展，特别是如果它能帮助简化网格的采用。有一些特定的用例我们预计这种方法会带来好处，但现在还很早，尚不清楚这些权衡是否值得。无论如何，环境模式在被认为准备好生产之前可能还需要一段时间。直到那时，正如人们所说，让我们拭目以待。\n', '\/trans\/istio-ambient-mesh-introduction\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细介绍了 Istio 的新型部署模式——环境模式（Ambient Mesh），这是一种实验性的无 sidecar 部署模式，旨在提高服务网格的性能和可靠性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-mode/">关于 Istio 推出 Ambient 模式（无侵入模式）的看法</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/09/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('关于 Istio 推出 Ambient 模式（无侵入模式）的看法', '本文介绍了 Ambient 模式并阐述了笔者的看法。', '\n今天 [Istio 社区推出了 Ambient 模式](https:\/\/cloudnative.to\/blog\/introducing-ambient-mesh\/)，这是一种新的 Istio 数据平面模式，旨在简化操作、扩大应用兼容性并降低基础设施成本。用户可以选择将 Ambient 模式集成到其基础设施的网格数据平面，放弃 sidecar 代理，同时保持 Istio 的零信任安全、遥测和流量管理等核心功能。该模式目前还是预览版，Istio 社区准备在未来几个月内将其推向生产就绪。\n\nAmbient 模式推出的消息对于社区来说可能显得有些突然，但其实关于 sidecar 模式对于资源的消耗过大，以及简化服务网格的呼声在社区里已经存在很久了，Google 从多年前就在寻求 HBONE（HTTP-Based Overlay Network Environment，基于 HTTP 的重叠网络环境）解决方案，还有社区提出的[多种 sidecar 部署模式](\/blog\/beyond-istio-oss\/#sidecar-management)、[proxyless 模式](\/blog\/beyond-istio-oss\/#proxyless-pattern) 等都是为了解决这个问题。\n\n## 什么是 Ambient 模式？{#what-is-ambient-mode}\n\nAmbient 模式是 Istio 社区在 2022 年 9 月推出的一种无 sidecar 的 Istio 数据平面部署模式，下图展示了 Ambient 模式的架构。\n\n![Ambient 模式架构](ambient-mesh-arch.svg)\n\n从图中我们可以看到 Ambient 模式对应用程序本身没有任何侵入，而是在应用程序外围：\n\n1. 同 node 上部署 ztunnel：使用 Envoy 实现的共享代理，多租户模式，负责 L4 网络，主要是安全性方面；\n2. 以服务账户为单位部署 Waypoint proxy：同样使用 Envoy 实现，单租户模式，使用 Gateway API 部署的 Gateway 资源，负责 L7 网络，当服务需要 L7 网络功能的时候才部署；\n\n下面是 Ambient 模式的功能分层。\n\n![Ambient 模式的功能分层](ambient-mesh-layers.svg)\n\n关于 Ambient 模式的更多介绍请阅读：\n\n- [Istio 无 sidecar 代理数据平面 ambient 模式简介](https:\/\/cloudnative.to\/blog\/introducing-ambient-mesh\/)\n- [Istio 服务网格 ambient 模式安全详解](https:\/\/cloudnative.to\/blog\/ambient-security\/)\n- [什么是 Ambient Mesh，它与 sidecar 模式有什么区别？](https:\/\/cloudnative.to\/blog\/what-is-ambient-mesh\/)\n\n## Ambient 模式的核心技术 {#ambient-core}\n\nAmbient 模式中的 ztunnel 和 Waypoint proxy 目前还是使用 Envoy 来实现的，未来不排除使用其他语言（非 C\u002b\u002b，如 Rust）来实现一个轻量级的 ztunnel。该模式的核心是所谓的 HBONE（HTTP Based Overlay Network Environment，基于 HTTP 的覆盖网络环境）。\n\nHBONE 基于 HTTP\/2 CONNECT，将工作负载之间的请求以流的形式进行隧道传输，尽可能地复用 HTTP\/2 连接。HBONE 对工作负载来说是透明的，支持更好的传输机制：\n\n- 支持多协议，包括 Server First 协议，如 MySQL。Istio 可以自动检测出 HTTP 和 HTTP\/2 流量。如果未自动检测出协议，流量将会视为普通 TCP 流量。对于 Server First 协议必须明确声明，否则将作为 TCP 流量处理；\n- 对于使用自己 TLS 证书的应用程序可以逐步采用 Istio；\n- 支持绕过 Istio mTLS 封装直接调用 Pod IP；\n\n## Sidecar 模式的限制 {#sidecar-limitations}\n\n其实 ambient 模式的出现，主要是因为 sidecar 模式有以下限制：\n\n- Sidecar 容器不是 pod 中的一等公民，它的生命周期不受控制，有可能在 sidecar 就没准备好的情况下，pod 就开始接收连接，让 sidecar 的生命周期与应用程序 pod 绑定，这本身就是对应用程序的一种侵入\n- Sidecar 无法解释不规范的七层系列，如 HTTP 和 gRPC；\n- 如果仅需服务网格的安全功能，那么引入 sidecar 是一次过大的投资，因为它增加了很多七层网络功能，这些是用不到的，客户无法做到渐进式采用服务网格；\n- Sidecar 升级时，应用程序需要重新部署或者启动，这需要对应用程序进行协调；\n\n## 关于 Ambient 模式的看法 {#ambient-insight}\n\n本文我将谈谈对 ambient 模式的几点看法：\n\n1. **关于 Ambient Mesh 的命名**：我觉得叫做 **Ambient Mode** 会更好，有些接触 Istio 的初学者可能会觉得它是一种全新的不同于 Istio 的 service mesh；另外关于这个模式的中文翻译，如果直接翻译成“环境网格”似乎让人很难理解，我还想到了其他词汇，如“外围”、“氛围”、“周围”、“环绕”、”情景”等，没有一个汉语词汇可以准确表达这个 ambient 的含义，因为相对于 sidecar 模式，ambient 模式对应用程序 pod 没有侵入性，暂且将其称之为**无侵入模式**。\n2. **Ambient Mode 的本质**：它的本质是分离 sidecar proxy（Envoy）中的 L4 和 L7 功能，让一部分仅需要安全功能的用户可以最小阻力（低资源消耗、运维成本）地使用 Istio service mesh。\n3. **Ambient Mode 的意义**：因为它 sidecar 模式兼容，用户在采纳 Ambient Mode 获得了 mTLS 和有限的可观测性及 TPC 路由等 L4 功能，之后可以更方便的过度到 sidecar mode 以获得完全的 L7 功能。这给用户采纳 Istio 提供了更多模式选择，优化了 Istio 采纳路径。\n4. **Ambient Mode 的坏处**：Proxyless、sidecar、ambient 模式，使得 Istio 越来越复杂，用户理解起来更加费力；控制平面为了支持多种数据平面部署模式，其实现将更加复杂。\n5. **与其他服务网格的关系**：有的 service mesh 从原先的 per-proxy per-node 模式转变为 sidecar mode，如 Linkerd；还有的从 CNI 做到 service mesh，如 Cilium 使用 per-proxy per-node 模式；如今 Istio 在 sidecar mode 的基础上增加了 ambient mode，这也是目前唯一同时支持这两种部署模式的服务网格，为用户提供了多样的选择。\n6. **安全问题**：虽然 [Istio 服务网格 ambient 模式安全详解](https:\/\/cloudnative.to\/blog\/ambient-security\/) 说明了 ambient 模式的设计主旨是为了将应用程序与数据平面分离，让安全覆盖层的组件（ztunnel）处于类似于 CNI 的网格底层，考虑到 ztunnel 有限的 L4 攻击面，该模式的安全风险是可以接受的；但是，ztunnel 作为 DaemonSet 部署在每个节点上，需要处理和分发调度到该节点上的所有 pod 的证书来建立 mTLS 连接，一旦 一个 ztunnel 被攻破，它的爆炸半径确实是大于一个 sidecar，安全详解的博客中说 Envoy 的 CVE 问题会影响所有 sidecar，升级 sidecar 也会带来很大的运营成本，所以权衡之下选择 ambient 模式，安全问题再次给用户造成了困惑，不过最终选择的权利还是在用户自己。\n\n## 安装试用 {#setup}\n\n参考 [Istio 官网中的步骤](https:\/\/istio.io\/latest\/blog\/2022\/get-started-ambient\/)安装：\n\n1. [下载 Ambient Mesh 预览版](https:\/\/gcsweb.istio.io\/gcs\/istio-build\/dev\/0.0.0-ambient.191fe680b52c1754ee72a06b3e0d3f9d116f2e82)；\n\n2. 检查 Kubernetes 版本，建议的大于等于 1.21；\n\n3. 安装 Ambient profile：\n\n   \u0060\u0060\u0060bash\n   istioctl install --set profile=ambient\n   \u0060\u0060\u0060\n\n4. 部署示例应用：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f samples\/bookinfo\/platform\/kube\/bookinfo.yaml\n   kubectl apply -f https:\/\/raw.githubusercontent.com\/linsun\/sample-apps\/main\/sleep\/sleep.yaml\n   kubectl apply -f https:\/\/raw.githubusercontent.com\/linsun\/sample-apps\/main\/sleep\/notsleep.yaml\n   kubectl apply -f samples\/bookinfo\/networking\/bookinfo-gateway.yaml\n   \u0060\u0060\u0060\n\n5. 将应用添加到 Ambient Mesh：\n\n   \u0060\u0060\u0060bash\n   kubectl label namespace default istio.io\/dataplane-mode=ambient\n   \u0060\u0060\u0060\n\n6. 发送测试流量：\n\n   \u0060\u0060\u0060bash\n   kubectl exec deploy\/sleep -- curl -s http:\/\/istio-ingressgateway.istio-system\/productpage | head -n1\n   kubectl exec deploy\/sleep -- curl -s http:\/\/productpage:9080\/ | head -n1\n   kubectl exec deploy\/notsleep -- curl -s http:\/\/productpage:9080\/ | head -n1\n   \u0060\u0060\u0060\n\n7. 在将 Pod 加入到 Ambient Mesh 中之后，就可以给这些 Pod 应用 L4 的授权策略：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f - \u003c\u003cEOF\n   apiVersion: security.istio.io\/v1beta1\n   kind: AuthorizationPolicy\n   metadata:\n    name: productpage-viewer\n    namespace: default\n   spec:\n    selector:\n      matchLabels:\n        app: productpage\n    action: ALLOW\n    rules:\n    - from:\n      - source:\n          principals: [\u0022cluster.local\/ns\/default\/sa\/sleep\u0022, \u0022cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\u0022]\n   EOF\n   \u0060\u0060\u0060\n\n   上面这个策略只允许 sleep 服务和 istio ingress gateway 访问 productpage。\n\n8. 应用 L7 策略：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1alpha2\n   kind: Gateway\n   metadata:\n    name: productpage\n    annotations:\n      istio.io\/service-account: bookinfo-productpage\n   spec:\n    gatewayClassName: istio-mesh\n   EOF\n   \u0060\u0060\u0060\n\n   使用 Gateway API 创建了一个 Gateway，这里实际是在 \u0060default\u0060 命名空间下创建了一个 waypoint proxy，专门用于处理 L7 流量。\n\n   在给它应用授权策略：\n\n   \u0060\u0060\u0060yaml\n   kubectl apply -f - \u003c\u003cEOF\n   apiVersion: security.istio.io\/v1beta1\n   kind: AuthorizationPolicy\n   metadata:\n    name: productpage-viewer\n    namespace: default\n   spec:\n    selector:\n      matchLabels:\n        app: productpage\n    action: ALLOW\n    rules:\n    - from:\n      - source:\n          principals: [\u0022cluster.local\/ns\/default\/sa\/sleep\u0022, \u0022cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\u0022]\n      to:\n      - operation:\n          methods: [\u0022GET\u0022]\n   EOF\n   \u0060\u0060\u0060\n\n   这个策略跟之前有所不同的是最后的 \u0060to\u0060 字段定义了 HTTP 方法，现在你在 sleep pod 中对 productpage 服务执行除 GET 以外的其他请求都将失败。从 notsleep pod 中对 productpage 服务的 GET 请求将成功。\n\n   现在你可以从前面创建的这个 productpage Gateway 中获取到 HTTP 请求的 Prometheus 指标信息。\n\n   \u0060\u0060\u0060bash\n   kubectl exec deploy\/bookinfo-productpage-waypoint-proxy -- curl -s http:\/\/localhost:15020\/stats\/prometheus | grep istio_requests_total\n   \u0060\u0060\u0060\n\n9. **给 Reviews 服务创建 Gateway（Waypoint proxy），所有访问 Reviews 服务的 L7 流量都会经过它。**\n\n   \u0060\u0060\u0060yaml\n   kubectl apply -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1alpha2\n   kind: Gateway\n   metadata:\n    name: reviews\n    annotations:\n      istio.io\/service-account: bookinfo-reviews\n   spec:\n    gatewayClassName: istio-mesh\n   EOF\n   \u0060\u0060\u0060\n\n   再给它应用流量划分：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f samples\/bookinfo\/networking\/virtual-service-reviews-90-10.yaml\n   kubectl apply -f samples\/bookinfo\/networking\/destination-rule-reviews.yaml\n   \u0060\u0060\u0060\n\n   发送 100 次请求测试流量切分结果。\n\n   \u0060\u0060\u0060bash\n   kubectl exec -it deploy\/sleep -- sh -c \u0027for i in $(seq 1 100); do curl -s http:\/\/istio-ingressgateway.istio-system\/productpage | grep reviews-v.-; done\u0027\n   \u0060\u0060\u0060\n\n   你将获得请求结果，说明一切运行正常。\n\n10. 清理环境和删除 Istio。\n\n    \u0060\u0060\u0060bash\n    kubectl delete -f samples\/bookinfo\/networking\/virtual-service-reviews-90-10.yaml\n    kubectl delete -f samples\/bookinfo\/networking\/destination-rule-reviews.yaml\n    kubectl delete -f samples\/bookinfo\/platform\/kube\/bookinfo.yaml\n    kubectl delete -f https:\/\/raw.githubusercontent.com\/linsun\/sample-apps\/main\/sleep\/sleep.yaml\n    kubectl delete -f https:\/\/raw.githubusercontent.com\/linsun\/sample-apps\/main\/sleep\/notsleep.yaml\n    kubectl delete namespace istio-system\n    kubectl label namespace default istio.io\/dataplane-mode-   \n    \u0060\u0060\u0060\n\n## 如何开启 Ambient Mesh？{#enable-ambient}\n\n在安装有 Istio 的 Kubernetes 中部署了你的应用之后，如果想要给命名空间 \u0060ns-a\u0060 启用 Ambient Mode，只需要运行：\n\n\u0060\u0060\u0060bash\nkubectl label namespace ns-a istio.io\/dataplane-mode=ambient\n\u0060\u0060\u0060\n\nAmbient Mesh 默认启用 L4 安全。\n\n## 如何启用 L7 网络功能？{#enable-l7}\n\nAmbient 模式的 L7 网络功能是按需启用的：假如你想给服务 A 访问服务 B 的路径开启 L7 网络功能，那么你需要给服务 B 创建 Gateway。\n\n另外，L7 网络功能是与服务账户绑定的，假如服务 \u0060svc-a\u0060 的服务账户是 \u0060sa-svc-a\u0060，那么给它部署一个 Gateway：\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.networking.k8s.io\/v1alpha2\nkind: Gateway\nmetadata:\n name: svc-a\n annotations:\n   istio.io\/service-account: sa-svc-a\nspec:\n gatewayClassName: istio-mesh\n\u0060\u0060\u0060\n\n然后你就可以创建 \u0060VirtualService\u0060、\u0060DestinationRule\u0060 等资源管理服务 \u0060svc-a\u0060。\n\n该 Gateway 实际上是一个 Deployment，它可以部署在与应用程序不同的命名空间中，你可以对这个 Deployment 单独管理和扩缩容。\n\n## Ambient 模式的限制 {#limitation}\n\n目前 ambient 模式的代码位于 Istio 代码库的 [\u0060experimental-ambient\u0060 分支](https:\/\/github.com\/istio\/istio\/tree\/experimental-ambient)，[根据 Matt Klein 和 Louis Ryan 的说法](https:\/\/twitter.com\/mattklein123\/status\/1567870635568955392?ref_src=twsrc%5Etfw)，ztunnel 和 Waypoint proxy 是用 Envoy 实现的，其中 ztunnel 是精简后的 Envoy，只负责 L4 功能且继续使用 xDS 协议来控制。但是 ambient 模式依然有很多[限制](https:\/\/github.com\/istio\/istio\/tree\/experimental-ambient#limitations)，例如：\n\n- 对 Kubernetes 版本的要求不低于 1.21\n- 不支持 \u0060EnvoyFilter\u0060；\n- 不支持 IPv6；\n- 直接对 Pod IP 而不是 service 的请求在某些情况下将无效；\n- Ambient 模式下的服务无法通过 \u0060LoadBalancer\u0060 和 \u0060NodePort\u0060 方式访问，不过你可以部署一个入口网关（未启用 ambient 模式）以从外部访问服务；\n- 不支持 Calico CNI 和 Dataplane V2 CNI，因为 Ambient 模式会使用 Istio CNI，与其他 CNI 冲突；\n\n[这里](https:\/\/github.com\/istio\/istio\/tree\/experimental-ambient#supported-environments)有安装 ambient 模式的详细环境要求。\n\n## 更多 {#more}\n\n以上就是笔者对 ambient 模式（外围模式）的看法，该模式还处于试验阶段，但绝不是玩具，据信已在某些场景试验过。笔者也将继续追踪该模式的最新进展，请保持关注。也欢迎更多关注 Istio 的朋友[加入云原生社区 Istio 讨论群](https:\/\/cloudnative.to\/community\/join\/)，与社区大咖一起探讨，或者在本文下面评论聊聊你的看法。\n', '\/blog\/istio-ambient-mode\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了 Ambient 模式并阐述了笔者的看法。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/tags/ambient/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/tags/ambient/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/tags/ambient/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item page-item active ">
           <a href="/tags/ambient/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
     
     
     
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(82)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(19)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%b7%a5%e5%85%b7" class="sidebar-item">
            <span>工具</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-ext-proc-guide/">深入解析 Envoy 外部处理过滤器（ext_proc）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-ambient-l7-flow-analysis/">深入 Istio Ambient 模式：从 ztunnel 到 Waypoint 代理的 L7 流量路径解析</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/building-private-ai-knowledge-base-anythingllm/">探索 AnythingLLM：借助开源 AI 打造私有化智能知识库</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />










<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
