<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kubernetes on Jimmy Song&#39;s Blog</title>
    <link>http://rootsongjc.github.io/tags/kubernetes/index.xml</link>
    <description>Recent content in Kubernetes on Jimmy Song&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="http://rootsongjc.github.io/tags/kubernetes/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Kubernetesä¸­çš„IPå’ŒæœåŠ¡å‘ç°ä½“ç³»</title>
      <link>http://rootsongjc.github.io/blogs/ip-and-service-discovry-in-kubernetes/</link>
      <pubDate>Mon, 24 Apr 2017 16:11:16 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/ip-and-service-discovry-in-kubernetes/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/20151108011.jpg&#34; alt=&#34;æœé˜³å…¬å›­&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šè·¯è¾¹çš„é‡èŠ±@æœé˜³å…¬å›­ Nov 8,2015ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;cluster-ip&#34;&gt;Cluster IP&lt;/h2&gt;

&lt;p&gt;å³Serviceçš„IPï¼Œé€šå¸¸åœ¨é›†ç¾¤å†…éƒ¨ä½¿ç”¨Service Nameæ¥è®¿é—®æœåŠ¡ï¼Œç”¨æˆ·ä¸éœ€è¦çŸ¥é“è¯¥IPåœ°å€ï¼Œkubednsä¼šè‡ªåŠ¨æ ¹æ®service nameè§£æåˆ°æœåŠ¡çš„IPåœ°å€ï¼Œå°†æµé‡åˆ†å‘ç»™Podã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Service Nameæ‰æ˜¯å¯¹å¤–æš´éœ²æœåŠ¡çš„å…³é”®ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;åœ¨kubeapiçš„é…ç½®ä¸­æŒ‡å®šè¯¥åœ°å€èŒƒå›´ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;é»˜è®¤é…ç½®&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;--service-cluster-ip-range=10.254.0.0/16
--service-node-port-range=30000-32767
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;pod-ip&#34;&gt;Pod IP&lt;/h2&gt;

&lt;p&gt;é€šè¿‡é…ç½®flannelçš„&lt;code&gt;network&lt;/code&gt;å’Œ&lt;code&gt;subnet&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;é»˜è®¤é…ç½®&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;FLANNEL_NETWORK=172.30.0.0/16
FLANNEL_SUBNET=172.30.46.1/24
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Podçš„IPåœ°å€&lt;u&gt;ä¸å›ºå®š&lt;/u&gt;ï¼Œå½“podé‡å¯æ—¶IPåœ°å€ä¼šå˜åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è¯¥IPåœ°å€ä¹Ÿæ˜¯ç”¨æˆ·æ— éœ€å…³å¿ƒçš„ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯Flannelä¼šåœ¨æœ¬åœ°ç”Ÿæˆç›¸åº”IPæ®µçš„è™šæ‹Ÿç½‘å¡ï¼Œä¸ºäº†é˜²æ­¢å’Œé›†ç¾¤ä¸­çš„å…¶ä»–IPåœ°å€å†²çªï¼Œéœ€è¦è§„åˆ’IPæ®µã€‚&lt;/p&gt;

&lt;h2 id=&#34;ä¸»æœº-node-ip&#34;&gt;ä¸»æœº/Node IP&lt;/h2&gt;

&lt;p&gt;ç‰©ç†æœºçš„IPåœ°å€ï¼Œå³kubernetesç®¡ç†çš„ç‰©ç†æœºçš„IPåœ°å€ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ kubectl get nodes
NAME           STATUS    AGE       VERSION
172.20.0.113   Ready     12d       v1.6.0
172.20.0.114   Ready     12d       v1.6.0
172.20.0.115   Ready     12d       v1.6.0
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æœåŠ¡å‘ç°&#34;&gt;æœåŠ¡å‘ç°&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡DNSå³å¯å‘ç°ï¼Œkubendsæ˜¯kubernetesçš„ä¸€ä¸ªæ’ä»¶ï¼Œä¸åŒæœåŠ¡ä¹‹é—´å¯ä»¥ç›´æ¥ä½¿ç”¨service nameè®¿é—®ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡&lt;code&gt;sericename:port&lt;/code&gt;å³å¯è°ƒç”¨æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æœåŠ¡å¤–éƒ¨çš„æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡Ingressæ¥å®ç°ï¼Œæˆ‘ä»¬æ˜¯ç”¨çš„&lt;strong&gt;Traefik&lt;/strong&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/&#34;&gt;Ingressè§£æ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://rootsongjc.github.io/blogs/traefik-ingress-installation/&#34;&gt;Kubernetes Traefik Ingresså®‰è£…è¯•ç”¨&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetesä¸­çš„RBACæ”¯æŒ</title>
      <link>http://rootsongjc.github.io/blogs/RBAC-support-in-kubernetes/</link>
      <pubDate>Fri, 21 Apr 2017 19:52:18 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/RBAC-support-in-kubernetes/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/20160402017.jpg&#34; alt=&#34;æ— é¢˜&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šæ— é¢˜ Apr 2,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨Kubernetes1.6ç‰ˆæœ¬ä¸­æ–°å¢è§’è‰²è®¿é—®æ§åˆ¶æœºåˆ¶ï¼ˆRole-Based Accessï¼ŒRBACï¼‰è®©é›†ç¾¤ç®¡ç†å‘˜å¯ä»¥é’ˆå¯¹ç‰¹å®šä½¿ç”¨è€…æˆ–æœåŠ¡è´¦å·çš„è§’è‰²ï¼Œè¿›è¡Œæ›´ç²¾ç¡®çš„èµ„æºè®¿é—®æ§åˆ¶ã€‚åœ¨RBACä¸­ï¼Œæƒé™ä¸è§’è‰²ç›¸å…³è”ï¼Œç”¨æˆ·é€šè¿‡æˆä¸ºé€‚å½“è§’è‰²çš„æˆå‘˜è€Œå¾—åˆ°è¿™äº›è§’è‰²çš„æƒé™ã€‚è¿™å°±æå¤§åœ°ç®€åŒ–äº†æƒé™çš„ç®¡ç†ã€‚åœ¨ä¸€ä¸ªç»„ç»‡ä¸­ï¼Œè§’è‰²æ˜¯ä¸ºäº†å®Œæˆå„ç§å·¥ä½œè€Œåˆ›é€ ï¼Œç”¨æˆ·åˆ™ä¾æ®å®ƒçš„è´£ä»»å’Œèµ„æ ¼æ¥è¢«æŒ‡æ´¾ç›¸åº”çš„è§’è‰²ï¼Œç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»ä¸€ä¸ªè§’è‰²è¢«æŒ‡æ´¾åˆ°å¦ä¸€ä¸ªè§’è‰²ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h3&gt;

&lt;p&gt;æœ¬æ–‡ç¿»è¯‘è‡ª&lt;a href=&#34;http://blog.kubernetes.io/2017/04/rbac-support-in-kubernetes.html&#34;&gt;RBAC Support in Kubernetes&lt;/a&gt;ï¼Œè½¬è½½è‡ª&lt;a href=&#34;https://www.kubernetes.org.cn/1879.html&#34;&gt;kubernetesä¸­æ–‡ç¤¾åŒº&lt;/a&gt;ï¼Œè¯‘è€…å‚¬æ€»ï¼Œ&lt;a href=&#34;http://rootsongjc.github.com/about&#34;&gt;Jimmy Song&lt;/a&gt;åšäº†ç¨è®¸ä¿®æ”¹ã€‚è¯¥æ–‡ç« æ˜¯&lt;a href=&#34;http://blog.kubernetes.io/2017/03/five-days-of-kubernetes-1.6.html&#34;&gt;5å¤©å†…äº†è§£Kubernetes1.6æ–°ç‰¹æ€§&lt;/a&gt;çš„ç³»åˆ—æ–‡ç« ä¹‹ä¸€ã€‚&lt;/p&gt;

&lt;p&gt;One of the highlights of the &lt;a href=&#34;http://blog.kubernetes.io/2017/03/kubernetes-1.6-multi-user-multi-workloads-at-scale.html&#34;&gt;Kubernetes 1.6&lt;/a&gt;ä¸­çš„ä¸€ä¸ªäº®ç‚¹æ—¶RBACè®¿é—®æ§åˆ¶æœºåˆ¶å‡çº§åˆ°äº†betaç‰ˆæœ¬ã€‚RBACï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œæ˜¯ç”¨æ¥ç®¡ç†kubernetesé›†ç¾¤ä¸­èµ„æºè®¿é—®æƒé™çš„æœºåˆ¶ã€‚ä½¿ç”¨RBACå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ›´æ–°è®¿é—®æˆæƒç­–ç•¥è€Œä¸ç”¨é‡å¯é›†ç¾¤ã€‚&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡ä¸»è¦å…³æ³¨æ–°ç‰¹æ€§å’Œæœ€ä½³å®è·µã€‚&lt;/p&gt;

&lt;h3 id=&#34;rbac-vs-abac&#34;&gt;RBAC vs ABAC&lt;/h3&gt;

&lt;p&gt;ç›®å‰kubernetesä¸­å·²ç»æœ‰ä¸€ç³»åˆ—l &lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/&#34;&gt;é‰´æƒæœºåˆ¶&lt;/a&gt;ã€‚é‰´æƒçš„ä½œç”¨æ˜¯ï¼Œå†³å®šä¸€ä¸ªç”¨æˆ·æ˜¯å¦æœ‰æƒä½¿ç”¨ Kubernetes API åšæŸäº›äº‹æƒ…ã€‚å®ƒé™¤äº†ä¼šå½±å“ kubectl ç­‰ç»„ä»¶ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ä¸€äº›è¿è¡Œåœ¨é›†ç¾¤å†…éƒ¨å¹¶å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œçš„è½¯ä»¶äº§ç”Ÿä½œç”¨ï¼Œä¾‹å¦‚ä½¿ç”¨äº† Kubernetes æ’ä»¶çš„ Jenkinsï¼Œæˆ–è€…æ˜¯åˆ©ç”¨ Kubernetes API è¿›è¡Œè½¯ä»¶éƒ¨ç½²çš„ Helmã€‚ABAC å’Œ RBAC éƒ½èƒ½å¤Ÿå¯¹è®¿é—®ç­–ç•¥è¿›è¡Œé…ç½®ã€‚&lt;/p&gt;

&lt;p&gt;ABACï¼ˆAttribute Based Access Controlï¼‰æœ¬æ¥æ˜¯ä¸é”™çš„æ¦‚å¿µï¼Œä½†æ˜¯åœ¨ Kubernetes ä¸­çš„å®ç°æ¯”è¾ƒéš¾äºç®¡ç†å’Œç†è§£ï¼Œè€Œä¸”éœ€è¦å¯¹ Master æ‰€åœ¨èŠ‚ç‚¹çš„ SSH å’Œæ–‡ä»¶ç³»ç»Ÿæƒé™ï¼Œè€Œä¸”è¦ä½¿å¾—å¯¹æˆæƒçš„å˜æ›´æˆåŠŸç”Ÿæ•ˆï¼Œè¿˜éœ€è¦é‡æ–°å¯åŠ¨ API Serverã€‚&lt;/p&gt;

&lt;p&gt;è€Œ RBAC çš„æˆæƒç­–ç•¥å¯ä»¥åˆ©ç”¨ kubectl æˆ–è€… Kubernetes API ç›´æ¥è¿›è¡Œé…ç½®ã€‚&lt;strong&gt;RBAC å¯ä»¥æˆæƒç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·æœ‰æƒè¿›è¡Œæˆæƒç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ— éœ€æ¥è§¦èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œæˆæƒç®¡ç†ã€‚&lt;/strong&gt;RBAC åœ¨ Kubernetes ä¸­è¢«æ˜ å°„ä¸º API èµ„æºå’Œæ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;å› ä¸º Kubernetes ç¤¾åŒºçš„æŠ•å…¥å’Œåå¥½ï¼Œç›¸å¯¹äº ABAC è€Œè¨€ï¼ŒRBAC æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åŸºç¡€æ¦‚å¿µ&#34;&gt;åŸºç¡€æ¦‚å¿µ&lt;/h3&gt;

&lt;p&gt;éœ€è¦ç†è§£ RBAC ä¸€äº›åŸºç¡€çš„æ¦‚å¿µå’Œæ€è·¯ï¼ŒRBAC æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿè®¿é—® &lt;a href=&#34;https://kubernetes.io/docs/api-reference/v1.6/&#34;&gt;Kubernetes API èµ„æº&lt;/a&gt;çš„æˆæƒæ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://1.bp.blogspot.com/-v6KLs1tT_xI/WOa0anGP4sI/AAAAAAAABBo/KIgYfp8PjusuykUVTfgu9-2uKj_wXo4lwCLcB/s1600/rbac1.png&#34;&gt;&lt;img src=&#34;https://1.bp.blogspot.com/-v6KLs1tT_xI/WOa0anGP4sI/AAAAAAAABBo/KIgYfp8PjusuykUVTfgu9-2uKj_wXo4lwCLcB/s400/rbac1.png&#34; alt=&#34;img&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;åœ¨ RBAC ä¸­å®šä¹‰äº†ä¸¤ä¸ªå¯¹è±¡ï¼Œç”¨äºæè¿°åœ¨ç”¨æˆ·å’Œèµ„æºä¹‹é—´çš„è¿æ¥æƒé™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;role&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;è§’è‰²æ˜¯ä¸€ç³»åˆ—æƒé™çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ªè§’è‰²å¯ä»¥åŒ…å«è¯»å– Pod çš„æƒé™å’Œåˆ—å‡º Pod çš„æƒé™ï¼Œ ClusterRole è·Ÿ Role ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥åœ¨é›†ç¾¤ä¸­åˆ°å¤„ä½¿ç”¨ï¼ˆ Role æ˜¯ namespace ä¸€çº§çš„ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;role binding&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;RoleBinding æŠŠè§’è‰²æ˜ å°„åˆ°ç”¨æˆ·ï¼Œä»è€Œè®©è¿™äº›ç”¨æˆ·ç»§æ‰¿è§’è‰²åœ¨ namespace ä¸­çš„æƒé™ã€‚ClusterRoleBinding è®©ç”¨æˆ·ç»§æ‰¿ ClusterRole åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æƒé™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://1.bp.blogspot.com/-ixDe91-cnqw/WOa0auxC0mI/AAAAAAAABBs/4LxVsr6shEgTYqUapt5QPISUeuTuztVwwCEw/s1600/rbac2.png&#34;&gt;&lt;img src=&#34;https://1.bp.blogspot.com/-ixDe91-cnqw/WOa0auxC0mI/AAAAAAAABBs/4LxVsr6shEgTYqUapt5QPISUeuTuztVwwCEw/s640/rbac2.png&#34; alt=&#34;img&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å¦å¤–è¿˜è¦è€ƒè™‘cluster roleså’Œcluster role bindingã€‚cluster roleå’Œcluster role bindingæ–¹æ³•è·Ÿroleå’Œrole bindingä¸€æ ·ï¼Œå‡ºäº†å®ƒä»¬æœ‰æ›´å¹¿çš„scopeã€‚è¯¦ç»†å·®åˆ«è¯·è®¿é—® &lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/rbac/#rolebinding-and-clusterrolebinding&#34;&gt;role bindingä¸clsuter role binding&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&#34;kubernetesä¸­çš„rbac&#34;&gt;Kubernetesä¸­çš„RBAC&lt;/h3&gt;

&lt;p&gt;RBAC ç°åœ¨è¢« Kubernetes æ·±åº¦é›†æˆï¼Œå¹¶ä½¿ç”¨ä»–ç»™ç³»ç»Ÿç»„ä»¶è¿›è¡Œæˆæƒã€‚&lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/rbac/#default-roles-and-role-bindings&#34;&gt;System Roles&lt;/a&gt; ä¸€èˆ¬å…·æœ‰å‰ç¼€&lt;code&gt;system:&lt;/code&gt;ï¼Œå¾ˆå®¹æ˜“è¯†åˆ«ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get clusterroles --namespace=kube-system
NAME                                           AGE
admin                                          10d
cluster-admin                                  10d
edit                                           10d
system:auth-delegator                          10d
system:basic-user                              10d
system:controller:attachdetach-controller      10d
system:controller:certificate-controller       10d
system:controller:cronjob-controller           10d
system:controller:daemon-set-controller        10d
system:controller:deployment-controller        10d
system:controller:disruption-controller        10d
system:controller:endpoint-controller          10d
system:controller:generic-garbage-collector    10d
system:controller:horizontal-pod-autoscaler    10d
system:controller:job-controller               10d
system:controller:namespace-controller         10d
system:controller:node-controller              10d
system:controller:persistent-volume-binder     10d
system:controller:pod-garbage-collector        10d
system:controller:replicaset-controller        10d
system:controller:replication-controller       10d
system:controller:resourcequota-controller     10d
system:controller:route-controller             10d
system:controller:service-account-controller   10d
system:controller:service-controller           10d
system:controller:statefulset-controller       10d
system:controller:ttl-controller               10d
system:discovery                               10d
system:heapster                                10d
system:kube-aggregator                         10d
system:kube-controller-manager                 10d
system:kube-dns                                10d
system:kube-scheduler                          10d
system:node                                    10d
system:node-bootstrapper                       10d
system:node-problem-detector                   10d
system:node-proxier                            10d
system:persistent-volume-provisioner           10d
view                                           10d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;RBAC ç³»ç»Ÿè§’è‰²å·²ç»å®Œæˆè¶³å¤Ÿçš„è¦†ç›–ï¼Œè®©é›†ç¾¤å¯ä»¥å®Œå…¨åœ¨ RBAC çš„ç®¡ç†ä¸‹è¿è¡Œã€‚&lt;/p&gt;

&lt;p&gt;åœ¨ ABAC åˆ° RBAC è¿›è¡Œè¿ç§»çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›åœ¨ ABAC é›†ç¾¤ä¸­ç¼ºçœå¼€æ”¾çš„æƒé™ï¼Œåœ¨ RBAC ä¸­ä¼šè¢«è§†ä¸ºä¸å¿…è¦çš„æˆæƒï¼Œä¼šå¯¹å…¶è¿›è¡Œ&lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/rbac/#upgrading-from-15&#34;&gt;é™çº§&lt;/a&gt;ã€‚è¿™ç§æƒ…å†µä¼šå½±å“åˆ°ä½¿ç”¨ Service Account çš„è´Ÿè½½ã€‚ABAC é…ç½®ä¸­ï¼Œä» Pod ä¸­å‘å‡ºçš„è¯·æ±‚ä¼šä½¿ç”¨ Pod Tokenï¼ŒAPI Server ä¼šä¸ºå…¶æˆäºˆè¾ƒé«˜æƒé™ã€‚ä¾‹å¦‚ä¸‹é¢çš„å‘½ä»¤åœ¨ ABAC é›†ç¾¤ä¸­ä¼šè¿”å› JSON ç»“æœï¼Œè€Œåœ¨ RBAC çš„æƒ…å†µä¸‹åˆ™ä¼šè¿”å›é”™è¯¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl run nginx --image=nginx:latest
$ kubectl exec -it $(kubectl get pods -o jsonpath=&#39;{.items[0].metadata.name}&#39;) bash
$ apt-get update &amp;amp;&amp;amp; apt-get install -y curl
$ curl -ik \
  -H &amp;quot;Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&amp;quot; \
  https://kubernetes/api/v1/namespaces/default/pods
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€æœ‰åœ¨ Kubernetes é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ï¼Œä¸€æ—¦å’Œ API Server è¿›è¡Œé€šä¿¡ï¼Œéƒ½ä¼šæœ‰å¯èƒ½å—åˆ°è¿ç§»çš„å½±å“ã€‚&lt;/p&gt;

&lt;p&gt;è¦å¹³æ»‘çš„ä» ABAC å‡çº§åˆ° RBACï¼Œåœ¨åˆ›å»º 1.6 é›†ç¾¤çš„æ—¶å€™ï¼Œå¯ä»¥åŒæ—¶å¯ç”¨&lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/rbac/#parallel-authorizers&#34;&gt;ABAC å’Œ RBAC&lt;/a&gt;ã€‚å½“ä»–ä»¬åŒæ—¶å¯ç”¨çš„æ—¶å€™ï¼Œå¯¹ä¸€ä¸ªèµ„æºçš„æƒé™è¯·æ±‚ï¼Œåœ¨ä»»ä½•ä¸€æ–¹è·å¾—æ”¾è¡Œéƒ½ä¼šè·å¾—æ‰¹å‡†ã€‚ç„¶è€Œåœ¨è¿™ç§é…ç½®ä¸‹çš„æƒé™å¤ªè¿‡ç²—æ”¾ï¼Œå¾ˆå¯èƒ½æ— æ³•åœ¨å•çº¯çš„ RBAC ç¯å¢ƒä¸‹å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;ç›®å‰RBACå·²ç»è¶³å¤Ÿäº†ï¼ŒABACå¯èƒ½ä¼šè¢«å¼ƒç”¨ã€‚åœ¨å¯è§çš„æœªæ¥ABACä¾ç„¶ä¼šä¿ç•™åœ¨kubernetesä¸­ï¼Œä¸è¿‡å¼€å‘çš„é‡å¿ƒå·²ç»è½¬ç§»åˆ°äº†RBACã€‚&lt;/p&gt;

&lt;h3 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://kubernetes.io/docs/admin/authorization/rbac/&#34;&gt;RBAC documentation&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=Cd4JU7qzYbE#t=8m01s&#34;&gt;Google Cloud Next talks 1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=18P7cFc6nTU#t=41m06s&#34;&gt;Google Cloud Next talks 2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://tonybai.com/2017/03/03/access-api-server-from-a-pod-through-serviceaccount/&#34;&gt;åœ¨Kubernetes Podä¸­ä½¿ç”¨Service Accountè®¿é—®API Server&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetes traefik ingresså®‰è£…è¯•ç”¨</title>
      <link>http://rootsongjc.github.io/blogs/traefik-ingress-installation/</link>
      <pubDate>Thu, 20 Apr 2017 22:38:40 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/traefik-ingress-installation/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/20160915046.jpg&#34; alt=&#34;fish&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šğŸŸ@é±¼ç¼¸ Sep 15,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;æ˜¨å¤©ç¿»äº†ä¸‹&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/&#34;&gt;Ingressè§£æ&lt;/a&gt;ï¼Œç„¶åå®‰è£…è¯•ç”¨äº†ä¸‹&lt;a href=&#34;https://traefik.io&#34;&gt;traefik&lt;/a&gt;ï¼Œè¿‡ç¨‹å·²åŒæ­¥åˆ°&lt;a href=&#34;https://www.gitbook.com/book/rootsongjc/kubernetes-handbook&#34;&gt;kubernetes-handbook&lt;/a&gt;ä¸Šï¼ŒGithubåœ°å€&lt;a href=&#34;https://github.com/rootsongjc/kubernetes-handbook&#34;&gt;https://github.com/rootsongjc/kubernetes-handbook&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ingressç®€ä»‹&#34;&gt;Ingressç®€ä»‹&lt;/h2&gt;

&lt;p&gt;å¦‚æœä½ è¿˜ä¸äº†è§£ï¼Œingressæ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å…ˆçœ‹ä¸‹æˆ‘ç¿»è¯‘çš„Kuberneteså®˜ç½‘ä¸Šingressçš„ä»‹ç»&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/&#34;&gt;Kubernetes Ingressè§£æ&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç†è§£Ingress&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç®€å•çš„è¯´ï¼Œingresså°±æ˜¯ä»kubernetesé›†ç¾¤å¤–è®¿é—®é›†ç¾¤çš„å…¥å£ï¼Œå°†ç”¨æˆ·çš„URLè¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„serviceä¸Šã€‚Ingressç›¸å½“äºnginxã€apacheç­‰è´Ÿè½½å‡è¡¡æ–¹å‘ä»£ç†æœåŠ¡å™¨ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬è§„åˆ™å®šä¹‰ï¼Œå³URLçš„è·¯ç”±ä¿¡æ¯ï¼Œè·¯ç”±ä¿¡æ¯å¾—çš„åˆ·æ–°ç”±&lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-controllers&#34;&gt;Ingress controller&lt;/a&gt;æ¥æä¾›ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç†è§£Ingress Controller&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Ingress Controller å®è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸ªç›‘è§†å™¨ï¼ŒIngress Controller é€šè¿‡ä¸æ–­åœ°è·Ÿ kubernetes API æ‰“äº¤é“ï¼Œå®æ—¶çš„æ„ŸçŸ¥åç«¯ serviceã€pod ç­‰å˜åŒ–ï¼Œæ¯”å¦‚æ–°å¢å’Œå‡å°‘ podï¼Œservice å¢åŠ ä¸å‡å°‘ç­‰ï¼›å½“å¾—åˆ°è¿™äº›å˜åŒ–ä¿¡æ¯åï¼ŒIngress Controller å†ç»“åˆä¸‹æ–‡çš„ Ingress ç”Ÿæˆé…ç½®ï¼Œç„¶åæ›´æ–°åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶åˆ·æ–°å…¶é…ç½®ï¼Œè¾¾åˆ°æœåŠ¡å‘ç°çš„ä½œç”¨ã€‚&lt;/p&gt;

&lt;h2 id=&#34;éƒ¨ç½²traefik&#34;&gt;éƒ¨ç½²Traefik&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;ä»‹ç»traefik&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://traefik.io/&#34;&gt;Traefik&lt;/a&gt;æ˜¯ä¸€æ¬¾å¼€æºçš„åå‘ä»£ç†ä¸è´Ÿè½½å‡è¡¡å·¥å…·ã€‚å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä¸å¸¸è§çš„å¾®æœåŠ¡ç³»ç»Ÿç›´æ¥æ•´åˆï¼Œå¯ä»¥å®ç°è‡ªåŠ¨åŒ–åŠ¨æ€é…ç½®ã€‚ç›®å‰æ”¯æŒDocker, Swarm, Mesos/Marathon, Mesos, Kubernetes, Consul, Etcd, Zookeeper, BoltDB, Rest APIç­‰ç­‰åç«¯æ¨¡å‹ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹é…ç½®æ–‡ä»¶å¯ä»¥åœ¨&lt;a href=&#34;https://github.com/rootsongjc/kubernetes-handbook&#34;&gt;kubernetes-handbook&lt;/a&gt;GitHubä»“åº“ä¸­çš„&lt;a href=&#34;manifests/traefik-ingress/&#34;&gt;manifests/traefik-ingress/&lt;/a&gt;ç›®å½•ä¸‹æ‰¾åˆ°ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºingress-rbac.yaml&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å°†ç”¨äºservice accountéªŒè¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Yaml&#34;&gt;apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress
  namespace: kube-system

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: ingress
subjects:
  - kind: ServiceAccount
    name: ingress
    namespace: kube-system
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºåä¸º&lt;code&gt;traefik-ingress&lt;/code&gt;çš„ingress&lt;/strong&gt;ï¼Œæ–‡ä»¶åtraefik.yaml&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-ingress
spec:
  rules:
  - host: traefik.nginx.io
    http:
      paths:
      - path: /
        backend:
          serviceName: my-nginx
          servicePort: 80
  - host: traefik.frontend.io
    http:
      paths:
      - path: /
        backend:
          serviceName: frontend
          servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™å…¶ä¸­çš„&lt;code&gt;backend&lt;/code&gt;ä¸­è¦é…ç½®default namespaceä¸­å¯åŠ¨çš„serviceåå­—ã€‚&lt;code&gt;path&lt;/code&gt;å°±æ˜¯URLåœ°å€åçš„è·¯å¾„ï¼Œå¦‚traefik.frontend.io/pathï¼Œserviceå°†ä¼šæ¥å—pathè¿™ä¸ªè·¯å¾„ï¼Œhostæœ€å¥½ä½¿ç”¨service-name.filed1.filed2.domain-nameè¿™ç§ç±»ä¼¼ä¸»æœºåç§°çš„å‘½åæ–¹å¼ï¼Œæ–¹ä¾¿åŒºåˆ†æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;æ ¹æ®ä½ è‡ªå·±ç¯å¢ƒä¸­éƒ¨ç½²çš„serviceçš„åå­—å’Œç«¯å£è‡ªè¡Œä¿®æ”¹ï¼Œæœ‰æ–°serviceå¢åŠ æ—¶ï¼Œä¿®æ”¹è¯¥æ–‡ä»¶åå¯ä»¥ä½¿ç”¨&lt;code&gt;kubectl replace -f traefik.yaml&lt;/code&gt;æ¥æ›´æ–°ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬ç°åœ¨é›†ç¾¤ä¸­å·²ç»æœ‰ä¸¤ä¸ªserviceäº†ï¼Œä¸€ä¸ªæ˜¯nginxï¼Œå¦ä¸€ä¸ªæ˜¯å®˜æ–¹çš„&lt;code&gt;guestbook&lt;/code&gt;ä¾‹å­ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºDepeloyment&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: traefik-ingress-lb
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      restartPolicy: Always
      serviceAccountName: ingress
      containers:
      - image: traefik
        name: traefik-ingress-lb
        resources:
          limits:
            cpu: 200m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: admin
          containerPort: 8580
          hostPort: 8580
        args:
        - --web
        - --web.address=:8580
        - --kubernetes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„æˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯Deployç±»å‹ï¼Œæ²¡æœ‰é™å®šè¯¥podè¿è¡Œåœ¨å“ªä¸ªä¸»æœºä¸Šã€‚Traefikçš„ç«¯å£æ˜¯8580ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Traefik UI&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Service
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
  - name: web
    port: 80
    targetPort: 8580
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-web-ui
  namespace: kube-system
spec:
  rules:
  - host: traefik-ui.local
    http:
      paths:
      - path: /
        backend:
          serviceName: traefik-web-ui
          servicePort: web
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®å®Œæˆåå°±å¯ä»¥å¯åŠ¨treafik ingressäº†ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl create -f .
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘æŸ¥çœ‹åˆ°traefikçš„podåœ¨&lt;code&gt;172.20.0.115&lt;/code&gt;è¿™å°èŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ã€‚&lt;/p&gt;

&lt;p&gt;è®¿é—®è¯¥åœ°å€&lt;code&gt;http://172.20.0.115:8580/&lt;/code&gt;å°†å¯ä»¥çœ‹åˆ°dashboardã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/traefik-dashboard.jpg&#34; alt=&#34;kubernetes-dashboard&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å·¦ä¾§é»„è‰²éƒ¨åˆ†éƒ¨åˆ†åˆ—å‡ºçš„æ˜¯æ‰€æœ‰çš„ruleï¼Œå³ä¾§ç»¿è‰²éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„backendã€‚&lt;/p&gt;

&lt;h2 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h2&gt;

&lt;p&gt;åœ¨é›†ç¾¤çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚å‡å¦‚ç°åœ¨æˆ‘è¦è®¿é—®nginxçš„&amp;rdquo;/&amp;ldquo;è·¯å¾„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl -H Host:traefik.nginx.io http://172.20.0.115/
&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;Welcome to nginx!&amp;lt;/title&amp;gt;
&amp;lt;style&amp;gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&amp;lt;/style&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;h1&amp;gt;Welcome to nginx!&amp;lt;/h1&amp;gt;
&amp;lt;p&amp;gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&amp;lt;/p&amp;gt;

&amp;lt;p&amp;gt;For online documentation and support please refer to
&amp;lt;a href=&amp;quot;http://nginx.org/&amp;quot;&amp;gt;nginx.org&amp;lt;/a&amp;gt;.&amp;lt;br/&amp;gt;
Commercial support is available at
&amp;lt;a href=&amp;quot;http://nginx.com/&amp;quot;&amp;gt;nginx.com&amp;lt;/a&amp;gt;.&amp;lt;/p&amp;gt;

&amp;lt;p&amp;gt;&amp;lt;em&amp;gt;Thank you for using nginx.&amp;lt;/em&amp;gt;&amp;lt;/p&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœä½ éœ€è¦åœ¨kubernetesé›†ç¾¤ä»¥å¤–è®¿é—®å°±éœ€è¦è®¾ç½®DNSï¼Œæˆ–è€…ä¿®æ”¹æœ¬æœºçš„hostsæ–‡ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨å…¶ä¸­åŠ å…¥ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;172.20.0.115 traefik.nginx.io
172.20.0.115 traefik.frontend.io
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€æœ‰è®¿é—®è¿™äº›åœ°å€çš„æµé‡éƒ½ä¼šå‘é€ç»™172.20.0.115è¿™å°ä¸»æœºï¼Œå°±æ˜¯æˆ‘ä»¬å¯åŠ¨traefikçš„ä¸»æœºã€‚&lt;/p&gt;

&lt;p&gt;Traefikä¼šè§£æhttpè¯·æ±‚headeré‡Œçš„Hostå‚æ•°å°†æµé‡è½¬å‘ç»™Ingressé…ç½®é‡Œçš„ç›¸åº”serviceã€‚&lt;/p&gt;

&lt;p&gt;ä¿®æ”¹hostsåå°±å°±å¯ä»¥åœ¨kubernetesé›†ç¾¤å¤–è®¿é—®ä»¥ä¸Šä¸¤ä¸ªserviceï¼Œå¦‚ä¸‹å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/traefik-nginx.jpg&#34; alt=&#34;traefik-nginx&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/traefik-guestbook.jpg&#34; alt=&#34;traefik-guestbook&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://www.colabug.com/thread-1703745-1-1.html&#34;&gt;Traefik-kubernetes åˆè¯•&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.tuicool.com/articles/ZnuEfay&#34;&gt;Traefikç®€ä»‹&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/kubernetes/kubernetes/tree/master/examples/guestbook&#34;&gt;Guestbook example&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetes ingressè§£æ</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/</link>
      <pubDate>Wed, 19 Apr 2017 21:05:47 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-ingress-resource/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/20160131054.jpg&#34; alt=&#34;é“¶æ²³soho&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šæœé˜³é—¨é“¶æ²³SOHO Jan 31,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯kuberneteå®˜æ–¹æ–‡æ¡£ä¸­&lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/&#34;&gt;Ingress Resource&lt;/a&gt;çš„ç¿»è¯‘ï¼Œå› ä¸ºæœ€è¿‘å·¥ä½œä¸­ç”¨åˆ°ï¼Œæ–‡ç« ä¹Ÿä¸é•¿ï¼Œä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç´¢æ€§ç¿»è¯‘ä¸€ä¸‹ï¼Œä¹Ÿä¾¿äºè‡ªå·±åŠ æ·±ç†è§£ï¼ŒåŒæ—¶é€ ç¦&lt;a href=&#34;https://www.kubernetes.org.cn/&#34;&gt;kubernetesä¸­æ–‡ç¤¾åŒº&lt;/a&gt;ã€‚åç»­å‡†å¤‡ä½¿ç”¨&lt;a href=&#34;https://github.com/containous/traefik&#34;&gt;Traefik&lt;/a&gt;æ¥åšIngress controllerï¼Œæ–‡ç« æœ«å°¾ç»™å‡ºäº†å‡ ä¸ªç›¸å…³é“¾æ¥ï¼Œå®é™…ä½¿ç”¨æ¡ˆä¾‹æ­£åœ¨æ‘¸ç´¢ä¸­ï¼Œå±Šæ—¶ç›¸å…³å®‰è£…æ–‡æ¡£å’Œé…ç½®è¯´æ˜å°†åŒæ­¥æ›´æ–°åˆ°&lt;a href=&#34;https://github.com/rootsongjc/kubernetes-handbook&#34;&gt;kubernetes-handbook&lt;/a&gt;ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æœ¯è¯­&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ä½ å°†ä¼šçœ‹åˆ°ä¸€äº›åœ¨å…¶ä»–åœ°æ–¹è¢«äº¤å‰ä½¿ç”¨çš„æœ¯è¯­ï¼Œä¸ºäº†é˜²æ­¢äº§ç”Ÿæ­§ä¹‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æ¾„æ¸…ä¸‹ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;èŠ‚ç‚¹ï¼šKubernetesé›†ç¾¤ä¸­çš„ä¸€å°ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºã€‚&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é›†ç¾¤ï¼šä½äºInterneté˜²ç«å¢™åçš„èŠ‚ç‚¹ï¼Œè¿™æ˜¯kubernetesç®¡ç†çš„ä¸»è¦è®¡ç®—èµ„æºã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;è¾¹ç•Œè·¯ç”±å™¨ï¼šä¸ºé›†ç¾¤å¼ºåˆ¶æ‰§è¡Œé˜²ç«å¢™ç­–ç•¥çš„è·¯ç”±å™¨ã€‚ è¿™å¯èƒ½æ˜¯ç”±äº‘æä¾›å•†æˆ–ç‰©ç†ç¡¬ä»¶ç®¡ç†çš„ç½‘å…³ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é›†ç¾¤ç½‘ç»œï¼šä¸€ç»„é€»è¾‘æˆ–ç‰©ç†é“¾æ¥ï¼Œå¯æ ¹æ®Kubernetes&lt;a href=&#34;https://kubernetes.io/docs/admin/networking/&#34;&gt;ç½‘ç»œæ¨¡å‹&lt;/a&gt;å®ç°ç¾¤é›†å†…çš„é€šä¿¡ã€‚ é›†ç¾¤ç½‘ç»œçš„å®ç°åŒ…æ‹¬Overlayæ¨¡å‹çš„ &lt;a href=&#34;https://github.com/coreos/flannel#flannel&#34;&gt;flannel&lt;/a&gt; å’ŒåŸºäºSDNçš„&lt;a href=&#34;https://kubernetes.io/docs/admin/ovs-networking/&#34;&gt;OVS&lt;/a&gt;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æœåŠ¡ï¼šä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ ‡è¯†ä¸€ç»„podæˆä¸ºçš„Kubernetes&lt;a href=&#34;https://kubernetes.io/docs/user-guide/services/&#34;&gt;æœåŠ¡&lt;/a&gt;ã€‚ é™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™æœåŠ¡å‡å®šåœ¨é›†ç¾¤ç½‘ç»œå†…ä»…å¯é€šè¿‡è™šæ‹ŸIPè®¿é—®ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ä»€ä¹ˆæ˜¯ingress&#34;&gt;ä»€ä¹ˆæ˜¯Ingressï¼Ÿ&lt;/h2&gt;

&lt;p&gt;é€šå¸¸æƒ…å†µä¸‹ï¼Œserviceå’Œpodä»…å¯åœ¨é›†ç¾¤å†…éƒ¨ç½‘ç»œä¸­é€šè¿‡IPåœ°å€è®¿é—®ã€‚æ‰€æœ‰åˆ°è¾¾è¾¹ç•Œè·¯ç”±å™¨çš„æµé‡æˆ–è¢«ä¸¢å¼ƒæˆ–è¢«è½¬å‘åˆ°å…¶ä»–åœ°æ–¹ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œå¯èƒ½åƒä¸‹é¢è¿™æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    internet
        |
  ------------
  [ Services ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ingressæ˜¯æˆæƒå…¥ç«™è¿æ¥åˆ°è¾¾é›†ç¾¤æœåŠ¡çš„è§„åˆ™é›†åˆã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    internet
        |
   [ Ingress ]
   --|-----|--
   [ Services ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½ å¯ä»¥ç»™Ingressé…ç½®æä¾›å¤–éƒ¨å¯è®¿é—®çš„URLã€è´Ÿè½½å‡è¡¡ã€SSLã€åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºç­‰ã€‚ç”¨æˆ·é€šè¿‡POST Ingressèµ„æºåˆ°API serverçš„æ–¹å¼æ¥è¯·æ±‚ingressã€‚ &lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/#ingress-controllers&#34;&gt;Ingress controller&lt;/a&gt;è´Ÿè´£å®ç°Ingressï¼Œé€šå¸¸ä½¿ç”¨è´Ÿè½½å¹³è¡¡å™¨ï¼Œå®ƒè¿˜å¯ä»¥é…ç½®è¾¹ç•Œè·¯ç”±å’Œå…¶ä»–å‰ç«¯ï¼Œè¿™æœ‰åŠ©äºä»¥HAæ–¹å¼å¤„ç†æµé‡ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å…ˆå†³æ¡ä»¶&#34;&gt;å…ˆå†³æ¡ä»¶&lt;/h2&gt;

&lt;p&gt;åœ¨ä½¿ç”¨Ingress resourceä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸‹é¢å‡ ä»¶äº‹æƒ…ã€‚Ingressæ˜¯betaç‰ˆæœ¬çš„resourceï¼Œåœ¨kubernetes1.1ä¹‹å‰è¿˜æ²¡æœ‰ã€‚ä½ éœ€è¦ä¸€ä¸ª&lt;code&gt;Ingress Controller&lt;/code&gt;æ¥å®ç°&lt;code&gt;Ingress&lt;/code&gt;ï¼Œå•çº¯çš„åˆ›å»ºä¸€ä¸ª&lt;code&gt;Ingress&lt;/code&gt;æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚&lt;/p&gt;

&lt;p&gt;GCE/GKEä¼šåœ¨masterèŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªingress controllerã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªpodä¸­éƒ¨ç½²ä»»æ„ä¸ªè‡ªå®šä¹‰çš„ingress controllerã€‚ä½ å¿…é¡»æ­£ç¡®åœ°annotateæ¯ä¸ªingressï¼Œæ¯”å¦‚ &lt;a href=&#34;https://github.com/kubernetes/ingress/tree/master/controllers/nginx#running-multiple-ingress-controllers&#34;&gt;è¿è¡Œå¤šä¸ªingress controller&lt;/a&gt; å’Œ &lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/gce/BETA_LIMITATIONS.md#disabling-glbc&#34;&gt;å…³é—­glbc&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;ç¡®å®šä½ å·²ç»é˜…è¯»äº†Ingress controllerçš„&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/gce/BETA_LIMITATIONS.md&#34;&gt;betaç‰ˆæœ¬é™åˆ¶&lt;/a&gt;ã€‚åœ¨éGCE/GKEçš„ç¯å¢ƒä¸­ï¼Œä½ éœ€è¦åœ¨podä¸­&lt;a href=&#34;https://github.com/kubernetes/ingress/tree/master/controllers&#34;&gt;éƒ¨ç½²ä¸€ä¸ªcontroller&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ingress-resource&#34;&gt;Ingress Resource&lt;/h2&gt;

&lt;p&gt;æœ€ç®€åŒ–çš„Ingressé…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;1: apiVersion: extensions/v1beta1
2: kind: Ingress
3: metadata:
4:   name: test-ingress
5: spec:
6:   rules:
7:   - http:
8:       paths:
9:       - path: /testpath
10:        backend:
11:           serviceName: test
12:           servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;å¦‚æœä½ æ²¡æœ‰é…ç½®Ingress controllerå°±å°†å…¶POSTåˆ°API serverä¸ä¼šæœ‰ä»»ä½•ç”¨å¤„&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;é…ç½®è¯´æ˜&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1-4è¡Œ&lt;/strong&gt;ï¼šè·ŸKubernetesçš„å…¶ä»–é…ç½®ä¸€æ ·ï¼Œingressçš„é…ç½®ä¹Ÿéœ€è¦&lt;code&gt;apiVersion&lt;/code&gt;ï¼Œ&lt;code&gt;kind&lt;/code&gt;å’Œ&lt;code&gt;metadata&lt;/code&gt;å­—æ®µã€‚é…ç½®æ–‡ä»¶çš„è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹&lt;a href=&#34;https://kubernetes.io/docs/user-guide/deploying-applications&#34;&gt;éƒ¨ç½²åº”ç”¨&lt;/a&gt;, &lt;a href=&#34;https://kubernetes.io/docs/user-guide/configuring-containers&#34;&gt;é…ç½®å®¹å™¨&lt;/a&gt;å’Œ &lt;a href=&#34;https://kubernetes.io/docs/user-guide/working-with-resources&#34;&gt;ä½¿ç”¨resources&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;5-7è¡Œ&lt;/strong&gt;: Ingress &lt;a href=&#34;https://github.com/kubernetes/community/blob/master/contributors/devel/api-conventions.md#spec-and-status&#34;&gt;spec&lt;/a&gt; ä¸­åŒ…å«é…ç½®ä¸€ä¸ªloadbalanceræˆ–proxy serverçš„æ‰€æœ‰ä¿¡æ¯ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªåŒ¹é…æ‰€æœ‰å…¥ç«™è¯·æ±‚çš„è§„åˆ™åˆ—è¡¨ã€‚ç›®å‰ingressåªæ”¯æŒhttpè§„åˆ™ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;8-9è¡Œ&lt;/strong&gt;ï¼šæ¯æ¡httpè§„åˆ™åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼šä¸€ä¸ª&lt;code&gt;host&lt;/code&gt;é…ç½®é¡¹ï¼ˆæ¯”å¦‚for.bar.comï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­é»˜è®¤æ˜¯*ï¼‰ï¼Œ&lt;code&gt;path&lt;/code&gt;åˆ—è¡¨ï¼ˆæ¯”å¦‚ï¼š/testpathï¼‰ï¼Œæ¯ä¸ªpathéƒ½å…³è”ä¸€ä¸ª&lt;code&gt;backend&lt;/code&gt;(æ¯”å¦‚test:80)ã€‚åœ¨loadbalancerå°†æµé‡è½¬å‘åˆ°backendä¹‹å‰ï¼Œæ‰€æœ‰çš„å…¥ç«™è¯·æ±‚éƒ½è¦å…ˆåŒ¹é…hostå’Œpathã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;10-12è¡Œ&lt;/strong&gt;ï¼šæ­£å¦‚ &lt;a href=&#34;https://kubernetes.io/docs/user-guide/services&#34;&gt;services doc&lt;/a&gt;ä¸­æè¿°çš„é‚£æ ·ï¼Œbackendæ˜¯ä¸€ä¸ª&lt;code&gt;service:port&lt;/code&gt;çš„ç»„åˆã€‚Ingressçš„æµé‡è¢«è½¬å‘åˆ°å®ƒæ‰€åŒ¹é…çš„backendã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å…¨å±€å‚æ•°&lt;/strong&gt;ï¼šä¸ºäº†ç®€å•èµ·è§ï¼ŒIngressç¤ºä¾‹ä¸­æ²¡æœ‰å…¨å±€å‚æ•°ï¼Œè¯·å‚é˜…èµ„æºå®Œæ•´å®šä¹‰çš„&lt;a href=&#34;https://releases.k8s.io/master/pkg/apis/extensions/v1beta1/types.go&#34;&gt;apiå‚è€ƒ&lt;/a&gt;ã€‚ åœ¨æ‰€æœ‰è¯·æ±‚éƒ½ä¸èƒ½è·Ÿspecä¸­çš„pathåŒ¹é…çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚è¢«å‘é€åˆ°Ingress controllerçš„é»˜è®¤åç«¯ï¼Œå¯ä»¥æŒ‡å®šå…¨å±€ç¼ºçœbackendã€‚&lt;/p&gt;

&lt;h2 id=&#34;ingress-controllers&#34;&gt;Ingress controllers&lt;/h2&gt;

&lt;p&gt;ä¸ºäº†ä½¿Ingressæ­£å¸¸å·¥ä½œï¼Œé›†ç¾¤ä¸­å¿…é¡»è¿è¡ŒIngress controllerã€‚ è¿™ä¸å…¶ä»–ç±»å‹çš„æ§åˆ¶å™¨ä¸åŒï¼Œå…¶ä»–ç±»å‹çš„æ§åˆ¶å™¨é€šå¸¸ä½œä¸º&lt;code&gt;kube-controller-manager&lt;/code&gt;äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸€éƒ¨åˆ†è¿è¡Œï¼Œåœ¨é›†ç¾¤å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ã€‚ ä½ éœ€è¦é€‰æ‹©æœ€é€‚åˆè‡ªå·±é›†ç¾¤çš„Ingress controlleræˆ–è€…è‡ªå·±å®ç°ä¸€ä¸ªã€‚ ç¤ºä¾‹å’Œè¯´æ˜å¯ä»¥åœ¨&lt;a href=&#34;https://github.com/kubernetes/ingress/tree/master/controllers&#34;&gt;è¿™é‡Œ&lt;/a&gt;æ‰¾åˆ°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;åœ¨ä½ å¼€å§‹å‰&#34;&gt;åœ¨ä½ å¼€å§‹å‰&lt;/h2&gt;

&lt;p&gt;ä»¥ä¸‹æ–‡æ¡£æè¿°äº†Ingressèµ„æºä¸­å…¬å¼€çš„ä¸€ç»„è·¨å¹³å°åŠŸèƒ½ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„Ingress controlleréƒ½åº”è¯¥ç¬¦åˆè¿™ä¸ªè§„èŒƒï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å®ç°ã€‚ GCEå’Œnginxæ§åˆ¶å™¨çš„æ–‡æ¡£åˆ†åˆ«åœ¨&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/gce/README.md&#34;&gt;è¿™é‡Œ&lt;/a&gt;å’Œ&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/nginx/README.md&#34;&gt;è¿™é‡Œ&lt;/a&gt;ã€‚&lt;strong&gt;ç¡®ä¿æ‚¨æŸ¥çœ‹æ§åˆ¶å™¨ç‰¹å®šçš„æ–‡æ¡£ï¼Œä»¥ä¾¿æ‚¨äº†è§£æ¯ä¸ªæ–‡æ¡£çš„æ³¨æ„äº‹é¡¹ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&#34;ingressç±»å‹&#34;&gt;Ingressç±»å‹&lt;/h2&gt;

&lt;h3 id=&#34;å•service-ingress&#34;&gt;å•Service Ingress&lt;/h3&gt;

&lt;p&gt;Kubernetesä¸­å·²ç»å­˜åœ¨ä¸€äº›æ¦‚å¿µå¯ä»¥æš´éœ²å•ä¸ªserviceï¼ˆæŸ¥çœ‹&lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/#alternatives&#34;&gt;æ›¿ä»£æ–¹æ¡ˆ&lt;/a&gt;ï¼‰ï¼Œä½†æ˜¯ä½ ä»ç„¶å¯ä»¥é€šè¿‡Ingressæ¥å®ç°ï¼Œé€šè¿‡æŒ‡å®šä¸€ä¸ªæ²¡æœ‰ruleçš„é»˜è®¤backendçš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;ingress.yamlå®šä¹‰æ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test-ingress
spec:
  backend:
    serviceName: testsvc
    servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;kubectl create -f&lt;/code&gt;å‘½ä»¤åˆ›å»ºï¼Œç„¶åæŸ¥çœ‹ingressï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get ing
NAME                RULE          BACKEND        ADDRESS
test-ingress        -             testsvc:80     107.178.254.228
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;107.178.254.228&lt;/code&gt;å°±æ˜¯Ingress controllerä¸ºäº†å®ç°Ingressè€Œåˆ†é…çš„IPåœ°å€ã€‚&lt;code&gt;RULE&lt;/code&gt;åˆ—è¡¨ç¤ºæ‰€æœ‰å‘é€ç»™è¯¥IPçš„æµé‡éƒ½è¢«è½¬å‘åˆ°äº†&lt;code&gt;BACKEND&lt;/code&gt;æ‰€åˆ—çš„Kubernetes serviceä¸Šã€‚&lt;/p&gt;

&lt;h3 id=&#34;ç®€å•å±•å¼€&#34;&gt;ç®€å•å±•å¼€&lt;/h3&gt;

&lt;p&gt;å¦‚å‰é¢æè¿°çš„é‚£æ ·ï¼Œkubernete podä¸­çš„IPåªåœ¨é›†ç¾¤ç½‘ç»œå†…éƒ¨å¯è§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¾¹ç•Œè®¾ç½®ä¸€ä¸ªä¸œè¥¿ï¼Œè®©å®ƒèƒ½å¤Ÿæ¥æ”¶ingressçš„æµé‡å¹¶å°†å®ƒä»¬è½¬å‘åˆ°æ­£ç¡®çš„ç«¯ç‚¹ä¸Šã€‚è¿™ä¸ªä¸œè¥¿ä¸€èˆ¬æ˜¯é«˜å¯ç”¨çš„loadbalancerã€‚ä½¿ç”¨Ingressèƒ½å¤Ÿå…è®¸ä½ å°†loadbalancerçš„ä¸ªæ•°é™ä½åˆ°æœ€å°‘ï¼Œä¾‹å¦‚ï¼Œå‡å¦‚ä½ æƒ³è¦åˆ›å»ºè¿™æ ·çš„ä¸€ä¸ªè®¾ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;foo.bar.com -&amp;gt; 178.91.123.132 -&amp;gt; / foo    s1:80
                                 / bar    s2:80

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½ éœ€è¦ä¸€ä¸ªè¿™æ ·çš„ingressï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test
spec:
  rules:
  - host: foo.bar.com
    http:
      paths:
      - path: /foo
        backend:
          serviceName: s1
          servicePort: 80
      - path: /bar
        backend:
          serviceName: s2
          servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;kubectl create -f&lt;/code&gt;åˆ›å»ºå®Œingressåï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get ing
NAME      RULE          BACKEND   ADDRESS
test      -
          foo.bar.com
          /foo          s1:80
          /bar          s2:80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åªè¦æœåŠ¡ï¼ˆs1ï¼Œs2ï¼‰å­˜åœ¨ï¼ŒIngress controllerå°±ä¼šå°†æä¾›ä¸€ä¸ªæ»¡è¶³è¯¥Ingressçš„ç‰¹å®šloadbalancerå®ç°ã€‚ è¿™ä¸€æ­¥å®Œæˆåï¼Œæ‚¨å°†åœ¨Ingressçš„æœ€åä¸€åˆ—çœ‹åˆ°loadbalancerçš„åœ°å€ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœº&#34;&gt;åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœº&lt;/h3&gt;

&lt;p&gt;Name-basedçš„è™šæ‹Ÿä¸»æœºåœ¨åŒä¸€ä¸ªIPåœ°å€ä¸‹æ‹¥æœ‰å¤šä¸ªä¸»æœºåã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;foo.bar.com --|                 |-&amp;gt; foo.bar.com s1:80
              | 178.91.123.132  |
bar.foo.com --|                 |-&amp;gt; bar.foo.com s2:80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸‹é¢è¿™ä¸ªingressè¯´æ˜åŸºäº&lt;a href=&#34;https://tools.ietf.org/html/rfc7230#section-5.4&#34;&gt;Host header&lt;/a&gt;çš„åç«¯loadbalancerçš„è·¯ç”±è¯·æ±‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: test
spec:
  rules:
  - host: foo.bar.com
    http:
      paths:
      - backend:
          serviceName: s1
          servicePort: 80
  - host: bar.foo.com
    http:
      paths:
      - backend:
          serviceName: s2
          servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;é»˜è®¤backend&lt;/strong&gt;ï¼šä¸€ä¸ªæ²¡æœ‰ruleçš„ingressï¼Œå¦‚å‰é¢ç« èŠ‚ä¸­æ‰€ç¤ºï¼Œæ‰€æœ‰æµé‡éƒ½å°†å‘é€åˆ°ä¸€ä¸ªé»˜è®¤backendã€‚ä½ å¯ä»¥ç”¨è¯¥æŠ€å·§é€šçŸ¥loadbalancerå¦‚ä½•æ‰¾åˆ°ä½ ç½‘ç«™çš„404é¡µé¢ï¼Œé€šè¿‡åˆ¶å®šä¸€äº›åˆ—ruleå’Œä¸€ä¸ªé»˜è®¤backendçš„æ–¹å¼ã€‚å¦‚æœè¯·æ±‚headerä¸­çš„hostä¸èƒ½è·Ÿingressä¸­çš„hoståŒ¹é…ï¼Œå¹¶ä¸”/æˆ–è¯·æ±‚çš„URLä¸èƒ½ä¸ä»»ä½•ä¸€ä¸ªpathåŒ¹é…ï¼Œåˆ™æµé‡å°†è·¯ç”±åˆ°ä½ çš„é»˜è®¤backendã€‚&lt;/p&gt;

&lt;h3 id=&#34;tls&#34;&gt;TLS&lt;/h3&gt;

&lt;p&gt;ä½ å¯ä»¥é€šè¿‡æŒ‡å®šåŒ…å«TLSç§é’¥å’Œè¯ä¹¦çš„&lt;a href=&#34;https://kubernetes.io/docs/user-guide/secrets&#34;&gt;secret&lt;/a&gt;æ¥åŠ å¯†Ingressã€‚ ç›®å‰ï¼ŒIngressä»…æ”¯æŒå•ä¸ªTLSç«¯å£443ï¼Œå¹¶å‡å®šTLS terminationã€‚ å¦‚æœIngressä¸­çš„TLSé…ç½®éƒ¨åˆ†æŒ‡å®šäº†ä¸åŒçš„ä¸»æœºï¼Œåˆ™å®ƒä»¬å°†æ ¹æ®é€šè¿‡SNI TLSæ‰©å±•æŒ‡å®šçš„ä¸»æœºåï¼ˆå‡å¦‚Ingress controlleræ”¯æŒSNIï¼‰åœ¨å¤šä¸ªç›¸åŒç«¯å£ä¸Šè¿›è¡Œå¤ç”¨ã€‚ TLS secretä¸­å¿…é¡»åŒ…å«åä¸º&lt;code&gt;tls.crt&lt;/code&gt;å’Œ&lt;code&gt;tls.key&lt;/code&gt;çš„å¯†é’¥ï¼Œè¿™é‡Œé¢åŒ…å«äº†ç”¨äºTLSçš„è¯ä¹¦å’Œç§é’¥ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Yaml&#34;&gt;apiVersion: v1
data:
  tls.crt: base64 encoded cert
  tls.key: base64 encoded key
kind: Secret
metadata:
  name: testsecret
  namespace: default
type: Opaque
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨Ingressä¸­å¼•ç”¨è¿™ä¸ªsecretå°†é€šçŸ¥Ingress controllerä½¿ç”¨TLSåŠ å¯†ä»å°†å®¢æˆ·ç«¯åˆ°loadbalancerçš„channelï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: no-rules-map
spec:
  tls:
    - secretName: testsecret
  backend:
    serviceName: s1
    servicePort: 80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯·æ³¨æ„ï¼Œå„ç§Ingress controlleræ”¯æŒçš„TLSåŠŸèƒ½ä¹‹é—´å­˜åœ¨å·®è·ã€‚ è¯·å‚é˜…æœ‰å…³&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/nginx/README.md#https&#34;&gt;nginx&lt;/a&gt;ï¼Œ&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/gce/README.md#tls&#34;&gt;GCE&lt;/a&gt;æˆ–ä»»ä½•å…¶ä»–å¹³å°ç‰¹å®šIngress controllerçš„æ–‡æ¡£ï¼Œä»¥äº†è§£TLSåœ¨ä½ çš„ç¯å¢ƒä¸­çš„å·¥ä½œåŸç†ã€‚&lt;/p&gt;

&lt;p&gt;Ingress controllerå¯åŠ¨æ—¶é™„å¸¦ä¸€äº›é€‚ç”¨äºæ‰€æœ‰Ingressçš„è´Ÿè½½å¹³è¡¡ç­–ç•¥è®¾ç½®ï¼Œä¾‹å¦‚è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œåç«¯æƒé‡æ–¹æ¡ˆç­‰ã€‚æ›´é«˜çº§çš„è´Ÿè½½å¹³è¡¡æ¦‚å¿µï¼ˆä¾‹å¦‚æŒä¹…ä¼šè¯ï¼ŒåŠ¨æ€æƒé‡ï¼‰å°šæœªåœ¨Ingressä¸­å…¬å¼€ã€‚ ä½ ä»ç„¶å¯ä»¥é€šè¿‡&lt;a href=&#34;https://github.com/kubernetes/contrib/tree/master/service-loadbalancer&#34;&gt;service loadbalancer&lt;/a&gt;è·å–è¿™äº›åŠŸèƒ½ã€‚ éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬è®¡åˆ’å°†é€‚ç”¨äºè·¨å¹³å°çš„è´Ÿè½½å¹³è¡¡æ¨¡å¼åŠ å…¥åˆ°Ingressèµ„æºä¸­ã€‚&lt;/p&gt;

&lt;p&gt;è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡å¥åº·æ£€æŸ¥ä¸ç›´æ¥é€šè¿‡Ingresså…¬å¼€ï¼Œä½†Kubernetesä¸­å­˜åœ¨å¹¶è¡Œæ¦‚å¿µï¼Œä¾‹å¦‚&lt;a href=&#34;https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/&#34;&gt;å‡†å¤‡æ¢æŸ¥&lt;/a&gt;ï¼Œå¯ä»¥ä½¿ä½ è¾¾æˆç›¸åŒçš„æœ€ç»ˆç»“æœã€‚ è¯·æŸ¥çœ‹ç‰¹å®šæ§åˆ¶å™¨çš„æ–‡æ¡£ï¼Œä»¥äº†è§£ä»–ä»¬å¦‚ä½•å¤„ç†å¥åº·æ£€æŸ¥ï¼ˆ&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/nginx/README.md&#34;&gt;nginx&lt;/a&gt;ï¼Œ&lt;a href=&#34;https://github.com/kubernetes/ingress/blob/master/controllers/gce/README.md#health-checks&#34;&gt;GCE&lt;/a&gt;ï¼‰ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ›´æ–°ingress&#34;&gt;æ›´æ–°Ingress&lt;/h2&gt;

&lt;p&gt;å‡å¦‚ä½ æƒ³è¦å‘å·²æœ‰çš„ingressä¸­å¢åŠ ä¸€ä¸ªæ–°çš„Hostï¼Œä½ å¯ä»¥ç¼–è¾‘å’Œæ›´æ–°è¯¥ingressï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Bash&#34;&gt;$ kubectl get ing
NAME      RULE          BACKEND   ADDRESS
test      -                       178.91.123.132
          foo.bar.com
          /foo          s1:80
$ kubectl edit ing test
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¼šå¼¹å‡ºä¸€ä¸ªåŒ…å«å·²æœ‰çš„yamlæ–‡ä»¶çš„ç¼–è¾‘å™¨ï¼Œä¿®æ”¹å®ƒï¼Œå¢åŠ æ–°çš„Hosté…ç½®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;spec:
  rules:
  - host: foo.bar.com
    http:
      paths:
      - backend:
          serviceName: s1
          servicePort: 80
        path: /foo
  - host: bar.baz.com
    http:
      paths:
      - backend:
          serviceName: s2
          servicePort: 80
        path: /foo
..
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿å­˜å®ƒä¼šæ›´æ–°API serverä¸­çš„èµ„æºï¼Œè¿™ä¼šè§¦å‘ingress controlleré‡æ–°é…ç½®loadbalancerã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get ing
NAME      RULE          BACKEND   ADDRESS
test      -                       178.91.123.132
          foo.bar.com
          /foo          s1:80
          bar.baz.com
          /foo          s2:80
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨ä¸€ä¸ªä¿®æ”¹è¿‡çš„ingress yamlæ–‡ä»¶ä¸Šè°ƒç”¨&lt;code&gt;kubectl replace -f&lt;/code&gt;å‘½ä»¤ä¸€æ ·å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚&lt;/p&gt;

&lt;h2 id=&#34;è·¨å¯ç”¨åŸŸæ•…éšœ&#34;&gt;è·¨å¯ç”¨åŸŸæ•…éšœ&lt;/h2&gt;

&lt;p&gt;åœ¨ä¸é€šäº‘ä¾›åº”å•†ä¹‹é—´ï¼Œè·¨æ•…éšœåŸŸçš„æµé‡ä¼ æ’­æŠ€æœ¯æœ‰æ‰€ä¸åŒã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ç›¸å…³Ingress controllerçš„æ–‡æ¡£ã€‚ æœ‰å…³åœ¨federationé›†ç¾¤ä¸­éƒ¨ç½²Ingressçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…&lt;a href=&#34;https://kubernetes.io/docs/concepts/cluster-administration/federation/&#34;&gt;federationæ–‡æ¡£&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æœªæ¥è®¡åˆ’&#34;&gt;æœªæ¥è®¡åˆ’&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;å¤šæ ·åŒ–çš„HTTPS/TLSæ¨¡å‹æ”¯æŒï¼ˆå¦‚SNIï¼Œre-encryptionï¼‰&lt;/li&gt;
&lt;li&gt;é€šè¿‡å£°æ˜æ¥è¯·æ±‚IPæˆ–è€…ä¸»æœºå&lt;/li&gt;
&lt;li&gt;ç»“åˆL4å’ŒL7 Ingress&lt;/li&gt;
&lt;li&gt;æ›´å¤šçš„Ingress controller&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¯·è·Ÿè¸ª&lt;a href=&#34;https://github.com/kubernetes/kubernetes/pull/12827&#34;&gt;L7å’ŒIngressçš„proposal&lt;/a&gt;ï¼Œäº†è§£æœ‰å…³èµ„æºæ¼”è¿›çš„æ›´å¤šç»†èŠ‚ï¼Œä»¥åŠ&lt;a href=&#34;https://github.com/kubernetes/ingress/tree/master&#34;&gt;Ingress repository&lt;/a&gt;ï¼Œäº†è§£æœ‰å…³å„ç§Ingress controlleræ¼”è¿›çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ›¿ä»£æ–¹æ¡ˆ&#34;&gt;æ›¿ä»£æ–¹æ¡ˆ&lt;/h2&gt;

&lt;p&gt;ä½ å¯ä»¥é€šè¿‡å¾ˆå¤šç§æ–¹å¼æš´éœ²serviceè€Œä¸å¿…ç›´æ¥ä½¿ç”¨ingressï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨&lt;a href=&#34;https://kubernetes.io/docs/user-guide/services/#type-loadbalancer&#34;&gt;Service.Type=LoadBalancer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;a href=&#34;https://kubernetes.io/docs/user-guide/services/#type-nodeport&#34;&gt;Service.Type=NodePort&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;a href=&#34;https://github.com/kubernetes/contrib/tree/master/for-demos/proxy-to-service&#34;&gt;Port Proxy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;éƒ¨ç½²ä¸€ä¸ª&lt;a href=&#34;https://github.com/kubernetes/contrib/tree/master/service-loadbalancer&#34;&gt;Service loadbalancer&lt;/a&gt; è¿™å…è®¸ä½ åœ¨å¤šä¸ªserviceä¹‹é—´å…±äº«å•ä¸ªIPï¼Œå¹¶é€šè¿‡Service Annotationså®ç°æ›´é«˜çº§çš„è´Ÿè½½å¹³è¡¡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/&#34;&gt;Kubernetes Ingress Resource&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://dockone.io/article/957&#34;&gt;ä½¿ç”¨NGINX Plusè´Ÿè½½å‡è¡¡KubernetesæœåŠ¡&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.cnblogs.com/276815076/p/6407101.html&#34;&gt;ä½¿ç”¨ NGINX å’Œ NGINX Plus çš„ Ingress Controller è¿›è¡Œ Kubernetes çš„è´Ÿè½½å‡è¡¡&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.osones.com/en/kubernetes-ingress-controller-with-traefik-and-lets-encrypt.html&#34;&gt;Kubernetes : Ingress Controller with TrÃ¦fÉªk and Let&amp;rsquo;s Encrypt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://blog.osones.com/en/kubernetes-traefik-and-lets-encrypt-at-scale.html&#34;&gt;Kubernetes : TrÃ¦fÉªk and Let&amp;rsquo;s Encrypt at scale&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://docs.traefik.io/user-guide/kubernetes/&#34;&gt;Kubernetes Ingress Controller-TrÃ¦fÉªk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://blog.kubernetes.io/2016/03/Kubernetes-1.2-and-simplifying-advanced-networking-with-Ingress.html&#34;&gt;Kubernetes 1.2 and simplifying advanced networking with Ingress&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetes Handbookå‘èµ·</title>
      <link>http://rootsongjc.github.io/projects/kubernetes-handbook-startup/</link>
      <pubDate>Fri, 14 Apr 2017 19:33:27 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/projects/kubernetes-handbook-startup/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2015092726.jpg&#34; alt=&#34;åœ°å›&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šåœ°å›å…¬å›­ Sep 27,2015ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;ç©è½¬Kubernetesï¼Œæˆ‘å°±çœ‹kubernetes handbookï¼&lt;/p&gt;

&lt;p&gt;GitHubåœ°å€ï¼š&lt;a href=&#34;https://github.com/rootsongjc/kubernetes-handbook&#34;&gt;https://github.com/rootsongjc/kubernetes-handbook&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;æ–‡ç« åŒæ­¥æ›´æ–°åˆ°&lt;a href=&#34;https://www.gitbook.com/book/rootsongjc/kubernetes-handbook/details&#34;&gt;gitbook&lt;/a&gt;ï¼Œæ–¹ä¾¿å¤§å®¶æµè§ˆå’Œä¸‹è½½PDFã€‚&lt;/p&gt;

&lt;h2 id=&#34;è¯´æ˜&#34;&gt;è¯´æ˜&lt;/h2&gt;

&lt;p&gt;æ–‡ä¸­æ¶‰åŠçš„é…ç½®æ–‡ä»¶å’Œä»£ç é“¾æ¥åœ¨gitbookä¸­ä¼šæ— æ³•æ‰“å¼€ï¼Œè¯·ä¸‹è½½githubæºç åï¼Œåœ¨MarkDownç¼–è¾‘å™¨ä¸­æ‰“å¼€ï¼Œç‚¹å‡»é“¾æ¥å°†è·³è½¬åˆ°ä½ çš„æœ¬åœ°ç›®å½•ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å¦‚ä½•ä½¿ç”¨&#34;&gt;å¦‚ä½•ä½¿ç”¨&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼ä¸€ï¼šåœ¨çº¿æµè§ˆ&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;è®¿é—®gitbookï¼š&lt;a href=&#34;https://www.gitbook.com/book/rootsongjc/kubernetes-handbook/&#34;&gt;https://www.gitbook.com/book/rootsongjc/kubernetes-handbook/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼äºŒï¼šæœ¬åœ°æŸ¥çœ‹&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å°†ä»£ç å…‹éš†åˆ°æœ¬åœ°&lt;/li&gt;
&lt;li&gt;å®‰è£…gitbookï¼š&lt;a href=&#34;https://github.com/GitbookIO/gitbook/blob/master/docs/setup.md&#34;&gt;Setup and Installation of GitBook&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œgitbook serve&lt;/li&gt;
&lt;li&gt;åœ¨æµè§ˆå™¨ä¸­è®¿é—®&lt;a href=&#34;http://localhost:4000&#34;&gt;http://localhost:4000&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;P.S æœ¬ä¹¦ä¸­ä¹Ÿå°†è®°å½•ä¸šç•ŒåŠ¨æ€å’Œç»éªŒåˆ†äº«ï¼Œæ¬¢è¿åˆ†äº«ä½ çš„&lt;strong&gt;ç‹¬åˆ°&lt;/strong&gt;è§è§£ã€‚&lt;/p&gt;

&lt;p&gt;åŠ å…¥Kubernetesäº¤æµç¾¤ï¼Œè¯·æ·»åŠ æˆ‘å¾®ä¿¡&lt;a href=&#34;http://rootsongjc.github.io/about&#34;&gt;jimmysong&lt;/a&gt;ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetes1.6é›†ç¾¤éƒ¨ç½²å®Œå…¨æŒ‡å— â€”â€”äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²å¼€å¯TLSåŸºäºCentOS7å‘å¸ƒ</title>
      <link>http://rootsongjc.github.io/projects/kubernetes-installation-document/</link>
      <pubDate>Thu, 13 Apr 2017 14:00:04 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/projects/kubernetes-installation-document/</guid>
      <description>&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016081309.jpg&#34; alt=&#34;é¦–éƒ½æœºåœº&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šæ¸…æ™¨@é¦–éƒ½æœºåœº Aug 13,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è¿™å¯èƒ½æ˜¯ç›®å‰ä¸ºæ­¢æœ€è¯¦ç»†çš„kuberneteså®‰è£…æ–‡æ¡£äº†ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç»è¿‡å‡ å¤©çš„å®‰è£…ã€è°ƒè¯•ã€æ•´ç†ï¼Œä»Šå¤©è¯¥æ–‡æ¡£ç»ˆäºå‘å¸ƒäº†ã€‚&lt;/p&gt;

&lt;p&gt;ä½ å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½² kubernetes1.6 é›†ç¾¤&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;æˆ–è€…ç›´æ¥ä¸‹è½½&lt;a href=&#34;http://olz1di9xf.bkt.clouddn.com/Kubernetes1.6%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E2%80%94%E2%80%94%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E9%83%A8%E7%BD%B2%E5%BC%80%E5%90%AFTLS%E5%9F%BA%E4%BA%8ECentOS7.pdf&#34;&gt;pdf&lt;/a&gt;ç‰ˆæœ¬ï¼ˆ2.92Mï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;Kubernetesçš„å®‰è£…ç¹çï¼Œæ­¥éª¤å¤æ‚ï¼Œè¯¥æ–‡æ¡£èƒ½å¤Ÿå¸®åŠ©è·³è¿‡å¾ˆå¤šå‘ï¼ŒèŠ‚çº¦ä¸å°‘æ—¶é—´ï¼Œæˆ‘åœ¨æœ¬åœ°ç¯å¢ƒä¸Šå·²ç»å®‰è£…å®Œæˆï¼Œæœ‰é—®é¢˜æ¬¢è¿åœ¨&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;GitHub&lt;/a&gt;ä¸Šæissueã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å®‰è£…çš„é›†ç¾¤è¯¦æƒ…&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Kubernetes 1.6.0&lt;/li&gt;
&lt;li&gt;Docker 1.12.5ï¼ˆä½¿ç”¨yumå®‰è£…ï¼‰&lt;/li&gt;
&lt;li&gt;Etcd 3.1.5&lt;/li&gt;
&lt;li&gt;Flanneld 0.7 vxlan ç½‘ç»œ&lt;/li&gt;
&lt;li&gt;TLS è®¤è¯é€šä¿¡ (æ‰€æœ‰ç»„ä»¶ï¼Œå¦‚ etcdã€kubernetes master å’Œ node)&lt;/li&gt;
&lt;li&gt;RBAC æˆæƒ&lt;/li&gt;
&lt;li&gt;kublet TLS BootStrapping&lt;/li&gt;
&lt;li&gt;kubednsã€dashboardã€heapster(influxdbã€grafana)ã€EFK(elasticsearchã€fluentdã€kibana) é›†ç¾¤æ’ä»¶&lt;/li&gt;
&lt;li&gt;ç§æœ‰dockeré•œåƒä»“åº“&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster/blob/master/github.com/vmware/harbor&#34;&gt;harbor&lt;/a&gt;ï¼ˆè¯·è‡ªè¡Œéƒ¨ç½²ï¼Œharboræä¾›ç¦»çº¿å®‰è£…åŒ…ï¼Œç›´æ¥ä½¿ç”¨docker-composeå¯åŠ¨å³å¯ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;è¯¥æ–‡æ¡£ä¸­åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åˆ›å»º TLS é€šä¿¡æ‰€éœ€çš„è¯ä¹¦å’Œç§˜é’¥&lt;/li&gt;
&lt;li&gt;åˆ›å»º kubeconfig æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;åˆ›å»ºä¸‰èŠ‚ç‚¹çš„é«˜å¯ç”¨ etcd é›†ç¾¤&lt;/li&gt;
&lt;li&gt;kubectlå‘½ä»¤è¡Œå·¥å…·&lt;/li&gt;
&lt;li&gt;éƒ¨ç½²é«˜å¯ç”¨ master é›†ç¾¤&lt;/li&gt;
&lt;li&gt;éƒ¨ç½² node èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;kubedns æ’ä»¶&lt;/li&gt;
&lt;li&gt;Dashboard æ’ä»¶&lt;/li&gt;
&lt;li&gt;Heapster æ’ä»¶&lt;/li&gt;
&lt;li&gt;EFK æ’ä»¶&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>åœ¨å¼€å¯TLSçš„Kubernetes1.6é›†ç¾¤ä¸Šå®‰è£…EFK</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-efk-installation-with-tls/</link>
      <pubDate>Thu, 13 Apr 2017 12:28:10 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-efk-installation-with-tls/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016061706.jpg&#34; alt=&#34;ç°‹è¡—&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šç°‹è¡— Jun 17,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®(forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;)ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œåœ¨å¼€å¯äº†TLSéªŒè¯çš„é›†ç¾¤ä¸­éƒ¨ç½²EFKæ—¥å¿—æ”¶é›†ç›‘æ§æ’ä»¶ã€‚&lt;/p&gt;

&lt;h1 id=&#34;é…ç½®å’Œå®‰è£…-efk&#34;&gt;é…ç½®å’Œå®‰è£… EFK&lt;/h1&gt;

&lt;p&gt;å®˜æ–¹æ–‡ä»¶ç›®å½•ï¼š&lt;code&gt;cluster/addons/fluentd-elasticsearch&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls *.yaml
es-controller.yaml  es-service.yaml  fluentd-es-ds.yaml  kibana-controller.yaml  kibana-service.yaml efk-rbac.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ ·EFKæœåŠ¡ä¹Ÿéœ€è¦ä¸€ä¸ª&lt;code&gt;efk-rbac.yaml&lt;/code&gt;æ–‡ä»¶ï¼Œé…ç½®serviceaccountä¸º&lt;code&gt;efk&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å·²ç»ä¿®æ”¹å¥½çš„ yaml æ–‡ä»¶è§ï¼š&lt;a href=&#34;./manifests/EFK&#34;&gt;EFK&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-es-controller-yaml&#34;&gt;é…ç½® es-controller.yaml&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff es-controller.yaml.orig es-controller.yaml
24c24
&amp;lt;       - image: gcr.io/google_containers/elasticsearch:v2.4.1-2
---
&amp;gt;       - image: sz-pg-oam-docker-hub-001.tendcloud.com/library/elasticsearch:v2.4.1-2
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®-es-service-yaml&#34;&gt;é…ç½® es-service.yaml&lt;/h2&gt;

&lt;p&gt;æ— éœ€é…ç½®ï¼›&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-fluentd-es-ds-yaml&#34;&gt;é…ç½® fluentd-es-ds.yaml&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff fluentd-es-ds.yaml.orig fluentd-es-ds.yaml
26c26
&amp;lt;         image: gcr.io/google_containers/fluentd-elasticsearch:1.22
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/fluentd-elasticsearch:1.22
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®-kibana-controller-yaml&#34;&gt;é…ç½® kibana-controller.yaml&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff kibana-controller.yaml.orig kibana-controller.yaml
22c22
&amp;lt;         image: gcr.io/google_containers/kibana:v4.6.1-1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/kibana:v4.6.1-1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ç»™-node-è®¾ç½®æ ‡ç­¾&#34;&gt;ç»™ Node è®¾ç½®æ ‡ç­¾&lt;/h2&gt;

&lt;p&gt;å®šä¹‰ DaemonSet &lt;code&gt;fluentd-es-v1.22&lt;/code&gt; æ—¶è®¾ç½®äº† nodeSelector &lt;code&gt;beta.kubernetes.io/fluentd-ds-ready=true&lt;/code&gt; ï¼Œæ‰€ä»¥éœ€è¦åœ¨æœŸæœ›è¿è¡Œ fluentd çš„ Node ä¸Šè®¾ç½®è¯¥æ ‡ç­¾ï¼›&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get nodes
NAME        STATUS    AGE       VERSION
172.20.0.113   Ready     1d        v1.6.0

$ kubectl label nodes 172.20.0.113 beta.kubernetes.io/fluentd-ds-ready=true
node &amp;quot;172.20.0.113&amp;quot; labeled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»™å…¶ä»–ä¸¤å°nodeæ‰“ä¸ŠåŒæ ·çš„æ ‡ç­¾ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ‰§è¡Œå®šä¹‰æ–‡ä»¶&#34;&gt;æ‰§è¡Œå®šä¹‰æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl create -f .
serviceaccount &amp;quot;efk&amp;quot; created
clusterrolebinding &amp;quot;efk&amp;quot; created
replicationcontroller &amp;quot;elasticsearch-logging-v1&amp;quot; created
service &amp;quot;elasticsearch-logging&amp;quot; created
daemonset &amp;quot;fluentd-es-v1.22&amp;quot; created
deployment &amp;quot;kibana-logging&amp;quot; created
service &amp;quot;kibana-logging&amp;quot; created
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ£€æŸ¥æ‰§è¡Œç»“æœ&#34;&gt;æ£€æŸ¥æ‰§è¡Œç»“æœ&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get deployment -n kube-system|grep kibana
kibana-logging         1         1         1            1           2m

$ kubectl get pods -n kube-system|grep -E &#39;elasticsearch|fluentd|kibana&#39;
elasticsearch-logging-v1-mlstp          1/1       Running   0          1m
elasticsearch-logging-v1-nfbbf          1/1       Running   0          1m
fluentd-es-v1.22-31sm0                  1/1       Running   0          1m
fluentd-es-v1.22-bpgqs                  1/1       Running   0          1m
fluentd-es-v1.22-qmn7h                  1/1       Running   0          1m
kibana-logging-1432287342-0gdng         1/1       Running   0          1m

$ kubectl get service  -n kube-system|grep -E &#39;elasticsearch|kibana&#39;
elasticsearch-logging   10.254.77.62    &amp;lt;none&amp;gt;        9200/TCP                        2m
kibana-logging          10.254.8.113    &amp;lt;none&amp;gt;        5601/TCP                        2m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;kibana Pod ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šç”¨&lt;strong&gt;è¾ƒé•¿æ—¶é—´(10-20åˆ†é’Ÿ)&lt;/strong&gt;æ¥ä¼˜åŒ–å’Œ Cache çŠ¶æ€é¡µé¢ï¼Œå¯ä»¥ tailf è¯¥ Pod çš„æ—¥å¿—è§‚å¯Ÿè¿›åº¦ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl logs kibana-logging-1432287342-0gdng -n kube-system -f
ELASTICSEARCH_URL=http://elasticsearch-logging:9200
server.basePath: /api/v1/proxy/namespaces/kube-system/services/kibana-logging
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:08:06Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;info&amp;quot;,&amp;quot;optimize&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;message&amp;quot;:&amp;quot;Optimizing and caching bundles for kibana and statusPage. This may take a few minutes&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:17Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;info&amp;quot;,&amp;quot;optimize&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;message&amp;quot;:&amp;quot;Optimization of bundles for kibana and statusPage complete in 610.40 seconds&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:17Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:kibana@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:18Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:elasticsearch@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;yellow&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to yellow - Waiting for Elasticsearch&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:kbn_vislib_vis_types@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:markdown_vis@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:metric_vis@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:spyModes@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:statusPage@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:table_vis@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from uninitialized to green - Ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;uninitialized&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;uninitialized&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:19Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;listening&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;message&amp;quot;:&amp;quot;Server running at http://0.0.0.0:5601&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:24Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:elasticsearch@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;yellow&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from yellow to yellow - No existing Kibana index found&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;yellow&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;Waiting for Elasticsearch&amp;quot;}
{&amp;quot;type&amp;quot;:&amp;quot;log&amp;quot;,&amp;quot;@timestamp&amp;quot;:&amp;quot;2017-04-12T13:18:29Z&amp;quot;,&amp;quot;tags&amp;quot;:[&amp;quot;status&amp;quot;,&amp;quot;plugin:elasticsearch@1.0.0&amp;quot;,&amp;quot;info&amp;quot;],&amp;quot;pid&amp;quot;:7,&amp;quot;state&amp;quot;:&amp;quot;green&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;Status changed from yellow to green - Kibana index ready&amp;quot;,&amp;quot;prevState&amp;quot;:&amp;quot;yellow&amp;quot;,&amp;quot;prevMsg&amp;quot;:&amp;quot;No existing Kibana index found&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è®¿é—®-kibana&#34;&gt;è®¿é—® kibana&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;é€šè¿‡ kube-apiserver è®¿é—®ï¼š&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è·å– monitoring-grafana æœåŠ¡ URL&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;   $ kubectl cluster-info
   Kubernetes master is running at https://172.20.0.113:6443
   Elasticsearch is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/elasticsearch-logging
   Heapster is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/heapster
   Kibana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kibana-logging
   KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
   kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
   monitoring-grafana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
   monitoring-influxdb is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š &lt;code&gt;https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kibana-logging/app/kibana&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;é€šè¿‡ kubectl proxy è®¿é—®ï¼š&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;åˆ›å»ºä»£ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;   $ kubectl proxy --address=&#39;172.20.0.113&#39; --port=8086 --accept-hosts=&#39;^*$&#39;
   Starting to serve on 172.20.0.113:8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š&lt;code&gt;http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/kibana-logging&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;åœ¨ Settings -&amp;gt; Indices é¡µé¢åˆ›å»ºä¸€ä¸ª indexï¼ˆç›¸å½“äº mysql ä¸­çš„ä¸€ä¸ª databaseï¼‰ï¼Œé€‰ä¸­ &lt;code&gt;Index contains time-based events&lt;/code&gt;ï¼Œä½¿ç”¨é»˜è®¤çš„ &lt;code&gt;logstash-*&lt;/code&gt; patternï¼Œç‚¹å‡» &lt;code&gt;Create&lt;/code&gt; ;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¯èƒ½é‡åˆ°çš„é—®é¢˜&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœä½ åœ¨è¿™é‡Œå‘ç°CreateæŒ‰é’®æ˜¯ç°è‰²çš„æ— æ³•ç‚¹å‡»ï¼Œä¸”Time-filed nameä¸­æ²¡æœ‰é€‰é¡¹ï¼Œfluentdè¦è¯»å–&lt;code&gt;/var/log/containers/&lt;/code&gt;ç›®å½•ä¸‹çš„logæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯ä»&lt;code&gt;/var/lib/docker/containers/${CONTAINER_ID}/${CONTAINER_ID}-json.log&lt;/code&gt;é“¾æ¥è¿‡æ¥çš„ï¼ŒæŸ¥çœ‹ä½ çš„dockeré…ç½®ï¼Œ&lt;code&gt;â€”log-dirver&lt;/code&gt;éœ€è¦è®¾ç½®ä¸º&lt;strong&gt;json-file&lt;/strong&gt;æ ¼å¼ï¼Œé»˜è®¤çš„å¯èƒ½æ˜¯&lt;strong&gt;journald&lt;/strong&gt;ï¼Œå‚è€ƒ&lt;a href=&#34;[https://docs.docker.com/engine/admin/logging/overview/#examples](https://docs.docker.com/engine/admin/logging/overview/#examples)&#34;&gt;docker logging&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-es-setting.png&#34; alt=&#34;es-setting&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åˆ›å»ºIndexåï¼Œå¯ä»¥åœ¨ &lt;code&gt;Discover&lt;/code&gt; ä¸‹çœ‹åˆ° ElasticSearch logging ä¸­æ±‡èšçš„æ—¥å¿—ï¼›&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-efk-kibana.jpg&#34; alt=&#34;es-home&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è‡³æ­¤Kubernetesçš„æ‰€æœ‰ç¯å¢ƒéƒ½å®‰è£…å®Œæˆã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>åœ¨å¼€å¯TLSçš„Kubernetes1.6é›†ç¾¤ä¸Šå®‰è£…heapster</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-heapster-installation-with-tls/</link>
      <pubDate>Wed, 12 Apr 2017 20:20:19 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-heapster-installation-with-tls/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016080801.jpg&#34; alt=&#34;å¤§å–µ&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šå¤§å–µ Aug 8,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®(forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;)ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œåœ¨å¼€å¯äº†TLSéªŒè¯çš„é›†ç¾¤ä¸­éƒ¨ç½²heapsterï¼ŒåŒ…æ‹¬influxdbã€grafanaç­‰ç»„ä»¶ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®å’Œå®‰è£…heapster&#34;&gt;é…ç½®å’Œå®‰è£…Heapster&lt;/h2&gt;

&lt;p&gt;åˆ° &lt;a href=&#34;https://github.com/kubernetes/heapster/releases&#34;&gt;heapster release é¡µé¢&lt;/a&gt; ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ heapsterã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ wget https://github.com/kubernetes/heapster/archive/v1.3.0.zip
$ unzip v1.3.0.zip
$ mv v1.3.0.zip heapster-1.3.0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ–‡ä»¶ç›®å½•ï¼š &lt;code&gt;heapster-1.3.0/deploy/kube-config/influxdb&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd heapster-1.3.0/deploy/kube-config/influxdb
$ ls *.yaml
grafana-deployment.yaml  grafana-service.yaml  heapster-deployment.yaml  heapster-service.yaml  influxdb-deployment.yaml  influxdb-service.yaml heapster-rbac.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬è‡ªå·±åˆ›å»ºäº†heapsterçš„rbacé…ç½®&lt;code&gt;heapster-rbac.yaml&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å·²ç»ä¿®æ”¹å¥½çš„ yaml æ–‡ä»¶è§ï¼š&lt;a href=&#34;./manifests/heapster&#34;&gt;heapster&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-grafana-deployment&#34;&gt;é…ç½® grafana-deployment&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff grafana-deployment.yaml.orig grafana-deployment.yaml
16c16
&amp;lt;         image: gcr.io/google_containers/heapster-grafana-amd64:v4.0.2
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-grafana-amd64:v4.0.2
40,41c40,41
&amp;lt;           # value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/
&amp;lt;           value: /
---
&amp;gt;           value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/
&amp;gt;           #value: /
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœåç»­ä½¿ç”¨ kube-apiserver æˆ–è€… kubectl proxy è®¿é—® grafana dashboardï¼Œåˆ™å¿…é¡»å°† &lt;code&gt;GF_SERVER_ROOT_URL&lt;/code&gt; è®¾ç½®ä¸º &lt;code&gt;/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/&lt;/code&gt;ï¼Œå¦åˆ™åç»­è®¿é—®grafanaæ—¶è®¿é—®æ—¶æç¤ºæ‰¾ä¸åˆ°&lt;code&gt;http://10.64.3.7:8086/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/api/dashboards/home&lt;/code&gt; é¡µé¢ï¼›&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-heapster-deployment&#34;&gt;é…ç½® heapster-deployment&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff heapster-deployment.yaml.orig heapster-deployment.yaml
16c16
&amp;lt;         image: gcr.io/google_containers/heapster-amd64:v1.3.0-beta.1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-amd64:v1.3.0-beta.1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®-influxdb-deployment&#34;&gt;é…ç½® influxdb-deployment&lt;/h2&gt;

&lt;p&gt;influxdb å®˜æ–¹å»ºè®®ä½¿ç”¨å‘½ä»¤è¡Œæˆ– HTTP API æ¥å£æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œä» v1.1.0 ç‰ˆæœ¬å¼€å§‹é»˜è®¤å…³é—­ admin UIï¼Œå°†åœ¨åç»­ç‰ˆæœ¬ä¸­ç§»é™¤ admin UI æ’ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;å¼€å¯é•œåƒä¸­ admin UIçš„åŠæ³•å¦‚ä¸‹ï¼šå…ˆå¯¼å‡ºé•œåƒä¸­çš„ influxdb é…ç½®æ–‡ä»¶ï¼Œå¼€å¯ admin æ’ä»¶åï¼Œå†å°†é…ç½®æ–‡ä»¶å†…å®¹å†™å…¥ ConfigMapï¼Œæœ€åæŒ‚è½½åˆ°é•œåƒä¸­ï¼Œè¾¾åˆ°è¦†ç›–åŸå§‹é…ç½®çš„ç›®çš„ï¼š&lt;/p&gt;

&lt;p&gt;æ³¨æ„ï¼šmanifests ç›®å½•å·²ç»æä¾›äº† &lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/manifests/heapster/influxdb-cm.yaml&#34;&gt;ä¿®æ”¹åçš„ ConfigMap å®šä¹‰æ–‡ä»¶&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ # å¯¼å‡ºé•œåƒä¸­çš„ influxdb é…ç½®æ–‡ä»¶
$ docker run --rm --entrypoint &#39;cat&#39;  -ti lvanneo/heapster-influxdb-amd64:v1.1.1 /etc/config.toml &amp;gt;config.toml.orig
$ cp config.toml.orig config.toml
$ # ä¿®æ”¹ï¼šå¯ç”¨ admin æ¥å£
$ vim config.toml
$ diff config.toml.orig config.toml
35c35
&amp;lt;   enabled = false
---
&amp;gt;   enabled = true
$ # å°†ä¿®æ”¹åçš„é…ç½®å†™å…¥åˆ° ConfigMap å¯¹è±¡ä¸­
$ kubectl create configmap influxdb-config --from-file=config.toml  -n kube-system
configmap &amp;quot;influxdb-config&amp;quot; created
$ # å°† ConfigMap ä¸­çš„é…ç½®æ–‡ä»¶æŒ‚è½½åˆ° Pod ä¸­ï¼Œè¾¾åˆ°è¦†ç›–åŸå§‹é…ç½®çš„ç›®çš„
$ diff influxdb-deployment.yaml.orig influxdb-deployment.yaml
16c16
&amp;lt;         image: grc.io/google_containers/heapster-influxdb-amd64:v1.1.1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/heapster-influxdb-amd64:v1.1.1
19a20,21
&amp;gt;         - mountPath: /etc/
&amp;gt;           name: influxdb-config
22a25,27
&amp;gt;       - name: influxdb-config
&amp;gt;         configMap:
&amp;gt;           name: influxdb-config
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®-monitoring-influxdb-service&#34;&gt;é…ç½® monitoring-influxdb Service&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ diff influxdb-service.yaml.orig influxdb-service.yaml
12a13
&amp;gt;   type: NodePort
15a17,20
&amp;gt;     name: http
&amp;gt;   - port: 8083
&amp;gt;     targetPort: 8083
&amp;gt;     name: admin
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;å®šä¹‰ç«¯å£ç±»å‹ä¸º NodePortï¼Œé¢å¤–å¢åŠ äº† admin ç«¯å£æ˜ å°„ï¼Œç”¨äºåç»­æµè§ˆå™¨è®¿é—® influxdb çš„ admin UI ç•Œé¢ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&#34;&gt;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pwd
/root/heapster-1.3.0/deploy/kube-config/influxdb
$ ls *.yaml
grafana-service.yaml      heapster-rbac.yaml     influxdb-cm.yaml          influxdb-service.yaml
grafana-deployment.yaml  heapster-deployment.yaml  heapster-service.yaml  influxdb-deployment.yaml
$ kubectl create -f  .
deployment &amp;quot;monitoring-grafana&amp;quot; created
service &amp;quot;monitoring-grafana&amp;quot; created
deployment &amp;quot;heapster&amp;quot; created
serviceaccount &amp;quot;heapster&amp;quot; created
clusterrolebinding &amp;quot;heapster&amp;quot; created
service &amp;quot;heapster&amp;quot; created
configmap &amp;quot;influxdb-config&amp;quot; created
deployment &amp;quot;monitoring-influxdb&amp;quot; created
service &amp;quot;monitoring-influxdb&amp;quot; created
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ£€æŸ¥æ‰§è¡Œç»“æœ&#34;&gt;æ£€æŸ¥æ‰§è¡Œç»“æœ&lt;/h2&gt;

&lt;p&gt;æ£€æŸ¥ Deployment&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get deployments -n kube-system | grep -E &#39;heapster|monitoring&#39;
heapster               1         1         1            1           2m
monitoring-grafana     1         1         1            1           2m
monitoring-influxdb    1         1         1            1           2m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€æŸ¥ Pods&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get pods -n kube-system | grep -E &#39;heapster|monitoring&#39;
heapster-110704576-gpg8v                1/1       Running   0          2m
monitoring-grafana-2861879979-9z89f     1/1       Running   0          2m
monitoring-influxdb-1411048194-lzrpc    1/1       Running   0          2m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€æŸ¥ kubernets dashboard ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„ Nodesã€Pods çš„ CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾ï¼›&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-dashboard-with-heapster.jpg&#34; alt=&#34;dashboard-heapster&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;è®¿é—®-grafana&#34;&gt;è®¿é—® grafana&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;é€šè¿‡ kube-apiserver è®¿é—®ï¼š&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è·å– monitoring-grafana æœåŠ¡ URL&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;   $ kubectl cluster-info
   Kubernetes master is running at https://172.20.0.113:6443
   Heapster is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/heapster
   KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
   kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
   monitoring-grafana is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
   monitoring-influxdb is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb

   To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š &lt;code&gt;http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana&lt;/code&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;é€šè¿‡ kubectl proxy è®¿é—®ï¼š&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;åˆ›å»ºä»£ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;   $ kubectl proxy --address=&#39;172.20.0.113&#39; --port=8086 --accept-hosts=&#39;^*$&#39;
   Starting to serve on 172.20.0.113:8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š&lt;code&gt;http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-heapster-grafana.jpg&#34; alt=&#34;grafana&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;è®¿é—®-influxdb-admin-ui&#34;&gt;è®¿é—® influxdb admin UI&lt;/h2&gt;

&lt;p&gt;è·å– influxdb http 8086 æ˜ å°„çš„ NodePort&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ kubectl get svc -n kube-system|grep influxdb
monitoring-influxdb    10.254.22.46    &amp;lt;nodes&amp;gt;       8086:32299/TCP,8083:30269/TCP   9m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡ kube-apiserver çš„&lt;strong&gt;éå®‰å…¨ç«¯å£&lt;/strong&gt;è®¿é—® influxdb çš„ admin UI ç•Œé¢ï¼š &lt;code&gt;http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb:8083/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;åœ¨é¡µé¢çš„ â€œConnection Settingsâ€ çš„ Host ä¸­è¾“å…¥ node IPï¼Œ Port ä¸­è¾“å…¥ 8086 æ˜ å°„çš„ nodePort å¦‚ä¸Šé¢çš„ 32299ï¼Œç‚¹å‡» â€œSaveâ€ å³å¯ï¼ˆæˆ‘çš„é›†ç¾¤ä¸­çš„åœ°å€æ˜¯172.20.0.113:32299ï¼‰ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-influxdb-heapster.jpg&#34; alt=&#34;kubernetes-influxdb-heapster&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åˆ°æ­¤Heapsterå·²ç»éƒ¨ç½²å®Œæˆã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>åœ¨å¼€å¯TLSçš„Kubernetes1.6é›†ç¾¤ä¸Šå®‰è£…dashboard</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation-with-tls/</link>
      <pubDate>Wed, 12 Apr 2017 15:53:39 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation-with-tls/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016082001.jpg&#34; alt=&#34;ä¸œç›´é—¨&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šä¸œç›´é—¨æ¡¥ Aug 20,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®(forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;)ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œåœ¨å¼€å¯äº†TLSéªŒè¯çš„é›†ç¾¤ä¸­éƒ¨ç½²dashboardã€‚&lt;/p&gt;

&lt;p&gt;æ„Ÿè°¢&lt;a href=&#34;github.com/opsnull&#34;&gt;opsnull&lt;/a&gt;å’Œ&lt;a href=&#34;github.com/ipchy&#34;&gt;ipchy&lt;/a&gt;çš„ç»†å¿ƒè§£ç­”ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å®‰è£…ç¯å¢ƒé…ç½®ä¿¡æ¯&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CentOS 7.2.1511&lt;/li&gt;
&lt;li&gt;Docker 1.12.5&lt;/li&gt;
&lt;li&gt;Flannel 0.7&lt;/li&gt;
&lt;li&gt;Kubernetes 1.6.0&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;é…ç½®å’Œå®‰è£…-dashboard&#34;&gt;é…ç½®å’Œå®‰è£… dashboard&lt;/h2&gt;

&lt;p&gt;å®˜æ–¹æ–‡ä»¶ç›®å½•ï¼š&lt;code&gt;kubernetes/cluster/addons/dashboard&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬ä½¿ç”¨çš„æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls *.yaml
dashboard-controller.yaml  dashboard-service.yaml dashboard-rbac.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å·²ç»ä¿®æ”¹å¥½çš„ yaml æ–‡ä»¶è§ï¼š&lt;a href=&#34;./manifests/dashboard&#34;&gt;dashboard&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç”±äº &lt;code&gt;kube-apiserver&lt;/code&gt; å¯ç”¨äº† &lt;code&gt;RBAC&lt;/code&gt; æˆæƒï¼Œè€Œå®˜æ–¹æºç ç›®å½•çš„ &lt;code&gt;dashboard-controller.yaml&lt;/code&gt; æ²¡æœ‰å®šä¹‰æˆæƒçš„ ServiceAccountï¼Œæ‰€ä»¥åç»­è®¿é—® &lt;code&gt;kube-apiserver&lt;/code&gt; çš„ API æ—¶ä¼šè¢«æ‹’ç»ï¼Œwebä¸­æç¤ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Forbidden (403)

User &amp;quot;system:serviceaccount:kube-system:default&amp;quot; cannot list jobs.batch in the namespace &amp;quot;default&amp;quot;. (get jobs.batch)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¢åŠ äº†ä¸€ä¸ª&lt;code&gt;dashboard-rbac.yaml&lt;/code&gt;æ–‡ä»¶ï¼Œå®šä¹‰ä¸€ä¸ªåä¸º dashboard çš„ ServiceAccountï¼Œç„¶åå°†å®ƒå’Œ Cluster Role view ç»‘å®šã€‚&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®dashboard-service&#34;&gt;é…ç½®dashboard-service&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff dashboard-service.yaml.orig dashboard-service.yaml
10a11
&amp;gt;   type: NodePort
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;æŒ‡å®šç«¯å£ç±»å‹ä¸º NodePortï¼Œè¿™æ ·å¤–ç•Œå¯ä»¥é€šè¿‡åœ°å€ nodeIP:nodePort è®¿é—® dashboardï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;é…ç½®dashboard-controller&#34;&gt;é…ç½®dashboard-controller&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff dashboard-controller.yaml.orig dashboard-controller.yaml
23c23
&amp;lt;         image: gcr.io/google_containers/kubernetes-dashboard-amd64:v1.6.0
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/kubernetes-dashboard-amd64:v1.6.0
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&#34;&gt;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pwd
/root/kubernetes/cluster/addons/dashboard
$ ls *.yaml
dashboard-controller.yaml  dashboard-service.yaml
$ kubectl create -f  .
service &amp;quot;kubernetes-dashboard&amp;quot; created
deployment &amp;quot;kubernetes-dashboard&amp;quot; created
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ£€æŸ¥æ‰§è¡Œç»“æœ&#34;&gt;æ£€æŸ¥æ‰§è¡Œç»“æœ&lt;/h2&gt;

&lt;p&gt;æŸ¥çœ‹åˆ†é…çš„ NodePort&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get services kubernetes-dashboard -n kube-system
NAME                   CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
kubernetes-dashboard   10.254.224.130   &amp;lt;nodes&amp;gt;       80:30312/TCP   25s
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;NodePort 30312æ˜ å°„åˆ° dashboard pod 80ç«¯å£ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ£€æŸ¥ controller&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get deployment kubernetes-dashboard  -n kube-system
NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubernetes-dashboard   1         1         1            1           3m
$ kubectl get pods  -n kube-system | grep dashboard
kubernetes-dashboard-1339745653-pmn6z   1/1       Running   0          4m
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è®¿é—®dashboard&#34;&gt;è®¿é—®dashboard&lt;/h2&gt;

&lt;p&gt;æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;kubernetes-dashboard æœåŠ¡æš´éœ²äº† NodePortï¼Œå¯ä»¥ä½¿ç”¨ &lt;code&gt;http://NodeIP:nodePort&lt;/code&gt; åœ°å€è®¿é—® dashboardï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡ kube-apiserver è®¿é—® dashboardï¼ˆhttps 6443ç«¯å£å’Œhttp 8080ç«¯å£æ–¹å¼ï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡ kubectl proxy è®¿é—® dashboardï¼š&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;é€šè¿‡-kubectl-proxy-è®¿é—®-dashboard&#34;&gt;é€šè¿‡ kubectl proxy è®¿é—® dashboard&lt;/h3&gt;

&lt;p&gt;å¯åŠ¨ä»£ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl proxy --address=&#39;172.20.0.113&#39; --port=8086 --accept-hosts=&#39;^*$&#39;
Starting to serve on 172.20.0.113:8086
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;éœ€è¦æŒ‡å®š &lt;code&gt;--accept-hosts&lt;/code&gt; é€‰é¡¹ï¼Œå¦åˆ™æµè§ˆå™¨è®¿é—® dashboard é¡µé¢æ—¶æç¤º â€œUnauthorizedâ€ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š&lt;code&gt;http://172.20.0.113:8086/ui&lt;/code&gt;
è‡ªåŠ¨è·³è½¬åˆ°ï¼š&lt;code&gt;http://172.20.0.113:8086/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/workload?namespace=default&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;é€šè¿‡-kube-apiserver-è®¿é—®dashboard&#34;&gt;é€šè¿‡ kube-apiserver è®¿é—®dashboard&lt;/h3&gt;

&lt;p&gt;è·å–é›†ç¾¤æœåŠ¡åœ°å€åˆ—è¡¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl cluster-info
Kubernetes master is running at https://172.20.0.113:6443
KubeDNS is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kube-dns
kubernetes-dashboard is running at https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµè§ˆå™¨è®¿é—® URLï¼š&lt;code&gt;https://172.20.0.113:6443/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard&lt;/code&gt;ï¼ˆæµè§ˆå™¨ä¼šæç¤ºè¯ä¹¦éªŒè¯ï¼Œå› ä¸ºé€šè¿‡åŠ å¯†é€šé“ï¼Œä»¥æ”¹æ–¹å¼è®¿é—®çš„è¯ï¼Œéœ€è¦æå‰å¯¼å…¥è¯ä¹¦åˆ°ä½ çš„è®¡ç®—æœºä¸­ï¼‰ã€‚è¿™æ˜¯æˆ‘å½“æ—¶åœ¨è¿™é‡åˆ°çš„å‘ï¼š&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/5&#34;&gt;é€šè¿‡ kube-apiserver è®¿é—®dashboardï¼Œæç¤ºUser &amp;ldquo;system:anonymous&amp;rdquo; cannot proxy services in the namespace &amp;ldquo;kube-system&amp;rdquo;. #5&lt;/a&gt;ï¼Œå·²ç»è§£å†³ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¯¼å…¥è¯ä¹¦&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å°†ç”Ÿæˆçš„admin.pemè¯ä¹¦è½¬æ¢æ ¼å¼&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;openssl pkcs12 -export -in admin.pem  -out admin.p12 -inkey admin-key.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†ç”Ÿæˆçš„&lt;code&gt;admin.p12&lt;/code&gt;è¯ä¹¦å¯¼å…¥çš„ä½ çš„ç”µè„‘ï¼Œå¯¼å‡ºçš„æ—¶å€™è®°ä½ä½ è®¾ç½®çš„å¯†ç ï¼Œå¯¼å…¥çš„æ—¶å€™è¿˜è¦ç”¨åˆ°ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœä½ ä¸æƒ³ä½¿ç”¨&lt;strong&gt;https&lt;/strong&gt;çš„è¯ï¼Œå¯ä»¥ç›´æ¥è®¿é—®insecure port 8080ç«¯å£:&lt;code&gt;http://172.20.0.113:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/kubernetes-dashboard-raw.jpg&#34; alt=&#34;kubernetes-dashboard&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç”±äºç¼ºå°‘ Heapster æ’ä»¶ï¼Œå½“å‰ dashboard ä¸èƒ½å±•ç¤º Podã€Nodes çš„ CPUã€å†…å­˜ç­‰ metric å›¾å½¢ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kuberneteså®‰è£…ä¹‹kubednsé…ç½®</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-kubedns-installation/</link>
      <pubDate>Wed, 12 Apr 2017 13:04:45 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-kubedns-installation/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016082701.jpg&#34; alt=&#34;ä¸œä¸‰ç¯&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šé›¨è¿‡å¤©æ™´@åŒ—äº¬å®šç¦åº„ Aug 27,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®(forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;)ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œä½¿ç”¨yamlæ–‡ä»¶éƒ¨ç½²&lt;strong&gt;kubedns&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å®‰è£…ç¯å¢ƒé…ç½®ä¿¡æ¯&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CentOS 7.2.1511&lt;/li&gt;
&lt;li&gt;Docker 1.12.5&lt;/li&gt;
&lt;li&gt;Flannel 0.7&lt;/li&gt;
&lt;li&gt;Kubernetes 1.6.0&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å®‰è£…å’Œé…ç½®-kubedns-æ’ä»¶&#34;&gt;å®‰è£…å’Œé…ç½® kubedns æ’ä»¶&lt;/h2&gt;

&lt;p&gt;å®˜æ–¹çš„yamlæ–‡ä»¶ç›®å½•ï¼š&lt;code&gt;kubernetes/cluster/addons/dns&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;è¯¥æ’ä»¶ç›´æ¥ä½¿ç”¨kuberneteséƒ¨ç½²ï¼Œå®˜æ–¹çš„é…ç½®æ–‡ä»¶ä¸­åŒ…å«ä»¥ä¸‹é•œåƒï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.1
gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.1
gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘cloneäº†ä¸Šè¿°é•œåƒï¼Œä¸Šä¼ åˆ°æˆ‘çš„ç§æœ‰é•œåƒä»“åº“ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-dnsmasq-nanny-amd64:1.14.1
sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-kube-dns-amd64:1.14.1
sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-sidecar-amd64:1.14.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ—¶ä¸Šä¼ äº†ä¸€ä»½åˆ°æ—¶é€Ÿäº‘å¤‡ä»½ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;index.tenxcloud.com/jimmy/k8s-dns-dnsmasq-nanny-amd64:1.14.1
index.tenxcloud.com/jimmy/k8s-dns-kube-dns-amd64:1.14.1
index.tenxcloud.com/jimmy/k8s-dns-sidecar-amd64:1.14.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸‹yamlé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯ç§æœ‰é•œåƒä»“åº“ä¸­çš„é•œåƒã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubedns-cm.yaml  
kubedns-sa.yaml  
kubedns-controller.yaml  
kubedns-svc.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å·²ç»ä¿®æ”¹å¥½çš„ yaml æ–‡ä»¶è§ï¼š&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;githubé¡¹ç›®ä¸­çš„manifest/kubedns/ç›®å½•&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç³»ç»Ÿé¢„å®šä¹‰çš„-rolebinding&#34;&gt;ç³»ç»Ÿé¢„å®šä¹‰çš„ RoleBinding&lt;/h2&gt;

&lt;p&gt;é¢„å®šä¹‰çš„ RoleBinding &lt;code&gt;system:kube-dns&lt;/code&gt; å°† kube-system å‘½åç©ºé—´çš„ &lt;code&gt;kube-dns&lt;/code&gt; ServiceAccount ä¸ &lt;code&gt;system:kube-dns&lt;/code&gt; Role ç»‘å®šï¼Œ è¯¥ Role å…·æœ‰è®¿é—® kube-apiserver DNS ç›¸å…³ API çš„æƒé™ï¼›&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Bash&#34;&gt;$ kubectl get clusterrolebindings system:kube-dns -o yaml
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &amp;quot;true&amp;quot;
  creationTimestamp: 2017-04-11T11:20:42Z
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-dns
  resourceVersion: &amp;quot;58&amp;quot;
  selfLink: /apis/rbac.authorization.k8s.io/v1beta1/clusterrolebindingssystem%3Akube-dns
  uid: e61f4d92-1ea8-11e7-8cd7-f4e9d49f8ed0
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-dns
subjects:
- kind: ServiceAccount
  name: kube-dns
  namespace: kube-system
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;kubedns-controller.yaml&lt;/code&gt; ä¸­å®šä¹‰çš„ Pods æ—¶ä½¿ç”¨äº† &lt;code&gt;kubedns-sa.yaml&lt;/code&gt; æ–‡ä»¶å®šä¹‰çš„ &lt;code&gt;kube-dns&lt;/code&gt; ServiceAccountï¼Œæ‰€ä»¥å…·æœ‰è®¿é—® kube-apiserver DNS ç›¸å…³ API çš„æƒé™ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-kube-dns-serviceaccount&#34;&gt;é…ç½® kube-dns ServiceAccount&lt;/h2&gt;

&lt;p&gt;æ— éœ€ä¿®æ”¹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é…ç½®-kube-dns-æœåŠ¡&#34;&gt;é…ç½® &lt;code&gt;kube-dns&lt;/code&gt; æœåŠ¡&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff kubedns-svc.yaml.base kubedns-svc.yaml
30c30
&amp;lt;   clusterIP: __PILLAR__DNS__SERVER__
---
&amp;gt;   clusterIP: 10.254.0.2
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;spec.clusterIP = 10.254.0.2ï¼Œå³æ˜ç¡®æŒ‡å®šäº† kube-dns Service IPï¼Œè¿™ä¸ª IP éœ€è¦å’Œ kubelet çš„ &lt;code&gt;--cluster-dns&lt;/code&gt; å‚æ•°å€¼ä¸€è‡´ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;é…ç½®-kube-dns-deployment&#34;&gt;é…ç½® &lt;code&gt;kube-dns&lt;/code&gt; Deployment&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ diff kubedns-controller.yaml.base kubedns-controller.yaml
58c58
&amp;lt;         image: gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-kube-dns-amd64:v1.14.1
88c88
&amp;lt;         - --domain=__PILLAR__DNS__DOMAIN__.
---
&amp;gt;         - --domain=cluster.local.
92c92
&amp;lt;         __PILLAR__FEDERATIONS__DOMAIN__MAP__
---
&amp;gt;         #__PILLAR__FEDERATIONS__DOMAIN__MAP__
110c110
&amp;lt;         image: gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-dnsmasq-nanny-amd64:v1.14.1
129c129
&amp;lt;         - --server=/__PILLAR__DNS__DOMAIN__/127.0.0.1#10053
---
&amp;gt;         - --server=/cluster.local./127.0.0.1#10053
148c148
&amp;lt;         image: gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.1
---
&amp;gt;         image: sz-pg-oam-docker-hub-001.tendcloud.com/library/k8s-dns-sidecar-amd64:v1.14.1
161,162c161,162
&amp;lt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,A
&amp;lt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,A
---
&amp;gt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local.,5,A
&amp;gt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local.,5,A
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨ç³»ç»Ÿå·²ç»åšäº† RoleBinding çš„ &lt;code&gt;kube-dns&lt;/code&gt; ServiceAccountï¼Œè¯¥è´¦æˆ·å…·æœ‰è®¿é—® kube-apiserver DNS ç›¸å…³ API çš„æƒé™ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&#34;&gt;æ‰§è¡Œæ‰€æœ‰å®šä¹‰æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pwd
/root/kubedns
$ ls *.yaml
kubedns-cm.yaml  kubedns-controller.yaml  kubedns-sa.yaml  kubedns-svc.yaml
$ kubectl create -f .
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ£€æŸ¥-kubedns-åŠŸèƒ½&#34;&gt;æ£€æŸ¥ kubedns åŠŸèƒ½&lt;/h2&gt;

&lt;p&gt;æ–°å»ºä¸€ä¸ª Deployment&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat  my-nginx.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-nginx
spec:
  replicas: 2
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
      - name: my-nginx
        image: sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9
        ports:
        - containerPort: 80
$ kubectl create -f my-nginx.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Export è¯¥ Deployment, ç”Ÿæˆ &lt;code&gt;my-nginx&lt;/code&gt; æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl expose deploy my-nginx
$ kubectl get services --all-namespaces |grep my-nginx
default       my-nginx     10.254.179.239   &amp;lt;none&amp;gt;        80/TCP          42m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆ›å»ºå¦ä¸€ä¸ª Podï¼ŒæŸ¥çœ‹ &lt;code&gt;/etc/resolv.conf&lt;/code&gt; æ˜¯å¦åŒ…å« &lt;code&gt;kubelet&lt;/code&gt; é…ç½®çš„ &lt;code&gt;--cluster-dns&lt;/code&gt; å’Œ &lt;code&gt;--cluster-domain&lt;/code&gt;ï¼Œæ˜¯å¦èƒ½å¤Ÿå°†æœåŠ¡ &lt;code&gt;my-nginx&lt;/code&gt; è§£æåˆ° Cluster IP &lt;code&gt;10.254.179.239&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl create -f nginx-pod.yaml
$ kubectl exec  nginx -i -t -- /bin/bash
root@nginx:/# cat /etc/resolv.conf
nameserver 10.254.0.2
search default.svc.cluster.local. svc.cluster.local. cluster.local. tendcloud.com
options ndots:5

root@nginx:/# ping my-nginx
PING my-nginx.default.svc.cluster.local (10.254.179.239): 56 data bytes
76 bytes from 119.147.223.109: Destination Net Unreachable
^C--- my-nginx.default.svc.cluster.local ping statistics ---

root@nginx:/# ping kubernetes
PING kubernetes.default.svc.cluster.local (10.254.0.1): 56 data bytes
^C--- kubernetes.default.svc.cluster.local ping statistics ---
11 packets transmitted, 0 packets received, 100% packet loss

root@nginx:/# ping kube-dns.kube-system.svc.cluster.local
PING kube-dns.kube-system.svc.cluster.local (10.254.0.2): 56 data bytes
^C--- kube-dns.kube-system.svc.cluster.local ping statistics ---
6 packets transmitted, 0 packets received, 100% packet loss
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»ç»“æœæ¥çœ‹ï¼Œserviceåç§°å¯ä»¥æ­£å¸¸è§£æã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kubernetesé«˜å¯ç”¨masterèŠ‚ç‚¹å®‰è£…</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-ha-master-installation/</link>
      <pubDate>Tue, 11 Apr 2017 19:55:56 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-ha-master-installation/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2015091402.jpg&#34; alt=&#34;åŒ—äº¬è¥¿å±±&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šé¬¼è§æ„@åŒ—äº¬è¥¿å±± Sep 14,2015ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®((forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;))ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œéƒ¨ç½²masterèŠ‚ç‚¹çš„&lt;code&gt;kube-apiserver&lt;/code&gt;ã€&lt;code&gt;kube-controller-manager&lt;/code&gt;å’Œ&lt;code&gt;kube-scheduler&lt;/code&gt;çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é«˜å¯ç”¨kubernetes-masterèŠ‚ç‚¹å®‰è£…&#34;&gt;é«˜å¯ç”¨kubernetes masterèŠ‚ç‚¹å®‰è£…&lt;/h2&gt;

&lt;p&gt;kubernetes master èŠ‚ç‚¹åŒ…å«çš„ç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;kube-apiserver&lt;/li&gt;
&lt;li&gt;kube-scheduler&lt;/li&gt;
&lt;li&gt;kube-controller-manager&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç›®å‰è¿™ä¸‰ä¸ªç»„ä»¶éœ€è¦éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;kube-scheduler&lt;/code&gt;ã€&lt;code&gt;kube-controller-manager&lt;/code&gt; å’Œ &lt;code&gt;kube-apiserver&lt;/code&gt; ä¸‰è€…çš„åŠŸèƒ½ç´§å¯†ç›¸å…³ï¼›&lt;/li&gt;
&lt;li&gt;åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª &lt;code&gt;kube-scheduler&lt;/code&gt;ã€&lt;code&gt;kube-controller-manager&lt;/code&gt; è¿›ç¨‹å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå¦‚æœè¿è¡Œå¤šä¸ªï¼Œåˆ™éœ€è¦é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ª leaderï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æœ¬æ–‡æ¡£è®°å½•éƒ¨ç½²ä¸€ä¸ªä¸‰ä¸ªèŠ‚ç‚¹çš„é«˜å¯ç”¨ kubernetes master é›†ç¾¤æ­¥éª¤ã€‚ï¼ˆåç»­åˆ›å»ºä¸€ä¸ª load balancer æ¥ä»£ç†è®¿é—® kube-apiserver çš„è¯·æ±‚ï¼‰&lt;/p&gt;

&lt;h2 id=&#34;tls-è¯ä¹¦æ–‡ä»¶&#34;&gt;TLS è¯ä¹¦æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;pemå’Œtoken.csvè¯ä¹¦æ–‡ä»¶æˆ‘ä»¬åœ¨&lt;a href=&#34;./01-TLSè¯ä¹¦å’Œç§˜é’¥.md&#34;&gt;TLSè¯ä¹¦å’Œç§˜é’¥&lt;/a&gt;è¿™ä¸€æ­¥ä¸­å·²ç»åˆ›å»ºè¿‡äº†ã€‚æˆ‘ä»¬å†æ£€æŸ¥ä¸€ä¸‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls /etc/kubernetes/ssl
admin-key.pem  admin.pem  ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  kubernetes-key.pem  kubernetes.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶&#34;&gt;ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;æœ‰ä¸¤ç§ä¸‹è½½æ–¹å¼&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼ä¸€&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä» &lt;a href=&#34;https://github.com/kubernetes/kubernetes/releases&#34;&gt;github release é¡µé¢&lt;/a&gt; ä¸‹è½½å‘å¸ƒç‰ˆ tarballï¼Œè§£å‹åå†æ‰§è¡Œä¸‹è½½è„šæœ¬&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wget https://github.com/kubernetes/kubernetes/releases/download/v1.6.0/kubernetes.tar.gz
$ tar -xzvf kubernetes.tar.gz
...
$ cd kubernetes
$ ./cluster/get-kube-binaries.sh
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼äºŒ&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä» &lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md&#34;&gt;&lt;code&gt;CHANGELOG&lt;/code&gt;é¡µé¢&lt;/a&gt; ä¸‹è½½ &lt;code&gt;client&lt;/code&gt; æˆ– &lt;code&gt;server&lt;/code&gt; tarball æ–‡ä»¶&lt;/p&gt;

&lt;p&gt;&lt;code&gt;server&lt;/code&gt; çš„ tarball &lt;code&gt;kubernetes-server-linux-amd64.tar.gz&lt;/code&gt; å·²ç»åŒ…å«äº† &lt;code&gt;client&lt;/code&gt;(&lt;code&gt;kubectl&lt;/code&gt;) äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ç”¨å•ç‹¬ä¸‹è½½&lt;code&gt;kubernetes-client-linux-amd64.tar.gz&lt;/code&gt;æ–‡ä»¶ï¼›&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ # wget https://dl.k8s.io/v1.6.0/kubernetes-client-linux-amd64.tar.gz
$ wget https://dl.k8s.io/v1.6.0/kubernetes-server-linux-amd64.tar.gz
$ tar -xzvf kubernetes-server-linux-amd64.tar.gz
...
$ cd kubernetes
$ tar -xzvf  kubernetes-src.tar.gz
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ°æŒ‡å®šè·¯å¾„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet} /root/local/bin/
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®å’Œå¯åŠ¨-kube-apiserver&#34;&gt;é…ç½®å’Œå¯åŠ¨ kube-apiserver&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º kube-apiserverçš„serviceé…ç½®æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;serivceé…ç½®æ–‡ä»¶&lt;code&gt;/usr/lib/systemd/system/kube-apiserver.service&lt;/code&gt;å†…å®¹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[Unit]
Description=Kubernetes API Service
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target
After=etcd.service

[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/apiserver
ExecStart=/usr/bin/kube-apiserver \
	    $KUBE_LOGTOSTDERR \
	    $KUBE_LOG_LEVEL \
	    $KUBE_ETCD_SERVERS \
	    $KUBE_API_ADDRESS \
	    $KUBE_API_PORT \
	    $KUBELET_PORT \
	    $KUBE_ALLOW_PRIV \
	    $KUBE_SERVICE_ADDRESSES \
	    $KUBE_ADMISSION_CONTROL \
	    $KUBE_API_ARGS
Restart=on-failure
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;/etc/kubernetes/config&lt;/code&gt;æ–‡ä»¶çš„å†…å®¹ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;###
# kubernetes system config
#
# The following values are used to configure various aspects of all
# kubernetes services, including
#
#   kube-apiserver.service
#   kube-controller-manager.service
#   kube-scheduler.service
#   kubelet.service
#   kube-proxy.service
# logging to stderr means we get it in the systemd journal
KUBE_LOGTOSTDERR=&amp;quot;--logtostderr=true&amp;quot;

# journal message level, 0 is debug
KUBE_LOG_LEVEL=&amp;quot;--v=0&amp;quot;

# Should this cluster be allowed to run privileged docker containers
KUBE_ALLOW_PRIV=&amp;quot;--allow-privileged=true&amp;quot;

# How the controller-manager, scheduler, and proxy find the apiserver
#KUBE_MASTER=&amp;quot;--master=http://sz-pg-oam-docker-test-001.tendcloud.com:8080&amp;quot;
KUBE_MASTER=&amp;quot;--master=http://172.20.0.113:8080&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥é…ç½®æ–‡ä»¶åŒæ—¶è¢«kube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletã€kube-proxyä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;apiserveré…ç½®æ–‡ä»¶&lt;code&gt;/etc/kubernetes/apiserver&lt;/code&gt;å†…å®¹ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Ini&#34;&gt;###
## kubernetes system config
##
## The following values are used to configure the kube-apiserver
##
#
## The address on the local server to listen to.
#KUBE_API_ADDRESS=&amp;quot;--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com&amp;quot;
KUBE_API_ADDRESS=&amp;quot;--advertise-address=172.20.0.113 --bind-address=172.20.0.113 --insecure-bind-address=172.20.0.113&amp;quot;
#
## The port on the local server to listen on.
#KUBE_API_PORT=&amp;quot;--port=8080&amp;quot;
#
## Port minions listen on
#KUBELET_PORT=&amp;quot;--kubelet-port=10250&amp;quot;
#
## Comma separated list of nodes in the etcd cluster
KUBE_ETCD_SERVERS=&amp;quot;--etcd-servers=https://172.20.0.113:2379,172.20.0.114:2379,172.20.0.115:2379&amp;quot;
#
## Address range to use for services
KUBE_SERVICE_ADDRESSES=&amp;quot;--service-cluster-ip-range=10.254.0.0/16&amp;quot;
#
## default admission control policies
KUBE_ADMISSION_CONTROL=&amp;quot;--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota&amp;quot;
#
## Add your own!
KUBE_API_ARGS=&amp;quot;--authorization-mode=RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/etc/kubernetes/ssl/ca.pem --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;--authorization-mode=RBAC&lt;/code&gt; æŒ‡å®šåœ¨å®‰å…¨ç«¯å£ä½¿ç”¨ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªé€šè¿‡æˆæƒçš„è¯·æ±‚ï¼›&lt;/li&gt;
&lt;li&gt;kube-schedulerã€kube-controller-manager ä¸€èˆ¬å’Œ kube-apiserver éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå®ƒä»¬ä½¿ç”¨&lt;strong&gt;éå®‰å…¨ç«¯å£&lt;/strong&gt;å’Œ kube-apiserveré€šä¿¡;&lt;/li&gt;
&lt;li&gt;kubeletã€kube-proxyã€kubectl éƒ¨ç½²åœ¨å…¶å®ƒ Node èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœé€šè¿‡&lt;strong&gt;å®‰å…¨ç«¯å£&lt;/strong&gt;è®¿é—® kube-apiserverï¼Œåˆ™å¿…é¡»å…ˆé€šè¿‡ TLS è¯ä¹¦è®¤è¯ï¼Œå†é€šè¿‡ RBAC æˆæƒï¼›&lt;/li&gt;
&lt;li&gt;kube-proxyã€kubectl é€šè¿‡åœ¨ä½¿ç”¨çš„è¯ä¹¦é‡ŒæŒ‡å®šç›¸å…³çš„ Userã€Group æ¥è¾¾åˆ°é€šè¿‡ RBAC æˆæƒçš„ç›®çš„ï¼›&lt;/li&gt;
&lt;li&gt;å¦‚æœä½¿ç”¨äº† kubelet TLS Boostrap æœºåˆ¶ï¼Œåˆ™ä¸èƒ½å†æŒ‡å®š &lt;code&gt;--kubelet-certificate-authority&lt;/code&gt;ã€&lt;code&gt;--kubelet-client-certificate&lt;/code&gt; å’Œ &lt;code&gt;--kubelet-client-key&lt;/code&gt; é€‰é¡¹ï¼Œå¦åˆ™åç»­ kube-apiserver æ ¡éªŒ kubelet è¯ä¹¦æ—¶å‡ºç° â€x509: certificate signed by unknown authorityâ€œ é”™è¯¯ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--admission-control&lt;/code&gt; å€¼å¿…é¡»åŒ…å« &lt;code&gt;ServiceAccount&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--bind-address&lt;/code&gt; ä¸èƒ½ä¸º &lt;code&gt;127.0.0.1&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;runtime-config&lt;/code&gt;é…ç½®ä¸º&lt;code&gt;rbac.authorization.k8s.io/v1beta1&lt;/code&gt;ï¼Œè¡¨ç¤ºè¿è¡Œæ—¶çš„apiVersionï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--service-cluster-ip-range&lt;/code&gt; æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼Œè¯¥åœ°å€æ®µä¸èƒ½è·¯ç”±å¯è¾¾ï¼›&lt;/li&gt;
&lt;li&gt;ç¼ºçœæƒ…å†µä¸‹ kubernetes å¯¹è±¡ä¿å­˜åœ¨ etcd &lt;code&gt;/registry&lt;/code&gt; è·¯å¾„ä¸‹ï¼Œå¯ä»¥é€šè¿‡ &lt;code&gt;--etcd-prefix&lt;/code&gt; å‚æ•°è¿›è¡Œè°ƒæ•´ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®Œæ•´ unit è§ &lt;a href=&#34;./systemd/kube-apiserver.service&#34;&gt;kube-apiserver.service&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¯åŠ¨kube-apiserver&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl daemon-reload
$ systemctl enable kube-apiserver
$ systemctl start kube-apiserver
$ systemctl status kube-apiserver
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®å’Œå¯åŠ¨-kube-controller-manager&#34;&gt;é…ç½®å’Œå¯åŠ¨ kube-controller-manager&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º kube-controller-managerçš„serivceé…ç½®æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æ–‡ä»¶è·¯å¾„&lt;code&gt;/usr/lib/systemd/system/kube-controller-manager.service&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;Description=Kubernetes Controller Manager
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/controller-manager
ExecStart=/usr/bin/kube-controller-manager \
	    $KUBE_LOGTOSTDERR \
	    $KUBE_LOG_LEVEL \
	    $KUBE_MASTER \
	    $KUBE_CONTROLLER_MANAGER_ARGS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®æ–‡ä»¶&lt;code&gt;/etc/kubernetes/controller-manager&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;###
# The following values are used to configure the kubernetes controller-manager

# defaults from config and apiserver should be adequate

# Add your own!
KUBE_CONTROLLER_MANAGER_ARGS=&amp;quot;--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem --leader-elect=true&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;--service-cluster-ip-range&lt;/code&gt; å‚æ•°æŒ‡å®š Cluster ä¸­ Service çš„CIDRèŒƒå›´ï¼Œè¯¥ç½‘ç»œåœ¨å„ Node é—´å¿…é¡»è·¯ç”±ä¸å¯è¾¾ï¼Œå¿…é¡»å’Œ kube-apiserver ä¸­çš„å‚æ•°ä¸€è‡´ï¼›&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;--cluster-signing-*&lt;/code&gt; æŒ‡å®šçš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ç”¨æ¥ç­¾åä¸º TLS BootStrap åˆ›å»ºçš„è¯ä¹¦å’Œç§é’¥ï¼›&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;--root-ca-file&lt;/code&gt; ç”¨æ¥å¯¹ kube-apiserver è¯ä¹¦è¿›è¡Œæ ¡éªŒï¼Œ&lt;strong&gt;æŒ‡å®šè¯¥å‚æ•°åï¼Œæ‰ä¼šåœ¨Pod å®¹å™¨çš„ ServiceAccount ä¸­æ”¾ç½®è¯¥ CA è¯ä¹¦æ–‡ä»¶&lt;/strong&gt;ï¼›&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;--address&lt;/code&gt; å€¼å¿…é¡»ä¸º &lt;code&gt;127.0.0.1&lt;/code&gt;ï¼Œå› ä¸ºå½“å‰ kube-apiserver æœŸæœ› scheduler å’Œ controller-manager åœ¨åŒä¸€å°æœºå™¨ï¼Œå¦åˆ™ï¼š&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;  $ kubectl get componentstatuses
  NAME                 STATUS      MESSAGE                                                                                        ERROR
  scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: getsockopt: connection refused   
  controller-manager   Healthy     ok                                                                                             
  etcd-2               Unhealthy   Get http://172.20.0.113:2379/health: malformed HTTP response &amp;quot;\x15\x03\x01\x00\x02\x02&amp;quot;        
  etcd-0               Healthy     {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}                                                                             
  etcd-1               Healthy     {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‚è€ƒï¼š&lt;a href=&#34;https://github.com/kubernetes-incubator/bootkube/issues/64&#34;&gt;https://github.com/kubernetes-incubator/bootkube/issues/64&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å®Œæ•´ unit è§ &lt;a href=&#34;./systemd/kube-controller-manager.service&#34;&gt;kube-controller-manager.service&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;å¯åŠ¨-kube-controller-manager&#34;&gt;å¯åŠ¨ kube-controller-manager&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl daemon-reload
$ systemctl enable kube-controller-manager
$ systemctl start kube-controller-manager
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;é…ç½®å’Œå¯åŠ¨-kube-scheduler&#34;&gt;é…ç½®å’Œå¯åŠ¨ kube-scheduler&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º kube-schedulerçš„serivceé…ç½®æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æ–‡ä»¶è·¯å¾„&lt;code&gt;/usr/lib/systemd/system/kube-scheduler.serivce&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[Unit]
Description=Kubernetes Scheduler Plugin
Documentation=https://github.com/GoogleCloudPlatform/kubernetes

[Service]
EnvironmentFile=-/etc/kubernetes/config
EnvironmentFile=-/etc/kubernetes/scheduler
ExecStart=/usr/bin/kube-scheduler \
            $KUBE_LOGTOSTDERR \
            $KUBE_LOG_LEVEL \
            $KUBE_MASTER \
            $KUBE_SCHEDULER_ARGS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®æ–‡ä»¶&lt;code&gt;/etc/kubernetes/scheduler&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Ini&#34;&gt;###
# kubernetes scheduler config

# default config should be adequate

# Add your own!
KUBE_SCHEDULER_ARGS=&amp;quot;--leader-elect=true --address=127.0.0.1&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;--address&lt;/code&gt; å€¼å¿…é¡»ä¸º &lt;code&gt;127.0.0.1&lt;/code&gt;ï¼Œå› ä¸ºå½“å‰ kube-apiserver æœŸæœ› scheduler å’Œ controller-manager åœ¨åŒä¸€å°æœºå™¨ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®Œæ•´ unit è§ &lt;a href=&#34;./systemd/kube-scheduler.service&#34;&gt;kube-scheduler.service&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;å¯åŠ¨-kube-scheduler&#34;&gt;å¯åŠ¨ kube-scheduler&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ systemctl daemon-reload
$ systemctl enable kube-scheduler
$ systemctl start kube-scheduler
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;éªŒè¯-master-èŠ‚ç‚¹åŠŸèƒ½&#34;&gt;éªŒè¯ master èŠ‚ç‚¹åŠŸèƒ½&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl get componentstatuses
NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok                   
controller-manager   Healthy   ok                   
etcd-0               Healthy   {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}   
etcd-1               Healthy   {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}   
etcd-2               Healthy   {&amp;quot;health&amp;quot;: &amp;quot;true&amp;quot;}   
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åè®°&#34;&gt;åè®°&lt;/h2&gt;

&lt;p&gt;å½“æ—¶åœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster/issues/4&#34;&gt;TLSè®¤è¯ç›¸å…³çš„é—®é¢˜&lt;/a&gt;ï¼Œå…¶å®å°±æ˜¯å› ä¸ºé…ç½®apiserveræ—¶å€™etcdçš„åè®®å†™æˆäº†httpå¯¼è‡´çš„ï¼Œåº”è¯¥æ˜¯ç”¨httpsã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;Opsnull&lt;/a&gt;å†™çš„kubernetesé«˜å¯ç”¨masteré›†ç¾¤éƒ¨ç½²è¿‡ç¨‹ä¸­ä¼¼ä¹å¹¶æ²¡æœ‰åŒ…æ‹¬&lt;strong&gt;é«˜å¯ç”¨çš„é…ç½®&lt;/strong&gt;ï¼Œæ‰äº‘ç§‘æŠ€çš„å”ç»§å…ƒåˆ†äº«è¿‡&lt;a href=&#34;https://segmentfault.com/a/1190000005832319&#34;&gt;Kubernetes Master High Availability é«˜çº§å®è·µ&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ç©¶ç«Ÿå¦‚ä½•å®ç°kubernetes masterçš„é«˜å¯ç”¨è¿˜éœ€è¦ç»§ç»­æ¢ç´¢ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kuberneteså®‰è£…ä¹‹etcdé«˜å¯ç”¨é…ç½®</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-etcd-ha-config/</link>
      <pubDate>Tue, 11 Apr 2017 15:21:39 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-etcd-ha-config/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2015091401.jpg&#34; alt=&#34;è¥¿å±±ä¿¯ç°åŒ—äº¬å¤œæ™¯&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šåŒ—äº¬å¤œæ™¯@è¥¿å±±ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®((forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;))ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œç”Ÿæˆ&lt;strong&gt;kubeconfig&lt;/strong&gt;æ–‡ä»¶çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»ºé«˜å¯ç”¨-etcd-é›†ç¾¤&#34;&gt;åˆ›å»ºé«˜å¯ç”¨ etcd é›†ç¾¤&lt;/h2&gt;

&lt;p&gt;kuberntes ç³»ç»Ÿä½¿ç”¨ etcd å­˜å‚¨æ‰€æœ‰æ•°æ®ï¼Œæœ¬æ–‡æ¡£ä»‹ç»éƒ¨ç½²ä¸€ä¸ªä¸‰èŠ‚ç‚¹é«˜å¯ç”¨ etcd é›†ç¾¤çš„æ­¥éª¤ï¼Œè¿™ä¸‰ä¸ªèŠ‚ç‚¹å¤ç”¨ kubernetes master æœºå™¨ï¼Œåˆ†åˆ«å‘½åä¸º&lt;code&gt;sz-pg-oam-docker-test-001.tendcloud.com&lt;/code&gt;ã€&lt;code&gt;sz-pg-oam-docker-test-002.tendcloud.com&lt;/code&gt;ã€&lt;code&gt;sz-pg-oam-docker-test-003.tendcloud.com&lt;/code&gt;ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;sz-pg-oam-docker-test-001.tendcloud.comï¼š172.20.0.113&lt;/li&gt;
&lt;li&gt;sz-pg-oam-docker-test-002.tendcloud.comï¼š172.20.0.114&lt;/li&gt;
&lt;li&gt;sz-pg-oam-docker-test-003.tendcloud.comï¼š172.20.0.115&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;tls-è®¤è¯æ–‡ä»¶&#34;&gt;TLS è®¤è¯æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;éœ€è¦ä¸º etcd é›†ç¾¤åˆ›å»ºåŠ å¯†é€šä¿¡çš„ TLS è¯ä¹¦ï¼Œè¿™é‡Œå¤ç”¨ä»¥å‰åˆ›å»ºçš„ kubernetes è¯ä¹¦&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp ca.pem kubernetes-key.pem kubernetes.pem /etc/kubernetes/ssl
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;kubernetes è¯ä¹¦çš„ &lt;code&gt;hosts&lt;/code&gt; å­—æ®µåˆ—è¡¨ä¸­åŒ…å«ä¸Šé¢ä¸‰å°æœºå™¨çš„ IPï¼Œå¦åˆ™åç»­è¯ä¹¦æ ¡éªŒä¼šå¤±è´¥ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶&#34;&gt;ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;åˆ° &lt;code&gt;https://github.com/coreos/etcd/releases&lt;/code&gt; é¡µé¢ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ https://github.com/coreos/etcd/releases/download/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz
$ tar -xvf etcd-v3.1.4-linux-amd64.tar.gz
$ sudo mv etcd-v3.1.4-linux-amd64/etcd* /root/local/bin
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ›å»º-etcd-çš„-systemd-unit-æ–‡ä»¶&#34;&gt;åˆ›å»º etcd çš„ systemd unit æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;æ³¨æ„æ›¿æ¢ &lt;code&gt;ETCD_NAME&lt;/code&gt; å’Œ &lt;code&gt;INTERNAL_IP&lt;/code&gt; å˜é‡çš„å€¼ï¼›&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ export ETCD_NAME=sz-pg-oam-docker-test-001.tendcloud.com
$ export INTERNAL_IP=172.20.0.113
$ sudo mkdir -p /var/lib/etcd /var/lib/etcd
$ cat &amp;gt; etcd.service &amp;lt;&amp;lt;EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target
Documentation=https://github.com/coreos

[Service]
Type=notify
WorkingDirectory=/var/lib/etcd/
EnvironmentFile=-/etc/etcd/etcd.conf
ExecStart=/root/local/bin/etcd \\
  --name ${ETCD_NAME} \\
  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \\
  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \\
  --peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \\
  --peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \\
  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\
  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\
  --initial-advertise-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-client-urls https://${INTERNAL_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${INTERNAL_IP}:2379 \\
  --initial-cluster-token etcd-cluster-0 \\
  --initial-cluster sz-pg-oam-docker-test-001.tendcloud.com=https://172.20.0.113:2380,sz-pg-oam-docker-test-002.tendcloud.com=https://172.20.0.114:2380,sz-pg-oam-docker-test-003.tendcloud.com=https://172.20.0.115:2380 \\
  --initial-cluster-state new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;æŒ‡å®š &lt;code&gt;etcd&lt;/code&gt; çš„å·¥ä½œç›®å½•ä¸º &lt;code&gt;/var/lib/etcd&lt;/code&gt;ï¼Œæ•°æ®ç›®å½•ä¸º &lt;code&gt;/var/lib/etcd&lt;/code&gt;ï¼Œéœ€åœ¨å¯åŠ¨æœåŠ¡å‰åˆ›å»ºè¿™ä¸¤ä¸ªç›®å½•ï¼›&lt;/li&gt;
&lt;li&gt;ä¸ºäº†ä¿è¯é€šä¿¡å®‰å…¨ï¼Œéœ€è¦æŒ‡å®š etcd çš„å…¬ç§é’¥(cert-fileå’Œkey-file)ã€Peers é€šä¿¡çš„å…¬ç§é’¥å’Œ CA è¯ä¹¦(peer-cert-fileã€peer-key-fileã€peer-trusted-ca-file)ã€å®¢æˆ·ç«¯çš„CAè¯ä¹¦ï¼ˆtrusted-ca-fileï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;åˆ›å»º &lt;code&gt;kubernetes.pem&lt;/code&gt; è¯ä¹¦æ—¶ä½¿ç”¨çš„ &lt;code&gt;kubernetes-csr.json&lt;/code&gt; æ–‡ä»¶çš„ &lt;code&gt;hosts&lt;/code&gt; å­—æ®µ&lt;strong&gt;åŒ…å«æ‰€æœ‰ etcd èŠ‚ç‚¹çš„ INTERNAL_IP&lt;/strong&gt;ï¼Œå¦åˆ™è¯ä¹¦æ ¡éªŒä¼šå‡ºé”™ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--initial-cluster-state&lt;/code&gt; å€¼ä¸º &lt;code&gt;new&lt;/code&gt; æ—¶ï¼Œ&lt;code&gt;--name&lt;/code&gt; çš„å‚æ•°å€¼å¿…é¡»ä½äº &lt;code&gt;--initial-cluster&lt;/code&gt; åˆ—è¡¨ä¸­ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å®Œæ•´ unit æ–‡ä»¶è§ï¼š&lt;a href=&#34;./systemd/etcd.service&#34;&gt;etcd.service&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;å¯åŠ¨-etcd-æœåŠ¡&#34;&gt;å¯åŠ¨ etcd æœåŠ¡&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sudo mv etcd.service /etc/systemd/system/
$ sudo systemctl daemon-reload
$ sudo systemctl enable etcd
$ sudo systemctl start etcd
$ systemctl status etcd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨æ‰€æœ‰çš„ kubernetes master èŠ‚ç‚¹é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ‰€æœ‰æœºå™¨çš„ etcd æœåŠ¡éƒ½å·²å¯åŠ¨ã€‚&lt;/p&gt;

&lt;h2 id=&#34;éªŒè¯æœåŠ¡&#34;&gt;éªŒè¯æœåŠ¡&lt;/h2&gt;

&lt;p&gt;åœ¨ä»»ä¸€ kubernetes master æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ etcdctl \
  --ca-file=/etc/kubernetes/ssl/ca.pem \
  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \
  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \
  cluster-health
2017-04-11 15:17:09.082250 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated
2017-04-11 15:17:09.083681 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated
member 9a2ec640d25672e5 is healthy: got healthy result from https://172.20.0.115:2379
member bc6f27ae3be34308 is healthy: got healthy result from https://172.20.0.114:2379
member e5c92ea26c4edba0 is healthy: got healthy result from https://172.20.0.113:2379
cluster is healthy
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»“æœæœ€åä¸€è¡Œä¸º &lt;code&gt;cluster is healthy&lt;/code&gt; æ—¶è¡¨ç¤ºé›†ç¾¤æœåŠ¡æ­£å¸¸ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Kuberneteså®‰è£…ä¹‹åˆ›å»ºkubeconfigæ–‡ä»¶</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-create-kubeconfig/</link>
      <pubDate>Tue, 11 Apr 2017 14:34:54 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-create-kubeconfig/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2016050801.jpg&#34; alt=&#34;åŒ—æµ·å…¬å›­&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(é¢˜å›¾ï¼šåŒ—æµ·å…¬å›­ May 8,2016)&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;è¿™æ˜¯&lt;a href=&#34;https://github.com/rootsongjc/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;é¡¹ç›®((forkè‡ª&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;opsnull&lt;/a&gt;))ä¸­çš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;äº§ç”Ÿçš„kuberentesç¯å¢ƒï¼Œç”Ÿæˆ&lt;strong&gt;kubeconfig&lt;/strong&gt;æ–‡ä»¶çš„è¿‡ç¨‹ã€‚
&lt;code&gt;kubelet&lt;/code&gt;ã€&lt;code&gt;kube-proxy&lt;/code&gt; ç­‰ Node æœºå™¨ä¸Šçš„è¿›ç¨‹ä¸ Master æœºå™¨çš„ &lt;code&gt;kube-apiserver&lt;/code&gt; è¿›ç¨‹é€šä¿¡æ—¶éœ€è¦è®¤è¯å’Œæˆæƒï¼›
kubernetes 1.4 å¼€å§‹æ”¯æŒç”± &lt;code&gt;kube-apiserver&lt;/code&gt; ä¸ºå®¢æˆ·ç«¯ç”Ÿæˆ TLS è¯ä¹¦çš„ &lt;a href=&#34;https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/&#34;&gt;TLS Bootstrapping&lt;/a&gt; åŠŸèƒ½ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆè¯ä¹¦äº†ï¼›è¯¥åŠŸèƒ½&lt;strong&gt;å½“å‰ä»…æ”¯æŒä¸º &lt;code&gt;kubelet&lt;/code&gt;&lt;/strong&gt; ç”Ÿæˆè¯ä¹¦ã€‚&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»º-tls-bootstrapping-token&#34;&gt;åˆ›å»º TLS Bootstrapping Token&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Token auth file&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Tokenå¯ä»¥æ˜¯ä»»æ„çš„åŒ…æ¶µ128 bitçš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨å®‰å…¨çš„éšæœºæ•°å‘ç”Ÿå™¨ç”Ÿæˆã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;)
cat &amp;gt; token.csv &amp;lt;&amp;lt;EOF
${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,&amp;quot;system:kubelet-bootstrap&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;åä¸‰è¡Œæ˜¯ä¸€å¥ï¼Œç›´æ¥å¤åˆ¶ä¸Šé¢çš„è„šæœ¬è¿è¡Œå³å¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å°†token.csvå‘åˆ°æ‰€æœ‰æœºå™¨ï¼ˆMaster å’Œ Nodeï¼‰çš„ &lt;code&gt;/etc/kubernetes/&lt;/code&gt; ç›®å½•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$cp token.csv /etc/kubernetes/
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ›å»º-kubelet-bootstrapping-kubeconfig-æ–‡ä»¶&#34;&gt;åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd /etc/kubernetes
$ export KUBE_APISERVER=&amp;quot;https://172.20.0.113:6443&amp;quot;
$ # è®¾ç½®é›†ç¾¤å‚æ•°
$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=bootstrap.kubeconfig
$ # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
$ kubectl config set-credentials kubelet-bootstrap \
  --token=${BOOTSTRAP_TOKEN} \
  --kubeconfig=bootstrap.kubeconfig
$ # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
$ kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet-bootstrap \
  --kubeconfig=bootstrap.kubeconfig
$ # è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
$ kubectl config use-context default --kubeconfig=bootstrap.kubeconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;--embed-certs&lt;/code&gt; ä¸º &lt;code&gt;true&lt;/code&gt; æ—¶è¡¨ç¤ºå°† &lt;code&gt;certificate-authority&lt;/code&gt; è¯ä¹¦å†™å…¥åˆ°ç”Ÿæˆçš„ &lt;code&gt;bootstrap.kubeconfig&lt;/code&gt; æ–‡ä»¶ä¸­ï¼›&lt;/li&gt;
&lt;li&gt;è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶&lt;strong&gt;æ²¡æœ‰&lt;/strong&gt;æŒ‡å®šç§˜é’¥å’Œè¯ä¹¦ï¼Œåç»­ç”± &lt;code&gt;kube-apiserver&lt;/code&gt; è‡ªåŠ¨ç”Ÿæˆï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;åˆ›å»º-kube-proxy-kubeconfig-æ–‡ä»¶&#34;&gt;åˆ›å»º kube-proxy kubeconfig æ–‡ä»¶&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ export KUBE_APISERVER=&amp;quot;https://172.20.0.113:6443&amp;quot;
$ # è®¾ç½®é›†ç¾¤å‚æ•°
$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=kube-proxy.kubeconfig
$ # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
$ kubectl config set-credentials kube-proxy \
  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \
  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig
$ # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
$ kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig
$ # è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
$ kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;è®¾ç½®é›†ç¾¤å‚æ•°å’Œå®¢æˆ·ç«¯è®¤è¯å‚æ•°æ—¶ &lt;code&gt;--embed-certs&lt;/code&gt; éƒ½ä¸º &lt;code&gt;true&lt;/code&gt;ï¼Œè¿™ä¼šå°† &lt;code&gt;certificate-authority&lt;/code&gt;ã€&lt;code&gt;client-certificate&lt;/code&gt; å’Œ &lt;code&gt;client-key&lt;/code&gt; æŒ‡å‘çš„è¯ä¹¦æ–‡ä»¶å†…å®¹å†™å…¥åˆ°ç”Ÿæˆçš„ &lt;code&gt;kube-proxy.kubeconfig&lt;/code&gt; æ–‡ä»¶ä¸­ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kube-proxy.pem&lt;/code&gt; è¯ä¹¦ä¸­ CN ä¸º &lt;code&gt;system:kube-proxy&lt;/code&gt;ï¼Œ&lt;code&gt;kube-apiserver&lt;/code&gt; é¢„å®šä¹‰çš„ RoleBinding &lt;code&gt;cluster-admin&lt;/code&gt; å°†User &lt;code&gt;system:kube-proxy&lt;/code&gt; ä¸ Role &lt;code&gt;system:node-proxier&lt;/code&gt; ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ &lt;code&gt;kube-apiserver&lt;/code&gt; Proxy ç›¸å…³ API çš„æƒé™ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;åˆ†å‘-kubeconfig-æ–‡ä»¶&#34;&gt;åˆ†å‘ kubeconfig æ–‡ä»¶&lt;/h2&gt;

&lt;p&gt;å°†ä¸¤ä¸ª kubeconfig æ–‡ä»¶åˆ†å‘åˆ°æ‰€æœ‰ Node æœºå™¨çš„ &lt;code&gt;/etc/kubernetes/&lt;/code&gt; ç›®å½•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp bootstrap.kubeconfig kube-proxy.kubeconfig /etc/kubernetes/
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Kuberneteså®‰è£…ä¹‹è¯ä¹¦éªŒè¯</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-tls-certificate/</link>
      <pubDate>Mon, 10 Apr 2017 17:28:41 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-tls-certificate/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2014082502.jpg&#34; alt=&#34;é¢å’Œå›­&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šé“œç‰›@é¢å’Œå›­ Aug 25,2014ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;æ˜¨æ™šï¼ˆApr 9,2017ï¼‰é‡‘å±±è½¯ä»¶çš„&lt;a href=&#34;https://github.com/opsnull&#34;&gt;opsnull&lt;/a&gt;å‘å¸ƒäº†ä¸€ä¸ªå¼€æºé¡¹ç›®&lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster&#34;&gt;å’Œæˆ‘ä¸€æ­¥æ­¥éƒ¨ç½²kubernetesé›†ç¾¤&lt;/a&gt;ï¼Œä¸‹æ–‡æ˜¯ç»“åˆæˆ‘&lt;a href=&#34;http://rootsongjc.github.io/tags/kubernetes/&#34;&gt;ä¹‹å‰éƒ¨ç½²kubernetesçš„è¿‡ç¨‹&lt;/a&gt;æ‰“é€ çš„kubernetesç¯å¢ƒå’Œopsnullçš„æ–‡ç« &lt;a href=&#34;https://github.com/opsnull/follow-me-install-kubernetes-cluster/blob/master/01-TLS%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%98%E9%92%A5.md&#34;&gt;åˆ›å»º kubernetes å„ç»„ä»¶ TLS åŠ å¯†é€šä¿¡çš„è¯ä¹¦å’Œç§˜é’¥&lt;/a&gt;çš„å®è·µã€‚ä¹‹å‰å®‰è£…è¿‡ç¨‹ä¸­ä¸€ç›´ä½¿ç”¨çš„æ˜¯éåŠ å¯†æ–¹å¼ï¼Œä¸€ç›´åˆ°åæ¥&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-fluentd-elasticsearch-installation/&#34;&gt;ä½¿ç”¨Fluentdå’ŒElasticSearchæ”¶é›†Kubernetesé›†ç¾¤æ—¥å¿—&lt;/a&gt;æ—¶å‘ç°æœ‰æƒé™éªŒè¯é—®é¢˜ï¼Œæ‰€ä»¥ä¸ºäº†æ·±å…¥ç ”ç©¶kubernentesã€‚&lt;/p&gt;

&lt;h2 id=&#34;kubernentesä¸­çš„èº«ä»½éªŒè¯&#34;&gt;Kubernentesä¸­çš„èº«ä»½éªŒè¯&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;kubernetes&lt;/code&gt; ç³»ç»Ÿçš„å„ç»„ä»¶éœ€è¦ä½¿ç”¨ &lt;code&gt;TLS&lt;/code&gt; è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œæœ¬æ–‡æ¡£ä½¿ç”¨ &lt;code&gt;CloudFlare&lt;/code&gt; çš„ PKI å·¥å…·é›† &lt;a href=&#34;https://github.com/cloudflare/cfssl&#34;&gt;cfssl&lt;/a&gt; æ¥ç”Ÿæˆ Certificate Authority (CA) å’Œå…¶å®ƒè¯ä¹¦ï¼›&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç”Ÿæˆçš„ CA è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ca-key.pem&lt;/li&gt;
&lt;li&gt;ca.pem&lt;/li&gt;
&lt;li&gt;kubernetes-key.pem&lt;/li&gt;
&lt;li&gt;kubernetes.pem&lt;/li&gt;
&lt;li&gt;kube-proxy.pem&lt;/li&gt;
&lt;li&gt;kube-proxy-key.pem&lt;/li&gt;
&lt;li&gt;admin.pem&lt;/li&gt;
&lt;li&gt;admin-key.pem&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;etcdï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›&lt;/li&gt;
&lt;li&gt;kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›&lt;/li&gt;
&lt;li&gt;kubeletï¼šä½¿ç”¨ ca.pemï¼›&lt;/li&gt;
&lt;li&gt;kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼›&lt;/li&gt;
&lt;li&gt;kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;kube-controller&lt;/code&gt;ã€&lt;code&gt;kube-scheduler&lt;/code&gt; å½“å‰éœ€è¦å’Œ &lt;code&gt;kube-apiserver&lt;/code&gt; éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸”ä½¿ç”¨éå®‰å…¨ç«¯å£é€šä¿¡ï¼Œæ•…ä¸éœ€è¦è¯ä¹¦ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å®‰è£…-cfssl&#34;&gt;å®‰è£… &lt;code&gt;CFSSL&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼ä¸€ï¼šç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶æºç åŒ…å®‰è£…&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
$ chmod +x cfssl_linux-amd64
$ sudo mv cfssl_linux-amd64 /root/local/bin/cfssl

$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
$ chmod +x cfssljson_linux-amd64
$ sudo mv cfssljson_linux-amd64 /root/local/bin/cfssljson

$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
$ chmod +x cfssl-certinfo_linux-amd64
$ sudo mv cfssl-certinfo_linux-amd64 /root/local/bin/cfssl-certinfo

$ export PATH=/root/local/bin:$PATH
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;æ–¹å¼äºŒï¼šä½¿ç”¨goå‘½ä»¤å®‰è£…&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬çš„ç³»ç»Ÿä¸­å®‰è£…äº†Go1.7.5ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…æ›´å¿«æ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$go get -u github.com/cloudflare/cfssl/cmd/...
$echo $GOPATH
/usr/local
$ls /usr/local/bin/cfssl*
cfssl cfssl-bundle cfssl-certinfo cfssljson cfssl-newkey cfssl-scan
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;$GOPATH/bin&lt;/code&gt;ç›®å½•ä¸‹å¾—åˆ°ä»¥cfsslå¼€å¤´çš„å‡ ä¸ªå‘½ä»¤ã€‚&lt;/p&gt;

&lt;h2 id=&#34;åˆ›å»º-ca-certificate-authority&#34;&gt;åˆ›å»º CA (Certificate Authority)&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º CA é…ç½®æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mkdir /root/ssl
$ cd /root/ssl
$ cfssl print-defaults config &amp;gt; config.json
$ cfssl print-defaults csr &amp;gt; csr.json
$ cat ca-config.json
{
  &amp;quot;signing&amp;quot;: {
    &amp;quot;default&amp;quot;: {
      &amp;quot;expiry&amp;quot;: &amp;quot;8760h&amp;quot;
    },
    &amp;quot;profiles&amp;quot;: {
      &amp;quot;kubernetes&amp;quot;: {
        &amp;quot;usages&amp;quot;: [
            &amp;quot;signing&amp;quot;,
            &amp;quot;key encipherment&amp;quot;,
            &amp;quot;server auth&amp;quot;,
            &amp;quot;client auth&amp;quot;
        ],
        &amp;quot;expiry&amp;quot;: &amp;quot;8760h&amp;quot;
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å­—æ®µè¯´æ˜&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ca-config.json&lt;/code&gt;ï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;signing&lt;/code&gt;ï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ &lt;code&gt;CA=TRUE&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;server auth&lt;/code&gt;ï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;client auth&lt;/code&gt;ï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»º CA è¯ä¹¦ç­¾åè¯·æ±‚&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat ca-csr.json
{
  &amp;quot;CN&amp;quot;: &amp;quot;kubernetes&amp;quot;,
  &amp;quot;key&amp;quot;: {
    &amp;quot;algo&amp;quot;: &amp;quot;rsa&amp;quot;,
    &amp;quot;size&amp;quot;: 2048
  },
  &amp;quot;names&amp;quot;: [
    {
      &amp;quot;C&amp;quot;: &amp;quot;CN&amp;quot;,
      &amp;quot;ST&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;L&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;O&amp;quot;: &amp;quot;k8s&amp;quot;,
      &amp;quot;OU&amp;quot;: &amp;quot;System&amp;quot;
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&amp;ldquo;CN&amp;rdquo;ï¼š&lt;code&gt;Common Name&lt;/code&gt;ï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›&lt;/li&gt;
&lt;li&gt;&amp;ldquo;O&amp;rdquo;ï¼š&lt;code&gt;Organization&lt;/code&gt;ï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
$ ls ca*
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ›å»º-kubernetes-è¯ä¹¦&#34;&gt;åˆ›å»º kubernetes è¯ä¹¦&lt;/h2&gt;

&lt;p&gt;åˆ›å»º kubernetes è¯ä¹¦ç­¾åè¯·æ±‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat kubernetes-csr.json
{
    &amp;quot;CN&amp;quot;: &amp;quot;kubernetes&amp;quot;,
    &amp;quot;hosts&amp;quot;: [
      &amp;quot;127.0.0.1&amp;quot;,
      &amp;quot;172.20.0.112&amp;quot;,
      &amp;quot;172.20.0.113&amp;quot;,
      &amp;quot;172.20.0.114&amp;quot;,
      &amp;quot;172.20.0.115&amp;quot;,
      &amp;quot;10.254.0.1&amp;quot;,
      &amp;quot;kubernetes&amp;quot;,
      &amp;quot;kubernetes.default&amp;quot;,
      &amp;quot;kubernetes.default.svc&amp;quot;,
      &amp;quot;kubernetes.default.svc.cluster&amp;quot;,
      &amp;quot;kubernetes.default.svc.cluster.local&amp;quot;
    ],
    &amp;quot;key&amp;quot;: {
        &amp;quot;algo&amp;quot;: &amp;quot;rsa&amp;quot;,
        &amp;quot;size&amp;quot;: 2048
    },
    &amp;quot;names&amp;quot;: [
        {
            &amp;quot;C&amp;quot;: &amp;quot;CN&amp;quot;,
            &amp;quot;ST&amp;quot;: &amp;quot;BeiJing&amp;quot;,
            &amp;quot;L&amp;quot;: &amp;quot;BeiJing&amp;quot;,
            &amp;quot;O&amp;quot;: &amp;quot;k8s&amp;quot;,
            &amp;quot;OU&amp;quot;: &amp;quot;System&amp;quot;
        }
    ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœ hosts å­—æ®µä¸ä¸ºç©ºåˆ™éœ€è¦æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ &lt;strong&gt;IP æˆ–åŸŸååˆ—è¡¨&lt;/strong&gt;ï¼Œç”±äºè¯¥è¯ä¹¦åç»­è¢« &lt;code&gt;etcd&lt;/code&gt; é›†ç¾¤å’Œ &lt;code&gt;kubernetes master&lt;/code&gt; é›†ç¾¤ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸Šé¢åˆ†åˆ«æŒ‡å®šäº† &lt;code&gt;etcd&lt;/code&gt; é›†ç¾¤ã€&lt;code&gt;kubernetes master&lt;/code&gt; é›†ç¾¤çš„ä¸»æœº IP å’Œ &lt;strong&gt;&lt;code&gt;kubernetes&lt;/code&gt; æœåŠ¡çš„æœåŠ¡ IP&lt;/strong&gt;ï¼ˆä¸€èˆ¬æ˜¯ &lt;code&gt;kue-apiserver&lt;/code&gt; æŒ‡å®šçš„ &lt;code&gt;service-cluster-ip-range&lt;/code&gt; ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.254.0.1ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;ç”Ÿæˆ kubernetes è¯ä¹¦å’Œç§é’¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes
$ ls kuberntes*
kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ–è€…ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šç›¸å…³å‚æ•°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ echo &#39;{&amp;quot;CN&amp;quot;:&amp;quot;kubernetes&amp;quot;,&amp;quot;hosts&amp;quot;:[&amp;quot;&amp;quot;],&amp;quot;key&amp;quot;:{&amp;quot;algo&amp;quot;:&amp;quot;rsa&amp;quot;,&amp;quot;size&amp;quot;:2048}}&#39; | cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes -hostname=&amp;quot;127.0.0.1,10.64.3.7,10.254.0.1,kubernetes,kubernetes.default&amp;quot; - | cfssljson -bare kubernetes
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ›å»º-admin-è¯ä¹¦&#34;&gt;åˆ›å»º admin è¯ä¹¦&lt;/h2&gt;

&lt;p&gt;åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat admin-csr.json
{
  &amp;quot;CN&amp;quot;: &amp;quot;admin&amp;quot;,
  &amp;quot;hosts&amp;quot;: [],
  &amp;quot;key&amp;quot;: {
    &amp;quot;algo&amp;quot;: &amp;quot;rsa&amp;quot;,
    &amp;quot;size&amp;quot;: 2048
  },
  &amp;quot;names&amp;quot;: [
    {
      &amp;quot;C&amp;quot;: &amp;quot;CN&amp;quot;,
      &amp;quot;ST&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;L&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;O&amp;quot;: &amp;quot;system:masters&amp;quot;,
      &amp;quot;OU&amp;quot;: &amp;quot;System&amp;quot;
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;åç»­ &lt;code&gt;kube-apiserver&lt;/code&gt; ä½¿ç”¨ &lt;code&gt;RBAC&lt;/code&gt; å¯¹å®¢æˆ·ç«¯(å¦‚ &lt;code&gt;kubelet&lt;/code&gt;ã€&lt;code&gt;kube-proxy&lt;/code&gt;ã€&lt;code&gt;Pod&lt;/code&gt;)è¯·æ±‚è¿›è¡Œæˆæƒï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kube-apiserver&lt;/code&gt; é¢„å®šä¹‰äº†ä¸€äº› &lt;code&gt;RBAC&lt;/code&gt; ä½¿ç”¨çš„ &lt;code&gt;RoleBindings&lt;/code&gt;ï¼Œå¦‚ &lt;code&gt;cluster-admin&lt;/code&gt; å°† Group &lt;code&gt;system:masters&lt;/code&gt; ä¸ Role &lt;code&gt;cluster-admin&lt;/code&gt; ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨&lt;code&gt;kube-apiserver&lt;/code&gt; çš„&lt;strong&gt;æ‰€æœ‰ API&lt;/strong&gt;çš„æƒé™ï¼›&lt;/li&gt;
&lt;li&gt;OU æŒ‡å®šè¯¥è¯ä¹¦çš„ Group ä¸º &lt;code&gt;system:masters&lt;/code&gt;ï¼Œ&lt;code&gt;kubelet&lt;/code&gt; ä½¿ç”¨è¯¥è¯ä¹¦è®¿é—® &lt;code&gt;kube-apiserver&lt;/code&gt; æ—¶ ï¼Œç”±äºè¯ä¹¦è¢« CA ç­¾åï¼Œæ‰€ä»¥è®¤è¯é€šè¿‡ï¼ŒåŒæ—¶ç”±äºè¯ä¹¦ç”¨æˆ·ç»„ä¸ºç»è¿‡é¢„æˆæƒçš„ &lt;code&gt;system:masters&lt;/code&gt;ï¼Œæ‰€ä»¥è¢«æˆäºˆè®¿é—®æ‰€æœ‰ API çš„æƒé™ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
$ ls admin*
admin.csr  admin-csr.json  admin-key.pem  admin.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ›å»º-kube-proxy-è¯ä¹¦&#34;&gt;åˆ›å»º kube-proxy è¯ä¹¦&lt;/h2&gt;

&lt;p&gt;åˆ›å»º kube-proxy è¯ä¹¦ç­¾åè¯·æ±‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cat kube-proxy-csr.json
{
  &amp;quot;CN&amp;quot;: &amp;quot;system:kube-proxy&amp;quot;,
  &amp;quot;hosts&amp;quot;: [],
  &amp;quot;key&amp;quot;: {
    &amp;quot;algo&amp;quot;: &amp;quot;rsa&amp;quot;,
    &amp;quot;size&amp;quot;: 2048
  },
  &amp;quot;names&amp;quot;: [
    {
      &amp;quot;C&amp;quot;: &amp;quot;CN&amp;quot;,
      &amp;quot;ST&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;L&amp;quot;: &amp;quot;BeiJing&amp;quot;,
      &amp;quot;O&amp;quot;: &amp;quot;k8s&amp;quot;,
      &amp;quot;OU&amp;quot;: &amp;quot;System&amp;quot;
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;CN æŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º &lt;code&gt;system:kube-proxy&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kube-apiserver&lt;/code&gt; é¢„å®šä¹‰çš„ RoleBinding &lt;code&gt;cluster-admin&lt;/code&gt; å°†User &lt;code&gt;system:kube-proxy&lt;/code&gt; ä¸ Role &lt;code&gt;system:node-proxier&lt;/code&gt; ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ &lt;code&gt;kube-apiserver&lt;/code&gt; Proxy ç›¸å…³ API çš„æƒé™ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”Ÿæˆ kube-proxy å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy
$ ls kube-proxy*
kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ ¡éªŒè¯ä¹¦&#34;&gt;æ ¡éªŒè¯ä¹¦&lt;/h2&gt;

&lt;p&gt;ä»¥ kubernetes è¯ä¹¦ä¸ºä¾‹&lt;/p&gt;

&lt;h3 id=&#34;ä½¿ç”¨-opsnssl-å‘½ä»¤&#34;&gt;ä½¿ç”¨ &lt;code&gt;opsnssl&lt;/code&gt; å‘½ä»¤&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ openssl x509  -noout -text -in  kubernetes.pem
...
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=Kubernetes
        Validity
            Not Before: Apr  5 05:36:00 2017 GMT
            Not After : Apr  5 05:36:00 2018 GMT
        Subject: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes
...
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Basic Constraints: critical
                CA:FALSE
            X509v3 Subject Key Identifier:
                DD:52:04:43:10:13:A9:29:24:17:3A:0E:D7:14:DB:36:F8:6C:E0:E0
            X509v3 Authority Key Identifier:
                keyid:44:04:3B:60:BD:69:78:14:68:AF:A0:41:13:F6:17:07:13:63:58:CD

            X509v3 Subject Alternative Name:
                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:172.20.0.112, IP Address:172.20.0.113, IP Address:172.20.0.114, IP Address:172.20.0.115, IP Address:10.254.0.1
...
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;ç¡®è®¤ &lt;code&gt;Issuer&lt;/code&gt; å­—æ®µçš„å†…å®¹å’Œ &lt;code&gt;ca-csr.json&lt;/code&gt; ä¸€è‡´ï¼›&lt;/li&gt;
&lt;li&gt;ç¡®è®¤ &lt;code&gt;Subject&lt;/code&gt; å­—æ®µçš„å†…å®¹å’Œ &lt;code&gt;kubernetes-csr.json&lt;/code&gt; ä¸€è‡´ï¼›&lt;/li&gt;
&lt;li&gt;ç¡®è®¤ &lt;code&gt;X509v3 Subject Alternative Name&lt;/code&gt; å­—æ®µçš„å†…å®¹å’Œ &lt;code&gt;kubernetes-csr.json&lt;/code&gt; ä¸€è‡´ï¼›&lt;/li&gt;
&lt;li&gt;ç¡®è®¤ &lt;code&gt;X509v3 Key Usageã€Extended Key Usage&lt;/code&gt; å­—æ®µçš„å†…å®¹å’Œ &lt;code&gt;ca-config.json&lt;/code&gt; ä¸­ &lt;code&gt;kubernetes&lt;/code&gt; profile ä¸€è‡´ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;ä½¿ç”¨-cfssl-certinfo-å‘½ä»¤&#34;&gt;ä½¿ç”¨ &lt;code&gt;cfssl-certinfo&lt;/code&gt; å‘½ä»¤&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cfssl-certinfo -cert kubernetes.pem
...
{
  &amp;quot;subject&amp;quot;: {
    &amp;quot;common_name&amp;quot;: &amp;quot;kubernetes&amp;quot;,
    &amp;quot;country&amp;quot;: &amp;quot;CN&amp;quot;,
    &amp;quot;organization&amp;quot;: &amp;quot;k8s&amp;quot;,
    &amp;quot;organizational_unit&amp;quot;: &amp;quot;System&amp;quot;,
    &amp;quot;locality&amp;quot;: &amp;quot;BeiJing&amp;quot;,
    &amp;quot;province&amp;quot;: &amp;quot;BeiJing&amp;quot;,
    &amp;quot;names&amp;quot;: [
      &amp;quot;CN&amp;quot;,
      &amp;quot;BeiJing&amp;quot;,
      &amp;quot;BeiJing&amp;quot;,
      &amp;quot;k8s&amp;quot;,
      &amp;quot;System&amp;quot;,
      &amp;quot;kubernetes&amp;quot;
    ]
  },
  &amp;quot;issuer&amp;quot;: {
    &amp;quot;common_name&amp;quot;: &amp;quot;Kubernetes&amp;quot;,
    &amp;quot;country&amp;quot;: &amp;quot;CN&amp;quot;,
    &amp;quot;organization&amp;quot;: &amp;quot;k8s&amp;quot;,
    &amp;quot;organizational_unit&amp;quot;: &amp;quot;System&amp;quot;,
    &amp;quot;locality&amp;quot;: &amp;quot;BeiJing&amp;quot;,
    &amp;quot;province&amp;quot;: &amp;quot;BeiJing&amp;quot;,
    &amp;quot;names&amp;quot;: [
      &amp;quot;CN&amp;quot;,
      &amp;quot;BeiJing&amp;quot;,
      &amp;quot;BeiJing&amp;quot;,
      &amp;quot;k8s&amp;quot;,
      &amp;quot;System&amp;quot;,
      &amp;quot;Kubernetes&amp;quot;
    ]
  },
  &amp;quot;serial_number&amp;quot;: &amp;quot;174360492872423263473151971632292895707129022309&amp;quot;,
  &amp;quot;sans&amp;quot;: [
    &amp;quot;kubernetes&amp;quot;,
    &amp;quot;kubernetes.default&amp;quot;,
    &amp;quot;kubernetes.default.svc&amp;quot;,
    &amp;quot;kubernetes.default.svc.cluster&amp;quot;,
    &amp;quot;kubernetes.default.svc.cluster.local&amp;quot;,
    &amp;quot;127.0.0.1&amp;quot;,
    &amp;quot;10.64.3.7&amp;quot;,
    &amp;quot;10.254.0.1&amp;quot;
  ],
  &amp;quot;not_before&amp;quot;: &amp;quot;2017-04-05T05:36:00Z&amp;quot;,
  &amp;quot;not_after&amp;quot;: &amp;quot;2018-04-05T05:36:00Z&amp;quot;,
  &amp;quot;sigalg&amp;quot;: &amp;quot;SHA256WithRSA&amp;quot;,
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;åˆ†å‘è¯ä¹¦&#34;&gt;åˆ†å‘è¯ä¹¦&lt;/h2&gt;

&lt;p&gt;å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º&lt;code&gt;.pem&lt;/code&gt;ï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨çš„ &lt;code&gt;/etc/kubernetes/ssl&lt;/code&gt; ç›®å½•ä¸‹å¤‡ç”¨ï¼›&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ sudo mkdir -p /etc/kubernetes/ssl
$ sudo cp *.pem /etc/kubernetes/ssl
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://coreos.com/os/docs/latest/generate-self-signed-certificates.html&#34;&gt;Generate self-signed certificates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/02-certificate-authority.md&#34;&gt;Setting up a Certificate Authority and Creating TLS Certificates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blogs.msdn.microsoft.com/kaushal/2012/02/17/client-certificates-vs-server-certificates/&#34;&gt;Client Certificates V/s Server Certificates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.jobbole.com/104919/&#34;&gt;æ•°å­—è¯ä¹¦åŠ CA çš„æ‰«ç›²ä»‹ç»&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>ä½¿ç”¨Fluentdå’ŒElasticSearchæ”¶é›†Kubernetesé›†ç¾¤æ—¥å¿—</title>
      <link>http://rootsongjc.github.io/blogs/kubernetes-fluentd-elasticsearch-installation/</link>
      <pubDate>Fri, 07 Apr 2017 20:13:24 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/blogs/kubernetes-fluentd-elasticsearch-installation/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/20160430080.jpg&#34; alt=&#34;å¤åŒ—æ°´é•‡&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ï¼ˆé¢˜å›¾ï¼šç å¤´@å¤åŒ—æ°´é•‡ Apr 30,2016ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;å‰è¨€&#34;&gt;å‰è¨€&lt;/h2&gt;

&lt;p&gt;åœ¨&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-installation-on-centos/&#34;&gt;å®‰è£…å¥½äº†Kubernetesé›†ç¾¤&lt;/a&gt;ã€&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-network-config/&#34;&gt;é…ç½®å¥½äº†flannelç½‘ç»œ&lt;/a&gt;ã€&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-dashboard-installation/&#34;&gt;å®‰è£…äº†Kubernetes Dashboard&lt;/a&gt;å’Œ&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-heapster-installation/&#34;&gt;é…ç½®Heapsterç›‘æ§æ’ä»¶&lt;/a&gt;åï¼Œè¿˜æœ‰ä¸€é¡¹é‡è¦çš„å·¥ä½œï¼Œä¸ºäº†è°ƒè¯•å’Œæ•…éšœæ’æŸ¥ï¼Œè¿˜éœ€è¦è¿›è¡Œæ—¥å¿—æ”¶é›†å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å®˜æ–¹æ–‡æ¡£&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://kubernetes.io/docs/concepts/cluster-administration/logging/&#34;&gt;Kubernetes Logging and Monitoring Cluster Activity&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://kubernetes.io/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/&#34;&gt;Logging Using Elasticsearch and Kibana&lt;/a&gt;ï¼šä¸è¿‡è¿™ç¯‡æ–‡ç« æ˜¯åœ¨GCEä¸Šé…ç½®çš„ï¼Œå‚è€ƒä»·å€¼ä¸å¤§ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å®¹å™¨æ—¥å¿—çš„å­˜åœ¨å½¢å¼&#34;&gt;å®¹å™¨æ—¥å¿—çš„å­˜åœ¨å½¢å¼&lt;/h2&gt;

&lt;p&gt;ç›®å‰å®¹å™¨æ—¥å¿—æœ‰ä¸¤ç§è¾“å‡ºå½¢å¼ï¼š&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;stdout,stderræ ‡å‡†è¾“å‡º&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;è¿™ç§å½¢å¼çš„æ—¥å¿—è¾“å‡ºæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨&lt;code&gt;docker logs&lt;/code&gt;æŸ¥çœ‹æ—¥å¿—ï¼Œkubernetesé›†ç¾¤ä¸­åŒæ ·å¯ä»¥ä½¿ç”¨&lt;code&gt;kubectl logs&lt;/code&gt;ç±»ä¼¼çš„å½¢å¼æŸ¥çœ‹æ—¥å¿—ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ—¥å¿—æ–‡ä»¶è®°å½•&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;è¿™ç§æ—¥å¿—è¾“å‡ºæˆ‘ä»¬æ— æ³•ä»ä»¥ä¸Šæ–¹æ³•æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼Œåªèƒ½&lt;code&gt;tail&lt;/code&gt;æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;fluentdä»‹ç»&#34;&gt;Fluentdä»‹ç»&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/fluent/fluentd&#34;&gt;Fluentd&lt;/a&gt;æ˜¯ä½¿ç”¨Rubyç¼–å†™çš„ï¼Œé€šè¿‡åœ¨åç«¯ç³»ç»Ÿä¹‹é—´æä¾›&lt;strong&gt;ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å±‚&lt;/strong&gt;æ¥ä»åç«¯ç³»ç»Ÿä¸­è§£è€¦æ•°æ®æºã€‚
æ­¤å±‚å…è®¸å¼€å‘äººå‘˜å’Œæ•°æ®åˆ†æäººå‘˜åœ¨ç”Ÿæˆæ—¥å¿—æ—¶ä½¿ç”¨å¤šç§ç±»å‹çš„æ—¥å¿—ã€‚
ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å±‚å¯ä»¥è®©æ‚¨å’Œæ‚¨çš„ç»„ç»‡æ›´å¥½åœ°ä½¿ç”¨æ•°æ®ï¼Œå¹¶æ›´å¿«åœ°åœ¨æ‚¨çš„è½¯ä»¶ä¸Šè¿›è¡Œè¿­ä»£ã€‚
ä¹Ÿå°±æ˜¯è¯´fluentdæ˜¯ä¸€ä¸ªé¢å‘å¤šç§æ•°æ®æ¥æºä»¥åŠé¢å‘å¤šç§æ•°æ®å‡ºå£çš„æ—¥å¿—æ”¶é›†å™¨ã€‚å¦å¤–å®ƒé™„å¸¦äº†æ—¥å¿—è½¬å‘çš„åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://camo.githubusercontent.com/c4abfe337c0b54b36f81bce78481f8965acbc7a9/687474703a2f2f646f63732e666c75656e74642e6f72672f696d616765732f666c75656e74642d6172636869746563747572652e706e67&#34; alt=&#34;arch&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Fluentdæ”¶é›†çš„&lt;strong&gt;event&lt;/strong&gt;ç”±ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ç»„æˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Tag&lt;/strong&gt;ï¼šå­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨ç‚¹éš”å¼€ï¼Œå¦‚myapp.access&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Time&lt;/strong&gt;ï¼šUNIXæ—¶é—´æ ¼å¼&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Record&lt;/strong&gt;ï¼šJSONæ ¼å¼&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;fluentdç‰¹ç‚¹&#34;&gt;Fluentdç‰¹ç‚¹&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;éƒ¨ç½²ç®€å•çµæ´»&lt;/li&gt;
&lt;li&gt;å¼€æº&lt;/li&gt;
&lt;li&gt;ç»è¿‡éªŒè¯çš„å¯é æ€§å’Œæ€§èƒ½&lt;/li&gt;
&lt;li&gt;ç¤¾åŒºæ”¯æŒï¼Œæ’ä»¶è¾ƒå¤š&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨jsonæ ¼å¼äº‹ä»¶æ ¼å¼&lt;/li&gt;
&lt;li&gt;å¯æ‹”æ’çš„æ¶æ„è®¾è®¡&lt;/li&gt;
&lt;li&gt;ä½èµ„æºè¦æ±‚&lt;/li&gt;
&lt;li&gt;å†…ç½®é«˜å¯é æ€§&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;å®‰è£…&#34;&gt;å®‰è£…&lt;/h2&gt;

&lt;p&gt;æŸ¥çœ‹&lt;code&gt;cluster/addons/fluentd-elasticsearch&lt;/code&gt;æ’ä»¶ç›®å½•ï¼Œè·å–åˆ°éœ€è¦ç”¨åˆ°çš„dockeré•œåƒåç§°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$grep -rn &amp;quot;gcr.io&amp;quot; *.yaml
es-controller.yaml:24:      - image: gcr.io/google_containers/elasticsearch:v2.4.1-2
fluentd-es-ds.yaml:26:        image: gcr.io/google_containers/fluentd-elasticsearch:1.22
kibana-controller.yaml:22:        image: gcr.io/google_containers/kibana:v4.6.1-1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;éœ€è¦ç”¨åˆ°çš„é•œåƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gcr.io/google_containers/kibana:v4.6.1-1&lt;/li&gt;
&lt;li&gt;gcr.io/google_containers/elasticsearch:v2.4.1-2&lt;/li&gt;
&lt;li&gt;gcr.io/google_containers/fluentd-elasticsearch:1.22&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å› ä¸ºè¿™äº›é•œåƒåœ¨å¢™å¤–ï¼Œæ‰€ä»¥æˆ‘ç‰¹æ„å¤‡ä»½äº†ä¸€ä»½åœ¨æœ¬åœ°è¿˜æœ‰æ—¶é€Ÿäº‘ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æµ‹è¯•ç¯å¢ƒé•œåƒåç§°&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;sz-pg-oam-docker-hub-001.tendcloud.com/library/elasticsearch:v2.4.1-2&lt;/li&gt;
&lt;li&gt;sz-pg-oam-docker-hub-001.tendcloud.com/library/kibana:v4.6.1-1&lt;/li&gt;
&lt;li&gt;sz-pg-oam-docker-hub-001.tendcloud.com/library/fluentd-elasticsearch:1.22&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;å¤‡ä»½åˆ°æ—¶é€Ÿäº‘ä¸Šçš„é•œåƒåç§°&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;index.tenxcloud.com/jimmy/elasticsearch:v2.4.1-2&lt;/li&gt;
&lt;li&gt;index.tenxcloud.com/jimmy/kibana:v4.6.1-1&lt;/li&gt;
&lt;li&gt;index.tenxcloud.com/jimmy/fluentd-elasticsearch:1.22&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¿®æ”¹ä¸Šé¢çš„é‚£ä¸‰ä¸ªyamlæ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„é•œåƒåç§°æ”¹æˆæˆ‘ä»¬æµ‹è¯•ç¯å¢ƒä¸­çš„ã€‚&lt;/p&gt;

&lt;h3 id=&#34;å¯åŠ¨é›†ç¾¤&#34;&gt;å¯åŠ¨é›†ç¾¤&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨åˆšä¿®æ”¹å¥½yamlæ–‡ä»¶çš„é‚£ä¸ªç›®å½•å¯åŠ¨fluentd-elasticsearchã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl create -f flucentd-elasticsearch
$kubectl get -f fluentd-elasticsearch/
NAME                          DESIRED   CURRENT   READY     AGE
rc/elasticsearch-logging-v1   2         2         2         13m

NAME                        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
svc/elasticsearch-logging   10.254.107.114   &amp;lt;none&amp;gt;        9200/TCP   13m

NAME                  DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE-SELECTOR                              AGE
ds/fluentd-es-v1.22   0         0         0         0            0           beta.kubernetes.io/fluentd-ds-ready=true   13m

NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deploy/kibana-logging   1         1         1            1           13m

NAME                 CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
svc/kibana-logging   10.254.104.215   &amp;lt;none&amp;gt;        5601/TCP   13m

$kubectl cluster-info
Kubernetes master is running at http://sz-pg-oam-docker-test-001:8080
Elasticsearch is running at http://sz-pg-oam-docker-test-001:8080/api/v1/proxy/namespaces/kube-system/services/elasticsearch-logging
Heapster is running at http://sz-pg-oam-docker-test-001:8080/api/v1/proxy/namespaces/kube-system/services/heapster
Kibana is running at http://sz-pg-oam-docker-test-001:8080/api/v1/proxy/namespaces/kube-system/services/kibana-logging
monitoring-grafana is running at http://sz-pg-oam-docker-test-001:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-grafana
monitoring-influxdb is running at http://sz-pg-oam-docker-test-001:8080/api/v1/proxy/namespaces/kube-system/services/monitoring-influxdb

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯åŠ¨å®Œæˆï¼Œä½†æ˜¯æŸ¥çœ‹podçš„æ—¥å¿—åä¼šå‘ç°å‡ºé”™äº†ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹å¯åŠ¨ä¸€ä¸ªFluentdå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨DaemonSetã€‚&lt;/p&gt;

&lt;h3 id=&#34;æ’é”™&#34;&gt;æ’é”™&lt;/h3&gt;

&lt;p&gt;æŸ¥çœ‹å¯åŠ¨çš„podã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl --namespace=kube-system get all
NAME                                       READY     STATUS    RESTARTS   AGE
po/elasticsearch-logging-v1-nshz2          1/1       Running   0          16m
po/elasticsearch-logging-v1-q515j          1/1       Running   0          16m
po/heapster-3669180046-06n3d               1/1       Running   0          23h
po/kibana-logging-4247188994-h8jxx         1/1       Running   0          16m
po/kubernetes-dashboard-1074266307-hsgxx   1/1       Running   0          1d
po/monitoring-grafana-127711743-xl9v1      1/1       Running   0          23h
po/monitoring-influxdb-1411048194-cvxmm    1/1       Running   0          23h
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åº”è¯¥åœ¨ä¸ªnodeèŠ‚ç‚¹ä¸Šå¯åŠ¨çš„&lt;strong&gt;fluentd&lt;/strong&gt;æ²¡æœ‰çœ‹åˆ°ã€‚æŸ¥çœ‹logging podçš„æ—¥å¿—ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl -n kube-system logs po/elasticsearch-logging-v1-nshz2
F0406 08:30:05.488197       7 elasticsearch_logging_discovery.go:49] Failed to make client: open /var/run/secrets/kubernetes.io/serviceaccount/token: no such file or directory
goroutine 1 [running]:
...
[2017-04-06 08:30:23,450][WARN ][discovery.zen.ping.unicast] [elasticsearch-logging-v1-nshz2] failed to send ping to [{#zen_unicast_1#}{127.0.0.1}{127.0.0.1:9300}]
SendRequestTransportException[[][127.0.0.1:9300][internal:discovery/zen/unicast]]; nested: NodeNotConnectedException[[][127.0.0.1:9300] Node not connected];
	at org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:340)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPingRequestToNode(UnicastZenPing.java:440)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPings(UnicastZenPing.java:426)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.ping(UnicastZenPing.java:240)
	at org.elasticsearch.discovery.zen.ping.ZenPingService.ping(ZenPingService.java:106)
	at org.elasticsearch.discovery.zen.ping.ZenPingService.pingAndWait(ZenPingService.java:84)
	at org.elasticsearch.discovery.zen.ZenDiscovery.findMaster(ZenDiscovery.java:945)
	at org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:360)
	at org.elasticsearch.discovery.zen.ZenDiscovery.access$4400(ZenDiscovery.java:96)
	at org.elasticsearch.discovery.zen.ZenDiscovery$JoinThreadControl$1.run(ZenDiscovery.java:1296)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: NodeNotConnectedException[[][127.0.0.1:9300] Node not connected]
	at org.elasticsearch.transport.netty.NettyTransport.nodeChannel(NettyTransport.java:1141)
	at org.elasticsearch.transport.netty.NettyTransport.sendRequest(NettyTransport.java:830)
	at org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:329)
	... 12 more
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŠ¥é”™ä¸­æœ‰è¿™æ ·çš„æè¿°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;discovery.zen.ping.unicast failed to send ping to [{#zen_unicast_1#}{127.0.0.1}{127.0.0.1:9300}]
SendRequestTransportException[[internal:discovery/zen/unicast]]; nested: NodeNotConnectedException[ Node not connected]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œé¢æœ‰ä¸¤ä¸ªé”™è¯¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ— æ³•è®¿é—®åˆ°API Server&lt;/li&gt;
&lt;li&gt;elasticsearchä¸¤ä¸ªèŠ‚ç‚¹é—´äº’pingå¤±è´¥&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™ä¸ªæ˜¯é•œåƒä¸­çš„é…ç½®é—®é¢˜ï¼Œé…ç½®æ–‡ä»¶åœ¨&lt;code&gt;fluentd-es-image/td-agent.conf&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å‚è€ƒ&lt;a href=&#34;http://tonybai.com/2017/03/03/implement-kubernetes-cluster-level-logging-with-fluentd-and-elasticsearch-stack/&#34;&gt;ä½¿ç”¨Fluentdå’ŒElasticSearch Stackå®ç°Kubernetesçš„é›†ç¾¤Logging&lt;/a&gt;ï¼ŒTony Baiä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬äº†è§£ä¸‹&lt;a href=&#34;https://kubernetes.io/docs/user-guide/configmap/&#34;&gt;ConfigMap&lt;/a&gt;è¿˜æœ‰&lt;a href=&#34;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&#34;&gt;fluent-plugin-kubernetes_metadata_filter&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å‚è€ƒæˆ‘çš„å¦ä¸€ç‰‡è¯‘æ–‡&lt;a href=&#34;rootsongjc.github.io/blogs/kubernetes-configmap-introduction&#34;&gt;Kubernetesä¸­ConfigMapè§£æ&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é—®é¢˜æ’æŸ¥&#34;&gt;é—®é¢˜æ’æŸ¥&lt;/h2&gt;

&lt;p&gt;å‰é¢å†™çš„æ˜¯ç›´æ¥ä½¿ç”¨&lt;code&gt;kubectl create -f flucentd-elasticsearch&lt;/code&gt;å‘½ä»¤å¯åŠ¨æ•´ä¸ªfluentd+elasticsearché›†ç¾¤ï¼Œè¿™æ ·å¯åŠ¨çœ‹ä¼¼å¾ˆç®€å•ï¼Œä½†æ˜¯å¯¹äºé—®é¢˜æ’æŸ¥çš„æ—¶å€™ä¸ä¾¿äºæˆ‘ä»¬åˆ†æå‡ºé”™åŸå› ï¼Œå› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å’Œå¯åŠ¨é¡ºåºï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬ä¾æ¬¡å¯åŠ¨æ¯ä¸ªæœåŠ¡ï¼Œçœ‹çœ‹èƒŒåéƒ½åšäº†ä»€ä¹ˆã€‚&lt;/p&gt;

&lt;h3 id=&#34;å¯åŠ¨fluentd&#34;&gt;å¯åŠ¨fluentd&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆå¯åŠ¨fluentdæ”¶é›†æ—¥å¿—çš„æœåŠ¡ï¼Œä»&lt;code&gt;fluentd-es-ds.yaml&lt;/code&gt;çš„é…ç½®ä¸­å¯ä»¥çœ‹åˆ°fluentdæ˜¯ä»¥&lt;a href=&#34;https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/&#34;&gt;DaemonSet&lt;/a&gt;æ–¹å¼æ¥è¿è¡Œçš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;DaemonSetç®€ä»‹&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;DaemonSetèƒ½å¤Ÿè®©æ‰€æœ‰ï¼ˆæˆ–è€…ä¸€äº›ç‰¹å®šï¼‰çš„NodeèŠ‚ç‚¹è¿è¡ŒåŒä¸€ä¸ªpodã€‚å½“èŠ‚ç‚¹åŠ å…¥åˆ°kubernetesé›†ç¾¤ä¸­ï¼Œpodä¼šè¢«ï¼ˆDaemonSetï¼‰è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå½“èŠ‚ç‚¹ä»kubernetesé›†ç¾¤ä¸­è¢«ç§»é™¤ï¼Œè¢«ï¼ˆDaemonSetï¼‰è°ƒåº¦çš„podä¼šè¢«ç§»é™¤ï¼Œå¦‚æœåˆ é™¤DaemonSetï¼Œæ‰€æœ‰è·Ÿè¿™ä¸ªDaemonSetç›¸å…³çš„podséƒ½ä¼šè¢«åˆ é™¤ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.dockerinfo.net/1139.html&#34;&gt;DaemonSetè¯¦ç»†ä»‹ç»&lt;/a&gt;ï¼Œè¿™æ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ï¼Œå…¶ä¸­è¿˜æœ‰ç¤ºä¾‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¯åŠ¨fluentd&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl create -f fluentd-es-ds.yaml
daemonset &amp;quot;fluentd-es-v1.22&amp;quot; created
$kubectl get -f fluentd-es-ds.yaml 
NAME               DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE-SELECTOR                              AGE
fluentd-es-v1.22   0         0         0         0            0           beta.kubernetes.io/fluentd-ds-ready=true   2m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨æ²¡æœ‰ä¿®æ”¹&lt;code&gt;fluentd-es-ds.yaml&lt;/code&gt;çš„æƒ…å†µä¸‹ç›´æ¥å¯åŠ¨fluentdï¼Œå®é™…ä¸Šä¸€ä¸ªPodä¹Ÿæ²¡æœ‰å¯åŠ¨èµ·æ¥ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º&lt;strong&gt;NODE-SELECTOR&lt;/strong&gt;é€‰æ‹©çš„labelæ˜¯&lt;code&gt;beta.kubernetes.io/fluentd-ds-ready=true&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å†æ¥çœ‹ä¸‹&lt;strong&gt;node&lt;/strong&gt;çš„&lt;strong&gt;label&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl describe node sz-pg-oam-docker-test-001.tendcloud.com
Name:			sz-pg-oam-docker-test-001.tendcloud.com
Role:			
Labels:			beta.kubernetes.io/arch=amd64
			beta.kubernetes.io/os=linux
			kubernetes.io/hostname=sz-pg-oam-docker-test-001.tendcloud.com
Annotations:		node.alpha.kubernetes.io/ttl=0
			volumes.kubernetes.io/controller-managed-attach-detach=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬æ²¡æœ‰ç»™nodeè®¾ç½®&lt;code&gt;beta.kubernetes.io/fluentd-ds-ready=true&lt;/code&gt;çš„labelï¼Œæ‰€ä»¥DaemonSetæ²¡æœ‰è°ƒåº¦ä¸Šå»ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»™kubernetesé›†ç¾¤çš„ä¸‰ä¸ªnodeæ·»åŠ labelã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl label node sz-pg-oam-docker-test-001.tendcloud.com beta.kubernetes.io/fluentd-ds-ready=true
node &amp;quot;sz-pg-oam-docker-test-001.tendcloud.com&amp;quot; labeled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»™å¦å¤–ä¸¤ä¸ªnodeæ‰§è¡ŒåŒæ ·çš„æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨å†æŸ¥çœ‹ä¸‹DaemonSetçš„çŠ¶æ€ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl get -f fluentd-es-ds.yaml 
NAME               DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE-SELECTOR                              AGE
fluentd-es-v1.22   3         3         0         3            0           beta.kubernetes.io/fluentd-ds-ready=true   31m
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç°åœ¨å¯ä»¥çœ‹åˆ°ä¸‰ä¸ªDeamonSetéƒ½å¯åŠ¨èµ·æ¥äº†ã€‚&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹ä¸‹fluentdçš„æ—¥å¿—&lt;code&gt;/var/log/fluentd.log&lt;/code&gt;ï¼Œæ—¥å¿—æ˜¯mountåˆ°æœ¬åœ°çš„ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;2017-04-07 03:53:42 +0000 [info]: adding match pattern=&amp;quot;fluent.**&amp;quot; type=&amp;quot;null&amp;quot;
2017-04-07 03:53:42 +0000 [info]: adding filter pattern=&amp;quot;kubernetes.**&amp;quot; type=&amp;quot;kubernetes_metadata&amp;quot;
2017-04-07 03:53:42 +0000 [error]: config error file=&amp;quot;/etc/td-agent/td-agent.conf&amp;quot; error=&amp;quot;Invalid Kubernetes API v1 endpoint https://10.254.0.1:443/api: SSL_connect returned=1 errno=0 state=error: certificate verify failed&amp;quot;
2017-04-07 03:53:42 +0000 [info]: process finished code=256
2017-04-07 03:53:42 +0000 [warn]: process died within 1 second. exit.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»æ—¥å¿—çš„æœ€åå‡ è¡Œä¸­å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code&gt;Invalid Kubernetes API v1 endpoint https://10.254.0.1:443/api: SSL_connect returned=1 errno=0 state=error: certificate verify failed&lt;/code&gt;è¿™æ ·çš„é”™è¯¯ï¼Œè¿™äº›éœ€è¦åœ¨&lt;code&gt;/etc/td-agent/td-agent.conf&lt;/code&gt;æ–‡ä»¶ä¸­é…ç½®çš„ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯è¿™äº›é…ç½®å·²ç»åœ¨åˆ›å»º&lt;code&gt;gcr.io/google_containers/fluentd-elasticsearch:1.22&lt;/code&gt;é•œåƒï¼ˆè¯¥é•œåƒæ˜¯è¿è¡Œå¸¦æœ‰elasticsearchæ’ä»¶çš„fluentdçš„ï¼‰çš„æ—¶å€™å°±å·²ç»copyè¿›å»äº†ï¼Œä»&lt;code&gt;fluentd-elasticsearch/fluentd-es-image/Dockerfile&lt;/code&gt;æ–‡ä»¶ä¸­å°±å¯ä»¥çœ‹åˆ°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Copy the Fluentd configuration file.
COPY td-agent.conf /etc/td-agent/td-agent.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;a href=&#34;http://rootsongjc.github.io/blogs/kubernetes-configmap-introduction/&#34;&gt;ConfigMap&lt;/a&gt;ï¼Œä¸ç”¨é‡æ–°å†buildé•œåƒï¼Œé€šè¿‡æ–‡ä»¶æŒ‚è½½çš„å½¢å¼æ›¿æ¢é•œåƒä¸­å·²æœ‰çš„td-agent.confæ–‡ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;tonybai.com&#34;&gt;Tony Bai&lt;/a&gt;ç»™å‡ºçš„ä¸¤ç‚¹å»ºè®®ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;åœ¨åŸºäºtd-agent.confåˆ›å»ºconfigmapèµ„æºä¹‹å‰ï¼Œéœ€è¦å°†td-agent.confä¸­çš„æ³¨é‡Šè¡Œéƒ½åˆ æ‰ï¼Œå¦åˆ™ç”Ÿæˆçš„configmapçš„å†…å®¹å¯èƒ½ä¸æ­£ç¡®ï¼›&lt;/li&gt;
&lt;li&gt;fluentd podå°†åˆ›å»ºåœ¨kube-systemä¸‹ï¼Œå› æ­¤ConfigMapèµ„æºä¹Ÿéœ€è¦åˆ›å»ºåœ¨kube-system namespaceä¸‹é¢ï¼Œå¦åˆ™kubectl createæ— æ³•æ‰¾åˆ°å¯¹åº”çš„ConfigMapã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨td-agent.confçš„é…ç½®æ–‡ä»¶çš„&lt;filter kubernetes.**&gt;ä¸­å¢åŠ ä¸¤æ¡é…ç½®é…ç½®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;filter kubernetes.**&amp;gt;
  type kubernetes_metadata
  kubernetes_url sz-pg-oam-docker-test-001.tendcloud.com:8080
  verify_ssl false
&amp;lt;/filter&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºConfigMap&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl create configmap td-agent-config --from-file=fluentd-elasticsearch/fluentd-es-image/td-agent.conf -n kube-system
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹åˆšåˆ›å»ºçš„ConfigMap&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$kubectl -n kube-system get configmaps td-agent-config -o yaml
apiVersion: v1
data:
  td-agent.conf: |
    &amp;lt;match fluent.**&amp;gt;
      type null
    &amp;lt;/match&amp;gt;
...
&amp;lt;filter kubernetes.**&amp;gt;
  type kubernetes_metadata
  kubernetes_url http://sz-pg-oam-docker-test-001.tendcloud.com:8080
  verify_ssl false
&amp;lt;/filter&amp;gt;
...

&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;âš ï¸ kubernetes_urlåœ°å€è¦åŠ ä¸Š&lt;strong&gt;http&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¿®æ”¹&lt;code&gt;fluentd-es-ds.yaml&lt;/code&gt;æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¢åŠ &lt;code&gt;td-agent.conf&lt;/code&gt;æ–‡ä»¶çš„volumeã€‚&lt;/p&gt;

&lt;p&gt;è¯¥æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
...
    spec:
     ...
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: td-agent-config
          mountPath: /etc/td-agent
...
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: td-agent-config
        configMap:
          name: td-agent-config
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯åŠ¨æ—¥å¿—æ”¶é›†æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl create -f ./fluentd-elasticsearch
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç°åœ¨å†æŸ¥çœ‹&lt;code&gt;/var/log/fluentd.log&lt;/code&gt;æ—¥å¿—é‡Œé¢å°±æ²¡æœ‰é”™è¯¯äº†ã€‚&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹ä¸‹elasticsearch podæ—¥å¿—ï¼Œå‘ç°é‡Œé¢è¿˜æœ‰é”™è¯¯ï¼Œè·Ÿä»¥å‰çš„ä¸€æ ·ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2017-04-07 10:54:57,858][WARN ][discovery.zen.ping.unicast] [elasticsearch-logging-v1-wxd5f] failed to send ping to [{#zen_unicast_1#}{127.0.0.1}{127.0.0.1:9300}]
SendRequestTransportException[[][127.0.0.1:9300][internal:discovery/zen/unicast]]; nested: NodeNotConnectedException[[][127.0.0.1:9300] Node not connected];
	at org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:340)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPingRequestToNode(UnicastZenPing.java:440)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPings(UnicastZenPing.java:426)
	at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.ping(UnicastZenPing.java:240)
	at org.elasticsearch.discovery.zen.ping.ZenPingService.ping(ZenPingService.java:106)
	at org.elasticsearch.discovery.zen.ping.ZenPingService.pingAndWait(ZenPingService.java:84)
	at org.elasticsearch.discovery.zen.ZenDiscovery.findMaster(ZenDiscovery.java:945)
	at org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:360)
	at org.elasticsearch.discovery.zen.ZenDiscovery.access$4400(ZenDiscovery.java:96)
	at org.elasticsearch.discovery.zen.ZenDiscovery$JoinThreadControl$1.run(ZenDiscovery.java:1296)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: NodeNotConnectedException[[][127.0.0.1:9300] Node not connected]
	at org.elasticsearch.transport.netty.NettyTransport.nodeChannel(NettyTransport.java:1141)
	at org.elasticsearch.transport.netty.NettyTransport.sendRequest(NettyTransport.java:830)
	at org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:329)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹ä¸‹elasticsearch:v2.4.1-2é•œåƒçš„ä»£ç ï¼Œåœ¨&lt;code&gt;fluentd-elasticsearch/es-image&lt;/code&gt;ç›®å½•ä¸‹ï¼Œè¯¥ç›®å½•ç»“æ„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;config
Dockerfile
elasticsearch_logging_discovery.go
Makefile
run.sh
template-k8s-logstash.json
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»&lt;strong&gt;Dockerfile&lt;/strong&gt;ä¸­å¯ä»¥çœ‹åˆ°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Dockerfile&#34;&gt;RUN mkdir -p /elasticsearch/config/templates
COPY template-k8s-logstash.json /elasticsearch/config/templates/template-k8s-logstash.json

COPY config /elasticsearch/config

COPY run.sh /
COPY elasticsearch_logging_discovery /

RUN useradd --no-create-home --user-group elasticsearch \
    &amp;amp;&amp;amp; mkdir /data \
    &amp;amp;&amp;amp; chown -R elasticsearch:elasticsearch /elasticsearch

VOLUME [&amp;quot;/data&amp;quot;]
EXPOSE 9200 9300

CMD [&amp;quot;/run.sh&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†æœ¬åœ°çš„&lt;code&gt;config&lt;/code&gt;ç›®å½•ä½œä¸ºé…ç½®æ–‡ä»¶æ‹·è´åˆ°äº†é•œåƒé‡Œï¼Œ&lt;code&gt;run.sh&lt;/code&gt;å¯åŠ¨è„šæœ¬ä¸­æœ‰ä¸‰è¡Œï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/elasticsearch_logging_discovery &amp;gt;&amp;gt; /elasticsearch/config/elasticsearch.yml

chown -R elasticsearch:elasticsearch /data

exec gosu elasticsearch /elasticsearch/bin/elasticsearch
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬å†è¿›å…¥åˆ°é•œåƒé‡ŒæŸ¥çœ‹ä¸‹&lt;code&gt;/elasticsearch/config/elasticsearch.yml&lt;/code&gt;æ–‡ä»¶çš„å†…å®¹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;cluster.name: kubernetes-logging

node.name: ${NODE_NAME}
node.master: ${NODE_MASTER}
node.data: ${NODE_DATA}

transport.tcp.port: ${TRANSPORT_PORT}
http.port: ${HTTP_PORT}

path.data: /data

network.host: 0.0.0.0

discovery.zen.minimum_master_nodes: ${MINIMUM_MASTER_NODES}
discovery.zen.ping.multicast.enabled: false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®°å½•å‡ ä¸ªé—®é¢˜&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Kubernetesä¸­çš„DNSæ²¡æœ‰é…ç½®ã€‚&lt;/li&gt;
&lt;li&gt;ElasticSearchçš„é…ç½®æœ‰é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;æ˜¯å¦è¦ç”¨ServiceAccountï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://tonybai.com/2017/03/03/implement-kubernetes-cluster-level-logging-with-fluentd-and-elasticsearch-stack/&#34;&gt;ä½¿ç”¨Fluentdå’ŒElasticSearch Stackå®ç°Kubernetesçš„é›†ç¾¤Logging&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://my.oschina.net/newlife111/blog/714574&#34;&gt;åœ¨Kubernetesä¸Šæ­å»ºEFKï¼ˆFluentdï¼‹Elasticsearchï¼‹Kibanaï¼‰&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.cnblogs.com/muzhiye/p/elasticsearch_set_cluster.html&#34;&gt;elasticsearch2.2 é›†ç¾¤æ­å»ºå„ç§å‘&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/es-image/elasticsearch_logging_discovery.go&#34;&gt;elasticsearch_logging_discovery.go&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&#34;&gt;fluent-plugin-kubernetes_metadata_filter&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;To be continuedâ€¦&lt;/strong&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>