<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Ebpf Â· Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="å®‹å‡€è¶…çš„åšå®¢">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/tags/ebpf/" />
  <meta property="og:title" content="Ebpf | Jimmy Song" />
  <meta property="twitter:title" content="Ebpf | Jimmy Song" />

  
  <meta property="og:description" content="å®‹å‡€è¶…çš„åšå®¢" />
  <meta property="twitter:description" content="å®‹å‡€è¶…çš„åšå®¢" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">åšå®¢</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">èµ„æ–™</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">å…¬å‘Š</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">è”ç³»</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">å…³äº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">ç¤¾åŒº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">è§†é¢‘ <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/tags/ebpf/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>æœç´¢</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">âŒ˜</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>ç«™å†…æœç´¢</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="å…³é—­"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="è¯·è¾“å…¥æœç´¢è¯" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="è¯·è¾“å…¥æœç´¢è¯">
        
        <div class="mt-4">
          <span>æœç´¢ç±»å‹: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">æ‰€æœ‰</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">åŸåˆ›</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">è¯‘æ–‡</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">èµ„æ–™</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">å…¬å‘Š</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Ebpf
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/application-traffic-with-ebpf/">[è¯‘] ç”¨ eBPF æ´å¯Ÿåº”ç”¨å±‚ç½‘ç»œæµé‡</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/01/10</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             å…¶ä»–
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thebsdbox.co.uk/2023/12/08/Application-traffic-with-eBPF/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ç”¨ eBPF æ´å¯Ÿåº”ç”¨å±‚ç½‘ç»œæµé‡', 'æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ eBPF ç¨‹åºæ•è·ã€åˆ†æå’Œä¿®æ”¹åº”ç”¨å±‚çš„ç½‘ç»œæ•°æ®ï¼ŒåŒ…æ‹¬ HTTP å¤´éƒ¨å’Œ URL è·¯å¾„ã€‚ä½œè€…è¿˜å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ eBPF map åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¼ é€’æ•°æ®ã€‚', 'åœ¨[å…ˆå‰çš„å¸–å­](..\/ebpf-adventures-in-networking\/)ä¸­ï¼Œæˆ‘ç¨å¾®è°ˆåˆ°äº†å»ºç«‹ eBPF çŸ¥è¯†ï¼Œä»¥å¼€å§‹æ›´å¤šåœ°äº†è§£ç½‘ç»œé€‚é…å™¨çš„è¾“å…¥å’Œè¾“å‡ºæƒ…å†µã€‚åŸºæœ¬ä¸Šï¼Œå°†ä»¥å¤ªç½‘å¸§å¹¶å‰¥ç¦»æ ‡å¤´ï¼ˆä»¥å¤ªç½‘æ ‡å¤´\u002bIP æ ‡å¤´\u002bTCP\/UDP æ ‡å¤´ï¼‰ï¼Œæœ€ç»ˆä½ å°†å¾—åˆ°æ¥è‡ªåº”ç”¨ç¨‹åºæˆ–æ•°æ®è§’åº¦çš„æ•°æ®åŒ…ä¸­å‰©ä½™çš„å†…å®¹ã€‚\n\næ‰€æœ‰çš„ä»£ç éƒ½åœ¨â€œå­¦ä¹  eBPFâ€å­˜å‚¨åº“ä¸­ï¼Œå…·ä½“çš„ eBPF ä»£ç åœ¨[è¿™é‡Œ](https:\/\/github.com\/thebsdbox\/learning-ebpf\/blob\/main\/ebpf\/http\/http.c)ã€‚è¿™ç¯‡æ–‡ç« çš„è®¡åˆ’æ˜¯é€æ­¥ä»‹ç»æˆ‘è®¤ä¸ºæœ‰ç”¨æˆ–å¯èƒ½é‡è¦çš„éƒ¨åˆ†...\n\n**æ³¨æ„**ï¼šæ­¤ä»£ç ç¡®å®å¯¹å…¥å£\/å‡ºå£æ•°æ®åŒ…è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œå› æ­¤éœ€è¦ 6.1\u002b çš„ Linux å†…æ ¸æ‰èƒ½ä½¿ç”¨ä¸€äº› eBPF åŠ©æ‰‹å‡½æ•°ã€‚\n\n## æ˜ å°„ï¼\n\nä½ å¯èƒ½ä»¥å‰é‡åˆ°è¿‡è¿™äº›å§ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œä¸ç”¨æ‹…å¿ƒï¼ç®€è€Œè¨€ä¹‹ï¼ŒeBPF æ˜ å°„æ˜¯åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ä¸­çš„ eBPF ç¨‹åºä¹‹é—´é€šä¿¡çš„æœºåˆ¶ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œéå¸¸é…·çš„ä¸€ç‚¹æ˜¯è¿™äº›æ˜ å°„ä½¿ç”¨é”®å’Œå€¼...æ‰€ä»¥æˆ‘ä¸å¿…å¾ªç¯æ¯”è¾ƒæ•°æ®å¹¶å¯»æ‰¾åŒ¹é…çš„å†…å®¹ï¼Œæˆ‘ä¼ é€’ä¸€ä¸ªé”®ï¼Œå¦‚æœæœ‰åŒ¹é…çš„å†…å®¹ï¼Œæˆ‘å°±å¾—åˆ°ç›¸åº”çš„æ•°æ®:D\n\nä¸‹é¢æ˜¯æˆ‘å°†è¦ä½¿ç”¨çš„æ˜ å°„ï¼Œç§°ä¸º\u0060url_map\u0060ï¼Œé”®æ˜¯ 20 ä¸ªå­—ç¬¦é•¿ï¼ˆå¯ä»¥è¯´æ˜¯æœ‰ç•Œçš„â€œå­—ç¬¦ä¸²â€ï¼‰ï¼Œåˆ†é…ç»™è¯¥é”®çš„å€¼æ˜¯æˆ‘åœ¨ä¸Šé¢å®šä¹‰çš„ç»“æ„ä½“ã€‚\n\n\u0060\u0060\u0060\n\/\/ å®šä¹‰ä¸é”®å…³è”çš„ä¸åŒURL\nstruct url_path {\n  __u8 path_len;\n  __u8 path[max_path_len]; \/\/ è¿™åº”è¯¥æ˜¯ä¸€ä¸ªcharï¼Œä½†åœ¨è¿™é‡Œå’ŒGoä¹‹é—´çš„ä»£ç ç”Ÿæˆæœ‰ç‚¹ä¸åŒ...\n};\n\n\/\/ å®šä¹‰æˆ‘çš„URLæ˜ å°„\nstruct {\n  __uint(type, BPF_MAP_TYPE_HASH);\n  __uint(max_entries, 1024);\n  __type(key, char[max_path_len]);\n  __type(value, struct url_path);\n}\nurl_map SEC(\u0022.maps\u0022);\n\u0060\u0060\u0060\n\n## eBPF ç¨‹åºï¼\n\nä»£ç ä¸­å®šä¹‰äº†ä¸¤ä¸ª eBPF ç¨‹åº\u0060tc_egress\u0060å’Œ\u0060tc_ingress\u0060ï¼Œå¦‚æœä½ èƒ½çŒœåˆ°å®ƒä»¬æ˜¯å¦‚ä½•è¿æ¥çš„ï¼Œé‚£å°±åŠ åˆ†ï¼åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åªå…³æ³¨\u0060tc_ingress\u0060ç¨‹åºã€‚\n\nå°±åƒæˆ‘ä»¬åœ¨å·²ç»å­˜åœ¨çš„ä¼—å¤šç¤ºä¾‹ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ ‡å¤´è¯†åˆ«çš„æ“ä½œã€‚\n\n1. è¿›è¡Œåˆç†æ€§æ£€æŸ¥ï¼Œå¹¶å°†\u0060data\u0060å¼ºåˆ¶è½¬æ¢ä¸º\u0060ethhdr\u0060ç±»å‹ï¼ˆ[ä»¥å¤ªç½‘æ ‡å¤´](https:\/\/en.wikipedia.org\/wiki\/Ethernet_frame)ï¼‰ã€‚\n2. é€šè¿‡è¯»å–ä»¥å¤ªç½‘æ ‡å¤´å†…éƒ¨çš„\u0060h_proto\u0060ï¼ˆä¹Ÿç§°ä¸º\u0060Ethertype\u0060ï¼‰æ¥æŸ¥æ‰¾ä»¥å¤ªç½‘å¸§å†…éƒ¨çš„åè®®ã€‚\n3. å°†ä»¥å¤ªç½‘æ ‡å¤´åçš„æ•°æ®å¼ºåˆ¶è½¬æ¢ä¸º\u0060iphdr\u0060ç±»å‹ï¼ˆ[IP æ ‡å¤´](https:\/\/en.wikipedia.org\/wiki\/Internet_Protocol_version_4#Header)ï¼‰ã€‚\n4. åœ¨ IP æ ‡å¤´å†…æŸ¥æ‰¾åè®®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¡®å®š IP æ ‡å¤´çš„å¤§å°ï¼ˆåŸæ¥å®ƒä»¬å¯ä»¥æœ‰ä¸åŒçš„å¤§å°ï¼\u0060Â¯\\_(ãƒ„)_\/Â¯\u0060ï¼‰ã€‚\n5. ä¸ºäº†ç¡®å®šæ ‡å¤´çš„å¤§å°ï¼Œæˆ‘ä»¬å°†å…¶å€¼ä¹˜ä»¥å››ï¼Œä½ å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆï¼å¥½å§ï¼Œè¿™ä¸ªå€¼ä¹˜ä»¥ 32 ä½ä»¥ç¡®å®šæ ‡å¤´çš„å¤§å°ï¼Œæ‰€ä»¥å¦‚æœå€¼ä¸º 6ï¼Œé‚£ä¹ˆæ ‡å¤´å°†æ˜¯ 192 ä½ï¼ˆæˆ– 24 å­—èŠ‚ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸ºäº†ç®€å•åœ°ç¡®å®š IP æ ‡å¤´çš„å­—èŠ‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå€¼ä¹˜ä»¥ 4ï¼\n6. å°†ä»¥ IP æ ‡å¤´åçš„æ•°æ®å¼ºåˆ¶è½¬æ¢ä¸º\u0060tcphdr\u0060ç±»å‹ï¼ˆ[TCP æ ‡å¤´](https:\/\/en.wikipedia.org\/wiki\/Transmission_Control_Protocol#TCP_segment_structure)ï¼‰ã€‚\n7. åƒæ­¥éª¤ï¼ˆ5ï¼‰ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®š TCP æ ‡å¤´çš„å¤§å°ï¼ˆå®ƒä¹Ÿå¯ä»¥æ˜¯åŠ¨æ€çš„ï¼‰ï¼Œåœ¨è¿™é‡Œçš„æ­¥éª¤ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å€¼\u0060doff\u0060ä¹˜ä»¥å››æ¥ç¡®å®šæ ‡å¤´çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚\n8. é€šè¿‡è®¡ç®—æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ¨æ–­å‡ºæ•°æ®ä½äºä»¥å¤ªç½‘æ ‡å¤´å¤§å°ã€IP æ ‡å¤´å¤§å°å’Œ TCP æ ‡å¤´å¤§å°çš„æœ«å°¾ã€‚\n9. æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä» IP æ ‡å¤´ä¸­å‡å» IP å’Œ TCP æ ‡å¤´çš„å¤§å°æ¥ç¡®å®šåº”ç”¨ç¨‹åºæ•°æ®çš„å¤§å°ï¼Œä½¿ç”¨\u0060tot_len\u0060ï¼ˆæ€»é•¿åº¦ï¼‰ã€‚\n\n### åº”ç”¨æ•°æ®ï¼ï¼\n\nä¸ºäº†è¯»å–è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸Šé¢æåˆ°çš„ä¸€äº›ä¸œè¥¿ï¼\n\né¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ•°æ®åç§»é‡ï¼ˆæ•°æ®èµ·å§‹ä½ç½®ï¼‰ï¼Œå®ƒä½äºä»¥å¤ªç½‘æ ‡å¤´\u002bIP æ ‡å¤´å¤§å°ï¼ˆä¸€æ—¦è®¡ç®—å‡ºæ¥ï¼‰å’Œ TCP æ ‡å¤´ï¼ˆå†æ¬¡ï¼Œä¸€æ—¦è®¡ç®—å‡ºæ¥ï¼‰ä¹‹åã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç¼“å†²åŒºæ¥å­˜å‚¨æˆ‘ä»¬å°†ä»å¥—æ¥å­—ç¼“å†²åŒºä¸­è¯»å–çš„æ•°æ®ã€‚\n\n\u0060\u0060\u0060c\n\/\/ ç”¨äºå­˜å‚¨æˆ‘ä»¬åº”ç”¨ç¨‹åºæ•°æ®çš„æ•°æ®ç¼“å†²åŒº\nchar pdata[60];\n\n\/\/ è®¡ç®—æ•°æ®å®é™…ä½ç½®çš„åç§»é‡\npoffset = ETH_HLEN \u002b ip_hlen \u002b tcp_hlen;\n\n\/\/ ä»å¥—æ¥å­—ç¼“å†²åŒºåŠ è½½æ•°æ®ï¼Œpoffset ä» TCP æ ‡å¤´çš„æœ«å°¾å¼€å§‹\nint ret = bpf_skb_load_bytes(skb, poffset, pdata, 60);\nif (ret != 0) {\n   return 0;\n}\n\u0060\u0060\u0060\n\næˆ‘ä»¬ä½¿ç”¨\u0060bpf_skb_load_bytes\u0060ä»å¥—æ¥å­—ç¼“å†²åŒºï¼ˆ\u0060skb\u0060ï¼‰ä¸­è¯»å–ä¸€å®šé‡çš„æ•°æ®ï¼ˆ60 ä¸ªå­—èŠ‚ï¼‰åˆ°æˆ‘ä»¬çš„ç¼“å†²åŒºï¼ˆ\u0060pdata\u0060ï¼‰ï¼Œèµ·å§‹ä½ç½®æ˜¯æˆ‘ä»¬çŸ¥é“æ•°æ®ä½äºçš„åç§»é‡ï¼ˆ\u0060poffset\u0060ï¼‰ï¼\n\næ­¤æ—¶ï¼Œæˆ‘ä»¬æœ‰äº† 60 å­—èŠ‚çš„æ•°æ®ï¼Œåº”è¯¥è¶³å¤Ÿè®©æˆ‘ä»¬ç¼–å†™ä¸€äº›ä»£ç æ¥ç†è§£å®ƒã€‚\n\n### HTTP æ•°æ® :-)\n\nè®©æˆ‘ä»¬çœ‹çœ‹å½“æˆ‘ä»¬å°è¯•è¿›è¡Œ HTTP è¯·æ±‚æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼\n\n\u0060\u0060\u0060plaintext\n ~ curl code\/test -vvv\n*   Trying 192.168.0.22:80...\n* Connected to code (192.168.0.22) port 80 (#0)\n\u003e GET \/test HTTP\/1.1\n\u003e Host: code\n\u003e User-Agent: curl\/7.87.0\n\u003e Accept: *\/*\n\n...\n\u0060\u0060\u0060\n\næˆ‘æ­£åœ¨ä½¿ç”¨\u0060curl\u0060ä»ä¸»æœº\u0060code\u0060ï¼ˆcode æ˜¯æˆ‘çš„å¼€å‘ VMï¼Œè¿è¡Œ code-serverï¼‰è¯·æ±‚ URL \u0060\/test\u0060ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®ï¼ˆæ¯è¡Œä»¥\u0060\u003e\u0060å¼€å¤´ï¼Œç”¨äºç¡®å®šé€šä¿¡çš„æ–¹å‘ï¼‰ã€‚HTTP è¯·æ±‚ä¸­çš„ç¬¬ä¸€è¡Œæ•°æ®é€šå¸¸æ˜¯ä¸€ä¸ª*åŠ¨è¯*ï¼Œåé¢æ˜¯æˆ‘ä»¬å¸Œæœ›ä¸ä¹‹äº¤äº’çš„èµ„æºï¼Œç„¶åæ˜¯ HTTP è§„èŒƒå’Œå›è½¦ç¬¦ï¼Œå¦‚[HTTP æ ‡å‡†](https:\/\/en.wikipedia.org\/wiki\/HTTP#HTTP\/1.1_request_messages)ä¸­å®šä¹‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…³å¿ƒçš„è¡Œæ˜¯\u0060GET \/test\u0060ï¼ˆåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬\/æˆ‘ä¸å¤ªå…³å¿ƒ HTTP è§„èŒƒ:Dï¼‰ã€‚\n\nç¬¬ä¸€æ­¥æ˜¯è¯»å–\u0060pdata\u0060çš„å‰ä¸‰ä¸ªå­—ç¬¦ï¼ŒæŸ¥æ‰¾\u0060pdata[0] == G\u0060ï¼Œ\u0060pdata[1] == E\u0060å’Œ\u0060pdata[2] == T\u0060ï¼Œè¿™å°†æœ‰æ•ˆåœ°å¸®åŠ©æˆ‘ä»¬ç¡®å®šé¦–å…ˆæ˜¯å¦æ˜¯ HTTP è¯·æ±‚ï¼Œç‰¹åˆ«æ˜¯æ˜¯å¦æ˜¯ HTTP è¯·æ±‚ï¼\n\nä¸€æ—¦æˆ‘ä»¬éªŒè¯äº†è¿™å‰ 3 ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å°†æƒ³è¦ä»ç¬¬ 4 ä¸ªå­—èŠ‚ï¼ˆè¯·æ±‚çš„å‰ä¸‰ä¸ªå­—èŠ‚åŠ ä¸Šä¸€ä¸ªç”¨äºåˆ†éš”çš„ç©ºæ ¼ï¼‰å¼€å§‹è¯»å–æ›´å¤šæ•°æ®ï¼\n\n\u0060\u0060\u0060c\nchar path[max_path_len];\nmemset(\u0026path, 0, sizeof(path));\n\nint path_len = 0;\n\n\/\/ æŸ¥æ‰¾è¯·æ±‚ URIï¼ˆä»åç§»é‡ 4 å¼€å§‹ï¼‰ï¼Œä»¥ç©ºæ ¼ç»“æŸ\nfor (int i = 4; i \u003c sizeof(pdata) ; i\u002b\u002b)\n{\n    if (pdata[i] != \u0027 \u0027) {\n        path[i-4] = pdata[i];\n    } else {\n        path[i-4] = \u0027\\0\u0027;\n        path_len = i-4;\n        break;\n    }\n}\n\u0060\u0060\u0060\n\nä¸Šé¢çš„å‡½æ•°å°†ä» HTTP æ•°æ®çš„ç¬¬ 4 ä¸ªå­—èŠ‚å¼€å§‹ï¼ˆä»ç¬¬ 4 ä¸ªå­—èŠ‚å¼€å§‹ï¼‰è¯»å–å…¶ä½™çš„æ•°æ®ï¼Œç›´åˆ°é‡åˆ°ç©ºæ ¼ä¸ºæ­¢ï¼Œç•™ä¸‹æˆ‘ä»¬è¦\u0060GET\u0060çš„ URLï¼æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªè°ƒè¯•æ‰“å°è¯­å¥æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š\n\n\u0060\u0060\u0060c\nbpf_printk(\u0022\u003c- incoming path [%s], length [%d]\u0022, path, path_len);\n\u0060\u0060\u0060\n\nè¿™å°†åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºå¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060plaintext\n\u003cidle\u003e-0       [001] dNs3. 2252901.017812: bpf_trace_printk: \u003c- incoming path [\/test], length [5]\n\u0060\u0060\u0060\n\n### å¯¹ HTTP åº”ç”¨ç¨‹åºè¯·æ±‚é‡‡å–è¡ŒåŠ¨\n\nä¸Šè¿°è§£é‡Šè¯¦ç»†è¯´æ˜äº†æˆ‘ä»¬å¦‚ä½•è¯»å–æ•°æ®ä»¥åŠå¦‚ä½•è¯»å–æ•°æ®ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³è¦â€œåŠ¨æ€â€æŸ¥æ‰¾ HTTP è¯·æ±‚ï¼Œæˆ‘ä»¬å°†éœ€è¦ä½¿ç”¨ eBPF æ˜ å°„ã€‚\n\nåœ¨æˆ‘ä»¬çš„ Go ç”¨æˆ·ç©ºé—´ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n\u0060\u0060\u0060go\npath := flag.String(\u0022path\u0022, \u0022\u0022, \u0022The URL Path to watch for\u0022)\nflag.Parse()\n\n\/\/ ...\n\n\/\/ åˆ›å»ºä¸€ä¸ª uint8 æ•°ç»„\nvar urlPath [20]uint8\n\/\/ å°†æˆ‘ä»¬çš„å­—èŠ‚å¤åˆ¶åˆ° uint8 æ•°ç»„ä¸­ï¼ˆæˆ‘ä»¬å¯ä»¥è¿›è¡Œç±»å‹è½¬æ¢ï¼‰\ncopy(urlPath[:], *path)\n\n\/\/ å°†æˆ‘ä»¬çš„ urlPath ä½œä¸ºé”®\nerr = objs.UrlMap.Put(urlPath,\n  bpfUrlPath{\n    Path:    urlPath,\n    PathLen: uint8(len(urlPath)),\n  })\nif err != nil {\n  panic(err)\n}\n\u0060\u0060\u0060\n\næ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œå½“æˆ‘ä»¬å¯åŠ¨ Go ç¨‹åºæ—¶ï¼Œå®ƒå°†ä»æ ‡å¿—\u0060-path\u0060ä¸­è¯»å–ï¼Œå¹¶å°†å…¶ç”¨ä½œæˆ‘ä»¬ eBPF æ˜ å°„ä¸­çš„**é”®**ï¼Œå¯ä»¥æš‚æ—¶å¿½ç•¥å€¼ã€‚\n\n\u0060\u0060\u0060c\nstruct url_path *found_path = bpf_map_lookup_elem(\u0026url_map, path);\nif (found_path \u003e 0) {\n    bpf_printk(\u0022Looks like we\u0027ve found your path [%s]\u0022, path);\n    \/\/ å¯èƒ½è¿›è¡Œæ›´å¤šæ“ä½œï¼Œé˜»æ­¢æµé‡æˆ–é‡å®šå‘ï¼Ÿ\n}\n\u0060\u0060\u0060\n\nåœ¨æˆ‘ä»¬çš„ eBPF ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†å¯¹ HTTP è¯·æ±‚è¿›è¡Œæ˜ å°„æŸ¥æ‰¾ï¼Œå¦‚æœè¯¥è¯·æ±‚ä½œä¸º char æ•°ç»„å­˜åœ¨äº**é”®**ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹å…¶è¿›è¡Œæ“ä½œï¼\n\nç°åœ¨å¯åŠ¨æˆ‘ä»¬çš„ Go ç¨‹åº \u0060sudo .\/http -interface ens160 -path \/test\u0060 å°†å¾—åˆ°ä»¥ä¸‹ç»“æœï¼š\n\n\u0060\u0060\u0060plaintext\nINFO[0000] Starting ğŸ the eBPF HTTP watcher, on interface [ens160] for path [\/test]\nINFO[0000] Loaded TC QDisc\nINFO[0000] Press Ctrl-C to exit and remove the program\n          \u003cidle\u003e-0       [001] d.s3. 2252901.015575: bpf_trace_printk: \u003c- 0.0.0.0:56345 -\u003e 0.0.0.0:80\n          \u003cidle\u003e-0       [001] D.s3\n\n. 2252901.015642: bpf_trace_printk: -\u003e 192.168.0.22:80 -\u003e 192.168.0.180:56345\n          \u003cidle\u003e-0       [001] d.s3. 2252901.017552: bpf_trace_printk: \u003c- 0.0.0.0:56345 -\u003e 0.0.0.0:80\n          \u003cidle\u003e-0       [001] d.s3. 2252901.017793: bpf_trace_printk: \u003c- 0.0.0.0:56345 -\u003e 0.0.0.0:80\n          \u003cidle\u003e-0       [001] dNs3. 2252901.017812: bpf_trace_printk: \u003c- incoming path [\/test], length [5]\n          \u003cidle\u003e-0       [001] dNs3. 2252901.017814: bpf_trace_printk: Looks like we\u0027ve found your path [\/test]\n\u0060\u0060\u0060\n\n## ç»“è®º\n\nè§£æ HTTP å¹¶ä¸å¤ªå›°éš¾ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•çš„åè®®ï¼Œå®ƒä½¿ç”¨ç®€å•çš„åŠ¨è¯å’Œç»“æ„çš„ç®€å•æ–¹æ³•ï¼Œä½¿ç”¨ç©ºæ ¼å’Œå›è½¦ç¬¦æ¥åŒºåˆ†ã€‚è¿™ç§æ–¹æ³•å¯èƒ½ä¹Ÿé€‚ç”¨äºå…¶ä»–åè®®ï¼Œå¦‚ DNSã€POP3 æˆ– SMTPã€‚å½“æ•°æ®åŠ å¯†æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§è§£å¯†çš„æ–¹æ³•ï¼Œç„¶åæ‰èƒ½è§£ææ•°æ®ï¼ˆè¿™è¶…å‡ºäº†æˆ‘çš„èƒ½åŠ›...ï¼‰ã€‚ä½†æ˜¯ï¼Œæˆ‘å¸Œæœ›è¿™ä¼šæ¿€å‘ä½ æ›´å¤šåœ°å°è¯•ä½¿ç”¨ eBPF æ¥è§£æå’Œæ“ä½œåº”ç”¨ç¨‹åºçš„æƒ³æ³•ï¼\n\næˆ‘ä¸€ç›´æƒ³å†™ä¸€äº›æœ‰å¸Œæœ›æœ‰ç”¨çš„å…³äº eBPF çš„å¸–å­ï¼Œå°½ç®¡é€šå¸¸åœ¨æˆ‘æƒ³å‡ºå¯èƒ½æœ‰ç”¨çš„ä¸œè¥¿ä¹‹åï¼Œåˆ«äººå·²ç»æŠ¢å…ˆä¸€æ­¥ã€‚é‰´äºæˆ‘å·²ç»åœ¨ä¸€æ®µæ—¶é—´é‡Œä»¥æŸç§æ–¹å¼å…³æ³¨ç½‘ç»œï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯æˆ‘å…³æ³¨çš„é¢†åŸŸï¼Œå°½ç®¡æˆ‘ç¡®å®ä¸ºæœ€è¿‘çš„ eBPF å³°ä¼š 2023 ç¼–å†™äº†ä¸€äº›æœ‰è¶£çš„å†…å®¹ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œæœ‰å¾ˆå¤šäººå¼€å§‹æ’°å†™ eBPF å†…å®¹ï¼Œæ‰€ä»¥æˆ‘å¯èƒ½ä¼šå‚è€ƒä»–ä»¬çš„å¸–å­ï¼Œè€Œä¸æ˜¯é‡å¤å†…å®¹ã€‚\n', '\/trans\/application-traffic-with-ebpf\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ eBPF ç¨‹åºæ•è·ã€åˆ†æå’Œä¿®æ”¹åº”ç”¨å±‚çš„ç½‘ç»œæ•°æ®ï¼ŒåŒ…æ‹¬ HTTP å¤´éƒ¨å’Œ URL è·¯å¾„ã€‚ä½œè€…è¿˜å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ eBPF map åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ebpf-adventures-in-networking/">[è¯‘] å¦‚ä½•ç”¨ eBPF æ”¹å˜ç½‘ç»œç¼–ç¨‹çš„æ¸¸æˆè§„åˆ™</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/01/10</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             å…¶ä»–
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thebsdbox.co.uk/2023/11/18/eBPF-adventures-in-networking/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('å¦‚ä½•ç”¨ eBPF æ”¹å˜ç½‘ç»œç¼–ç¨‹çš„æ¸¸æˆè§„åˆ™', 'è¿™ç¯‡æ–‡ç« ä»‹ç»äº† eBPF åœ¨ç½‘ç»œé¢†åŸŸçš„ä¸€äº›åº”ç”¨å’Œå®è·µï¼ŒåŒ…æ‹¬ XDPã€TC å’Œ sysprobes ä¸‰ç§ä¸åŒçš„ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ eBPF å®ç°ç½‘ç»œæ•°æ®çš„æ•è·ã€åˆ†æå’Œä¿®æ”¹ã€‚ä½œè€…è¿˜åˆ†äº«äº†ä¸€äº›æœ‰ç”¨çš„ eBPF å·¥å…·å’Œèµ„æºï¼Œä»¥åŠè‡ªå·±å¼€å‘çš„ä¸€ä¸ª eBPF ç½‘ç»œä»£ç†çš„é¡¹ç›®ã€‚', '\næˆ‘ä¸€ç›´æƒ³å†™ä¸€äº›å…³äº eBPF çš„å¸–å­ï¼Œå¸Œæœ›å®ƒä»¬èƒ½æœ‰æ‰€å¸®åŠ©ï¼Œå°½ç®¡é€šå¸¸åœ¨æˆ‘æƒ³åˆ°å¯èƒ½æœ‰ç”¨çš„ä¸œè¥¿æ—¶ï¼Œå…¶ä»–äººå·²ç»å…ˆæˆ‘ä¸€æ­¥äº†ã€‚é‰´äºæˆ‘å·²ç»åœ¨ç½‘ç»œæ–¹é¢é›†ä¸­ç²¾åŠ›ä¸€æ®µæ—¶é—´ï¼Œè¿™åŸºæœ¬ä¸Šæ˜¯æˆ‘ä¸“æ³¨çš„é¢†åŸŸï¼Œå°½ç®¡æˆ‘ç¡®å®è®¾æ³•ä¸ºæœ€è¿‘çš„ eBPF å³°ä¼š 2023 å‡†å¤‡äº†ä¸€äº›æˆ‘è®¤ä¸ºå¾ˆæœ‰è¶£çš„ä¸œè¥¿ã€‚æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œæœ‰å¾ˆå¤šäººå¼€å§‹æ’°å†™å…³äº eBPF çš„å†…å®¹ï¼Œå› æ­¤æˆ‘å¯èƒ½ä¼šå‚è€ƒä»–ä»¬çš„å¸–å­ï¼Œè€Œä¸æ˜¯é‡å¤å†…å®¹ã€‚\n\næˆ‘å°†ä»ä¸€äº›åœ¨ Linux å†…æ ¸ä¸­å¯èƒ½æˆ–å¯èƒ½ä¸ä¼šé‡åˆ°çš„é¦–å­—æ¯ç¼©å†™æˆ–æŠ€æœ¯å¼€å§‹ã€‚ä½†åŸºæœ¬ä¸Šä»æˆ‘çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº›æ˜¯ä½ ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿä»¥ä¸ç½‘ç»œæ•°æ®äº¤äº’çš„ä¸»è¦é€‰é¡¹ã€‚\n\n### XDP\n\nå…³äº eXpress Data Plane å·²ç»å­˜åœ¨å¤§é‡ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä¸ä¼šæ·±å…¥æ¢è®¨å¤ªå¤šç»†èŠ‚ã€‚\u0060tl;dr\u0060æ˜¯ XDP eBPF ç¨‹åºæŒ‚é’©åˆ° XDP å°†ä½¿å…¶èƒ½å¤Ÿè®¿é—®ç”±å†…æ ¸è‡ªèº«å¤„ç†ä¹‹å‰çš„ä¼ å…¥ç½‘ç»œå¸§ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒeBPF ç¨‹åºå°†åŠ è½½åˆ° NIC é©±åŠ¨ç¨‹åºæœ¬èº«ä¸­ï¼Œè¿™å°†æœ‰æ•ˆåœ°å°†ç¨‹åºå¸è½½åˆ° NIC æœ¬èº«ã€‚\n\n### ä¼˜ç‚¹\n\n- æœ€ä½³æ€§èƒ½\n- éå¸¸é€‚ç”¨äºé˜²ç«å¢™ã€DDoS é˜²æŠ¤æˆ–è´Ÿè½½å‡è¡¡ç­‰ç”¨ä¾‹\n- åœ¨ä»»ä½•å…¶ä»–å†…å®¹è¿›è¡Œä¿®æ”¹ä¹‹å‰çœ‹åˆ°ä¼ å…¥çš„æµé‡\n\n### ç¼ºç‚¹\n\n- ä»…æ”¯æŒå…¥ç«™æµé‡ï¼Œä½¿ç”¨ XDP ç¨‹åºçœ‹åˆ°çš„ä»»ä½•æµé‡éƒ½åªæ˜¯ä¼ å…¥æµé‡ï¼Œç›®å‰æ— æ³•çœ‹åˆ°å‡ºç«™æµé‡\n- ä½¿ç”¨\u0060XDP\u0060æ•°æ®ç»“æ„ï¼Œä¸å¤§å¤šæ•°å¥—æ¥å­—ç¼–ç¨‹çš„é»˜è®¤æ•°æ®ç»“æ„\u0060SKB\u0060æœ‰ä¸€äº›ä¸åŒã€‚\n\n### TCï¼ˆTraffic Controlï¼‰æˆ–æµé‡æ§åˆ¶\n\nTraffic Control æ˜¯å†…æ ¸ç½‘ç»œç»“æ„çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸»è¦åŒ…æ‹¬æ·»åŠ è¯¸å¦‚ qdisc å’Œè¿‡æ»¤å™¨ä¹‹ç±»çš„åŠŸèƒ½åˆ°æ¥å£çš„èƒ½åŠ›ã€‚qdisc ä¸»è¦é›†ä¸­åœ¨ä¸º TBDï¼ˆå¾…å®šï¼‰æä¾›æœåŠ¡ï¼Œè€Œè¿‡æ»¤å™¨é€šå¸¸åœ¨åº•å±‚å®é™…ä¸Šæ˜¯ä¸€ä¸ª eBPF ç¨‹åºã€‚\n\nå¸¸è§çš„å·¥ä½œæµç¨‹æ˜¯ï¼š\n\n1. åˆ›å»ºä¸€ä¸ªå…³æ³¨å…¥å£æˆ–å‡ºå£çš„ qdiscï¼Œæˆ–è€…æ›¿æ¢ä¸€ä¸ªç°æœ‰çš„ qdiscã€‚qdisc å°†é™„åŠ åˆ°æ¥å£ä¸Šã€‚\n2. åŠ è½½ä½ çš„ eBPF ç¨‹åºã€‚\n3. åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå°†å…¶é™„åŠ åˆ°é€šè¿‡æ¥å£ä¸Šçš„ qdisc ä¸Šçš„å…¥å£æˆ–å‡ºå£ä¹‹ä¸€ã€‚è¯¥è¿‡æ»¤å™¨å°†ä¸ eBPF ç¨‹åºç›¸å…³è”ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰ä¼ å…¥æˆ–ä¼ å‡ºçš„æµé‡ç°åœ¨éƒ½ä¼šé€šè¿‡ä¸€ä¸ªç¨‹åºè¿è¡Œï¼ˆå¦‚æœè¿æ¥ï¼‰ã€‚\n4. è·åˆ© ğŸ’°\n\n### ä¼˜ç‚¹\n\n- æä¾›å…¥å£å’Œå‡ºå£çš„æŒ‚é’©ç‚¹\n- ä½¿ç”¨ä¼ ç»Ÿçš„\u0060SKB\u0060æ•°æ®ç»“æ„\n\n### ç¼ºç‚¹\n\n- å°† TC ç¨‹åºé™„åŠ åˆ°å…¥å£æˆ–å‡ºå£é˜Ÿåˆ—ç¨å¾®å¤æ‚ä¸€äº›ã€‚ç”¨æˆ·éœ€è¦ä½¿ç”¨ qdisc æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼ŒæŸäº› eBPF SDK ä¸ä¼šåŸç”Ÿæ”¯æŒ TC ç¨‹åºçš„ä½¿ç”¨ã€‚\n- TC eBPF ç¨‹åºçœ‹åˆ°çš„æµé‡å¯èƒ½å·²ç»è¢«ä¹‹å‰çš„ XDP ç¨‹åºæˆ–å†…æ ¸æœ¬èº«ä¿®æ”¹ã€‚\n\n### ç³»ç»Ÿè°ƒç”¨\n\nä¸å…¶ä»–ä¸¤ç§ä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†ç½‘ç»œçš„æ–¹æ³•ç›¸æ¯”ï¼Œè¿™å¯èƒ½ä¼šæ˜¾å¾—æœ‰äº›å¥‡æ€ªï¼Œå› ä¸ºå®ƒæ˜¯å°†ä¸€äº› eBPF ä»£ç é™„åŠ åˆ°å†…æ ¸ä¸­çš„ç³»ç»Ÿè°ƒç”¨çš„ä¸€ç§æ›¿ä»£æ–¹æ³•ï¼Œå…·ä½“æ¥è¯´æ˜¯\u0060tcp4_connect()\u0060 \/ \u0060tcp6_connect()\u0060ç­‰è°ƒç”¨ã€‚è¿™åœ¨åè®®æ ˆä¸­ç•¥å¾®é åï¼Œå› ä¸ºåœ¨æ­¤æ—¶ï¼Œä¼ å…¥æ•°æ®åŒ…å·²ç»ç»è¿‡äº†å¾ˆå¤šå†…æ ¸é€»è¾‘ï¼Œè€Œ eBPF å†…çœç‚¹æ˜¯å½“æµé‡å³å°†ä¸åº”ç”¨ç¨‹åºæœ¬èº«äº¤äº’æ—¶ã€‚\n\n## ç¼–å†™ç½‘ç»œç¨‹åºï¼\n\næ‰€ä»¥åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬ï¼ˆå¸Œæœ›ï¼‰æ„è¯†åˆ°æˆ‘ä»¬æœ‰è®¸å¤šä¸åŒçš„å…¥å£ç‚¹ï¼Œå…è®¸æˆ‘ä»¬åœ¨â€œä¼ é€å¸¦â€ä¸Šæ³¨å…¥æˆ‘ä»¬çš„ä»£ç ï¼Œè¿™ä¸ªä¼ é€å¸¦ä» NIC å¼€å§‹ï¼Œä¸€ç›´åˆ°åº”ç”¨ç¨‹åºï¼ˆä»¥åŠåœ¨å‡ºç«™çš„æƒ…å†µä¸‹ï¼‰ã€‚\n\n### å›é¡¾\n\nåœ¨æˆ‘ä»¬æ‰€è°“çš„â€œä¼ é€å¸¦â€çš„å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥é™„åŠ æˆ‘ä»¬çš„ XDP ç¨‹åºå¹¶è·å¾—æœªç»è§¦ç¢°çš„åŸå§‹ç½‘ç»œæ•°æ®ã€‚åœ¨â€œä¼ é€å¸¦â€çš„ä¸­é—´ï¼Œæˆ‘ä»¬çš„ TC ç¨‹åºå°†æˆä¸ºé€šè¿‡å†…æ ¸çš„è·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶æ¥æ”¶å¯èƒ½è¢«ä¿®æ”¹çš„ç½‘ç»œæ•°æ®ã€‚åœ¨ä¼ é€å¸¦çš„æœ«ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»£ç é™„åŠ åˆ°åº”ç”¨ç¨‹åºå°†åœ¨å®ƒè¢«è¿è¡Œä¹‹å‰è·å–ç½‘ç»œæ•°æ®çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥åœ¨ä¼ é€å¸¦çš„æœ«ç«¯è¿›è¡Œé™„åŠ ã€‚\n\n### æ•°æ®è¡¨ç¤º\n\nä½ çš„ç¨‹åºé™„åŠ åˆ°çš„ä½ç½®å†³å®šäº†ä¸¤ä¸ªä¸»è¦äº‹ç‰©ï¼Œä¸€ä¸ªæ˜¯æ½œåœ¨çš„æµé‡ä¿®æ”¹çš„ç›¸å¯¹çº§åˆ«ï¼Œå¦ä¸€ä¸ªæ˜¯æµé‡çš„è¡¨ç¤ºæ–¹å¼ã€‚\n\n### XDP ç»“æ„\n\næˆ‘ä¼šå†™å…³äºå®ƒçš„å†…å®¹ï¼Œä½†æ˜¯ DataDog å·²ç»åšäº†ï¼Œä½ å¯ä»¥åœ¨[è¿™é‡Œ](https:\/\/www.datadoghq.com\/blog\/xdp-intro\/#the-flow-of-an-xdp-program)é˜…è¯»ã€‚\n\n### SKBï¼ˆå¥—æ¥å­—ç¼“å†²åŒºï¼‰\n\nSKB æ˜¯åœ¨ eBPF æ·»åŠ åˆ°å†…æ ¸ä¹‹å‰å°±å­˜åœ¨äºå†…æ ¸ä¸­çš„æ•°æ®ç±»å‹ï¼Œå®ƒå·²ç»å…·å¤‡äº†ä¸€äº›ä½¿ä¸ SKB å¯¹è±¡äº¤äº’å˜å¾—ç¨å¾®å®¹æ˜“ä¸€äº›çš„è¾…åŠ©åŠŸèƒ½ã€‚æœ‰å…³æ›´æ·±å…¥çš„ SKB ä»‹ç»ï¼Œä½ å¯ä»¥é˜…è¯»æ­¤æ–‡ -\u003e http:\/\/vger.kernel.org\/~davem\/skb_data.html\n\n### è§£ææ•°æ®\n\næ— è®ºä¸å“ªä¸ªç»“æ„è¿›è¡Œäº¤äº’ï¼Œå®ƒä»¬éƒ½å…±äº«ä¸€äº›å…±åŒä¹‹å¤„ï¼Œè¿™ä¸»è¦æ˜¯ä¸¤ä¸ªå˜é‡ï¼Œå¯¹äºè¿™ä¸¤ç§æ•°æ®ç±»å‹æ¥è¯´æ˜¯ç›¸åŒçš„ã€‚\n\nè¿™äº›å˜é‡æ˜¯ï¼š\n\n- \u0060data\u0060ï¼Œå®ƒæ˜¯ eBPF ç¨‹åºæ¥æ”¶åˆ°çš„æ•°æ®çš„æŒ‡é’ˆ\n\n- \u0060data_len\u0060ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°ï¼ŒæŒ‡å®šäº†æœ‰å¤šå°‘æ•°æ®å¯ç”¨ï¼ˆä»¥å¸®åŠ©ç¡®ä¿ä½ æ°¸è¿œä¸ä¼šè®¿é—®\u0060data\u0060è¶…è¿‡\u0060data_len\u0060ï¼ˆæ˜¾è€Œæ˜“è§çš„çœŸç† ğŸ¤“ï¼‰ï¼‰\n\næ‰€ä»¥è¿™ä¸€åˆ‡ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†ç­‰ç­‰... \u0060*data\u0060ä¸­å®é™…ä¸Šæœ‰ä»€ä¹ˆï¼Ÿï¼ˆè¿™å–å†³äºä½ çš„å‘ç°ï¼‰\n\né€šè¿‡ä¸æ–­â€œè½¬æ¢â€\u0060*data\u0060å¹¶æ²¿ç€å®ƒç§»åŠ¨ä»¥å‰¥ç¦»å„ç§æ ‡å¤´ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£å’ŒæŸ¥æ‰¾åº•å±‚æ•°æ®ï¼\n\n### è½¬æ¢ï¼Ÿ\n\nå¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥è·³è¿‡æ­¤éƒ¨åˆ†ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿï¼ˆä¸”ç³Ÿç³•ï¼‰çš„ç¤ºä¾‹ï¼Œè¯´æ˜äº†æˆ‘ä»¬é€šå¸¸å¦‚ä½•å°†ä¸€äº›åŸå§‹æ•°æ®è½¬æ¢ä¸ºæœ‰æ„ä¹‰çš„ä¸œè¥¿ã€‚ç›®å‰ï¼Œ\u0060*data\u0060å°†åªæ˜¯ä¸€ä¸²éšæœºæ•°æ®ï¼Œæ¯«æ— æ„ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦æœ‰æ•ˆåœ°ä¸ºå…¶æ·»åŠ â€œæ ¼å¼â€ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç†è§£å…¶å¤–è§‚ã€‚\n\nè€ƒè™‘ä¸€ä¸‹éšæœºæ•°æ®è¡Œï¼šâ€œBobby0004500100.503 Harvard Drive90210â€ï¼Œå…¶ä¸­ä¸€äº›å¯¹è£¸çœ¼æ¥è¯´æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æœ‰äº›æ˜¯ä¸æ¸…æ¥šçš„ã€‚\n\næƒ³è±¡ä¸€ä¸‹åä¸ºâ€œpersonâ€çš„æ•°æ®ç»“æ„ï¼š\n\n\u0060\u0060\u0060bash\nName: string\nAge: number\nBalance: float\nStreet: string\nZipCode: number\n\u0060\u0060\u0060\n\nå¦‚æœæˆ‘ä»¬è¦å°†æˆ‘ä»¬çš„éšæœºæ•°æ®â€œè½¬æ¢â€ä¸ºä¸Šé¢çš„â€œpersonâ€ç»“æ„ï¼Œå®ƒå°†çªç„¶å˜æˆï¼š\n\n\u0060\u0060\u0060bash\nName: Bobby\nAge: 45\nBalance: 100.50\nStreet: 3 Harvard Drive\nZipCode: 90210\n\u0060\u0060\u0060\n\nç°åœ¨çªç„¶é—´ï¼Œæˆ‘èƒ½å¤Ÿç†è§£å¹¶è®¿é—®ç»“æ„ä¸­çš„åº•å±‚å˜é‡ï¼Œå› ä¸ºå®ƒä»¬ç°åœ¨æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå³ person-\u003eNameï¼Œå¹¶ä¸”å‘ç°æ­¤ç‰¹å®šçš„ person ç±»å‹å¯¹è±¡å…·æœ‰åç§°å˜é‡â€œBobbyâ€ï¼\n\nè¿™æ­£æ˜¯æˆ‘ä»¬å°†å¯¹æˆ‘ä»¬çš„\u0060*data\u0060æ‰€åšçš„ï¼\n\n### æ•°æ®ä¸­åŒ…å«ä»€ä¹ˆï¼Ÿ\n\nå› æ­¤ï¼Œç¬¬ä¸€æ­¥æ˜¯ç¡®å®šæ•°æ®æ˜¯å¦ä»¥ä»¥å¤ªç½‘å¸§å¼€å¤´ï¼å‡ ä¹æ‰€æœ‰ä¼ è¾“çš„æ•°æ®éƒ½ä»¥ä»¥å¤ªç½‘å¸§å¼€å¤´ï¼Œè¿™ç›¸å½“ç®€å•ï¼Œä½†å…¶ä½œç”¨æ˜¯å…·æœ‰æºå’Œç›®æ ‡ç¡¬ä»¶åœ°å€ï¼ˆæ— è®ºè™šæ‹ŸåŒ–\/å®¹å™¨åŒ–\/æœ‰çº¿ç½‘ç»œè¿˜æ˜¯ WiFi å¦‚ä½•ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ˜¯å°†æˆ‘ä»¬çš„\u0060*data\u0060è½¬æ¢ä¸ºç±»å‹\u0060ETHHDR\u0060ï¼Œå¦‚æœæˆåŠŸï¼Œæˆ‘ä»¬ç°åœ¨å°†èƒ½å¤Ÿäº†è§£ç»„æˆä»¥å¤ªç½‘å¤´æ•°æ®ç±»å‹çš„å˜é‡ã€‚è¿™äº›åŒ…æ‹¬æºå’Œç›®æ ‡ MAC åœ°å€ï¼Œä½†æ›´é‡è¦çš„æ˜¯å‰©ä½™æ•°æ®çš„å†…å®¹æ˜¯ä»€ä¹ˆã€‚å†æ¬¡ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»¥å¤ªç½‘å¤´ä¹‹åçš„\u0060*data\u0060å†…å®¹é€šå¸¸æ˜¯ IP å¤´ï¼Œä½†æˆ‘ä»¬å°†é€šè¿‡æ£€æŸ¥ä»¥å¤ªç½‘å¸§çš„ TBD å˜é‡æ¥éªŒè¯ã€‚\n\nä¸€æ—¦æˆ‘ä»¬éªŒè¯ä¸‹ä¸€ç»„æ•°æ®æ˜¯ IP å¤´ï¼Œæˆ‘ä»¬å°†éœ€è¦å°†ä»¥å¤ªç½‘å¤´ä¹‹åçš„æ•°æ®è½¬æ¢ä¸º IPHDR ç±»å‹ã€‚ä¸€æ—¦æˆ‘ä»¬è¿™æ ·åšï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè®¿é—® IP ç‰¹å®šçš„æ•°æ®ï¼Œä¾‹å¦‚æº IPï¼ˆ\u0060saddr\u0060ï¼‰æˆ–ç›®æ ‡åœ°å€ï¼ˆ\u0060daddr\u0060ï¼‰ï¼Œå†æ¬¡é‡è¦çš„æ˜¯ IP å¤´åŒ…å«ä¸€ä¸ªå˜é‡ï¼Œè¯¦ç»†è¯´æ˜äº† IP å¤´ä¹‹åçš„æ•°æ®æ˜¯ä»€ä¹ˆã€‚è¿™é€šå¸¸æ˜¯ TCP å¤´æˆ– UDP å¤´ï¼Œä½†è¿˜æœ‰å…¶ä»–é€‰æ‹©ï¼Œä¾‹å¦‚ sctp ç­‰ã€‚\n\nä¸€æ—¦æˆ‘ä»¬æŸ¥çœ‹äº† IP å¤´çš„å†…éƒ¨å¹¶ç¡®å®šæ•°æ®ç±»å‹æ˜¯ TCPï¼ˆä¹Ÿå¯èƒ½æ˜¯ UDP æˆ–å…¶ä»–å†…å®¹ï¼‰ï¼Œæˆ‘ä»¬å°†æŠŠä»¥å¤ªç½‘å¤´å’Œ IP å¤´ä¹‹åçš„æ•°æ®éƒ½è½¬æ¢ä¸º TCP å¤´ç±»å‹ï¼ï¼ˆå‡ ä¹å®Œæˆäº†ï¼‰ã€‚é€šè¿‡è®¿é—® TCP å¤´çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾— TCP ç‰¹å®šçš„æ•°æ®ï¼Œä¾‹å¦‚æºç«¯å£æˆ–ç›®æ ‡ç«¯å£ï¼Œç”¨äºéªŒè¯æ•°æ®çš„æœ‰æ•ˆæ€§çš„æ ¡éªŒå’Œä»¥åŠå…¶ä»–æœ‰ç”¨çš„å˜é‡ã€‚\n\nç°åœ¨æˆ‘ä»¬å‡ ä¹æ‹¥æœ‰ä¸€åˆ‡ï¼Œä½†æ˜¯ TCP å¤´çš„é•¿åº¦å¯èƒ½æ˜¯å¯å˜çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡æŸ¥çœ‹ tcl_len å˜é‡æ¥ç¡®å®šè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ä¹˜ä»¥ 4ã€‚ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†è®¿é—®æœ€ç»ˆæ•°æ®æ‰€éœ€çš„ä¸€åˆ‡ï¼\n\nå› æ­¤ï¼Œ\u0060*data\u0060æŒ‡å‘æ•°æ®çš„å¼€å¤´ï¼æˆ‘ä»¬å·²ç»ç¡®å®šäº†ä»¥å¤ªç½‘å¤´ä¹‹åæ˜¯ IP å¤´ï¼Œæœ€åæ˜¯ TCP å¤´ï¼Œè¿™æ„å‘³ç€\u0060*data \u002b ä»¥å¤ªç½‘å¤´ \u002b IP å¤´ \u002b TCP å¤´ = å®é™…åº”ç”¨ç¨‹åºæ•°æ®ï¼\n\n### æˆ‘ä»¬å¯ä»¥ç”¨è¿™äº›ä¿¡æ¯åšä»€ä¹ˆï¼Ÿ\n\nå½“æˆ‘ä»¬è§£æå„ç§æ ‡å¤´æ—¶ï¼Œå®é™…ä¸Šåœ¨ OSI æ¨¡å‹çš„ä¸åŒå±‚æ¬¡ä¸Šè§£é”äº†è¶Šæ¥è¶Šå¤šçš„ä¿¡æ¯ï¼\n\n**[ç¬¬ 2 å±‚]** ä»¥å¤ªç½‘å¤´ä¸ºæˆ‘ä»¬æä¾›äº†æºå’Œç›®æ ‡ç¡¬ä»¶åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤ä¿¡æ¯æ¥æ½œåœ¨åœ°é˜»æ­¢ä»æˆ‘ä»¬çŸ¥é“å±é™©çš„æº MAC åœ°å€å¤„ç†çš„å¸§ã€‚\n\n**[ç¬¬ 3 å±‚]** IP å¤´åŒ…å«æºå’Œç›®æ ‡ IP åœ°å€ï¼Œå†æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥åƒé˜²ç«å¢™ä¸€æ ·è¿ä½œï¼Œé€šè¿‡ä½¿ç”¨ eBPF ç¨‹åºä¸¢å¼ƒç‰¹å®š IP åœ°å€çš„æ‰€æœ‰æµé‡ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® IP åœ°å€é‡å®šå‘æµé‡ï¼Œæˆ–è€…ç”šè‡³åœ¨è¿™ä¸€å±‚å®æ–½è´Ÿè½½å‡è¡¡é€»è¾‘ï¼Œä»¥å°†æµé‡é‡å®šå‘åˆ°å…¶ä»–åº•å±‚ IP åœ°å€é›†åˆã€‚\n\n**[ç¬¬ 4 å±‚]** TCP æˆ– UDP æ ‡å¤´å®šä¹‰äº†ç›®æ ‡ç«¯å£å·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥ç¡®å®šåº”ç”¨ç¨‹åºåè®®æ˜¯ä»€ä¹ˆï¼ˆå³ç«¯å£ 80 é€šå¸¸æ„å‘³ç€å‰©ä½™çš„*data å¯èƒ½æ˜¯ HTTP æ•°æ®ï¼‰ã€‚åœ¨è¿™ä¸€å±‚ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæ‰§è¡Œè´Ÿè½½å‡è¡¡ç­‰æ“ä½œï¼ŒåŸºäºç›®æ ‡ï¼ˆå³åœ¨å¤šä¸ªå…¶ä»–è´Ÿè½½å‡è¡¡å™¨åœ°å€ä¹‹é—´å¹³è¡¡ï¼‰ã€‚\n\n**[ç¬¬ 7 å±‚]** æ­£å¦‚å‰é¢æåˆ°çš„ï¼Œå„ç§æ ‡å¤´é›†åˆçš„æœ«å°¾çš„æ•°æ®æ˜¯å®é™…çš„åº”ç”¨ç¨‹åºæ•°æ®ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“æ ¼å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è§£æå®ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¤–éƒ¨ Web æµè§ˆå™¨å°è¯•è®¿é—®æˆ‘çš„è®¡ç®—æœºä¸Šçš„\u0060\/index.html\u0060å¹¶é™„åŠ äº† eBPF ç¨‹åºï¼Œæˆ‘ä¼šè§£æåˆ° TCPï¼Œç„¶åç¡®å®šå®ƒæ˜¯ç«¯å£ 80ï¼Œç„¶ååº”ç”¨ç¨‹åºæ•°æ®åº”è¯¥æ˜¯ HTTP æ ¼å¼ã€‚æˆ‘å¯ä»¥é€šè¿‡æŸ¥çœ‹åº”ç”¨ç¨‹åºæ•°æ®çš„å‰ä¸‰ä¸ªå­—ç¬¦ï¼ˆåœ¨æ‰€æœ‰æ ‡å¤´ä¹‹åï¼‰æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼Œä½¿ç”¨ä»¥ä¸‹ä¼ªä»£ç ï¼š\n\n\u0060\u0060\u0060bash\nApplicationData = EthernetHDR \u002b IPHDR \u002b TCPHDR \/\/ å°†æ‰€æœ‰æ ‡å¤´é•¿åº¦ç›¸åŠ ä»¥æ‰¾åˆ°æ•°æ®\nIf ( data[ApplicationData] = \u0022G\u0022 \u0026\u0026 data[ApplicationData\u002b1] = \u0022E\u0022 \u0026\u0026 data[ApplicationData\u002b2] = \u0022T\u0022 ) {\n\t\/\/ è¿™æ˜¯ä¸€ä¸ªHTTP GETè¯·æ±‚\n\t\/\/ åšä¸€äº›ä»¤äººå…´å¥‹çš„äº‹æƒ…\n}\n\u0060\u0060\u0060\n\n## æ€»ç»“\n\nç°åœ¨æˆ‘ä»¬â€œæœ‰ç‚¹â€ç†è§£äº†è¿™ä¸ªé€»è¾‘ï¼Œä¹Ÿè®¸æˆ‘ä»¬åº”è¯¥è€ƒè™‘å®æ–½ä¸€äº›ä»£ç æ¥å®Œæˆæ‰€æœ‰è¿™äº›...ä½†è¿™å°†æ˜¯å¦ä¸€å¤©çš„äº‹æƒ…ã€‚\n', '\/trans\/ebpf-adventures-in-networking\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">è¿™ç¯‡æ–‡ç« ä»‹ç»äº† eBPF åœ¨ç½‘ç»œé¢†åŸŸçš„ä¸€äº›åº”ç”¨å’Œå®è·µï¼ŒåŒ…æ‹¬ XDPã€TC å’Œ sysprobes ä¸‰ç§ä¸åŒçš„ eBPF ç¨‹åºæŒ‚è½½æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ eBPF å®ç°ç½‘ç»œæ•°æ®çš„æ•è·ã€åˆ†æå’Œä¿®æ”¹ã€‚ä½œè€…è¿˜åˆ†äº«äº†ä¸€äº›æœ‰ç”¨çš„ eBPF å·¥å…·å’Œèµ„æºï¼Œä»¥åŠè‡ªå·±å¼€å‘çš„ä¸€ä¸ª eBPF ç½‘ç»œä»£ç†çš„é¡¹ç›®ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">ä½¿ç”¨ Geneve éš§é“å®ç° Istio Ambient Mesh çš„æµé‡æ‹¦æˆª</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/03/24</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä½¿ç”¨ Geneve éš§é“å®ç° Istio Ambient Mesh çš„æµé‡æ‹¦æˆª', 'æœ¬æ–‡ä»‹ç»äº†ä»€ä¹ˆæ˜¯ Geneve éš§é“ï¼Œä¸ VXLAN çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒåœ¨ Istio Ambient Mesh ä¸­çš„åº”ç”¨ï¼Œæœ€åè°ˆåŠä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡æ‹¦æˆªã€‚', '\nåœ¨æˆ‘[ä¹‹å‰çš„åšå®¢](\/blog\/ambient-mesh-l4-traffic-path\/)åˆ†äº«ä¸­æåˆ° Istio Ambient Mesh ä½¿ç”¨ iptables å’Œ Geneve éš§é“å°†åº”ç”¨ç¨‹åº Pod ä¸­çš„æµé‡æ‹¦æˆªåˆ° Ztunnel ä¸­ã€‚å¾ˆå¤šè¯»è€…å¯èƒ½è¿˜ä¸äº†è§£è¿™ç§éš§é“åè®®ï¼Œæœ¬æ–‡å°†ä¸ºä½ ä»‹ç» Geneve éš§é“çš„å®šä¹‰ï¼ŒæŠ¥æ–‡ç»“æ„ï¼Œä»¥åŠä¸ VXLAN åè®®çš„æ¯”è¾ƒæœ‰å“ªäº›ä¼˜åŠ¿ã€‚æœ€åï¼Œæœ¬æ–‡å°†ä»‹ç» Istio Ambient Mesh å¦‚ä½•åº”ç”¨ Geneve éš§é“æ¥å®ç°æµé‡æ‹¦æˆªï¼Œä»¥åŠ Istio 1.18 ä¸­æ–°æ¨å‡ºçš„ eBPF æ¨¡å¼ã€‚\n\n## Geneve éš§é“ç®€ä»‹\n\nGENEVEï¼ˆGeneric Network Virtualization Encapsulationï¼‰æ˜¯ä¸€ç§ç½‘ç»œè™šæ‹ŸåŒ–å°è£…ï¼ˆéš§é“ï¼‰åè®®ï¼Œå®ƒçš„è®¾è®¡çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å½“å‰æ•°æ®ä¼ è¾“ç¼ºä¹çµæ´»æ€§å’Œå®‰å…¨æ€§çš„é—®é¢˜ã€‚Geneve åªå®šä¹‰äº†ä¸€ç§æ•°æ®å°è£…æ ¼å¼ï¼Œä¸åŒ…æ‹¬æ§åˆ¶å¹³é¢çš„ä¿¡æ¯ã€‚GENEVE ç›¸è¾ƒäº VXLAN å°è£…çš„å…³é”®ä¼˜åŠ¿åœ¨äºå…¶é€šè¿‡æ·»åŠ  TLV æ ¼å¼çš„é€‰é¡¹æ¥æ‰©å±•å¯å°è£…çš„åè®®ç±»å‹ã€‚\n\n## Geneve vs VXLAN\n\nVXLAN å’Œ Geneve éƒ½æ˜¯ç½‘ç»œè™šæ‹ŸåŒ–åè®®ï¼Œå®ƒä»¬ä¹‹é—´æœ‰å¾ˆå¤šå…±åŒç‚¹ã€‚è™šæ‹ŸåŒ–åè®®æ˜¯ä¸€ç§å°†è™šæ‹Ÿç½‘ç»œä¸ç‰©ç†ç½‘ç»œåˆ†ç¦»çš„æŠ€æœ¯ï¼Œå®ƒå…è®¸ç½‘ç»œç®¡ç†å‘˜åœ¨è™šæ‹Ÿç¯å¢ƒä¸­åˆ›å»ºå¤šä¸ªè™šæ‹Ÿç½‘ç»œï¼Œæ¯ä¸ªè™šæ‹Ÿç½‘ç»œéƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ VLAN æ ‡è¯†ç¬¦ã€IP åœ°å€å’Œè·¯ç”±ã€‚æ­¤å¤–ï¼ŒVXLAN å’Œ Geneve åè®®éƒ½ä½¿ç”¨ UDP å°è£…ï¼Œè¿™ä½¿å¾—å®ƒä»¬èƒ½å¤Ÿé€šè¿‡ç°æœ‰ç½‘ç»œåŸºç¡€è®¾æ–½è¿›è¡Œæ‰©å±•ã€‚VXLAN å’Œ Geneve åè®®è¿˜å…·æœ‰çµæ´»æ€§ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä¸åŒçš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥ä¸ä¸åŒçš„è™šæ‹ŸåŒ–å¹³å°å…¼å®¹ã€‚\n\nå›¾ 1 å±•ç¤ºäº† VXLAN ä¸ Geneve åè®®çš„æŠ¥æ–‡ç»“æ„åŠå…¶å„è‡ªçš„ Header åŒºåˆ«ã€‚\n\n![å›¾ 1ï¼šVXLAN ä¸ Geneve æŠ¥æ–‡æ ¼å¼ç¤ºæ„å›¾](vxlan-vs-geneve.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒVXLAN ä¸ Geneve éš§é“æŠ¥æ–‡çš„ç»“æ„ç±»ä¼¼ï¼Œå…¶ä¸»è¦åŒºåˆ«åœ¨äºä½¿ç”¨ä¸åŒçš„ UDP ç«¯å£å·å’Œåè®®å¤´ â€”â€”VXLAN ä½¿ç”¨ 4789 ç«¯å£ï¼ŒGeneve ä½¿ç”¨ 6081 ç«¯å£ï¼›Geneve åè®®å¤´æ¯” VXLAN æ›´å…·æ‰©å±•æ€§ã€‚\n\nGeneve éš§é“åè®®æ¯” VXLAN æ›´åŠ å¯æ‰©å±•æ˜¯å› ä¸º Geneve éš§é“åè®®ä¸­å¢åŠ äº†å˜é•¿é€‰é¡¹ï¼Œå®ƒå¯ä»¥åŒ…å«é›¶æˆ–å¤šä¸ª TLV æ ¼å¼çš„é€‰é¡¹æ•°æ®ã€‚TLV æ˜¯æŒ‡ç±»å‹ - é•¿åº¦ - å€¼ï¼ˆType-Length-Valueï¼‰æ ¼å¼ï¼Œç”¨äºä¼ è¾“å’Œè§£æç½‘ç»œåŒ…çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚åœ¨ Geneve åè®®ä¸­ï¼Œæ¯ä¸ªå…ƒæ•°æ®ä¿¡æ¯éƒ½ç”±ä¸€ä¸ª TLV æ ¼å¼çš„å­—æ®µç»„æˆï¼Œä»¥ä¾¿äºçµæ´»åœ°æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹è¿™äº›å…ƒæ•°æ®ã€‚\n\nå…·ä½“æ¥è¯´ï¼ŒTLV æ ¼å¼çš„å­—æ®µåŒ…æ‹¬ï¼š\n\n- Typeï¼š8 ä½çš„ç±»å‹å­—æ®µã€‚\n- Lengthï¼š5 ä½çš„é€‰é¡¹é•¿åº¦å­—æ®µï¼Œä»¥ 4 å­—èŠ‚å€æ•°è¡¨ç¤ºï¼Œä¸åŒ…æ‹¬é€‰é¡¹å¤´ã€‚\n- Dataï¼šå¯å˜é•¿çš„é€‰é¡¹æ•°æ®å­—æ®µï¼Œå¯ä»¥ä¸å­˜åœ¨æˆ–è€…ä¸º 4 åˆ° 128 å­—èŠ‚ä¹‹é—´ã€‚\n\né€šè¿‡ä½¿ç”¨ TLV æ ¼å¼ï¼ŒGeneve åè®®å¯ä»¥è½»æ¾åœ°æ‰©å±•å’Œä¿®æ”¹å…ƒæ•°æ®ä¿¡æ¯ï¼ŒåŒæ—¶ä¿æŒå…¼å®¹æ€§å’Œçµæ´»æ€§ã€‚\n\nå…³äº VXLAN éš§é“æŠ¥æ–‡çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) ã€‚\n\nå…³äº Geneve éš§é“æŠ¥æ–‡çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i) ã€‚\n\n### å·¥ä½œåŸç†\n\nGeneve éš§é“ä¸»è¦åº”ç”¨åœ¨äº‘è®¡ç®—å’Œè™šæ‹ŸæœºåŒ–åœºæ™¯ï¼Œå®ƒå¯ä»¥å°†æ•°æ®åŒ…å°è£…åœ¨ä¸€ä¸ªæ–°çš„æ•°æ®åŒ…ä¸­ï¼Œä»¥ä¾¿åœ¨è™šæ‹Ÿç½‘ç»œä¸­ä¼ è¾“ã€‚Geneve éš§é“ä½¿ç”¨ä¸€ä¸ª 24 ä½çš„è™šæ‹Ÿç½‘ç»œæ ‡è¯†ç¬¦ (VNI)ï¼Œå°†æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œã€‚Geneve éš§é“è¿˜å¯ä»¥ä½¿ç”¨å®‰å…¨æ€§åè®®ï¼Œå¦‚ IPsecã€TLï¼Œæ¥ä¿æŠ¤æ•°æ®åŒ…çš„ä¼ è¾“ã€‚\n\nå½“æ•°æ®åŒ…åˆ°è¾¾ç›®çš„ä¸»æœºæ—¶ï¼ŒGeneve éš§é“åè®®ä¼šå°†æ•°æ®åŒ…ä» Geneve åè®®å¤´ä¸­è§£å°è£…å‡ºæ¥ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™è™šæ‹Ÿç½‘ç»œä¸­çš„ç›®çš„åœ°ã€‚åœ¨è§£å°è£…è¿‡ç¨‹ä¸­ï¼ŒGeneve åè®®å¤´ä¸­çš„ VNI ä¿¡æ¯ä¼šè¢«æ¥åˆ¤æ–­æ•°æ®åŒ…çš„ç›®çš„åœ°ï¼Œä»¥ç¡®ä¿æ•°æ®åŒ…è¢«æ­£ç¡®åœ°è·¯ç”±åˆ°è™šæ‹Ÿç½‘ç»œä¸­çš„ç›®çš„åœ°ã€‚\n\nå‡è®¾æœ‰ä¸€ä¸ªè™šæ‹Ÿç½‘ç»œï¼Œå…¶ VNI ä¸º 1001ã€‚å½“æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨éš§é“å°†æ•°æ®åŒ…ä»ä¸€ä¸ªç‰©ç†ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ä¸ªç‰©ç†ç½‘ç»œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéš§é“å°†æºç‰©ç†ç½‘ç»œå’Œç›®æ ‡ç‰©ç†ç½‘ç»œä¹‹é—´çš„è™šæ‹Ÿç½‘ç»œæ ‡è¯†ç¬¦ (VNI) è®¾ç½®ä¸º 1001ï¼Œä»¥ä¾¿åœ¨ä¼ è¾“æœŸé—´è·Ÿè¸ªæ•°æ®åŒ…ã€‚å½“æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡ç‰©ç†ç½‘ç»œæ—¶ï¼Œéš§é“å°† VNI ä»æ•°æ®åŒ…ä¸­åˆ é™¤ï¼Œå¹¶å°†æ•°æ®åŒ…ä¼ é€’ç»™ç›®æ ‡ç‰©ç†ç½‘ç»œã€‚\n\n### å®‰å…¨æ€§\n\nGeneve éš§é“åè®®æœ¬èº«å¹¶æ²¡æœ‰æä¾›ä»»ä½•å®‰å…¨æœºåˆ¶ï¼Œå› æ­¤åœ¨ Geneve éš§é“ä¸­ä¼ è¾“çš„æ•°æ®åŒ…å¯èƒ½ä¼šå—åˆ°å¨èƒï¼Œä¾‹å¦‚æ•°æ®åŒ…è¢«ç¯¡æ”¹ã€æˆªè·ã€é‡æ”¾ç­‰ã€‚\n\nä¸ºäº†ä¿éšœ Geneve éš§é“ä¸­ä¼ è¾“çš„æ•°æ®åŒ…çš„å®‰å…¨æ€§ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å®‰å…¨åè®®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å®‰å…¨åè®®ï¼š\n\n1. IPsecï¼ˆInternet Protocol Securityï¼‰ï¼šIPsec æ˜¯ä¸€ç§ç½‘ç»œå±‚å®‰å…¨åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†ã€è®¤è¯å’Œå®Œæ•´æ€§ä¿æŠ¤ã€‚ä½¿ç”¨ IPsec å¯ä»¥æä¾›ç«¯åˆ°ç«¯çš„å®‰å…¨æ€§ã€‚\n2. TLSï¼ˆTransport Layer Securityï¼‰ï¼šTLS æ˜¯ä¸€ç§åŸºäºä¼ è¾“å±‚çš„åŠ å¯†åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚ä½¿ç”¨ TLS å¯ä»¥æä¾›ç«¯åˆ°ç«¯çš„å®‰å…¨æ€§ã€‚\n3. MACSecï¼ˆMedia Access Control Securityï¼‰ï¼šMACSec æ˜¯ä¸€ç§æ•°æ®é“¾è·¯å±‚çš„å®‰å…¨åè®®ï¼Œå¯ä»¥å¯¹ Geneve éš§é“ä¸­çš„æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚ä½¿ç”¨ MACSec å¯ä»¥æä¾›é“¾è·¯å±‚çš„å®‰å…¨æ€§ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šå®‰å…¨åè®®éƒ½éœ€è¦è¿›è¡Œç›¸åº”çš„é…ç½®å’Œéƒ¨ç½²ï¼Œä¸”å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚åœ¨é€‰æ‹©åˆé€‚çš„å®‰å…¨åè®®æ—¶ï¼Œéœ€è¦è€ƒè™‘å®‰å…¨æ€§ã€æ€§èƒ½ã€å¯ç®¡ç†æ€§ç­‰æ–¹é¢çš„å› ç´ ã€‚\n\n### ä¸ºä»€ä¹ˆé€‰æ‹© Geneveï¼Ÿ\n\nä¸‹è¡¨å¯¹æ¯”äº† VXLAN ä¸ Geneve åœ¨å¤šä¸ªæ–¹é¢çš„ç‰¹ç‚¹ã€‚\n\n| ç‰¹æ€§ | VXLAN | Geneve |\n| --- | --- | --- |\n| å¤´éƒ¨æ ¼å¼ | å›ºå®šæ ¼å¼ | å¯æ‰©å±•æ ¼å¼ |\n| å¯æ‰©å±•æ€§ | æ›´å¤šåœ°ä¸“æ³¨äº L2 æ‰©å±• | æ›´å¥½åœ°æ”¯æŒæ–°å…´ç½‘ç»œæœåŠ¡ |\n| å¯æ“ä½œæ€§ | è¾ƒéš¾ç®¡ç†å’Œæ‰©å±• | æ›´å®¹æ˜“ç®¡ç†å’Œæ‰©å±• |\n| æ€§èƒ½ | å¤´éƒ¨è¾ƒçŸ­ï¼Œæ€§èƒ½è¾ƒé«˜ | å¤´éƒ¨è¾ƒé•¿ï¼Œæ€§èƒ½ç•¥ä½ |\n\nä½¿ç”¨ Geneve åè®®çš„ä¸»è¦åŸå› æ˜¯å°†ç›®å‰ç½‘ç»œè™šæ‹ŸåŒ–å°è£…æŠ€æœ¯ï¼ˆä¾‹å¦‚ VXLANã€NVGRE å’Œ STTï¼‰ä¸­çš„ä¼˜ç‚¹åˆå¹¶åˆ°ä¸€ä¸ªåè®®ä¸­ã€‚æˆ‘ä»¬é€šè¿‡å¤šå¹´çš„ç½‘ç»œè™šæ‹ŸåŒ–å¼€å‘ç»éªŒå¾—çŸ¥ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„éœ€æ±‚æ˜¯å¯æ‰©å±•æ€§ã€‚Geneve åè®®ä½¿ç”¨å¯æ‰©å±•çš„ TLV ç»“æ„å¯¹å…ƒæ•°æ®è¿›è¡Œç¼–ç ï¼Œå› æ­¤å¯ä»¥ç‹¬ç«‹åœ°å‘å±•è½¯ä»¶å’Œç¡¬ä»¶ç«¯ç‚¹çš„åŠŸèƒ½ï¼Œä»¥æ»¡è¶³ä¸æ–­å¢é•¿çš„éœ€æ±‚ã€‚\n\n## Istio Ambient Mesh å¦‚ä½•åº”ç”¨ Geneve éš§é“\n\nåœ¨[ä¹‹å‰çš„åšå®¢](https:\/\/jimmysong.io\/blog\/ambient-mesh-l4-traffic-path\/)ä¸­ï¼Œæˆ‘è®²è§£äº† Istio Ambient Mesh å¦‚ä½•ä½¿ç”¨ Ztunnel å®ç° L4 ä»£ç†çš„ï¼Œå›¾ 2 å±•ç¤ºä½¿ç”¨ iptables å’Œ Geneve éš§é“çš„ L4 é€æ˜æµé‡åŠ«æŒè·¯å¾„ã€‚\n\n![å›¾ 2ï¼šä½¿ç”¨ iptables å’Œ Geneve éš§é“çš„ L4 é€æ˜æµé‡åŠ«æŒè·¯å¾„ç¤ºæ„å›¾](geneve-tunnel.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š\n\n- Istio CNI åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»ºÂ \u0060istioout\u0060Â ç½‘å¡å’Œ iptables è§„åˆ™ï¼Œå°†èŠ‚ç‚¹ä¸­çš„å‡ºç«™æµé‡é€æ˜åŠ«æŒåˆ°Â \u0060pistioout\u0060Â è™šæ‹Ÿç½‘å¡ï¼›\n- Istio CNI åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»º \u0060istioin\u0060 ç½‘å¡å’Œ iptables è§„åˆ™ï¼Œå°†èŠ‚ç‚¹ä¸­çš„å…¥ç«™æµé‡é€æ˜åŠ«æŒåˆ° \u0060pistioin\u0060 è™šæ‹Ÿç½‘å¡ï¼›\n- Istio CNI åœ¨ ztunnel ä¸­åˆ›å»º \u0060pistioin\u0060 å’Œ \u0060pistioout\u0060 ç½‘å¡ï¼Œç”¨äºæ¥æ”¶ Geneve éš§é“ä¸­çš„å‘æ¥çš„æ•°æ®åŒ…ï¼›\n\n\u0060pistioin\u0060 å’Œ \u0060pistioout\u0060 è¿™ä¸¤ä¸ªç½‘å¡æ˜¯ç”± ztunnel ä¸­çš„ init å®¹å™¨æˆ– Istio CNIï¼ˆè§ [\u0060CreateRulesWithinNodeProxyNS\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910) å‡½æ•°ï¼‰åˆ›å»ºçš„ï¼Œå…¶ IP åœ°å€å’Œç«¯å£ä¹Ÿæ˜¯å›ºå®šçš„ã€‚åº”ç”¨å®¹å™¨å‘å‡ºçš„æ•°æ®åŒ…éœ€è¦ç»è¿‡ \u0060istioout\u0060 ç½‘å¡å¹¶ä½¿ç”¨ Geneve éš§é“å°è£…åè½¬å‘ç»™ ztunnel å®¹å™¨ã€‚\n\n## ä½¿ç”¨ eBPF è¿›è¡Œé€æ˜æµé‡åŠ«æŒ\n\neBPFï¼ˆextended Berkeley Packet Filterï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥åœ¨ Linux å†…æ ¸ä¸­è¿è¡Œå®‰å…¨çš„ç”¨æˆ·æ€ç¨‹åºã€‚eBPF æœ€åˆæ˜¯ä¸€ç§ç”¨äºè¿‡æ»¤ç½‘ç»œæ•°æ®åŒ…çš„æŠ€æœ¯ï¼Œä½†ç°åœ¨å·²ç»æ‰©å±•åˆ°å…¶ä»–é¢†åŸŸï¼Œå¦‚è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ã€æ€§èƒ½åˆ†æå’Œå®‰å…¨ç›‘æ§ç­‰ã€‚eBPF çš„ä¼˜åŠ¿åœ¨äºå…¶è½»é‡çº§ã€é«˜æ•ˆã€å®‰å…¨å’Œå¯ç¼–ç¨‹æ€§ã€‚å®ƒå¯ä»¥è¢«ç”¨äºå®æ—¶ç›‘æ§ã€ç½‘ç»œå®‰å…¨ã€åº”ç”¨ç¨‹åºè°ƒè¯•å’Œä¼˜åŒ–ã€å®¹å™¨ç½‘ç»œç­‰å¤šä¸ªé¢†åŸŸã€‚\n\nåœ¨ Istio 1.18 ä¹‹å‰ï¼ŒAmbient æ¨¡å¼ä¸­ä½¿ç”¨ iptables å’Œ Geneve éš§é“å°†åº”ç”¨ç¨‹åºæµé‡é€æ˜åŠ«æŒåˆ° ztunnel ä¸­ã€‚åœ¨ Istio 1.18 ä¸­ï¼Œå¢åŠ äº† eBPF é€‰é¡¹ï¼Œä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨ iptables æˆ– eBPF æ¥åšæµé‡åŠ«æŒã€‚å¦‚å›¾ 3 æ‰€ç¤ºï¼ŒeBPF ç¨‹åºç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºå†…æ ¸ï¼Œå°†åº”ç”¨ç¨‹åºçš„æµé‡è½¬å‘åˆ° ztunnel ä¸­ã€‚\n\n![å›¾ 3ï¼šä½¿ç”¨ eBPF åŠ«æŒåº”ç”¨ç¨‹åºçš„æµé‡](ebpf.svg)\n\nå›¾ 3ï¼šä½¿ç”¨ eBPF åŠ«æŒåº”ç”¨ç¨‹åºçš„æµé‡\n\n| å¯¹æ¯”é¡¹ | eBPF æ–¹å¼ | ä½¿ç”¨ iptables å’Œ Geneve éš§é“ |\n| --- | --- | --- |\n| æ•ˆç‡ | æ›´é«˜ | ç•¥ä½ |\n| å…¼å®¹æ€§ | éœ€è¦è¾ƒé«˜çš„ Linux å†…æ ¸ç‰ˆæœ¬ | æ›´å¥½ |\n| å®ç°éš¾åº¦ | è¾ƒé«˜ | è¾ƒä½ |\n| æ‰©å±•æ€§ | è¾ƒå¥½ | è¾ƒå·® |\n\næ ¹æ® [Istio å®˜æ–¹åšå®¢](https:\/\/istio.io\/latest\/blog\/2023\/ambient-ebpf-redirection\/)ä»‹ç»ï¼Œä½¿ç”¨ eBPF æ–¹å¼é¿å…äº†éƒ¨åˆ† iptables è§„åˆ™å’Œéš§é“å°è£…ï¼Œç›¸æ¯”ä½¿ç”¨ iptables å’Œ Geneve éš§é“æ›´åŠ é«˜æ•ˆã€‚ç„¶è€Œï¼ŒeBPF å¯¹ Linux å†…æ ¸ç‰ˆæœ¬çš„è¦æ±‚æ›´é«˜ï¼ˆè‡³å°‘ 4.20ï¼‰ï¼Œè€Œ iptables æ–¹å¼åˆ™å…·æœ‰æ›´å¥½çš„å…¼å®¹æ€§ã€‚æ­¤å¤–ï¼ŒeBPF æ–¹å¼çš„å®ç°éš¾åº¦è¾ƒé«˜ï¼Œä½†æ‰©å±•æ€§è¾ƒå¥½ã€‚\n\nè¦æƒ³ä½¿ç”¨ eBPF æ¨¡å¼è¿è¡Œ Ambient Meshï¼Œåªéœ€è¦åœ¨å®‰è£… Istio æ—¶è®¾ç½® \u0060values.cni.ambient.redirectMode\u0060 å‚æ•°å³å¯ï¼Œå¦‚ä¸‹ï¼š\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## æ€»ç»“\n\næœ¬æ–‡ä»‹ç»äº† Geneve éš§é“åè®®çš„å·¥ä½œåŸç†ã€å®‰å…¨æ€§å’Œä¸ VXLAN çš„æ¯”è¾ƒã€‚æ­¤å¤–ï¼Œè¿˜ä»‹ç»äº† Istio Ambient Mesh å¦‚ä½•ä½¿ç”¨ Geneve éš§é“å®ç°æµé‡æ‹¦æˆªï¼Œå¹¶è®¨è®ºäº†ä½¿ç”¨ eBPF è¿›è¡Œé€æ˜æµé‡åŠ«æŒçš„ä¼˜ç¼ºç‚¹ã€‚Geneve éš§é“åè®®æ˜¯ä¸€ç§é€šç”¨çš„éš§é“åè®®ï¼Œå¯ä»¥åœ¨è™šæ‹Ÿç½‘ç»œä¸­ä¼ è¾“æ•°æ®åŒ…ï¼Œå…·æœ‰æ›´å¤šçš„ä¼˜åŠ¿ï¼Œå› æ­¤åœ¨é€‰æ‹©éš§é“åè®®æ—¶ï¼Œç”¨æˆ·å¯ä»¥è€ƒè™‘ä½¿ç”¨ Geneve éš§é“ã€‚åœ¨ Istio 1.18 ä¸­æ–°æ¨å‡ºäº† Ambient Mesh çš„çš„ eBPF æ¨¡å¼ï¼Œå¯ä»¥æä¾›ç½‘ç»œæ•ˆç‡ï¼Œä½†å¯¹ Linux å†…æ ¸ç‰ˆæœ¬æœ‰æ›´é«˜è¦æ±‚ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µé€‰ç”¨ã€‚\n\n## å‚è€ƒ\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n', '\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»‹ç»äº†ä»€ä¹ˆæ˜¯ Geneve éš§é“ï¼Œä¸ VXLAN çš„åŒºåˆ«ï¼Œä»¥åŠå®ƒåœ¨ Istio Ambient Mesh ä¸­çš„åº”ç”¨ï¼Œæœ€åè°ˆåŠä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡æ‹¦æˆªã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/beyond-istio-oss/">Beyond Istio OSS â€”â€” Istio æœåŠ¡ç½‘æ ¼çš„ç°çŠ¶ä¸æœªæ¥</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/07/23</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Beyond Istio OSS â€”â€” Istio æœåŠ¡ç½‘æ ¼çš„ç°çŠ¶ä¸æœªæ¥', 'æœ¬æ–‡ä»äº‘åŸç”Ÿå¤§èƒŒæ™¯ä¸‹é‡æ–°å®¡è§† Istioï¼Œè®²è§£ Istio è¯ç”Ÿï¼Œåœ¨äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­çš„åœ°ä½åŠå‘å±•æ–¹å‘ã€‚', '\n{{\u003ccallout note å…³äºæœ¬æ–‡\u003e}}\næœ¬æ–‡æ ¹æ®ç¬”è€…åœ¨ GIAC æ·±åœ³ 2022 å¹´å¤§ä¼šä¸Šçš„çš„æ¼”è®²[ã€ŠBeyond Istio OSS â€”â€” Istio çš„ç°çŠ¶åŠæœªæ¥ã€‹](https:\/\/giac.msup.com.cn\/2022sz\/course?id=16093)æ•´ç†è€Œæˆï¼Œæ¼”è®²å¹»ç¯ç‰‡è§ [è…¾è®¯æ–‡æ¡£](https:\/\/docs.qq.com\/pdf\/DRWxETHNDZmRsS0l5)ã€‚\n{{\u003c\/callout\u003e}}\n\næœ¬æ–‡å›é¡¾äº† Istio å¼€æºè¿‘äº”å¹´æ¥çš„å‘å±•ï¼Œå¹¶å±•æœ›äº† Istio æœåŠ¡ç½‘æ ¼çš„æœªæ¥æ–¹å‘ã€‚æœ¬æ–‡çš„ä¸»è¦è§‚ç‚¹å¦‚ä¸‹ï¼š\n\n- å› ä¸º Kubernetesã€å¾®æœåŠ¡ã€DevOps åŠäº‘åŸç”Ÿæ¶æ„çš„æµè¡Œï¼Œå¯¼è‡´æœåŠ¡ç½‘æ ¼æŠ€æœ¯çš„å…´èµ·ï¼›\n- Kubernetes å’Œå¯ç¼–ç¨‹ä»£ç†ï¼Œä¸º Istio çš„å‡ºç°æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ï¼›\n- è™½ç„¶ eBPF å¯ä»¥åŠ é€Ÿ Istio ä¸­çš„é€æ˜æµé‡åŠ«æŒï¼Œä½†æ— æ³•å–ä»£æœåŠ¡ç½‘æ ¼ä¸­çš„ sidecarï¼›\n- Istio çš„æœªæ¥åœ¨äºæ„å»ºåŸºäºæ··åˆäº‘çš„é›¶ä¿¡ä»»ç½‘ç»œï¼›\n\n## Istio è¯ç”Ÿçš„å‰å¤œ{#the-dawn-of-istio}\n\n2013 å¹´èµ·ï¼Œéšç€ç§»åŠ¨äº’è”ç½‘çš„çˆ†å‘ï¼Œä¼ä¸šå¯¹åº”ç”¨è¿­ä»£çš„æ•ˆç‡è¦æ±‚æ›´é«˜ï¼Œåº”ç”¨ç¨‹åºæ¶æ„å¼€å§‹ä»å•ä½“è½¬å‘å¾®æœåŠ¡ï¼ŒDevOps ä¹Ÿå¼€å§‹å˜å¾—æµè¡Œã€‚åŒå¹´éšç€ Docker çš„å¼€æºï¼Œè§£å†³äº†åº”ç”¨å°è£…å’Œéš”ç¦»çš„é—®é¢˜ï¼Œä½¿å¾—åº”ç”¨åœ¨ç¼–æ’ç³»ç»Ÿä¸­è°ƒåº¦å˜å¾—æ›´å®¹æ˜“ã€‚2014 å¹´ Kubernetesã€Spring Boot å¼€æºï¼ŒSpring æ¡†æ¶å¼€å‘å¾®æœåŠ¡åº”ç”¨å¼€å§‹æµè¡Œï¼Œåœ¨æ¥ä¸‹æ¥çš„å‡ å¹´é—´å¤§æ‰¹çš„ RPC ä¸­é—´ä»¶å¼€æºé¡¹ç›®å‡ºç°ï¼Œå¦‚ Google åœ¨ 2016 å¹´å‘å¸ƒ gRPC 1.0ï¼Œèš‚èšåœ¨ 2018 å¹´å¼€æº [SOFAStack](https:\/\/www.sofastack.tech\/) ç­‰ï¼Œå¾®æœåŠ¡æ¡†æ¶ç™¾èŠ±é½æ”¾ã€‚ä¸ºäº†èŠ‚çº¦æˆæœ¬ï¼Œå¢åŠ å¼€å‘æ•ˆç‡ï¼Œä½¿åº”ç”¨æ›´å…·å¼¹æ€§ï¼Œè¶Šæ¥è¶Šå¤šçš„ä¼ä¸šæ­£åœ¨è¿ç§»ä¸Šäº‘ï¼Œä½†è¿™ä¸ä»…ä»…æ˜¯å°†åº”ç”¨æ¬åˆ°äº‘ä¸Šé‚£ä¹ˆç®€å•ï¼Œä¸ºäº†æ›´é«˜æ•ˆåœ°åˆ©ç”¨äº‘è®¡ç®—ï¼Œä¸€å¥—ã€Œäº‘åŸç”Ÿã€æ–¹æ³•å’Œç†å¿µä¹Ÿå‘¼ä¹‹æ¬²å‡ºã€‚\n\n## Istio å¼€æºæ—¶é—´çº¿{#istio-open-time-line}\n\nIstio å¼€æºå‘å±•æ—¶é—´çº¿å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![Istio å¼€æºå‘å±•æ—¶é—´çº¿ç¤ºæ„å›¾](istio-history.svg)\n\nä¸‹é¢æˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸‹ Istio å¼€æºå¤§äº‹ä»¶ï¼š\n\n- 2016 å¹´ 9 æœˆï¼šå› ä¸º Envoy æ˜¯ Istio ä¸­çš„é‡è¦ç»„æˆï¼ŒIstio çš„å¼€æºæ—¶é—´çº¿åº”è¯¥æœ‰ Envoy ä¸€éƒ¨åˆ†ã€‚èµ·åˆ Envoy åœ¨ Lyft å†…éƒ¨ä»…ä½œä¸ºè¾¹ç¼˜ä»£ç†ï¼Œå¼€æºå‰å·²åœ¨ Lyft å†…éƒ¨å¾—åˆ°å¤§è§„æ¨¡ç”Ÿäº§éªŒè¯å¹¶å—åˆ°äº† Google å·¥ç¨‹å¸ˆçš„æ³¨æ„ [^1]ï¼Œé‚£æ—¶å€™ Google æ­£æ‰“ç®—æ¨å‡ºä¸€ä¸ªæœåŠ¡ç½‘æ ¼çš„å¼€æºé¡¹ç›®ã€‚2017 å¹´ï¼ŒLyft å°† Envoy æçŒ®ç»™äº† [CNCF](https:\/\/cncf.io)ã€‚\n- 2017 å¹´ 5 æœˆï¼šIstio ç”± Googleã€IBM å’Œ Lyft è”åˆå®£å¸ƒå¼€æº [^2]ã€‚ä¸€å¼€å§‹å°±ä½¿ç”¨äº†å¾®æœåŠ¡æ¶æ„ï¼Œç¡®å®šäº†æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢çš„ç»„æˆä»¥åŠ Sidecar æ¨¡å¼ã€‚\n- 2018 å¹´ 3 æœˆï¼šKubernetes é¡ºåˆ©çš„æˆä¸ºä» CNCF ä¸­ç¬¬ä¸€ä¸ªæ¯•ä¸šçš„é¡¹ç›®ï¼Œå˜å¾—è¶Šæ¥è¶Šã€Œæ— èŠã€ï¼ŒåŸºç¡€ API å·²ç»å®šå‹ï¼ŒCNCF æ­£å¼å°†æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰å†™å…¥åˆ°äº†äº‘åŸç”Ÿçš„ç¬¬äºŒç‰ˆå®šä¹‰ [^3] ä¸­ã€‚ç¬”è€…å½“å‰å°±èŒçš„å…¬å¸ [Tetrate](https:\/\/tetrate.io)ï¼Œä¹Ÿæ˜¯åœ¨é‚£æ—¶ç”± Google Istio åˆåˆ›å›¢é˜Ÿåˆ›ä¸šæˆç«‹çš„ã€‚æœåŠ¡ç½‘æ ¼åœ¨ä¸­å›½å¼€å§‹çˆ†å‘ï¼ŒServiceMesher ç¤¾åŒºä¹Ÿåœ¨èš‚èšé›†å›¢çš„æ”¯æŒä¸‹æˆç«‹ï¼Œåœ¨ä¸­å›½å¸ƒé“æœåŠ¡ç½‘æ ¼æŠ€æœ¯ã€‚\n- 2018 å¹´ 7 æœˆï¼šIstio 1.0 å‘å¸ƒï¼Œå·ç§°ã€Œç”Ÿäº§å¯ç”¨ã€ï¼ŒIstio å›¢é˜Ÿé‡ç»„ã€‚\n- 2020 å¹´ 3 æœˆï¼šIstio 1.5 å‘å¸ƒï¼Œæ¶æ„å›å½’å•ä½“ï¼Œå‘å¸ƒå‘¨æœŸç¡®å®šï¼Œæ¯ä¸‰ä¸ªæœˆå‘å¸ƒä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼ŒAPI è¶‹äºç¨³å®šã€‚\n- 2020 å¹´è‡³ä»Šï¼šIstio çš„å‘å±•ä¸»è¦ç€é‡äº Day 2 Operation [^4]ã€æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•æ€§å‘é¢ï¼Œå¤šä¸ªå›´ç»• Istio ç”Ÿæ€çš„å¼€æºé¡¹ç›®å¼€å§‹å‡ºç°ï¼Œä¾‹å¦‚ [Slime](https:\/\/github.com\/slime-io\/slime\/)ã€[Areaki](https:\/\/github.com\/aeraki-mesh\/aeraki)ã€[Merbridge](https:\/\/github.com\/merbridge\/merbridge)ã€‚\n\n## ä¸ºä»€ä¹ˆ Istio ä¼šåœ¨ Kubernetes ä¹‹åå‡ºç°ï¼Ÿ{#why-istio-born-after-kubernetes}\n\nå¾®æœåŠ¡å’Œå®¹å™¨åŒ–ä¹‹åï¼Œå¼‚æ„è¯­è¨€ä½¿ç”¨çš„å¢åŠ ï¼ŒæœåŠ¡çš„æ•°é‡æ¿€å¢ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå˜çŸ­æ˜¯å¯¼è‡´æœåŠ¡ç½‘æ ¼å‡ºç°çš„æ ¹æœ¬åŸå› ã€‚\n\næˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æœåŠ¡ä»éƒ¨ç½²åœ¨ Kubernetes åˆ° Istio ä¸­æ¶æ„çš„å˜è¿ï¼Œç„¶åå†æ¢è®¨æ¶æ„æ¼”è¿›è¿‡ç¨‹ä¸­ Istio çš„éœ€æ±‚ï¼Œä¸‹æ–‡å‡å®šè¯»è€…å·²äº†è§£ [Kubernetes](\/book\/kubernetes-handbook\/architecture\/) å’Œ [Istio çš„æ¶æ„](https:\/\/istio.io\/latest\/zh\/docs\/ops\/deployment\/architecture\/)ã€‚\n\n![Kubernetes åˆ° Istio çš„æ¶æ„æ”¹å˜ç¤ºæ„å›¾](kubernetes-to-istio.svg)\n\nä» Kubernetes åˆ° Istioï¼Œæ¦‚æ‹¬çš„è®²åº”ç”¨çš„éƒ¨ç½²æ¶æ„æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š\n\n- Kubernetes ç®¡ç†åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ï¼ˆæ‰©ç¼©å®¹ã€è‡ªåŠ¨æ¢å¤ã€å‘å¸ƒç­–ç•¥ï¼‰ï¼›\n- åŸºäº Kubernetes çš„è‡ªåŠ¨ sidecar æ³¨å…¥ï¼Œå®ç°äº†é€æ˜æµé‡æ‹¦æˆªã€‚å…ˆé€šè¿‡ sidecar ä»£ç†æ‹¦æˆªåˆ°å¾®æœåŠ¡é—´æµé‡ï¼Œå†é€šè¿‡æ§åˆ¶å¹³é¢é…ç½®ç®¡ç†å¾®æœåŠ¡çš„è¡Œä¸ºã€‚å¦‚ä»ŠæœåŠ¡ç½‘æ ¼çš„éƒ¨ç½²æ¨¡å¼ä¹Ÿè¿æ¥äº†æ–°çš„æŒ‘æˆ˜ï¼Œsidecar å·²ç»ä¸æ˜¯ Istio æœåŠ¡ç½‘æ ¼æ‰€å¿…é¡»çš„ï¼ŒåŸºäº gRPC çš„æ— ä»£ç†çš„æœåŠ¡ç½‘æ ¼ [^5] ä¹Ÿåœ¨æµ‹è¯•ä¸­ã€‚\n\n- æœåŠ¡ç½‘æ ¼å°†æµé‡ç®¡ç†ä» Kubernetes ä¸­è§£è€¦ï¼ŒæœåŠ¡ç½‘æ ¼å†…éƒ¨çš„æµé‡æ— é¡» \u0060kube-proxy\u0060 ç»„ä»¶çš„æ”¯æŒï¼Œé€šè¿‡ç±»ä¼¼äºå¾®æœåŠ¡åº”ç”¨å±‚çš„æŠ½è±¡ï¼Œç®¡ç†æœåŠ¡é—´çš„æµé‡ï¼Œå®ç°å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§åŠŸèƒ½ã€‚\n- æ§åˆ¶å¹³é¢é€šè¿‡ xDS åè®®å‘æ”¾ä»£ç†é…ç½®ç»™æ•°æ®å¹³é¢ï¼Œå·²å®ç° xDS çš„ä»£ç†æœ‰ [Envoy](https:\/\/envoyproxy.io) å’Œèš‚èšå¼€æºçš„ [MOSN](https:\/\/mosn.io)ã€‚\n\n- Kubernetes é›†ç¾¤å¤–éƒ¨çš„å®¢æˆ·ç«¯è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡æ—¶ï¼ŒåŸå…ˆæ˜¯é€šè¿‡ Kubernetes [Ingress](\/book\/kubernetes-handbook\/service-discovery\/ingress\/)ï¼Œåœ¨æœ‰äº† Istio ä¹‹åï¼Œä¼šé€šè¿‡ Gateway æ¥è®¿é—® [^6]ã€‚\n\n\u003e *Kubernetes å®¹å™¨ç¼–æ’ä¸å¯ç¼–ç¨‹ä»£ç† Envoy ä¸º Istio çš„å‡ºç°æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚*\n\nä»ä¸Šé¢ Kubernetes åˆ° Istio çš„æ¶æ„çš„è½¬å˜çš„æè¿°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸ºäº†è®©å¼€å‘è€…æœ€å°æˆæœ¬åœ°ç®¡ç†æœåŠ¡é—´çš„æµé‡ï¼ŒIstio éœ€è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼š\n\n1. **é€æ˜åŠ«æŒåº”ç”¨é—´çš„æµé‡**ï¼šIstio å¼€æºæœ€åˆçš„ç›®æ ‡æ˜¯æˆä¸ºç½‘ç»œåŸºç¡€è®¾æ–½ï¼Œå°±åƒæ°´å’Œç”µäººç±»çš„åŸºç¡€è®¾æ–½ä¸€æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨æ°´ç”µä¸éœ€è¦å…³å¿ƒå¦‚ä½•å–æ°´å’Œå‘ç”µï¼Œåªéœ€è¦æ‰“å¼€æ°´é¾™å¤´ï¼ŒæŒ‰ä¸‹å¼€å…³å³å¯ã€‚é€æ˜æµé‡åŠ«æŒå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œå°±åƒä½¿ç”¨æ°´å’Œç”µï¼Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºå°±å¯ä»¥å¿«é€Ÿä½¿ç”¨ Istio å¸¦æ¥çš„æµé‡ç®¡ç†èƒ½åŠ›ï¼›\n1. **ä»£ç†é›†ç¾¤çš„è¿ç»´**ï¼šå¦‚ä½•ä¸ºæ¯ä¸ªåº”ç”¨æ³¨å…¥ä¸€ä¸ªä»£ç†ï¼ŒåŒæ—¶é«˜æ•ˆåœ°ç®¡ç†è¿™äº›åˆ†å¸ƒå¼çš„ sidecar ä»£ç†ï¼›\n1. **å¯ç¼–ç¨‹ä»£ç†**ï¼šä»£ç†å¯ä»¥é€šè¿‡ API åŠ¨æ€é…ç½®ï¼Œè¿˜è¦æœ‰å‡ºè‰²çš„æ€§èƒ½ä¸å¯æ‰©å±•æ€§ï¼›\n\nä»¥ä¸Šä¸‰ä¸ªæ¡ä»¶å¯¹äº Istio æœåŠ¡ç½‘æ ¼æ¥è¯´ç¼ºä¸€ä¸å¯ï¼Œè€Œä¸”ï¼Œä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›è¦æ±‚åŸºæœ¬éƒ½æ˜¯å¯¹äº sidecar ä»£ç†çš„è¦æ±‚ï¼Œè¿™ä¸ªä»£ç†çš„é€‰æ‹©å°†ç›´æ¥å½±å“è¯¥é¡¹ç›®çš„èµ°å‘ä¸æˆè´¥ã€‚ä¸ºäº†è§£å†³ä»¥ä¸Šä¸‰ä¸ªé—®é¢˜ï¼ŒIstio é€‰æ‹©äº† Kubernetes å®¹å™¨ç¼–æ’å’Œå¯ç¼–ç¨‹ä»£ç† Envoyã€‚\n\n### é€æ˜æµé‡åŠ«æŒ{#traffic-intercept}\n\nå¦‚æœä½ ä½¿ç”¨çš„æ˜¯å¦‚ gRPC è¿™ç±»ä¸­é—´ä»¶å¼€å‘å¾®æœåŠ¡ï¼Œåœ¨ç¨‹åºä¸­é›†æˆ SDK åï¼ŒSDK ä¸­çš„æ‹¦æˆªå™¨ä¼šè‡ªåŠ¨ä¸ºä½ æ‹¦æˆªæµé‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![gRPC çš„æ‹¦æˆªå™¨ç¤ºæ„å›¾](grpc.svg)\n\nå¦‚ä½•è®© Kubernetes  pod ä¸­çš„æµé‡éƒ½é€šè¿‡ä»£ç†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åº pod ä¸­æ³¨å…¥ä¸€ä¸ªä»£ç†ï¼Œä¸åº”ç”¨å…±äº«ç½‘ç»œç©ºé—´ï¼Œå†é€šè¿‡ä¿®æ”¹ pod å†…çš„æµé‡è·¯å¾„ï¼Œè®©æ‰€æœ‰è¿›å‡º pod çš„æµé‡éƒ½ç»è¿‡ sidecarï¼Œå…¶æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![Istio ä¸­çš„é€æ˜æµé‡åŠ«æŒç¤ºæ„å›¾](istio-route-iptables.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€å¥—éå¸¸å¤æ‚çš„ iptables æµé‡åŠ«æŒé€»è¾‘ï¼ˆè¯¦è§ [Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£](\/blog\/sidecar-injection-iptables-and-traffic-routing\/)ï¼‰ï¼Œä½¿ç”¨ iptables çš„å¥½å¤„æ˜¯é€‚ç”¨äºä»»ä½• Linux æ“ä½œç³»ç»Ÿã€‚ä½†æ˜¯è¿™ä¹Ÿå¸¦æ¥äº†ä¸€äº›å‰¯ä½œç”¨ï¼š\n\n1. Istio ç½‘æ ¼ä¸­æ‰€æœ‰çš„æœåŠ¡éƒ½éœ€è¦åœ¨è¿›å‡º pod æ—¶éƒ½å¢åŠ äº†ä¸€ä¸ªç½‘ç»œè·³è·ƒç‚¹ï¼ˆhopï¼‰ï¼Œè™½ç„¶æ¯æ¬¡ hop å¯èƒ½åªæœ‰ä¸¤ä¸‰æ¯«ç§’ï¼Œä½†æ˜¯éšç€ç½‘æ ¼ä¸­æœåŠ¡å’ŒæœåŠ¡é—´çš„ä¾èµ–å¢åŠ ï¼Œè¿™ç§å»¶è¿Ÿå¯èƒ½ä¼šæ˜¾è‘—å¢åŠ ï¼Œå¯¹äºé‚£ç§è¿½æ±‚ä½å»¶è¿Ÿçš„æœåŠ¡å¯èƒ½å°±ä¸é€‚ç”¨äºæœåŠ¡ç½‘æ ¼äº†ï¼›\n2. å› ä¸º Istio å‘æ•°æ®å¹³é¢ä¸­æ³¨å…¥äº†å¤§é‡çš„ sidecarï¼Œå°¤å…¶æ˜¯å½“æœåŠ¡æ•°é‡å¢å¤§æ—¶ï¼Œæ§åˆ¶å¹³é¢éœ€è¦ä¸‹å‘æ›´å¤šçš„ Envoy ä»£ç†é…ç½®åˆ°æ•°æ®å¹³é¢ï¼Œè¿™æ ·ä¼šä½¿æ•°æ®å¹³é¢å ç”¨å¤§é‡çš„ç³»ç»Ÿå†…å­˜å’Œç½‘ç»œèµ„æºï¼›\n\né’ˆå¯¹è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä¼˜åŒ–æœåŠ¡ç½‘æ ¼å‘¢ï¼Ÿ\n\n1. ä½¿ç”¨ proxyless æ¨¡å¼ï¼šå–æ¶ˆ sidecar ä»£ç†ï¼Œé‡æ–°å›åˆ° SDKï¼›\n2. ä¼˜åŒ–æ•°æ®å¹³é¢ï¼šå‡å°‘ä¸‹å‘åˆ°æ•°æ®å¹³é¢çš„é…ç½®çš„é¢‘ç‡å’Œå¤§å°ï¼›\n3. eBPFï¼šä½¿ç”¨ eBPF ä¼˜åŒ–ç½‘ç»œåŠ«æŒï¼›\n\næœ¬æ–‡å°†åœ¨åé¢[æ€§èƒ½ä¼˜åŒ–](#performance-optimizing)ä¸€èŠ‚è®²è§£è¿™äº›ç»†èŠ‚ã€‚\n\n### Sidecar è¿ç»´ç®¡ç†{#sidecar-management}\n\nIstio æ˜¯åœ¨ Kubernetes çš„åŸºç¡€ä¸Šæ„å»ºçš„ï¼Œå®ƒå¯ä»¥åˆ©ç”¨ Kubernetes çš„å®¹å™¨ç¼–æ’å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œåœ¨ Kubernetes åˆ›å»º pod æ—¶ï¼Œé€šè¿‡å‡†å…¥æ§åˆ¶å™¨è‡ªåŠ¨å‘ pod ä¸­æ³¨å…¥ sidecarã€‚\n\nä¸ºäº†è§£å†³ Sidecar çš„èµ„æºæ¶ˆè€—é—®é¢˜ï¼Œæœ‰äººä¸ºæœåŠ¡ç½‘æ ¼æå‡ºäº†æœ‰å››ç§éƒ¨ç½²æ¨¡å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![æœåŠ¡ç½‘æ ¼çš„å››ç§éƒ¨ç½²æ¨¡å¼ç¤ºæ„å›¾](deployment-model.svg)\n\nä¸‹è¡¨ä¸­è¯¦ç»†å¯¹æ¯”äº†è¿™å››ç§éƒ¨ç½²æ–¹å¼ï¼Œå®ƒä»¬å„æœ‰ä¼˜åŠ£ï¼Œå…·ä½“é€‰æ‹©å“ªç§æ ¹æ®å®é™…æƒ…å†µè€Œå®šã€‚\n\n{{\u003ctable \u0022æœåŠ¡ç½‘æ ¼çš„å››ç§éƒ¨ç½²æ¨¡å¼å¯¹æ¯”\u0022\u003e}}\n| **æ¨¡å¼**                           | **å†…å­˜å¼€é”€**                                                 | **å®‰å…¨æ€§**                                                   | **æ•…éšœåŸŸ**                                                   | **è¿ç»´**                                                  |\n| :--------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :-------------------------------------------------------- |\n| **Sidecar ä»£ç†**                   | å› ä¸ºä¸ºæ¯ä¸ª pod éƒ½æ³¨å…¥ä¸€ä¸ªä»£ç†ï¼Œæ‰€ä»¥å¼€é”€æœ€å¤§ã€‚                | ç”±äº sidecar å¿…é¡»ä¸å·¥ä½œè´Ÿè½½ä¸€èµ·éƒ¨ç½²ï¼Œå·¥ä½œè´Ÿè½½æœ‰å¯èƒ½ç»•è¿‡ sidecarã€‚ | Pod çº§åˆ«éš”ç¦»ï¼Œå¦‚æœæœ‰ä»£ç†å‡ºç°æ•…éšœï¼Œåªå½±å“åˆ° Pod ä¸­çš„å·¥ä½œè´Ÿè½½ã€‚ | å¯ä»¥å•ç‹¬å‡çº§æŸä¸ªå·¥ä½œè´Ÿè½½çš„ sidecar è€Œä¸å½±å“å…¶ä»–å·¥ä½œè´Ÿè½½ã€‚ |\n| **èŠ‚ç‚¹å…±äº«ä»£ç†**                   | æ¯ä¸ªèŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªä»£ç†ï¼Œä¸ºè¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å·¥ä½œè´Ÿè½½æ‰€å…±äº«ï¼Œå¼€é”€å°ã€‚ | å¯¹åŠ å¯†å†…å®¹å’Œç§é’¥çš„ç®¡ç†å­˜åœ¨å®‰å…¨éšæ‚£ã€‚                         | èŠ‚ç‚¹çº§åˆ«éš”ç¦»ï¼Œå¦‚æœå…±äº«ä»£ç†å‡çº§æ—¶å‡ºç°ç‰ˆæœ¬å†²çªã€é…ç½®å†²çªæˆ–æ‰©å±•ä¸å…¼å®¹ç­‰é—®é¢˜ï¼Œåˆ™å¯èƒ½ä¼šå½±å“è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚ | ä¸éœ€è¦è€ƒè™‘æ³¨å…¥ Sidecar çš„é—®é¢˜ã€‚                           |\n| **Service Account \/ èŠ‚ç‚¹å…±äº«ä»£ç†** | æœåŠ¡è´¦æˆ· \/ èº«ä»½ä¸‹çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½éƒ½ä½¿ç”¨å…±äº«ä»£ç†ï¼Œå¼€é”€å°ã€‚      | å·¥ä½œè´Ÿè½½å’Œä»£ç†ä¹‹é—´çš„è¿æ¥çš„è®¤è¯åŠå®‰å…¨æ€§æ— æ³•ä¿éšœã€‚             | èŠ‚ç‚¹å’ŒæœåŠ¡è´¦å·ä¹‹é—´çº§åˆ«éš”ç¦»ï¼Œæ•…éšœåŒâ€œèŠ‚ç‚¹å…±äº«ä»£ç†â€ã€‚          | åŒâ€œèŠ‚ç‚¹å…±äº«ä»£ç†â€ã€‚                                       |\n| **å¸¦æœ‰å¾®ä»£ç†çš„å…±äº«è¿œç¨‹ä»£ç†**       | å› ä¸ºä¸ºæ¯ä¸ª pod éƒ½æ³¨å…¥ä¸€ä¸ªå¾®ä»£ç†ï¼Œå¼€é”€æ¯”è¾ƒå¤§ã€‚                | å¾®ä»£ç†ä¸“é—¨å¤„ç† mTLSï¼Œä¸è´Ÿè´£ L7 è·¯ç”±ï¼Œå¯ä»¥ä¿éšœå®‰å…¨æ€§ã€‚        | å½“éœ€è¦åº”ç”¨ 7 å±‚ç­–ç•¥æ—¶ï¼Œå·¥ä½œè´Ÿè½½å®ä¾‹çš„æµé‡ä¼šè¢«é‡å®šå‘åˆ° L7 ä»£ç†ä¸Šï¼Œè‹¥ä¸éœ€è¦ï¼Œåˆ™å¯ä»¥ç›´æ¥ç»•è¿‡ã€‚è¯¥ L7 ä»£ç†å¯ä»¥é‡‡ç”¨å…±äº«èŠ‚ç‚¹ä»£ç†ã€æ¯ä¸ªæœåŠ¡è´¦æˆ·ä»£ç†ï¼Œæˆ–è€…è¿œç¨‹ä»£ç†çš„æ–¹å¼è¿è¡Œã€‚ | åŒâ€œSidecar ä»£ç†â€ã€‚                                       |\n\n{{\u003c\/table\u003e}}\n\n### å¯ç¼–ç¨‹ä»£ç†{#programmable-proxy}\n\nFlomesh çš„å¼ æ™“è¾‰æ›¾åœ¨ [ä¸ºä»€ä¹ˆéœ€è¦å¯ç¼–ç¨‹ä»£ç†](https:\/\/cloudnative.to\/blog\/what-and-why-programmable-proxy\/) åšå®¢ä¸­è¯¦ç»†è¯´æ˜äº†ä»£ç†è½¯ä»¶çš„å‘å±•æ¼”åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä¸‹é¢å°†å¼•ç”¨ä»–çš„ä¸€äº›è§‚ç‚¹ï¼Œè¯´æ˜å¯ç¼–ç¨‹ä»£ç† Envoy åœ¨ Istio ä¸­çš„å…³é”®ä½œç”¨ã€‚\n\nä¸‹å›¾å±•ç¤ºäº†ä»£ç†ä»é…ç½®åˆ°å¯ç¼–ç¨‹æ¨¡å¼çš„æ¼”åŒ–è¿‡ç¨‹ï¼ŒåŠæ¯ä¸ªé˜¶æ®µä¸­çš„ä»£è¡¨æ€§ä»£ç†è½¯ä»¶ã€‚\n\n![ä»£ç†è½¯ä»¶çš„æ¼”åŒ–ç¤ºæ„å›¾](proxy-evolution.svg)\n\næ•´ä¸ªä»£ç†æ¼”åŒ–è¿‡ç¨‹éƒ½æ˜¯éšç€åº”ç”¨ä»æœ¬åœ°å’Œå•ä½“ï¼Œè¶Šæ¥è¶Šèµ°å‘å¤§è§„æ¨¡å’Œåˆ†å¸ƒå¼ã€‚ä¸‹é¢æˆ‘å°†ç®€è¦æ¦‚æ‹¬ä»£ç†è½¯ä»¶çš„å‘å±•è¿‡ç¨‹ï¼š\n\n- **é…ç½®æ–‡ä»¶æ—¶ä»£**ï¼šå‡ ä¹æ‰€æœ‰è½¯ä»¶éƒ½æœ‰é…ç½®æ–‡ä»¶ï¼Œä»£ç†è½¯ä»¶å› ä¸ºå…¶ç›¸å¯¹å¤æ‚çš„åŠŸèƒ½ï¼Œæ›´ç¦»ä¸å¼€é…ç½®æ–‡ä»¶ã€‚è¯¥é˜¶æ®µçš„ä»£ç†ä¸»è¦ä½¿ç”¨ C è¯­è¨€å¼€å‘ï¼ŒåŒ…æ‹¬å…¶æ‰©å±•æ¨¡å—ï¼Œçªå‡ºçš„ä»£ç†æœ¬èº«çš„èƒ½åŠ›ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä½¿ç”¨ä»£ç†æœ€åŸå§‹æœ€åŸºç¡€çš„å½¢å¼ï¼Œè¿™äº›ä»£ç†åŒ…æ‹¬ Nginxã€Apache HTTP Serverã€[Squid](http:\/\/www.squid-cache.org\/) ç­‰ï¼›\n- **é…ç½®è¯­è¨€æ—¶ä»£**ï¼šè¿™ä¸ªæ—¶ä»£çš„ä»£ç†ï¼Œæ›´å…·æ‰©å±•æ€§å’Œçµæ´»æ€§ï¼Œæ¯”å¦‚åŠ¨æ€æ•°æ®è·å–å’Œé…å¥—çš„é€»è¾‘åˆ¤æ–­ã€‚ä»£è¡¨æ€§ä»£ç†åŒ…æ‹¬æ‰© [Varnish](https:\/\/varnish-cache.org\/) å’Œ HAProxyï¼›\n- **è„šæœ¬è¯­è¨€æ—¶ä»£**ï¼šä»è„šæœ¬è¯­è¨€çš„å¼•å…¥å¼€å§‹ï¼Œä»£ç†è½¯ä»¶æ‰çœŸæ­£èµ°å‘çš„å¯ç¼–ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨è„šæœ¬åœ¨ä»£ç†ä¸­å¢åŠ åŠ¨æ€é€»è¾‘ï¼Œå¢åŠ äº†å¼€å‘æ•ˆç‡ã€‚ä»£è¡¨æ€§çš„ä»£ç†æ˜¯ Nginx åŠå…¶æ”¯æŒçš„è„šæœ¬è¯­è¨€ï¼›\n- **é›†ç¾¤æ—¶ä»£**ï¼šéšç€äº‘è®¡ç®—çš„æ™®åŠï¼Œå¤§è§„æ¨¡éƒ¨ç½²å’ŒåŠ¨æ€é…ç½® API æˆäº†ä»£ç†æ‰€å¿…éœ€çš„èƒ½åŠ›ï¼Œè€Œä¸”éšç€ç½‘ç»œæµé‡çš„å¢åŠ ï¼Œå¤§è§„æ¨¡ä»£ç†é›†ç¾¤ä¹Ÿåº”è¿è€Œç”Ÿã€‚è¿™ä¸ªæ—¶ä»£çš„ä»£è¡¨æ€§ä»£ç†æœ‰ Envoyã€Kong ç­‰ï¼›\n- **äº‘åŸç”Ÿæ—¶ä»£**ï¼šå¤šç§Ÿæˆ·ã€å¼¹æ€§ã€å¼‚æ„æ··åˆäº‘ã€å¤šé›†ç¾¤ã€å®‰å…¨å’Œå¯è§‚æµ‹ï¼Œè¿™äº›éƒ½æ˜¯äº‘åŸç”Ÿæ—¶ä»£å¯¹ä»£ç†æ‰€æå‡ºçš„æ›´é«˜è¦æ±‚ï¼Œä»£è¡¨æ€§è½¯ä»¶æœ‰ Istioã€Linkerdã€[Pypi](https:\/\/flomesh.io\/)ï¼Œå®ƒä»¬éƒ½ä¸ºä»£ç†æ„å»ºäº†æ§åˆ¶å¹³é¢ã€‚\n\n## è¿™äº›éƒ½æ˜¯æœåŠ¡ç½‘æ ¼å—ï¼Ÿ{#are-they-service-mesh}\n\nç°åœ¨æˆ‘å°†åˆ—ä¸¾ä¸€äº›æµè¡Œçš„æœåŠ¡ç½‘æ ¼å¼€æºé¡¹ç›®ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢æœåŠ¡ç½‘æ ¼çš„å‘å±•è§„å¾‹å’Œæœ¬è´¨ã€‚ä¸‹è¡¨å¯¹æ¯”äº†å½“å‰æµè¡Œçš„æœåŠ¡ç½‘æ ¼å¼€æºé¡¹ç›® [^7]ã€‚\n\n{{\u003ctable æœåŠ¡ç½‘æ ¼å¼€æºé¡¹ç›®å¯¹æ¯”è¡¨\u003e}}\n\n| å¯¹æ¯”é¡¹     | Istio                                                    | Linkerd                                                     | Consul Connect                                               | Traefik Mesh                                                 | Kuma                                | Open Service Mesh (OSM)             |\n| :--------- | :------------------------------------------------------- | :---------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :---------------------------------- | ----------------------------------- |\n| å½“å‰ç‰ˆæœ¬   | 1.14                                                     | 2.11                                                        | 1.12                                                         | 1.4                                                          | 1.5                                 | 1.0                                 |\n| è®¸å¯è¯     | Apache License 2.0                                       | Apache License 2.0                                          | Mozilla License                                              | Apache License 2.0                                           | Apache License 2.0                  | Apache License 2.0                  |\n| å‘èµ·è€…     | Googleã€IBMã€Lyft                                        | Buoyant                                                     | HashiCorp                                                    | Traefik Labs                                                 | Kong                                | Microsoft                           |\n| æœåŠ¡ä»£ç†   | Envoyï¼Œæ”¯æŒ gRPC çš„ proxyless æ¨¡å¼                       | [Linkerd2-proxy](https:\/\/github.com\/linkerd\/linkerd2-proxy) | é»˜è®¤ä¸º [Envoy](https:\/\/www.envoyproxy.io\/)ï¼Œå¯æ›¿æ¢           | [Traefik Proxy](https:\/\/traefik.io\/traefik\/)                 | [Envoy](https:\/\/www.envoyproxy.io\/) | [Envoy](https:\/\/www.envoyproxy.io\/) |\n| å…¥å£æ§åˆ¶å™¨ | Envoyï¼Œè‡ªå®šä¹‰çš„ Ingressï¼Œæ”¯æŒ Kubernetes  Gateway API    | æ— å†…ç½®                                                      | Envoyï¼Œæ”¯æŒ Kubernetes Gateway API                           | æ— å†…ç½®                                                       | Kong                                | æ”¯æŒ Contourã€Nginxï¼Œå…¼å®¹å…¶ä»–       |\n| æ²»ç†       | Istio Community å’Œ Open Usage Commonsï¼Œå·²æè®®æçŒ®ç»™ CNCF | CNCF                                                        | æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](https:\/\/github.com\/hashicorp\/consul\/blob\/master\/.github\/CONTRIBUTING.md) | æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](https:\/\/github.com\/traefik\/mesh\/blob\/master\/CONTRIBUTING.md) | CNCF                                | CNCF                                |\n\n{{\u003c \/table \u003e}}\n\nä¸Šè¡¨ä¸­åˆ—å‡ºçš„éƒ½æ˜¯æœåŠ¡ç½‘æ ¼ï¼Œä¸‹é¢å†ç®€å•è¯„è®ºä¸€ä¸‹è¿™äº›é¡¹ç›®ï¼š\n\n- [Istio](https:\/\/istio.io)ï¼šç›®å‰æœ€æµè¡Œçš„æœåŠ¡ç½‘æ ¼é¡¹ç›®ä¹‹ä¸€ï¼Œåœ¨ä¸­å›½å‡ ä¹æˆä¸ºäº†æœåŠ¡ç½‘æ ¼çš„ä»£åè¯ï¼›\n- [Linkerd](https:\/\/linkerd.io)ï¼šæœ€æ—©å‡ºç°çš„æœåŠ¡ç½‘æ ¼ï¼Œã€ŒService Meshã€æ¦‚å¿µæå‡ºè€…ï¼Œç¬¬ä¸€ä¸ªè¿›å…¥ CNCF çš„æœåŠ¡ç½‘æ ¼é¡¹ç›®ï¼Œä½¿ç”¨è‡ªç ”çš„ Rust è¯­è¨€ç¼–å†™è½»é‡çº§ sidecar ä»£ç†ï¼›\n- [Traefik Mesh](https:\/\/traefik.io\/traefik-mesh\/)ï¼šç”± Traefik æ¨å‡ºçš„æœåŠ¡ç½‘æ ¼é¡¹ç›®ï¼Œä½¿ç”¨ Treafik proxy ä½œä¸º sidecarï¼Œæ”¯æŒ SMIï¼ˆæ¥ä¸‹æ¥ä¼šæåˆ°ï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å¯¹åº”ç”¨çš„æ— ä¾µå…¥æ€§ï¼Œä¸ä¼šåœ¨ pod ä¸­æ³¨å…¥ sidecarï¼›\n- [Kuma](https:\/\/kuma.io\/)ï¼šç”± Kong æ¨å‡ºçš„æœåŠ¡ç½‘æ ¼é¡¹ç›®ï¼Œä½¿ç”¨ Envoy ä½œä¸º Sidecar ä»£ç†ï¼Œç‰¹è‰²æ˜¯ä½¿ç”¨ Kong è‡ªå®¶çš„ç½‘å…³ä½œä¸ºå…¥å£ç½‘å…³ï¼›\n- [Consul Connect](https:\/\/www.consul.io\/docs\/connect)ï¼šConsul æœåŠ¡ç½‘æ ¼ï¼Œä½¿ç”¨ Envoy ä½œä¸º sidecar ä»£ç†ï¼›\n- [Open Service Mesh](https:\/\/openservicemesh.io\/)ï¼šç”±å¾®è½¯å¼€æºçš„æœåŠ¡ç½‘æ ¼ï¼Œä½¿ç”¨ Envoy ä½œä¸º sidecarï¼Œå…¼å®¹ SMIï¼ˆåŒæ ·æ˜¯å¾®è½¯æå‡ºï¼‰ï¼›\n\nå¦å¤–è¿˜æœ‰å‡ ä¸ªé¡¹ç›®ï¼Œä¹ŸæœåŠ¡ç½‘æ ¼é¢†åŸŸä¹Ÿç»å¸¸è¢«æåŠï¼Œä½†å®ƒä»¬éƒ½ä¸æ˜¯æœåŠ¡ç½‘æ ¼ï¼š\n\n- [Envoy](https:\/\/envoyproxy.io)ï¼šEnvoy æœ¬èº«åªæ˜¯ä»£ç†ï¼Œä¹Ÿç»å¸¸è¢«ä½œä¸ºå…¶ä»–åŸºäº Envoy çš„æœåŠ¡ç½‘æ ¼çš„ sidecarï¼Œä¹Ÿç»å¸¸è¢«ç”¨æ¥æ„å»º API Gatewayï¼›\n- [Service Mesh Performanceï¼ˆSMPï¼‰](https:\/\/smp-spec.io\/)ï¼šæ ‡å‡†åŒ–äº†æœåŠ¡ç½‘æ ¼å€¼çš„æŒ‡æ ‡ï¼Œé€šè¿‡æ•è·åŸºç¡€è®¾æ–½å®¹é‡ã€æœåŠ¡ç½‘æ ¼é…ç½®å’Œå·¥ä½œè´Ÿè½½å…ƒæ•°æ®çš„ç»†èŠ‚æ¥æè¿°ä»»ä½•éƒ¨ç½²çš„æ€§èƒ½ï¼›\n- [Service Mesh Interfaceï¼ˆSMIï¼‰](https:\/\/smi-spec.io\/)ï¼šå®ƒä¸æ˜¯æœåŠ¡ç½‘æ ¼ï¼Œè€Œåªæ˜¯ä¸€å¥—æœåŠ¡ç½‘æ ¼å®ç°æ ‡å‡†ï¼Œä¸ OAMã€SPIFFEã€CNIã€CSI ç­‰ç±»ä¼¼éƒ½æ˜¯å®šä¹‰æ¥å£æ ‡å‡†ï¼Œå…·ä½“å®ç°å°±ä¸ä¸€è€Œè¶³äº†ã€‚ç›®å‰ Traefik Mesh å’Œ Open Service Mesh å£°æ˜æ”¯æŒè¯¥è§„èŒƒï¼›\n- [Network Service Mesh](https:\/\/networkservicemesh.io\/)ï¼šæœ‰å¿…è¦æä¸€ä¸‹è¿™ä¸ªé¡¹ç›®ï¼Œå› ä¸ºç»å¸¸æœ‰äººæŠŠå®ƒé”™è®¤ä¸ºæ˜¯ä¸€ä¸ªæœåŠ¡ç½‘æ ¼ã€‚å®é™…ä¸Šï¼Œå®ƒé¢å‘çš„æ˜¯ä¸‰å±‚ç½‘ç»œï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ä¸æ›´æ¢ CNI æ’ä»¶çš„å‰æä¸‹ï¼Œè¿æ¥å¤šäº‘\/æ··åˆäº‘ã€‚å®ƒå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€å®šä¹‰çš„ã€ŒæœåŠ¡ç½‘æ ¼ã€ï¼Œè€Œæ˜¯æœåŠ¡ç½‘æ ¼çš„ä¸€ä¸ªæœ‰åŠ›è¡¥å……ï¼ˆè™½ç„¶åå­—é‡Œå¸¦æœ‰æœåŠ¡ç½‘æ ¼æ¯”è¾ƒæœ‰è¿·æƒ‘æ€§ï¼‰ã€‚\n\nçºµè§‚ä»¥ä¸Šé¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¤§éƒ¨åˆ†æœåŠ¡ç½‘æ ¼é¡¹ç›®çš„å‘èµ·è€…éƒ½æ˜¯æ ¹æ®ä»£ç†èµ·å®¶ï¼Œç„¶ååšæ§åˆ¶å¹³é¢ã€‚è€Œä¸” Istioã€Consul Connectã€Open Service Meshã€Kuma éƒ½æ˜¯ä½¿ç”¨ Envoy ä½œä¸º sidecar ä»£ç†ã€‚åªæœ‰ Linkerd å’Œ Traefik Mesh æ¨å‡ºäº†è‡ªå·±çš„ä»£ç†ã€‚è€Œæ‰€æœ‰çš„æœåŠ¡ç½‘æ ¼é¡¹ç›®éƒ½æ”¯æŒ sidecar æ¨¡å¼ã€‚é™¤äº† Istioã€Linkerdã€Consul Connect å·²åº”ç”¨äºç”Ÿäº§ä¸Šï¼Œå…¶ä»–æœåŠ¡ç½‘æ ¼é¡¹ç›®è¿˜æ²¡æœ‰çœ‹åˆ°è¢«å¤§è§„æ¨¡åœ¨ç”Ÿäº§ä¸Šä½¿ç”¨ã€‚\n\n## Istio çš„æ€§èƒ½ä¼˜åŒ–{#performance-optimizing}\n\nåœ¨ Istio 1.5 ç‰ˆæœ¬ç¡®å®šäº†ç¨³å®šçš„æ¶æ„ä¹‹åï¼Œç¤¾åŒºçš„ä¸»è¦ç²¾åŠ›åœ¨äºä¼˜åŒ– Istio çš„æ€§èƒ½ã€‚ä¸‹é¢æˆ‘å°†å‘ä½ è¯¦ç»†ä»‹ç» Istio ä¸­çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š\n\n- é‡‡ç”¨ Proxyless æ¨¡å¼ï¼›\n- ä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡åŠ«æŒï¼›\n- æ§åˆ¶å¹³é¢æ€§èƒ½ä¼˜åŒ–ï¼›\n- æ•°æ®å¹³é¢æ€§èƒ½ä¼˜åŒ–ï¼›\n\n### Proxyless æ¨¡å¼{#proxyless-pattern}\n\nProxyless æ¨¡å¼æ˜¯ Istio åœ¨ 1.11 ç‰ˆæœ¬ä¸­æå‡ºçš„å®éªŒç‰¹æ€§ â€”â€” [åŸºäº gRPC å’Œ Istio çš„æ—  sidecar ä»£ç†çš„æœåŠ¡ç½‘æ ¼](https:\/\/cloudnative.to\/blog\/grpc-proxyless-service-mesh\/)ã€‚ä½¿ç”¨è¯¥æ¨¡å¼å¯ä»¥ç›´æ¥å°† gRPC æœåŠ¡æ·»åŠ åˆ° Istio ä¸­ï¼Œè€Œä¸éœ€è¦å†å‘ Pod ä¸­æ³¨å…¥ Envoy ä»£ç†ã€‚ä¸‹å›¾å±•ç¤ºäº† sidecar æ¨¡å¼ä¸ proxyless æ¨¡å¼çš„å¯¹æ¯”å›¾ã€‚\n\n![Sidecar æ¨¡å¼ vs Proxyless æ¨¡å¼](sidecar-to-proxyless.svg)\n\nä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ proxyless æ¨¡å¼ä¸ä½¿ç”¨ proxy è¿›è¡Œæ•°æ®å¹³é¢é€šä¿¡ï¼Œä½†ä»ç„¶éœ€è¦ä¸€ä¸ª agentï¼ˆå³ \u0060pilot-agent\u0060ï¼‰æ¥è¿›è¡Œåˆå§‹åŒ–å’Œä¸æ§åˆ¶å¹³é¢çš„é€šä¿¡ã€‚é¦–å…ˆï¼Œagent åœ¨å¯åŠ¨æ—¶ç”Ÿæˆä¸€ä¸ª[å¼•å¯¼æ–‡ä»¶](https:\/\/github.com\/grpc\/proposal\/blob\/master\/A27-xds-global-load-balancing.md#xdsclient-and-bootstrap-file)ï¼Œä¸ä¸º Envoy ç”Ÿæˆå¼•å¯¼æ–‡ä»¶çš„æ–¹å¼ç›¸åŒã€‚è¿™å‘Šè¯‰ gRPC åº“å¦‚ä½•è¿æ¥åˆ° \u0060istiod\u0060ï¼Œåœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ç”¨äºæ•°æ®å¹³é¢é€šä¿¡çš„è¯ä¹¦ï¼Œå‘æ§åˆ¶å¹³é¢å‘é€ä»€ä¹ˆå…ƒæ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œagent ä½œä¸º xDS proxyï¼Œä»£è¡¨åº”ç”¨ç¨‹åºä¸ \u0060istiod\u0060 è¿›è¡Œè¿æ¥å’Œè®¤è¯ã€‚æœ€åï¼Œagent è·å–å¹¶è½®æ¢æ•°æ®å¹³é¢é€šä¿¡ä¸­ä½¿ç”¨çš„è¯ä¹¦ï¼Œè¿™å…¶å®ä¸ Sidecar æ¨¡å¼çš„æµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å°† Envoy ä»£ç†çš„åŠŸèƒ½å†…ç½®åˆ° SDK ä¸­äº†ã€‚\n\n\u003e *æœåŠ¡ç½‘æ ¼çš„æœ¬è´¨ä¸æ˜¯ Sidecar æ¨¡å¼ï¼Œä¹Ÿä¸æ˜¯é…ç½®ä¸­å¿ƒæˆ–é€æ˜æµé‡æ‹¦æˆªï¼Œè€Œæ˜¯æ ‡å‡†åŒ–çš„æœåŠ¡é—´é€šä¿¡æ ‡å‡†ã€‚*\n\næœ‰äººè¯´ proxyless æ¨¡å¼åˆå›åˆ°äº†åŸºäº SDK å¼€å‘å¾®æœåŠ¡çš„è€è·¯ï¼ŒæœåŠ¡ç½‘æ ¼çš„ä¼˜åŠ¿ä¸§å¤±æ®†å°½ï¼Œé‚£è¿˜èƒ½å«åšæœåŠ¡ç½‘æ ¼å— [^9]ï¼Ÿå…¶å®è¿™ä¹Ÿæ˜¯ä¸€ç§å¯¹æ€§èƒ½çš„å¦¥å â€”â€” å¦‚æœä½ ä¸»è¦ä½¿ç”¨ gRPC æ¥å¼€å‘å¾®æœåŠ¡çš„è¯ï¼Œåªéœ€è¦ç»´æŠ¤ä¸åŒè¯­è¨€çš„ gRPC ç‰ˆæœ¬ï¼Œå³å¯ä»¥é€šè¿‡æ§åˆ¶å¹³é¢æ¥ç®¡ç†å¾®æœåŠ¡äº†ã€‚\n\n\u003e *Envoy xDS å·²ç»æˆä¸ºæœåŠ¡ç½‘æ ¼ä¸­æœåŠ¡é—´é€šä¿¡çš„äº‹å®æ ‡å‡†ã€‚*\n\n### ä½¿ç”¨ eBPF ä¼˜åŒ–æµé‡åŠ«æŒ{#ebpf}\n\nåœ¨[é€æ˜æµé‡åŠ«æŒ](#traffic-intercept)ä¸€èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæœåŠ¡é—´çš„æµé‡åœ¨åˆ°è¾¾ç›®çš„åœ° pod æ—¶ç»è¿‡çš„ iptables è§„åˆ™å’Œè·¯å¾„ï¼Œå…¶ä¸­éœ€è¦ç»è¿‡å¤šæ¡ iptables è§„åˆ™ï¼Œå¦‚ \u0060PREROUTING\u0060ã€\u0060ISTIO_INBOUND\u0060ã€\u0060ISTIO_IN_REDIRECT\u0060ã€\u0060OUTPUT\u0060ã€\u0060ISTIO_OUTPUT\u0060ã€\u0060POSTROUTING\u0060 ç­‰ã€‚å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªæœåŠ¡ A æƒ³è¦è°ƒç”¨éæœ¬åœ°ä¸»æœºä¸Šçš„å¦ä¸€ä¸ª pod ä¸­çš„æœåŠ¡ Bï¼Œç»è¿‡çš„ç½‘ç»œå †æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![éåŒä¸»æœº Pod é—´çš„æœåŠ¡è®¿é—®è·¯å¾„ï¼ˆiptables æ¨¡å¼ï¼‰](iptables-process.svg)\n\nä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸­ç»è¿‡å››æ¬¡ iptablesï¼Œå…¶ä¸­ Pod A ä¸­çš„ä» Envoy çš„å‡ºç«™ï¼ˆiptables2ï¼‰å’Œ Pod B ä¸­çš„ä» eth0 çš„å…¥ç«™ï¼ˆiptables3ï¼‰çš„ iptables è·¯ç”±æ˜¯æ— æ³•é¿å…çš„ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„ä¸¤ä¸ª iptables1 å’Œ iptables4 æ˜¯å¦å¯ä»¥ä¼˜åŒ–å‘¢ï¼Ÿè®©ä¸¤ä¸ª socket ç›´æ¥é€šä¿¡ï¼Œä¸å°±å¯ä»¥ç¼©çŸ­ç½‘ç»œè·¯å¾„äº†å—ï¼Ÿè¿™å°±éœ€è¦é€šè¿‡ eBPF ç¼–ç¨‹ï¼Œä½¿å¾—ï¼š\n\n- Service A çš„æµé‡ä»ç›´æ¥å‘é€åˆ° Envoy çš„ Inbound socket ä¸Šï¼›\n- Pod B ä¸­ Envoy æ¥æ”¶åˆ°å…¥ç«™æµé‡åï¼Œå·²ç»ç¡®å®šæµé‡æ˜¯è¦å‘é€ç»™æœ¬åœ°çš„æœåŠ¡ï¼Œç›´æ¥å¯¹æ¥ Outbound socket ä¸ Service Bï¼›\n\nä½¿ç”¨ eBPF æ¨¡å¼çš„é€æ˜æµé‡æ‹¦æˆªç½‘ç»œè·¯å¾„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![éåŒä¸»æœº Pod é—´çš„æœåŠ¡è®¿é—®è·¯å¾„ï¼ˆeBPF æ¨¡å¼ï¼‰](ebpf-diff-node.svg)\n\nå¦‚æœè¦è®¿é—®çš„æœåŠ¡ A å’ŒæœåŠ¡ B åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆç½‘ç»œè·¯å¾„å°†æ›´çŸ­ã€‚\n\n![åŒä¸»æœº Pod é—´çš„ç½‘ç»œè®¿é—®è·¯å¾„ï¼ˆeBPF æ¨¡å¼ï¼‰](ebpf-same-node.svg)\n\nåŒä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„æœåŠ¡é—´è®¿é—®å®Œå…¨ç»•è¿‡äº† TCP\/IP å †æ ˆï¼Œå˜æˆäº† socket é—´çš„ç›´æ¥è®¿é—®ã€‚\n\n{{\u003ccallout note \u0022ä»€ä¹ˆæ˜¯ eBPFï¼Ÿ\u0022\u003e}}\n\næˆ‘ä»¬çŸ¥é“ä¿®æ”¹ Linux å†…æ ¸ä»£ç å¾ˆéš¾ï¼Œæ–°ç‰¹æ€§å‘å¸ƒåˆ°å†…æ ¸ä¸­éœ€è¦å¾ˆé•¿çš„å‘¨æœŸã€‚eBPF æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå…è®¸ç”¨æˆ·åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸å†…åŠ è½½å’Œè¿è¡Œè‡ªå®šä¹‰ç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰äº† eBPFï¼Œä½ ä¸éœ€è¦ç›´æ¥ä¿®æ”¹å†…æ ¸ï¼Œå°±å¯ä»¥æ‰©å±•å’Œæ”¹å˜å†…æ ¸çš„è¡Œä¸ºã€‚ä¸‹é¢æˆ‘å°†ç®€è¦çš„ä¸ºå¤§å®¶ä»‹ç»ä¸€ä¸‹ eBPFï¼š\n\n- eBPF ç¨‹åºåŠ è½½åˆ°å†…æ ¸ä¸­åéœ€è¦é€šè¿‡éªŒè¯å™¨çš„éªŒè¯æ‰å¯ä»¥è¿è¡Œï¼ŒéªŒè¯å™¨å¯ä»¥é˜²æ­¢ eBPF ç¨‹åºè¶…è¶Šæƒé™çš„è®¿é—®ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å†…æ ¸çš„å®‰å…¨ï¼›\n- eBPF ç¨‹åºæ˜¯é™„ç€äºå†…æ ¸äº‹ä»¶ä¸Šçš„ï¼Œå½“æœ‰è¿›å…¥æˆ–é€€å‡ºå†…æ ¸å‡½æ•°æ—¶è¢«è§¦å‘ï¼›\n- å†…æ ¸ç©ºé—´çš„ eBPF ç¨‹åºå¿…é¡»ä½¿ç”¨èƒ½å¤Ÿæ”¯æŒç”Ÿæˆ eBPF å­—èŠ‚ç æ ¼å¼çš„ç¼–è¯‘å™¨çš„è¯­è¨€ç¼–å†™ï¼Œç›®å‰ä½ å¯ä»¥ç”¨ C å’Œ Rust è¯­è¨€ç¼–å†™ eBPF ç¨‹åºï¼›\n- eBPF ç¨‹åºå¯¹äºä¸åŒçš„ Linux ç‰ˆæœ¬å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼›\n\nç”±äº eBPF ç¨‹åºå¯ä»¥ç›´æ¥ç›‘å¬å’Œæ“ä½œ Linux å†…æ ¸ï¼Œå…·æœ‰å¯¹ç³»ç»Ÿæœ€åº•å±‚çš„é€è§†ï¼Œå°±å¯ä»¥åœ¨æµé‡ç®¡ç†ã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨å‘æŒ¥ä½œç”¨ã€‚æœ‰å…³ eBPF çš„è¯¦ç»†ä»‹ç»è¯·å‚è€ƒç¬”è€…ç¿»è¯‘çš„[ã€Šä»€ä¹ˆæ˜¯ eBPFã€‹](https:\/\/jimmysong.io\/book\/what-is-ebpf\/)ç”µå­ä¹¦ã€‚\n\n{{\u003c\/callout\u003e}}\n\nå¼€æºé¡¹ç›® [Merbridge](https:\/\/github.com\/merbridge\/merbridge) æ­£æ˜¯åˆ©ç”¨ eBPF ç¼©çŸ­äº†é€æ˜æµé‡åŠ«æŒçš„è·¯å¾„ï¼Œä¼˜åŒ–äº†æœåŠ¡ç½‘æ ¼çš„æ€§èƒ½ã€‚å…³äº Merbridge å®ç°çš„ä¸€äº›ç»†èŠ‚ï¼Œè¯·å‚è€ƒ [Istio åšå®¢](https:\/\/istio.io\/latest\/zh\/blog\/2022\/merbridge\/)ã€‚\n\n{{\u003ccallout warning æ³¨æ„\u003e}}\n\nMerbridge ä½¿ç”¨çš„ eBPF å‡½æ•°éœ€è¦ Linux å†…æ ¸ç‰ˆæœ¬ â‰¥ 5.7ã€‚\n\n{{\u003c\/callout\u003e}}\n\nä¹çœ‹ä¸Šå» eBPF ä¼¼ä¹ä»æ›´åº•å±‚å®ç°äº† Istio çš„åŠŸèƒ½ï¼Œæ›´å¤§æœ‰å–ä»£ sidecar çš„è¶‹åŠ¿ã€‚ä½†æ˜¯ eBPF ä¹Ÿå­˜åœ¨å¾ˆå¤šå±€é™æ€§ï¼Œå¯¼è‡´åœ¨å¯ä»¥é¢„è§çš„æœªæ¥æ— æ³•å–ä»£æœåŠ¡ç½‘æ ¼å’Œ Sidecarã€‚å¦‚æœå–æ¶ˆ sidecar è½¬è€Œä½¿ç”¨æ¯ä¸ªä¸»æœºä¸€ä¸ªä»£ç†çš„æ¨¡å¼ï¼Œä¼šå¯¼è‡´ï¼š\n\n1. ä»£ç†å¤±è´¥çš„çˆ†ç‚¸åŠå¾„æ‰©å¤§åˆ°æ•´ä¸ªèŠ‚ç‚¹ï¼Œå³ä¸€ä¸ªä»£ç†å¤±è´¥äº†ï¼Œä»£ç†æ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å·¥ä½œè´Ÿè½½éƒ½ä¼šå—åˆ°å½±å“ï¼›\n2. ä½¿å¾—å®‰å…¨é—®é¢˜æ›´åŠ å¤æ‚ï¼Œå› ä¸ºä¸€ä¸ªèŠ‚ç‚¹ä¸Šä¿å­˜åœ¨å¤ªå¤šè´Ÿè½½çš„è¯ä¹¦ï¼Œä¸€æ—¦è¢«æ”»å‡»ï¼Œä¼šå­˜åœ¨ç§˜é’¥æ³„éœ²çš„é£é™©ï¼›\n3. ä¸»æœºä¸Šçš„ Pod ä¹‹é—´çš„æµé‡äº‰æŠ¢é—®é¢˜ï¼Œå³èŠ‚ç‚¹ä¸Šå¦‚æœæœ‰ä¸€ä¸ªå·¥ä½œè´Ÿè½½æ¶ˆè€—æ‰ä»£ç†çš„æ‰€æœ‰èµ„æºï¼Œå…¶ä»–å·¥ä½œè´Ÿè½½å°†æ— æ³•è·å¾—æµé‡ï¼›\n\nè€Œä¸” eBPF ä¸»è¦è´Ÿè´£ä¸‰\/å››å±‚æµé‡ï¼Œå¯ä»¥ä¸ CNI ä¸€èµ·è¿è¡Œï¼Œä½†æ˜¯ä¸ƒå±‚æµé‡ä½¿ç”¨ eBPF æ¥å¤„ç†å°±ä¸å¤ªåˆé€‚äº†ã€‚\n\n\u003e *åœ¨å¯ä»¥é¢„è§çš„æœªæ¥ eBPF æŠ€æœ¯æ— æ³•å–ä»£æœåŠ¡ç½‘æ ¼å’Œ Sidecarã€‚*\n\nå…³äº eBPF ä¸æœåŠ¡ç½‘æ ¼çš„å…³ç³»çš„æ›´è¯¦ç»†ä»‹ç»è¯·å‚è€ƒåšå®¢[è¯·æš‚æ—¶æŠ›å¼ƒä½¿ç”¨ eBPF å–ä»£æœåŠ¡ç½‘æ ¼å’Œ Sidecar æ¨¡å¼çš„å¹»æƒ³](\/blog\/ebpf-sidecar-and-service-mesh\/)ã€‚\n\n### æ§åˆ¶å¹³é¢æ€§èƒ½ä¼˜åŒ–{#control-plane-perf-optimizing}\n\nä»¥ä¸Šä¸¤ç§ä¼˜åŒ–éƒ½æ˜¯é’ˆå¯¹æ•°æ®å¹³é¢è¿›è¡Œçš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹æ§åˆ¶å¹³é¢çš„æ€§èƒ½ä¼˜åŒ–ã€‚ä½ å¯ä»¥æŠŠæœåŠ¡ç½‘æ ¼æƒ³è±¡æˆæ˜¯ä¸€åœºæ¼”å‡ºï¼Œæ§åˆ¶å¹³é¢æ˜¯æ€»å¯¼æ¼”ï¼Œæ•°æ®å¹³é¢æ˜¯æ‰€æœ‰æ¼”å‘˜ï¼Œå¯¼æ¼”ä¸å‚ä¸æ¼”å‡ºï¼Œä½†æ˜¯è´Ÿè´£æŒ‡æŒ¥æ¼”å‘˜ã€‚å¦‚æœè¿™åœºæ¼”å‡ºçš„æƒ…èŠ‚å¾ˆç®€å•ï¼Œæ—¶é•¿åˆå¾ˆçŸ­ï¼Œé‚£è¦æ¯ä¸ªæ¼”å‘˜åˆ†é…çš„æˆä»½å°±ä¼šå¾ˆå°‘ï¼Œæ’ç»ƒèµ·æ¥å°±ä¼šå¾ˆå®¹æ˜“ï¼›å¦‚æœæ˜¯ä¸€ä¸ªå¤§å‹æ¼”å‡ºï¼Œæ¼”å‘˜çš„æ•°é‡å¤šï¼Œæƒ…èŠ‚æœ‰å¾ˆå¤æ‚ï¼Œè¦æƒ³æ’ç»ƒå¥½è¿™åœºæ¼”å‡ºï¼Œä¸€ä¸ªå¯¼æ¼”å¯èƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œä»–æŒ‡æŒ¥ä¸äº†è¿™ä¹ˆå¤šæ¼”å‘˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤šåå‰¯å¯¼æ¼”ï¼ˆæ‰©å¤§æ§åˆ¶å¹³é¢å®ä¾‹æ•°é‡ï¼‰ï¼›æˆ‘ä»¬è¿˜éœ€è¦ç»™æ¼”å‘˜å‡†å¤‡å¥½å°è¯å’Œè„šæœ¬ï¼Œå¦‚æœæ¼”å‘˜ä¹Ÿå¯ä»¥ä¸€ä¸ªé•œå¤´å®Œæˆä¸€è¿ä¸²çš„å°è¯å’Œåœºæ™¯çš„è¡¨æ¼”ï¼ˆå‡å°‘éƒ½æ•°æ®å¹³é¢çš„æ‰“æ‰°ï¼Œæ‰¹é‡æ¨é€æ›´æ–°ï¼‰ï¼Œé‚£æˆ‘ä»¬çš„æ’ç»ƒæ˜¯ä¸æ˜¯æ›´åŠ é«˜æ•ˆï¼Ÿ\n\nä»ä¸Šé¢çš„ç±»æ¯”ä¸­ï¼Œä½ åº”è¯¥å¯ä»¥æ‰¾åˆ°æ§åˆ¶å¹³é¢æ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘äº†ï¼Œé‚£å°±æ˜¯ï¼š\n\n- å‡å°‘éœ€è¦æ¨é€çš„é…ç½®å¤§å°ï¼›\n- æ‰¹å¤„ç†ä»£ç†æ¨é€ï¼›\n- æ‰©å¤§æ§åˆ¶å¹³é¢è§„æ¨¡ï¼›\n\n#### å‡å°‘éœ€è¦æ¨é€çš„é…ç½®{#reduce-config-size}\n\næ§åˆ¶å¹³é¢æ€§èƒ½ä¼˜åŒ–æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯å‡å°‘è¦å‘æ•°æ®å¹³é¢æ¨é€çš„ä»£ç†é…ç½®å¤§å°ã€‚å‡è®¾æœ‰å·¥ä½œè´Ÿè½½ Aï¼Œå¦‚æœä»…å°†ä¸ A ç›¸å…³çš„ä»£ç†é…ç½®ï¼ˆå³ A ä¾èµ–çš„æœåŠ¡ï¼‰æ¨é€ç»™ Aï¼Œè€Œä¸æ˜¯å°†ç½‘æ ¼å†…æ‰€æœ‰æœåŠ¡çš„é…ç½®éƒ½æ¨é€ç»™ Aï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‹ç¼©è¦æ¨é€çš„å·¥ä½œè´Ÿè½½èŒƒå›´åŠé…ç½®å¤§å°ã€‚Istio ä¸­çš„ Sidecar èµ„æºå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°è¿™ä¸€ç‚¹ã€‚ä¸‹é¢æ˜¯ Sidecar é…ç½®ç¤ºä¾‹ï¼š\n\n\u0060\u0060\u0060yaml\napiVersion: networking.istio.io\/v1alpha3\nkind: Sidecar\nmetadata:\n  name: default\n  namespace: cn-bj\nspec:\n  workloadSelector:\n    labels:\n      app: app-a\n  egress:\n  - hosts:\n    - \u0022cn-bj\/*\u0022\n\u0060\u0060\u0060\n\næˆ‘ä»¬é€šè¿‡ \u0060workloadSelector\u0060 å­—æ®µå¯ä»¥é™åˆ¶è¯¥ Sidecar é…ç½®é€‚ç”¨çš„å·¥ä½œè´Ÿè½½èŒƒå›´ï¼Œè€Œ \u0060egress\u0060 å­—æ®µå¯ä»¥ç¡®å®šè¯¥å·¥ä½œè´Ÿè½½ä¾èµ–çš„æœåŠ¡èŒƒå›´ï¼Œè¿™æ ·æ§åˆ¶å¹³é¢å°±å¯ä»¥ä»…å‘æœåŠ¡ A æ¨é€å…¶ä¾èµ–çš„æœåŠ¡é…ç½®ï¼Œå¤§å¤§å‡ä½è¦å‘æ•°æ®å¹³é¢æ¨é€çš„é…ç½®å¤§å°ï¼Œå‡å°‘äº†æœåŠ¡ç½‘æ ¼çš„å†…å­˜å’Œç½‘ç»œæ¶ˆè€—ã€‚\n\n#### æ‰¹å¤„ç†ä»£ç†é…ç½®æ¨é€{#batch-push-conf}\n\næ§åˆ¶å¹³é¢ Istiod å‘æ•°æ®å¹³é¢æ¨é€ä»£ç†é…ç½®çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸‹å›¾å±•ç¤ºäº†å…¶ä¸­çš„æµç¨‹ã€‚\n\n![Istiod å‘æ•°æ®å¹³é¢æ¨é€ä»£ç†é…ç½®çš„æµç¨‹å›¾](istiod-push.svg)\n\nç®¡ç†å‘˜é…ç½® Istio ç½‘æ ¼åï¼ŒIstiod ä¸­æ¨é€ä»£ç†é…ç½®çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š\n\n1. ç®¡ç†å‘˜æ›´æ–° Istio é…ç½®çš„äº‹ä»¶ä¼šè§¦å‘æ•°æ®å¹³é¢ä»£ç†çš„é…ç½®åŒæ­¥ï¼›\n2. Istio çš„ \u0060DiscoveryServer\u0060 ç»„ä»¶ç›‘å¬åˆ°è¿™äº›äº‹ä»¶åä¸ä¼šç«‹å³å°†é…ç½®æ¨é€åˆ°æ•°æ®å¹³é¢ï¼Œè€Œæ˜¯å°†è¿™äº›äº‹ä»¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼ŒæŒç»­åˆå¹¶ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšå»æŠ–åŠ¨ï¼ˆdebouncingï¼‰ï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢é¢‘ç¹çš„æ›´æ–°æ•°æ®å¹³é¢é…ç½®ï¼›\n3. åœ¨å»æŠ–åŠ¨å‘¨æœŸè¿‡åï¼Œè¿™äº›äº‹ä»¶å°†è¢«æ¨é€åˆ°é˜Ÿåˆ—ä¸­ï¼›\n4. Istiod ä¼šé™åˆ¶åŒæ—¶æ¨é€çš„è¯·æ±‚æ•°é‡ï¼Œä»¥åŠ å¿«æ¨é€è¿›åº¦ï¼›\n5. äº‹ä»¶è¢«è½¬æ¢æˆ Envoy çš„é…ç½®æ¨é€åˆ°æ•°æ®å¹³é¢çš„å·¥ä½œè´Ÿè½½ä¸Šï¼›\n\nä»ä»¥ä¸Šæµç¨‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¼˜åŒ–é…ç½®æ¨é€çš„å…³é”®å°±æ˜¯æ­¥éª¤ 2 ä¸­å»æŠ–åŠ¨å‘¨æœŸå’Œæ­¥éª¤ 4 ä¸­çš„é™æµè®¾ç½®ã€‚æœ‰è¿™æ ·å‡ ä¸ªç¯å¢ƒå˜é‡å¯ä»¥å¸®åŠ©ä½ è®¾ç½®æ§åˆ¶å¹³é¢çš„æ¨é€ï¼š\n\n- \u0060PILOT_DEBOUNCE_AFTER\u0060ï¼šæŒ‡å®šå»æŠ–åŠ¨çš„æ—¶é—´ï¼Œå°†äº‹ä»¶æ·»åŠ åˆ°æ¨é€é˜Ÿåˆ—ä¸­ï¼Œé»˜è®¤ä¸º 100 æ¯«ç§’ï¼›\n- \u0060PILOT_DEBOUNCE_MAX\u0060ï¼šæŒ‡å®šå…è®¸äº‹ä»¶å»æŠ–åŠ¨çš„æœ€é•¿æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…äº‹ä»¶æ²¡æœ‰æ–°çš„å˜åŒ–åˆ™æ¨é€äº‹ä»¶ï¼Œé»˜è®¤ä¸º 10 ç§’ï¼›\n- \u0060PILOT_ENABLE_EDS_DEBOUNCE\u0060ï¼šæŒ‡å®šç«¯ç‚¹æ›´æ–°æ˜¯å¦ç¬¦åˆå»æŠ–åŠ¨è§„åˆ™æˆ–å…·æœ‰ä¼˜å…ˆæƒå¹¶ç«‹å³è½å…¥æ¨é€é˜Ÿåˆ—ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå…³é—­å®ƒåå¯ä»¥åŠ é€Ÿ EDS æ¨é€ï¼›\n- \u0060PILOT_PUSH_THROTTLE\u0060ï¼šæŒ‡å®šåŒæ—¶å¤„ç†çš„æ¨é€è¯·æ±‚ï¼Œé»˜è®¤æ˜¯ 100ï¼›\n\nå…³äºè¿™äº›ç¯å¢ƒå˜é‡çš„é»˜è®¤å€¼å’Œå…·ä½“é…ç½®è¯·å‚è€ƒ [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/reference\/commands\/pilot-agent\/#envvars)ã€‚\n\nè¿™äº›å€¼ç©¶ç«Ÿå¦‚ä½•è®¾ç½®ï¼Œå¯ä»¥éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š\n\n- å¦‚æœæ§åˆ¶å¹³é¢èµ„æºç©ºé—²ï¼Œä¸ºäº†åŠ å¿«é…ç½®æ›´æ–°çš„ä¼ æ’­é€Ÿåº¦ï¼Œä½ å¯ä»¥ï¼š\n  - ç¼©çŸ­å»æŠ–åŠ¨å‘¨æœŸï¼Œå¢åŠ æ¨é€æ¬¡æ•°ï¼›\n  - å¢åŠ åŒæ—¶å¤„ç†çš„æ¨é€è¯·æ±‚æ•°é‡ï¼›\n- å¦‚æœæ§åˆ¶å¹³é¢é¥±å’Œï¼Œä¸ºäº†é™ä½æ€§èƒ½ç“¶é¢ˆï¼Œä½ å¯ä»¥ï¼š\n  - å»¶è¿Ÿå»æŠ–åŠ¨å‘¨æœŸï¼Œå‡å°‘æ¨é€æ¬¡æ•°ï¼›\n  - å¢åŠ åŒæ—¶å¤„ç†çš„æ¨é€è¯·æ±‚çš„æ•°é‡ï¼›\n\nè‡³äºå¦‚ä½•è®¾ç½®æœ€ä¼˜è§£ï¼Œéœ€è¦ç»“åˆä½ çš„å¯è§‚æµ‹ç³»ç»Ÿæ¥è°ƒè¯•ã€‚\n\n#### æ‰©å¤§æ§åˆ¶å¹³é¢è§„æ¨¡{#scale-up-control-plane}\n\nå¦‚æœè®¾ç½®å»æŠ–åŠ¨æ‰¹å¤„ç†å’Œ Sidecar è¿˜æ— æ³•ä¼˜åŒ–æ§åˆ¶å¹³é¢æ€§èƒ½çš„è¯ï¼Œæœ€åçš„é€‰æ‹©å°±æ˜¯æ‰©å¤§æ§åˆ¶å¹³é¢çš„è§„æ¨¡ï¼ŒåŒ…æ‹¬æ‰©å¤§å•ä¸ª Istiod å®ä¾‹çš„èµ„æºå’Œå¢åŠ  Istiod çš„å®ä¾‹ä¸ªæ•°ï¼Œç©¶ç«Ÿé‡‡ç”¨å“ªç§æ‰©å±•æ–¹å¼è§†æƒ…å†µè€Œå®šï¼š\n\n- å½“å•ä¸ª Istiod çš„èµ„æºå ç”¨é¥±å’Œæ—¶ï¼Œä¼˜å…ˆæ¨èä½ æ‰©å¤§ Istiod çš„å®ä¾‹å¤§å°ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºæœåŠ¡ç½‘æ ¼ä¸­æœ‰å¤ªå¤šçš„èµ„æºï¼ˆIstio çš„è‡ªå®šä¹‰èµ„æºï¼Œå¦‚ VirtualServiceã€DestinationRule ç­‰ï¼‰éœ€è¦å¤„ç†ï¼›\n- å¦‚æœå¢åŠ  Istiod å®ä¾‹çš„ CPU å’Œå†…å­˜ä¾ç„¶ä¸èµ·æ•ˆçš„è¯ï¼Œå¢åŠ  Istiod çš„å®ä¾‹ä¸ªæ•°ï¼Œè¿™æ ·å¯ä»¥åˆ†æ•£å•ä¸ªå®ä¾‹è¦ç®¡ç†çš„å·¥ä½œè´Ÿè½½æ•°é‡ï¼›\n\n### æ•°æ®å¹³é¢æ€§èƒ½ä¼˜åŒ–{#data-plane-performance}\n\nApache SkyWalking å¯ä»¥ä½œä¸º Istio æä¾›å¯è§‚æµ‹æ€§å·¥å…·ï¼Œè¿˜å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨è¿›è¡ŒæœåŠ¡åŠ¨æ€è°ƒè¯•å’Œæ•…éšœæ’é™¤å‰–ææœåŠ¡çš„æ€§èƒ½ï¼Œå…¶æœ€æ–°æ¨å‡ºçš„ [Apache SkyWalking Rover](https:\/\/github.com\/apache\/skywalking-rover) ç»„ä»¶å¯ä»¥åˆ©ç”¨ eBPF æŠ€æœ¯æ¥å‡†ç¡®å®šä½ Istio çš„å…³é”®æ€§èƒ½é—®é¢˜ [^12]ã€‚åœ¨æ•°æ®å¹³é¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥å¢åŠ  Envoy çš„ååé‡ä»¥ä¼˜åŒ– Istio çš„æ€§èƒ½ï¼š\n\n- ç¦ç”¨ Zipkin è¿½è¸ªæˆ–å‡å°‘é‡‡æ ·ç‡\n- ç®€åŒ–è®¿é—®æ—¥å¿—æ ¼å¼\n- ç¦ç”¨ Envoy çš„è®¿é—®æ—¥å¿—æœåŠ¡ï¼ˆALSï¼‰\n\nä»¥ä¸Šä¼˜åŒ–æ–¹å¼å¯¹ Envoy ååé‡çš„å½±å“æ•°æ®è¯·å‚é˜… [ä½¿ç”¨ eBPF å‡†ç¡®å®šä½æœåŠ¡ç½‘æ ¼çš„å…³é”®æ€§èƒ½é—®é¢˜](https:\/\/cloudnative.to\/blog\/pinpoint-service-mesh-critical-performance-impact-by-using-ebpf\/#introducing-skywalking-rover)ã€‚\n\n## Envoy â€”â€” æœåŠ¡ç½‘æ ¼çš„é¢†è¡”ä¸»æ¼”{#starring-envoy}\n\næˆ‘ä»¬çŸ¥é“æœåŠ¡ç½‘æ ¼æ˜¯ç”±æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ç»„æˆçš„ï¼Œä»ä¸Šé¢çš„æœåŠ¡ç½‘æ ¼å¼€æºé¡¹ç›®åˆ—è¡¨ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡ç½‘æ ¼å¼€æºé¡¹ç›®å¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäº Envoyï¼Œç„¶åå¼€å‘è‡ªå·±çš„æ§åˆ¶å¹³é¢ã€‚è¿˜è®°å¾—æˆ‘åœ¨æœ¬æ–‡å‰é¢å°†æœåŠ¡ç½‘æ ¼æ¯”ä½œæ¼”å‡ºå—ï¼Ÿåœ¨è¿™åœºæœåŠ¡ç½‘æ ¼çš„æ¼”å‡ºä¸­ï¼Œæ¯«æ— ç–‘é—® Envoy å°±æ˜¯é¢†è¡”ä¸»æ¼” â€”â€” Envoy å‘æ˜çš„ xDS åè®®ï¼ŒåŸºæœ¬æˆä¸ºæœåŠ¡ç½‘æ ¼çš„é€šç”¨ APIã€‚ä¸‹é¢å±•ç¤ºçš„æ˜¯ Envoy çš„æ¶æ„å›¾ã€‚\n\n![Envoy æ¶æ„å›¾](envoy-arch.svg)\n\nxDS æ˜¯ Envoy åŒºåˆ«äºå…¶ä»–ä»£ç†çš„å…³é”®ï¼Œå®ƒçš„ä»£ç å’Œè§£ææµç¨‹ååˆ†å¤æ‚ [^10]ï¼Œç›´æ¥æ‰©å±•èµ·æ¥ä¹Ÿå¾ˆæœ‰éš¾åº¦ã€‚ä¸‹é¢å±•ç¤ºçš„æ˜¯ Istio ç»„ä»¶æ‹“æ‰‘å›¾ï¼Œä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Istio æ•°æ®å¹³é¢çš„ Sidecar å®¹å™¨ä¸­ä¸æ­¢æœ‰ \u0060envoy\u0060 è¿™ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿˜æœ‰ä¸€ä¸ª \u0060pilot-agent\u0060 è¿›ç¨‹ã€‚\n\n{{\u003cfigure title=\u0022Istio ç»„ä»¶æ‹“æ‰‘å›¾\u0022 alt=\u0022Istio ç»„ä»¶æ‹“æ‰‘å›¾\u0022 id=\u0022istio-components\u0022 src=\u0022istio-components.svg\u0022\u003e}}\n\n\u0060pilot-agent\u0060 è¿›ç¨‹çš„ä½œç”¨å¦‚ä¸‹ï¼š\n- ä½œä¸º \u0060envoy\u0060 çš„çˆ¶è¿›ç¨‹ï¼Œè´Ÿè´£ Envoy çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼›\n-  æ¥æ”¶æ¥è‡ªæ§åˆ¶å¹³é¢çš„æ¨é€ï¼Œé…ç½®ä»£ç†å’Œè¯ä¹¦ï¼›\n- æ”¶é›† Envoy ç»Ÿè®¡ä¿¡æ¯ï¼Œæ±‡æ€» sidecar çš„ç»Ÿè®¡æ•°æ®ä¾› Prometheus æœé›†ï¼›\n- å†…ç½®æœ¬åœ° DNS ä»£ç†ï¼Œç”¨äºè§£æ Kubernetes DNS è§£æä¸äº†çš„é›†ç¾¤å†…éƒ¨åŸŸåçš„åœºæ™¯ï¼›\n- å¯¹ Envoy å’Œ DNS ä»£ç†è¿›è¡Œå¥åº·æ£€æŸ¥ï¼›\n\nä»ä»¥ä¸ŠåŠŸèƒ½ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º \u0060pilot-agent\u0060 è¿›ç¨‹ä¸»è¦æ˜¯ç”¨äºä¸ Istiod äº¤äº’ï¼Œä¸º Envoy èµ·åˆ°æŒ‡æŒ¥å’Œè¾…åŠ©çš„ä½œç”¨ï¼ŒIstio çš„æ ¸å¿ƒç»„ä»¶æ˜¯ Envoyã€‚é‚£ä¹ˆ Envoy ä¼šä¸ä¼šã€Œæ¼”è€Œä¼˜åˆ™å¯¼ã€ï¼Œä¸å†é…åˆ Istioï¼Œæ„å»ºä¸€å¥—è‡ªå·±çš„æ§åˆ¶å¹³é¢å‘¢ï¼Ÿ\n\n\u003e *åœ¨ Sidecar å®¹å™¨ä¸­ï¼Œ\u0060pilot-agent\u0060 å°±åƒæ˜¯ Envoy çš„â€œSidecarâ€ã€‚*\n\n{{\u003ccallout note è¯·è¯»è€…æ€è€ƒä¸€ä¸‹\u003e}}\n\u0060pilot-agent\u0060 çš„åŠŸèƒ½èƒ½å¦ç›´æ¥å†…ç½®åˆ° Envoy ä¸­ï¼Œä»è€Œå–æ¶ˆ \u0060pilot-agent\u0060 å‘¢ï¼Ÿ\n{{\u003c\/callout\u003e}}\n\n## Envoy Gateway ç»Ÿä¸€æœåŠ¡ç½‘æ ¼ç½‘å…³{#envoy-gateway}\n\nåœ¨ Kubernetes ä¸­ï¼Œé™¤ Service èµ„æºå¯¹è±¡ä¹‹å¤–ï¼Œæœ€æ—©ç”¨æ¥æš´éœ²é›†ç¾¤ä¸­æœåŠ¡çš„èµ„æºå¯¹è±¡æ˜¯ Ingressã€‚ä½¿ç”¨ Ingress ä½ åªéœ€è¦ä¸ºé›†ç¾¤å¼€æ”¾ä¸€ä¸ªå¯¹å¤–çš„è®¿é—®ç‚¹å³å¯ï¼Œé€šè¿‡ HTTP Hosts å’Œ \u0060path\u0060 æ¥è·¯ç”±æµé‡åˆ°å…·ä½“çš„æœåŠ¡ã€‚ç›¸å¯¹äºç›´æ¥åœ¨ \u0060service\u0060 èµ„æºä¸Šæš´éœ²æœåŠ¡æ¥è¯´ï¼Œå¯ä»¥å‡å°‘é›†ç¾¤çš„ç½‘ç»œè®¿é—®ç‚¹ï¼ˆPEPï¼‰[^11] ï¼Œé™ä½é›†ç¾¤è¢«ç½‘ç»œæ”»å‡»çš„é£é™©ã€‚ä½¿ç”¨ Ingress è®¿é—®é›†ç¾¤å†…çš„æœåŠ¡æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![Kubernetes Ingress æµé‡è®¿é—®æµç¨‹å›¾](ingress.svg)\n\nåœ¨ Kubernetes ä¹‹å‰ï¼ŒAPI Gateway è½¯ä»¶å°±å·²ç»è¢«å¹¿æ³›ç”¨ä½œè¾¹ç¼˜è·¯ç”±äº†ï¼Œåœ¨å¼•ç”¨ Istio æ—¶åˆå¢åŠ äº† Istio è‡ªå®šä¹‰çš„ Gateway èµ„æºï¼Œä½¿å¾—è®¿é—® Istio æœåŠ¡ç½‘æ ¼ä¸­çš„èµ„æºåˆå¤šäº†ä¸€ç§é€‰æ‹©ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![è®¿é—® Istio ç½‘æ ¼ä¸­çš„æœåŠ¡çš„æ–¹å¼](access-cluster.svg)\n\nç°åœ¨ï¼Œè¦æƒ³æš´éœ²å•ä¸ª Istio ç½‘æ ¼ä¸­çš„æœåŠ¡ï¼Œ\u0060NodePort\u0060ã€\u0060LoadBalance\u0060ã€Istio è‡ªå®šä¹‰ Gatewayã€Kubernetes Ingress å’Œ API Gateway è½¯ä»¶ï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿå¦‚æœæ˜¯å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼ï¼Œå®¢æˆ·ç«¯å¦‚ä½•è®¿é—®ç½‘æ ¼å†…çš„æœåŠ¡ï¼Ÿæˆ‘ä»¬çš„æœåŠ¡ç½‘æ ¼é¢†è¡”ä¸»æ¼” Envoy å·²ç»åœ¨è¿™æ–¹é¢åšè¶³äº†åŠŸå¤«ï¼Œè¢«ä»¥å¤šç§å½¢å¼ä½¿ç”¨ï¼š\n\n- Sidecar Proxyï¼šæ­£å¦‚åœ¨[å‰æ–‡ä¸­](#are-they-service-mesh)æåˆ°çš„ï¼ŒIstioã€Kumaã€Consul Connect éƒ½ä½¿ç”¨äº† Envoy ä½œä¸º sidecar ä»£ç†ï¼›\n- Kubernetes Ingress Controller\/API Gatewayï¼š[Contour](https:\/\/github.com\/projectcontour\/contour)ã€[Emissary](https:\/\/github.com\/emissary-ingress\/emissary)ã€[Hango](https:\/\/github.com\/hango-io\/hango-gateway)ã€[Gloo](https:\/\/github.com\/solo-io\/gloo) ç­‰ï¼›\n\nè¿™äº›é¡¹ç›®åˆ©ç”¨ Envoy æ¥å®ç°æœåŠ¡ç½‘æ ¼å’Œ API ç½‘å…³ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šåŠŸèƒ½é‡å ï¼ŒåŒæ—¶åˆæœ‰å¾ˆå¤šä¸“æœ‰åŠŸèƒ½ï¼Œæˆ–è€…ç¼ºä¹ç¤¾åŒºå¤šæ ·æ€§ï¼Œè¿™ç§ç°çŠ¶ç”±äº Envoy ç¤¾åŒºæ²¡æœ‰æä¾›æ§åˆ¶å¹³é¢å®ç°è€Œå¯¼è‡´çš„ã€‚ä¸ºäº†æ”¹å˜ç°çŠ¶ï¼ŒEnvoy ç¤¾åŒºå‘èµ·äº† [Envoy Gateway](https:\/\/github.com\/envoyproxy\/gateway) é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ—¨åœ¨ç»“åˆç°æœ‰çš„åŸºäº Envoy çš„ API Gateway ç›¸å…³é¡¹ç›®çš„ç»éªŒ [^13]ï¼Œåˆ©ç”¨å¸¦æœ‰ä¸€äº› Envoy ç‰¹å®šæ‰©å±•çš„  [Kubernetes Gateway API](https:\/\/gateway-api.sigs.k8s.io\/) é™ä½ Envoy ç”¨æˆ·ä½¿ç”¨ç½‘å…³çš„é—¨æ§›ã€‚å› ä¸º Envoy Gateway ä»ç„¶é€šè¿‡ xDS ä¸‹å‘é…ç½®ç»™ Envoy ä»£ç†ï¼Œå› æ­¤ä½ è¿˜å¯ä»¥ç”¨å®ƒæ¥ç®¡ç†æ”¯æŒ xDS çš„ç½‘å…³ï¼Œå¦‚ Istio Gatewayã€‚\n\næˆ‘ä»¬ç°åœ¨æ‰€è§çš„ç½‘å…³åŸºæœ¬éƒ½æ˜¯åœ¨å•é›†ç¾¤ä¸­ä½œä¸ºå…¥å£ç½‘å…³ï¼Œå¯¹äºå¤šé›†ç¾¤å’Œå¤šç½‘æ ¼å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚ä¸ºäº†åº”å¯¹å¤šé›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Istio ä¹‹ä¸Šå†æ·»åŠ ä¸€å±‚ç½‘å…³ï¼Œå’Œä¸€ä¸ªå…¨å±€çš„æ§åˆ¶å¹³é¢ä»¥åœ¨å¤šé›†ç¾¤é—´è·¯ç”±æµé‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![å¤šé›†ç¾¤å¤šç½‘æ ¼çš„ä¸¤çº§ç½‘å…³ç¤ºæ„å›¾](t2-gateway.svg)\n\n{{\u003ccallout note å…³äºä¸¤çº§ç½‘å…³çš„ç®€è¦ä»‹ç»\u003e}}\n- ä¸€çº§ç½‘å…³ï¼ˆä¸‹æ–‡ç®€ç§° T1ï¼‰ä½äºåº”ç”¨è¾¹ç¼˜ï¼Œç”¨äºå¤šé›†ç¾¤ç¯å¢ƒã€‚åŒä¸€åº”ç”¨ä¼šåŒæ—¶æ‰˜ç®¡åœ¨ä¸åŒçš„é›†ç¾¤ä¸Šï¼ŒT1 ç½‘å…³å°†å¯¹è¯¥åº”ç”¨çš„è¯·æ±‚æµé‡åœ¨è¿™äº›é›†ç¾¤ä¹‹é—´è·¯ç”±ã€‚\n- äºŒçº§ç½‘å…³ï¼ˆä¸‹æ–‡ç®€ç§° T2ï¼‰ä½äºä¸€ä¸ªçš„é›†ç¾¤è¾¹ç¼˜ï¼Œç”¨äºå°†æµé‡è·¯ç”±åˆ°è¯¥é›†ç¾¤å†…ç”±æœåŠ¡ç½‘æ ¼ç®¡ç†çš„æœåŠ¡ã€‚\n{{\u003c\/callout\u003e}}\n\né€šè¿‡åœ¨ Istio æ§åˆ¶å¹³é¢ä»¥å¤–å¢åŠ ä¸€å±‚å…¨å±€æ§åˆ¶å¹³é¢å’Œ APIï¼Œæ¥å®ç°å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼ç®¡ç†ã€‚å°† T1 ç½‘å…³éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œå¯ä»¥é˜²æ­¢å•ç‚¹æ•…éšœã€‚æƒ³è¦äº†è§£å…³äºä¸¤çº§ç½‘å…³çš„æ›´å¤šå†…å®¹ï¼Œè¯·å‚è€ƒ[é€šè¿‡ä¸¤çº§ç½‘å…³è®¾è®¡æ¥è·¯ç”±æœåŠ¡ç½‘æ ¼æµé‡](https:\/\/cloudnative.to\/blog\/designing-traffic-flow-via-tier1-and-tier2-ingress-gateways\/)ã€‚\n\nT1 ç½‘å…³çš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.tsb.tetrate.io\/v2\nkind: Tier1Gateway\nmetadata:\n  name: service1-tier1\n  group: demo-gw-group\n  organization: demo-org\n  tenant: demo-tenant\n  workspace: demo-ws\nspec:\n  workloadSelector:\n    namespace: t1\n    labels:\n      app: gateway-t1\n      istio: ingressgateway\n  externalServers:\n  - name: service1\n    hostname: servicea.example.com\n    port: 80\n    tls: {}\n    clusters:\n    - name: cluster1\n      weight: 75\n    - name: cluster2\n      weight: 25 \n\u0060\u0060\u0060\n\nè¯¥é…ç½®å°† \u0060servicea.example.com\u0060 é€šè¿‡ T1 ç½‘å…³æš´éœ²åˆ°ç½‘æ ¼å¤–ï¼Œå¹¶å°†ç½‘æ ¼å¤–è®¿é—®è¯¥æœåŠ¡çš„æµé‡çš„ \u006075%\u0060 è½¬å‘åˆ° \u0060cluster1\u0060ï¼Œ\u006025%\u0060 çš„æµé‡è½¬å‘åˆ° \u0060cluster2\u0060ï¼Œå¦å¤–ä¸ºäº†åº”å¯¹å¤šé›†ç¾¤ä¸­çš„æµé‡ã€æœåŠ¡å’Œå®‰å…¨é…ç½®ï¼ŒTetrate æ——èˆ°äº§å“ Tetrate Service Bridge ä¸­è¿˜å¢åŠ äº† ä¸€ç³»åˆ— Group APIï¼Œè¯¦è§ TSB æ–‡æ¡£ã€‚\n\n## Istio å¼€æºç”Ÿæ€{#ecosystem}\n\nIstio å¼€æºåœ¨è‡³ä»Šå·²ç»äº”å¹´å¤šäº†ï¼Œè¿‘ä¸¤å¹´æ¥å‡ºç°äº†å¾ˆå¤šåŸºäº Istio çš„å¼€æºé¡¹ç›®ï¼Œå…¶ä¸­æ¯”è¾ƒä»£è¡¨æ€§çš„æœ‰ï¼š\n\n- ç½‘æ˜“å¼€æºçš„ Slime\n- è…¾è®¯å¼€æºçš„ Aeraki\n- Istio å®˜æ–¹å¯¹ Wasm æ’ä»¶çš„æ”¯æŒ\n\nå®ƒä»¬çš„å‡ºç°ä½¿å¾— Istio æ›´åŠ æ™ºèƒ½åŒ–å¹¶æ‰©å±•äº† Istio çš„é€‚ç”¨èŒƒå›´ã€‚\n\n### Slime\n\n[Slime](https:\/\/github.com\/slime-io\/slime\/) æ˜¯ç”±ç½‘æ˜“æ•°å¸†å¾®æœåŠ¡å›¢é˜Ÿå¼€æºçš„ä¸€æ¬¾åŸºäº Istio çš„æ™ºèƒ½ç½‘æ ¼ç®¡ç†å™¨ã€‚Slime åŸºäº Kubernetes Operator å®ç°ï¼Œå¯ä½œä¸º Istio çš„ CRD ç®¡ç†å™¨ï¼Œæ— é¡»å¯¹ Istio åšä»»ä½•å®šåˆ¶åŒ–æ”¹é€ ï¼Œå°±å¯ä»¥å®šä¹‰åŠ¨æ€çš„æœåŠ¡æ²»ç†ç­–ç•¥ï¼Œä»è€Œè¾¾åˆ°è‡ªåŠ¨ä¾¿æ·ä½¿ç”¨ Istio å’Œ Envoy é«˜é˜¶åŠŸèƒ½çš„ç›®çš„ã€‚\n\næˆ‘ä»¬åœ¨å‰æ–‡çš„[æ§åˆ¶å¹³é¢æ€§èƒ½ä¼˜åŒ–](#control-plane-perf-optimizing)ä¸­æåˆ°äº†é€šè¿‡ã€Œå‡å°‘éœ€è¦æ¨é€çš„é…ç½®ã€çš„æ–¹å¼æ¥ä¼˜åŒ– Istio çš„æ€§èƒ½ï¼Œä½†æ˜¯ Istio æ— æ³•åšåˆ°è‡ªåŠ¨è¯†åˆ«æ— æ³•ä¾èµ–ä»¥æœ€ä¼˜åŒ–éœ€è¦æ¨é€åˆ°æ¯ä¸ª sidecar çš„ä»£ç†é…ç½®ï¼ŒSlime æä¾›äº† \u0060lazyload\u0060 æ§åˆ¶å™¨ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°é…ç½®æ‡’åŠ è½½ï¼Œç”¨æˆ·æ— é¡»æ‰‹åŠ¨é…ç½® \u0060SidecarScope\u0060 [^15]ï¼ŒIstio å¯ä»¥æŒ‰éœ€åŠ è½½æœåŠ¡é…ç½®å’ŒæœåŠ¡å‘ç°ä¿¡æ¯ã€‚\n\nä¸‹å›¾å±•ç¤ºçš„æ˜¯ Slime ä½œä¸º Istio çš„ç®¡ç†å¹³é¢æ›´æ–°æ•°æ®å¹³é¢é…ç½®çš„æµç¨‹å›¾ã€‚\n\n![ä½¿ç”¨ Slime æ›´æ–° Istio æ•°æ®å¹³é¢é…ç½®çš„æµç¨‹å›¾](slime-process.svg)\n\nå…¶ä¸­ï¼ŒGlobal Proxy ä½¿ç”¨ Envoy æ„å»ºï¼Œåœ¨æ¯ä¸ªéœ€è¦å¯åŠ¨é…ç½®æ‡’åŠ è½½çš„å‘½åç©ºé—´ä¸­éƒ¨ç½²ä¸€ä¸ªæˆ–åœ¨æ•´ä¸ªç½‘æ ¼ä¸­åªéƒ¨ç½²ä¸€ä¸ªï¼Œæ‰€æœ‰ç¼ºå¤±æœåŠ¡å‘ç°ä¿¡æ¯çš„è°ƒç”¨ï¼ˆä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨é…ç½®æœåŠ¡è°ƒç”¨å…³ç³»ï¼‰ï¼Œéƒ½ä¼šè¢«å…œåº•è·¯ç”±åŠ«æŒåˆ° Global Proxyï¼Œç»è¿‡å…¶é¦–æ¬¡è½¬å‘åï¼ŒSlime ä¾¿å¯æ„ŸçŸ¥åˆ°è¢«è°ƒç”¨æ–¹çš„ä¿¡æ¯ï¼Œç„¶åæ ¹æ®å…¶å¯¹åº”æœåŠ¡çš„ VirtualServiceï¼Œæ‰¾åˆ°æœåŠ¡åå’ŒçœŸå®åç«¯çš„æ˜ å°„å…³ç³»ï¼Œå°†ä¸¤è€…çš„éƒ½åŠ å…¥ SidecarScopeï¼Œä»¥åè¯¥æœåŠ¡çš„è°ƒç”¨å°±ä¸å†éœ€è¦ç»è¿‡ Global Proxy äº†ã€‚\n\næ•°æ®å¹³é¢é…ç½®æ›´æ–°çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. Slime Operator æ ¹æ®ç®¡ç†å‘˜çš„é…ç½®åœ¨ Kubernetes ä¸­å®Œæˆ Slime ç»„ä»¶çš„åˆå§‹åŒ–ï¼Œå¼€å‘è€…åˆ›å»ºç¬¦åˆ Slime CRD è§„èŒƒçš„é…ç½®å¹¶åº”ç”¨åˆ° Kubernetes é›†ç¾¤ä¸­ï¼›\n2. Slime æŒç»­ç›‘å¬ Slime CRD çš„åˆ›å»ºï¼›\n3. Slime æŸ¥è¯¢ Prometheus ä¸­ä¿å­˜çš„ç›¸å…³æœåŠ¡çš„ç›‘æ§æ•°æ®ï¼Œç»“åˆ Slime CRD ä¸­è‡ªé€‚åº”éƒ¨åˆ†çš„é…ç½®ï¼Œå°† Slime CRD è½¬æ¢ä¸º Istio CRDï¼ŒåŒæ—¶å°†å…¶æ¨é€åˆ° Global Proxy ä¸­ï¼›\n4. Istio ç›‘å¬ Istio CRD çš„åˆ›å»ºï¼›\n5. Istio å°†ä»£ç†çš„é…ç½®ä¿¡æ¯æ¨é€åˆ°æ•°æ®å¹³é¢ç›¸åº”çš„ Sidecar Proxy ä¸­ï¼›\n\nå› ä¸ºæ•°æ®å¹³é¢ä¸­çš„æ‰€æœ‰æœåŠ¡çš„é¦–æ¬¡è°ƒç”¨éƒ½é€šè¿‡ Global Proxyï¼Œè¯¥ Proxy å¯ä»¥è®°å½•æ‰€æœ‰æœåŠ¡çš„è°ƒç”¨å’Œä¾èµ–ä¿¡æ¯ï¼Œæ ¹æ®è¯¥ä¾èµ–ä¿¡æ¯æ›´æ–° Istio ä¸­ Sidecar èµ„æºçš„é…ç½®ï¼›å½“æŸä¸ªæœåŠ¡çš„è°ƒç”¨é“¾è¢« VirtualService ä¸­çš„è·¯ç”±ä¿¡æ¯é‡æ–°å®šä¹‰æ—¶ï¼ŒGlobal Proxy åŸæœ‰è®°å½•å°±å¤±æ•ˆäº†ï¼Œéœ€è¦ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„æ¥ç»´æŠ¤è¯¥æœåŠ¡çš„è°ƒç”¨å…³ç³»ã€‚Slime åˆ›å»ºäº†åä¸º \u0060ServiceFence\u0060 çš„ CRD æ¥ç»´æŠ¤æœåŠ¡è°ƒç”¨å…³ç³»ä»¥è§£å†³æœåŠ¡ä¿¡æ¯ç¼ºå¤±é—®é¢˜ï¼Œè¯¦è§ [Slime ç®€ä»‹](\/blog\/slime-intro\/)ã€‚\n\n### Aeraki\n\n[Aeraki Mesh](https:\/\/github.com\/aeraki-mesh\/aeraki) æ˜¯è…¾è®¯äº‘åœ¨ 2021 å¹´ 3 æœˆå¼€æºçš„ä¸€ä¸ªæœåŠ¡ç½‘æ ¼é¢†åŸŸçš„é¡¹ç›®ï¼ŒåŸºäº Istio æ‰©å±•å…¶å¯¹ä¸ƒå±‚åè®®çš„æ”¯æŒï¼Œä¸“æ³¨äºè§£å†³ Istio ä¸­çš„**é HTTP åè®®**çš„æœåŠ¡æ²»ç†ï¼Œå·²äº 2022 å¹´ 6 æœˆè¿›å…¥ CNCF Sandboxã€‚\n\nä¸‹å›¾å±•ç¤ºäº† Aeraki å°†é HTTP åè®®çº³å…¥åˆ° Istio ç½‘æ ¼ä¸­çš„æµç¨‹å›¾ã€‚\n\n![Aeraki å°†é HTTP åè®®çº³å…¥åˆ° Istio ç½‘æ ¼ä¸­çš„æµç¨‹å›¾](aeraki-arch.svg)\n\n å…¶è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š\n\n1. Aeraki çš„ X2Istio ç»„ä»¶å¯¹æ¥æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œè·å–é HTTP æœåŠ¡çš„æ³¨å†Œä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆ ServiceEntry å‘ Istio ä¸­æ³¨å†Œï¼›\n2. Aeraki ä½œä¸º Istio ä¹‹ä¸Šçš„ç®¡ç†å¹³é¢ï¼Œå®ƒä» Istio ä¸­è·å– ServiceEntry é…ç½®ï¼›\n3. Aeraki é€šè¿‡ç«¯å£å‘½åè§„åˆ¤æ–­æœåŠ¡çš„åè®®ç±»å‹ï¼ˆå¦‚ \u0060tcp-metaprotocol-dubbo\u0060ï¼‰ï¼Œç„¶åç”Ÿæˆ MetaProtocol Proxy Filterï¼ˆå…¼å®¹ EnvoyFilterï¼‰é…ç½®ï¼ŒåŒæ—¶ä¿®æ”¹ RDS åœ°å€ï¼Œå°†å…¶æŒ‡å‘ Aerakiï¼›\n4. Istio ä½¿ç”¨ xDS åè®®å°†é…ç½®ï¼ˆLDSã€CDSã€EDS ç­‰ï¼‰ä¸‹å‘ç»™æ•°æ®å¹³é¢ï¼›\n5. Aeraki æ ¹æ®æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯å’Œç”¨æˆ·è®¾ç½®ç”Ÿæˆè·¯ç”±è§„åˆ™ï¼Œé€šè¿‡ RDS å‘é€ç»™æ•°æ®å¹³é¢ï¼›\n\nåœ¨ Istio ä¸­æ¥å…¥é HTTP æœåŠ¡çš„æ•´ä¸ªæµç¨‹ä¸­çš„å…³é”®æ˜¯ **MetaProtocol Proxy** ã€‚Istio é»˜è®¤æ”¯æŒ HTTP\/HTTP2ã€TCP å’Œ gRPC åè®®ï¼Œå®éªŒæ€§æ”¯æŒ Mongoã€MySQL å’Œ Redis åè®® [^14]ã€‚è‹¥è¦ä½¿ç”¨ Istio è·¯ç”±å…¶ä»–åè®®çš„æµé‡ï¼Œä¸ä»…éœ€è¦ä¿®æ”¹ Istio æ§åˆ¶å¹³é¢å¹¶æ‰©å±• Envoyï¼Œè¿™å°†å¸¦æ¥å·¨å¤§çš„å·¥ä½œé‡ï¼Œè€Œä¸”ä¸åŒåè®®å…±äº«é€šç”¨çš„æ§åˆ¶é€»è¾‘ï¼Œè¿™è¿˜ä¼šå¸¦æ¥å¾ˆå¤šé‡å¤æ€§å·¥ä½œã€‚MetaProtocol Proxy æ˜¯åœ¨ Envoy ä»£ç åŸºç¡€ä¸Šçš„æ‰©å±•ï¼Œä¸ºä¸ƒå±‚åè®®ç»Ÿä¸€å®ç°äº†æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€RDS åŠ¨æ€è·¯ç”±ã€æµé‡é•œåƒã€æ•…éšœæ³¨å…¥ã€æœ¬åœ°\/å…¨å±€é™æµç­‰åŸºç¡€èƒ½åŠ›ï¼Œå¤§å¤§é™ä½äº†åœ¨ Envoy ä¸Šå¼€å‘ç¬¬ä¸‰æ–¹åè®®çš„éš¾åº¦ã€‚\n\nä¸‹å›¾å±•ç¤ºçš„ MetaProtocol Proxy çš„æ¶æ„å›¾ã€‚\n\n![MetaProtocol Proxy æ¶æ„å›¾](metaprotocol-proxy.svg)\n\nå½“æˆ‘ä»¬æƒ³æ‰©å±• Istio ä½¿å…¶æ”¯æŒ Kafkaã€Dubboã€Thrift ç­‰å…¶ä»–ä¸ƒå±‚åè®®æ—¶ï¼Œåªéœ€è¦å®ç°ä¸Šå›¾ä¸­çš„ç¼–è§£ç çš„æ¥å£ï¼ˆDecode å’Œ Encodeï¼‰ï¼Œå°±å¯ä»¥åŸºäº MetaProtocol å¿«é€Ÿå¼€å‘ä¸€ä¸ªç¬¬ä¸‰æ–¹åè®®æ’ä»¶ã€‚MetaProtocol Proxy æ˜¯åœ¨ Envoy åŸºç¡€ä¸Šçš„æ‰©å±•ï¼Œå› æ­¤ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨å¤šç§è¯­è¨€ä¸ºå…¶å¼€å‘è¿‡æ»¤å™¨ï¼Œå¹¶ä½¿ç”¨ \u0060EnvoyFilter\u0060 èµ„æºå°†é…ç½®ä¸‹å‘åˆ°æ•°æ®å¹³é¢ã€‚\n\n### WasmPlugin API\n\n[WasmPlugin](https:\/\/istio.io\/latest\/docs\/reference\/config\/proxy_extensions\/wasm-plugin\/) æ˜¯ Istio 1.12 ç‰ˆæœ¬å¼•å…¥çš„ APIï¼Œä½œä¸ºä»£ç†æ‰©å±•æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒå°†è‡ªå®šä¹‰å’Œç¬¬ä¸‰æ–¹çš„ Wasm æ¨¡å—æ·»åŠ åˆ°æ•°æ®å¹³é¢ä¸­ã€‚ä¸‹å›¾ä¸­å±•ç¤ºäº†å¦‚ä½•åœ¨ Istio ä¸­ä½¿ç”¨ WasmPluginã€‚\n\n![åœ¨ Istio ä¸­ä½¿ç”¨ WasmPlugin çš„æµç¨‹å›¾](wasmplugin.svg)\n\nå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. ç”¨æˆ·ä½¿ç”¨ [Proxy-Wasm SDK](https:\/\/github.com\/proxy-wasm)ï¼ˆç›®å‰æœ‰ AssemblyScriptã€C\u002b\u002bã€Rustã€Zig å’Œ Go è¯­è¨€ç‰ˆæœ¬ï¼‰æ¥å¼€å‘æ‰©å±•ï¼Œå¹¶æ„å»ºæˆ OCI é•œåƒï¼ˆå¦‚ Docker é•œåƒï¼‰ä¸Šä¼ åˆ°é•œåƒä»“åº“ï¼›\n2. ç”¨æˆ·ç¼–å†™ \u0060WasmPlugin\u0060 é…ç½®å¹¶åº”ç”¨åˆ° Istioï¼›\n3. Istio æ§åˆ¶å¹³é¢æ ¹æ® \u0060WasmPlugin\u0060 é…ç½®ä¸­çš„å·¥ä½œè´Ÿè½½é€‰æ‹©é…ç½®ï¼Œå°† Wasm æ¨¡å—æ³¨å…¥åˆ°æŒ‡å®šçš„ Pod ä¸­ï¼›\n4. Sidecar ä¸­çš„ \u0060pilot-agent\u0060 [^16] ä»è¿œç¨‹æˆ–æœ¬åœ°æ–‡ä»¶ä¸­è·å– Wasm æ¨¡å—å¹¶å°†å…¶åŠ è½½åˆ° Envoy ä¸­è¿è¡Œï¼›\n\n## è°åº”è¯¥ä½¿ç”¨ Istioï¼Ÿ{#whos-should-use-istio}\n\nå¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆè¯´ï¼Œè¿™è·Ÿä½ æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼ŸIstio è·Ÿä½ çš„å…³ç³»å–å†³äºä½ çš„è§’è‰²ï¼š\n\n- å¦‚æœä½ æ˜¯å¹³å°è´Ÿè´£äººï¼Œåº”ç”¨æœåŠ¡ç½‘æ ¼åï¼Œå¯èƒ½å¢å¼ºä½ çš„å¹³å°å¯è§‚æµ‹æ€§ï¼Œå…·æœ‰äº†ä¸€ä¸ªç»Ÿä¸€çš„å¹³å°æ¥ç®¡ç†å¾®æœåŠ¡ï¼Œä½ å°†æ˜¯ç›´æ¥å—ç›Šè€…ï¼Œä¹Ÿåº”è¯¥æ˜¯æœåŠ¡ç½‘æ ¼çš„ä¸»è¦å®æ–½è€…ï¼›\n- å¦‚æœæ˜¯åº”ç”¨ç¨‹åºå¼€å‘è€…ï¼Œä¹Ÿä¼šä»æœåŠ¡ç½‘æ ¼ä¸­æ”¶ç›Šï¼Œå› ä¸ºä½ å¯ä»¥æ›´åŠ ä¸“å±äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸ç”¨æ‹…å¿ƒé‡è¯•ç­–ç•¥ã€TLS ç­‰å…¶ä»–éåŠŸèƒ½æ€§é—®é¢˜ï¼›\n\nä¸‹å›¾å±•ç¤ºäº†æœåŠ¡ç½‘æ ¼çš„é‡‡ç”¨è·¯å¾„ã€‚\n\n![æœåŠ¡ç½‘æ ¼çš„é‡‡ç”¨è·¯å¾„](adopt.svg)\n\næ˜¯å¦é‡‡ç”¨æœåŠ¡ç½‘æ ¼å–å†³äºä½ å…¬å¸çš„æŠ€æœ¯å‘å±•é˜¶æ®µï¼Œåº”ç”¨æ˜¯å¦å®ç°å®¹å™¨åŒ–å’Œå¾®æœåŠ¡ï¼Œå¯¹å¤šè¯­è¨€çš„éœ€æ±‚ï¼Œæ˜¯å¦éœ€è¦ mTLS ä»¥åŠå¯¹æ€§èƒ½æŸè€—çš„æ¥çº³åº¦ç­‰ã€‚\n\n## æœåŠ¡ç½‘æ ¼åœ¨äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­çš„å®šä½{#service-mesh-positioning}\n\næŠ€æœ¯çš„å‘å±•æ—¥æ–°æœˆå¼‚ï¼Œè¿‘ä¸¤å¹´æ¥æœ‰ä¸€äº›æ–°æŠ€æœ¯å‡ºç°ï¼Œä¼¼ä¹æŒ‘æˆ˜äº†æœåŠ¡ç½‘æ ¼çš„åœ°ä½ï¼Œæ›´æœ‰äººå£°ç§°å¯ä»¥ç›´æ¥å–ä»£ç°æœ‰ç»å…¸çš„ sidecar æ¨¡å¼çš„æœåŠ¡ç½‘æ ¼ [^8]ï¼Œæˆ‘ä»¬ä¸è¦è¢«å¤–ç•Œå˜ˆæ‚çš„å£°éŸ³æ‰€è¿·æƒ‘ï¼Œè®¤æ¸…æœåŠ¡ç½‘æ ¼åœ¨äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­çš„å®šä½ã€‚\n\n\u003e *ä¸€å‘³åœ°æ¨å¹¿æŸé¡¹æŠ€æœ¯è€Œå¿½ç•¥å®ƒçš„é€‚ç”¨åœºæ™¯ï¼Œå°±æ˜¯è€æµæ°“ã€‚*\n\nä¸‹å›¾å±•ç¤ºçš„æ˜¯äº‘åŸç”ŸæŠ€æœ¯å †æ ˆã€‚\n\n![äº‘åŸç”ŸæŠ€æœ¯å †æ ˆç¤ºæ„å›¾](cloud-native-stack.svg)\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨äº‘åŸç”ŸæŠ€æœ¯å †æ ˆå›¾ä¸­çš„ã€Œäº‘åŸºç¡€è®¾æ–½ã€ã€ã€Œä¸­é—´ä»¶ã€å’Œã€Œåº”ç”¨ã€å±‚éƒ½åˆ—ä¸¾äº†ä¸€äº›æ ‡å¿—æ€§çš„å¼€æºé¡¹ç›®ï¼Œè¿™äº›é¡¹ç›®æ„å»ºäº†å®ƒä»¬æ‰€åœ¨é¢†åŸŸçš„æ ‡å‡†ï¼š\n\n- åœ¨äº‘åŸºç¡€è®¾æ–½é¢†åŸŸï¼ŒKubernetes ç»Ÿä¸€äº†å®¹å™¨ç¼–æ’å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ ‡å‡†ï¼ŒOperator æ¨¡å¼å¥ å®šäº†æ‰©å±• Kubernetes API åŠç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥çš„æ ‡å‡†ï¼›\n- åœ¨ä¸­é—´ä»¶é¢†åŸŸï¼ŒæœåŠ¡ç½‘æ ¼æ‰¿æ‹…èµ·äº†äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­çš„ä¸ƒå±‚ç½‘ç»œã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨ç­‰å¤šä¸ªæ–¹é¢çš„éƒ¨åˆ†æˆ–å…¨éƒ¨è´£ä»»ï¼Œå®ƒè¿è¡Œåœ¨åº”ç”¨ç¨‹åºä¸‹å±‚ï¼Œå¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´å‡ ä¹æ˜¯æ— æ„ŸçŸ¥çš„ï¼›Daprï¼ˆåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼‰å®šä¹‰äº‘åŸç”Ÿä¸­é—´ä»¶çš„èƒ½åŠ›æ¨¡å‹ï¼Œå¼€å‘è€…å¯ä»¥åœ¨åº”ç”¨ä¸­é›†æˆ Dapr çš„å¤šè¯­è¨€ SDKï¼Œé¢å‘ Dapr æä¾›çš„åˆ†å¸ƒå¼èƒ½åŠ›ç¼–ç¨‹ï¼Œè€Œä¸ç”¨å…³å¿ƒåº”ç”¨æ‰€è¿è¡Œçš„ç¯å¢ƒåŠå¯¹æ¥çš„åç«¯åŸºç¡€è®¾æ–½ã€‚å› ä¸ºåœ¨å’Œåº”ç”¨ç¨‹åºè¿è¡Œåœ¨åŒä¸€ä¸ª Pod ä¸­çš„ Dapr è¿è¡Œæ—¶ï¼ˆSidecar æ¨¡å¼éƒ¨ç½²ï¼Œå…¶ä¸­åŒ…å«å„ç§æ„å»ºå—ï¼‰è‡ªåŠ¨å¸®æˆ‘ä»¬å¯¹æ¥äº†åç«¯ç»„ä»¶ï¼ˆComponentï¼‰ï¼›\n- åœ¨åº”ç”¨ç¨‹åºé¢†åŸŸï¼šOAM æ—¨åœ¨å»ºç«‹ä¸€ä¸ªåº”ç”¨æ¨¡å‹æ ‡å‡†ï¼Œé€šè¿‡ç»„ä»¶ã€ç‰¹å¾ã€ç­–ç•¥å’Œå·¥ä½œæµæ¥ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼›\n\nä¸‹å›¾å±•ç¤ºäº† Istio åœ¨äº‘åŸç”Ÿéƒ¨ç½²ä¸­å®šä½äºä¸ƒå±‚ç½‘æ ¼ç®¡ç†ã€‚\n\n![Istio åœ¨äº‘åŸç”Ÿæ¶æ„ä¸­å®šä½åœ¨ä¸ƒå±‚ç½‘ç»œ](istio-role.svg)\n\n{{\u003ccallout note \u0022Dapr ä¸ Istio æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ\u0022\u003e}}\n\nåœ¨äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­ï¼ŒIstio å’Œ Dapr åŒæ—¶ä½äºä¸­é—´ä»¶å±‚ï¼Œå®ƒä»¬ä¹‹é—´æœ‰å¾ˆå¤šåŒºåˆ«å’Œè”ç³»ã€‚\n\nIstio å’Œ Dapr ä¹‹é—´çš„ç›¸åŒç‚¹ï¼š\n\n- Istio å’Œ Dapr éƒ½å¯ä»¥ä½¿ç”¨ Sidecar æ¨¡å¼çš„éƒ¨ç½²æ¨¡å‹ï¼›\n- åŒå±äºä¸­é—´ä»¶ï¼ŒåŒæ ·å¯ä»¥ç®¡ç†æœåŠ¡é—´é€šä¿¡ï¼›\n\nIstio å’Œ Dapr ä¹‹é—´çš„ä¸åŒç‚¹ï¼š\n- ç›®æ ‡ä¸åŒï¼šIstio çš„ç›®æ ‡æ˜¯æ„å»ºé›¶ä¿¡ä»»ç½‘ç»œï¼Œå®šä¹‰æœåŠ¡é—´é€šä¿¡æ ‡å‡†ï¼ŒDapr ç›®æ ‡æ˜¯æ„å»ºæ ‡å‡†çš„ä¸­é—´ä»¶èƒ½åŠ›çš„ APIï¼›\n- æ¶æ„ä¸åŒï¼šIstio = Envoy \u002b é€æ˜æµé‡åŠ«æŒ \u002b æ§åˆ¶å¹³é¢ï¼ŒDapr = å¤šè¯­è¨€ SDK \u002b æ ‡å‡†åŒ– API \u002b åˆ†å¸ƒå¼èƒ½åŠ›ç»„ä»¶ï¼›\n- é¢å‘çš„äººç¾¤ä¸åŒï¼šä½†æ˜¯åº”ç”¨ Istio å¯¹äºå¼€å‘è€…æ¥è¯´å‡ ä¹æ— æ„ŸçŸ¥ï¼Œä¸»è¦éœ€è¦åŸºç¡€è®¾æ–½è¿ç»´å›¢é˜Ÿå®æ–½ï¼Œè€Œåº”ç”¨ Dapr éœ€è¦å¼€å‘è€…è‡ªä¸»é€‰æ‹©é›†æˆ Dapr SDKï¼›\n\n{{\u003c\/callout\u003e}}\n\n## æœåŠ¡ç½‘æ ¼çš„æœªæ¥{#istio-future}\n\næˆ‘åœ¨å‰æ–‡ä¸­ä»‹ç»äº† Istio çš„å‘å±•è„‰ç»œåŠå¼€æºç”Ÿæ€ï¼Œæ¥ä¸‹æ¥æˆ‘å°†ä¸ºå¤§å®¶ä»‹ç» Istio æœåŠ¡ç½‘æ ¼çš„æœªæ¥è¶‹åŠ¿ï¼š\n\n- æ„å»ºé›¶ä¿¡ä»»ç½‘ç»œ\n- æˆä¸ºæ··åˆäº‘ç®¡ç†å¹³å°çš„ç½‘ç»œåŸºç¡€è®¾æ–½\n\n\u003e *æœåŠ¡ç½‘æ ¼çš„æœªæ¥åœ¨äºæˆä¸ºé›¶ä¿¡ä»»ç½‘ç»œå’Œæ··åˆäº‘çš„åŸºç¡€è®¾æ–½ã€‚*\n\nè¿™ä¹Ÿæ˜¯ç¬”è€…æ‰€åœ¨çš„å…¬å¸ä¼ä¸šçº§æœåŠ¡ç½‘æ ¼æä¾›å•† [Tetrate](https:\/\/www.tetrate.io\/) çš„åŠªåŠ›æ–¹å‘ï¼Œæˆ‘ä»¬è‡´åŠ›äºæ„å»ºä¸€ä¸ªåŸºäºé›¶ä¿¡ä»»çš„é€‚ç”¨äºä»»æ„ç¯å¢ƒã€ä»»æ„è´Ÿè½½çš„åº”ç”¨æ„ŸçŸ¥ç½‘ç»œã€‚ä¸‹é¢å±•ç¤ºçš„æ˜¯ Tetrate æ——èˆ°äº§å“ [Tetrate Service Bridge](https:\/\/www.tetrate.io\/tetrate-service-bridge\/) çš„æ¶æ„å›¾ã€‚\n\n![TSB æ¶æ„å›¾](tsb.svg)\n\nTetrate å…¬å¸æ˜¯ç”± Istio é¡¹ç›®çš„å‘èµ·äººåˆ›ç«‹çš„ï¼ŒTSB æ˜¯åŸºäºå¼€æºçš„ Istioã€Envoy å’Œ Apache SkyWalking å¼€å‘çš„ã€‚æˆ‘ä»¬åŒæ—¶ç§¯æå¾—è´¡çŒ®ä¸Šæ¸¸ç¤¾åŒºï¼Œå¹¶å‚ä¸äº†æ—¨åœ¨ç®€åŒ–å°† Envoy ç½‘å…³ä½¿ç”¨çš„ [Envoy Gateway](https:\/\/github.com\/envoyproxy\/gateway) é¡¹ç›®çš„åˆ›å»ºï¼ˆä¸Šå›¾ä¸­çš„ XCP å³ä½¿ç”¨ Envoy æ„å»ºçš„ç½‘å…³ï¼‰ã€‚\n\n## é›¶ä¿¡ä»»{#zero-trust}\n\né›¶ä¿¡ä»»ï¼ˆZero Trustï¼‰æ˜¯ IstioCon 2022 é‡Œçš„ä¸€ä¸ªé‡è¦è¯é¢˜ï¼ŒIstio æ­£åœ¨æˆä¸ºé›¶ä¿¡ä»»ç½‘ç»œçš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚\n\n{{\u003ccallout note \u0022ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Ÿ\u0022\u003e}}\né›¶ä¿¡ä»»ï¼ˆZero Trustï¼‰æ˜¯ä¸€ç§å®‰å…¨ç†å¿µï¼Œè€Œä¸æ˜¯ä¸€ç§æ‰€æœ‰å®‰å…¨å›¢é˜Ÿéƒ½è¦éµå¾ªçš„æœ€ä½³å®è·µã€‚é›¶ä¿¡ä»»æ¦‚å¿µçš„æå‡ºæ˜¯ä¸ºäº†ç»™äº‘åŸç”Ÿä¸–ç•Œå¸¦æ¥æ›´å®‰å…¨çš„ç½‘ç»œã€‚é›¶ä¿¡ä»»æ˜¯ä¸€ç§ç†è®ºçŠ¶æ€ï¼Œå³ç½‘ç»œå†…çš„æ‰€æœ‰æ¶ˆè´¹è€…ä¸ä»…æ²¡æœ‰ä»»ä½•æƒé™ï¼Œè€Œä¸”ä¹Ÿä¸å…·å¤‡å¯¹å‘¨å›´ç½‘ç»œçš„æ„ŸçŸ¥ã€‚é›¶ä¿¡ä»»çš„ä¸»è¦æŒ‘æˆ˜æ˜¯å°±è¶Šæ¥è¶Šç»†åŒ–çš„æˆæƒå’Œå’Œå¯¹ç”¨æˆ·æˆæƒçš„æ—¶é—´é™åˆ¶ã€‚å…³äºæ›´å¤šé›¶ä¿¡ä»»çš„ä»‹ç»ï¼Œè¯·é˜…è¯»[è¿™ç¯‡åšå®¢](\/blog\/what-is-zero-trust\/)ã€‚\n{{\u003c\/callout\u003e}}\n\n### èº«ä»½è®¤è¯{#authn}\n\né›¶ä¿¡ä»»ç½‘ç»œä¸­æœ€é‡è¦çš„æ˜¯**é¢å‘èº«ä»½çš„æ§åˆ¶**è€Œä¸æ˜¯é¢å‘ç½‘ç»œçš„æ§åˆ¶ã€‚Istio 1.14 ä¸­å¢åŠ äº†å¯¹ SPIRE çš„æ”¯æŒï¼ŒSPIREï¼ˆSPIFFE Runtime Environmentï¼ŒCNCF å­µåŒ–é¡¹ç›®ï¼‰æ˜¯ SPIFFEï¼ˆSecure Production Identity Framework For Everyoneï¼ŒCNCF å­µåŒ–é¡¹ç›®ï¼‰çš„ä¸€ä¸ªå®ç°ã€‚åœ¨ Kubernetes ä¸­æˆ‘ä»¬ä½¿ç”¨ [ServiceAccount](\/book\/kubernetes-handbook\/auth\/serviceaccount\/) ä¸º Pod ä¸­çš„å·¥ä½œè´Ÿè½½æä¾›èº«ä»½ä¿¡æ¯ï¼Œå…¶æ ¸å¿ƒæ˜¯åŸºäº Tokenï¼ˆä½¿ç”¨ Secret èµ„æºå­˜å‚¨ï¼‰æ¥è¡¨ç¤ºè´Ÿè½½èº«ä»½ã€‚è€Œ Token æ˜¯ Kubernetes é›†ç¾¤ä¸­çš„èµ„æºï¼Œå¯¹äºå¤šé›†ç¾¤åŠè¿è¡Œåœ¨é Kubernetes ç¯å¢ƒï¼ˆä¾‹å¦‚è™šæ‹Ÿæœºï¼‰ä¸­çš„è´Ÿè½½ï¼Œå¦‚ä½•ç»Ÿä¸€å®ƒä»¬çš„èº«ä»½ï¼Ÿè¿™å°±æ˜¯ SPIFFE è¦è§£å†³çš„é—®é¢˜ã€‚\n\nSPIFFE çš„ç›®çš„æ˜¯åŸºäºé›¶ä¿¡ä»»çš„ç†å¿µï¼Œå»ºç«‹ä¸€ä¸ªå¼€æ”¾ã€ç»Ÿä¸€çš„å·¥ä½œè´Ÿè½½èº«ä»½æ ‡å‡†ï¼Œè¿™æœ‰åŠ©äºå»ºç«‹ä¸€ä¸ªé›¶ä¿¡ä»»çš„å…¨é¢èº«ä»½åŒ–çš„æ•°æ®ä¸­å¿ƒç½‘ç»œã€‚SPIFFE çš„æ ¸å¿ƒæ˜¯é€šè¿‡ç®€å• API å®šä¹‰äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçŸ­æš‚çš„åŠ å¯†èº«ä»½æ–‡ä»¶â€”â€” SVIDï¼ˆSPFFE Verifiable Identity Documentï¼‰ï¼Œç”¨ä½œå·¥ä½œè´Ÿè½½è®¤è¯æ—¶ä½¿ç”¨çš„èº«ä»½æ–‡ä»¶ï¼ˆåŸºäº X.509 è¯ä¹¦æˆ– JWT ä»¤ç‰Œï¼‰ã€‚SPIRE å¯ä»¥æ ¹æ®ç®¡ç†å‘˜å®šä¹‰çš„ç­–ç•¥è‡ªåŠ¨è½®æ¢ SVID è¯ä¹¦å’Œç§˜é’¥ï¼ŒåŠ¨æ€åœ°æä¾›å·¥ä½œè´Ÿè½½æ ‡è¯†ï¼ŒåŒæ—¶ Istio å¯ä»¥é€šè¿‡ SPIRE åŠ¨æ€çš„æ¶ˆè´¹è¿™äº›å·¥ä½œè´Ÿè½½æ ‡è¯†ã€‚\n\nåŸºäº Kubernetes çš„ SPIRE æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\n\n![SPIRE éƒ¨ç½²åœ¨ Kubernetes ä¸­çš„æ¶æ„å›¾](spire-with-kubernetes.svg)\n\nIstio ä¸­åŸå…ˆæ˜¯ä½¿ç”¨ Istiod ä¸­ Citadel æœåŠ¡ [^17] è´Ÿè´£æœåŠ¡ç½‘æ ¼ä¸­è¯ä¹¦ç®¡ç†ï¼Œé€šè¿‡ xDSï¼ˆå‡†ç¡®çš„è¯´æ˜¯ SDS APIï¼‰åè®®å°†è¯ä¹¦ä¸‹å‘ç»™æ•°æ®å¹³é¢ã€‚æœ‰äº† SPIRE ä¹‹åï¼Œè¯ä¹¦ç®¡ç†çš„å·¥ä½œå°±äº¤ç»™äº† SPIRE Serverã€‚SPIRE åŒæ ·æ”¯æŒ Envoy SDS APIï¼Œæˆ‘ä»¬åœ¨ Istio ä¸­å¯ç”¨ SPIRE ä¹‹åï¼Œè¿›å…¥å·¥ä½œè´Ÿè½½ Pod ä¸­çš„æµé‡åœ¨è¢«é€æ˜æ‹¦æˆªåˆ° Sidecar ä¸­åï¼Œä¼šç»è¿‡ä¸€æ¬¡èº«ä»½è®¤è¯ã€‚èº«ä»½è®¤è¯çš„ç›®çš„æ˜¯å¯¹æ¯”è¯¥å·¥ä½œè´Ÿè½½çš„èº«ä»½ï¼Œä¸å®ƒæ‰€è¿è¡Œçš„ç¯å¢ƒä¿¡æ¯ï¼ˆæ‰€åœ¨çš„èŠ‚ç‚¹ã€Pod çš„ ServiceAccount å’Œ Namespace ç­‰ï¼‰æ˜¯å¦ä¸€è‡´ï¼Œä»¥é˜²æ­¢ä¼ªé€ èº«ä»½ã€‚è¯·å‚è€ƒ[å¦‚ä½•åœ¨ Istio ä¸­é›†æˆ SPIRE](\/blog\/how-to-integrate-spire-with-istio\/) ä»¥äº†è§£å¦‚ä½•åœ¨ Istio ä¸­ä½¿ç”¨ SPIRE åšèº«ä»½è®¤è¯ã€‚\n\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Kubernetes Workload Registrar](https:\/\/github.com\/spiffe\/spire\/blob\/main\/support\/k8s\/k8s-workload-registrar\/README.md) åœ¨ Kubernetes ä¸­éƒ¨ç½² SPIREï¼Œå®ƒä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨æ³¨å†Œ Kubernetes ä¸­çš„å·¥ä½œè´Ÿè½½å¹¶ç”Ÿæˆ SVIDã€‚è¯¥æ³¨å†Œæœºæ˜¯ Server-Agent æ¶æ„ï¼Œå®ƒåœ¨æ¯ä¸ª Node ä¸Šéƒ¨ç½²ä¸€ä¸ª SPIRE Agentï¼ŒAgent ä¸å·¥ä½œè´Ÿè½½é€šè¿‡å…±äº«çš„ UNIX Domain Socket é€šä¿¡ã€‚é›¶ä¿¡ä»»ç½‘ç»œä¸­æ¯ä¸ªæµé‡ä¼šè¯éƒ½éœ€è¦ç»è¿‡èº«ä»½è®¤è¯ï¼ŒIstio åœ¨é€æ˜æµé‡åŠ«æŒæ—¶ï¼ŒSidecar åŒæ—¶å¯¹æµé‡è¯·æ±‚è¿›è¡Œèº«ä»½è®¤è¯ã€‚ä¸‹å›¾å±•ç¤ºäº†åœ¨ Istio ä¸­ä½¿ç”¨ SPIRE è¿›è¡Œèº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚\n\n![Istio ä¸­åŸºäº SPIRE çš„å·¥ä½œè´Ÿè½½èº«ä»½è®¤è¯è¿‡ç¨‹ç¤ºæ„å›¾](workload-attestation.svg)\n\nIstio ä¸­ä½¿ç”¨ SPIRE è¿›è¡Œå·¥ä½œè´Ÿè½½è®¤è¯çš„æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. å·¥ä½œè´Ÿè½½çš„ sidecar ä¸­çš„ \u0060pilot-agent\u0060 é€šè¿‡å…±äº«çš„ UDS è°ƒç”¨ SPIRE Agent æ¥è·å– SVID å¹¶ç¼“å­˜åœ¨ SPIRE Agent ä¸­ç”¨äºåç»­èº«ä»½è®¤è¯ï¼›\n2. SPIRE Agent è¯¢é—® Kubernetesï¼ˆå‡†ç¡®çš„è¯´æ˜¯èŠ‚ç‚¹ä¸Šçš„ kubeletï¼‰è·å–å·¥ä½œè´Ÿè½½çš„ä¿¡æ¯ï¼Œå¦‚æ‰€åœ¨çš„ namespaceã€èŠ‚ç‚¹åç§°ã€æœåŠ¡è´¦å·ç­‰ï¼›\n3. Kubelet æŠŠä» API æœåŠ¡å™¨ä¸­æŸ¥è¯¢åˆ°çš„ä¿¡æ¯è¿”å›ç»™å·¥ä½œè´Ÿè½½éªŒè¯å™¨ï¼›\n4. éªŒè¯å™¨å°† kubelet è¿”å›çš„ç»“æœä¸ SPIRE æŸ¥è¯¢å¾—åˆ°çš„èº«ä»½ä¿¡æ¯æ¯”å¯¹ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™å°†æ­£ç¡®çš„ SVID ç¼“å­˜è¿”å›ç»™å·¥ä½œè´Ÿè½½ï¼Œå¦‚æœä¸åŒåˆ™è®¤è¯å¤±è´¥ï¼Œæ‹’ç»æµé‡è¯·æ±‚ï¼›\n\nå…³äºå·¥ä½œè´Ÿè½½çš„æ³¨å†Œå’Œè®¤è¯çš„è¯¦ç»†è¿‡ç¨‹è¯·å‚è€ƒ [SPIRE æ–‡æ¡£](\/book\/kubernetes-handbook\/auth\/spire\/) ã€‚\n\n### NGAC\n\nå½“æ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½æœ‰å‡†ç¡®çš„èº«ä»½ä¹‹åï¼Œå¦‚ä½•å¯¹è¿™äº›èº«ä»½çš„æƒé™è¿›è¡Œé™åˆ¶ï¼ŸKubernetes ä¸­é»˜è®¤ä½¿ç”¨ RBAC æ¥åšè®¿é—®æ§åˆ¶ï¼Œæ­£å¦‚å…¶åï¼Œè¿™ç§è®¿é—®æ§åˆ¶æ˜¯åŸºäºè§’è‰²çš„ï¼Œè™½ç„¶ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¯¹äºå¤§è§„æ¨¡é›†ç¾¤ï¼Œå­˜åœ¨è§’è‰²çˆ†ç‚¸é—®é¢˜ â€”â€” å³å­˜åœ¨å¤ªå¤šè§’è‰²ï¼Œè€Œä¸”è§’è‰²çš„ç±»å‹ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéš¾ä»¥å¯¹è§’è‰²æƒé™æœºå‹è·Ÿè¸ªå’Œå®¡è®¡ã€‚å¦å¤– RBAC ä¸­çš„è§’è‰²çš„è®¿é—®æƒé™æ˜¯å›ºå®šï¼Œæ²¡æœ‰è§„å®šçŸ­æš‚çš„ä½¿ç”¨æƒé™ï¼Œä¹Ÿæ²¡æœ‰è€ƒè™‘ä½ç½®ã€æ—¶é—´æˆ–è®¾å¤‡ç­‰å±æ€§ã€‚ä½¿ç”¨ RBAC çš„ä¼ä¸šå¾ˆéš¾æ»¡è¶³å¤æ‚çš„è®¿é—®æ§åˆ¶è¦æ±‚ï¼Œä»¥æ»¡è¶³å…¶ä»–ç»„ç»‡éœ€æ±‚çš„ç›‘ç®¡è¦æ±‚ã€‚\n\nNGACï¼Œå³ä¸‹ä¸€ä»£è®¿é—®æ§åˆ¶ï¼Œé‡‡ç”¨å°†è®¿é—®å†³å®šæ•°æ®å»ºæ¨¡ä¸º DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰çš„æ–¹æ³•ã€‚NGAC å¯ä»¥å®ç°ç³»ç»ŸåŒ–ã€ç­–ç•¥ä¸€è‡´çš„è®¿é—®æ§åˆ¶æ–¹æ³•ï¼Œä»¥é«˜ç²¾ç»†åº¦æˆäºˆæˆ–æ‹’ç»ç”¨æˆ·ç®¡ç†èƒ½åŠ›ã€‚NGAC ç”± [NIST](https:\/\/www.nist.gov\/) ï¼ˆç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶æ‰€ï¼‰å¼€å‘ï¼Œç›®å‰å·²ç”¨äº [Tetrate Service Bridge](https:\/\/www.tetrate.io\/tetrate-service-bridge\/) ä¸­çš„æƒé™ç®¡ç†ã€‚å…³äºä¸ºä»€ä¹ˆé€‰æ‹© NGACï¼Œè€Œä¸æ˜¯ ABAC å’Œ RBAC çš„æ›´å¤šå†…å®¹è¯·å‚è€ƒåšå®¢[ä¸ºä»€ä¹ˆåº”è¯¥é€‰æ‹©ä½¿ç”¨ NGAC ä½œä¸ºæƒé™æ§åˆ¶æ¨¡å‹](\/blog\/why-you-should-choose-ngac-as-your-access-control-model\/)ã€‚\n\n## æ··åˆäº‘{#hybrid-cloud}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å‡ºäºè´Ÿè½½å‡è¡¡ã€éš”ç¦»å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒã€è§£è€¦æ•°æ®å¤„ç†å’Œæ•°æ®å­˜å‚¨ã€è·¨äº‘å¤‡ä»½å’Œç¾éš¾æ¢å¤ä»¥åŠé¿å…å‚å•†é”å®šç­‰åŸå› ï¼Œåœ¨å¤šç§ç¯å¢ƒä¸‹éƒ¨ç½²å¤šä¸ª Kubernetes é›†ç¾¤ã€‚Kubernetes ç¤¾åŒºæä¾›äº†ã€Œé›†ç¾¤è”é‚¦ã€åŠŸèƒ½å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºå¤šé›†ç¾¤æ¶æ„ï¼Œä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¸€ç§å¸¸ç”¨çš„ Kubernetes å¤šé›†ç¾¤æ¶æ„ï¼Œå…¶ä¸­ Host Cluster ä½œä¸ºæ§åˆ¶å¹³é¢ï¼Œæœ‰ä¸¤ä¸ªæˆå‘˜é›†ç¾¤ï¼Œåˆ†åˆ«æ˜¯ West å’Œ Eastã€‚\n\n![Kubernetes é›†ç¾¤è”é‚¦æ¶æ„](multicluster.svg)\n\né›†ç¾¤è”é‚¦è¦æ±‚ Host é›†ç¾¤ä¸æˆå‘˜é›†ç¾¤çš„ä¹‹é—´çš„ç½‘ç»œèƒ½å¤Ÿäº’é€šï¼Œå¯¹æˆå‘˜é›†ç¾¤ä¹‹é—´çš„ç½‘ç»œè¿æ¥æ€§æ²¡æœ‰è¦æ±‚ã€‚Host é›†ç¾¤ä½œä¸º API å…¥å£ï¼Œå¤–ç•Œæ‰€æœ‰å¯¹ Host é›†ç¾¤çš„èµ„æºè¯·æ±‚ä¼šè½¬å‘åˆ°æˆå‘˜é›†ç¾¤ä¸­ã€‚Host é›†ç¾¤ä¸­éƒ¨ç½²æœ‰é›†ç¾¤è”é‚¦çš„æ§åˆ¶å¹³é¢ï¼Œå…¶ä¸­çš„ã€ŒPush Reconcilerã€ä¼šå°†è”é‚¦ä¸­çš„èº«ä»½ã€è§’è‰²åŠè§’è‰²ç»‘å®šä¼ æ’­åˆ°æ‰€æœ‰çš„æˆå‘˜é›†ç¾¤ä¸­ã€‚é›†ç¾¤è”é‚¦åªæ˜¯ç®€å•åœ°å°†å¤šä¸ªé›†ç¾¤ç®€å•çš„ã€Œè¿æ¥åˆ°äº†ä¸€èµ·ã€ï¼Œåœ¨å¤šä¸ªé›†ç¾¤ä¹‹é—´å¤åˆ¶å·¥ä½œè´Ÿè½½ï¼Œè€Œæˆå‘˜é›†ç¾¤ä¹‹é—´çš„æµé‡æ— æ³•è°ƒåº¦ï¼Œä¹Ÿæ— æ³•å®ç°çœŸæ­£çš„å¤šç§Ÿæˆ·ã€‚\n\né›†ç¾¤è”é‚¦ä¸è¶³ä»¥å®ç°æ··åˆäº‘ï¼Œä¸ºäº†å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„æ··åˆäº‘ï¼Œå°±è¦è®©é›†ç¾¤ä¹‹é—´åšåˆ°äº’è”äº’é€šï¼ŒåŒæ—¶å®ç°å¤šç§Ÿæˆ·ã€‚TSB åœ¨ Istio ä¹‹ä¸Šæ„å»ºä¸€ä¸ªå¤šé›†ç¾¤ç®¡ç†çš„é€šç”¨æ§åˆ¶å¹³é¢ï¼Œç„¶åå†å¢åŠ ä¸€ä¸ªç®¡ç†å¹³é¢æ¥ç®¡ç†å¤šé›†ç¾¤ï¼Œæä¾›å¤šç§Ÿæˆ·ã€ç®¡ç†é…ç½®ã€å¯è§‚æµ‹æ€§ç­‰åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯ Istio ç®¡ç†å¹³é¢çš„å¤šç§Ÿæˆ·å’Œ API ç¤ºæ„å›¾ã€‚\n\n![TSB åœ¨ Istio ä¹‹ä¸Šæ„å»ºçš„ç®¡ç†å¹³é¢ç¤ºæ„å›¾](tsb-management-plane.svg)\n\nTSB ä¸ºç®¡ç†æ··åˆäº‘ï¼ŒåŸºäº Istio æ„å»ºäº†ä¸€ä¸ªç®¡ç†å¹³é¢ï¼Œæ–°å»ºäº† Tenant å’Œ Workspace çš„èµ„æºï¼Œå¹¶é€šè¿‡é€‰æ‹©å™¨ï¼Œå°†ç½‘å…³ç»„ã€æµé‡ç»„å’Œå®‰å…¨ç»„åº”ç”¨åˆ°å¯¹åº”é›†ç¾¤ä¸­çš„å·¥ä½œè´Ÿè½½ä¸Šã€‚å…³äº TSB çš„è¯¦ç»†æ¶æ„è¯·å‚è€ƒ TSB æ–‡æ¡£ã€‚\n\n## æ›´å¤š{#more}\n\nå¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº Istio å’Œäº‘åŸç”Ÿçš„å†…å®¹ï¼Œä¸‹é¢æœ‰ä¸€äº›èµ„æ–™åˆ†äº«ç»™ä½ ï¼š\n\n- ä¸ºäº†å¸®åŠ©å¤§å®¶æ›´å¥½çš„äº†è§£ Istio å’Œäº‘åŸç”Ÿï¼Œç¬”è€…åœ¨ 2020 å¹´å‘èµ·äº†[äº‘åŸç”Ÿç¤¾åŒº](https:\/\/cloudnative.to)ï¼Œæ¬¢è¿å¤§å®¶åŠ å…¥æˆ‘ä»¬ä¸€èµ·æ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼ï¼›\n- 2022 å¹´ 6 æœˆï¼Œäº‘åŸç”Ÿç¤¾åŒºè‘—çš„[ã€Šæ·±å…¥ç†è§£ Istio â€”â€” äº‘åŸç”ŸæœåŠ¡ç½‘æ ¼è¿›é˜¶å®æˆ˜ã€‹](\/blog\/istio-service-mesh-book\/)å·²å›¾ä¹¦ç”±ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾å‡ºç‰ˆï¼Œæ¬¢è¿å¤§å®¶è´­ä¹°ï¼›\n- ç¬”è€…äº 2022 å¹´ 5 æœˆï¼Œå°†ä¹‹å‰æ‰€ä½œç”µå­ä¹¦ã€æ•™ç¨‹å’Œè¯‘æ–‡å…¨éƒ¨è¿ç§»åˆ°äº†[äº‘åŸç”Ÿèµ„æ–™åº“](\/book\/)æ¬¢è¿é˜…è¯»å’Œç•™è¨€è¯„è®ºã€‚\n\n## å‚è€ƒ\n\n[^1]: æœ‰å…³ Envoy å¼€æºçš„è¯¦ç»†è¿‡ç¨‹ï¼Œæ¨èä½ é˜…è¯» Envoy ä½œè€… Matt Klein çš„è¿™ç¯‡æ–‡ç« [ç½‘ç»œä»£ç† Envoy å¼€æºäº”å‘¨å¹´ï¼Œåˆ›å§‹äºº Matt Klein äº²è¿°å¼€æºå¿ƒè·¯å†ç¨‹åŠç»éªŒæ•™è®­](https:\/\/cloudnative.to\/blog\/envoy-oss-5-year\/)ã€‚\n\n[^2]: åæ¥ IBM ä¸ Google åç›®ï¼Œå¤§ä¸¾æŠ¨å‡» Google æ²¡æœ‰éµå®ˆå°† Istio æçŒ®ç»™ CNCF çš„çº¦å®šï¼ŒGoogle å¯¹ Istio å•†æ ‡çš„ç®¡ç†ä¹Ÿå—åˆ°äº†[è´¨ç–‘](https:\/\/thenewstack.io\/googles-management-of-the-istio-service-mesh-raises-questions-in-the-cloud-native-community\/)ã€‚\n[^3]: 2018 å¹´ï¼ŒCNCF ä¸ºäº‘åŸç”Ÿçš„é‡æ–°å®šä¹‰æ˜¯ï¼šäº‘åŸç”ŸæŠ€æœ¯æœ‰åˆ©äºå„ç»„ç»‡åœ¨å…¬æœ‰äº‘ã€ç§æœ‰äº‘å’Œæ··åˆäº‘ç­‰æ–°å‹åŠ¨æ€ç¯å¢ƒä¸­ï¼Œæ„å»ºå’Œè¿è¡Œå¯å¼¹æ€§æ‰©å±•çš„åº”ç”¨ã€‚äº‘åŸç”Ÿçš„ä»£è¡¨æŠ€æœ¯åŒ…æ‹¬å®¹å™¨ã€æœåŠ¡ç½‘æ ¼ã€å¾®æœåŠ¡ã€ä¸å¯å˜åŸºç¡€è®¾æ–½å’Œå£°æ˜å¼ APIã€‚\n[^4]: Day-2 Operation æ˜¯åœ¨ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸç»“æŸå‰ï¼Œå¯¹ç³»ç»Ÿä¸æ–­æ”¹è¿›çš„è¿‡ç¨‹ï¼Œä»¥å®ç°æ•ˆç›Šæœ€å¤§åŒ–ã€‚å‚è€ƒ [ä»€ä¹ˆæ˜¯ Day-2 Operation](https:\/\/jimmysong.io\/blog\/what-is-day-2-operation\/)ã€‚\n[^5]: Istio ç°å·²æ¨å‡º proxyless æ¨¡å¼æµ‹è¯•ç‰ˆï¼Œè¯¦è§ [åŸºäº gRPC å’Œ Istio çš„æ—  sidecar ä»£ç†çš„æœåŠ¡ç½‘æ ¼](https:\/\/cloudnative.to\/blog\/grpc-proxyless-service-mesh\/)ã€‚\n[^6]: Kubernetes é¢„è®¡æ¨å‡º [Gateway API](\/book\/kubernetes-handbook\/service-discovery\/gateway\/)ï¼ŒIstio ä¹Ÿæœ‰è®¡åˆ’ä½¿ç”¨ Kubernetes çš„ Gateway API æ›¿æ¢å½“å‰ Istio è‡ªå®šä¹‰çš„ Gateway èµ„æºã€‚\n[^7]: æœ‰å…³æœåŠ¡ç½‘æ ¼é¡¹ç›®çš„è¯¦ç»†å¯¹æ¯”è¯·å‚è€ƒ [servicemesh.es](https:\/\/servicemesh.es\/) ç½‘ç«™ã€‚\n[^8]: ã€Š[å‘Šåˆ« Sidecarâ€”â€” ä½¿ç”¨ eBPF è§£é”å†…æ ¸çº§æœåŠ¡ç½‘æ ¼](https:\/\/cloudnative.to\/blog\/ebpf-solve-service-mesh-sidecar\/)ã€‹è¿™ç¯‡æ–‡ç« åœ¨äº‘åŸç”Ÿç¤¾åŒºé‡Œå¼•èµ·äº†ä¸€ç³»åˆ—å…³äºæœåŠ¡ç½‘æ ¼å°†è¢« eBPF æŠ€æœ¯æ‰€å–ä»£çš„è®¨è®ºã€‚[è¯·æš‚æ—¶æŠ›å¼ƒä½¿ç”¨ eBPF å–ä»£æœåŠ¡ç½‘æ ¼å’Œ sidecar æ¨¡å¼çš„å¹»æƒ³](https:\/\/jimmysong.io\/blog\/epbf-sidecar-and-service-mesh\/)ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ eBPFï¼Œåœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼éƒ½ä¼šåŸºäºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ sidecar ä»£ç†ï¼ˆproxyless æ¨¡å¼é™¤å¤–ï¼‰ã€‚\n[^9]: åœ¨ç™¾åº¦çš„æœåŠ¡ç½‘æ ¼å›¢é˜Ÿåˆ†äº«çš„ [æ®Šé€”åŒå½’ï¼ŒProxyless Service Mesh åœ¨ç™¾åº¦çš„å®è·µä¸æ€è€ƒ](https:\/\/mp.weixin.qq.com\/s\/G8vmlJyaimux_K-548kFbA) è¿™ç¯‡æ–‡ç« é‡Œï¼Œè¯¦ç»†ä»‹ç»äº†ç™¾åº¦çš„æœåŠ¡ç½‘æ ¼é‡‡ç”¨è·¯å¾„ï¼Œä»¥åŠå¯¹æœåŠ¡ç½‘æ ¼æœ¬è´¨çš„æ¢ç´¢ã€‚\n[^10]: å…³äº xDS åè®®ï¼Œè¯·å‚è€ƒ [Envoy ä¸­çš„ xDS REST å’Œ gRPC åè®®è¯¦è§£](https:\/\/cloudnative.to\/blog\/envoy-xds-protocol\/) è¿™ç¯‡æ–‡ç« ã€‚\n[^11]: [PEP](https:\/\/www.oreilly.com\/library\/view\/network-access-control\/9780470398678\/9780470398678_policy_enforcement_point.html)ï¼Œå…¨ç§° Policy Enforcement Pointï¼Œç­–ç•¥æ‰§è¡Œç‚¹ï¼ˆPEPï¼‰æ˜¯æ§åˆ¶ç”¨æˆ·è®¿é—®å¹¶ç¡®ä¿ç­–ç•¥å†³ç­–ç‚¹ (PDP) åšå‡ºæˆæƒå†³ç­–çš„ç½‘ç»œæˆ–å®‰å…¨è®¾å¤‡ã€‚åœ¨ä¸€äº› NAC å®ç°ä¸­ï¼ŒPDP æ˜¯æœ‰çº¿äº¤æ¢æœºæˆ–æ— çº¿æ¥å…¥ç‚¹ã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼ŒPEP æ˜¯é˜²ç«å¢™ã€IPSã€æœåŠ¡å™¨æˆ–å†…è”è®¾å¤‡ã€‚æ ¹æ®å®æ–½æƒ…å†µï¼ŒPEP å’Œ PDP å¯ä»¥æ˜¯ç‹¬ç«‹è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥åˆå¹¶ä¸ºå•ä¸ªè®¾å¤‡ã€‚\n[^12]: Apache SkyWalking çš„ Rover ç»„ä»¶åˆ©ç”¨ eBPF æŠ€æœ¯æ”¹è¿›äº† SkyWalking çš„å‰–æåŠŸèƒ½ï¼Œå¯ç”¨äºåˆ†ææœåŠ¡ç½‘æ ¼çš„æ€§èƒ½é—®é¢˜ï¼Œè¯·å‚è€ƒ [ä½¿ç”¨ eBPF å‡†ç¡®å®šä½æœåŠ¡ç½‘æ ¼çš„å…³é”®æ€§èƒ½é—®é¢˜](https:\/\/cloudnative.to\/blog\/pinpoint-service-mesh-critical-performance-impact-by-using-ebpf\/)ã€‚\n[^13]: æœ‰å¤šå®¶å…¬å¸æ­£åœ¨åˆä½œå¼€å‘ Envoy Gatewayï¼ŒåŒ…æ‹¬ [Ambassador Labs](https:\/\/www.getambassador.io\/)ã€[Fidelity Investments](https:\/\/www.fidelity.com\/)ã€[Project Contour](https:\/\/projectcontour.io\/) å’Œ [VMware](https:\/\/www.vmware.com\/)ã€‚\n[^14]: Istio ä»…å¯ä»¥è·¯ç”± TCP æµé‡ï¼Œé»˜è®¤æ”¯æŒ HTTPã€HTTPSã€gRPC å’ŒåŸå§‹ TCP åè®®ï¼Œå…¶ä¸­ Sidecar å’Œ Gateway æ‰€æ”¯æŒçš„åè®®èŒƒå›´æœ‰æ‰€ä¸åŒï¼Œè¯¦è§ [Istio æ–‡æ¡£](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/traffic-management\/protocol-selection\/)ã€‚\n[^15]: SidecarScope æ˜¯åœ¨ Istio 1.1 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªç›´æ¥é¢å‘ç”¨æˆ·çš„é…ç½®é¡¹ï¼Œè€Œæ˜¯ Sidecar èµ„æºçš„åŒ…è£…å™¨ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ Sidecar èµ„æºä¸­çš„ \u0060egress\u0060 é€‰é¡¹ã€‚é€šè¿‡è¯¥é…ç½®å¯ä»¥å‡å°‘ Istio å‘ Sidecar ä¸‹å‘çš„æ•°æ®é‡ï¼Œä¾‹å¦‚åªå‘æŸä¸ªå‘½åç©ºé—´ä¸­çš„æŸäº›æœåŠ¡ä¸‹å‘æŸäº› hosts çš„è®¿é—®é…ç½®ï¼Œä»è€Œæé«˜åº”ç”¨æé«˜æ€§èƒ½ã€‚\n[^16]: \u0060pilot-agent\u0060 æ˜¯ sidecar å®¹å™¨ä¸­çš„ä¸»è¿›ç¨‹ï¼Œä½ å¯ä»¥åœ¨ [Istio çš„ç»„æˆæ¶æ„å›¾](#istio-components)ä¸­çœ‹åˆ°ã€‚\u0060pilot-agent\u0060 ä¸­çš„é•œåƒæå–æœºåˆ¶ï¼ˆåœ¨ Istio 1.9 ä¸­å¼•å…¥ï¼‰ï¼Œä»è¿œç¨‹ HTTP æºå¯é åœ°æ£€ç´¢ Wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå·²è¢«æ‰©å±•åˆ°æ”¯æŒä»ä»»ä½• OCI æ³¨å†Œå¤„æ£€ç´¢ Wasm OCI é•œåƒï¼ŒåŒ…æ‹¬ Docker Hubã€Google Container Registryï¼ˆGCRï¼‰ã€Amazon Elastic Container Registryï¼ˆAmazon ECRï¼‰å’Œå…¶ä»–åœ°æ–¹ã€‚\n[^17]: Istio å…·æœ‰èº«ä»½å’Œè¯ä¹¦ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥å®ç°æœåŠ¡é—´çš„ç»ˆç«¯ç”¨æˆ·è®¤è¯ï¼Œåœ¨æ§åˆ¶å¹³é¢è¿˜é‡‡ç”¨å¾®æœåŠ¡æ¶æ„çš„æ—¶å€™ï¼Œå…¶ä¸­çš„ Citadel ç»„ä»¶è´Ÿè´£è¯ä¹¦ç®¡ç†ï¼Œåœ¨ Istio 1.5 ç‰ˆæœ¬è¢«åˆå¹¶åˆ°å•ä½“ Istiod ä¸­äº†ã€‚\n', '\/blog\/beyond-istio-oss\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡ä»äº‘åŸç”Ÿå¤§èƒŒæ™¯ä¸‹é‡æ–°å®¡è§† Istioï¼Œè®²è§£ Istio è¯ç”Ÿï¼Œåœ¨äº‘åŸç”ŸæŠ€æœ¯æ ˆä¸­çš„åœ°ä½åŠå‘å±•æ–¹å‘ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/ebpf-sidecar-and-service-mesh/">è¯·æš‚æ—¶æŠ›å¼ƒä½¿ç”¨ eBPF å–ä»£æœåŠ¡ç½‘æ ¼å’Œ sidecar æ¨¡å¼çš„å¹»æƒ³</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/06/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('è¯·æš‚æ—¶æŠ›å¼ƒä½¿ç”¨ eBPF å–ä»£æœåŠ¡ç½‘æ ¼å’Œ sidecar æ¨¡å¼çš„å¹»æƒ³', 'ä¸ç®¡æœ‰æ²¡æœ‰ eBPFï¼Œåœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼éƒ½ä¼šåŸºäºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ sidecar ä»£ç†ï¼ˆproxyless æ¨¡å¼é™¤å¤–ï¼‰ã€‚', '\næœ€è¿‘ eBPF æŠ€æœ¯åœ¨äº‘åŸç”Ÿç¤¾åŒºä¸­æŒç»­ç«çƒ­ï¼Œåœ¨æˆ‘ç¿»è¯‘äº†ã€Š[ä»€ä¹ˆæ˜¯ eBPF](https:\/\/jimmysong.io\/book\/what-is-ebpf\/)ã€‹ä¹‹åï¼Œå½“é˜…è¯»â€œäº‘åŸç”Ÿç¯å¢ƒä¸­çš„ eBPFâ€ä¹‹åå°±ä¸€ç›´åœ¨æ€è€ƒ eBPF åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­ç©¶ç«Ÿå¤„äºä»€ä¹ˆåœ°ä½ï¼Œå‘æŒ¥ä»€ä¹ˆæ ·çš„ä½œç”¨ã€‚å½“æ—¶æˆ‘è¯„è®ºè¯´â€œeBPF å¼€å¯äº†ä¸Šå¸è§†è§’ï¼Œå¯ä»¥çœ‹åˆ°ä¸»æœºä¸Šæ‰€æœ‰çš„æ´»åŠ¨ï¼Œè€Œ sidecar åªèƒ½è§‚æµ‹åˆ° pod å†…çš„æ´»åŠ¨ï¼Œåªè¦æå¥½è¿›ç¨‹éš”ç¦»ï¼ŒåŸºäº eBPF çš„ proxy per-node æ‰æ˜¯æœ€ä½³é€‰æ‹©â€ï¼Œå†çœ‹åˆ° William Morgan çš„[è¿™ç¯‡æ–‡ç« ](https:\/\/buoyant.io\/2022\/06\/07\/ebpf-sidecars-and-the-future-of-the-service-mesh\/) [^1]ä¹‹åï¼Œè®©æˆ‘æç„¶å¤§æ‚Ÿã€‚ä¸‹é¢èŠ‚é€‰ç¿»è¯‘äº†æ–‡ç« æˆ‘æ¯”ç»ŸåŒæ„çš„è§‚ç‚¹ï¼Œå³ eBPF æ— æ³•æ›¿ä»£æœåŠ¡ç½‘æ ¼å’Œ sidecarï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯» William çš„åŸæ–‡ã€‚\n\n## ä»€ä¹ˆæ˜¯ eBPF\n\nåœ¨è¿‡å»ï¼Œå¦‚æœä½ æƒ³è®©åº”ç”¨ç¨‹åºå¤„ç†ç½‘ç»œæ•°æ®åŒ…ï¼Œé‚£æ˜¯ä¸å¯èƒ½çš„ã€‚å› ä¸ºåº”ç”¨ç¨‹åºè¿è¡Œåœ¨ Linux ç”¨æˆ·ç©ºé—´ï¼Œå®ƒæ˜¯ä¸èƒ½ç›´æ¥è®¿é—®ä¸»æœºçš„ç½‘ç»œç¼“å†²åŒºã€‚ç¼“å†²åŒºæ˜¯ç”±å†…æ ¸ç®¡ç†çš„ï¼Œå—åˆ°å†…æ ¸ä¿æŠ¤ï¼Œå†…æ ¸éœ€è¦ç¡®ä¿è¿›ç¨‹éš”ç¦»ï¼Œè¿›ç¨‹ä¹‹é—´ä¸èƒ½ç›´æ¥è¯»å–å¯¹æ–¹çš„ç½‘ç»œæ•°æ®åŒ…ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰æ¥è¯·æ±‚ç½‘ç»œæ•°æ®åŒ…ä¿¡æ¯ï¼Œè¿™æœ¬è´¨ä¸Šæ˜¯å†…æ ¸ API è°ƒç”¨â€”â€”åº”ç”¨ç¨‹åºè°ƒç”¨ syscallï¼Œå†…æ ¸æ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰æƒé™è·å¾—å…¶è¯·æ±‚çš„æ•°æ®åŒ…ï¼›å¦‚æœæœ‰ï¼Œå°±æŠŠè¿”å›æ•°æ®åŒ…ã€‚\n\næœ‰äº† eBPF ä¹‹åï¼Œåº”ç”¨ç¨‹åºä¸å†éœ€è¦ syscallï¼Œæ•°æ®åŒ…ä¸éœ€è¦åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´æ¥å›äº¤äº’ä¼ é€’ã€‚è€Œæ˜¯æˆ‘ä»¬å°†ä»£ç ç›´æ¥äº¤ç»™å†…æ ¸ï¼Œè®©å†…æ ¸è‡ªå·±æ‰§è¡Œï¼Œè¿™æ ·å°±å¯ä»¥è®©ä»£ç å…¨é€Ÿè¿è¡Œï¼Œæ•ˆç‡æ›´é«˜ã€‚eBPF å…è®¸åº”ç”¨ç¨‹åºå’Œå†…æ ¸ä»¥å®‰å…¨çš„æ–¹å¼å…±äº«å†…å­˜ï¼ŒeBPF å…è®¸åº”ç”¨ç¨‹åºç›´æ¥å‘å†…æ ¸æäº¤ä»£ç ï¼Œç›®æ ‡éƒ½æ˜¯é€šè¿‡è¶…è¶Šç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼æ¥å®ç°æ€§èƒ½æå‡ã€‚\n\neBPF ä¸æ˜¯é“¶å¼¹ï¼Œä½ ä¸èƒ½ç”¨ eBPF è¿è¡Œä»»æ„ç¨‹åºï¼Œå®é™…ä¸Š eBPF å¯ä»¥åšçš„äº‹æƒ…æ˜¯éå¸¸æœ‰é™çš„ã€‚\n\n## eBPF çš„å±€é™æ€§\n\neBPF çš„å±€é™æ€§ä¹Ÿæ˜¯å› ä¸ºå†…æ ¸é€ æˆçš„ã€‚å†…æ ¸ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºåº”å½“æœ‰è‡ªå·±çš„ç§Ÿæˆ·ï¼Œè¿™äº›ç§Ÿæˆ·ä¹‹é—´ä¼šäº‰æŠ¢ç³»ç»Ÿçš„å†…å­˜ã€ç£ç›˜å’Œç½‘ç»œï¼Œå†…æ ¸çš„èŒè´£å°±æ˜¯éš”ç¦»å’Œè°ƒåº¦è¿™äº›åº”ç”¨ç¨‹åºçš„èµ„æºï¼ŒåŒæ—¶å†…æ ¸è¿˜è¦ä¿æŠ¤ç¡®è®¤åº”ç”¨ç¨‹åºçš„æƒé™ï¼Œä¿æŠ¤å…¶ä¸è¢«å…¶ä»–ç¨‹åºç ´åã€‚\n\nå› ä¸ºæˆ‘ä»¬ç›´æ¥å°† eBPF ä»£ç äº¤ç»™å†…æ ¸æ‰§è¡Œï¼Œè¿™ç»•è¿‡äº†å†…æ ¸å®‰å…¨ä¿æŠ¤ï¼ˆå¦‚ syscallï¼‰ï¼Œå†…æ ¸å°†é¢ä¸´ç›´æ¥çš„å®‰å…¨é£é™©ã€‚ä¸ºäº†ä¿æŠ¤å†…æ ¸ï¼Œæ‰€æœ‰ eBPF ç¨‹åºè¦æƒ³è¿è¡Œéƒ½å¿…é¡»å…ˆé€šè¿‡ä¸€ä¸ª**éªŒè¯å™¨**ã€‚ä½†æ˜¯è¦æƒ³è‡ªåŠ¨éªŒè¯ç¨‹åºæ˜¯å¾ˆå›°éš¾çš„ï¼ŒéªŒè¯å™¨å¯èƒ½ä¼šè¿‡åº¦é™åˆ¶ç¨‹åºçš„åŠŸèƒ½ã€‚æ¯”å¦‚ eBPF ç¨‹åºä¸èƒ½æ˜¯é˜»å¡çš„ï¼Œä¸èƒ½æœ‰æ— é™å¾ªç¯ï¼Œä¸èƒ½è¶…è¿‡é¢„å®šçš„å¤§å°ï¼›å…¶å¤æ‚æ€§ä¹Ÿå—åˆ°é™åˆ¶ï¼ŒéªŒè¯å™¨ä¼šè¯„ä¼°æ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ï¼Œå¦‚æœ eBPF ç¨‹åºä¸èƒ½åœ¨æŸäº›èŒƒå›´å†…å®Œæˆï¼Œæˆ–è€…ä¸èƒ½è¯æ˜æ¯ä¸ªå¾ªç¯éƒ½æœ‰ä¸€ä¸ªé€€å‡ºæ¡ä»¶ï¼Œé‚£ä¹ˆéªŒè¯å™¨å°±ä¸ä¼šå…è®¸è¯¥ç¨‹åºè¿è¡Œã€‚æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºéƒ½è¿åäº†è¿™äº›é™åˆ¶ï¼Œè¦æƒ³å°†å®ƒä»¬ä½œä¸º eBPF ç¨‹åºæ¥è¿è¡Œçš„è¯ï¼Œè¦ä¹ˆé‡å†™ä»¥æ»¡è¶³éªŒè¯å™¨çš„éœ€æ±‚ï¼Œè¦ä¹ˆç»™å†…æ ¸æ‰“è¡¥ä¸ï¼Œæ¥ç»•è¿‡ä¸€äº›éªŒè¯ï¼ˆè¿™å¯èƒ½æ¯”è¾ƒå›°éš¾ï¼‰ã€‚ä¸è¿‡éšç€å†…æ ¸ç‰ˆæœ¬çš„å‡çº§ï¼Œè¿™äº›éªŒè¯å™¨ä¹Ÿå˜å¾—æ›´åŠ æ™ºèƒ½ï¼Œé™åˆ¶ä¹Ÿé€æ¸å˜å¾—å®½æ¾ï¼Œä¹Ÿæœ‰ä¸€äº›åˆ›é€ æ€§çš„æ–¹æ³•æ¥ç»•è¿‡è¿™äº›é™åˆ¶ã€‚\n\nä½†æ€»çš„æ¥è¯´ï¼ŒeBPF ç¨‹åºèƒ½åšçš„äº‹æƒ…éå¸¸æœ‰é™ã€‚å¯¹äºä¸€äº›é‡é‡çº§äº‹ä»¶çš„å¤„ç†ï¼Œä¾‹å¦‚å¤„ç†å…¨å±€èŒƒå›´å†…çš„ HTTP\/2 æµé‡ï¼Œæˆ–è€… TLS æ¡æ‰‹åå•†ä¸èƒ½åœ¨çº¯ eBPF ç¯å¢ƒä¸­å®Œæˆã€‚å……å…¶é‡ï¼ŒeBPF å¯ä»¥åšå…¶ä¸­çš„ä¸€å°éƒ¨åˆ†å·¥ä½œï¼Œç„¶åè°ƒç”¨ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæ¥å¤„ç†å¯¹äº eBPF æ¥è¯´è¿‡äºå¤æ‚è€Œæ— æ³•å¤„ç†çš„éƒ¨åˆ†ã€‚\n\n## eBPF ä¸æœåŠ¡ç½‘æ ¼çš„å…³ç³»\n\nå› ä¸ºä¸Šæ–‡æ‰€è¿°çš„ eBPF çš„å„é¡¹é™åˆ¶ï¼Œä¸ƒå±‚æµé‡ä»ç„¶éœ€è¦ç”¨æˆ·ç©ºé—´çš„ç½‘ç»œä»£ç†æ¥å®Œæˆï¼ŒeBPF å¹¶ä¸èƒ½æ›¿ä»£æœåŠ¡ç½‘æ ¼ã€‚eBPF å¯ä»¥ä¸ CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰ä¸€èµ·è¿è¡Œï¼Œå¤„ç†ä¸‰å±‚\/å››å±‚æµé‡ï¼Œè€ŒæœåŠ¡ç½‘æ ¼å¤„ç†ä¸ƒå±‚æµé‡ã€‚\n\n## æ¯ä¸ªä¸»æœºä¸€ä¸ªä»£ç†çš„æ¨¡å¼æ¯” sidecar æ›´ç³Ÿ\n\nå¯¹äºæ¯ä¸ªä¸»æœºä¸€ä¸ªä»£ç†ï¼ˆper-hostï¼‰çš„æ¨¡å¼ï¼ŒæœåŠ¡ç½‘æ ¼çš„æ—©æœŸå®è·µè€… Linkerd 1.x å°±æ˜¯è¿™ä¹ˆç”¨çš„ï¼Œç¬”è€…ä¹Ÿæ˜¯ä»é‚£ä¸ªæ—¶å€™å¼€å§‹å…³æ³¨æœåŠ¡ç½‘æ ¼ï¼ŒLinkerd 1.x è¿˜ä½¿ç”¨äº† JVM è™šæ‹Ÿæœºï¼ä½†æ˜¯ç»è¿‡ Linkerd 1.x çš„ç”¨æˆ·å®è·µè¯æ˜ï¼Œè¿™ç§æ¨¡å¼ç›¸å¯¹äº sidecar æ¨¡å¼ï¼Œå¯¹äºè¿ç»´å’Œå®‰å…¨æ¥è¯´ä¼šæ›´ç³Ÿç³•ã€‚\n\nä¸ºä»€ä¹ˆè¯´ sidecar æ¨¡å¼æ¯” per-host æ¨¡å¼æ›´å¥½å‘¢ï¼Ÿå› ä¸º sidecar æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜åŠ¿ï¼Œè¿™æ˜¯ per-host æ¨¡å¼æ‰€ä¸å…·å¤‡çš„ï¼š\n\n1. ä»£ç†çš„èµ„æºæ¶ˆè€—éšç€åº”ç”¨ç¨‹åºçš„è´Ÿè½½è€Œå˜åŒ–ã€‚éšç€å®ä¾‹æµé‡çš„å¢åŠ ï¼Œsidecar ä¼šæ¶ˆè€—æ›´å¤šçš„èµ„æºï¼Œå°±åƒåº”ç”¨ç¨‹åºä¸€æ ·ã€‚å¦‚æœåº”ç”¨ç¨‹åºçš„æµé‡éå¸¸å°ï¼Œé‚£ä¹ˆ sidecar å°±ä¸éœ€è¦æ¶ˆè€—å¾ˆå¤šèµ„æºã€‚Kubernetes ç°æœ‰çš„ç®¡ç†èµ„æºæ¶ˆè€—çš„æœºåˆ¶ï¼Œå¦‚èµ„æºè¯·æ±‚å’Œé™åˆ¶ä»¥åŠ OOM killï¼Œéƒ½ä¼šç»§ç»­å·¥ä½œã€‚\n2. ä»£ç†å¤±è´¥çš„çˆ†ç‚¸åŠå¾„åªé™äºä¸€ä¸ª podã€‚ä»£ç†å¤±è´¥ä¸åº”ç”¨å¤±è´¥ç›¸åŒï¼Œç”± Kubernetes è´Ÿè´£å¤„ç†å¤±è´¥çš„ podã€‚\n3. ä»£ç†ç»´æŠ¤ã€‚ä¾‹å¦‚ä»£ç†ç‰ˆæœ¬çš„å‡çº§ï¼Œæ˜¯é€šè¿‡å¦‚æ»šåŠ¨æ›´æ–°ï¼Œç°åº¦å‘å¸ƒç­‰åº”ç”¨ç¨‹åºæœ¬èº«ç›¸åŒçš„æœºåˆ¶å®Œæˆçš„ã€‚\n4. å®‰å…¨è¾¹ç•Œå¾ˆæ¸…æ¥šï¼ˆè€Œä¸”å¾ˆå°ï¼‰ï¼šåœ¨ pod çº§åˆ«ã€‚Sidecar åœ¨åº”ç”¨ç¨‹åºå®ä¾‹çš„åŒä¸€å®‰å…¨ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚å®ƒæ˜¯ pod çš„ä¸€éƒ¨åˆ†ï¼Œä¸åº”ç”¨ç¨‹åºå…·æœ‰ä¸€æ ·çš„ IP åœ°å€ã€‚Sidecar æ‰§è¡Œç­–ç•¥ï¼Œå¹¶å°† mTLS åº”ç”¨äºè¿›å‡ºè¯¥ pod çš„æµé‡ï¼Œè€Œä¸”å®ƒåªéœ€è¦è¯¥ pod çš„å¯†é’¥ã€‚\n\nè€Œå¯¹äº per-host æ¨¡å¼ï¼Œå°±æ²¡æœ‰ä¸Šè¿°å¥½å¤„äº†ã€‚ä»£ç†ä¸åº”ç”¨ç¨‹åº pod å®Œå…¨è§£è€¦ï¼Œå¤„ç†ä¸»æœºä¸Šæ‰€æœ‰ pod çš„æµé‡ï¼Œè¿™æ ·ä¼šä»£ç†å„ç§é—®é¢˜ï¼š\n\n1. ä»£ç†æ¶ˆè€—çš„èµ„æºæ˜¯é«˜åº¦å¯å˜çš„ï¼Œè¿™å–å†³äºåœ¨æŸä¸ªæ—¶é—´ç‚¹ Kubernetes è°ƒåº¦äº†å¤šå°‘ä¸ª pod åœ¨è¯¥ä¸»æœºä¸Šã€‚ä½ æ— æ³•æœ‰æ•ˆçš„é¢„æµ‹ç‰¹å®šä»£ç†çš„èµ„æºæ¶ˆè€—æƒ…å†µï¼Œè¿™æ ·ä»£ç†å°±æœ‰å´©æºƒçš„é£é™©ï¼ˆåŸæ–‡æ˜¯è¿™ä¹ˆè¯´çš„ï¼Œè¿™ç‚¹ç¬”è€…è¿˜æ˜¯å­˜ç–‘çš„ï¼Œå¸Œæœ›æœ‰ç‚¹è¯»è€…èƒ½è§£å¸®å¿™è§£é‡Šä¸‹ï¼‰ã€‚\n2. ä¸»æœºä¸Š pod ä¹‹é—´çš„æµé‡äº‰æŠ¢é—®é¢˜ã€‚å› ä¸ºä¸»æœºä¸Šçš„æ‰€æœ‰æµé‡éƒ½ç»è¿‡åŒä¸€ä¸ªä»£ç†ï¼Œå¦‚æœæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åº pod çš„æµé‡æé«˜ï¼Œæ¶ˆè€—äº†ä»£ç†çš„æ‰€æœ‰èµ„æºï¼Œä¸»æœºä¸Šçš„å…¶ä»–åº”ç”¨ç¨‹åºå°±æœ‰è¢«é¥¿æ­»çš„å±é™©ã€‚\n3. ä»£ç†çš„çˆ†ç‚¸åŠå¾„å¾ˆå¤§ï¼Œè€Œä¸”æ˜¯ä¸æ–­å˜åŒ–çš„ã€‚ä»£ç†çš„æ•…éšœå’Œå‡çº§ç°åœ¨å½±å“åˆ°éšæœºçš„åº”ç”¨ç¨‹åºé›†åˆä¸­çš„ä¸€ä¸ªéšæœºçš„ pod å­é›†ï¼Œæ„å‘³ç€ä»»ä½•æ•…éšœæˆ–ç»´æŠ¤ä»»åŠ¡éƒ½æœ‰éš¾ä»¥é¢„æµ‹çš„é£é™©ã€‚\n4. ä½¿å¾—å®‰å…¨é—®é¢˜æ›´åŠ å¤æ‚ã€‚ä»¥ TLS ä¸ºä¾‹ï¼Œä¸»æœºä¸Šçš„ä»£ç†å¿…é¡»åŒ…å«è¯¥ä¸»æœºä¸Šæ‰€æœ‰åº”ç”¨ç¨‹åºçš„å¯†é’¥ï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºä¸€ä¸ªæ–°çš„æ”»å‡»åª’ä»‹ï¼Œå®¹æ˜“å—åˆ°[æ··æ·†ä»£ç†](https:\/\/en.wikipedia.org\/wiki\/Confused_deputy_problem)é—®é¢˜çš„å½±å“â€”â€”ä»£ç†ä¸­çš„ä»»ä½• CVE æˆ–æ¼æ´éƒ½æ˜¯æ½œåœ¨çš„å¯†é’¥æ³„éœ²é£é™©ã€‚\n\nç®€è€Œè¨€ä¹‹ï¼Œsidecar æ¨¡å¼ç»§ç»­è´¯å½»äº†å®¹å™¨çº§åˆ«çš„éš”ç¦»ä¿æŠ¤â€”â€”å†…æ ¸å¯ä»¥åœ¨å®¹å™¨çº§åˆ«æ‰§è¡Œæ‰€æœ‰å®‰å…¨ä¿æŠ¤å’Œå…¬å¹³çš„å¤šç§Ÿæˆ·è°ƒåº¦ã€‚å®¹å™¨çš„éš”ç¦»ä»ç„¶å¯ä»¥å®Œç¾çš„è¿è¡Œï¼Œè€Œ per-host æ¨¡å¼å´ç ´åäº†è¿™ä¸€åˆ‡ï¼Œé‡æ–°å¼•å…¥äº†äº‰æŠ¢å¼çš„å¤šç§Ÿæˆ·éš”ç¦»é—®é¢˜ã€‚\n\nå½“ç„¶ per-host ä¹Ÿä¸æ˜¯ä¸€æ— æ˜¯å¤„ï¼Œè¯¥æ¨¡å¼æœ€å¤§çš„å¥½å¤„æ˜¯å¯ä»¥æˆæ•°é‡çº§çš„å‡å°‘ä»£ç†çš„æ•°é‡ï¼Œå‡å°‘ç½‘ç»œè·³æ•°ï¼Œè¿™ä¹Ÿå°±å‡å°‘äº†èµ„æºæ¶ˆè€—å’Œç½‘ç»œå»¶è¿Ÿã€‚ä½†æ˜¯ä¸è¯¥æ¨¡å¼å¸¦æ¥çš„è¿ç»´å’Œå®‰å…¨æ€§é—®é¢˜ç›¸æ¯”ï¼Œè¿™äº›ä¼˜åŠ¿éƒ½æ˜¯æ¬¡è¦çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æŒç»­ä¼˜åŒ– sidecar æ¥å¼¥è¡¥ sidecar æ¨¡å¼åœ¨è¿™æ–¹é¢çš„ä¸è¶³ï¼Œè€Œ per-host æ¨¡å¼çš„ç¼ºé™·ç¡®æ˜¯è‡´å‘½æ€§çš„ã€‚\n\nå…¶å®å½’æ ¹ç»“åº•è¿˜æ˜¯å›åˆ°äº†äº‰æŠ¢å¼å¤šç§Ÿæˆ·é—®é¢˜ä¸Šï¼Œé‚£ä¹ˆèƒ½å¦åˆ©ç”¨ç°æœ‰çš„å†…æ ¸è§£å†³æ–¹æ¡ˆï¼Œæ”¹è¿›ä¸€ä¸‹ per-host æ¨¡å¼ä¸­çš„ä»£ç†ï¼Œè®©å…¶æ”¯æŒå¤šç§Ÿæˆ·å‘¢ï¼Ÿæ¯”å¦‚æ”¹é€  Envoy ä»£ç†ï¼Œä½¿å…¶æ”¯æŒå¤šç§Ÿæˆ·æ¨¡å¼ã€‚è™½ç„¶ä»ç†è®ºæ¥è¯´è¿™æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å·¥ä½œé‡å·¨å¤§ï¼ŒMatt Klein ä¹Ÿè§‰å¾—ä¸å€¼å¾—è¿™æ ·åš [^2]ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨å®¹å™¨æ¥å®ç°ç§Ÿæˆ·éš”ç¦»ã€‚è€Œä¸”å³ä½¿è®© per-host æ¨¡å¼ä¸­çš„ä»£ç†æ”¯æŒäº†å¤šç§Ÿæˆ·ï¼Œä»ç„¶è¿˜æœ‰çˆ†ç‚¸åŠå¾„å’Œå®‰å…¨é—®é¢˜éœ€è¦è§£å†³ã€‚\n\n## æ€»ç»“\n\nä¸ç®¡æœ‰æ²¡æœ‰ eBPFï¼Œåœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼éƒ½ä¼šåŸºäºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ sidecar ä»£ç†ï¼ˆproxyless æ¨¡å¼é™¤å¤–ï¼‰ã€‚Sidecar æ¨¡å¼è™½ç„¶ä¹Ÿæœ‰å¼Šç«¯ï¼Œä½†å®ƒä¾ç„¶æ˜¯æ—¢èƒ½ä¿æŒå®¹å™¨éš”ç¦»å’Œæ“ä½œçš„ä¼˜åŠ¿ï¼Œåˆèƒ½å¤„ç†äº‘åŸç”Ÿç½‘ç»œå¤æ‚æ€§çš„æœ€ä¼˜æ–¹æ¡ˆã€‚eBPF çš„èƒ½åŠ›å°†æ¥æ˜¯å¦ä¼šå‘å±•åˆ°å¯ä»¥å¤„ç†ä¸ƒå±‚ç½‘ç»œæµé‡ï¼Œä»è€Œæ›¿ä»£æœåŠ¡ç½‘æ ¼å’Œ sidecarï¼Œä¹Ÿè®¸å§ï¼Œä½†é‚£ä¸€å¤©å¯èƒ½å¾ˆé¥è¿œã€‚\n\n## å‚è€ƒ\n\n[^1]: William Morgan çš„ [eBPF, sidecars, and the future of the service mesh](https:\/\/buoyant.io\/2022\/06\/07\/ebpf-sidecars-and-the-future-of-the-service-mesh\/) è¿™ç¯‡æ–‡ç« æ­£å¥½å›ç­”äº†æˆ‘çš„å…³äº eBPFã€sidecar çš„ç–‘é—®ã€‚\n[^2]: å…³äº per-host æ¨¡å¼ä¸­çš„ä»£ç†æ”¹é€ é—®é¢˜ï¼ŒTwitter ä¸Šæœ‰ä¸€ä¸ªç²¾å½©çš„[è®¨è®º](https:\/\/twitter.com\/mattklein123\/status\/1522925333053272065)ã€‚\n', '\/blog\/ebpf-sidecar-and-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">ä¸ç®¡æœ‰æ²¡æœ‰ eBPFï¼Œåœ¨å¯é¢„è§çš„æœªæ¥ï¼ŒæœåŠ¡ç½‘æ ¼éƒ½ä¼šåŸºäºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ sidecar ä»£ç†ï¼ˆproxyless æ¨¡å¼é™¤å¤–ï¼‰ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/book/what-is-ebpf/">ä»€ä¹ˆæ˜¯ eBPFï¼Ÿ</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/06/01</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6"> 
             ç¿»è¯‘ç”µå­ä¹¦
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('ä»€ä¹ˆæ˜¯ eBPFï¼Ÿ', 'æ–°ä¸€ä»£ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§å·¥å…·ç®€ä»‹ã€‚', '\nã€Šä»€ä¹ˆæ˜¯ eBPF â€”â€” æ–°ä¸€ä»£ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§å·¥å…·ä»‹ç»ã€‹è¯‘è‡ª O\u0027Reilly å‘å¸ƒçš„æŠ¥å‘Šâ€œWhat is eBPFâ€ï¼Œä½œè€…æ˜¯ Liz Riceï¼Œç”± JImmy Song ç¿»è¯‘ï¼Œè‹±æ–‡åŸç‰ˆå¯ä»¥åœ¨ [O\u0027Reilly ç½‘ç«™](https:\/\/www.oreilly.com\/library\/view\/what-is-ebpf\/9781492097266\/)ä¸Šè·å–ã€‚\n\n## è¯‘è€…åº\n\næœ€è¿‘ä¸¤å¹´æ¥å…³äº eBPF çš„è®¨è®ºåœ¨äº‘åŸç”Ÿç¤¾åŒºé‡Œè¶Šæ¥è¶Šå¤šï¼Œå°¤å…¶æ˜¯å½“è°ˆåˆ° Cilium çš„å•†ä¸šåŒ–ï¼Œä½¿ç”¨ eBPF æ¥ä¼˜åŒ– Istio æœåŠ¡ç½‘æ ¼ï¼Œç”šè‡³æ‰¬è¨€å¹²æ‰ Sidecar æ—¶ï¼ŒeBPF æ›´æ˜¯èµšè¶³äº†çœ¼çƒã€‚\n\nè¿™æœ¬æŠ¥å‘Šæ˜¯ç”±åŸºäº Cilium  çš„åˆ›ä¸šå…¬å¸ Isovalent çš„ Liz Rice æ’°å†™ï¼Œç”± O\u0027Reilly å‘å¸ƒï¼Œç›¸ä¿¡å¯ä»¥ä¸ºä½ æ­å¼€ eBPF æŠ€æœ¯çš„ç¥ç§˜é¢çº±ï¼Œå¸¦ä½ äº†è§£ä»€ä¹ˆæ˜¯ eBPF è¿˜æœ‰å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚æ›´é‡è¦çš„æ˜¯å®ƒåœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­ï¼Œåœ¨æœåŠ¡ç½‘æ ¼ã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨ä¸­çš„åº”ç”¨ã€‚\n\n## å…³äºä½œè€…\n\nLiz Rice æ˜¯äº‘åŸç”Ÿç½‘ç»œå’Œå®‰å…¨ä¸“å®¶ï¼ŒIsovalent çš„é¦–å¸­å¼€æºå®˜ï¼Œæ˜¯åŸºäº eBPF çš„ Cilium ç½‘ç»œé¡¹ç›®çš„åˆ›å»ºè€…ã€‚å¥¹åœ¨ 2019-2022 å¹´æ‹…ä»» CNCF çš„æŠ€æœ¯ç›‘ç£å§”å‘˜ä¼šï¼ˆTOCï¼‰ä¸»å¸­ï¼Œå¹¶åœ¨ 2018 å¹´æ‹…ä»» KubeCon \u002b CloudNativeCon çš„è”åˆä¸»å¸­ã€‚å¥¹ä¹Ÿæ˜¯ Container Security ä¸€ä¹¦çš„ä½œè€…ï¼Œç”± O\\\u0027Reilly å‡ºç‰ˆã€‚å¥¹æ‹¥æœ‰ä¸°å¯Œçš„è½¯ä»¶å¼€å‘ã€å›¢é˜Ÿå’Œäº§å“ç®¡ç†ç»éªŒï¼Œæ›¾åœ¨ç½‘ç»œåè®®å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä»¥åŠæ•°å­—æŠ€æœ¯é¢†åŸŸï¼ˆå¦‚ VODã€éŸ³ä¹å’Œ VoIPï¼‰å·¥ä½œã€‚åœ¨ä¸å†™ä»£ç çš„æ—¶å€™ï¼ŒLiz å–œæ¬¢åœ¨å¤©æ°”æ¯”å¥¹çš„å®¶ä¹¡ä¼¦æ•¦å¥½çš„åœ°æ–¹éª‘è‡ªè¡Œè½¦ï¼Œå’Œåœ¨ Zwift ä¸Šå‚åŠ è™šæ‹Ÿæ¯”èµ›ã€‚\n\n## æœ¬ä¹¦å¤§çº²\n\n{{\u003c list_children show_summary=\u0022false\u0022\u003e}}\n\n{{\u003c cta cta_text=\u0022å¼€å§‹é˜…è¯»\u0022 cta_link=\u0022introduction\u0022 \u003e}}\n', '\/book\/what-is-ebpf\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æ–°ä¸€ä»£ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§å·¥å…·ç®€ä»‹ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/how-to-add-bpf-observability/">[è¯‘] å¦‚ä½•åœ¨äº§å“ä¸­å¼•å…¥ eBPF ä»¥å¢åŠ å¯è§‚æµ‹æ€§</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/01/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             å…¶ä»–
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://www.brendangregg.com/blog/2021-07-03/how-to-add-bpf-observability.html" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('å¦‚ä½•åœ¨äº§å“ä¸­å¼•å…¥ eBPF ä»¥å¢åŠ å¯è§‚æµ‹æ€§', 'æœ¬æ–‡æ˜¯ç»™æƒ³è¦åœ¨äº§å“ä¸­å¼•å…¥ eBPF å¢åŠ å¯è§‚æµ‹æ€§äººå‘˜çš„å¿ å‘Šã€‚', '\n## ç¼–è€…æŒ‰\n\næœ¬æ–‡è¯‘è‡ª [How To Add eBPF Observability To Your Product](https:\/\/www.brendangregg.com\/blog\/2021-07-03\/how-to-add-bpf-observability.html)ï¼ŒåŸæ–‡å‘å¸ƒäº 2021 å¹´ 7 æœˆ 3 æ—¥ã€‚æœ¬æ–‡ä½œè€… Brendan Gregg æ˜¯ eBPF é¢†åŸŸçš„ä¸“å®¶ï¼Œå‡ºç‰ˆè¿‡å¤šæœ¬ç›¸å…³ä¹¦ç±ï¼Œæœ¬æ–‡æ˜¯ä»–ç»™æƒ³è¦åœ¨äº§å“ä¸­å¼•å…¥ eBPF å¢åŠ å¯è§‚æµ‹æ€§äººå‘˜çš„å¿ å‘Šã€‚\n\n## æ­£æ–‡\n\nç°åœ¨æœ‰ä¸€åœºå†›å¤‡ç«èµ›ï¼Œå³å¢åŠ  eBPF çš„å†›å¤‡ç«èµ›ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•å¿«é€Ÿåšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ä¹Ÿé€‚ç”¨äºäººä»¬å°†å…¶æ·»åŠ åˆ°è‡ªå·±çš„å†…éƒ¨ç›‘æµ‹ç³»ç»Ÿä¸­ã€‚\n\näººä»¬å–œæ¬¢åœ¨ä»–ä»¬å»ºç«‹äº†åŸå‹æˆ–æ„å»ºäº†äº§å“ä¹‹åå‘æˆ‘å±•ç¤ºä»–ä»¬çš„ BPF å¯è§‚æµ‹æ€§äº§å“ï¼Œä½†æˆ‘å¸¸å¸¸åœ¨ä»–ä»¬å¼€å§‹ä¹‹å‰ç»™å‡ºå»ºè®®ã€‚ä½œä¸º BPF å¯è§‚æµ‹æ€§çš„é¢†å¯¼è€…ï¼Œè¿™æ˜¯æˆ‘åœ¨æœ€è¿‘çš„è°ˆè¯ä¸­ä¸€ç›´åŒ…å«çš„å»ºè®®ï¼Œç°åœ¨æˆ‘æŠŠå®ƒçº³å…¥è¿™ç¯‡æ–‡ç« ä¸­ã€‚\n\né¦–å…ˆï¼Œæˆ‘çŸ¥é“ä½ å¾ˆå¿™ã€‚ä½ ç”šè‡³å¯èƒ½ä¸å–œæ¬¢ BPFã€‚ä¸ºäº†åŠ¡å®èµ·è§ï¼Œæˆ‘å°†æè¿°å¦‚ä½•èŠ±æœ€å°‘çš„ç²¾åŠ›æ¥è·å¾—æœ€å¤§çš„ä»·å€¼ã€‚æŠŠè¿™çœ‹æˆæ˜¯â€œç¬¬ä¸€ç‰ˆâ€ã€‚ä¸€ä¸ªç›¸å½“æœ‰ç”¨çš„å‡ºå‘ç‚¹ã€‚æ— è®ºä½ æ˜¯å¦éµå¾ªè¿™ä¸ªå»ºè®®ï¼Œè‡³å°‘è¯·ä½ ç†è§£å®ƒï¼Œä»¥é¿å…ä»¥åçš„é—æ†¾å’Œç—›è‹¦ã€‚\n\nå¦‚æœä½ æ­£åœ¨ä½¿ç”¨å¼€æºç›‘æ§å¹³å°ï¼Œé¦–å…ˆæ£€æŸ¥å®ƒæ˜¯å¦å·²ç»æœ‰ä¸€ä¸ª BPF ä»£ç†ã€‚è¿™ç¯‡æ–‡ç« å‡è®¾å®ƒæ²¡æœ‰ï¼Œè€Œä¸”ä½ å°†é¦–æ¬¡æ·»åŠ ä¸€äº›ä¸œè¥¿ã€‚\n\n## 1. è¿è¡Œç¬¬ä¸€ä¸ªå·¥å…·\n\né¦–å…ˆå®‰è£… [bcc](https:\/\/github.com\/iovisor\/bcc) æˆ– [bpftrace](https:\/\/github.com\/iovisor\/bpftrace) å·¥å…·ã€‚ä¾‹å¦‚ï¼ŒUbuntu ä¸Šçš„ bccã€‚\n\n\u0060\u0060\u0060sh\n# apt-get install bpfcc-tools\n\u0060\u0060\u0060\n\nç„¶åå°è¯•è¿è¡Œä¸€ä¸ªå·¥å…·ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ execsnoop (8) æŸ¥çœ‹å¸¦æœ‰æ—¶é—´æˆ³çš„è¿›ç¨‹æ‰§è¡Œæƒ…å†µã€‚\n\n\u0060\u0060\u0060sh\n# execsnoop-bpfcc -T\nTIME     PCOMM            PID    PPID   RET ARGS\n19:36:15 service          828567 6009     0 \/usr\/sbin\/service --status-all\n19:36:15 basename         828568 828567   0 \n19:36:15 basename         828569 828567   0 \/usr\/bin\/basename \/usr\/sbin\/service\n19:36:15 env              828570 828567   0 \/usr\/bin\/env -i LANG=en_AU.UTF-8 LANGUAGE=en_AU:en LC_CTYPE= LC_NUMERIC= LC_TIME= LC_COLLATE= LC_MONETARY= LC_MESSAGES= LC_PAPER= LC_NAME= LC_ADDRESS= LC_TELEPHONE= LC_MEASUREMENT= LC_IDENTIFICATION= LC_ALL= PATH=\/opt\/local\/bin:\/opt\/local\/sbin:\/usr\/local\/git\/bin:\/home\/bgregg\/.local\/bin:\/home\/bgregg\/bin:\/opt\/local\/bin:\/opt\/local\/sbin:\/ TERM=xterm-256color \/etc\/init.d\/acpid \n19:36:15 acpid            828570 828567   0 \/etc\/init.d\/acpid status\n19:36:15 run-parts        828571 828570   0 \/usr\/bin\/run-parts --lsbsysinit --list \/lib\/lsb\/init-functions.d\n19:36:15 systemctl        828572 828570   0 \/usr\/bin\/systemctl -p LoadState --value show acpid.service\n19:36:15 readlink         828573 828570   0 \/usr\/bin\/readlink -f \/etc\/init.d\/acpid\n[...]\n\u0060\u0060\u0060\n\nè™½ç„¶å¾ˆåŸºæœ¬ï¼Œä½†æˆ‘ä»…ç”¨è¿™ä¸ªå·¥å…·å°±è§£å†³äº†å¾ˆå¤š perf é—®é¢˜ï¼ŒåŒ…æ‹¬é’ˆå¯¹é…ç½®é”™è¯¯çš„ç³»ç»Ÿï¼Œå…¶ä¸­ä¸€ä¸ª shell è„šæœ¬æ­£åœ¨å¾ªç¯å¯åŠ¨å¤±è´¥çš„è¿›ç¨‹ï¼Œä»¥åŠå½“ä¸€äº›å°ç¨‹åºå´©æºƒå¹¶æ¯éš”å‡ åˆ†é’Ÿå°±é‡å¯ä½†è¿˜æ²¡æœ‰è¢«æ³¨æ„åˆ°æ—¶ã€‚\n\n## 2. ä¸ºä½ çš„äº§å“æ·»åŠ ä¸€ä¸ªå·¥å…·\n\nç°åœ¨æƒ³è±¡ä¸€ä¸‹å°† execsnoop (8) æ·»åŠ åˆ°ä½ çš„äº§å“ä¸­ã€‚ä½ å¯èƒ½å·²ç»åœ¨ä½ æ‰€æœ‰çš„å®¢æˆ·ç³»ç»Ÿä¸Šè¿è¡Œäº†ä»£ç†ã€‚ä»–ä»¬æ˜¯å¦æœ‰åŠæ³•è¿è¡Œä¸€ä¸ªå‘½ä»¤å¹¶è¿”å›æ–‡æœ¬è¾“å‡ºï¼Ÿæˆ–è€…è¿è¡Œä¸€ä¸ªå‘½ä»¤å¹¶å°†è¾“å‡ºå‘é€åˆ°å…¶ä»–åœ°æ–¹è¿›è¡Œèšåˆï¼ˆS3ã€Hiveã€Druid ç­‰ï¼‰ï¼Ÿæœ‰å¾ˆå¤šé€‰æ‹©ï¼Œè¿™å®é™…ä¸Šæ˜¯ä½ è‡ªå·±åŸºäºç°æœ‰ç³»ç»Ÿå’Œå®¢æˆ·ç¯å¢ƒçš„åå¥½ã€‚\n\nå½“ä½ æŠŠç¬¬ä¸€ä¸ªå·¥å…·æ·»åŠ åˆ°ä½ çš„äº§å“ä¸­æ—¶ï¼Œè®©å®ƒåœ¨çŸ­æ—¶é—´å†…è¿è¡Œï¼Œæ¯”å¦‚ 10 åˆ° 60 ç§’ã€‚æˆ‘åˆšåˆšæ³¨æ„åˆ° execsnoop (8) è¿˜æ²¡æœ‰æŒç»­æ—¶é—´é€‰é¡¹ï¼Œæ‰€ä»¥åœ¨è¿™æœŸé—´ä½ å¯ä»¥ç”¨ \u0060watch -s2 60 execsnoop-bpfcc\u0060 æ¥åŒ…è£…å®ƒã€‚å¦‚æœä½ æƒ³ 24 å°æ—¶è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¦–å…ˆè¦ç ”ç©¶å¼€é”€ä»¥äº†è§£æˆæœ¬ã€‚ä½é¢‘ç‡çš„äº‹ä»¶ï¼Œå¦‚è¿›ç¨‹çš„æ‰§è¡Œï¼Œæ•æ‰èµ·æ¥åº”è¯¥æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚\n\nä¸ä½¿ç”¨ bccï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ [bpftrace](https:\/\/github.com\/iovisor\/bpftrace) ç‰ˆæœ¬ã€‚è¿™äº›é€šå¸¸æ²¡æœ‰å°è£…é€‰é¡¹ï¼ˆ-vã€-l ç­‰ï¼‰ï¼Œä½†æœ‰ä¸€ä¸ª json è¾“å‡ºæ¨¡å¼ã€‚ä¾‹å¦‚ï¼š\n\n\u0060\u0060\u0060sh\n# bpftrace -f json execsnoop.bt \n{\u0022type\u0022: \u0022attached_probes\u0022, \u0022data\u0022: {\u0022probes\u0022: 2}}\n{\u0022type\u0022: \u0022printf\u0022, \u0022data\u0022: \u0022TIME(ms)   PID   ARGS\\n\u0022}\n{\u0022type\u0022: \u0022printf\u0022, \u0022data\u0022: \u00222737       849176 \u0022}\n{\u0022type\u0022: \u0022join\u0022, \u0022data\u0022: \u0022ls -F\u0022}\n{\u0022type\u0022: \u0022printf\u0022, \u0022data\u0022: \u00225641       849178 \u0022}\n{\u0022type\u0022: \u0022join\u0022, \u0022data\u0022: \u0022date\u0022}\n\u0060\u0060\u0060\n\næ·»åŠ è¿™ç§æ¨¡å¼æ˜¯ä¸ºäº†ä½¿ BPF çš„å¯è§‚æµ‹æ€§äº§å“å¯ä»¥å»ºç«‹åœ¨ bpftrace ä¹‹ä¸Šã€‚\n\n## 3. ä¸è¦æ‹…å¿ƒä¾èµ–æ€§é—®é¢˜\n\næˆ‘å»ºè®®ä½ åœ¨å®¢æˆ·ç³»ç»Ÿä¸Šå®‰è£… bcc æˆ– bpftraceï¼Œå®ƒä»¬ç›®å‰æœ‰ llvm ä¾èµ–ã€‚è¿™å¯èƒ½ä¼šå¢åŠ åˆ°å‡ å MBï¼Œè¿™å¯¹ä¸€äº›èµ„æºæœ‰é™çš„ç¯å¢ƒï¼ˆåµŒå…¥å¼ï¼‰æ˜¯ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ä¸€ç›´åœ¨åšå¤§é‡çš„å·¥ä½œï¼Œä»¥ä¾¿åœ¨æœªæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ [BTF and CO-RE](https:\/\/www.brendangregg.com\/blog\/2020-11-04\/bpf-co-re-btf-libbpf.html)ï¼ˆè€Œä¸æ˜¯ Pythonï¼‰ï¼Œæœ€ç»ˆå°†æ„å‘³ç€ä½ å¯ä»¥å®‰è£… 100KB çš„æ— ä¾èµ–æ€§çš„å·¥å…·äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚bpftrace ä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„è®¡åˆ’ï¼Œä½¿ç”¨è¾ƒæ–°çš„å†…æ ¸ç‰¹æ€§ç”Ÿæˆä¸€ä¸ªå°çš„æ— ä¾èµ–æ€§çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚\n\nè¿™ç¡®å®éœ€è¦è‡³å°‘ Linux 5.8 æ‰èƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œè€Œä½ çš„å®¢æˆ·å¯èƒ½å‡ å¹´éƒ½ä¸ä¼šè¿è¡Œè¿™ä¸ªç³»ç»Ÿã€‚åœ¨è¿™æœŸé—´ï¼Œæˆ‘å»ºè®®æš‚æ—¶ä¸è¦æ‹…å¿ƒ llvm çš„ä¾èµ–å…³ç³»ï¼Œå› ä¸ºå®ƒä»¥åä¼šè¢«ä¿®å¤ã€‚\n\nè¯·æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ Linux å‘è¡Œç‰ˆéƒ½å¯ç”¨äº† \u0060CONFIG_DEBUG_INFO_BTF=y\u0060ï¼Œè¿™å¯¹äº BTF å’Œ CO-RE çš„æœªæ¥æ˜¯å¿…è¦çš„ã€‚ä¸»è¦çš„å‘è¡Œç‰ˆå·²ç»è®¾ç½®äº†å®ƒï¼Œæ¯”å¦‚åœ¨ Ubuntu 20.10ã€Fedora 30 å’Œ RHEL 8.2ã€‚ä½†å¦‚æœä½ çŸ¥é“ä½ çš„ä¸€äº›å®¢æˆ·æ­£åœ¨è¿è¡Œä¸€äº›ä¸å¸¸è§çš„ä¸œè¥¿ï¼Œè¯·æ£€æŸ¥å¹¶é¼“åŠ±ä»–ä»¬æˆ–å‘è¡Œå•†è®¾ç½® \u0060CONFIG_DEBUG_INFO_BTF=y\u0060 å’Œ \u0060CONFIG_DEBUG_INFO_BTF_MODULES=y\u0060ï¼Œä»¥é¿å…æœªæ¥çš„ç—›è‹¦ã€‚\n\n## 4. ç¬¬ 1 ç‰ˆä»ªè¡¨æ¿\n\nç°åœ¨ä½ çš„äº§å“ä¸­æœ‰äº†ä¸€ä¸ª BPF å¯è§‚æµ‹æ€§å·¥å…·ï¼Œæ˜¯æ—¶å€™å¢åŠ æ›´å¤šçš„å·¥å…·äº†ã€‚ä¸‹é¢æ˜¯ä½ å¯ä»¥è¿è¡Œçš„åå¤§å·¥å…·ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªé€šç”¨çš„ BPF å¯è§‚æµ‹æ€§ä»ªè¡¨ç›˜æ¥å±•ç¤ºï¼ŒåŒæ—¶è¿˜æœ‰å»ºè®®çš„å¯è§†åŒ–ã€‚\n\n| ç¼–å· | å·¥å…·       | å±•ç¤º                    | å¯è§†åŒ–           |\n| ---- | ---------- | ----------------------- | ---------------- |\n| 1.   | execsnoop  | æ–°è¿›ç¨‹ï¼ˆé€šè¿‡ exec (2)ï¼‰ | è¡¨æ ¼             |\n| 2.   | opensnoop  | æ‰“å¼€çš„æ–‡ä»¶              | è¡¨æ ¼             |\n| 3.   | ext4slower | æ…¢é€Ÿæ–‡ä»¶ç³»ç»Ÿ I\/O        | è¡¨æ ¼             |\n| 4.   | biolatency | ç£ç›˜ I\/O å»¶è¿ŸæŸ±çŠ¶å›¾     | çƒ­åŠ›å›¾           |\n| 5.   | biosnoop   | æ¯ä¸ªäº‹ä»¶çš„ç£ç›˜ I\/O ç»†èŠ‚ | è¡¨æ ¼ï¼Œåç§»çƒ­å›¾   |\n| 6.   | cachestat  | æ–‡ä»¶ç³»ç»Ÿé«˜é€Ÿç¼“å­˜ç»Ÿè®¡    | çº¿çŠ¶å›¾           |\n| 7.   | tcplife    | TCP è¿æ¥                | è¡¨æ ¼ï¼Œåˆ†å¸ƒå¼å›¾è¡¨ |\n| 8.   | tcpretrans | TCP é‡ä¼                 | è¡¨æ ¼             |\n| 9.   | runqlat    | CPU è°ƒåº¦å™¨çš„å»¶è¿Ÿ        | çƒ­åŠ›å›¾           |\n| 10.  | profile    | CPU å †æ ˆè·Ÿè¸ªæ ·æœ¬        | ç«ç„°å›¾           |\n\nè¿™æ˜¯åœ¨æˆ‘çš„ [bcc Tutorial](https:\/\/github.com\/iovisor\/bcc\/blob\/master\/docs\/tutorial.md) çš„ï¼Œè€Œä¸”å¾ˆå¤šä¹Ÿå­˜åœ¨äº bpftrace ä¸­ã€‚æˆ‘é€‰æ‹©è¿™äº›æ˜¯ä¸ºäº†ç”¨æœ€å°‘çš„å·¥å…·æ‰¾åˆ°æœ€å¤§çš„æ€§èƒ½ä¼˜åŠ¿ã€‚\n\nè¯·æ³¨æ„ï¼Œrunqlat å’Œ profile ä¼šæœ‰æ˜æ˜¾çš„å¼€é”€ï¼Œæ‰€ä»¥æˆ‘åªè¿è¡Œè¿™äº›å·¥å…· 10 åˆ° 60 ç§’ï¼Œç„¶åç”Ÿæˆä¸€ä»½æŠ¥å‘Šã€‚æœ‰äº›å·¥å…·çš„å¼€é”€å¾ˆä½ï¼Œå¦‚æœéœ€è¦çš„è¯å¯ä»¥ 24 å°æ—¶è¿è¡Œï¼ˆä¾‹å¦‚ execsnoopã€biolatencyã€tcplifeã€tcpretransï¼‰ã€‚\n\nåœ¨ bcc å’Œ bpftrace èµ„æºåº“ä¸­ï¼Œå·²ç»æœ‰ä»¥æ‰‹å†Œå’Œå®ä¾‹æ–‡ä»¶å½¢å¼å­˜åœ¨çš„æ–‡æ¡£ï¼Œä½ å¯ä»¥é“¾æ¥åˆ°è¿™äº›æ–‡æ¡£ï¼Œä»¥å¸®åŠ©ä½ çš„å®¢æˆ·äº†è§£å·¥å…·çš„è¾“å‡ºã€‚ä¾‹å¦‚ï¼Œåœ¨ [bcc](https:\/\/github.com\/iovisor\/bcc\/blob\/master\/tools\/execsnoop_example.txt) å’Œ [bpftrace](https:\/\/github.com\/iovisor\/bpftrace\/blob\/master\/tools\/execsnoop_example.txt) æœ‰ execsnoop (8) çš„ç¤ºä¾‹æ–‡ä»¶ã€‚\n\nå®Œæˆè¿™äº›åï¼Œä½ å°±æœ‰äº†ç¬¬ä¸€ç‰ˆçš„ä»ªè¡¨æ¿ã€‚\n\n## bcc ä¸ bpftrace\n\nbcc å·¥å…·æ˜¯æœ€å®¹æ˜“ä½¿ç”¨çš„ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æœ‰å¾ˆå¤šå‘½ä»¤è¡Œé€‰é¡¹ã€‚bpftrace å·¥å…·æ›´å®¹æ˜“ç¼–è¾‘å’Œå®šåˆ¶ï¼Œè€Œä¸” bpftrace æœ‰ä¸€ä¸ª json è¾“å‡ºæ¨¡å¼ã€‚\n\nå¦‚æœä½ æ˜¯è¿½è¸ªçš„æ–°æ‰‹ï¼Œå°±ç”¨ bcc å§ã€‚å¦‚æœä½ æƒ³åšä¸€äº›é»‘å®¢å’Œå®šåˆ¶çš„å·¥å…·ï¼Œå°±ç”¨ bpftraceã€‚æœ€åï¼Œå®ƒä»¬éƒ½æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚\n\n## æ¡ˆä¾‹ç ”ç©¶ï¼šNetflix\n\nNetflix æ­£åœ¨å»ºç«‹ä¸€ä¸ªæ–°çš„ GUIï¼Œåœ¨è¿™äº›å·¥å…·çš„ bpftrace ç‰ˆæœ¬çš„åŸºç¡€ä¸Šï¼Œåšè¿™ä¸ªå·¥å…·ä»ªè¡¨ç›˜å’Œæ›´å¤šçš„å·¥ä½œã€‚æ¶æ„å¦‚å›¾ã€‚\n\n![](008i3skNly1gys3a6aaa2j31310u0tcj.jpg) \n\nè™½ç„¶ bpftrace äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…åœ¨æ‰€æœ‰ç›®æ ‡ç³»ç»Ÿä¸Šï¼Œä½† bpftrace å·¥å…·ï¼ˆæ–‡æœ¬æ–‡ä»¶ï¼‰å´åœ¨ç½‘ç»œæœåŠ¡å™¨ä¸Šï¼Œå¹¶åœ¨éœ€è¦æ—¶è¢«æ¨é€å‡ºå»ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ªåœ°æ–¹æ›´æ–°å·¥å…·æ¥ç¡®ä¿æˆ‘ä»¬ä¸€ç›´åœ¨è¿è¡Œæœ€æ–°ç‰ˆæœ¬çš„å·¥å…·ã€‚\n\nè¿™æ˜¯ç›®å‰æˆ‘ä»¬ FlameCommander ç”¨æˆ·ç•Œé¢çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¹Ÿåœ¨äº‘ç«¯è¿è¡Œç«ç„°å›¾ã€‚æˆ‘ä»¬ä»¥å‰çš„ BPF GUI æ˜¯ [Vector](https:\/\/github.com\/Netflix\/vector) çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨äº† bccï¼Œä½†æˆ‘ä»¬åæ¥åºŸå¼ƒäº†å®ƒã€‚æˆ‘ä»¬å¯èƒ½ä¼šåœ¨æŸä¸ªæ—¶å€™å¼€æºæ–°çš„ GUIï¼Œå¹¶åœ¨ Netflix æŠ€æœ¯åšå®¢ä¸Šå‘è¡¨ç›¸å…³æ–‡ç« ã€‚\n\n## æ¡ˆä¾‹ç ”ç©¶ï¼šFacebook\n\nFacebook æ˜¯ BPF çš„é«˜çº§ç”¨æˆ·ï¼Œä½†ä»–ä»¬å¦‚ä½•åœ¨æ•´ä¸ªé›†ç¾¤ä¸­è¿è¡Œå·¥å…·çš„æ·±å±‚ç»†èŠ‚å¹¶æ²¡æœ‰å®Œå…¨å…¬å¼€ã€‚æ ¹æ® bcc çš„æ´»åŠ¨ï¼Œä»¥åŠä»–ä»¬å¯¹ BTF å’Œ CO-RE æŠ€æœ¯çš„å¼€å‘ï¼Œæˆ‘ååˆ†æ€€ç–‘ä»–ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯åŸºäº bcc çš„ libbpf-tool ç‰ˆæœ¬ã€‚\n\n## ç§»æ¤çš„é™·é˜±\n\nBPF è¿½è¸ªå·¥å…·å°±åƒåº”ç”¨ç¨‹åºå’Œå†…æ ¸çš„è¡¥ä¸ã€‚å®ƒä»¬éœ€è¦ä¸æ–­çš„æ›´æ–°ä»¥ä¿æŒåœ¨ä¸åŒçš„è½¯ä»¶ç‰ˆæœ¬ä¸­å·¥ä½œã€‚æŠŠå®ƒä»¬ç§»æ¤åˆ°ä¸åŒçš„è¯­è¨€ï¼Œç„¶åä¸ç»´æŠ¤å®ƒä»¬ï¼Œå¯èƒ½å°±åƒè¯•å›¾æŠŠ Linux 4.15 çš„è¡¥ä¸åº”ç”¨äº Linux 5.12ã€‚å¦‚æœä½ è¿æ°”å¥½ï¼Œå®ƒå°±ä¼šå·¥ä½œï¼å¦‚æœä½ ä¸èµ°è¿ï¼Œè¡¥ä¸å°±ä¼šåº”ç”¨ï¼Œä½†ä¼šä»¥ä¸€ç§å¾®å¦™çš„æ–¹å¼ç ´åä¸€äº›ä¸œè¥¿ï¼Œç›´åˆ°åæ¥ä½ æ‰æ³¨æ„åˆ°ã€‚è¿™å–å†³äºå·¥å…·ã€‚\n\nä½œä¸ºä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œæˆ‘åœ¨ 2014 å¹´ä¼‘å‡æ—¶å†™äº† cachestat (8)ï¼Œç”¨äº Netflix cloudï¼Œå½“æ—¶æ˜¯ Linux 3.2 å’Œ 3.13 çš„æ··åˆç‰ˆæœ¬ã€‚BPF åœ¨è¿™äº›ç‰ˆæœ¬ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äº† Linux 3.2 ä¸Šçš„åŸºæœ¬ Ftrace åŠŸèƒ½ã€‚æˆ‘æŠŠè¿™ç§æ–¹æ³•æè¿°ä¸º [brittle](https:\/\/www.brendangregg.com\/blog\/2014-12-31\/linux-page-cache-hit-ratio.html)ï¼Œ [sandcastle](https:\/\/github.com\/brendangregg\/perf-tools\/blob\/master\/fs\/cachestat) éœ€è¦éšç€å†…æ ¸çš„å˜åŒ–è€Œè¿›è¡Œç»´æŠ¤ã€‚åæ¥ï¼Œå®ƒè¢«ç§»æ¤åˆ°äº†å¸¦æœ‰ kprobes çš„ BPF ä¸Šï¼Œç°åœ¨å·²ç»è¢«é‡å†™å¹¶åŒ…å«åœ¨å•†ä¸šå¯è§‚æµ‹æ€§äº§å“ä¸­ã€‚æˆ‘å¬è¯´å®ƒåœ¨è¾ƒæ–°çš„å†…æ ¸ä¸Šæœ‰é—®é¢˜ï¼Œæ‰“å°çš„è¾“å‡ºæ²¡æœ‰æ„ä¹‰ã€‚å®ƒçœŸçš„éœ€è¦ä¸€æ¬¡å¤§ä¿®ã€‚å½“æˆ‘ï¼ˆæˆ–æŸäººï¼‰åšäº†è¿™ä¸ªå·¥ä½œï¼Œä»»ä½•ä» bcc ä¸Šæ‹‰å–æ›´æ–°çš„äººéƒ½ä¼šè‡ªåŠ¨å¾—åˆ°å›ºå®šçš„ç‰ˆæœ¬ï¼Œä¸éœ€è¦è´¹åŠ›ã€‚é‚£äº›é‡å†™çš„äººå°†éœ€è¦é‡å†™è‡ªå·±çš„ç‰ˆæœ¬ã€‚æˆ‘æ‹…å¿ƒä»–ä»¬ä¸ä¼šè¿™æ ·åšï¼Œè€Œå®¢æˆ·å°†åœ¨å¤šå¹´æ¥ä¸€ç›´è¿è¡Œä¸€ä¸ªé”™è¯¯çš„ cachestat (8) ç‰ˆæœ¬ã€‚\n\nè¯·æ³¨æ„ï¼Œå¦‚æœåœ¨æˆ‘å†™ cachestat (8) çš„æ—¶å€™ï¼ŒBPF åœ¨æˆ‘çš„ç›®æ ‡ç¯å¢ƒä¸­æ˜¯å¯ç”¨çš„ï¼Œæˆ‘çš„ç¼–ç æ–¹å¼å°±ä¼šå®Œå…¨ä¸åŒã€‚äººä»¬æ­£åœ¨ç§»æ¤ä¸º Linux 3.2 ç¼–å†™çš„ä¸œè¥¿ï¼Œå¹¶åœ¨ Linux 5.x ä¸Šè¿è¡Œå®ƒã€‚\n\nåœ¨ä»¥å‰çš„ä¸€ç¯‡åšæ–‡ [An Unbelievable Demo](https:\/\/www.brendangregg.com\/blog\/2021-06-04\/an-unbelievable-demo.html) ä¸­ï¼Œè°ˆåˆ°äº†å¾ˆå¤šå¹´å‰å‘ç”Ÿçš„ç±»ä¼¼æƒ…å†µï¼Œå³åœ¨æ²¡æœ‰æ›´æ–°çš„æƒ…å†µä¸‹ä½¿ç”¨æ—§çš„è¿½è¸ªå·¥å…·ç‰ˆæœ¬ã€‚\n\næˆ‘æ‰€æè¿°çš„é—®é¢˜æ˜¯é’ˆå¯¹ BPF è½¯ä»¶å’Œå†…æ ¸è¿½è¸ªçš„ã€‚ä½œä¸ºä¸€ä¸ªä¸åŒçš„ä¾‹å­ï¼Œæˆ‘çš„ç«ç„°å›¾è½¯ä»¶å·²ç»è¢«é‡å†™äº†åå‡ æ¬¡ï¼Œç”±äºå®ƒæ˜¯ä¸€ä¸ªç®€å•è€Œå®Œå¤‡çš„ç®—æ³•ï¼Œæˆ‘ä¸è®¤ä¸ºè¿™æœ‰ä»€ä¹ˆå¤§é—®é¢˜ã€‚æˆ‘æ›´å–œæ¬¢äººä»¬å¸®åŠ©æ›´æ–° [d3 version](https:\/\/github.com\/spiermar\/d3-flame-graph) ä½†å¦‚æœäººä»¬è‡ªå·±åšï¼Œé‚£ä¹Ÿæ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚ä½ å¯ä»¥ç»™å®ƒç¼–ç ï¼Œå®ƒå°†æ°¸è¿œå·¥ä½œã€‚åŸºäº uprobe å’Œ kprobe çš„ BPF å·¥å…·å°±ä¸æ˜¯è¿™æ ·äº†ï¼Œå› ä¸ºå®ƒä»¬ç¡®å®éœ€è¦ç»´æŠ¤ã€‚\n\n## åƒç³»ç»Ÿç®¡ç†å‘˜ä¸€æ ·æ€è€ƒï¼Œè€Œä¸æ˜¯åƒç¨‹åºå‘˜ä¸€æ ·æ€è€ƒ\n\næ€»ä¹‹ï¼Œé¦–å…ˆæ£€æŸ¥ä½ çš„ç›‘æ§ç³»ç»Ÿæ˜¯å¦å·²ç»æœ‰ä¸€ä¸ª BPF ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åœ¨ç°æœ‰çš„åŸºç¡€ä¸Šæ„å»ºä¸€ä¸ª [bcc](https:\/\/github.com\/iovisor\/bcc) æˆ– [bpftrace](https:\/\/github.com\/iovisor\/bpftrace) å·¥å…·ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹é‡å†™ä¸€åˆ‡ã€‚è¿™æ˜¯åƒä¸€ä¸ªå®‰è£…å’Œç»´æŠ¤è½¯ä»¶çš„ç³»ç»Ÿç®¡ç†å‘˜é‚£æ ·æ€è€ƒï¼Œè€Œä¸æ˜¯åƒä¸€ä¸ªç¼–ç æ‰€æœ‰ä¸œè¥¿çš„ç¨‹åºå‘˜é‚£æ ·æ€è€ƒã€‚å®‰è£… bcc æˆ– bpftrace å·¥å…·ï¼ŒæŠŠå®ƒä»¬æ·»åŠ åˆ°ä½ çš„å¯è§‚æµ‹æ€§äº§å“ä¸­ï¼Œå¹¶æ ¹æ®éœ€è¦æ‹‰å–åŒ…çš„æ›´æ–°ã€‚è¿™å°†æ˜¯ä¸€ä¸ªå¿«é€Ÿè€Œæœ‰ç”¨çš„ç‰ˆæœ¬ã€‚BPF å¯åŠ¨å’Œè¿è¡Œäº†ï¼\n\næˆ‘çœ‹åˆ°äººä»¬åè€Œåƒç¨‹åºå‘˜ä¸€æ ·æ€è€ƒï¼Œè§‰å¾—ä»–ä»¬å¿…é¡»ä»æ·±å…¥å­¦ä¹  bcc å’Œ BPF ç¼–ç¨‹ã€‚ç„¶åï¼Œåœ¨å‘ç°æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯ C è¯­è¨€æˆ– Python å†™çš„ä¹‹åï¼Œæœ‰äº›äººå°±ç”¨ä¸åŒçš„è¯­è¨€é‡å†™äº†ã€‚\n\né¦–å…ˆï¼Œå­¦å¥½ bcc å’Œ BPF éœ€è¦å‡ å‘¨æ—¶é—´ï¼›å­¦ä¹ ç³»ç»Ÿè·Ÿè¸ªçš„å¾®å¦™ä¹‹å¤„å’Œé™·é˜±å¯èƒ½éœ€è¦å‡ ä¸ªæœˆæˆ–å‡ å¹´ã€‚ä¸ºäº†è®©ä½ äº†è§£ä½ æ‰€é¢ä¸´çš„æƒ…å†µï¼Œè¯·çœ‹æˆ‘çš„ [BPF Internals](https:\/\/www.brendangregg.com\/blog\/2021-06-15\/bpf-internals.html) è®²åº§ã€‚å¦‚æœä½ çœŸçš„æƒ³åšè¿™ä¸ªï¼Œå¹¶ä¸”æœ‰æ—¶é—´ï¼Œä½ å½“ç„¶å¯ä»¥ï¼ˆä½ å¯èƒ½ä¼šåœ¨ Tracing ä¼šè®®ä¸Šé‡åˆ°æˆ‘ã€‚åœ¨ Linux Plumberâ€™s æˆ–è¿½ Tracing ä¼šä¸Šè§ï¼ï¼‰ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨æŸä¸ªæœŸé™å†…è¦å¢åŠ  BPF çš„å¯è§‚æµ‹æ€§ï¼Œé‚£å°±è¯•ç€åƒä¸€ä¸ªç³»ç»Ÿç®¡ç†å‘˜é‚£æ ·æ€è€ƒï¼Œå¹¶åœ¨ç°æœ‰çš„å·¥å…·åŸºç¡€ä¸Šè¿›è¡Œæ„å»ºã€‚è¿™æ˜¯å¿«é€Ÿçš„æ–¹æ³•ã€‚ä»¥åå†åƒç¨‹åºå‘˜é‚£æ ·æ€è€ƒï¼Œå¦‚æœä½ æœ‰æ—¶é—´çš„è¯ã€‚\n\nç¬¬äºŒï¼ŒBPF è½¯ä»¶ï¼Œç‰¹åˆ«æ˜¯æŸäº›åŸºäº kprobe çš„å·¥å…·ï¼Œéœ€è¦æŒç»­çš„ç»´æŠ¤ã€‚ä¸€ä¸ªå·¥å…·å¯èƒ½åœ¨ Linux 5.3 ä¸Šå·¥ä½œï¼Œä½†åœ¨ 5.4 ä¸Šå°±ä¼šåæ‰ï¼Œå› ä¸ºä¸€ä¸ªè¢«è¿½è¸ªçš„å‡½æ•°è¢«é‡æ–°å‘½åæˆ–å¢åŠ äº†ä¸€ä¸ªæ–°çš„ä»£ç è·¯å¾„ã€‚BPF åº“å’Œæ¡†æ¶ä¹Ÿåœ¨å˜åŒ–å’Œå‘å±•ï¼Œæœ€è¿‘çš„ä¸€æ¬¡æ˜¯ BTF å’Œ CO-RE æ”¯æŒã€‚è¿™æ˜¯æˆ‘å¸Œæœ›äººä»¬åœ¨é€‰æ‹©é‡å†™å®ƒä»¬ä¹‹å‰è¦è€ƒè™‘çš„é—®é¢˜ã€‚ä½ æ˜¯å¦ä¹Ÿæœ‰è®¡åˆ’é‡å†™æ‰€æœ‰çš„æ›´æ–°ï¼Œæˆ–è€…ä½ æœ€ç»ˆä¼šè¢«å›°åœ¨ä¸€ä¸ªæ—§çš„åº“çš„ç«¯å£ä¸Šï¼Ÿæ‹‰å–æ‰€æœ‰çš„æ›´æ–°æ¯”ç»´æŠ¤ä½ è‡ªå·±çš„ç‰ˆæœ¬æ›´å®¹æ˜“ã€‚\n\næœ€åï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªæ¯”æˆ‘ä»¬åœ¨ bcc å’Œ bpftrace ä¸­ä½¿ç”¨çš„æ›´å¥½çš„ BPF åº“æˆ–æ¡†æ¶çš„å¥½ä¸»æ„å‘¢ï¼Ÿå’Œæˆ‘ä»¬è°ˆè°ˆï¼Œè¯•è¯•ï¼Œåˆ›æ–°ä¸€ä¸‹ã€‚æˆ‘ä»¬æ­£å¤„äº BPF æ—¶ä»£çš„å¼€ç«¯ï¼Œè¿˜æœ‰å¾ˆå¤šä¸œè¥¿éœ€è¦æ¢ç´¢ã€‚ä½†è¯·å…ˆäº†è§£ç°æœ‰çš„æƒ…å†µä»¥åŠä½ æ‰€æ‰¿æ‹…çš„ç»´æŠ¤è´Ÿæ‹…ã€‚ä½ çš„ç²¾åŠ›å¯èƒ½ä¼šè¢«ç”¨æ¥åœ¨ç°æœ‰çš„åŸºç¡€ä¸Šåˆ›é€ æ–°çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯ç§»æ¤æ—§çš„ä¸œè¥¿ã€‚\n', '\/trans\/how-to-add-bpf-observability\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡æ˜¯ç»™æƒ³è¦åœ¨äº§å“ä¸­å¼•å…¥ eBPF å¢åŠ å¯è§‚æµ‹æ€§äººå‘˜çš„å¿ å‘Šã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ebpf-wasm-service-mesh/">[è¯‘] eBPF å’Œ Wasmï¼šæ¢ç´¢æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„æœªæ¥</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/01/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://infoq.com/news/2022/01/ebpf-wasm-service-mesh/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('eBPF å’Œ Wasmï¼šæ¢ç´¢æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„æœªæ¥', 'eBPF å’Œ Wasm æ˜¯æœåŠ¡ç½‘æ ¼åº”ç”¨åœ¨æ•°æ®å¹³é¢ä¸Šå®ç°é«˜æ€§èƒ½çš„æ–°ç”ŸåŠ›é‡ã€‚å®ƒä»¬ä»ç„¶æ˜¯æ–°ç”Ÿçš„æŠ€æœ¯ï¼Œä½†æœ‰å¯èƒ½æˆä¸ºä»Šå¤©å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿä¸­ Linux å®¹å™¨çš„æ›¿ä»£å“æˆ–è¡¥å……ã€‚', '\n## ç¼–è€…æŒ‰\n\nå‰æ®µæ—¶é—´ï¼Œæœ‰äººæå‡ºä½¿ç”¨ eBPF å–ä»£æœåŠ¡ç½‘æ ¼ä¸­çš„ sidecar ä»£ç†ï¼Œè¯¥è§‚ç‚¹å·²ç»å‘å‡ºï¼Œå°±åœ¨æœåŠ¡ç½‘æ ¼å’Œäº‘åŸç”Ÿç¤¾åŒºä¸­å¼•èµ·äº†â€œè½©ç„¶å¤§æ³¢â€ã€‚åæ¥ä¹Ÿæœ‰ä¸å°‘äººæŒ‡å‡ºè¯¥æ–¹æ¡ˆå®å±æ­¦æ–­ï¼Œä¸åˆ‡å®é™…ã€‚æœ¬æ–‡å°±æ€»ç»“äº† eBPF åœ¨æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢ä¸­çš„ä½œç”¨ï¼Œä»¥åŠä½¿ç”¨ Wasm è¿™ç§æ–°çš„æ–¹æ¡ˆã€‚\n\n## æ­£æ–‡\n\n2021 å¹´ 12 æœˆ 2 æ—¥ï¼ŒCilium é¡¹ç›®å®£å¸ƒäº† [Cilium Service Mesh](https:\/\/cilium.io\/blog\/2021\/12\/01\/cilium-service-mesh-beta) çš„ beta æµ‹è¯•è®¡åˆ’ã€‚åœ¨è°·æ­Œäº‘åŸºäº eBPF çš„ Google Cloud Kubernetes Serviceï¼ˆGKSï¼‰Dataplane V2ï¼ˆäº 2020 å¹´ 8 æœˆå‘å¸ƒï¼‰æ‰€å¼€åˆ›çš„æ¦‚å¿µåŸºç¡€ä¸Šï¼ŒCilium Service Mesh æå€¡â€œæ—  sidecar æœåŠ¡ç½‘æ ¼ \u0022 çš„ç†å¿µã€‚å®ƒæ‰©å±•äº† Cilium eBPF äº§å“ï¼Œä»¥å¤„ç†æœåŠ¡ç½‘æ ¼ä¸­çš„å¤§éƒ¨åˆ† sidecar ä»£ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ L7 è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ã€TLS ç»ˆæ­¢ã€è®¿é—®ç­–ç•¥ã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—å’Œè·Ÿè¸ªï¼Œä»¥åŠå†…ç½®çš„ Kubernetes Ingressã€‚\n\nCillium çš„åˆ›å»ºè€… Isovalent åœ¨ä¸€ç¯‡é¢˜ä¸ºâ€œ[å‘Šåˆ« Sidecarâ€”â€” ä½¿ç”¨ eBPF è§£é”å†…æ ¸çº§æœåŠ¡ç½‘æ ¼](https:\/\/cloudnative.to\/blog\/ebpf-solve-service-mesh-sidecar\/) â€œçš„æ–‡ç« ä¸­è§£é‡Šäº†ä½¿ç”¨ eBPF ä½œä¸º sidecar ä»£ç†çš„ç†ç”±ã€‚\n\nå®ƒå°†æŠŠæˆ‘ä»¬ä» sidecar æ¨¡å‹ä¸­è§£æ”¾å‡ºæ¥ï¼Œå¹¶å…è®¸æˆ‘ä»¬å°†ç°æœ‰çš„ä»£ç†æŠ€æœ¯æ•´åˆåˆ°ç°æœ‰çš„å†…æ ¸å‘½åç©ºé—´æ¦‚å¿µä¸­ï¼Œä½¿å®ƒä»¬æˆä¸ºæˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨çš„å®¹å™¨æŠ½è±¡çš„ä¸€éƒ¨åˆ†ã€‚\n\nç®€è€Œè¨€ä¹‹ï¼ŒeBPF æœ‰æœ›è§£å†³æœåŠ¡ç½‘æ ¼ä¸­çš„ä¸€ä¸ªä¸»è¦ç—›ç‚¹ â€”â€” å½“æœ‰è®¸å¤šç»†ç²’åº¦çš„å¾®æœåŠ¡æ—¶ï¼Œæ€§èƒ½å ªå¿§ã€‚ç„¶è€Œï¼Œä½¿ç”¨ eBPF æ¥å–ä»£ sidecar ä»£ç†è¿™ä¸ªæƒ³æ³•ä¹Ÿæ˜¯å­˜åœ¨äº‰è®®çš„ã€‚\n\n![å‘Šåˆ« sidecar](008i3skNly1gy9u3uba27j31x70u0dk7.jpg) \n\nï¼ˆæ¥æºï¼š[å‘Šåˆ« Sidecarâ€”â€” ä½¿ç”¨ eBPF è§£é”å†…æ ¸çº§æœåŠ¡ç½‘æ ¼](https:\/\/cloudnative.to\/blog\/ebpf-solve-service-mesh-sidecar\/)ï¼‰\n\næœåŠ¡ç½‘æ ¼ä¸­çš„æ•°æ®å¹³é¢æŒ‡çš„æ˜¯ç®¡ç†æ•°æ®æµé‡å¦‚ä½•è¢«è·¯ç”±å’Œäº¤ä»˜ç»™å¾®æœåŠ¡åº”ç”¨çš„åŸºç¡€è®¾æ–½æœåŠ¡ã€‚ç›®å‰ï¼Œè¿™æ˜¯é€šè¿‡ä½¿ç”¨æœåŠ¡ä»£ç†æ¥å®ç°çš„ã€‚è¿™ç§è®¾è®¡æ¨¡å¼é€šå¸¸ä¹Ÿè¢«ç§°ä¸º Sidecar æ¨¡å¼ã€‚Sidecar å…è®¸å…¶é™„å±çš„å¾®æœåŠ¡é€æ˜åœ°ä¸æœåŠ¡ç½‘æ ¼ä¸­çš„å…¶ä»–ç»„ä»¶å‘å‡ºå’Œæ¥æ”¶è¯·æ±‚ã€‚\n\nSidecar é€šå¸¸åŒ…å«ä¸€ä¸ª L7 ç½‘ç»œä»£ç†ï¼Œå¦‚ [Envoy](https:\/\/envoyproxy.io\/)ã€[Linkerd](https:\/\/linkerd.io\/) æˆ– [MOSN](https:\/\/mosn.io\/)ã€‚è¯¥ä»£ç†å¤„ç†æµé‡è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ã€è®¤è¯ã€æˆæƒã€åŠ å¯†ã€æ—¥å¿—ã€è·Ÿè¸ªå’Œç»Ÿè®¡æ•°æ®æ”¶é›†ã€‚Sidecar è¿˜å¯ä»¥åŒ…å«ä¸€ä¸ªåŸºäº SDK çš„åº”ç”¨æ¡†æ¶ï¼Œå¦‚ [Dapr](https:\/\/dapr.io\/)ï¼Œä»¥æä¾›ç½‘ç»œä»£ç†ä»¥å¤–çš„åº”ç”¨æœåŠ¡ã€‚è¿™ç§åº”ç”¨æœåŠ¡çš„ä¾‹å­åŒ…æ‹¬æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ã€èµ„æºç»‘å®šã€åŸºäºåç§°çš„æœåŠ¡è°ƒç”¨ã€çŠ¶æ€ç®¡ç†ã€è¡Œä¸ºè€…æ¡†æ¶å’Œç§˜å¯†å­˜å‚¨ã€‚\n\nSidecar ä»£ç†å’ŒæœåŠ¡é€šå¸¸åœ¨ Kubernetes pod æˆ–å®¹å™¨å†…è¿è¡Œã€‚å¾®æœåŠ¡åº”ç”¨ä¹Ÿåœ¨å®¹å™¨å†…è¿è¡Œï¼Œå®ƒä»¬é€šè¿‡ç½‘ç»œæ¥å£è¿æ¥åˆ° sidecar ä¸Šã€‚ç„¶è€Œï¼Œè¿™äº›å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªé‡è¦é—®é¢˜æ˜¯èµ„æºæ¶ˆè€—ã€‚Sidecar æœåŠ¡éšç€å¾®æœåŠ¡çš„æ•°é‡å‘ˆå‡ ä½•çº§æ•°å¢åŠ ã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰æ•°ç™¾ä¸ªç›¸äº’è”ç³»å’Œè´Ÿè½½å‡è¡¡çš„å¾®æœåŠ¡æ—¶ï¼Œå¼€é”€å¯èƒ½å˜å¾—ä¸å ªé‡è´Ÿã€‚æœåŠ¡ç½‘æ ¼ä»£ç†ä¾›åº”å•†åœ¨æ€§èƒ½ä¸Šå±•å¼€ç«äº‰ã€‚æ­£å¦‚ [InfoQ ä¹‹å‰æŠ¥é“çš„](https:\/\/www.infoq.com\/news\/2021\/08\/linkerd-rust-cloud-native\/)é‚£æ ·ï¼ŒLinkerd å°†å…¶ä»£ç†ä» Go é‡å†™æˆäº† Rustï¼Œå¹¶å–å¾—äº†æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚\n\nä¸è¶³ä¸ºå¥‡çš„æ˜¯ï¼Œç°æœ‰çš„æœåŠ¡ç½‘æ ¼ä¾›åº”å•†å¹¶ä¸ç›¸ä¿¡ eBPF æ˜¯èƒ½è§£å†³æˆ‘ä»¬æ‰€æœ‰é—®é¢˜çš„åœ£æ¯ã€‚æ¥è‡ª Solo çš„ Idit Levine ç­‰äººå†™äº†ä¸€ç¯‡æ–‡ç« æ¥å›åº” Cilium çš„å…¬å‘Šã€‚è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜æ˜¯â€œ[æœåŠ¡ç½‘æ ¼å°†ä½¿ç”¨ eBPFï¼Ÿæ˜¯çš„ï¼Œä½† Envoy ä»£ç†å°†ç»§ç»­å­˜åœ¨](https:\/\/www.zhaohuabing.com\/post\/2021-12-19-ebpf-for-service-mesh\/) \u0022ã€‚\n\n\u003e åœ¨ Solo.ioï¼Œæˆ‘ä»¬è®¤ä¸º eBPF æ˜¯ä¼˜åŒ–æœåŠ¡ç½‘æ ¼çš„ä¸€ç§å¼ºå¤§æ–¹å¼ï¼Œæˆ‘ä»¬è®¤ä¸º Envoy ä»£ç†æ˜¯æ•°æ®å¹³é¢çš„åŸºçŸ³ã€‚\n\nSolo.io ä½œè€…æå‡ºçš„å…³é”®ç‚¹æ˜¯ï¼Œç°åœ¨çš„ sidecar ä»£ç†æ‰€åšçš„äº‹æƒ…è¿œè¿œè¶…è¿‡äº†ç®€å•çš„ç½‘ç»œæµé‡ç®¡ç†ã€‚åœ¨ä»Šå¤©çš„æœåŠ¡ç½‘æ ¼éƒ¨ç½²ä¸­ï¼Œæœ‰ä¸€äº›å¤æ‚çš„è¦æ±‚ï¼Œè¿œè¿œè¶…è¿‡äº† eBPF æ‰€æ”¯æŒçš„æœ‰é™çš„ç¼–ç¨‹æ¨¡å‹ï¼ŒeBPF æ˜¯å›¾çµä¸å®Œæ•´çš„ï¼Œå¯¹å†…æ ¸çš„å®‰å…¨æ€§æœ‰è®¸å¤šé™åˆ¶ã€‚Cilium eBPF äº§å“å¯ä»¥å¤„ç†è®¸å¤šï¼Œä½†ä¸æ˜¯å…¨éƒ¨ï¼Œç”± sidecar ä»£ç†æ‰§è¡Œçš„å„ç§ä»»åŠ¡ã€‚æ­¤å¤–ï¼ŒSolo.io çš„ä½œè€…æŒ‡å‡ºï¼ŒeBPF çš„æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªä»£ç†çš„è®¾ç½®æä¾›äº†æ›´å°‘çš„çµæ´»æ€§ï¼Œå› æ­¤ä¸ä¼ ç»Ÿä»£ç†çš„æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªä»£ç†çš„è®¾ç½®ç›¸æ¯”ï¼Œå¢åŠ äº†æ•´ä½“å¼€é”€ã€‚è¿™äº› eBPF çš„ç¼ºç‚¹å¯¹äºå¼€å‘è€…å¿…é¡»ç¼–å†™å¹¶éƒ¨ç½²åˆ°æœåŠ¡ç½‘æ ¼ä»£ç†ä¸­çš„æµé‡è·¯ç”±ã€è´Ÿè½½å‡è¡¡å’Œæˆæƒçš„ç‰¹å®šåº”ç”¨é€»è¾‘æ¥è¯´å°¤å…¶æ˜æ˜¾ã€‚\n\nTerate.io çš„å¼€å‘è€…åœ¨å¯¹ Cilium å…¬å‘Šçš„å›åº”ä¸­æå‡ºäº†ç±»ä¼¼çš„è®ºç‚¹ï¼Œæ ‡é¢˜æ˜¯â€œ[ç¤¾åŒºä¸­å…³äº Istio å’ŒæœåŠ¡ç½‘æ ¼çš„äº‰è®º](https:\/\/www.tetrate.io\/blog\/the-debate-in-the-community-about-istio-and-service-mesh\/) \u0022ã€‚ä»–ä»¬æŒ‡å‡ºï¼Œä»Šå¤©çš„ sidecar ä»£ç†çš„æ€§èƒ½æ˜¯åˆç†çš„ï¼Œå¼€æºç¤¾åŒºå·²ç»æƒ³å‡ºäº†è¿›ä¸€æ­¥æé«˜æ€§èƒ½çš„æ–¹æ³•ã€‚åŒæ—¶ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œåœ¨ eBPF è¿™ç§æ–°é¢–çš„ã€å›¾çµä¸å®Œæ•´çš„æŠ€æœ¯ä¸­æ„å»ºç‰¹å®šåº”ç”¨çš„æ•°æ®å¹³é¢é€»è¾‘æ˜¯éå¸¸å›°éš¾çš„ã€‚\n\n\u003e Istio æ¶æ„æ˜¯ç¨³å®šçš„ï¼Œå¯ç”¨äºç”Ÿäº§çš„ï¼Œè€Œä¸”ç”Ÿæ€ç³»ç»Ÿæ­£åœ¨èŒèŠ½ã€‚\n\neBPF çš„è®¸å¤šé—®é¢˜ä¸ä»¥ä¸‹äº‹å®æœ‰å…³ï¼šå®ƒæ˜¯ä¸€ç§å†…æ ¸æŠ€æœ¯ï¼Œå› æ­¤å¿…é¡»æœ‰å®‰å…¨é™åˆ¶ã€‚æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å°†å¤æ‚çš„ç‰¹å®šåº”ç”¨çš„ä»£ç†é€»è¾‘çº³å…¥æ•°æ®å¹³é¢ï¼Œè€Œä¸ä½¿ç”¨ä½¿ç”¨ç©ºé—´æŠ€æœ¯é™ä½æ€§èƒ½ï¼Ÿäº‹å®è¯æ˜ï¼ŒWebAssemblyï¼ˆWasmï¼‰å¯èƒ½æ­£æ˜¯è¿™ç§é€‰æ‹©ã€‚Wasm è¿è¡Œæ—¶å¯ä»¥å®‰å…¨åœ°éš”ç¦»å¹¶ä»¥æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç ã€‚\n\nEnvoy Proxy å¼€åˆ›äº†ä½¿ç”¨ Wasm ä½œä¸ºæ‰©å±•æœºåˆ¶å¯¹æ•°æ®å¹³é¢è¿›è¡Œç¼–ç¨‹çš„æ–¹æ³•ã€‚å¼€å‘äººå‘˜å¯ä»¥ç”¨ Cã€C\u002b\u002bã€Rustã€AssemblyScriptã€Swift å’Œ TinyGo ç­‰è¯­è¨€ç¼–å†™ç‰¹å®šåº”ç”¨çš„ä»£ç†é€»è¾‘ï¼Œå¹¶å°†è¯¥æ¨¡å—ç¼–è¯‘åˆ° Wasm ä¸­ã€‚é€šè¿‡ proxy-Wasm æ ‡å‡†ï¼Œä»£ç†å¯ä»¥åœ¨ [Wasmtime](https:\/\/github.com\/bytecodealliance\/wasmtime) å’Œ [WasmEdge](https:\/\/github.com\/WasmEdge\/WasmEdge) ç­‰é«˜æ€§èƒ½è¿è¡Œæœºåˆ¶ä¸­æ‰§è¡Œé‚£äº› Wasm æ’ä»¶ã€‚ç›®å‰ï¼Œ[Envoy Proxy](https:\/\/envoyproxy.io\/)ã€[Istio Proxy](https:\/\/github.com\/istio\/proxy)ã€MOSN å’Œ [OpenResty](http:\/\/openresty.org\/) æ”¯æŒ [proxy-Wasm](https:\/\/github.com\/proxy-wasm)ã€‚\n\n![å®¹å™¨ç”Ÿæ€](008i3skNly1gy9u3wo1dnj30u015yq70.jpg) \n\nï¼ˆå®¹å™¨ç”Ÿæ€ç³»ç»Ÿä¸­çš„ Wasmï¼Œæ¥æºï¼š[WasmEdge Book](https:\/\/wasmedge.org\/book\/en\/kubernetes.html)ï¼‰\n\næ­¤å¤–ï¼ŒWasm å¯ä»¥ä½œä¸ºä¸€ä¸ªé€šç”¨çš„åº”ç”¨å®¹å™¨ã€‚å®ƒåœ¨æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢ä¸Šçš„åº”ç”¨å¹¶ä¸é™äº sidecar ä»£ç†ã€‚é™„åœ¨ sidecar ä¸Šçš„å¾®æœåŠ¡å¯ä»¥åœ¨å®ƒè‡ªå·±çš„è½»é‡çº§ Wasm è¿è¡Œæ—¶è¿è¡Œã€‚WasmEdge WebAssembly è¿è¡Œæ—¶æ˜¯ä¸€ä¸ªå®‰å…¨ã€è½»é‡çº§ã€å¿«é€Ÿã€å¯ç§»æ¤å’Œå¤šå…ƒåŒ–çš„è¿è¡Œæ—¶ï¼Œå¯ä»¥ç›´æ¥ç”± [Kubernetes ä½œä¸ºå®¹å™¨](https:\/\/wasmedge.org\/book\/en\/kubernetes.html)ç®¡ç†ã€‚åˆ° 2021 å¹´ 12 æœˆï¼ŒWasmEdge ç¤¾åŒºçš„è´¡çŒ®è€…è¯æ˜äº†åŸºäº WasmEdge çš„å¾®æœåŠ¡å¯ä»¥ä¸ [Dapr](https:\/\/github.com\/second-state\/dapr-wasm) å’Œ [Linkerd](https:\/\/github.com\/Liquid-Reply\/kind-crun-wasm) ä¸€èµ·å·¥ä½œï¼Œä½œä¸ºå¸¦æœ‰æ“ä½œç³»ç»Ÿå’Œå®Œæ•´è½¯ä»¶å †æ ˆçš„é‡é‡çº§å…¨é¢çš„ Linux å®¹å™¨çš„æ›¿ä»£ã€‚WebAssembly å¾®æœåŠ¡æ¶ˆè€— 1% çš„èµ„æºï¼Œä¸ Linux å®¹å™¨åº”ç”¨ç›¸æ¯”ï¼Œå†·å¯åŠ¨çš„æ—¶é—´æ˜¯ 1%ã€‚\n\neBPF å’Œ Wasm æ˜¯æœåŠ¡ç½‘æ ¼åº”ç”¨åœ¨æ•°æ®å¹³é¢ä¸Šå®ç°é«˜æ€§èƒ½çš„æ–°ç”ŸåŠ›é‡ã€‚å®ƒä»¬ä»ç„¶æ˜¯æ–°ç”Ÿçš„æŠ€æœ¯ï¼Œä½†æœ‰å¯èƒ½æˆä¸ºä»Šå¤©å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿä¸­ Linux å®¹å™¨çš„æ›¿ä»£å“æˆ–è¡¥å……ã€‚\n', '\/trans\/ebpf-wasm-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">eBPF å’Œ Wasm æ˜¯æœåŠ¡ç½‘æ ¼åº”ç”¨åœ¨æ•°æ®å¹³é¢ä¸Šå®ç°é«˜æ€§èƒ½çš„æ–°ç”ŸåŠ›é‡ã€‚å®ƒä»¬ä»ç„¶æ˜¯æ–°ç”Ÿçš„æŠ€æœ¯ï¼Œä½†æœ‰å¯èƒ½æˆä¸ºä»Šå¤©å¾®æœåŠ¡ç”Ÿæ€ç³»ç»Ÿä¸­ Linux å®¹å™¨çš„æ›¿ä»£å“æˆ–è¡¥å……ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ebpf-solve-service-mesh-sidecar/">[è¯‘] å‘Šåˆ« Sidecarâ€”â€”ä½¿ç”¨ eBPF è§£é”å†…æ ¸çº§æœåŠ¡ç½‘æ ¼</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2021/12/09</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://isovalent.com/blog/post/2021-12-08-ebpf-servicemesh" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('å‘Šåˆ« Sidecarâ€”â€”ä½¿ç”¨ eBPF è§£é”å†…æ ¸çº§æœåŠ¡ç½‘æ ¼', 'æœ¬æ–‡å›é¡¾äº† Linux å†…æ ¸çš„è¿æ¥æ€§ï¼Œå®ç°æœåŠ¡ç½‘æ ¼çš„å‡ ç§æ¨¡å¼ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ eBPF å®ç°æ—  Sidecar çš„æœåŠ¡ç½‘æ ¼ã€‚', '\nè¯‘è€…æ³¨ï¼šæœ¬æ–‡ä½œè€…æ˜¯ Isovalent è”åˆåˆ›å§‹äºº\u0026CTOï¼ŒåŸæ–‡æ ‡é¢˜ [How eBPF will solve Service Mesh - Goodbye Sidecars](https:\/\/isovalent.com\/blog\/post\/2021-12-08-ebpf-servicemesh)ï¼Œä½œè€…å›é¡¾äº† Linux å†…æ ¸çš„è¿æ¥æ€§ï¼Œå®ç°æœåŠ¡ç½‘æ ¼çš„å‡ ç§æ¨¡å¼ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ eBPF å®ç°æ—  Sidecar çš„æœåŠ¡ç½‘æ ¼ã€‚\n\n------\n\n## ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ\n\néšç€åˆ†å¸ƒå¼åº”ç”¨çš„å¼•å…¥ï¼Œé¢å¤–çš„å¯è§æ€§ã€è¿æ¥æ€§å’Œå®‰å…¨æ€§è¦æ±‚ä¹Ÿæµ®å‡ºæ°´é¢ã€‚åº”ç”¨ç¨‹åºç»„ä»¶é€šè¿‡ä¸å—ä¿¡ä»»çš„ç½‘ç»œè·¨è¶Šäº‘å’Œé›†ç¾¤è¾¹ç•Œè¿›è¡Œé€šä¿¡ï¼Œè´Ÿè½½å‡è¡¡ã€å¼¹æ€§å˜å¾—è‡³å…³é‡è¦ï¼Œå®‰å…¨å¿…é¡»å‘å±•åˆ°å‘é€è€…å’Œæ¥æ”¶è€…éƒ½å¯ä»¥éªŒè¯å½¼æ­¤çš„èº«ä»½çš„æ¨¡å¼ã€‚åœ¨åˆ†å¸ƒå¼åº”ç”¨çš„æ—©æœŸï¼Œè¿™äº›è¦æ±‚æ˜¯é€šè¿‡ç›´æ¥å°†æ‰€éœ€çš„é€»è¾‘åµŒå…¥åˆ°åº”ç”¨ä¸­æ¥è§£å†³çš„ã€‚æœåŠ¡ç½‘æ ¼å°†è¿™äº›åŠŸèƒ½ä»åº”ç”¨ç¨‹åºä¸­æå–å‡ºæ¥ï¼Œä½œä¸ºåŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†æä¾›ç»™æ‰€æœ‰åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå› æ­¤ä¸å†éœ€è¦ä¿®æ”¹æ¯ä¸ªåº”ç”¨ç¨‹åºã€‚\n\n![æœåŠ¡ç½‘æ ¼ç¤ºæ„å›¾](008i3skNly1gx7wyna8jsj32e20sojtx.jpg)\n\nçºµè§‚ä»Šå¤©æœåŠ¡ç½‘æ ¼çš„åŠŸèƒ½è®¾ç½®ï¼Œå¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š\n\n- **å¼¹æ€§è¿æ¥**ï¼šæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„é€šä¿¡å¿…é¡»èƒ½å¤Ÿè·¨è¶Šè¾¹ç•Œï¼Œå¦‚äº‘ã€é›†ç¾¤å’Œåœºæ‰€ã€‚é€šä¿¡å¿…é¡»æ˜¯æœ‰å¼¹æ€§çš„å’Œå®¹é”™çš„ã€‚\n- **L7 æµé‡ç®¡ç†**ï¼šè´Ÿè½½å‡è¡¡ã€é€Ÿç‡é™åˆ¶å’Œå¼¹æ€§å¿…é¡»æ˜¯ L7 æ„ŸçŸ¥çš„ï¼ˆHTTPã€RESTã€gRPCã€WebSocket ç­‰ï¼‰ã€‚\n- **åŸºäºèº«ä»½çš„å®‰å…¨**ï¼šä¾é ç½‘ç»œæ ‡è¯†ç¬¦æ¥å®ç°å®‰å…¨å·²ç»ä¸å¤Ÿäº†ï¼Œå‘é€å’Œæ¥æ”¶æœåŠ¡éƒ½å¿…é¡»èƒ½å¤Ÿæ ¹æ®èº«ä»½è€Œä¸æ˜¯ç½‘ç»œæ ‡è¯†ç¬¦æ¥éªŒè¯å¯¹æ–¹ã€‚\n- **å¯è§‚æµ‹æ€§å’Œè·Ÿè¸ª**ï¼šè¿½è¸ªå’ŒæŒ‡æ ‡å½¢å¼çš„å¯è§‚æµ‹æ€§å¯¹äºç†è§£ã€ç›‘æ§å’Œæ’é™¤åº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œå¯ç”¨æ€§è‡³å…³é‡è¦ã€‚\n- **é€æ˜**ï¼šè¯¥åŠŸèƒ½å¿…é¡»ä»¥é€æ˜çš„æ–¹å¼æä¾›ç»™åº”ç”¨ç¨‹åºï¼Œå³ä¸éœ€è¦æ”¹å˜åº”ç”¨ç¨‹åºä»£ç ã€‚\n\nåœ¨æ—©æœŸï¼ŒæœåŠ¡ç½‘æ ¼çš„åŠŸèƒ½é€šå¸¸æ˜¯ä»¥åº“çš„å½¢å¼å®ç°çš„ï¼Œè¦æ±‚ç½‘æ ¼ä¸­çš„æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½è¦é“¾æ¥åˆ°ä»¥åº”ç”¨ç¨‹åºçš„è¯­è¨€æ¡†æ¶ç¼–å†™çš„åº“ã€‚ç±»ä¼¼çš„äº‹æƒ…ä¹Ÿå‘ç”Ÿåœ¨äº’è”ç½‘çš„æ—©æœŸï¼šæ›¾å‡ ä½•æ—¶ï¼Œåº”ç”¨ç¨‹åºè¿˜éœ€è¦è¿è¡Œè‡ªå·±çš„ TCP\/IP åè®®æ ˆï¼æ­£å¦‚æˆ‘ä»¬å°†åœ¨è¿™ç¯‡æ–‡ç« ä¸­è®¨è®ºçš„é‚£æ ·ï¼ŒæœåŠ¡ç½‘æ ¼æ­£åœ¨å‘å±•æˆä¸ºä¸€ç§å†…æ ¸è´£ä»»ï¼Œå°±åƒç½‘ç»œå †æ ˆä¸€æ ·ã€‚\n\n![åŸºäºåº“çš„æœåŠ¡ç½‘æ ¼æ¨¡å‹](008i3skNly1gx7wyowb55j31pi0k076p.jpg)\n\nä»Šå¤©ï¼ŒæœåŠ¡ç½‘æ ¼é€šå¸¸ä½¿ç”¨ä¸€ç§å«åš sidecar æ¨¡å‹çš„æ¶æ„æ¥å®ç°ã€‚è¿™ç§æ¶æ„å°†å®ç°ä¸Šè¿°åŠŸèƒ½çš„ä»£ç å°è£…åˆ°ç¬¬å››å±‚ä»£ç†ä¸­ï¼ŒæœåŠ¡é—´çš„æµé‡è¢«é‡å®šå‘åˆ°è¿™ä¸ªæ‰€è°“çš„ sidecar ä»£ç†ã€‚å®ƒä¹‹æ‰€ä»¥è¢«ç§°ä¸ºâ€œæŒæ–—â€ï¼Œæ˜¯å› ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªä»£ç†ï¼Œå°±åƒæŒæ–—é™„ç€åœ¨æ‘©æ‰˜è½¦ä¸Šä¸€æ ·ã€‚\n\n![åŸºäº Sidecar çš„æœåŠ¡ç½‘æ ¼æ¨¡å‹](008i3skNly1gx7wyqsefhj31pe0moq5h.jpg)\n\nè¿™ç§æ¶æ„çš„ä¼˜ç‚¹æ˜¯ï¼ŒæœåŠ¡ä¸å†éœ€è¦è‡ªå·±å®ç°æœåŠ¡ç½‘æ ¼çš„åŠŸèƒ½ã€‚å¦‚æœè®¸å¤šæœåŠ¡æ˜¯ç”¨ä¸åŒçš„è¯­è¨€ç¼–å†™éƒ¨ç½²çš„ï¼Œæˆ–è€…å¦‚æœä½ æ­£åœ¨è¿è¡Œä¸å¯å˜çš„ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œè¿™å°±å¾ˆæœ‰å¥½å¤„ã€‚\n\nè¿™ç§æ¨¡å¼çš„ç¼ºç‚¹æ˜¯æœ‰å¤§é‡çš„ä»£ç†ï¼Œè®¸å¤šé¢å¤–çš„ç½‘ç»œè¿æ¥ï¼Œä»¥åŠå¤æ‚çš„é‡å®šå‘é€»è¾‘ï¼Œå°†ç½‘ç»œæµé‡è¾“å…¥ä»£ç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ä»€ä¹ˆç±»å‹çš„ç½‘ç»œæµé‡å¯ä»¥è¢«é‡å®šå‘åˆ°ç¬¬å››å±‚ä»£ç†ä¸Šä¹Ÿæœ‰é™åˆ¶ã€‚ä»£ç†ï¼ˆProxyï¼‰åœ¨å…¶èƒ½æ”¯æŒçš„ç½‘ç»œåè®®æ–¹é¢æ˜¯æœ‰é™çš„ã€‚\n\n## è¿æ¥æ€§è½¬ç§»åˆ°å†…æ ¸ä¸­çš„å†å²\n\nå‡ åå¹´æ¥ï¼Œåœ¨åº”ç”¨ç¨‹åºä¹‹é—´æä¾›å®‰å…¨å¯é çš„è¿æ¥ä¸€ç›´æ˜¯æ“ä½œç³»ç»Ÿçš„è´£ä»»ã€‚æœ‰äº›äººå¯èƒ½è¿˜è®°å¾—æ—©æœŸ Unix å’Œ Linux æ—¶ä»£çš„ [TCP åŒ…è£…å™¨](https:\/\/en.wikipedia.org\/wiki\/TCP_Wrappers)å’Œ tcpdã€‚tcpd å…è®¸ç”¨æˆ·åœ¨ä¸ä¿®æ”¹åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹é€æ˜åœ°æ·»åŠ æ—¥å¿—ã€è®¿é—®æ§åˆ¶ã€ä¸»æœºåéªŒè¯å’Œæ¬ºéª—ä¿æŠ¤ã€‚å®ƒä½¿ç”¨äº† libwrapï¼Œè€Œä¸”ï¼Œåœ¨ä¸€ä¸ªæœ‰è¶£çš„å¹³è¡ŒäºæœåŠ¡ç½‘æ ¼çš„æ•…äº‹ä¸­ï¼Œè¿™ä¸ªåº“ä¹Ÿæ˜¯ä»¥å‰åº”ç”¨ç¨‹åºæä¾›è¿™äº›åŠŸèƒ½çš„é“¾æ¥å¯¹è±¡ã€‚tcpd æ‰€å¸¦æ¥çš„æ˜¯èƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ç°æœ‰åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹å°†è¿™äº›åŠŸèƒ½é€æ˜åœ°æ·»åŠ åˆ°ç°æœ‰åº”ç”¨ç¨‹åºä¸­ã€‚æœ€ç»ˆï¼Œæ‰€æœ‰è¿™äº›åŠŸèƒ½éƒ½è¿›å…¥äº† Linux æœ¬èº«ï¼Œå¹¶ä»¥ä¸€ç§æ›´æœ‰æ•ˆã€æ›´å¼ºå¤§çš„æ–¹å¼æä¾›ç»™æ‰€æœ‰åº”ç”¨ç¨‹åºã€‚ä»Šå¤©ï¼Œè¿™å·²ç»å‘å±•åˆ°äº†æˆ‘ä»¬æ‰€çŸ¥é“çš„ iptablesã€‚\n\nç„¶è€Œï¼Œiptables æ˜¾ç„¶ä¸é€‚åˆè§£å†³ç°ä»£åº”ç”¨çš„è¿æ¥æ€§ã€å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§è¦æ±‚ï¼Œå› ä¸ºå®ƒåªåœ¨ç½‘ç»œå±‚é¢ä¸Šæ“ä½œï¼Œå¯¹åº”ç”¨åè®®å±‚ç¼ºä¹ä»»ä½•äº†è§£ã€‚è‡ªç„¶ï¼Œé˜»åŠ›æœ€å°çš„è·¯å¾„æ˜¯å›åˆ°åº“æ¨¡å‹ï¼Œç„¶åæ˜¯ sidecar æ¨¡å‹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ­£å¤„äºè¿™æ ·ä¸€ä¸ªé˜¶æ®µï¼šä¸ºäº†æœ€ä½³çš„é€æ˜åº¦ã€æ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­åŸç”Ÿåœ°æ”¯æŒè¿™ç§æ¨¡å¼æ˜¯æœ‰æ„ä¹‰çš„ã€‚\n\n![æœåŠ¡ç½‘æ ¼çš„è¿›åŒ–](008i3skNly1gx7y8ybphhj31h30u041s.jpg) \n\nåœ¨ tcpd æ—¶ä»£ï¼Œæ›¾ç»çš„è¿æ¥è®°å½•ç°åœ¨æ˜¯è¿½è¸ªã€‚IP å±‚é¢çš„è®¿é—®æ§åˆ¶å·²ç»æ¼”å˜æˆåº”ç”¨åè®®å±‚é¢çš„æˆæƒï¼Œä¾‹å¦‚ä½¿ç”¨ JWTã€‚ä¸»æœºåéªŒè¯å·²è¢«æ›´å¼ºå¤§çš„è®¤è¯æ‰€å–ä»£ï¼Œå¦‚ mTLSã€‚ç½‘ç»œè´Ÿè½½å‡è¡¡å·²ç»æ‰©å±•åˆ° L7 æµé‡ç®¡ç†ã€‚HTTP é‡è¯•æ˜¯æ–°çš„ TCP é‡ä¼ ã€‚è¿‡å»ç”¨é»‘æ´è·¯ç”±è§£å†³çš„é—®é¢˜ä»Šå¤©è¢«ç§°ä¸ºæ–­è·¯ã€‚è¿™äº›éƒ½ä¸æ˜¯æ ¹æœ¬æ€§çš„æ–°é—®é¢˜ï¼Œä½†æ‰€éœ€çš„ç¯å¢ƒå’Œæ§åˆ¶å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚\n\n## æ‰©å±•å†…æ ¸å‘½åç©ºé—´æ¦‚å¿µ\n\nLinux å†…æ ¸å·²ç»æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œå¯ä»¥å…±äº«å…±åŒçš„åŠŸèƒ½ï¼Œå¹¶ä½¿å…¶å¯¹ç³»ç»Ÿä¸Šè¿è¡Œçš„è®¸å¤šåº”ç”¨ç¨‹åºå¯ç”¨ã€‚è¿™ä¸ªæ¦‚å¿µè¢«ç§°ä¸ºå‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œå®ƒæ„æˆäº†æˆ‘ä»¬ä»Šå¤©æ‰€çŸ¥çš„å®¹å™¨æŠ€æœ¯çš„åŸºç¡€ã€‚å‘½åç©ºé—´ï¼ˆå†…æ ¸çš„é‚£ç§ï¼Œä¸æ˜¯ Kubernetes çš„å‘½åç©ºé—´ï¼‰å­˜åœ¨äºå„ç§æŠ½è±¡ä¸­ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ç®¡ç†ã€æŒ‚è½½è®¾å¤‡ã€è¿›ç¨‹ã€ç½‘ç»œç­‰ã€‚è¿™å°±æ˜¯å…è®¸å•ä¸ªå®¹å™¨å‘ˆç°ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€ä¸åŒçš„ç”¨æˆ·é›†ï¼Œä»¥åŠå…è®¸å¤šä¸ªå®¹å™¨ç»‘å®šåˆ°å•ä¸ªä¸»æœºä¸Šçš„åŒä¸€ç½‘ç»œç«¯å£ã€‚åœ¨ cgroups çš„å¸®åŠ©ä¸‹ï¼Œè¿™ä¸ªæ¦‚å¿µå¾—åˆ°äº†æ‰©å±•ï¼Œå¯ä»¥å¯¹ CPUã€å†…å­˜å’Œç½‘ç»œç­‰èµ„æºè¿›è¡Œç®¡ç†å’Œä¼˜å…ˆæ’åºã€‚ä»äº‘åŸç”Ÿåº”ç”¨å¼€å‘è€…çš„è§’åº¦æ¥çœ‹ï¼Œcgroups å’Œèµ„æºè¢«ç´§å¯†åœ°æ•´åˆåˆ°æˆ‘ä»¬æ‰€çŸ¥çš„ \u0022å®¹å™¨\u0022 æ¦‚å¿µä¸­ã€‚\n\nç¬¦åˆé€»è¾‘çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è®¤ä¸ºæœåŠ¡ç½‘æ ¼æ˜¯æ“ä½œç³»ç»Ÿçš„è´£ä»»ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»ç¬¦åˆå¹¶æ•´åˆå‘½åç©ºé—´å’Œ cgroup çš„æ¦‚å¿µã€‚è¿™çœ‹èµ·æ¥ä¼šæ˜¯è¿™æ ·çš„ã€‚\n\n![Service Mesh Namespace](008i3skNly1gx7wypvr2zj31p20q0q75.jpg)\n\nä¸å‡ºæ‰€æ–™ï¼Œè¿™çœ‹èµ·æ¥éå¸¸è‡ªç„¶ï¼Œè€Œä¸”å¯èƒ½æ˜¯å¤§å¤šæ•°ç”¨æˆ·ä»ç®€å•çš„è§’åº¦æ‰€æœŸæœ›çš„ã€‚åº”ç”¨ç¨‹åºä¿æŒä¸å˜ï¼Œå®ƒä»¬ç»§ç»­ä½¿ç”¨å¥—æ¥å­—è¿›è¡Œé€šä¿¡ï¼Œå°±åƒä»¥å‰é‚£æ ·ã€‚ç†æƒ³çš„æœåŠ¡ç½‘æ ¼æ˜¯ä½œä¸º Linux çš„ä¸€éƒ¨åˆ†é€æ˜åœ°æä¾›çš„ã€‚å®ƒå°±åœ¨é‚£é‡Œï¼Œå°±åƒä»Šå¤©çš„ TCP ä¸€æ ·ã€‚\n\n### æ³¨å…¥ Sidecar çš„æˆæœ¬\n\nå¦‚æœæˆ‘ä»¬ä»”ç»†ç ”ç©¶ä¸€ä¸‹ sidecar æ¨¡å‹ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒå®é™…ä¸Šæ˜¯åœ¨è¯•å›¾æ¨¡ä»¿è¿™ç§æ¨¡å‹ã€‚åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨å¥—æ¥å­—ï¼Œä¸€åˆ‡éƒ½è¢«å¡è¿› Linux å†…æ ¸çš„ç½‘ç»œå‘½åç©ºé—´ã€‚ç„¶è€Œï¼Œè¿™æ¯”å®ƒçœ‹èµ·æ¥è¦å¤æ‚å¾—å¤šï¼Œéœ€è¦è®¸å¤šé¢å¤–çš„æ­¥éª¤æ¥é€æ˜åœ°æ³¨å…¥ sidecar ä»£ç†ã€‚\n\n![æ³¨å…¥ Sidecar çš„æˆæœ¬](008i3skNly1gx7y8nu479j31h30u041s.jpg) \n\n \n\nè¿™ç§é¢å¤–çš„å¤æ‚æ€§åœ¨å»¶è¿Ÿå’Œé¢å¤–èµ„æºæ¶ˆè€—æ–¹é¢ä»˜å‡ºäº†å·¨å¤§çš„ä»£ä»·ã€‚æ—©æœŸçš„åŸºå‡†æµ‹è¯•è¡¨æ˜ï¼Œè¿™å¯¹å»¶è¿Ÿçš„å½±å“é«˜è¾¾ 3-4 å€ï¼Œè€Œä¸”æ‰€æœ‰ä»£ç†éƒ½éœ€è¦å¤§é‡çš„é¢å¤–å†…å­˜ã€‚åœ¨è¿™ç¯‡æ–‡ç« çš„åé¢ï¼Œæˆ‘ä»¬å°†ç ”ç©¶è¿™ä¸¤ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å°†å…¶ä¸åŸºäº eBPF çš„æ¨¡å‹è¿›è¡Œæ¯”è¾ƒã€‚\n\n## ç”¨ eBPF è§£é”å†…æ ¸æœåŠ¡ç½‘æ ¼\n\nä¸ºä»€ä¹ˆæˆ‘ä»¬ä»¥å‰æ²¡æœ‰åœ¨å†…æ ¸ä¸­åˆ›å»ºä¸€ä¸ªæœåŠ¡ç½‘æ ¼ï¼Ÿæœ‰äº›äººåŠå¼€ç©ç¬‘åœ°è¯´ï¼Œkube-proxy æ˜¯æœ€åˆçš„æœåŠ¡ç½‘æ ¼ï¼ˆè§[æˆ‘ä»¬å·²ç»æ„å»ºäº†ç›¸å½“å¤šçš„æœåŠ¡ç½‘æ ¼ - Tim Hockin, Google](https:\/\/www.youtube.com\/watch?v=lUF88T16YqY\u0026ab_channel=CloudNativeRejekts)ï¼‰ã€‚è¿™å¥è¯æ˜¯æœ‰ä¸€å®šé“ç†çš„ã€‚Kube-proxy æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œè¯´æ˜äº† Linux å†…æ ¸åœ¨ä¾é ä¼ ç»Ÿçš„åŸºäºç½‘ç»œçš„ iptables åŠŸèƒ½å®ç°æœåŠ¡ç½‘æ ¼æ—¶ï¼Œå¯ä»¥è¾¾åˆ°å¤šä¹ˆæ¥è¿‘ã€‚ç„¶è€Œï¼Œè¿™è¿˜ä¸å¤Ÿï¼ŒL7 ä¸Šä¸‹æ–‡æ˜¯ç¼ºå¤±çš„ã€‚Kube-proxy å®Œå…¨åœ¨ç½‘ç»œæ•°æ®åŒ…å±‚é¢è¿ä½œã€‚ç°ä»£åº”ç”¨éœ€è¦ L7 æµé‡ç®¡ç†ã€è·Ÿè¸ªã€è®¤è¯å’Œé¢å¤–çš„å¯é æ€§ä¿è¯ã€‚Kube-proxy ä¸èƒ½åœ¨ç½‘ç»œå±‚é¢ä¸Šæä¾›è¿™äº›ã€‚\n\neBPF æ”¹å˜äº†è¿™ä¸ªæ¨¡å¼ã€‚å®ƒå…è®¸åŠ¨æ€åœ°æ‰©å±• Linux å†…æ ¸çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨ eBPF ä¸º Cilium å»ºç«‹ä¸€ä¸ªé«˜æ•ˆçš„ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§æ•°æ®é€šè·¯ï¼Œå¹¶å°†å…¶ç›´æ¥åµŒå…¥åˆ° Linux å†…æ ¸ã€‚åº”ç”¨è¿™ä¸ªç›¸åŒçš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å†…æ ¸å±‚é¢ä¸Šè§£å†³æœåŠ¡ç½‘æ ¼çš„è¦æ±‚ã€‚äº‹å®ä¸Šï¼ŒCilium å·²ç»å®ç°äº†å„ç§æ‰€éœ€çš„æ¦‚å¿µï¼Œå¦‚åŸºäºèº«ä»½çš„å®‰å…¨ã€L3-L7 å¯è§‚æµ‹æ€§å’Œæˆæƒã€åŠ å¯†å’Œè´Ÿè½½å‡è¡¡ã€‚ç¼ºå°‘çš„éƒ¨åˆ†ç°åœ¨æ­£åœ¨å‘ Cilium æ¶Œæ¥ã€‚åœ¨æœ¬åšå®¢çš„æœ«å°¾ï¼Œä½ ä¼šå‘ç°å¦‚ä½•åŠ å…¥ç”± Cilium ç¤¾åŒºæ¨åŠ¨çš„ Cilium æœåŠ¡ç½‘æ ¼æµ‹è¯•é¡¹ç›®çš„ç»†èŠ‚ã€‚\n\n![eBPF æœåŠ¡ç½‘æ ¼æ¶æ„](008i3skNly1gx7wyrufdyj31w90u0q6o.jpg) \n\n**æœ‰äººå¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆ Linux å†…æ ¸ç¤¾åŒºä¸ç›´æ¥è§£å†³è¿™äº›éœ€æ±‚**ã€‚eBPF æœ‰ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ï¼ŒeBPF ä»£ç å¯ä»¥åœ¨è¿è¡Œæ—¶æ’å…¥åˆ°ç°æœ‰çš„ Linux å†…æ ¸ä¸­ï¼Œç±»ä¼¼äº Linux å†…æ ¸æ¨¡å—ï¼Œä½†ä¸å†…æ ¸æ¨¡å—ä¸åŒï¼Œå®ƒå¯ä»¥ä»¥å®‰å…¨å’Œå¯ç§»æ¤çš„æ–¹å¼è¿›è¡Œã€‚è¿™ä½¿å¾— eBPF çš„å®ç°èƒ½å¤Ÿéšç€æœåŠ¡ç½‘æ ¼ç¤¾åŒºçš„å‘å±•è€Œç»§ç»­å‘å±•ã€‚**æ–°çš„å†…æ ¸ç‰ˆæœ¬éœ€è¦å‡ å¹´æ—¶é—´æ‰èƒ½è¿›å…¥ç”¨æˆ·æ‰‹ä¸­**ã€‚eBPF æ˜¯ä¸€é¡¹å…³é”®æŠ€æœ¯ï¼Œå®ƒä½¿ Linux å†…æ ¸èƒ½å¤Ÿè·Ÿä¸Šå¿«é€Ÿå‘å±•çš„äº‘åŸç”ŸæŠ€æœ¯æ ˆã€‚\n\n## æ—  Sidecar çš„åŸºäº eBPF çš„ L7 è¿½è¸ªå’Œåº¦é‡\n\nè®©æˆ‘ä»¬çœ‹çœ‹ L7 è¿½è¸ªå’ŒæŒ‡æ ‡å¯è§‚æµ‹æ€§ï¼Œä½œä¸ºä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œè¯´æ˜åŸºäº eBPF çš„æœåŠ¡ç½‘æ ¼å¯¹ä¿æŒä½å»¶è¿Ÿå’Œæé«˜è§‚å¯Ÿæ€§æœ‰å·¨å¤§çš„å½±å“ã€‚åº”ç”¨ç¨‹åºå›¢é˜Ÿä¾é åº”ç”¨ç¨‹åºçš„å¯è§æ€§å’Œç›‘æ§ä½œä¸ºåŸºæœ¬è¦æ±‚è¿™äº›ï¼Œè¿™åŒ…æ‹¬è¯·æ±‚è·Ÿè¸ªã€HTTP å“åº”ç‡å’ŒæœåŠ¡å»¶è¿Ÿä¿¡æ¯ç­‰èƒ½åŠ›ã€‚ç„¶è€Œï¼Œè¿™ç§å¯è§‚æµ‹æ€§åº”è¯¥æ²¡æœ‰æ˜æ˜¾çš„æˆæœ¬ï¼ˆå»¶è¿Ÿã€å¤æ‚æ€§ã€èµ„æºâ€¦ï¼‰ã€‚\n\n![åŸºäº eBPF çš„å¯è§†æ€§](008i3skNly1gx7wysxpr4j31ne0iugq1.jpg)\n\nåœ¨ä¸‹é¢çš„åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ—©æœŸçš„æµ‹é‡ç»“æœï¼Œå³é€šè¿‡ eBPF æˆ– sidecar æ–¹æ³•å®ç° HTTP å¯è§æ€§å¯¹å»¶è¿Ÿçš„å½±å“ã€‚è¯¥è®¾ç½®æ˜¯åœ¨ä¸¤ä¸ªä¸åŒèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä¸¤ä¸ª pod ä¹‹é—´é€šè¿‡å›ºå®šæ•°é‡çš„è¿æ¥æ¯ç§’ç¨³å®šè¿è¡Œ 10K ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶æµ‹é‡è¯·æ±‚çš„å¹³å‡å»¶æ—¶ã€‚\n\n![åŸºäº eBPF çš„å»¶è¿ŸåŸºå‡†æµ‹è¯• vs åŸºäº Sidecar çš„ L7 å¯è§†æ€§](008i3skNly1gx7wyt6izdj31ns0rawfw.jpg)\n\næˆ‘ä»¬æ•…æ„ä¸æè¿™äº›æµ‹é‡ä¸­ä½¿ç”¨çš„å…·ä½“ä»£ç†ï¼Œå› ä¸ºå®ƒå¹¶ä¸é‡è¦ã€‚å¯¹äºæˆ‘ä»¬æµ‹è¯•è¿‡çš„æ‰€æœ‰ä»£ç†ï¼Œç»“æœå‡ ä¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¦æ˜ç¡®çš„æ˜¯ï¼Œè¿™ä¸æ˜¯å…³äº Envoyã€Linkerdã€Nginx æˆ–å…¶ä»–ä»£ç†æ˜¯å¦æ›´å¿«ã€‚æ‰€æåˆ°çš„ä»£ç†æœ‰å·®å¼‚ï¼Œä½†ä¸é¦–å…ˆæ³¨å…¥ä»£ç†çš„æˆæœ¬ç›¸æ¯”ï¼Œå®ƒä»¬æ˜¯å¾®ä¸è¶³é“çš„ã€‚**å‡ ä¹æ²¡æœ‰å¼€é”€æ˜¯æ¥è‡ªä»£ç†æœ¬èº«çš„é€»è¾‘ã€‚å¼€é”€æ˜¯é€šè¿‡æ³¨å…¥ä»£ç†ï¼Œå°†ç½‘ç»œæµé‡é‡å®šå‘åˆ°å®ƒï¼Œç»ˆæ­¢è¿æ¥å’Œå¯åŠ¨æ–°çš„è¿æ¥è€Œå¢åŠ çš„ã€‚**\n\nè¿™äº›æ—©æœŸçš„æµ‹é‡ç»“æœè¡¨æ˜ï¼ŒåŸºäº eBPF çš„å†…æ ¸æ–¹æ³•æ˜¯éå¸¸æœ‰å‰é€”çš„ï¼Œå¯ä»¥å®ç°å®Œå…¨é€æ˜çš„æœåŠ¡ç½‘æ ¼çš„æ„¿æœ›ï¼Œè€Œä¸”æ²¡æœ‰æ˜æ˜¾çš„å¼€é”€ã€‚\n\n## ä½¿ç”¨ eBPF åŠ é€Ÿçš„ per-node ä»£ç†\n\nè¶Šæ¥è¶Šå¤šçš„ç”¨ä¾‹å¯ä»¥ç”¨è¿™ç§ä»…æœ‰ eBPF çš„æ–¹æ³•æ¥è¦†ç›–ï¼Œä»è€Œå®Œå…¨å–æ¶ˆ L4 ä»£ç†ã€‚æœ‰äº›ç”¨ä¾‹ï¼Œä»ç„¶éœ€è¦ä»£ç†ã€‚ä¾‹å¦‚ï¼Œå½“è¿æ¥éœ€è¦æ‹¼æ¥æ—¶ï¼Œå½“ TLS ç»ˆæ­¢è¢«æ‰§è¡Œæ—¶ï¼Œæˆ–å¯¹äºæŸäº›å½¢å¼çš„ HTTP æˆæƒã€‚\n\næˆ‘ä»¬çš„ eBPF æœåŠ¡ç½‘æ ¼å·¥ä½œå°†ç»§ç»­å…³æ³¨é‚£äº›ä»æ€§èƒ½è§’åº¦å¯ä»¥è·å¾—æœ€å¤§æ”¶ç›Šçš„é¢†åŸŸã€‚å¦‚æœä½ å¿…é¡»æ‰§è¡Œ TLS ç»ˆæ­¢ï¼Œä½ å¯èƒ½ä¸ä»‹æ„åœ¨æµé‡æµå…¥é›†ç¾¤æ—¶ç”¨ä»£ç†ç»ˆæ­¢ä¸€æ¬¡è¿æ¥ã€‚ç„¶è€Œï¼Œä½ ä¼šæ›´å…³å¿ƒåœ¨æ¯ä¸ªè¿æ¥çš„è·¯å¾„ä¸­æ³¨å…¥ä¸¤ä¸ªä»£ç†çš„å½±å“ï¼Œä»¥æå– HTTP æŒ‡æ ‡å’Œè·Ÿè¸ªæ•°æ®ã€‚\n\nå½“ä¸€ä¸ªç”¨ä¾‹ä¸èƒ½ç”¨çº¯ eBPF çš„æ–¹æ³•æ¥å®ç°æ—¶ï¼Œç½‘æ ¼å¯ä»¥å›é€€åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ä»£ç†æ¨¡å‹ï¼Œç›´æ¥å°†ä»£ç†ä¸å†…æ ¸çš„å¥—æ¥å­—å±‚ç»“åˆèµ·æ¥ã€‚\n\n![eBPF per-node Proxy](008i3skNly1gx7wyvrfmfj31vq0u0q87.jpg) \n\neBPF ä¸ä¾èµ–ç½‘ç»œçº§çš„é‡å®šå‘ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å¥—æ¥å­—çº§åˆ«æ³¨å…¥ä»£ç†ï¼Œä¿æŒè·¯å¾„çŸ­ã€‚åœ¨ Cilium çš„æ¡ˆä¾‹ä¸­ï¼Œæ­£åœ¨ä½¿ç”¨ Envoy ä»£ç†ï¼Œå°½ç®¡ä»æ¶æ„çš„è§’åº¦æ¥çœ‹ï¼Œä»»ä½•ä»£ç†éƒ½å¯ä»¥è¢«æ•´åˆåˆ°è¿™ä¸ªæ¨¡å‹ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™å…è®¸å°† Linux å†…æ ¸ç½‘ç»œå‘½åç©ºé—´çš„æ¦‚å¿µç›´æ¥æ‰©å±•åˆ° Envoy ç›‘å¬å™¨é…ç½®çš„æ¦‚å¿µï¼Œå¹¶å°† Envoy å˜æˆä¸€ä¸ªå¤šç”¨æˆ·ä»£ç†ã€‚\n\n## Sidecar ä¸ per-Node ä»£ç†\n\nå³ä½¿éœ€è¦ä»£ç†ï¼Œä»£ç†çš„æˆæœ¬ä¹Ÿä¼šæ ¹æ®éƒ¨ç½²çš„æ¶æ„è€Œæœ‰æ‰€ä¸åŒã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªèŠ‚ç‚¹çš„ä»£ç†æ¨¡å¼ä¸ sidecar æ¨¡å¼çš„æ¯”è¾ƒã€‚\n\n### æ¯ä¸ªè¿æ¥çš„ä»£ç†\n\næ‰€éœ€çš„ç½‘ç»œè¿æ¥æ•°å°†å› æ˜¯å¦æœ‰ä»£ç†è€Œä¸åŒã€‚æœ€ç®€å•çš„æƒ…å†µæ˜¯æ—  sidecar æ¨¡å¼ï¼Œè¿™æ„å‘³ç€ç½‘ç»œè¿æ¥çš„æ•°é‡æ²¡æœ‰å˜åŒ–ã€‚ä¸€ä¸ªå•ä¸€çš„è¿æ¥å°†ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼ŒeBPF å°†æä¾›æœåŠ¡ç½‘æ ¼åŠŸèƒ½ï¼Œå¦‚è·Ÿè¸ªæˆ–ç°æœ‰è¿æ¥ä¸Šçš„è´Ÿè½½å‡è¡¡ã€‚\n\n![åŸºäº eBPF çš„æ¨¡å‹](008i3skNly1gx7wyy16o4j32960kcwg9.jpg)\n\nç”¨ sidecar æ¨¡å‹æä¾›åŒæ ·çš„åŠŸèƒ½éœ€è¦åœ¨è¿æ¥ä¸­æ³¨å…¥ä¸¤æ¬¡ä»£ç†ï¼Œè¿™å¯¼è‡´éœ€è¦ç»´æŠ¤ä¸‰ä¸ªè¿æ¥ã€‚è¿™å¯¼è‡´äº†å¼€é”€çš„å¢åŠ å’Œæ‰€æœ‰é¢å¤–çš„å¥—æ¥å­—ç¼“å†²åŒºæ‰€éœ€å†…å­˜çš„å€å¢ï¼Œè¡¨ç°ä¸ºæ›´é«˜çš„æœåŠ¡é—´å»¶è¿Ÿã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨æ—  sidecar L7 å¯è§æ€§éƒ¨åˆ†çœ‹åˆ°çš„ sidecar å¼€é”€ã€‚\n\n![åŸºäº Sidecar ä»£ç†çš„æ¨¡å‹](008i3skNly1gx7wz3o1f6j32860lego3.jpg)\n\nåˆ‡æ¢åˆ° per-node çš„ä»£ç†æ¨¡å¼ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ‘†è„±å…¶ä¸­ä¸€ä¸ªä»£ç†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†ä¾èµ–åœ¨æ¯ä¸ªå·¥ä½œè´Ÿè½½ä¸­è¿è¡Œä¸€ä¸ª sidecarã€‚æ¯”èµ·ä¸éœ€è¦é¢å¤–çš„è¿æ¥ï¼Œè¿™è¿˜æ˜¯ä¸å¤Ÿç†æƒ³ï¼Œä½†æ¯”èµ·æ€»æ˜¯éœ€è¦ä¸¤ä¸ªé¢å¤–çš„è¿æ¥è¦å¥½ã€‚\n\n![Per-node ä»£ç†æ¨¡å¼](008i3skNly1gx7wyx2lulj32980o4dhz.jpg)\n\n### æ‰€éœ€çš„ä»£ç†æ€»æ•°\n\nåœ¨æ¯ä¸ªå·¥ä½œè´Ÿè½½ä¸­è¿è¡Œä¸€ä¸ª sidecar ä¼šå¯¼è‡´å¤§é‡çš„ä»£ç†ã€‚å³ä½¿æ¯ä¸ªå•ç‹¬çš„ä»£ç†å®ä¾‹åœ¨å…¶å†…å­˜å ç”¨æ–¹é¢æ˜¯ç›¸å½“ä¼˜åŒ–çš„ï¼Œä½†å®ä¾‹çš„æ•°é‡ä¹‹å¤šå°†å¯¼è‡´æ€»çš„å½±å“å¾ˆå¤§ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªä»£ç†ç»´æŠ¤çš„æ•°æ®ç»“æ„ï¼Œå¦‚è·¯ç”±å’Œç«¯ç‚¹è¡¨ï¼Œéšç€é›†ç¾¤çš„å¢é•¿è€Œå¢é•¿ï¼Œæ‰€ä»¥é›†ç¾¤è¶Šå¤§ï¼Œæ¯ä¸ªä»£ç†çš„å†…å­˜æ¶ˆè€—å°±è¶Šé«˜ã€‚ä»Šå¤©ï¼Œä¸€äº›æœåŠ¡ç½‘æ ¼è¯•å›¾é€šè¿‡å°†éƒ¨åˆ†è·¯ç”±è¡¨æ¨é€ç»™å•ä¸ªä»£ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé™åˆ¶å®ƒä»¬å¯ä»¥è·¯ç”±åˆ°å“ªé‡Œã€‚\n\n![ä»£ç†æ•°é‡](008i3skNly1gx7y8synvej31z40oiq6n.jpg) \n\n \n\nè®©æˆ‘ä»¬å‡è®¾åœ¨ä¸€ä¸ª 500 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æœ‰ 30 ä¸ª podï¼Œä¸€ä¸ªåŸºäº sidecar çš„æ¶æ„å°†éœ€è¦è¿è¡Œ 15K ä¸ªä»£ç†ã€‚åœ¨æ¯ä¸ªä»£ç†æ¶ˆè€— 70MB å†…å­˜çš„æƒ…å†µä¸‹ï¼ˆå‡è®¾å·²ç»ç»è¿‡æè‡´ä¼˜åŒ–è¿‡çš„è·¯ç”±è¡¨ï¼‰ï¼Œè¿™ä»ç„¶å¯¼è‡´é›†ç¾¤ä¸­æ‰€æœ‰ sidecar æ¶ˆè€— 1.5TB çš„å†…å­˜ã€‚åœ¨ per-node æ¨¡å‹ä¸­ï¼Œå‡è®¾æ¯ä¸ªä»£ç†çš„å†…å­˜è¶³è¿¹ç›¸åŒï¼Œ500 ä¸ªä»£ç†å°†æ¶ˆè€—ä¸è¶…è¿‡ 34GB çš„å†…å­˜ã€‚\n\n### å¤šç§Ÿæˆ·\n\nå½“æˆ‘ä»¬ä» sidecar æ¨¡å‹è½¬å‘ per-node æ¨¡å‹æ—¶ï¼Œä»£ç†å°†ä¸ºå¤šä¸ªåº”ç”¨ç¨‹åºæä¾›è¿æ¥ã€‚ä»£ç†å¿…é¡»å…·æœ‰å¤šç§Ÿæˆ·æ„ŸçŸ¥ã€‚è¿™ä¸æˆ‘ä»¬ä»ä½¿ç”¨å•ä¸ªè™šæ‹Ÿæœºè½¬å‘ä½¿ç”¨å®¹å™¨æ—¶å‘ç”Ÿçš„è¿‡æ¸¡å®Œå…¨ç›¸åŒã€‚ç”±äºæˆ‘ä»¬ä¸å†ä½¿ç”¨åœ¨æ¯ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œçš„å®Œå…¨ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿå‰¯æœ¬ï¼Œè€Œå¼€å§‹ä¸å¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«æ“ä½œç³»ç»Ÿï¼ŒLinux å¿…é¡»å…·æœ‰å¤šç§Ÿæˆ·æ„ŸçŸ¥ã€‚è¿™å°±æ˜¯å‘½åç©ºé—´å’Œ cgroup å­˜åœ¨çš„åŸå› ã€‚å¦‚æœæ²¡æœ‰å®ƒä»¬ï¼Œä¸€ä¸ªå®¹å™¨å¯èƒ½ä¼šæ¶ˆè€—ä¸€ä¸ªç³»ç»Ÿçš„æ‰€æœ‰èµ„æºï¼Œå®¹å™¨å¯èƒ½ä¼šä»¥ä¸å—æ§åˆ¶çš„æ–¹å¼è®¿é—®å¯¹æ–¹çš„æ–‡ä»¶ç³»ç»Ÿã€‚\n\n![Envoy Namespace](008i3skNly1gx7z3klyfhj31hx0u0djs.jpg)\n\nå¦‚æœè¿™åœ¨æœåŠ¡ç½‘æ ¼çº§åˆ«çš„ç½‘ç»œèµ„æºä¸Šè¡¨ç°å¾—å®Œå…¨ä¸€æ ·ï¼Œé‚£ä¸æ˜¯å¾ˆå¥½å—ï¼ŸEnvoy å·²ç»æœ‰äº†å‘½åç©ºé—´çš„åˆæ­¥æ¦‚å¿µï¼Œå®ƒä»¬è¢«ç§°ä¸ºç›‘å¬å™¨ã€‚ç›‘å¬å™¨å¯ä»¥æºå¸¦å•ç‹¬çš„é…ç½®å¹¶ç‹¬ç«‹è¿è¡Œã€‚è¿™å°†å¼€å¯å…¨æ–°çš„å¯èƒ½æ€§ï¼šçªç„¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°æ§åˆ¶èµ„æºæ¶ˆè€—ï¼Œå»ºç«‹å…¬å¹³çš„æ’é˜Ÿè§„åˆ™ï¼Œå¹¶å°†å¯ç”¨çš„èµ„æºå¹³ç­‰åœ°åˆ†é…ç»™æ‰€æœ‰çš„åº”ç”¨ç¨‹åºï¼Œæˆ–è€…æŒ‰ç…§æŒ‡å®šçš„è§„åˆ™åˆ†é…ã€‚è¿™å¯ä»¥è€Œä¸”åº”è¯¥ä¸æˆ‘ä»¬ä»Šå¤©åœ¨ Kubernetes ä¸­å®šä¹‰åº”ç”¨ç¨‹åºçš„ CPU å’Œå†…å­˜çº¦æŸçš„æ–¹å¼å®Œå…¨ä¸€æ ·ã€‚å¦‚æœä½ æƒ³äº†è§£è¿™ä¸ªè¯é¢˜ï¼Œæˆ‘æ›¾åœ¨ EnvoyCon ä¸Šè®²è¿‡è¿™ä¸ªé—®é¢˜ï¼ˆ[Envoy Namespace - ä»¥æ›´å°çš„ä»£ä»·è¿ç»´åŸºäº Envoy çš„æœåŠ¡ç½‘æ ¼ï¼ŒThomas Grafï¼ŒEnvoyCon 2019](https:\/\/www.youtube.com\/watch?v=08opgZkdYIw)ï¼‰ã€‚\n\n## æƒ³å‚ä¸å…¶ä¸­å—ï¼Ÿ- åŠ å…¥ Cilium æœåŠ¡ç½‘æ ¼æµ‹è¯•ç‰ˆ\n\n![æµ‹è¯•ç‰ˆ](008i3skNly1gx7wz1obexj327t0u0dkm.jpg) \n\nä¼´éšç€å³å°†å‘å¸ƒçš„ Cilium 1.11 ç‰ˆæœ¬ï¼ŒCilium ç¤¾åŒºæ­£åœ¨ä¸¾åŠä¸€ä¸ªæ–°çš„ Cilium Service Mesh æµ‹è¯•è®¡åˆ’ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯ä¸€ä¸ªæ–°çš„æ„å»ºï¼Œå°†ä½¿ä»¥ä¸‹åŠŸèƒ½å¯ç”¨ã€‚\n\n- L7 æµé‡ç®¡ç†å’Œè´Ÿè½½å‡è¡¡ï¼ˆHTTPï¼ŒgRPCï¼Œâ€¦ï¼‰\n- è·¨é›†ç¾¤ã€äº‘å’Œé›†ç¾¤çš„æ‹“æ‰‘æ„ŸçŸ¥è·¯ç”±\n- TLS ç»ˆæ­¢\n- é€šè¿‡ Envoy é…ç½®çš„é‡‘ä¸é›€å‘å¸ƒã€é‡è¯•ã€é€Ÿç‡é™åˆ¶ã€æ–­è·¯ç­‰\n- ç”¨ OpenTelemetry å’Œ Jaeger é›†æˆè¿›è¡Œè¿½è¸ª\n- å†…ç½® Kubernetes Ingress æ”¯æŒ\n\nä¸Šè¿°æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥åœ¨ [github.com\/cilium\/cilium](https:\/\/github.com\/cilium\/cilium) åŠŸèƒ½åˆ†æ”¯ä¸­æ‰¾åˆ°ã€‚æµ‹è¯•è®¡åˆ’å…è®¸ Cilium ç»´æŠ¤è€…ç›´æ¥ä¸ç”¨æˆ·æ¥è§¦ï¼Œäº†è§£ä»–ä»¬çš„éœ€æ±‚ã€‚è¦æ³¨å†Œï¼Œä½ å¯ä»¥ç›´æ¥å¡«å†™ [è¿™ä¸ªè¡¨æ ¼](https:\/\/forms.gle\/j9fwhAC6HnHRJQKeA)ï¼Œæˆ–è€…ä½ å¯ä»¥åœ¨ Cilium ç¤¾åŒºçš„[å…¬å‘Š](https:\/\/cilium.io\/blog\/2021\/12\/01\/cilium-service-mesh-beta)ä¸­é˜…è¯»æ›´å¤šå…³äºè¯¥è®¡åˆ’çš„ä¿¡æ¯ã€‚\n\n## æ€»ç»“\n\neBPF æ˜¯æä¾›æœ¬åœ°å’Œé«˜æ•ˆçš„æœåŠ¡ç½‘æ ¼å®ç°çš„ç­”æ¡ˆã€‚å®ƒå°†æŠŠæˆ‘ä»¬ä» sidecar æ¨¡å‹ä¸­è§£æ”¾å‡ºæ¥ï¼Œå¹¶å…è®¸å°†ç°æœ‰çš„ä»£ç†æŠ€æœ¯æ•´åˆåˆ°ç°æœ‰çš„å†…æ ¸å‘½åæ¦‚å¿µä¸­ï¼Œä½¿å®ƒä»¬æˆä¸ºæˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨çš„å®¹å™¨æŠ½è±¡çš„ä¸€éƒ¨åˆ†ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒeBPF å°†èƒ½å¤Ÿå¸è½½è¶Šæ¥è¶Šå¤šçš„ç›®å‰ç”±ä»£ç†æ‰§è¡Œçš„åŠŸèƒ½ï¼Œä»¥è¿›ä¸€æ­¥å‡å°‘å¼€é”€å’Œå¤æ‚æ€§ã€‚é€šè¿‡æ•´åˆå‡ ä¹ä»»ä½•ç°æœ‰çš„ä»£ç†ï¼Œè¯¥æ¶æ„ä¹Ÿå…è®¸ä¸å¤§å¤šæ•°ç°æœ‰çš„æœåŠ¡ç½‘æ ¼æ§åˆ¶å¹³é¢ï¼ˆIstioã€SMIã€Linkerdâ€¦ï¼‰æ•´åˆã€‚è¿™å¯ä»¥å°† eBPF çš„å¥½å¤„æä¾›ç»™å¹¿å¤§çš„ç»ˆç«¯ç”¨æˆ·ï¼ŒåŒæ—¶å°†æ•°æ®é€šè·¯çš„æ•ˆç‡å’Œå¼€é”€çš„è®¨è®ºä¸æ§åˆ¶å¹³é¢æ–¹é¢ç›¸åˆ†ç¦»ã€‚\n\nå¦‚æœä½ æœ‰å…´è¶£æ¢ç´¢è¿™ä¸ªè¯é¢˜ï¼Œæˆ‘ä»¬å¾ˆæƒ³å¬åˆ°ä½ çš„æ„è§ã€‚è¯·éšæ—¶é€šè¿‡ [Twitter](https:\/\/twitter.com\/tgraf__) æˆ– [eBPF \u0026 Cilium Slack è”ç³»æˆ‘ä»¬](http:\/\/ebpf.io\/slack)ã€‚\n\n## è¿›ä¸€æ­¥é˜…è¯»\n\n- [eBPF å¦‚ä½•ç®€åŒ–æœåŠ¡ç½‘æ ¼](\/trans\/how-ebpf-streamlines-the-service-mesh\/)ï¼ŒLiz Riceï¼ŒThe New Stack\n- [Cilium æœåŠ¡ç½‘æ ¼æµ‹è¯•è®¡åˆ’](https:\/\/cilium.io\/blog\/2021\/12\/01\/cilium-service-mesh-beta)ï¼ŒCilium ç¤¾åŒº\n- [äº†è§£æ›´å¤šå…³äº Cilium çš„ä¿¡æ¯](https:\/\/cilium.io\/learn)\n', '\/trans\/ebpf-solve-service-mesh-sidecar\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡å›é¡¾äº† Linux å†…æ ¸çš„è¿æ¥æ€§ï¼Œå®ç°æœåŠ¡ç½‘æ ¼çš„å‡ ç§æ¨¡å¼ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ eBPF å®ç°æ—  Sidecar çš„æœåŠ¡ç½‘æ ¼ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/how-ebpf-streamlines-the-service-mesh/">[è¯‘] eBPF å¦‚ä½•ç®€åŒ–æœåŠ¡ç½‘æ ¼</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2021/10/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thenewstack.io/how-ebpf-streamlines-the-service-mesh/" target="_blank" rel="noopener">åŸæ–‡</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('eBPF å¦‚ä½•ç®€åŒ–æœåŠ¡ç½‘æ ¼', 'æœ¬æ–‡æ¢è®¨ä¸€ä¸‹ eBPF æ˜¯å¦‚ä½•è®©æˆ‘ä»¬ç²¾ç®€æœåŠ¡ç½‘æ ¼ï¼Œä½¿æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢æ›´æœ‰æ•ˆç‡ï¼Œæ›´å®¹æ˜“éƒ¨ç½²ã€‚', '\nä»Šå¤©æœ‰å‡ ä¸ªæœåŠ¡ç½‘æ ¼çš„äº§å“å’Œé¡¹ç›®ï¼Œæ‰¿è¯ºç®€åŒ–åº”ç”¨å¾®æœåŠ¡ä¹‹é—´çš„è¿æ¥ï¼ŒåŒæ—¶æä¾›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚å®‰å…¨è¿æ¥ã€å¯è§‚æµ‹æ€§å’Œæµé‡ç®¡ç†ã€‚ä½†æ­£å¦‚æˆ‘ä»¬åœ¨è¿‡å»å‡ å¹´ä¸­åå¤çœ‹åˆ°çš„é‚£æ ·ï¼Œå¯¹æœåŠ¡ç½‘æ ¼çš„å…´å¥‹å·²ç»è¢«å¯¹é¢å¤–çš„[å¤æ‚æ€§](https:\/\/engineering.hellofresh.com\/everything-we-learned-running-istio-in-production-part-2-ff4c26844bfb)å’Œ[å¼€é”€çš„](https:\/\/pklinker.medium.com\/performance-impacts-of-an-istio-service-mesh-63957a0000b)å®é™…[æ‹…å¿§æ‰€æŠ‘åˆ¶](https:\/\/medium.com\/geekculture\/watch-out-for-this-istio-proxy-sidecar-memory-pitfall-8dbd99ea7e9d)ã€‚è®©æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹ [eBPF](https:\/\/ebpf.io\/) æ˜¯å¦‚ä½•è®©æˆ‘ä»¬ç²¾ç®€[æœåŠ¡ç½‘æ ¼](https:\/\/thenewstack.io\/category\/service-mesh\/)ï¼Œä½¿æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢æ›´æœ‰æ•ˆç‡ï¼Œæ›´å®¹æ˜“éƒ¨ç½²ã€‚\n\n## Sidecar é—®é¢˜\n\nä»Šå¤©çš„ Kubernetes æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆè¦æ±‚ä½ åœ¨æ¯ä¸€ä¸ªåº”ç”¨ pod ä¸Šæ·»åŠ ä¸€ä¸ªä»£ç† sidecar å®¹å™¨ï¼Œå¦‚ [Envoy](https:\/\/www.envoyproxy.io\/) æˆ– [Linkerd-proxy](https:\/\/linkerd.io\/)ã€‚è¿™æ˜¯æ­£ç¡®çš„ï¼šå³ä½¿åœ¨ä¸€ä¸ªéå¸¸å°çš„ç¯å¢ƒä¸­ï¼Œæ¯”å¦‚è¯´æœ‰ 20 ä¸ªæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è¿è¡Œäº”ä¸ª podï¼Œåˆ†å¸ƒåœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½ ä¹Ÿæœ‰ 100 ä¸ªä»£ç†å®¹å™¨ã€‚æ— è®ºä»£ç†çš„å®ç°å¤šä¹ˆå°å’Œæœ‰æ•ˆï¼Œè¿™ç§çº¯ç²¹çš„é‡å¤éƒ½ä¼šè€—è´¹èµ„æºã€‚\n\næ¯ä¸ªä»£ç†ä½¿ç”¨çš„å†…å­˜ä¸å®ƒéœ€è¦èƒ½å¤Ÿé€šä¿¡çš„æœåŠ¡æ•°é‡æœ‰å…³ã€‚Pranay Singhal å†™äº†ä»–é…ç½® Istio çš„[ç»éªŒ](https:\/\/medium.com\/geekculture\/watch-out-for-this-istio-proxy-sidecar-memory-pitfall-8dbd99ea7e9d)ï¼Œå°†æ¯ä¸ªä»£ç†çš„æ¶ˆè€—ä» 1GB å·¦å³å‡å°‘åˆ°æ›´åˆç†çš„ 60-70MBã€‚ä½†æ˜¯ï¼Œå³ä½¿åœ¨æˆ‘ä»¬çš„å°ç¯å¢ƒä¸­ï¼Œåœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ 100 ä¸ªä»£ç†ï¼Œè¿™ç§ä¼˜åŒ–é…ç½®ä»ç„¶éœ€è¦æ¯ä¸ªèŠ‚ç‚¹ 2GB å·¦å³ã€‚\n\n![æ¥è‡ª [redhat.com\/architect\/why-when-service-mesh](https:\/\/redhat.com\/architect\/why-when-service-mesh)â€”â€”æ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±çš„ä»£ç† sidecar](008i3skNly1gvtp69o74jj31w50u0jy8.jpg) \n\nä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ‰€æœ‰è¿™äº› sidecarï¼Ÿè¿™ç§æ¨¡å¼å…è®¸ä»£ç†å®¹å™¨ä¸ pod ä¸­çš„åº”ç”¨å®¹å™¨å…±äº«ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ã€‚ç½‘ç»œå‘½åç©ºé—´æ˜¯ Linux å†…æ ¸çš„ç»“æ„ï¼Œå®ƒå…è®¸å®¹å™¨å’Œ pod æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œå †æ ˆï¼Œå°†å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºç›¸äº’éš”ç¦»ã€‚è¿™ä½¿å¾—åº”ç”¨ä¹‹é—´äº’ä¸ç›¸å¹²ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ å¯ä»¥è®©å°½å¯èƒ½å¤šçš„ pod åœ¨ 80 ç«¯å£ä¸Šè¿è¡Œä¸€ä¸ª web åº”ç”¨ â€”â€” ç½‘ç»œå‘½åç©ºé—´æ„å‘³ç€å®ƒä»¬å„è‡ªæ‹¥æœ‰è‡ªå·±çš„ 80 ç«¯å£ã€‚ä»£ç†å¿…é¡»å…±äº«ç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥æ‹¦æˆªå’Œå¤„ç†è¿›å‡ºåº”ç”¨å®¹å™¨çš„æµé‡ã€‚\n\n## å¼•å…¥ eBPF\n\n[eBPF](http:\/\/ebpf.io\/) æ˜¯ä¸€ç§å†…æ ¸æŠ€æœ¯ï¼Œå…è®¸è‡ªå®šä¹‰ç¨‹åºåœ¨å†…æ ¸ä¸­è¿è¡Œã€‚è¿™äº›ç¨‹åºåœ¨å“åº”äº‹ä»¶æ—¶è¿è¡Œï¼Œæœ‰æˆåƒä¸Šä¸‡ä¸ªå¯èƒ½çš„äº‹ä»¶ï¼ŒeBPF ç¨‹åºå¯ä»¥è¢«é™„åŠ åˆ°è¿™äº›äº‹ä»¶ä¸Šã€‚è¿™äº›äº‹ä»¶åŒ…æ‹¬è½¨è¿¹ç‚¹ã€è¿›å…¥æˆ–é€€å‡ºä»»ä½•åŠŸèƒ½ï¼ˆåœ¨å†…æ ¸æˆ–ç”¨æˆ·ç©ºé—´ï¼‰æˆ–å¯¹æœåŠ¡ç½‘æ ¼æ¥è¯´å¾ˆé‡è¦çš„ â€”â€” æŠµè¾¾çš„ç½‘ç»œæ•°æ®åŒ…ã€‚\n\né‡è¦çš„æ˜¯ï¼Œ**æ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå†…æ ¸**ï¼›åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ‰€æœ‰å®¹å™¨ï¼ˆä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ podï¼‰å…±äº«åŒä¸€ä¸ªå†…æ ¸ã€‚å¦‚æœä½ åœ¨å†…æ ¸ä¸­æ·»åŠ ä¸€ä¸ª eBPF ç¨‹åºåˆ°ä¸€ä¸ªäº‹ä»¶ä¸­ï¼Œå®ƒå°†è¢«è§¦å‘ï¼Œæ— è®ºå“ªä¸ªè¿›ç¨‹å¼•èµ·è¯¥äº‹ä»¶ï¼Œæ— è®ºå®ƒæ˜¯åœ¨åº”ç”¨å®¹å™¨ä¸­è¿è¡Œè¿˜æ˜¯ç›´æ¥è¿è¡Œåœ¨ä¸»æœºä¸Šã€‚\n\n![æ¯å°ä¸»æœºä¸€ä¸ªå†…æ ¸](008i3skNly1gvtp6c8mn9j31ea0u0n0t.jpg) \n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ eBPF å¯¹äº Kubernetes ä¸­çš„ä»»ä½•ä¸€ç§ instrumentation æ¥è¯´éƒ½æ˜¯å¦‚æ­¤ä»¤äººå…´å¥‹çš„æŠ€æœ¯ â€”â€” ä½ åªéœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ ä¸€æ¬¡ instrumentationï¼Œæ‰€æœ‰çš„åº”ç”¨ç¨‹åº pod éƒ½ä¼šè¢«è¦†ç›–ã€‚æ— è®ºä½ æ˜¯åœ¨å¯»æ±‚å¯è§‚æµ‹æ€§ã€å®‰å…¨æ€§è¿˜æ˜¯ç½‘ç»œï¼Œç”± eBPF é©±åŠ¨çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥åœ¨ä¸éœ€è¦ sidecar çš„æƒ…å†µä¸‹å¯¹åº”ç”¨è¿›è¡Œæ£€æµ‹ã€‚\n\nåŸºäº eBPF çš„ [Cilium](http:\/\/cilium.io\/) é¡¹ç›®ï¼ˆæœ€è¿‘ [ä»¥å­µåŒ–çº§åˆ«åŠ å…¥äº‘è®¡ç®—åŸºé‡‘ä¼š](https:\/\/www.cncf.io\/blog\/2021\/10\/13\/cilium-joins-cncf-as-an-incubating-project\/)ï¼‰å°†è¿™ç§â€œæ—  sidecar\u0022 æ¨¡å¼å¸¦åˆ°äº†æœåŠ¡ç½‘æ ¼çš„ä¸–ç•Œã€‚é™¤äº†ä¼ ç»Ÿçš„ sidecar æ¨¡å‹ï¼ŒCilium è¿˜æ”¯æŒæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ä¸€ä¸ª Envoy ä»£ç†å®ä¾‹è¿è¡ŒæœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢ã€‚ä½¿ç”¨æˆ‘ä»¬å‰é¢çš„ä¾‹å­ï¼Œè¿™å°±æŠŠä»£ç†å®ä¾‹çš„æ•°é‡ä» 100 ä¸ªå‡å°‘åˆ°åªæœ‰ 3 ä¸ªã€‚\n\n![ç”¨æ—  sidecar ä»£ç†æ¨¡å¼å‡å°‘ä»£ç†å®ä¾‹](008i3skNly1gvtp67ocjkj31xt0u0jvp.jpg) \n\n## å‡å°‘ YAML\n\nåœ¨ sidecar æ¨¡å‹ä¸­ï¼ŒæŒ‡å®šæ¯ä¸ªåº”ç”¨ pod çš„ YAML éœ€è¦è¢«ä¿®æ”¹ä»¥æ·»åŠ  sidecar å®¹å™¨ã€‚è¿™é€šå¸¸æ˜¯è‡ªåŠ¨åŒ–çš„ â€”â€” ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸€ä¸ª mutating webhookï¼Œåœ¨æ¯ä¸ªåº”ç”¨ pod éƒ¨ç½²çš„æ—¶å€™æ³¨å…¥ sidecarã€‚\n\nä»¥ Istio ä¸ºä¾‹ï¼Œè¿™éœ€è¦[æ ‡è®°](https:\/\/istio.io\/latest\/docs\/setup\/additional-setup\/sidecar-injection\/#controlling-the-injection-policy) Kubernetes å‘½åç©ºé—´å’Œ \/ æˆ– podï¼Œä»¥å®šä¹‰æ˜¯å¦åº”è¯¥æ³¨å…¥ sidecarâ€”â€” å½“ç„¶ä¹Ÿéœ€è¦ä¸ºé›†ç¾¤å¯ç”¨ mutating webhookã€‚\n\nä½†å¦‚æœå‡ºäº†é—®é¢˜æ€ä¹ˆåŠï¼Ÿå¦‚æœå‘½åç©ºé—´æˆ– pod çš„æ ‡ç­¾ä¸æ­£ç¡®ï¼Œé‚£ä¹ˆ sidecar å°†ä¸ä¼šè¢«æ³¨å…¥ï¼Œpod å°†ä¸ä¼šè¢«è¿æ¥åˆ°æœåŠ¡ç½‘æ ¼ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¦‚æœæ”»å‡»è€…ç ´åäº†é›†ç¾¤ï¼Œå¹¶èƒ½å¤Ÿè¿è¡Œä¸€ä¸ªæ¶æ„çš„å·¥ä½œè´Ÿè½½ â€”â€” ä¾‹å¦‚ï¼Œä¸€ä¸ªåŠ å¯†è´§å¸çŸ¿å·¥ï¼Œä»–ä»¬å°†ä¸å¤ªå¯èƒ½æ ‡è®°å®ƒï¼Œä»¥ä¾¿å®ƒåŠ å…¥æœåŠ¡ç½‘æ ¼ã€‚å®ƒä¸ä¼šé€šè¿‡æœåŠ¡ç½‘æ ¼æä¾›çš„æµé‡è§‚å¯Ÿèƒ½åŠ›è€Œè¢«å‘ç°ã€‚\n\nç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨æ”¯æŒ eBPF çš„æ—  sidecar ä»£ç†æ¨¡å‹ä¸­ï¼Œpod ä¸éœ€è¦ä»»ä½•é¢å¤–çš„ YAML å°±å¯ä»¥è¢«æ£€æµ‹ã€‚ç›¸åï¼Œä¸€ä¸ª CRD è¢«ç”¨æ¥åœ¨é›†ç¾¤èŒƒå›´å†…é…ç½®æœåŠ¡ç½‘æ ¼ã€‚å³ä½¿æ˜¯å·²ç»å­˜åœ¨çš„ pod ä¹Ÿå¯ä»¥æˆä¸ºæœåŠ¡ç½‘æ ¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯åŠ¨ã€‚\n\nå¦‚æœæ”»å‡»è€…è¯•å›¾é€šè¿‡ç›´æ¥åœ¨ä¸»æœºä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½æ¥ç»•è¿‡ Kubernetes ç¼–æ’ï¼ŒeBPF ç¨‹åºå¯ä»¥æ£€æµ‹å¹¶æ§åˆ¶è¿™ä¸€æ´»åŠ¨ï¼Œå› ä¸ºè¿™ä¸€åˆ‡éƒ½å¯ä»¥ä»å†…æ ¸çœ‹åˆ°ã€‚\n\n## eBPF æ”¯æŒçš„ç½‘ç»œæ•ˆç‡\n\næ”¯æŒ eBPF çš„ç½‘ç»œå…è®¸æ•°æ®åŒ…èµ°æ·å¾„ï¼Œç»•è¿‡å†…æ ¸çš„éƒ¨åˆ†ç½‘ç»œå †æ ˆï¼Œè¿™å¯ä»¥ä½¿ Kubernetes ç½‘ç»œçš„[æ€§èƒ½å¾—åˆ°æ˜¾è‘—æ”¹å–„](https:\/\/cilium.io\/blog\/2021\/05\/11\/cni-benchmark)ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™åœ¨æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢ä¸­æ˜¯å¦‚ä½•åº”ç”¨çš„ã€‚\n\n![åœ¨ eBPF åŠ é€Ÿã€æ—  sidecar çš„æœåŠ¡ç½‘æ ¼æ¨¡å‹ä¸­ï¼Œç½‘ç»œæ•°æ®åŒ…é€šè¿‡çš„è·¯å¾„è¦çŸ­å¾—å¤š](008i3skNly1gvtp6ao3lqj31q90u0gqw.jpg) \n\nåœ¨æœåŠ¡ç½‘æ ¼çš„æƒ…å†µä¸‹ï¼Œä»£ç†åœ¨ä¼ ç»Ÿç½‘ç»œä¸­ä½œä¸º sidecar è¿è¡Œï¼Œæ•°æ®åŒ…åˆ°è¾¾åº”ç”¨ç¨‹åºçš„è·¯å¾„ç›¸å½“æ›²æŠ˜ï¼šå…¥ç«™æ•°æ®åŒ…å¿…é¡»ç©¿è¶Šä¸»æœº TCP\/IP æ ˆï¼Œé€šè¿‡è™šæ‹Ÿä»¥å¤ªç½‘è¿æ¥åˆ°è¾¾ pod çš„ç½‘ç»œå‘½åç©ºé—´ã€‚ä»é‚£é‡Œï¼Œæ•°æ®åŒ…å¿…é¡»ç©¿è¿‡ pod çš„ç½‘ç»œå †æ ˆåˆ°è¾¾ä»£ç†ï¼Œä»£ç†å°†æ•°æ®åŒ…é€šè¿‡å›ç¯æ¥å£è½¬å‘åˆ°åº”ç”¨ç¨‹åºã€‚è€ƒè™‘åˆ°æµé‡å¿…é¡»åœ¨è¿æ¥çš„ä¸¤ç«¯æµç»ä»£ç†ï¼Œä¸éæœåŠ¡ç½‘æ ¼æµé‡ç›¸æ¯”ï¼Œè¿™å°†å¯¼è‡´å»¶è¿Ÿçš„[æ˜¾è‘—å¢åŠ ](https:\/\/linkerd.io\/2021\/05\/27\/linkerd-vs-istio-benchmarks\/#latency-at-20-rps)ã€‚\n\nåŸºäº eBPF çš„ Kubernetes CNI å®ç°ï¼Œå¦‚ Ciliumï¼Œå¯ä»¥ä½¿ç”¨ eBPF ç¨‹åºï¼Œæ˜æ™ºåœ°é’©ä½å†…æ ¸ä¸­çš„ç‰¹å®šç‚¹ï¼Œæ²¿ç€æ›´ç›´æ¥çš„è·¯çº¿é‡å®šå‘æ•°æ®åŒ…ã€‚è¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º Cilium çŸ¥é“æ‰€æœ‰çš„ Kubernetes ç«¯ç‚¹å’ŒæœåŠ¡çš„èº«ä»½ã€‚å½“æ•°æ®åŒ…åˆ°è¾¾ä¸»æœºæ—¶ï¼ŒCilium å¯ä»¥å°†å…¶ç›´æ¥åˆ†é…åˆ°å®ƒæ‰€è¦å»çš„ä»£ç†æˆ– Pod ç«¯ç‚¹ã€‚\n\n## ç½‘ç»œä¸­çš„åŠ å¯†\n\nå¦‚æœä¸€ä¸ªç½‘ç»œè§£å†³æ–¹æ¡ˆèƒ½å¤Ÿæ„è¯†åˆ° Kubernetes æœåŠ¡ï¼Œå¹¶åœ¨è¿™äº›æœåŠ¡çš„ç«¯ç‚¹ä¹‹é—´æä¾›ç½‘ç»œè¿æ¥ï¼Œé‚£ä¹ˆå®ƒèƒ½å¤Ÿæä¾›æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„èƒ½åŠ›å°±ä¸è¶³ä¸ºå¥‡ã€‚ä½†è¿™äº›èƒ½åŠ›å¯ä»¥è¶…è¶ŠåŸºæœ¬çš„è¿æ¥ã€‚ä¸€ä¸ªä¾‹å­æ˜¯é€æ˜åŠ å¯†ã€‚\n\né€šå¸¸ä½¿ç”¨æœåŠ¡ç½‘æ ¼æ¥ç¡®ä¿æ‰€æœ‰çš„åº”ç”¨æµé‡éƒ½æ˜¯ç»è¿‡è®¤è¯å’ŒåŠ å¯†çš„ã€‚è¿™æ˜¯é€šè¿‡åŒå‘ TLSï¼ˆmTLSï¼‰å®ç°çš„ï¼›æœåŠ¡ç½‘æ ¼ä»£ç†ç»„ä»¶ä½œä¸ºç½‘ç»œè¿æ¥çš„ç«¯ç‚¹ï¼Œå¹¶ä¸å…¶è¿œç¨‹å¯¹ç­‰ç‰©åå•†ä¸€ä¸ªå®‰å…¨çš„ TLS è¿æ¥ã€‚è¿™ç§è¿æ¥å¯¹ä»£ç†ä¹‹é—´çš„é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œè€Œä¸éœ€è¦å¯¹åº”ç”¨ç¨‹åºåšä»»ä½•æ”¹å˜ã€‚\n\nä½†åœ¨åº”ç”¨å±‚ç®¡ç†çš„ TLS å¹¶ä¸æ˜¯å®ç°ç»„ä»¶é—´è®¤è¯å’ŒåŠ å¯†æµé‡çš„å”¯ä¸€æ–¹æ³•ã€‚å¦ä¸€ä¸ªé€‰æ‹©æ˜¯åœ¨ç½‘ç»œå±‚åŠ å¯†æµé‡ï¼Œä½¿ç”¨ [IPSec æˆ– WireGuard](https:\/\/cilium.io\/blog\/2021\/05\/11\/cni-benchmark#the-cost-of-encryption---wireguard-vs-ipsec)ã€‚å› ä¸ºå®ƒåœ¨ç½‘ç»œå±‚æ“ä½œï¼Œè¿™ç§åŠ å¯†ä¸ä»…å¯¹åº”ç”¨ç¨‹åºå®Œå…¨é€æ˜ï¼Œè€Œä¸”å¯¹ä»£ç†ä¹Ÿæ˜¯é€æ˜çš„ â€”â€” å®ƒå¯ä»¥åœ¨æœ‰æˆ–æ²¡æœ‰æœåŠ¡ç½‘æ ¼æ—¶å¯ç”¨ã€‚å¦‚æœä½ ä½¿ç”¨æœåŠ¡ç½‘æ ¼çš„å”¯ä¸€åŸå› æ˜¯æä¾›åŠ å¯†ï¼Œä½ å¯èƒ½æƒ³è€ƒè™‘ç½‘ç»œçº§åŠ å¯†ã€‚å®ƒä¸ä»…æ›´ç®€å•ï¼Œè€Œä¸”è¿˜å¯ä»¥ç”¨æ¥éªŒè¯å’ŒåŠ å¯†èŠ‚ç‚¹ä¸Šçš„ä»»ä½•æµé‡ â€”â€” å®ƒä¸åªé™äºé‚£äº›å¯ç”¨äº† sidecar çš„å·¥ä½œè´Ÿè½½ã€‚\n\n## eBPF æ˜¯æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢\n\nç°åœ¨ï¼ŒeBPF åœ¨ Linux ç”Ÿäº§å‘è¡Œç‰ˆä½¿ç”¨çš„å†…æ ¸ç‰ˆæœ¬ä¸­å¾—åˆ°å¹¿æ³›æ”¯æŒï¼Œä¼ä¸šå¯ä»¥åˆ©ç”¨å®ƒæ¥è·å¾—æ›´æœ‰æ•ˆçš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå¹¶ä½œä¸ºæœåŠ¡ç½‘æ ¼çš„æ›´æœ‰æ•ˆçš„æ•°æ®å¹³é¢ã€‚\n\nå»å¹´ï¼Œæˆ‘ä»£è¡¨ [CNCF](https:\/\/cncf.io\/?utm_content=inline-mention) çš„æŠ€æœ¯ç›‘ç£å§”å‘˜ä¼šï¼Œå¯¹æœåŠ¡ç½‘æ ¼é¢†åŸŸçš„æ•´åˆå’Œæ¸…æ™°åŒ–åšäº†ä¸€äº› [é¢„æµ‹](https:\/\/youtu.be\/bESogtuHwX0)ã€‚åœ¨åŒä¸€ä¸»é¢˜æ¼”è®²ä¸­ï¼Œæˆ‘è°ˆåˆ° eBPF æœ‰å¯èƒ½æˆä¸ºæ›´å¤šé¡¹ç›®å’Œæ›´å¹¿æ³›éƒ¨ç½²èƒ½åŠ›çš„åŸºç¡€ã€‚è¿™ä¸¤ä¸ªæƒ³æ³•ç°åœ¨æ­£ç»“åˆåœ¨ä¸€èµ·ï¼Œå› ä¸º eBPF ä¼¼ä¹æ˜¯æœåŠ¡ç½‘æ ¼æ•°æ®å¹³é¢çš„è‡ªç„¶è·¯å¾„ã€‚\n', '\/trans\/how-ebpf-streamlines-the-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">æœ¬æ–‡æ¢è®¨ä¸€ä¸‹ eBPF æ˜¯å¦‚ä½•è®©æˆ‘ä»¬ç²¾ç®€æœåŠ¡ç½‘æ ¼ï¼Œä½¿æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢æ›´æœ‰æ•ˆç‡ï¼Œæ›´å®¹æ˜“éƒ¨ç½²ã€‚</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> é˜…è¯»åŸæ–‡è¯·è½¬åˆ°ï¼šhttps://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      ä¸“æ 
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(69)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(38)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(24)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>éšç¬”</span>
            <span>(20)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>ä¸šæ€</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>å…¶ä»–</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(16)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>äº‘åŸç”Ÿ</span>
            <span>(13)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>å®‰å…¨</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>å¼€æº</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>å¯è§‚æµ‹æ€§</span>
            <span>(5)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>æ—…è¡Œ</span>
            <span>(4)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      èµ„æ–™
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>å‡ºç‰ˆç‰©</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘ç”µå­ä¹¦</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>ç¿»è¯‘æ–‡æ¡£</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>ç¿»è¯‘å›¾ä¹¦</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>åŸåˆ›å›¾ä¹¦</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>æ•™ç¨‹æ‰‹å†Œ</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">è”ç³»</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">å¾®ä¿¡å…¬ä¼—å·</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">åšå®¢</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-gateway-integration-istio-mesh/">é›†æˆ Envoy Gateway ä½œä¸º Istio æœåŠ¡ç½‘æ ¼ä¸­çš„å…¥å£ç½‘å…³</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-configuration-safety-common-misconfigurations/">Istio é…ç½®å®‰å…¨ï¼šå¦‚ä½•é¿å…é”™è¯¯é…ç½®</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">ä¿éšœ Istio å®‰å…¨ï¼šè§£å†³å…³é”®å®‰å…¨æ¼æ´åŠæœ€ä½³å®è·µ</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é“¾æ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio æœåŠ¡ç½‘æ ¼
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate å…¬å¸
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå­¦é™¢|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿå¼€æºé¡¹ç›®å¤§å…¨
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  äº‘åŸç”Ÿç¤¾åŒºï¼ˆä¸­å›½ï¼‰
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">æ•™ç¨‹</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio åŸºç¡€æ•™ç¨‹
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes åŸºç¡€æ•™ç¨‹
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">é€šçŸ¥</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024ï¼ˆé¦™æ¸¯ï¼‰</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">ç½‘ç«™æ”¹ç‰ˆé€šçŸ¥</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 å¤§è¿äº‘åŸç”ŸæŠ€æœ¯å¼€æ”¾æ—¥</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">Â© 2017-2024 Jimmy Song ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
