<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Envoy · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="宋净超的博客">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.10cc29dc94114b03907db3131a2a0b871735964d59cce9d69637f50ea22698ae.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.10cc29dc94114b03907db3131a2a0b871735964d59cce9d69637f50ea22698ae.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/tags/envoy/" />
  <meta property="og:title" content="Envoy | Jimmy Song" />
  <meta property="twitter:title" content="Envoy | Jimmy Song" />

  
  <meta property="og:description" content="宋净超的博客" />
  <meta property="twitter:description" content="宋净超的博客" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/tags/envoy/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Envoy
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-proxy-config-deep-dive/">Istio 的数据平面 Envoy Proxy 配置详解</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2019/01/07</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 的数据平面 Envoy Proxy 配置详解', '本文介绍了 Envoy proxy 的概念，对应的 xDS 的版本以及配置的详细解析。', '\nEnvoy 是 Istio Service Mesh 中默认的 Sidecar，Istio 在 Envoy 的基础上按照 Envoy 的 xDS 协议扩展了其控制平面，在讲到 Envoy xDS 协议之前还需要我们先熟悉下 Envoy 的基本术语。下面列举了 Envoy 里的基本术语及其数据结构解析，关于 Envoy 的详细介绍请参考 [Envoy 官方文档](https:\/\/cloudnative.to\/envoy\/)，至于 Envoy 在 Service Mesh（不仅限于 Istio）中是如何作为转发代理工作的请参考网易云刘超的这篇[深入解读 Service Mesh 背后的技术细节 ](https:\/\/www.cnblogs.com\/163yun\/p\/8962278.html)以及[理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持](\/blog\/envoy-sidecar-injection-in-istio-service-mesh-deep-dive\/)，本文引用其中的一些观点，详细内容不再赘述。\n\n![Envoy proxy 架构图](xds.svg)\n\n## 基本术语\n\n下面是您应该了解的 Envoy 里的基本术语：\n\n- **Downstream（下游）**：下游主机连接到 Envoy，发送请求并接收响应，即发送请求的主机。\n- **Upstream（上游）**：上游主机接收来自 Envoy 的连接和请求，并返回响应，即接受请求的主机。\n- **Listener（监听器）**：监听器是命名网地址（例如，端口、unix domain socket 等)，下游客户端可以连接这些监听器。Envoy 暴露一个或者多个监听器给下游主机连接。\n- **Cluster（集群）**：集群是指 Envoy 连接的一组逻辑相同的上游主机。Envoy 通过服务发现来发现集群的成员。可以选择通过主动健康检查来确定集群成员的健康状态。Envoy 通过负载均衡策略决定将请求路由到集群的哪个成员。\n\n我将在本文的后半部分解释以上术语与 Kubernetes、Istio 中概念之间的联系。\n\n## 关于 xDS 的版本\n\n有一点需要大家注意，就是 Envoy 的 API 有 v1 和 v2 两个版本，从 Envoy 1.5.0 起 v2 API 就已经生产就绪了，为了能够让用户顺利的向 v2 版本的额 API 过度，Envoy 启动的时候设置了一个 \u0060--v2-config-only\u0060 的标志，Envoy 不同版本对 v1\/v2 API 的支持详情请参考 [Envoy v1 配置废弃时间表](https:\/\/groups.google.com\/forum\/#!topic\/envoy-announce\/Lb1QZcSclGQ)。\n\nEnvoy 的作者 Matt Klein 在 [Service Mesh 中的通用数据平面 API 设计](https:\/\/cloudnative.to\/blog\/the-universal-data-plane-api\/)这篇文章中说明了 Envoy API v1 的历史及其缺点，还有 v2 的引入。v2 API 是 v1 的演进，而不是革命，它是 v1 功能的超集。\n\n在 Istio 1.0 及以上版本中使用的是 **Envoy 1.8.0-dev** 版本，其支持 v2 的 API，同时在 Envoy 作为 Sidecar proxy 启动的使用使用了例如下面的命令：\n\n\u0060\u0060\u0060bash\n$ \/usr\/local\/bin\/envoy -c \/etc\/istio\/proxy\/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster ratings --service-node sidecar~172.33.14.2~ratings-v1-8558d4458d-ld8x9.default~default.svc.cluster.local --max-obj-name-len 189 --allow-unknown-fields -l warn --v2-config-only\n\u0060\u0060\u0060\n\n上面是都 Bookinfo 示例中的 rating pod 中的 sidecar 启动的分析，可以看到其中指定了 \u0060--v2-config-only\u0060，表明 Istio 1.0\u002b 只支持 xDS v2 的 API。\n\n## Istio sidecar proxy 配置\n\n假如您使用 [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) 部署了 Kubernetes 集群并开启了 [Istio Service Mesh](https:\/\/istio.io\/zh)，再部署 [bookinfo 示例](https:\/\/istio.io\/latest\/zh\/docs\/examples\/bookinfo\/)，那么在 \u0060default\u0060 命名空间下有一个名字类似于 \u0060ratings-v1-7c9949d479-dwkr4\u0060 的 Pod，使用下面的命令查看该 Pod 的 Envoy sidecar 的全量配置：\n\n\u0060\u0060\u0060bash\nkubectl -n default exec ratings-v1-7c9949d479-dwkr4 -c istio-proxy curl http:\/\/localhost:15000\/config_dump \u003e dump-rating.json\n\u0060\u0060\u0060\n\n将 Envoy 的运行时配置 dump 出来之后你将看到一个长 6000 余行的配置文件。\n\nIstio 会在为 Service Mesh 中的每个 Pod 注入 Sidecar 的时候同时为 Envoy 注入 Bootstrap 配置，其余的配置是通过 Pilot 下发的，注意整个数据平面即 Service Mesh 中的 Envoy 的动态配置应该是相同的。您也可以使用上面的命令检查其他 sidecar 的 Envoy 配置是否跟最上面的那个相同。\n\n使用下面的命令检查 Service Mesh 中的所有有 Sidecar 注入的 Pod 中的 proxy 配置是否同步。\n\n\u0060\u0060\u0060bash\n$ istioctl proxy-status\nPROXY                                                 CDS        LDS        EDS               RDS          PILOT                            VERSION\ndetails-v1-876bf485f-sx7df.default                    SYNCED     SYNCED     SYNCED (100%)     SYNCED       istio-pilot-5bf6d97f79-6lz4x     1.0.0\n...\n\u0060\u0060\u0060\n\n[istioctl](https:\/\/istio.io\/zh\/docs\/reference\/commands\/istioctl\/) 这个命令行工具就像 [kubectl](https:\/\/jimmysong.io\/kubernetes-handbook\/guide\/kubectl-cheatsheet.html) 一样有很多神器的魔法，通过它可以高效的管理 Istio 和 debug。\n\n## Envoy proxy 配置解析\n\nIstio envoy sidecar proxy 配置中包含以下四个部分。\n\n- **bootstrap**：Envoy proxy 启动时候加载的静态配置。\n- **listeners**：监听器配置，使用 LDS 下发。\n- **clusters**：集群配置，静态配置中包括 xds-grpc 和 zipkin 地址，动态配置使用  CDS 下发。\n- **routes**：路由配置，静态配置中包括了本地监听的服务的集群信息，其中引用了 cluster，动态配置使用 RDS 下发。\n\n每个部分中都包含静态配置与动态配置，其中 bootstrap 配置又是在集群启动的时候通过 sidecar 启动参数注入的，配置文件在 \u0060\/etc\/istio\/proxy\/envoy-rev0.json\u0060。\n\n由于 bootstrap 中的配置是来自 Envoy 启动时加载的静态文件，主要配置了节点信息、tracing、admin 和统计信息收集等信息，这不是本文的重点，大家可以自行研究。\n\nBootstrap 是 Envoy 中配置的根本来源，Bootstrap 消息中有一个关键的概念，就是静态和动态资源的之间的区别。例如 Listener 或 Cluster 这些资源既可以从 static_resources 静态的获得也可以从 dynamic_resources 中配置的 LDS 或 CDS 之类的 xDS 服务获取。\n\n### Listener\n\nListener 顾名思义，就是监听器，监听 IP 地址和端口，然后根据策略转发。\n\n**Listener 的特点**\n\n- 每个 Envoy 进程中可以有多个 Listener，Envoy 与 Listener 之间是一对多的关系。\n- 每个 Listener 中可以配置一条 filter 链表（filter_chains），Envoy 会根据 filter 顺序执行过滤。\n- Listener 可以监听下游的端口，也可以接收来自其他 listener 的数据，形成链式处理。\n- filter 是可扩展的。\n- 可以静态配置，也可以使用 LDS 动态配置。\n- 目前只能监听 TCP，UDP 还未支持。\n\n**Listener 的数据结构**\n\nListener 的数据结构如下，除了 \u0060name\u0060、\u0060address\u0060 和 \u0060filter_chains\u0060 为必须配置之外，其他都为可选的。\n\n\u0060\u0060\u0060json\n{\n  \u0022name\u0022: \u0022...\u0022,\n  \u0022address\u0022: \u0022{...}\u0022,\n  \u0022filter_chains\u0022: [],\n  \u0022use_original_dst\u0022: \u0022{...}\u0022,\n  \u0022per_connection_buffer_limit_bytes\u0022: \u0022{...}\u0022,\n  \u0022metadata\u0022: \u0022{...}\u0022,\n  \u0022drain_type\u0022: \u0022...\u0022,\n  \u0022listener_filters\u0022: [],\n  \u0022transparent\u0022: \u0022{...}\u0022,\n  \u0022freebind\u0022: \u0022{...}\u0022,\n  \u0022socket_options\u0022: [],\n  \u0022tcp_fast_open_queue_length\u0022: \u0022{...}\u0022,\n  \u0022bugfix_reverse_write_filter_order\u0022: \u0022{...}\u0022\n}\n\u0060\u0060\u0060\n\n下面是关于上述数据结构中的常用配置解析。\n\n- **name**：该 listener 的 UUID，唯一限定名，默认 60 个字符，例如 \u006010.254.74.159_15011\u0060，可以使用命令参数指定长度限制。\n\n- **address**：监听的逻辑\/物理地址和端口号，例如\n\n  \u0060\u0060\u0060json\n  \u0022address\u0022: {\n         \u0022socket_address\u0022: {\n          \u0022address\u0022: \u002210.254.74.159\u0022,\n          \u0022port_value\u0022: 15011\n         }\n  }\n  \u0060\u0060\u0060\n\n- **filter_chains**：这是一个列表，Envoy 中内置了一些通用的 filter，每种 filter 都有特定的数据结构，Envoy 会根据该配置顺序执行 filter。Envoy 中内置的 filter 有：[envoy.client_ssl_auth](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/client_ssl_auth_filter#config-network-filters-client-ssl-auth)、[envoy.echo](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/echo_filter#config-network-filters-echo)、[Envoy.http_connection_manager](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/http_conn_man\/http_conn_man#config-http-conn-man)、[envoy.mongo_proxy](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/mongo_proxy_filter#config-network-filters-mongo-proxy)、[envoy.rate_limit](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/rate_limit_filter#config-network-filters-rate-limit)、[Envoy.redis_proxy](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/redis_proxy_filter#config-network-filters-redis-proxy)、[envoy.tcp_proxy](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/network_filters\/tcp_proxy_filter#config-network-filters-tcp-proxy)、[http_filters](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/intro\/arch_overview\/http_filters)、[thrift_filters](https:\/\/www.envoyproxy.io\/docs\/envoy\/v1.8.0\/configuration\/thrift_filters\/thrift_filters)等。这些 filter 可以单独使用也可以组合使用，还可以自定义扩展，例如使用 Istio 中的 EnvoyFilter 配置。\n\n- **use_original_dst**：这是一个布尔值，如果使用 iptables 重定向连接，则代理接收的端口可能与原始目的地址的端口不一样。当此标志设置为 true 时，Listener 将重定向的连接切换到与原始目的地址关联的 Listener。如果没有与原始目的地址关联的 Listener，则连接由接收它的 Listener 处理。默认为 false。注意：该参数将被废弃，请使用原始目的地址的 Listener filter 替代。该参数的主要用途是：Envoy 通过监听 15001 端口将应用的流量截取后再由其他 Listener 处理而不是直接转发出去，详情见 [Virtual Listener](https:\/\/zhaohuabing.com\/post\/2018-09-25-istio-traffic-management-impl-intro\/#virtual-listener)。\n\n关于 Listener 的详细介绍请参考 Envoy v2 API reference - listener。\n\n### Route\n\n我们在这里所说的路由指的是 HTTP 路由，这也使得 Envoy 可以用来处理网格边缘的流量。HTTP 路由转发是通过路由过滤器实现的。该过滤器的主要职能就是执行路由表中的指令。除了可以做重定向和转发，路由过滤器还需要处理重试、统计之类的任务。\n\n**HTTP 路由的特点**\n\n- 前缀和精确路径匹配规则。\n- 可跨越多个上游集群进行基于权重\/百分比的路由。\n- 基于优先级的路由。\n- 基于哈希策略的路由。\n\n**Route 的数据结构**\n\n\u0060\u0060\u0060json\n{\n  \u0022name\u0022: \u0022...\u0022,\n  \u0022virtual_hosts\u0022: [],\n  \u0022internal_only_headers\u0022: [],\n  \u0022response_headers_to_add\u0022: [],\n  \u0022response_headers_to_remove\u0022: [],\n  \u0022request_headers_to_add\u0022: [],\n  \u0022request_headers_to_remove\u0022: [],\n  \u0022validate_clusters\u0022: \u0022{...}\u0022\n}\n\u0060\u0060\u0060\n\n下面是关于上述数据结构中的常用配置解析。\n\n- **name**：该名字跟 \u0060envoy.http_connection_manager\u0060 filter 中的 \u0060http_filters.rds.route_config_name\u0060 一致，在 Istio Service Mesh 中为 Envoy 下发的配置中的 Route 是以监听的端口号作为名字，而同一个名字下面的 \u0060virtual_hosts\u0060 可以有多个值（数组形式）。\n- **virtual_hosts**：因为 **VirtualHosts** 是 Envoy 中引入的一个重要概念，我们在下文将详细说明 \u0060virtual_hosts\u0060 的数据结构。\n- **validate_clusters**：这是一个布尔值，用来设置开启使用 cluster manager 来检测路由表引用的 cluster 是否有效。如果是路由表是通过 route_config 静态配置的则该值默认设置为 true，如果是使用 rds 动态配置的话，则该值默认设置为 false。\n\n#### route.VirtualHost\n\nVirtualHost 即上文中 Route 配置中的 \u0060virtual_hosts\u0060，VirtualHost 是路由配置中的顶级元素。每个虚拟主机都有一个逻辑名称以及一组根据传入请求的 host header 路由到它的域。这允许单个 Listener 为多个顶级域路径树提供服务。基于域选择了虚拟主机后 Envoy  就会处理路由以查看要路由到哪个上游集群或是否执行重定向。\n\n**VirtualHost 的数据结构**\n\n下面是 VirtualHost 的数据结构，除了 \u0060name\u0060 和 \u0060domains\u0060 是必须配置项外，其他皆为可选项。\n\n\u0060\u0060\u0060json\n{\n  \u0022name\u0022: \u0022...\u0022,\n  \u0022domains\u0022: [],\n  \u0022routes\u0022: [],\n  \u0022require_tls\u0022: \u0022...\u0022,\n  \u0022virtual_clusters\u0022: [],\n  \u0022rate_limits\u0022: [],\n  \u0022request_headers_to_add\u0022: [],\n  \u0022request_headers_to_remove\u0022: [],\n  \u0022response_headers_to_add\u0022: [],\n  \u0022response_headers_to_remove\u0022: [],\n  \u0022cors\u0022: \u0022{...}\u0022,\n  \u0022per_filter_config\u0022: \u0022{...}\u0022,\n  \u0022include_request_attempt_count\u0022: \u0022...\u0022\n}\n\u0060\u0060\u0060\n\n下面是关于上述数据结构中的常用配置解析。\n\n- **name**：该 VirtualHost 的名字，一般是 FQDN 加端口，如 \u0060details.default.svc.cluster.local:9080\u0060。\n- **domains**：这是个用来匹配 VirtualHost 的域名（host\/authority header）列表，也可以使用通配符，但是通配符不能匹配空字符，除了仅使用 \u0060*\u0060 作为 domains，注意列表中的值不能重复和存在交集，只要有一条 domain 被匹配上了，就会执行路由。Istio 会为该值配置所有地址解析形式，包括 IP 地址、FQDN 和短域名等。\n- **routes**：针对入口流量的有序路由列表，第一个匹配上的路由将被执行。我们在下文将详细说明 route 的数据结构。\n\n下面是一个实际的 VirtualHost 的例子，该配置来自 [Bookinfo 应用](https:\/\/istio.io\/latest\/zh\/docs\/examples\/bookinfo\/)的 details 应用的 Sidecar 服务。\n\n\u0060\u0060\u0060json\n{\n            \u0022name\u0022: \u0022details.default.svc.cluster.local:9080\u0022,\n            \u0022domains\u0022: [\n                \u0022details.default.svc.cluster.local\u0022,\n                \u0022details.default.svc.cluster.local:9080\u0022,\n                \u0022details\u0022,\n                \u0022details:9080\u0022,\n                \u0022details.default.svc.cluster\u0022,\n                \u0022details.default.svc.cluster:9080\u0022,\n                \u0022details.default.svc\u0022,\n                \u0022details.default.svc:9080\u0022,\n                \u0022details.default\u0022,\n                \u0022details.default:9080\u0022,\n                \u002210.254.4.113\u0022,\n                \u002210.254.4.113:9080\u0022\n            ],\n            \u0022routes\u0022: [\n                {\n                    \u0022match\u0022: {\n                        \u0022prefix\u0022: \u0022\/\u0022\n                    },\n                    \u0022route\u0022: {\n                        \u0022cluster\u0022: \u0022outbound|9080||details.default.svc.cluster.local\u0022,\n                        \u0022timeout\u0022: \u00220s\u0022,\n                        \u0022max_grpc_timeout\u0022: \u00220s\u0022\n                    },\n                    \u0022decorator\u0022: {\n                        \u0022operation\u0022: \u0022details.default.svc.cluster.local:9080\/*\u0022\n                    },\n                    \u0022per_filter_config\u0022: {\n                        \u0022mixer\u0022: {\n                            \u0022forward_attributes\u0022: {\n                                \u0022attributes\u0022: {\n                                    \u0022destination.service.uid\u0022: {\n                                        \u0022string_value\u0022: \u0022istio:\/\/default\/services\/details\u0022\n                                    },\n                                    \u0022destination.service.host\u0022: {\n                                        \u0022string_value\u0022: \u0022details.default.svc.cluster.local\u0022\n                                    },\n                                    \u0022destination.service.namespace\u0022: {\n                                        \u0022string_value\u0022: \u0022default\u0022\n                                    },\n                                    \u0022destination.service.name\u0022: {\n                                        \u0022string_value\u0022: \u0022details\u0022\n                                    },\n                                    \u0022destination.service\u0022: {\n                                        \u0022string_value\u0022: \u0022details.default.svc.cluster.local\u0022\n                                    }\n                                }\n                            },\n                            \u0022mixer_attributes\u0022: {\n                                \u0022attributes\u0022: {\n                                    \u0022destination.service.host\u0022: {\n                                        \u0022string_value\u0022: \u0022details.default.svc.cluster.local\u0022\n                                    },\n                                    \u0022destination.service.uid\u0022: {\n                                        \u0022string_value\u0022: \u0022istio:\/\/default\/services\/details\u0022\n                                    },\n                                    \u0022destination.service.name\u0022: {\n                                        \u0022string_value\u0022: \u0022details\u0022\n                                    },\n                                    \u0022destination.service.namespace\u0022: {\n                                        \u0022string_value\u0022: \u0022default\u0022\n                                    },\n                                    \u0022destination.service\u0022: {\n                                        \u0022string_value\u0022: \u0022details.default.svc.cluster.local\u0022\n                                    }\n                                }\n                            },\n                            \u0022disable_check_calls\u0022: true\n                        }\n                    }\n                }\n            ]\n        }\n\u0060\u0060\u0060\n\n#### route.Route\n\n路由既是如何匹配请求的规范，也是对下一步做什么的指示（例如，redirect、forward、rewrite 等）。\n\n**route.Route 的数据结构**\n\n下面是是 route.Route 的数据结构，除了 \u0060match\u0060 之外其余都是可选的。\n\n\u0060\u0060\u0060json\n{\n  \u0022match\u0022: \u0022{...}\u0022,\n  \u0022route\u0022: \u0022{...}\u0022,\n  \u0022redirect\u0022: \u0022{...}\u0022,\n  \u0022direct_response\u0022: \u0022{...}\u0022,\n  \u0022metadata\u0022: \u0022{...}\u0022,\n  \u0022decorator\u0022: \u0022{...}\u0022,\n  \u0022per_filter_config\u0022: \u0022{...}\u0022,\n  \u0022request_headers_to_add\u0022: [],\n  \u0022request_headers_to_remove\u0022: [],\n  \u0022response_headers_to_add\u0022: [],\n  \u0022response_headers_to_remove\u0022: []\n}\n\u0060\u0060\u0060\n\n下面是关于上述数据结构中的常用配置解析。\n\n- **match**：路由匹配参数。例如 URL prefix（前缀）、path（URL 的完整路径）、regex（规则表达式）等。\n- **route**：这里面配置路由的行为，可以是 route、redirect 和 direct_response，不过这里面没有专门的一个配置项用来配置以上三种行为，而是根据实际填充的配置项来确定的。例如在此处添加 \u0060cluster\u0060 配置则暗示路由动作为”route“，表示将流量路由到该 cluster。详情请参考 route.RouteAction。\n- **decorator**：被匹配的路由的修饰符，表示被匹配的虚拟主机和 URL。该配置里有且只有一个必须配置的项 \u0060operation\u0060，例如 \u0060details.default.svc.cluster.local:9080\/*\u0060。\n- **per_filter_config**：这是一个 map 类型，\u0060per_filter_config\u0060 字段可用于为 filter 提供特定路由的配置。Map 的 key 应与 filleter 名称匹配，例如用于 HTTP buffer filter 的 \u0060envoy.buffer\u0060。该字段是特定于 filter 的，详情请参考 HTTP filter。\n\n### Cluster\n\nCluster 是指 Envoy 连接的一组逻辑相同的上游主机。Envoy 通过服务发现来发现 cluster 的成员。可以选择通过主动健康检查来确定集群成员的健康状态。Envoy 通过负载均衡策略决定将请求路由到 cluster 的哪个成员。\n\n**Cluster 的特点**\n\n- 一组逻辑上相同的主机构成一个 cluster。\n- 可以在 cluster 中定义各种负载均衡策略。\n- 新加入的 cluster 需要一个热身的过程才可以给路由引用，该过程是原子的，即在 cluster 热身之前对于 Envoy 及 Service Mesh 的其余部分来说是不可见的。\n- 可以通过多种方式来配置 cluster，例如静态类型、严格限定 DNS、逻辑 DNS、EDS 等。\n\n**Cluster 的数据结构**\n\nCluster 的数据结构如下，除了 \u0060name\u0060 字段，其他都是可选的。\n\n\u0060\u0060\u0060json\n{\n  \u0022name\u0022: \u0022...\u0022,\n  \u0022alt_stat_name\u0022: \u0022...\u0022,\n  \u0022type\u0022: \u0022...\u0022,\n  \u0022eds_cluster_config\u0022: \u0022{...}\u0022,\n  \u0022connect_timeout\u0022: \u0022{...}\u0022,\n  \u0022per_connection_buffer_limit_bytes\u0022: \u0022{...}\u0022,\n  \u0022lb_policy\u0022: \u0022...\u0022,\n  \u0022hosts\u0022: [],\n  \u0022load_assignment\u0022: \u0022{...}\u0022,\n  \u0022health_checks\u0022: [],\n  \u0022max_requests_per_connection\u0022: \u0022{...}\u0022,\n  \u0022circuit_breakers\u0022: \u0022{...}\u0022,\n  \u0022tls_context\u0022: \u0022{...}\u0022,\n  \u0022common_http_protocol_options\u0022: \u0022{...}\u0022,\n  \u0022http_protocol_options\u0022: \u0022{...}\u0022,\n  \u0022http2_protocol_options\u0022: \u0022{...}\u0022,\n  \u0022extension_protocol_options\u0022: \u0022{...}\u0022,\n  \u0022dns_refresh_rate\u0022: \u0022{...}\u0022,\n  \u0022dns_lookup_family\u0022: \u0022...\u0022,\n  \u0022dns_resolvers\u0022: [],\n  \u0022outlier_detection\u0022: \u0022{...}\u0022,\n  \u0022cleanup_interval\u0022: \u0022{...}\u0022,\n  \u0022upstream_bind_config\u0022: \u0022{...}\u0022,\n  \u0022lb_subset_config\u0022: \u0022{...}\u0022,\n  \u0022ring_hash_lb_config\u0022: \u0022{...}\u0022,\n  \u0022original_dst_lb_config\u0022: \u0022{...}\u0022,\n  \u0022least_request_lb_config\u0022: \u0022{...}\u0022,\n  \u0022common_lb_config\u0022: \u0022{...}\u0022,\n  \u0022transport_socket\u0022: \u0022{...}\u0022,\n  \u0022metadata\u0022: \u0022{...}\u0022,\n  \u0022protocol_selection\u0022: \u0022...\u0022,\n  \u0022upstream_connection_options\u0022: \u0022{...}\u0022,\n  \u0022close_connections_on_host_health_failure\u0022: \u0022...\u0022,\n  \u0022drain_connections_on_host_removal\u0022: \u0022...\u0022\n}\n\u0060\u0060\u0060\n\n下面是关于上述数据结构中的常用配置解析。\n\n- **name**：如果你留意到作为 Sidecar 启动的 Envoy 的参数的会注意到 \u0060--max-obj-name-len 189\u0060，该选项用来用来指定 cluster 的名字，例如 \u0060inbound|9080||ratings.default.svc.cluster.local\u0060。该名字字符串由 \u0060|\u0060 分隔成四个部分，分别是 \u0060inbound\u0060 或 \u0060outbound\u0060 代表入向流量或出向流量、端口号、subcluster 名称、FQDN，其中 subcluster 名称将对应于 Istio \u0060DestinationRule\u0060 中配置的 \u0060subnet\u0060，如果是按照多版本按比例路由的话，该值可以是版本号。\n- **type**：即服务发现类型，支持的参数有 \u0060STATIC\u0060（缺省值）、\u0060STRICT_DNS\u0060、\u0060LOGICAL_DNS\u0060、\u0060EDS\u0060、\u0060ORIGINAL_DST\u0060。\n- **hosts**：这是个列表，配置负载均衡的 IP 地址和端口，只有使用了  \u0060STATIC\u0060、\u0060STRICT_DNS\u0060、\u0060LOGICAL_DNS\u0060 服务发现类型时才需要配置。\n- **eds_cluster_config**：如果使用 \u0060EDS\u0060 做服务发现，则需要配置该项目，其中包括的配置有 \u0060service_name\u0060 和 \u0060ads\u0060。\n\n## 参考\n\n- [深入解读 Service Mesh 背后的技术细节 - cnblogs.com](https:\/\/www.cnblogs.com\/163yun\/p\/8962278.html)\n- [理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持 - jimmysong.io](https:\/\/jimmysong.io\/blog\/envoy-sidecar-injection-in-istio-service-mesh-deep-dive\/)\n', '\/blog\/envoy-proxy-config-deep-dive\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了 Envoy proxy 的概念，对应的 xDS 的版本以及配置的详细解析。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-mesh-in-kubernetes-tutorial/">在 Kubernetes 中使用 Envoy mesh 教程</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/04/28</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('在 Kubernetes 中使用 Envoy mesh 教程', '本文是在 Kubernetes 集群中，使用 Envoy 来做 mesh，来为一个简单的使用 Python 编写的 Flask 应用程序做反向代理和负载均衡。', '\n本文是在 Kubernetes 集群中，使用 Envoy 来做 mesh，来为一个简单的使用 Python 编写的 Flask 应用程序做反向代理和负载均衡。\n\n**注**：本教程中的示例来自 [envoy-steps](https:\/\/github.com\/datawire\/envoy-steps)，本文中使用的所有的代码和 YAML 配置见 [envoy-tutorial](https:\/\/github.com\/rootsongjc\/envoy-tutorial)。\n\n![Envoy Mesh 架构图](envoy-mesh-in-kubernetes.webp)\n\n## 前提条件\n\n使用 [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) 部署 kubernetes 集群，只要启动集群并安装了 CoreDNS 即可，无须安装其他插件。\n\n## 部署应用\n\n我们首先将应用部署到 Kubernetes 中。\n\n部署 postgres 数据库。\n\n\u0060\u0060\u0060bash\nkubectl apply -f postgres\n\u0060\u0060\u0060\n\n创建 usersvc 镜像。\n\n\u0060\u0060\u0060bash\ndocker build -t jimmysong\/usersvc:step1 .\n\u0060\u0060\u0060\n\n部署 usersvc。\n\n\u0060\u0060\u0060bash\nkubectl apply -f usersvc\n\u0060\u0060\u0060\n\n查看 uservc 的 ClusterIP 地址。\n\n\u0060\u0060\u0060bash\n$ kubectl get svc usersvc\nkubectl get svc usersvc\nNAME      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nusersvc   ClusterIP   10.254.176.248   \u003cnone\u003e        5000\/TCP   11m\n\u0060\u0060\u0060\n\n进到 node1 中访问该服务，因为我们要访问的是 ClusterIP，在我们自己的电脑上是无法直接访问的，所以进到虚拟机中操作。\n\n\u0060\u0060\u0060bash\n$ vagrant ssh node1\n$ curl 10.254.176.248:5000\n{\n  \u0022hostname\u0022: \u0022usersvc-7cf5bb9d85-9gx7w\u0022,\n  \u0022msg\u0022: \u0022user health check OK\u0022,\n  \u0022ok\u0022: true,\n  \u0022resolvedname\u0022: \u0022172.33.10.7\u0022\n}\n\u0060\u0060\u0060\n\n尝试添加一个名为 \u0060Alice\u0060 的用户。\n\n\u0060\u0060\u0060bash\n$ curl -X PUT -H \u0022Content-Type: application\/json\u0022 \\\n    -d \u0027{ \u0022fullname\u0022: \u0022Alice\u0022, \u0022password\u0022: \u0022alicerules\u0022 }\u0027 \\\n    10.254.176.248\/user\/alice\n\u0060\u0060\u0060\n\n将会看到类似如下的输出。\n\n\u0060\u0060\u0060json\n{\n  \u0022fullname\u0022: \u0022Alice\u0022,\n  \u0022hostname\u0022: \u0022usersvc-7cf5bb9d85-9gx7w\u0022,\n  \u0022ok\u0022: true,\n  \u0022resolvedname\u0022: \u0022172.33.10.7\u0022,\n  \u0022uuid\u0022: \u0022EF43B475F65848C6BE708F436305864B\u0022\n}\n\u0060\u0060\u0060\n\n尝试再添加一个名为 \u0060Bob\u0060 的用户。\n\n\u0060\u0060\u0060bash\n$ curl -X PUT -H \u0022Content-Type: application\/json\u0022 \\\n    -d \u0027{ \u0022fullname\u0022: \u0022Bob\u0022, \u0022password\u0022: \u0022bobrules\u0022 }\u0027 \\\n    10.254.176.248\/user\/bob\n\u0060\u0060\u0060\n\n将会看到类似如下的输出。\n\n\u0060\u0060\u0060json\n{\n  \u0022fullname\u0022: \u0022Bob\u0022,\n  \u0022hostname\u0022: \u0022usersvc-7cf5bb9d85-9gx7w\u0022,\n  \u0022ok\u0022: true,\n  \u0022resolvedname\u0022: \u0022172.33.10.7\u0022,\n  \u0022uuid\u0022: \u00226AC944E7D4254D9A811A82C0FDAC3046\u0022\n}\n\u0060\u0060\u0060\n\n当应用部署完毕后，我们该部署 edge envoy 了。\n\n## 部署 edge envoy\n\n部署 edge envoy 的方式很简单，执行下面的命令。\n\n\u0060\u0060\u0060bash\nkubectl apply -f edge-envoy\n\u0060\u0060\u0060\n\n现在访问 edge envoy 是就可以路由到 \u0060usersvc\u0060 上的，当然直接访问 \u0060usersvc\u0060 也是可以的。\n\n我们看下 edge-envoy 的 envoy 配置文件定义。\n\n\u0060\u0060\u0060json\n{\n  \u0022listeners\u0022: [\n    {\n      \u0022address\u0022: \u0022tcp:\/\/0.0.0.0:80\u0022,\n      \u0022filters\u0022: [\n        {\n          \u0022type\u0022: \u0022read\u0022,\n          \u0022name\u0022: \u0022http_connection_manager\u0022,\n          \u0022config\u0022: {\n            \u0022codec_type\u0022: \u0022auto\u0022,\n            \u0022stat_prefix\u0022: \u0022ingress_http\u0022,\n            \u0022route_config\u0022: {\n              \u0022virtual_hosts\u0022: [\n                {\n                  \u0022name\u0022: \u0022backend\u0022,\n                  \u0022domains\u0022: [\u0022*\u0022],\n                  \u0022routes\u0022: [\n                    {\n                      \u0022timeout_ms\u0022: 0,\n                      \u0022prefix\u0022: \u0022\/user\u0022,\n                      \u0022cluster\u0022: \u0022usersvc\u0022\n                    }\n                  ]\n                }\n              ]\n            },\n            \u0022filters\u0022: [\n              {\n                \u0022type\u0022: \u0022decoder\u0022,\n                \u0022name\u0022: \u0022router\u0022,\n                \u0022config\u0022: {}\n              }\n            ]\n          }\n        }\n      ]\n    }\n  ],\n  \u0022admin\u0022: {\n    \u0022access_log_path\u0022: \u0022\/dev\/null\u0022,\n    \u0022address\u0022: \u0022tcp:\/\/127.0.0.1:8001\u0022\n  },\n  \u0022cluster_manager\u0022: {\n    \u0022clusters\u0022: [\n      {\n        \u0022name\u0022: \u0022usersvc\u0022,\n        \u0022connect_timeout_ms\u0022: 250,\n        \u0022type\u0022: \u0022strict_dns\u0022,\n        \u0022service_name\u0022: \u0022usersvc\u0022,\n        \u0022lb_type\u0022: \u0022round_robin\u0022,\n        \u0022features\u0022: \u0022http2\u0022,\n        \u0022hosts\u0022: [\n          {\n            \u0022url\u0022: \u0022tcp:\/\/usersvc:80\u0022\n          }\n        ]\n      }\n    ]\n  }\n}\n\u0060\u0060\u0060\n\n客户端访问 \u0060edge-envoy\u0060 的 \u0060ClusterIP:8000\/user\/health\u0060 就可以检查节点的健康状况。\n\n## 部署 usersvc2\n\n删除原来的 \u0060usersvc\u0060，部署第二版 \u0060usersvc2\u0060，它与原来的 \u0060usersvc\u0060 唯一不同的地方是在 \u0060entrypoint\u0060 中集成了 envoy，查看 \u0060Dockerfile\u0060 中指定的 \u0060entrypoint.sh\u0060 的内容便可知。\n\n\u0060\u0060\u0060bash\n#!\/bin\/sh\n\npython \/application\/service.py \u0026\n\/usr\/local\/bin\/envoy -c \/application\/envoy.json\n\u0060\u0060\u0060\n\n首先删除老的 \u0060usersvc\u0060。\n\n\u0060\u0060\u0060bash\nkubectl delete -f usersvc\n\u0060\u0060\u0060\n\n使用下面的命令部署 \u0060usersvc2\u0060，它仍然使用 \u0060usersvc\u0060 这个 service 名称。\n\n\u0060\u0060\u0060bash\nkubectl apply -f usersvc2\n\u0060\u0060\u0060\n\nEnvoy 以 out-of-process 的方式运行，对应用进程没有侵入性，也可以使用 sidecar 的方式运行，让 envoy 与 应用容器运行在同一个 pod 中。\n\n增加 \u0060usersvc2\u0060 的实例个数。\n\n\u0060\u0060\u0060bash\nkubectl scale --replicas=3 deployment\/usersvc\n\u0060\u0060\u0060\n\n此时我们有 3 个 usersvc 实例，现在通过 \u0060edge-envoy\u0060 的 \u0060ClusterIP:8000\/user\/health\u0060 检查节点的健康状况时，是不是会轮询的访问到后端的的 \u0060usersvc2\u0060 的实例呢？\n\n我们当初在 \u0060edge-node\u0060 的 \u0060envoy.json\u0060 中配置过 cluster 的，其中指定了 \u0060lb_type\u0060 为 \u0060round_robin\u0060 。\n\n\u0060\u0060\u0060json\n  \u0022cluster_manager\u0022: {\n    \u0022clusters\u0022: [\n      {\n        \u0022name\u0022: \u0022usersvc\u0022,\n        \u0022connect_timeout_ms\u0022: 250,\n        \u0022type\u0022: \u0022strict_dns\u0022,\n        \u0022service_name\u0022: \u0022usersvc\u0022,\n        \u0022lb_type\u0022: \u0022round_robin\u0022,\n        \u0022features\u0022: \u0022http2\u0022,\n        \u0022hosts\u0022: [\n          {\n            \u0022url\u0022: \u0022tcp:\/\/usersvc:80\u0022\n          }\n        ]\n      }\n    ]\n  }\n\u0060\u0060\u0060\n\n而且该 \u0060Service_name\u0060 也可以被 DNS 正确解析。\n\n\u0060\u0060\u0060bash\nroot@usersvc-55b6857d44-gcg5c:\/application# nslookup usersvc\nServer:         10.254.0.2\nAddress:        10.254.0.2#53\n\nName:   usersvc.envoy-tutorial.svc.cluster.local\nAddress: 10.254.123.166\n\u0060\u0060\u0060\n\n**答案是否定的。**\n\n虽然通过 DNS 可以正确的解析出 Service 的 ClusterIP，但是负载均衡不再通过 kube-proxy 实现，所以不论我们访问多少次 \u0060edge-envoy\u0060 永远只能访问到一个固定的后端 \u0060usersvc\u0060。\n\n## 服务发现服务 - SDS\n\nKubernetes 中的 DNS 可以发现所有 Service 的 ClusterIP，但是 DNS 中不包括所有 endpoint 地址，我们需要一个 SDS（服务发现服务）来发现服务的所有的 endpoint，我们将修改 \u0060lb_type\u0060，使用 \u0060sds\u0060 替代 \u0060strict_dns\u0060。\n\n执行下面的命令部署 SDS。\n\n\u0060\u0060\u0060bassh\nkubectl apply -f usersvc-sds\n\u0060\u0060\u0060\n\n因为在添加了 SDS 之后需要修改 \u0060edge-envoy\u0060 中的 \u0060envoy.josn\u0060 配置，在 \u0060clusters\u0060 字段中增加 \u0060sds\u0060 信息，我们将所有的配置都写好了，重新打包成了镜像，我们需要先删除之前部署的 \u0060edge-envoy\u0060。\n\n\u0060\u0060\u0060bash\nkubectl delete -f edge-envoy\n\u0060\u0060\u0060\n\n部署新的 \u0060edge-envoy2\u0060。\n\n\u0060\u0060\u0060bash\nkubectl apply -f edge-envoy2\n\u0060\u0060\u0060\n\n连续访问 \u0060usersvc\u0060 12 次看看输出结果如何。\n\n\u0060\u0060\u0060bash\nURL=http:\/\/172.17.8.101:30800\/user\/alice\nfor i in \u0060seq 1 12\u0060;do curl -s $URL|grep \u0022resolvedname\u0022|tr -d \u0022 \u0022|tr -d \u0022,\u0022|tr -d \u0027\u0022\u0027;done\n\u0060\u0060\u0060\n\n我们可以看到类似如下的输出：\n\n\u0060\u0060\u0060ini\nresolvedname:172.33.71.2\nresolvedname:172.33.88.2\nresolvedname:172.33.10.2\nresolvedname:172.33.71.2\nresolvedname:172.33.88.2\nresolvedname:172.33.10.2\nresolvedname:172.33.71.2\nresolvedname:172.33.88.2\nresolvedname:172.33.10.2\nresolvedname:172.33.71.2\nresolvedname:172.33.88.2\nresolvedname:172.33.10.2\n\u0060\u0060\u0060\n\n再查看下 \u0060usersvc\u0060 服务的所有 pod 的 IP 地址。\n\n\u0060\u0060\u0060bash\n$ kubectl get pod -l service=usersvc -o wide\nNAME                       READY     STATUS    RESTARTS   AGE       IP            NODE\nusersvc-55b6857d44-mkfpv   1\/1       Running   0          9m        172.33.88.2   node1\nusersvc-55b6857d44-q98jg   1\/1       Running   0          9m        172.33.71.2   node2\nusersvc-55b6857d44-s2znk   1\/1       Running   0          9m        172.33.10.2   node3\n\u0060\u0060\u0060\n\n我们看到 round-robin 负载均衡生效了。\n\n## 参考\n\n- [Part 2: Deploying Envoy with a Python Flask webapp and Kubernetes](https:\/\/www.datawire.io\/envoyproxy\/envoy-flask-kubernetes\/)\n- [envoy-steps](https:\/\/github.com\/datawire\/envoy-steps)\n- [kubernetes-vagrant-centos-cluster](https:\/\/github.com\/rootsongjc\/kubernetes-vagrant-centos-cluster) \n- [envoy-tutorial](https:\/\/github.com\/rootsongjc\/envoy-tutorial)\n', '\/blog\/envoy-mesh-in-kubernetes-tutorial\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文是在 Kubernetes 集群中，使用 Envoy 来做 mesh，来为一个简单的使用 Python 编写的 Flask 应用程序做反向代理和负载均衡。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-archiecture-and-terminology/">Envoy 的架构与基本配置解析</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/04/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy 的架构与基本配置解析', '本文介绍了 Envoy proxy 中的基本概念、配置与架构解析。', '\n在了解一门技术之前一开始就要了解其中的基本概念和术语，只有融入了该语境才能理解这门技术。本文将为大家介绍 Envoy 中的基本术语和重点概念。\n\n## 架构\n\n下图是 Envoy proxy 的架构图，显示了 host B 经过 Envoy 访问 host A 的过程。每个 host 上都可能运行多个 service，Envoy 中也可能有多个 Listener，每个 Listener 中可能会有多个 filter 组成了 chain。\n\n![Envoy proxy 架构图](envoy-arch.jpg)\n\n其中的基本术语将在下面解释。\n\n## 基本术语\n\n**Host**：能够进行网络通信的实体（在手机或服务器等上的应用程序）。在 Envoy 中主机是指逻辑网络应用程序。只要每台主机都可以独立寻址，一块物理硬件上就运行多个主机。\n\n**Downstream**：下游（downstream）主机连接到 Envoy，发送请求并或获得响应。\n\n**Upstream**：上游（upstream）主机获取来自 Envoy 的链接请求和响应。\n\n**Cluster**: 集群（cluster）是 Envoy 连接到的一组逻辑上相似的上游主机。Envoy 通过服务发现发现集群中的成员。Envoy 可以通过主动运行状况检查来确定集群成员的健康状况。Envoy 如何将请求路由到集群成员由负载均衡策略确定。\n\n**Mesh**：一组互相协调以提供一致网络拓扑的主机。Envoy mesh 是指一组 Envoy 代理，它们构成了由多种不同服务和应用程序平台组成的分布式系统的消息传递基础。\n\n**运行时配置**：与 Envoy 一起部署的带外实时配置系统。可以在无需重启 Envoy 或 更改 Envoy 主配置的情况下，通过更改设置来影响操作。\n\n**Listener**: 侦听器（listener）是可以由下游客户端连接的命名网络位置（例如，端口、unix 域套接字等）。Envoy 公开一个或多个下游主机连接的侦听器。一般是每台主机运行一个 Envoy，使用单进程运行，但是每个进程中可以启动任意数量的 Listener（监听器），目前只监听 TCP，每个监听器都独立配置一定数量的（L3\/L4）网络过滤器。Listenter 也可以通过 Listener Discovery Service（**LDS**）动态获取。\n\n**Listener filter**：Listener 使用 listener filter（监听器过滤器）来操作链接的元数据。它的作用是在不更改 Envoy 的核心功能的情况下添加更多的集成功能。Listener filter 的 API 相对简单，因为这些过滤器最终是在新接受的套接字上运行。在链中可以互相衔接以支持更复杂的场景，例如调用速率限制。Envoy 已经包含了多个监听器过滤器。\n\n**Http Route Table**：HTTP 的路由规则，例如请求的域名，Path 符合什么规则，转发给哪个 Cluster。\n\n**Health checking**：健康检查会与 SDS 服务发现配合使用。但是，即使使用其他服务发现方式，也有相应需要进行主动健康检查的情况。详见 health checking。\n\n## xDS\n\nxDS 是一个关键概念，它是一类发现服务的统称，其包括如下几类：\n\n- CDS: Cluster Discovery Service\n- EDS: Endpoint Discovery Service\n- SDS: Secret Discovery Service\n- RDS: Route Discovery Service\n- LDS: Listener Discovery Service\n\n正是通过对 xDS 的请求来动态更新 Envoy 配置，另外还有个 ADS（Aggregated Discovery Service）通过聚合的方式解决以上 xDS 的更新顺序问题。\n\n## Envoy Mesh\n\nEnvoy Mesh 指的是由 envoy 做负载均衡和代理的 mesh。该 Mesh 中会包含两类 envoy：\n\n- Edge envoy：即流量进出 mesh 时候的 envoy，相当于 kubernetes 中的 ingress。\n- Service envoy：服务 envoy 是跟每个 Service 实例一起运行的，应用程序无感知的进程外工具，在 kubernetes 中会与应用容器以 sidecar 形式运行在同一个 pod 中。\n\nEnvoy 即可以单独作为 edge envoy，也可以仅做 service envoy 使用，也可以两者同时使用。Mesh 中的所有 envoy 会共享路由信息。\n\n## Envoy 配置\n\nEnvoy 中的配置包括两大类：listenner 配置和 cluster 配置。\n\n### Listener 配置\n\n我们知道 Envoy 中可以配置一组 listener 以实现复杂的处理逻辑。Listener 中设置监听的 TCP 端口，还有一组 filter 对这些端口上的数据流进行处理。\n\n\u0060\u0060\u0060yaml\n  listeners:\n  - address:\n      socket_address:\n        address: 0.0.0.0\n        port_value: 80\n    filter_chains:\n    - filters:\n      - name: envoy.http_connection_manager\n        config:\n          codec_type: auto\n          stat_prefix: ingress_http\n          route_config:\n            name: local_route\n            virtual_hosts:\n            - name: backend\n              domains:\n              - \u0022*\u0022\n              routes:\n              - match:\n                  prefix: \u0022\/service\/1\u0022\n                route:\n                  cluster: service1\n              - match:\n                  prefix: \u0022\/service\/2\u0022\n                route:\n                  cluster: service2\n\u0060\u0060\u0060\n\n这是一个 \u0060http_connection_manager\u0060 例子，其中必须包含 \u0060virtual_hosts\u0060 配置，而 \u0060virtual_hosts\u0060 配置中必须包含以下几项配置：\n\n- \u0060name\u0060：服务名称\n- \u0060domains\u0060：DNS 域名，必须能跟 \u0060virtual_host\u0060 的 URL 匹配 \n- \u0060routes\u0060：路由列表\n\n每个路由中还可以包含以下配置：\n\n- \u0060prefix\u0060：URL 路径前缀\n- \u0060cluster\u0060：处理该请求的 envoy cluster\n- \u0060timeout_ms\u0060：当出错时的超时时间\n\n如上面的例子中，我们还需要定义 \u0060service1\u0060 cluster 和 \u0060service2\u0060 cluster。\n\n### Cluster 配置\n\nCluster 是一组逻辑相似的主机配置，定义哪些主机属于一个服务，cluster 的配置中包含了服务发现和负载均衡方式配置。依然是参考使用 Envoy 作为前端代理中的配置：\n\n\u0060\u0060\u0060yaml\n clusters:\n  - name: service1\n    connect_timeout: 0.25s\n    type: strict_dns\n    lb_policy: round_robin\n    http2_protocol_options: {}\n    hosts:\n    - socket_address:\n        address: service1\n        port_value: 80\n  - name: service2\n    connect_timeout: 0.25s\n    type: strict_dns\n    lb_policy: round_robin\n    http2_protocol_options: {}\n    hosts:\n    - socket_address:\n        address: service2\n        port_value: 80\n\u0060\u0060\u0060\n\nCluster 的配置中至少包含以下信息：\n\n- \u0060name\u0060：cluster 名称，就是服务名称\n- \u0060type\u0060：该 cluster 怎么知道主机是否启动？即服务发现类型，有以下方式：\n  - \u0060static\u0060：监听 cluster 中的所有主机\n  - \u0060strict_dns\u0060：envoy 会监听 DNS，每个匹配的 A 记录都会认定为有效\n  - \u0060logical_dns\u0060：envoy 将使用 DNS 来增加主机，如果 DNS 不再返回该主机也不会删除这些主机信息\n  - \u0060sds\u0060：即 Service Discovery Service，envoy 访问外部的 REST 获取 cluster 成员信息\n- \u0060lb_type\u0060：cluster 的负载均衡类型，有以下方式：\n  - \u0060round_robin\u0060：轮询主机\n  - \u0060weighted_least_request\u0060：最近获得最少请求的主机\n  - \u0060random\u0060：随机\n- \u0060hosts\u0060：能够定义 cluster 中主机的 URL 地址，通常是\u0060tcp:\/\/\u0060 URL\n\n## 参考\n\n- [Part 1: Getting started with Envoy Proxy for microservices resilience - getambassador.io](https:\/\/www.getambassador.io\/resources\/getting-started-envoyproxy-microservices-resilience\/\/)\n', '\/blog\/envoy-archiecture-and-terminology\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了 Envoy proxy 中的基本概念、配置与架构解析。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-as-front-proxy/">使用 Envoy 作为前端代理</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2018/04/22</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 Envoy 作为前端代理', '本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。', '\n[Envoy](https:\/\/github.com\/envoyproxy\/envoy) 是一款由 Lyft 开源的，使用 C\u002b\u002b 编写的 L7 代理和通信总线，目前是 [CNCF](https:\/\/cncf.io) 旗下的开源项目，代码托管在 GitHub 上，它也是 [Istio](https:\/\/istio.io) service mesh 中默认的 data plane。本文将给出使用 Envoy 作为 service mesh 的数据平面的示例，应用使用 docker-compose 编排。\n\n## 特性\n\nEnvoy 包括如下特性：\n\n- 进程外架构，不侵入应用进程\n- 使用现代版 C\u002b\u002b11 代码\n- L3\/L4 filter 架构\n- HTTP L7 filter 架构\n- 支持 HTTP\/2\n- HTTP L7 routing\n- 支持 gRPC\n- 支持 MongoDB L7\n- 动态配置\n- 最佳可观测性\n- 支持 front\/edge proxy\n- 高级负载均衡\n- 健康检查\n- 服务发现\n- 支持 DynamoDB L7\n\nEnvoy 本身无法构成一个完整的 Service Mesh，但是它可以作为 service mesh 中的应用间流量的代理，负责 service mesh 中的数据层。\n\n更多信息请参考 [Envoy 官网](https:\/\/www.envoyproxy.io\/)。\n\n## Envoy 作为前端代理\n\n本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。\n\n## 快速开始\n\nEnvoy 中的所有规则配置跟 Kubernetes 一样都是通过 YAML 文件来完成的。在继续下面的步骤之前，首先克隆 Envoy 的 GitHub repo。\n\n\u0060\u0060\u0060bash\ngit clone https:\/\/github.com\/envoyproxy\/envoy.git\n\u0060\u0060\u0060\n\n## 运行 sandbox 测试\n\nEnvoy 官方提供了以下打包用例：\n\n- Front Proxy\n- [Zipkin Tracing](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/start\/sandboxes\/zipkin_tracing)\n- Jaeger Tracing\n- gRPC Bridge\n\n全部可以使用 \u0060docker-compose\u0060 运行，代码可以在 https:\/\/github.com\/envoyproxy\/envoy\/tree\/master\/examples 找到。\n\n## Front proxy\n\nEnvoy 在 envoymesh 的边缘做反向代理，详细使用方式见 \u003chttps:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/start\/sandboxes\/front_proxy\u003e，在此我将解说下以下问题：\n\n- Envoy 是如何作为进程外架构运行的？\n- 为何说 Envoy 是无侵入式架构？\n- Envoy 作为边缘反向代理能做什么？\n\n本示例的架构图如下所示，此时 Envoy 将作为一个反向代理，类似于 Nginx，但与 Nginx 不同的是它还会作为一个进程，伴随每个服务一起运行在同一个容器中（在 Kubernetes 中可以作为 Sidecar 与应用容器一起运行在同一个 Pod 中）。\n\n![Front proxy 部署结构图](envoyproxy-docker-compose.png)\n\n在此示例中一共有 3 个服务，我们需要为其创建容器编排的 \u0060docker-compose.yml\u0060 文件。\n\n\u0060\u0060\u0060yaml\nversion: \u00272\u0027\nservices:\n\n  front-envoy:\n    build:\n      context: .\n      dockerfile: Dockerfile-frontenvoy\n    volumes:\n      - .\/front-envoy.yaml:\/etc\/front-envoy.yaml\n    networks:\n      - envoymesh\n    expose:\n      - \u002280\u0022\n      - \u00228001\u0022\n    ports:\n      - \u00228000:80\u0022\n      - \u00228001:8001\u0022\n\n  service1:\n    build:\n      context: .\n      dockerfile: Dockerfile-service\n    volumes:\n      - .\/service-envoy.yaml:\/etc\/service-envoy.yaml\n    networks:\n      envoymesh:\n        aliases:\n          - service1\n    environment:\n      - SERVICE_NAME=1\n    expose:\n      - \u002280\u0022\n\n  service2:\n    build:\n      context: .\n      dockerfile: Dockerfile-service\n    volumes:\n      - .\/service-envoy.yaml:\/etc\/service-envoy.yaml\n    networks:\n      envoymesh:\n        aliases:\n          - service2\n    environment:\n      - SERVICE_NAME=2\n    expose:\n      - \u002280\u0022\n\nnetworks:\n  envoymesh: {}\n\u0060\u0060\u0060\n\n使用 docker-compose 启动可以保证三个服务都在同一个网络内，即 \u0060frontproxy_envoymesh\u0060 网络中。\n\n其中 \u0060front-envoy\u0060 是前端（边缘）Envoy 服务，用来做反向代理，它使用的是 \u0060Dockerfile-frontenvoy\u0060 文件来构建镜像的，我们来看下该 \u0060Dockerfile\u0060 的内容。\n\n\u0060\u0060\u0060dockerfile\nFROM envoyproxy\/envoy:latest\n\nRUN apt-get update \u0026\u0026 apt-get -q install -y \\\n    curl\nCMD \/usr\/local\/bin\/envoy -c \/etc\/front-envoy.yaml --service-cluster front-proxy\n\u0060\u0060\u0060\n\n其中 \u0060\/etc\/front-envoy.yaml\u0060 是本地的 \u0060front-envoy.yaml\u0060 挂载进去的。我们看下该文件的内容。\n\n\u0060\u0060\u0060yaml\nstatic_resources:\n  listeners:\n  - address:\n      socket_address:\n        address: 0.0.0.0\n        port_value: 80\n    filter_chains:\n    - filters:\n      - name: envoy.http_connection_manager\n        config:\n          codec_type: auto\n          stat_prefix: ingress_http\n          route_config:\n            name: local_route\n            virtual_hosts:\n            - name: backend\n              domains:\n              - \u0022*\u0022\n              routes:\n              - match:\n                  prefix: \u0022\/service\/1\u0022\n                route:\n                  cluster: service1\n              - match:\n                  prefix: \u0022\/service\/2\u0022\n                route:\n                  cluster: service2\n          http_filters:\n          - name: envoy.router\n            config: {}\n  clusters:\n  - name: service1\n    connect_timeout: 0.25s\n    type: strict_dns\n    lb_policy: round_robin\n    http2_protocol_options: {}\n    hosts:\n    - socket_address:\n        address: service1\n        port_value: 80\n  - name: service2\n    connect_timeout: 0.25s\n    type: strict_dns\n    lb_policy: round_robin\n    http2_protocol_options: {}\n    hosts:\n    - socket_address:\n        address: service2\n        port_value: 80\nadmin:\n  access_log_path: \u0022\/dev\/null\u0022\n  address:\n    socket_address:\n      address: 0.0.0.0\n      port_value: 8001\n\u0060\u0060\u0060\n\n我们看到其中包括了三大配置项：\n\n- **static_resources**：路由配置信息\n- **cluster**：envoymesh 的服务注册信息\n- **admin**：管理接口，可以通过访问 8001 端口的，访问 \u0060\/stats\u0060  获取当前 envoymesh 的一些统计信息，访问 \u0060\/server_info\u0060 获取 Envoy 的版本信息\n\n使用 \u0060docker-compose\u0060 启动三个容器。\n\n\u0060\u0060\u0060bash\n$ pwd\nenvoy\/examples\/front-proxy\n$ docker-compose up --build -d\n$ docker-compose ps\n        Name                       Command               State      Ports\n-------------------------------------------------------------------------------------------------------------\nexample_service1_1      \/bin\/sh -c \/usr\/local\/bin\/ ... Up       80\/tcp\nexample_service2_1      \/bin\/sh -c \/usr\/local\/bin\/ ... Up       80\/tcp\nexample_front-envoy_1   \/bin\/sh -c \/usr\/local\/bin\/ ... Up       0.0.0.0:8000-\u003e80\/tcp, 0.0.0.0:8001-\u003e8001\/tcp\n\u0060\u0060\u0060\n\n我们下面将过一遍 Envoy 作为前端代理的所有功能，这些功能是通用功能。\n\n### 路由\n\n访问 service1 \u003chttp:\/\/localhost:8000\/service\/1\u003e 将看到如下输出。\n\n\u0060\u0060\u0060bash\n$ curl -v localhost:8000\/service\/1\n* \nTrying ::1...\n* TCP_NODELAY set\n* Connected to localhost (::1) port 8000 (#0)\n\u003e GET \/service\/1 HTTP\/1.1\n\u003e Host: localhost:8000\n\u003e User-Agent: curl\/7.54.0\n\u003e Accept: *\/*\n\u003e\n\u003c HTTP\/1.1 200 OK\n\u003c content-type: text\/html; charset=utf-8\n\u003c content-length: 89\n\u003c server: envoy\n\u003c date: Fri, 20 Apr 2018 08:26:33 GMT\n\u003c x-envoy-upstream-service-time: 14\n\u003c\nHello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4\n* Connection #0 to host localhost left intact\n\u0060\u0060\u0060\n\n访问 service2 \u003chttp:\/\/localhost:8000\/service\/2\u003e 将看到如下输出。\n\n\u0060\u0060\u0060bash\n*   Trying ::1...\n* TCP_NODELAY set\n* Connected to localhost (::1) port 8000 (#0)\n\u003e GET \/service\/2 HTTP\/1.1\n\u003e Host: localhost:8000\n\u003e User-Agent: curl\/7.54.0\n\u003e Accept: *\/*\n\u003e\n\u003c HTTP\/1.1 200 OK\n\u003c content-type: text\/html; charset=utf-8\n\u003c content-length: 89\n\u003c server: envoy\n\u003c date: Fri, 20 Apr 2018 08:27:27 GMT\n\u003c x-envoy-upstream-service-time: 10\n\u003c\nHello from behind Envoy (service 2)! hostname: f6650e1911a0 resolvedhostname: 172.18.0.3\n* Connection #0 to host localhost left intact\n\u0060\u0060\u0060\n\n我们看到访问请求被路由到了正确的服务后端。\n\n### 负载均衡\n\n增加 service1 的示例数。\n\n\u0060\u0060\u0060bash\n$ docker-compose scale service1=3\nWARNING: The scale command is deprecated. Use the up command with the --scale flag instead.\nStarting frontproxy_service1_1 ... done\nCreating frontproxy_service1_2 ... done\nCreating frontproxy_service1_3 ... done\n\n$ docker-compose ps\n          Name                        Command               State                            Ports\n---------------------------------------------------------------------------------------------------------------------------\nfrontproxy_front-envoy_1   \/usr\/bin\/dumb-init -- \/bin ...   Up      10000\/tcp, 0.0.0.0:8000-\u003e80\/tcp, 0.0.0.0:8001-\u003e8001\/tcp\nfrontproxy_service1_1      \/bin\/sh -c \/usr\/local\/bin\/ ...   Up      10000\/tcp, 80\/tcp\nfrontproxy_service1_2      \/bin\/sh -c \/usr\/local\/bin\/ ...   Up      10000\/tcp, 80\/tcp\nfrontproxy_service1_3      \/bin\/sh -c \/usr\/local\/bin\/ ...   Up      10000\/tcp, 80\/tcp\nfrontproxy_service2_1      \/bin\/sh -c \/usr\/local\/bin\/ ...   Up      10000\/tcp, 80\/tcp\n\u0060\u0060\u0060\n\n我们看到现在 service1 已经有了 3 个实例，现在再访问 service1 \u003chttp:\/\/localhost:8000\/service\/1\u003e。\n\n\u0060\u0060\u0060bash\n$ while true;do curl localhost:8000\/service\/1;sleep 1;done\nHello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4\nHello from behind Envoy (service 1)! hostname: fe44dba64122 resolvedhostname: 172.18.0.5\nHello from behind Envoy (service 1)! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6\nHello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4\nHello from behind Envoy (service 1)! hostname: fe44dba64122 resolvedhostname: 172.18.0.5\nHello from behind Envoy (service 1)! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6\n\u0060\u0060\u0060\n\n我们看到对 service1 的已经有负载均衡了，使用的策略是 \u0060round_robin\u0060，这些都是在 \u0060front-envoy.yaml\u0060 文件中的 \u0060cluster\u0060 项下配置的。\n\n### admin 端点\n\n访问 \u003chttp:\/\/localhost:8001\u003e 可以看到 Envoy admin 提供以下管理 API 端点。\n\n| 命令                 | 描述                                     |\n| -------------------- | ---------------------------------------- |\n| \/                    | Admin 主页                               |\n| \/certs               | 打印机器上的 certs                       |\n| \/clusters            | upstream cluster 状态                    |\n| \/config_dump         | 输出当前的 Envoy 配置                    |\n| \/cpuprofiler         | 开启\/关闭 CPU profiler                   |\n| \/healthcheck\/fail    | 导致服务失败健康检查                     |\n| \/healthcheck\/ok      | 导致服务通过健康检查                     |\n| \/help                | 打印管理命令的帮助信息                   |\n| \/hot_restart_version | 打印热重启兼容版本                       |\n| \/listeners           | 打印 listener 地址                       |\n| \/logging             | 查询\/更改日志级别                        |\n| \/quitquitquit        | 退出服务                                 |\n| \/reset_counters      | 将计数器重置为 1                         |\n| \/runtime             | 打印运行时值                             |\n| \/runtime_modify      | 修改运行时值                             |\n| \/server_info         | 打印服务器版本\/状态信息                  |\n| \/stats               | 打印服务器状态统计信息                   |\n| \/stats\/prometheus    | 打印 prometheus 格式的服务器状态统计信息 |\n\nEnvoy 提供了 API 管理端点，可以对 Envoy 进行动态配置，参考 v2 API reference。\n\n## 参考\n\n- Front proxy\n', '\/blog\/envoy-as-front-proxy\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/tags/envoy/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/tags/envoy/page/2/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/tags/envoy/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/tags/envoy/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item page-item active ">
           <a href="/tags/envoy/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
     
     
     
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(68)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(38)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(23)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(20)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(15)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(13)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(13)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
      
        <a href="/categories/%e5%ae%b9%e5%99%a8" class="sidebar-item">
            <span>容器</span>
            <span>(4)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(4)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">保障 Istio 安全：解决关键安全漏洞及最佳实践</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/ulanqab-trip/">乌兰察布之旅：探索火山与失落的村庄</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/explore-tetrate-enterprise-gateway/">介绍 Tetrate Enterprise Gateway 及与 Istio 集成：云原生应用的全面网关解决方案</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024 圆桌论坛预告：Istio 和现代 API 网关——引领服务网格的未来</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 大连云原生技术开放日</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
