<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Jimmy Song - 专注于探索后 Kubernetes 时代的云原生新范式 – SPIRE</title>
    <link>https://jimmysong.io/tags/spire/</link>
    <description>Recent content in SPIRE on Jimmy Song - 专注于探索后 Kubernetes 时代的云原生新范式</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    <copyright>&amp;copy; 2017-2022 Jimmy Song 保留所有权利</copyright>
    <lastBuildDate>Tue, 21 Jun 2022 19:27:49 +0800</lastBuildDate>
    
	  <atom:link href="https://jimmysong.io/tags/spire/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>为什么 Istio 要使用 SPIRE 做身份认证？</title>
      <link>https://jimmysong.io/blog/why-istio-need-spire/</link>
      <pubDate>Tue, 21 Jun 2022 19:27:49 +0800</pubDate>
      
      <guid>https://jimmysong.io/blog/why-istio-need-spire/</guid>
      <description>
        
        
        &lt;p&gt;今年 6 月初，&lt;a href=&#34;https://istio.io/latest/news/releases/1.14.x/announcing-1.14/&#34; title=&#34;Istio 1.14 发布&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Istio 1.14 发布&lt;/a&gt;
，该版本中最值得关注的特性是新增对 SPIRE 的支持。&lt;a href=&#34;https://spiffe.io&#34; title=&#34;SPIFFE&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SPIFFE&lt;/a&gt;
 和 SPIRE 都是 CNCF 孵化项目，其中 SPIRE 是 SPIFFE 的实现之一。本文将带你了解 SPIRE 对于零信任架构的意义，以及 Istio 是为何使用 SPIRE 实现身份认证。&lt;/p&gt;
&lt;h2 id=&#34;kubernetes-中的身份认证&#34;&gt;Kubernetes 中的身份认证&lt;/h2&gt;
&lt;p&gt;我们都知道 Istio 最初是基于 Kubernetes 建立起来的，在谈在 Istio 中使用 SPIRE 做身份认证之前，我们先来看下 Kubernetes 中如何做身份认证。&lt;/p&gt;
&lt;p&gt;我们来看一个 pod 的 token 的例子，下面是 default 命名空间下 sleep pod 的 Service Account 的 token。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;apiVersion: v1
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;data:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  ca.crt: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;CA_CRT&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  namespace: &lt;span class=&#34;nv&#34;&gt;ZGVmYXVsdA&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  token: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;TOKEN_STRING&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kind: Secret
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;metadata:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  annotations:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    kubernetes.io/service-account.name: sleep
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    kubernetes.io/service-account.uid: 2c0d00e8-13a2-48d0-9ff8-f987f3325ecf
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  creationTimestamp: &lt;span class=&#34;s2&#34;&gt;&amp;#34;2022-06-14T03:01:35Z&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  name: sleep-token-gwhwd
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  namespace: default
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  resourceVersion: &lt;span class=&#34;s2&#34;&gt;&amp;#34;244535398&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  uid: b8822ceb-9553-4a17-96dc-d525bbaed0e0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;type: kubernetes.io/service-account-token
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们看到其中有 &lt;code&gt;ca.crt&lt;/code&gt; 和 &lt;code&gt;token&lt;/code&gt; 字段，如果这个 token 被窃取，会有什么后果？Kubernetes 中使用 Service Account 来管理 Pod 的身份，然后利用 RBAC 指定具有某 Service Account 的 Pod 对 Kubernetes  API 的权限。Service Account 的 token 存储在 Secret 中，token 中并不包含工作负载所运行的节点、pod 的声明，一旦 token 被窃取破坏者就获得了该账户的所有权限，伪装成该用户窃取信息或破坏。&lt;/p&gt;
&lt;p&gt;一个 token 只能在一个集群中标记负载身份，Istio 同时支持 Kubernetes 环境和虚拟机，还有多集群多网格，如何统一这些异构环境中的工作负载身份？这时，一个统一的工作负载身份标准就呼之欲出了。&lt;/p&gt;
&lt;h2 id=&#34;spiffe-与-spire-简介&#34;&gt;SPIFFE 与 SPIRE 简介&lt;/h2&gt;
&lt;p&gt;SPIFFE 的目的是基于零信任的理念，建立一个开放、统一的工作负载身份标准，这有助于建立一个零信任的全面身份化的数据中心网络。SPIFFE 的核心是通过简单 API 定义了一个短期的加密身份文件 SVID，用作工作负载认证时使用的身份文件，例如建立 TLS 连接或签署和验证 JWT 令牌等。SPIRE 可以根据管理员定义的策略自动轮换 X.509 SVID 证书和秘钥。Istio 可以通过 SPIRE 动态的消费工作负载标识，SPIRE 可以动态的提供工作负载标识。&lt;/p&gt;
&lt;p&gt;下面我将为你简单介绍一下与 SPIFFE 相关的一些术语。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;SPIFFE&lt;/strong&gt;（Secure Production Identity Framework For Everyone）是一套身份认证标准。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SPIRE&lt;/strong&gt;（SPIFFE Runtime Environment） 是 SPIFFE 标准的一套生产就绪实现。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SVID&lt;/strong&gt;（SPIFFE Verifiable Identity Document）是工作负载向资源或调用者证明其身份的文件。SVID 包含一个 SPIFFE ID，代表了服务的身份。它将 SPIFFE ID 编码在一个可加密验证的文件中，目前支持两种格式：X.509 证书或 JWT 令牌。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SPIFFE ID&lt;/strong&gt; 是一个统一资源标识符（URI），其格式如下：&lt;code&gt;spiffe://trust_domain/workload_identifier&lt;/code&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;SPIRE 包含 Server 和 Agent 两个部分，它们的作用如下。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;SPIRE Server&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;身份映射&lt;/li&gt;
&lt;li&gt;节点认证&lt;/li&gt;
&lt;li&gt;SVID 颁发&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;SPIRE Agent&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;工作负载认证&lt;/li&gt;
&lt;li&gt;提供工作负载 API&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;spiffe-与零信任安全&#34;&gt;SPIFFE 与零信任安全&lt;/h2&gt;
&lt;p&gt;零信任的本质是以身份为中心的动态访问控制。动态证书轮换、动态证书下发、动态权限控制。SPIFFE 解决的是标识工作负载的问题。&lt;/p&gt;
&lt;p&gt;在虚拟机时代我们可能根据一个 IP 地址和端口来标识一个工作负载，基于 IP 地址标识存在多个服务共享一个 IP 地址，IP 地址伪造和访问控制列表过大等问题。到了 Kubernetes 时代，容器的生命周期是短暂的，我们无法再用 IP 地址来标识负载，而是通过 pod 或 service 名称。但是，不同的云、软件平台对工作负载标识的方法不同，相互之间存在兼容性问题。尤其是在异构混合云的中，同时存在虚拟机和容器的工作负载。这时，建立一个细粒度、具有互操作性的标识系统，将具有重要意义。&lt;/p&gt;
&lt;h2 id=&#34;在-istio-中使用-spire-做身份认证&#34;&gt;在 Istio 中使用 SPIRE 做身份认证&lt;/h2&gt;
&lt;p&gt;Istio 会利用 SPIRE 为每个工作负载提供一个唯一标识，服务网格中的工作负载在进行对等身份认证、请求身份认证和授权策略都会使用到服务标识，用于验证访问是否被允许。SPIRE 原生支持 Envoy SDS API，SPIRE Agent 中的通过与工作负载中共享的 UNIX Domain Socket 通信，为工作负载颁发 SVID。请参考 &lt;a href=&#34;https://istio.io/latest/docs/ops/integrations/spire&#34; title=&#34;Istio 文档&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Istio 文档&lt;/a&gt;
了解如何在 Istio 中使用 SPIRE 做身份认证。&lt;/p&gt;
&lt;p&gt;SDS 最重要的好处就是简化了证书管理。如果没有这个特性，在 Kubernetes deployment 中，证书就必须以 secret 的方式被创建，然后挂载进代理容器。如果证书过期了，就需要更新 secret 且代理容器需要被重新部署。如果使用 SDS，Istio 可以使用 SDS 服务器会将证书推送给所有的 Envoy 实例。如果证书过期了，服务器仅需要将新证书推送至 Envoy 实例，Envoy 将会立即使用新证书且不需要重新部署代理容器。&lt;/p&gt;
&lt;p&gt;下图展示了 Istio 中使用 SPIRE 进行身份认证的架构。&lt;/p&gt;
&lt;p&gt;
  &lt;figure&gt;
  &lt;img src=&#34;spire-istio-arch.jpg&#34; alt=&#34;Istio 中使用 SPIRE 进行身份认证的架构图&#34;&gt;
  
  &lt;figcaption class=&#34;text-center&#34;&gt;Istio 中使用 SPIRE 进行身份认证的架构图&lt;/figcaption&gt;
  
  &lt;/figure&gt;

&lt;/p&gt;
&lt;p&gt;在 Kubernetes 集群中的 &lt;code&gt;spire&lt;/code&gt; 命名空间中使用 StatefulSet 部署 SPIRE Server 和 Kubernetes Workload Registrar，使用 DaemonSet 资源为每个节点部署一个 SPIRE Agent。假设你在安装 Kubernetes 时使用的是默认的 DNS 名称 &lt;code&gt;cluster.local&lt;/code&gt;，&lt;a href=&#34;https://github.com/spiffe/spire/blob/main/support/k8s/k8s-workload-registrar/README.md&#34; title=&#34;Kubernetes Workload Registar&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Kubernetes Workload Registar&lt;/a&gt;
 会为 Istio Mesh 中的工作负载创建如下格式的身份：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SPRRE Server：&lt;code&gt;spiffe://cluster.local/ns/spire/sa/server&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;SPIRE Agent：&lt;code&gt;spiffe://cluster.local/ns/spire/sa/spire-agent&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Kubernetes Node：&lt;code&gt;spiffe://cluster.local/k8s-workload-registrar/demo-cluster/node/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Kubernetes Worload Pod：&lt;code&gt;spiffe://cluster.local/{namespace}/spire/sa/{service_acount}&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这样不论是节点还是每个工作负载都有它们全局唯一的身份，而且还可以根据集群 （信任域）扩展。&lt;/p&gt;
&lt;p&gt;Istio Mesh 中的工作负载身份验证过程如下图所示。&lt;/p&gt;
&lt;figure class=&#34;mx-auto text-center&#34;&gt;&lt;img src=&#34;istio-workload-attestor.jpg&#34; loading=&#34;lazy&#34; decoding=&#34;async&#34;
         alt=&#34;图片&#34; width=&#34;30%&#34;/&gt;&lt;figcaption&gt;
            Istio 服务网格中的工作负载身份认证过程示意图
        &lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;详细过程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;工作负载的 sidecar 中的 &lt;code&gt;pilot-agent&lt;/code&gt; 会通过共享的 UDS 调用 SPIRE Agent 来获取 SIVD&lt;/li&gt;
&lt;li&gt;SPIRE Agent 询问 Kubernetes（准确的说是节点上的 kubelet）获取负载的信息&lt;/li&gt;
&lt;li&gt;Kubelet 将从 API server 查询到的信息返回给工作负载验证器&lt;/li&gt;
&lt;li&gt;验证器将 kubelet 返回的结果与 sidecar 共享的身份信息比对，如果相同，则将正确的 SVID 缓存返回给工作负载&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;关于工作负载的注册和认证的详细过程请参考 &lt;a href=&#34;https://lib.jimmysong.io/kubernetes-handbook/concepts/spire/&#34; title=&#34;SPIRE 文档&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SPIRE 文档&lt;/a&gt;
。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结&lt;/h2&gt;
&lt;p&gt;身份是零信任网络的基础，SPIFFE 统一了异构环境下的身份标准。在 Istio 中不论我们是否使用 SPIRE，身份验证对于工作负载来说是不会有任何感知的。通过 SPIRE 来为工作负载提供身份验证，可以有效的管理工作负载的身份，为实现零信任网络打好基础。&lt;/p&gt;

      </description>
    </item>
    
  </channel>
</rss>
