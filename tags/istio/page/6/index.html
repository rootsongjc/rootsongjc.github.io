<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Istio - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="宋净超的博客">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/tags/istio/" />
  <meta property="og:title" content="Istio | Jimmy Song" />
  <meta property="twitter:title" content="Istio | Jimmy Song" />

  
  <meta property="og:description" content="宋净超的博客" />
  <meta property="twitter:description" content="宋净超的博客" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/tags/istio/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Istio
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/understanding-istio-and-open-policy-agent-opa/">[译] Istio 中的外部授权过滤器：使用 OPA 实现灵活的授权策略</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/03/28</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/understanding-istio-and-open-policy-agent-opa/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 中的外部授权过滤器：使用 OPA 实现灵活的授权策略', '本文介绍了如何将服务网格和开放策略代理（OPA）结合使用，以实现基于身份的分割的五个策略检查。服务网格为前四项检查提供了执行点，而 OPA 则在第五项中发挥作用。本文还探讨了如何将特定于业务的策略应用于请求，以及如何使用 OIDC 或专用授权基础设施来实现最终用户对资源的授权。', '\n客户向我们询问服务网格实践中关于开放策略代理 (OPA) 和服务网格如何结合使用的问题。我们探讨了关于服务网格和 OPA 策略的最佳实践，以及它们如何相互补充的想法。为了构建讨论框架，我们使用了 NIST 的零信任架构标准。在即将发布的 NIST 标准文档特别出版物 800-207A 中，基于身份的分段是一个主要概念。最低标准包括五项策略检查，应应用于进入的每个请求系统和每个后续跃点。您可以观看我们在今年的 CloudNativeSecurityCon 上与来自 NIST 的 Ramaswami Chandramouli 进行的深入讨论的[演示](https:\/\/www.youtube.com\/watch?v=s2lIaFhkA8c)。\n\n**使用服务网格实现基于身份的分割的五个策略检查：**\n\n1. 传输中加密\n2. 服务身份和认证\n3. 服务到服务授权\n4. 最终用户身份和身份验证\n5. 最终用户对资源的授权\n\n简而言之，服务网格是一个专用的基础设施层，专门用于为前四项检查实施策略，并在第五项中发挥一定作用。OPA 的亮点在于第五点：最终用户对资源的授权。\n\nIstio 的 sidecar 代理充当微服务应用程序的安全内核。Envoy 数据平面是一个通用的策略执行点 (PEP)，可以拦截所有流量并可以在应用层应用策略。就此而言，它是一个参考监视器 ( [NIST SP 800-204B](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204b\/final) )。将 Envoy 作为 PEP，我们可以将安全问题从应用程序转移到网格中。\n\n策略**检查 1-2：传输中的加密和服务身份与认证**。为了满足前两个策略检查、传输中的加密以及服务身份和身份验证，网格为系统中的所有通信实施 mTLS。\n\n**策略检查 3：服务到服务授权。** 服务网格还提供策略三，即服务到服务的授权。OPA 可以在这里开始发挥作用，但由于 OPA 是通用的，它没有围绕服务通信的 DSL，因此您必须自己创建它。另一方面，我们认为策略往往更自然，更容易用专为它构建的语言来表达。服务网格 —— 更重要的是，我们在 Istio 之上构建的应用程序连接和安全平台 [Tetrate Service Bridge](https:\/\/tetrate.io\/tetrate-service-bridge\/)—— 具有对编写服务到服务策略有意义的名词。\n\n**策略检查 4：最终用户身份和身份验证。** 对于第四个策略检查，我们需要在系统的每一跳验证最终用户身份。服务网格提供执行点来进行检查，但有关用户身份验证的实际决定既不在服务网格领域也不在 OPA 范围内。相反，我们需要委托给受信任的身份提供者来在此处做出判决。\n\n**策略检查 5：最终用户对资源的授权。** 零信任云原生访问控制的第五个策略检查是 OPA 可以发挥重要作用的地方。服务网格没有最终用户和资源之间关系的模型，因此不适合编写有关它的策略。NIST 的指南是通过 OIDC 与现有系统集成或利用专用授权基础设施 —— 例如，NIST 的下一代访问控制 (NGAC) 和 Open Policy Agent。\n\n例如，以媒体流服务及其播放列表为例。我们可能需要授权最终用户访问数百万到数十亿个播放列表。就像 OPA 不是特别适合服务到服务的授权一样，Istio 授权策略也不适合最终用户到资源的授权；但是，OPA 适合。\n\nOPA 也非常适合超越 NIST ZTA 策略框架的步骤：**将特定于业务的策略应用于请求。** 在我们完成零信任的五项策略检查之后，我们可以委托 OPA 作为规则引擎来执行业务策略。\n\n在接下来的几个月里，我们将对此发表更多看法，尤其是在 SP 800-207A 进入起草过程时。但是，与此同时，我们在 Cloud Native Security Con 上的谈话录音对这些问题进行了更深入的讨论：\n\n- [ZTA 基于身份的分割 ——Zack Butcher、Tetrate 和 Ramaswamy Chandramouli，NIST](https:\/\/www.youtube.com\/watch?v=s2lIaFhkA8c)\n- [赞助主题演讲：从 Google 到 NIST — 云原生安全的未来 — Zack Butcher，Tetrate](https:\/\/www.youtube.com\/watch?v=YdcVALVwwY4)\n', '\/trans\/understanding-istio-and-open-policy-agent-opa\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了如何将服务网格和开放策略代理（OPA）结合使用，以实现基于身份的分割的五个策略检查。服务网格为前四项检查提供了执行点，而 OPA 则在第五项中发挥作用。本文还探讨了如何将特定于业务的策略应用于请求，以及如何使用 OIDC 或专用授权基础设施来实现最终用户对资源的授权。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">使用 Geneve 隧道实现 Istio Ambient Mesh 的流量拦截</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/03/24</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 Geneve 隧道实现 Istio Ambient Mesh 的流量拦截', '本文介绍了什么是 Geneve 隧道，与 VXLAN 的区别，以及它在 Istio Ambient Mesh 中的应用，最后谈及使用 eBPF 优化流量拦截。', '\n在我[之前的博客](\/blog\/ambient-mesh-l4-traffic-path\/)分享中提到 Istio Ambient Mesh 使用 iptables 和 Geneve 隧道将应用程序 Pod 中的流量拦截到 Ztunnel 中。很多读者可能还不了解这种隧道协议，本文将为你介绍 Geneve 隧道的定义，报文结构，以及与 VXLAN 协议的比较有哪些优势。最后，本文将介绍 Istio Ambient Mesh 如何应用 Geneve 隧道来实现流量拦截，以及 Istio 1.18 中新推出的 eBPF 模式。\n\n## Geneve 隧道简介\n\nGENEVE（Generic Network Virtualization Encapsulation）是一种网络虚拟化封装（隧道）协议，它的设计的初衷是为了解决当前数据传输缺乏灵活性和安全性的问题。Geneve 只定义了一种数据封装格式，不包括控制平面的信息。GENEVE 相较于 VXLAN 封装的关键优势在于其通过添加 TLV 格式的选项来扩展可封装的协议类型。\n\n## Geneve vs VXLAN\n\nVXLAN 和 Geneve 都是网络虚拟化协议，它们之间有很多共同点。虚拟化协议是一种将虚拟网络与物理网络分离的技术，它允许网络管理员在虚拟环境中创建多个虚拟网络，每个虚拟网络都可以拥有自己的 VLAN 标识符、IP 地址和路由。此外，VXLAN 和 Geneve 协议都使用 UDP 封装，这使得它们能够通过现有网络基础设施进行扩展。VXLAN 和 Geneve 协议还具有灵活性，它们可以在不同的网络拓扑结构中使用，并且可以与不同的虚拟化平台兼容。\n\n图 1 展示了 VXLAN 与 Geneve 协议的报文结构及其各自的 Header 区别。\n\n![图 1：VXLAN 与 Geneve 报文格式示意图](vxlan-vs-geneve.svg)\n\n从图中我们可以看到，VXLAN 与 Geneve 隧道报文的结构类似，其主要区别在于使用不同的 UDP 端口号和协议头 ——VXLAN 使用 4789 端口，Geneve 使用 6081 端口；Geneve 协议头比 VXLAN 更具扩展性。\n\nGeneve 隧道协议比 VXLAN 更加可扩展是因为 Geneve 隧道协议中增加了变长选项，它可以包含零或多个 TLV 格式的选项数据。TLV 是指类型 - 长度 - 值（Type-Length-Value）格式，用于传输和解析网络包的元数据信息。在 Geneve 协议中，每个元数据信息都由一个 TLV 格式的字段组成，以便于灵活地添加、删除和修改这些元数据。\n\n具体来说，TLV 格式的字段包括：\n\n- Type：8 位的类型字段。\n- Length：5 位的选项长度字段，以 4 字节倍数表示，不包括选项头。\n- Data：可变长的选项数据字段，可以不存在或者为 4 到 128 字节之间。\n\n通过使用 TLV 格式，Geneve 协议可以轻松地扩展和修改元数据信息，同时保持兼容性和灵活性。\n\n关于 VXLAN 隧道报文的详细信息请参考 [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) 。\n\n关于 Geneve 隧道报文的详细信息请参考 [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i) 。\n\n### 工作原理\n\nGeneve 隧道主要应用在云计算和虚拟机化场景，它可以将数据包封装在一个新的数据包中，以便在虚拟网络中传输。Geneve 隧道使用一个 24 位的虚拟网络标识符 (VNI)，将数据包从一个物理网络传输到另一个物理网络。Geneve 隧道还可以使用安全性协议，如 IPsec、TL，来保护数据包的传输。\n\n当数据包到达目的主机时，Geneve 隧道协议会将数据包从 Geneve 协议头中解封装出来，并将其传递给虚拟网络中的目的地。在解封装过程中，Geneve 协议头中的 VNI 信息会被来判断数据包的目的地，以确保数据包被正确地路由到虚拟网络中的目的地。\n\n假设有一个虚拟网络，其 VNI 为 1001。当数据包从一个物理网络传输到另一个物理网络时，可以使用隧道将数据包从一个物理网络传输到另一个物理网络。在这种情况下，隧道将源物理网络和目标物理网络之间的虚拟网络标识符 (VNI) 设置为 1001，以便在传输期间跟踪数据包。当数据包到达目标物理网络时，隧道将 VNI 从数据包中删除，并将数据包传递给目标物理网络。\n\n### 安全性\n\nGeneve 隧道协议本身并没有提供任何安全机制，因此在 Geneve 隧道中传输的数据包可能会受到威胁，例如数据包被篡改、截获、重放等。\n\n为了保障 Geneve 隧道中传输的数据包的安全性，可以使用一些安全协议。以下是一些常见的安全协议：\n\n1. IPsec（Internet Protocol Security）：IPsec 是一种网络层安全协议，可以对 Geneve 隧道中的数据包进行加密、认证和完整性保护。使用 IPsec 可以提供端到端的安全性。\n2. TLS（Transport Layer Security）：TLS 是一种基于传输层的加密协议，可以对 Geneve 隧道中的数据包进行加密和认证。使用 TLS 可以提供端到端的安全性。\n3. MACSec（Media Access Control Security）：MACSec 是一种数据链路层的安全协议，可以对 Geneve 隧道中的数据包进行加密和认证。使用 MACSec 可以提供链路层的安全性。\n\n需要注意的是，以上安全协议都需要进行相应的配置和部署，且可能会对性能产生一定的影响。在选择合适的安全协议时，需要考虑安全性、性能、可管理性等方面的因素。\n\n### 为什么选择 Geneve？\n\n下表对比了 VXLAN 与 Geneve 在多个方面的特点。\n\n| 特性 | VXLAN | Geneve |\n| --- | --- | --- |\n| 头部格式 | 固定格式 | 可扩展格式 |\n| 可扩展性 | 更多地专注于 L2 扩展 | 更好地支持新兴网络服务 |\n| 可操作性 | 较难管理和扩展 | 更容易管理和扩展 |\n| 性能 | 头部较短，性能较高 | 头部较长，性能略低 |\n\n使用 Geneve 协议的主要原因是将目前网络虚拟化封装技术（例如 VXLAN、NVGRE 和 STT）中的优点合并到一个协议中。我们通过多年的网络虚拟化开发经验得知，其中一个重要的需求是可扩展性。Geneve 协议使用可扩展的 TLV 结构对元数据进行编码，因此可以独立地发展软件和硬件端点的功能，以满足不断增长的需求。\n\n## Istio Ambient Mesh 如何应用 Geneve 隧道\n\n在[之前的博客](https:\/\/jimmysong.io\/blog\/ambient-mesh-l4-traffic-path\/)中，我讲解了 Istio Ambient Mesh 如何使用 Ztunnel 实现 L4 代理的，图 2 展示使用 iptables 和 Geneve 隧道的 L4 透明流量劫持路径。\n\n![图 2：使用 iptables 和 Geneve 隧道的 L4 透明流量劫持路径示意图](geneve-tunnel.svg)\n\n从图中我们可以看到：\n\n- Istio CNI 在节点上创建 \u0060istioout\u0060 网卡和 iptables 规则，将节点中的出站流量透明劫持到 \u0060pistioout\u0060 虚拟网卡；\n- Istio CNI 在节点上创建 \u0060istioin\u0060 网卡和 iptables 规则，将节点中的入站流量透明劫持到 \u0060pistioin\u0060 虚拟网卡；\n- Istio CNI 在 ztunnel 中创建 \u0060pistioin\u0060 和 \u0060pistioout\u0060 网卡，用于接收 Geneve 隧道中的发来的数据包；\n\n\u0060pistioin\u0060 和 \u0060pistioout\u0060 这两个网卡是由 ztunnel 中的 init 容器或 Istio CNI（见 [\u0060CreateRulesWithinNodeProxyNS\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910) 函数）创建的，其 IP 地址和端口也是固定的。应用容器发出的数据包需要经过 \u0060istioout\u0060 网卡并使用 Geneve 隧道封装后转发给 ztunnel 容器。\n\n## 使用 eBPF 进行透明流量劫持\n\neBPF（extended Berkeley Packet Filter）是一个功能强大的技术，它可以在 Linux 内核中运行安全的用户态程序。eBPF 最初是一种用于过滤网络数据包的技术，但现在已经扩展到其他领域，如跟踪系统调用、性能分析和安全监控等。eBPF 的优势在于其轻量级、高效、安全和可编程性。它可以被用于实时监控、网络安全、应用程序调试和优化、容器网络等多个领域。\n\n在 Istio 1.18 之前，Ambient 模式中使用 iptables 和 Geneve 隧道将应用程序流量透明劫持到 ztunnel 中。在 Istio 1.18 中，增加了 eBPF 选项，你可以选择使用 iptables 或 eBPF 来做流量劫持。如图 3 所示，eBPF 程序直接运行在宿主机内核，将应用程序的流量转发到 ztunnel 中。\n\n![图 3：使用 eBPF 劫持应用程序的流量](ebpf.svg)\n\n图 3：使用 eBPF 劫持应用程序的流量\n\n| 对比项 | eBPF 方式 | 使用 iptables 和 Geneve 隧道 |\n| --- | --- | --- |\n| 效率 | 更高 | 略低 |\n| 兼容性 | 需要较高的 Linux 内核版本 | 更好 |\n| 实现难度 | 较高 | 较低 |\n| 扩展性 | 较好 | 较差 |\n\n根据 [Istio 官方博客](https:\/\/istio.io\/latest\/blog\/2023\/ambient-ebpf-redirection\/)介绍，使用 eBPF 方式避免了部分 iptables 规则和隧道封装，相比使用 iptables 和 Geneve 隧道更加高效。然而，eBPF 对 Linux 内核版本的要求更高（至少 4.20），而 iptables 方式则具有更好的兼容性。此外，eBPF 方式的实现难度较高，但扩展性较好。\n\n要想使用 eBPF 模式运行 Ambient Mesh，只需要在安装 Istio 时设置 \u0060values.cni.ambient.redirectMode\u0060 参数即可，如下：\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## 总结\n\n本文介绍了 Geneve 隧道协议的工作原理、安全性和与 VXLAN 的比较。此外，还介绍了 Istio Ambient Mesh 如何使用 Geneve 隧道实现流量拦截，并讨论了使用 eBPF 进行透明流量劫持的优缺点。Geneve 隧道协议是一种通用的隧道协议，可以在虚拟网络中传输数据包，具有更多的优势，因此在选择隧道协议时，用户可以考虑使用 Geneve 隧道。在 Istio 1.18 中新推出了 Ambient Mesh 的的 eBPF 模式，可以提供网络效率，但对 Linux 内核版本有更高要求，用户可以根据自己的实际情况选用。\n\n## 参考\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n', '\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了什么是 Geneve 隧道，与 VXLAN 的区别，以及它在 Istio Ambient Mesh 中的应用，最后谈及使用 eBPF 优化流量拦截。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/tsb-tips/">关于 TSB 你应该知道的事情</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/02/22</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('关于 TSB 你应该知道的事情', '如果你对服务网格（Service Mesh）和 Tetrate Service Bridge 感兴趣，那么这篇文章可以解答你心中很多疑惑。', '\n本文假设你熟悉服务网格和 Istio，对 Tetrate 出品的商业化服务网格管理工具 Tetrate Service Bridge 感兴趣，那么这篇文章可以解答你心中的一些困惑。\n\n本文中包含了：\n\n- 关于 TSB 的一些 FAQ\n- TSB 的一些基本资源对象\n- TSB 实现的一些细节\n\n## TSB FAQ\n\n笔者将罗列一些关于 TSB 的知识点，主要是关于它与 Istio 之间的不同点：\n\n1. TSB 全称 Tetrate Service Bridge，是 Tetrate 公司的旗舰产品，首发于 2018 年，目前版本是 1.7，这是一款商业化产品，你需要购买才能使用，如果想要了解更多或请求试用请在[这里](https:\/\/tetrate.io\/tetrate-service-bridge\/)登记；\n2. TSB 可以私有化部署也可以在 GKE、AWS、Azure、OpenShift、EKS Anywhere 等平台中单独或跨平台部署；\n3. TSB 并不是对 Istio 的改进版，它是在 Istio 之上建立的管理平面，它可以与 Istio 完全兼容，并适配最新版的 Istio；\n4. TSB 并不是 Kubernetes 管理平台，它不能用于管理 Kubernetes 中的资源；\n5. TSB 是基于 Istio、Envoy 和 Apache SkyWalking 构建；\n6. TSB 通过定义 Tenant、Workspace 等资源对象为 Istio 增加了多租户和多集群管理功能；\n7. 为了实现多集群服务网格的管理，TSB 中定义了一系列 Group 资源，如 Traffic、Security、Gateway 等，这些 CRD 最终将转化为 Istio 中的 CRD 应用到服务网格；\n8. TSB 定义了 Tier1Gateway CRD 实现了跨集群的二层网关；\n9. TSB 部署和管理比较复杂，Tetrate 即将推出轻量级的 Tetrate Service Express（TSE）简化服务网格管理；\n\n## TSB 中的资源对象 {#tsb-resources}\n\n图 1 展示了 TSB 的基本资源对象，其中只要分为五大类：\n\n- 为了实现多租户和多集群管理的资源对象，如 Tenant、Organization、Workspace 等；\n- 主要功能对象配置组，如 Traffic、Security、Gateway 等；\n- Istio 原生 CRD；\n- 角色和权限管理；\n- 其他扩展；\n\n![图 1：Tetrate Service Bridge 中的资源对象](tsb-crd.svg)\n\nTSB 是建立在 Istio 之上的，下表中列出了 TSB 中的可以通过 tctl 命令获取的资源对象，其中部分名称与 Kubernetes 中原生资源对象重复，但它们并不相同：\n\n| **名称**                    | **说明**                                                     |\n| --------------------------- | ------------------------------------------------------------ |\n| ApplicationAccessBindings   | 配置应用程序用户访问权限。                                   |\n| AccessBindings              | 为 TSB 中任何资源的用户分配访问角色的配置。                  |\n| AuthorizationPolicy         | 同 Istio 中的授权策略。                                      |\n| APIAccessBindings           | 配置 API 用户访问权限。                                      |\n| Application                 | 应用程序的配置，应用程序表示一组相互关联的服务逻辑分组，并公开一组实现完整业务逻辑的 API。 |\n| Cluster                     | Kubernetes 集群。要想将 Kubernetes 集群纳入 TSB 管理，首先需要声明 Cluster 添加，然后是部署 TSB Agent 和控制平面（包括 Istio、XCP、GitOps、OAP 等组件）。 |\n| DestinationRule             | Istio 原生 CRD，主要用来划分可路由的集群及负载均衡规则。     |\n| EnvoyFilter                 | Istio 原生 CRD，主要用来扩展 Envoy 的功能。                  |\n| EgressGateway               | 配置工作负载作为出口网关。                                   |\n| GatewayAccessBindings       | 配置网关组用户访问权限。                                     |\n| GatewayGroup                | 网关组。                                                     |\n| Gateway                     | 管理 TSB 中设置的网关，而非 Istio 中的原生 Gateway CRD。     |\n| IstioInternalAccessBindings | 为 Istio 内部组的用户分配访问角色的配置。                    |\n| IngressGateway              | 配置负载作为入口网关，类似于 Istio 中的原生 Gateway。        |\n| IstioInternalGroup          | 配置 Istio 内部的 TSB 资源。                                 |\n| OrganizationAccessBindings  | 配置组织用户访问权限。                                       |\n| Organization                | 组织。                                                       |\n| OrganizationSetting         | 组织的默认配置，如区域 Failover、安全、流量、网络配置等。    |\n| Metric                      | 运行时获取的服务度量。                                       |\n| Source                      | Sources 服务公开了管理来自资源的遥测源。                     |\n| PeerAuthentication          | Istio 原生 CRD，配置对等认证（配置 mTLS）。                  |\n| RequestAuthentication       | Istio 原生 CRD，配置请求认证（JWT 规则配置）。               |\n| ServiceAccount              | 不同于 Kubernetes 中的原生资源对象，TSB 自定义的服务账号配置。 |\n| SecurityAccessBindings      | 配置安全组用户访问权限。                                     |\n| Sidecar                     | 配置预安装的 Istio Sidecar。                                 |\n| ServiceEntry                | Istio 原生 CRD，添加服务对象。                               |\n| SecurityGroup               | 安全配置组。                                                 |\n| ServiceRoute                | 配置服务路由。                                               |\n| SecuritySetting             | 安全设置将配置应用于 SecurityGroup 或 Workspace 中的一组代理工作负载。当应用于 SecurityGroup 时，缺失的字段将从 Workspace 范围设置继承值 (如果有的话)。 |\n| ServiceSecuritySetting      | 安全组配置。                                                 |\n| Service                     | 注册中心中的服务，表示所有这些单独服务的聚合和逻辑视图，并提供聚合指标等高级功能。 |\n| Tier1Gateway                | TSB 一级网关配置，指定网关负载。                             |\n| TrafficAccessBindings       | 流量访问角色配置。                                           |\n| TrafficGroup                | 流量管理组。                                                 |\n| TenantAccessBindings        | 租户角色配置。                                               |\n| TenantSetting               | 租户配置。                                                   |\n| TrafficSetting              | 流量配置。                                                   |\n| VirtualService              | Istio 原生 CRD，配置流量路由。                               |\n| WorkspaceAccessBindings     | Workspace 角色配置。                                         |\n| WasmExtension               | 配置管理 Wasm 扩展。                                         |\n| WasmPlugin                  | Istio 原生 CRD，配置 Wasm 插件。                             |\n| Workspace                   | 划定工作空间。                                               |\n| WorkspaceSetting            | 配置工作空间。                                               |\n\n你可以使用 tctl 命令行工具来管理 TSB，它的使用方法与 kubectl 类似，上面的列表是使用 \u0060tctl get\u0060 命令可以列出的资源对象。实际上 TSB 中的资源对象不止这些，关于 TSB 中 API 资源的详细说明请参考 [TSB 文档](https:\/\/docs.tetrate.io\/service-bridge\/1.6.x\/en-us\/reference)。\n\n## TSB 架构 {#tsb-arch}\n\n我在上文中提到，TSB 是在 Istio 之上构建的管理平面，为 Istio 增加了多租户和多集群管理功能，TSB 的组件架构及其功能如图 2 所示。\n\n![图 2：TSB 组件架构图](tsb-arch.svg)\n\nTSB 的全局控制平面可以和管理平面部署在同一个 Kubernetes 集群中，也可以单独部署。\n\nTSB 管理平面的架构如图 3 所示。\n\n![图 3：TSB 管理平面架构图](tsb-management-plane.svg)\n\n管理平面与各个 Kubernetes 集群中的 Istio 联系，管理多集群环境下的服务网格。\n\nTSB 控制平面的架构如图 4 所示。\n\n![图 4：TSB 控制平面架构](tsb-control-plane.svg)\n\n为了实现跨集群的多租户管理，TSB 定义了一系列逻辑对象，如图 5 所示。\n\n![图 5：TSB 中的多租户管理层级](tsb-resource-hierarchy.svg)\n\n## 更多 {#more}\n\n如果您不熟悉服务网格和 Kubernetes 安全性，我们在 [Tetrate Academy](https:\/\/tetr8.io\/academy) 提供了一系列免费在线课程，可以让您快速了解 Istio 和 Envoy。\n\n如果您正在寻找一种快速将 Istio 投入生产的方法，请查看 [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid)。TID 是 Tetrate 的强化、完全上游的 Istio 发行版，具有经过 FIPS 验证的构建和支持。这是开始使用 Istio 的好方法，因为您知道您有一个值得信赖的发行版，有一个支持您的专家团队，并且如果需要，还可以选择快速获得 FIPS 合规性。\n\n一旦启动并运行 Istio，您可能需要更简单的方法来管理和保护您的服务，而不仅仅是 Istio 中可用的方法，这就是 Tetrate Service Bridge 的用武之地。您可以[在这里](https:\/\/tetr8.io\/tsb)详细了解 Tetrate Service Bridge 如何使服务网格更安全、更易于管理和弹性，或[联系我们进行快速演示](https:\/\/tetr8.io\/contact)。 \n\n## 参考 {#refrence}\n\n- [TSB 简介 - tetrate.io](https:\/\/tetrate.io\/tetrate-service-bridge\/)\n- [TSB 文档 - docs.tetrate.io](https:\/\/docs.tetrate.io\/service-bridge\/)\n- [TSB API 参考 - docs.tetrate.io](https:\/\/docs.tetrate.io\/service-bridge\/1.6.x\/en-us\/reference)\n', '\/blog\/tsb-tips\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">如果你对服务网格（Service Mesh）和 Tetrate Service Bridge 感兴趣，那么这篇文章可以解答你心中很多疑惑。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/ocsp-stapling-for-istio-gateways/">Istio Gateway 中对证书撤销的支持</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/02/06</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Gateway 中对证书撤销的支持', '这篇博客将向你介绍证书撤销的方式和 Istio 的解决方案。', '\n最近 Istio 社区正在处理 [Issue 17763](https:\/\/github.com\/istio\/istio\/issues\/17763)，以增加 Istio 对证书撤销的支持，目前该功能正在开发工程中，见 [PR #42859 - OSCP Stapling](https:\/\/github.com\/istio\/istio\/pull\/42859) 和 [OCSP Stapling for Istio Gateways](https:\/\/docs.google.com\/document\/d\/15wwYyVyOluubL2KIM89b2X8NFwyhMVxq2_I1MESrZdI\/edit#)。这篇博客将向你介绍证书撤销的方式和 Istio 的解决方案进展。\n\nIstio 使用 Envoy SDS 分发证书，一共有两种情形：\n\n- 分发内部证书，用于 mTLS，这种情况需要分别验证客户端和服务端的证书是否被撤销\n- 分发外部服务的证书给集群内的服务，用于向集群外的通信加密，此时集群内的服务相当于客户端，仅需验证服务端证书是否被撤销\n\n本文探讨的是第二种情形，即 Istio Gateway 的证书撤销，如下图所示：\n\n![Istio Gateway 的证书撤销示意图](cert-revoke.svg)\n\nCA 通过设置 TTL 控制证书的寿命，如果要提前结束证书可以将证书撤销，有两种方式撤销证书：\n\n1. 配置证书撤销列表（CRL）\n2. 在线证书状态协议（OCSP）\n\n## CRL（证书撤销列表）\n\nCRL（证书吊销列表）是一种用于管理和验证证书有效性的机制。它包含一个已被撤销的证书列表，颁发机构（CA）定期更新该列表。当验证证书的客户端（如浏览器）收到证书时，它会检查该证书是否在 CRL 中被列为已撤销，如果是，则该证书被视为无效。\n\nCRL 通常存储在颁发机构（CA）的服务器上，并可以通过互联网公开访问。验证证书的客户端（例如，浏览器）可以下载并检查 CRL 以确定证书是否有效。CRL 可以以多种格式（如 DER 或 PEM）存储，并通过 HTTP，LDAP 或其他协议发布，以便进行验证。\n\nCRL 文件通常是以二进制形式存储的，不是直接可读的文本文件。但是，可以使用工具（例如 OpenSSL）转换为其他格式，例如 PEM，以方便阅读。下面是一个名为 \u0060crl.pem\u0060 的 CRL 示例文件，以 PEM 格式表示：\n\n\u0060\u0060\u0060dockerfile\n-----BEGIN X509 CRL-----\nMIIBtjCBqwIBATANBgkqhkiG9w0BAQUFADBBMQswCQYDVQQGEwJVUzERMA8GA1UE\nCBMITmV3IFlvcmsxETAPBgNVBAcTCE5ldyBZb3JrMREwDwYDVQQKEwhNeSBDQTEQ\nMA4GA1UECxMHQ2VydGlmaWNhdGUxGDAWBgNVBAMTD01ZIEJ1c2luZXNzIENBMB4X\nDTA5MDUwMzE1MTQwMFoXDTEwMDUwMjE1MTQwMFqgLzAtMB8GA1UdIwQYMBaAFJ4f\n6Nz7Vuw\/NcZXG0U8O6OZ9XB0MAsGA1UdDwQEAwIFoDAdBgNVHQ4EFgQUU6G9fjRK\nop\u002bJU6vQPnnhxBxHtzUwDQYJKoZIhvcNAQEFBQADgYEAbYoLz7MnJ4ltIS\u002bnCquG\nN\/v\u002b8rE00\/N0pGzN\/dCv\/8t0W0tGTGr2zGRb0mv67MPOmWmHcZZq3sOxgEIp8T\u002bO\nOJxDCD\/xJN6hB0NgN\/Z0\u002bfX9hU6bL\/6zhwUy\/l51xddmSd5KKhJ7FmOh2Py5m9Au\n4fJh7w\u002bOLyjKV7rz55WKjvY=\n-----END X509 CRL-----\n\u0060\u0060\u0060\n\n使用 OpenSSL 将其转换为可读格式：\n\n\u0060\u0060\u0060bash\nopenssl crl -inform PEM -in crl.pem -noout -text\n\u0060\u0060\u0060\n\n输出结果为：\n\n\u0060\u0060\u0060\nCertificate Revocation List (CRL):\n        Version 2 (0x1)\n    Signature Algorithm: sha256WithRSAEncryption\n        Issuer: \/C=US\/ST=New York\/L=New York\/O=My CA\/OU=Certificate\/CN=My Business CA\n        Last Update: May 3 11:40:00 2009 GMT\n        Next Update: May 2 11:40:00 2010 GMT\n    Revoked Certificates:\n        Serial Number: 1 (0x1)\n            Revocation Date: May 3 11:40:00 2009 GMT\n\u0060\u0060\u0060\n\n**注意**：该 CRL 文件的列表中只保存了一个撤销证书。\n\nCRL 虽被广泛使用，但使用 CRL 文件来撤销证书存在以下几个缺点：\n\n1. **时效性**：CRL 文件必须定期更新，否则将无法识别近期撤销的证书；\n2. **可用性**：如果无法访问 CRL 服务器，则无法验证证书是否已被撤销；\n3. **效率**：CRL 文件随着证书数量的增加而变得越来越大，因此验证证书的过程可能会变慢；\n4. **安全性**：CRL 文件本身也需要安全保护，否则攻击者可能会篡改 CRL 以逃避撤销证书的限制；\n\n因此，现在有更高效和安全的证书撤销机制，例如 OCSP（Online Certificate Status Protocol），它可以实时验证证书的状态，并且不需要存储所有已撤销证书的列表。\n\n## OCSP Stapling\n\nOCSP Stapling（正式名称为 TLS 证书状态查询扩展）是一种 TLS（Transport Layer Security）扩展，用于证明证书的状态是有效的。它允许服务器预先检索证书状态信息，并将该信息“钉”到 TLS 证书中，以减少对证书颁发机构的依赖，并提高证书状态验证的效率。可代替 OCSP 来查询 X.509 证书的状态。服务器在 TLS 握手时发送事先缓存的 OCSP 响应，用户只需验证该响应的有效性而不用再向数字证书认证机构（CA）发送请求。详见[维基百科](https:\/\/en.wikipedia.org\/wiki\/OCSP_stapling)。\n\nOCSP 只适用于单个证书，而不是列表。客户端在收到证书后，与 CA 通信以检查撤销状态。响应可以是 \u0022good\u0022、\u0022revoked\u0022 或 \u0022unknown\u0022 之一。\n\n使用 OSCP Stapling 虽然省去了维护 CRL 的负担，但是它依然有以下几个缺点：\n\n1. **额外的资源开销**：CA 服务器需要不断地响应 OCSP 质询以确保证书的有效性，这将对服务器的 CPU 和网络带宽造成额外的开销；\n2. **可用性问题**：如果 OCSP 服务器不可用，则客户端将无法获得证书的有效性信息；\n3. **安全问题**：如果 OCSP 响应被篡改或服务器不安全，则证书的有效性信息可能被篡改，从而影响安全；\n4. **兼容性问题**：OCSP Stapling 不是所有浏览器都支持的功能，因此可能需要在旧浏览器上实现额外的兼容性。\n\nOCSP 的挑战是，它给 CA 带来了很大的负担，因为每个客户端都需要独立地获得证书的验证。总体而言，OCSP Stapling 可以提高证书验证的效率和安全性，但是也存在一些需要考虑的问题。因此，在采用该技术时需要综合考虑多方面的因素。\n\n## Istio 对 OSCP Stapling 支持\n\n很多 Web 服务器都支持 OSCP Stapling，云原生边缘代理 Envoy 也支持该功能，需要对 Envoy 进行以下配置：\n\n- 配置 [\u0060DownstreamTlsContext\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/transport_sockets\/tls\/v3\/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-downstreamtlscontext) 中的 \u0060oscp_staple_policy\u0060：\n  - \u0060LENIENT_STAPLING\u0060：OCSP 响应是可选的，此为默认值\n  - \u0060STRICT_STAPLING\u0060：OCSP 响应是可选的，但如果存在并且有效，就会使用。\n  - \u0060MUST_STAPLE\u0060: OCSP 响应是必需的\n- 配置 [\u0060TlsCertificate\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/transport_sockets\/tls\/v3\/common.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-tlscertificate) 中的 \u0060oscp_staple\u0060，响应必须是 DER 编码的，只能通过文件名或 \u0060inline_bytes\u0060 提供。响应可能只与一个证书有关。\n\n目前 Envoy 已支持 OSCP Stapling，其作为 Istio 的数据平面和 Istio Gateway 中的代理，理论上 Istio 也可以支持该功能。不过 Istio 的 OSCP Stapling 证书撤销功能支持仍在进行中，详见 [PR #42859 - OSCP Stapling](https:\/\/github.com\/istio\/istio\/pull\/42859)。该功能的新进展将在本文中更新，请保持关注。\n', '\/blog\/ocsp-stapling-for-istio-gateways\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">这篇博客将向你介绍证书撤销的方式和 Istio 的解决方案。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/optimize-traffic-management-and-security-with-these-service-mesh-best-practices/">[译] 服务网格安全性优化最佳实践</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/02/01</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/optimize-traffic-management-and-security-with-these-service-mesh-best-practices/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('服务网格安全性优化最佳实践', '本文推荐了服务网格安全性优化的一些最佳实践。', '\n这是 [服务网格最佳实践系列文章](https:\/\/tetrate.io\/blog\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) 中的第三篇，摘自 Tetrate 创始工程师 Zack Butcher 即将出版的新书 Istio in Production。\n\nIstio 就像一组乐高积木：它具有许多功能，可以按照你想要的任何方式进行组装。出现的结构取决于你如何组装零件。在 [上一篇中](..\/service-mesh-deployment-best-practices-for-security-and-high-availability\/)，我们描述了一种运行时拓扑结构，用于构建健壮、有弹性且可靠的基础架构。在本文中，我们将描述一组网格配置，以帮助在运行时实现稳健性、弹性、可靠性和安全性。\n\nIstio 在其所谓的 [根命名空间](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-root_namespace) 中支持全局默认配置 —— 默认在 \u0060istio-system\u0060。在根命名空间中发布的配置默认适用于所有服务，但在本地命名空间中发布的任何配置都会覆盖它。因此，一些配置应该在根命名空间中发布，并且不允许在其他任何地方发布（例如用于在传输中强制加密的 PeerAuthentication 策略）。其他配置应该在每个服务自己的命名空间中编写（例如 VirtualService 控制它的弹性设置）。\n\n我们看到的最成功的网格采用将网格本身隐藏在另一个界面后面：例如 Helm 模板、Terraform 或更高级的解决方案，例如 [Tetrate Service Bridge (TSB)](https:\/\/tetrate.io\/tetrate-service-bridge\/)。核心思想是只公开应用程序开发人员应该配置的一小部分网格功能，最好是使用他们理解的语言（例如，TSB 可以使用 [带注释的 OpenAPI 规范](https:\/\/docs.tetrate.io\/service-bridge\/1.6.x\/en-us\/quickstart\/apps) 进行配置）。首先，我们通常只向应用程序开发人员公开流量设置和授权。身份验证和遥测由各自的团队或代表他们的平台团队集中控制。[NIST SP800-204 系列](https:\/\/tetrate.io\/blog\/nist-standards-for-zero-trust-the-sp-800-204-series\/)，尤其是 [SP 800-204A](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204a\/final) 和 [SP 800-204B](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204b\/final)。Istio 项目站点也有一组 [最佳实践](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/)，也值得收藏。\n\n## 服务网格命名约定\n\n**建议**：为 Istio 资源开发和维护一致的命名方案，最好基于它们配置的服务或主机。\n\n**建议**：为跨集群的团队保持一致的名称。命名空间应该由一个团队拥有。\n\nIstio 资源应该根据它们配置的服务或主机来命名：\u0060ServiceEntry\u0060 添加 \u0060api.example.com\u0060 到网格的应该命名为 \u0060external-api-example-com\u0060；服务的 \u0060DestinationRule\u0060、\u0060VirtualService\u0060、\u0060PeerAuthentication\u0060 和 \u0060Authorization\u0060 策略也都应该有相同的名称。PCI 命名空间中的内部服务 Payments（应用程序代码中的 hostname \u0060payments.pci\u0060）应该被命名为 \u0060payment-pci\u0060，其所有的网格配置名称也应该匹配。这些命名方案并不是硬性规定，但你应该在你的组织内建立并坚持一个一致的惯例。\n\n这些资源应该全部发布在它们配置的服务的命名空间中，或者发布在 \u0060istio-system\u0060 命名空间中以进行网格范围的配置。外部服务通常发布到 \u0060istio-system\u0060 中并由中心团队（平台或安全团队）管理。\n\n我们建议跨集群的团队使用一致的名称：无论集群租户模型如何，命名空间都应由单个团队拥有（请参阅下一节）。\n\n## 服务网格全局设置\n\n**配置可见性**。Istio 有一个配置可见性的想法：配置可以默认应用于整个集群，或者它可以只应用于本地命名空间，甚至可以只应用于单个服务（选择对整个集群可见，或者只是特定的命名空间）。为了性能和安全，你应该将该字段默认为 \u0060exportTo\u0060 本地名称空间（“.”）。你应该在安装时为 [*Services*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_service_export_to)、[*VirtualServices*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_virtual_service_export_to) 和 [*DestinationRules*](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_destination_rule_export_to) 设置这个默认值。查看 Istio 的 [全局配置](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-default_service_export_to) 来配置这些默认值：\n\n\u0060\u0060\u0060yaml\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n name: controlplane\n namespace: istio-system\nspec:\n # profile: default\n # ...\n meshConfig:\n   defaultServiceExportTo:\n   - \u0022.\u0022# only the namespace the resource is published in\n   defaultVirtualServiceExportTo:\n   - \u0022.\u0022\n   # equivalent, just different YAML syntax\n   defaultDestinationRuleExportTo: [\u0022.\u0022]\n\u0060\u0060\u0060\n\n示例 1：默认全局设置\n\n**每个命名空间的 Sidecar 资源配置**。Istio 的 \u0060Sidecar\u0060 （API）资源控制 Istio 将哪些配置发送到每个命名空间中的 Sidecar。为了获得最佳性能和最低开销，你应该为每个命名空间管理一个配置，并管理 egress 部分以仅包括服务必须与之通信的主机。这将导致 Istio 向该命名空间中的 Envoy 实例发送更少的配置，从而减少它们的内存和 CPU 消耗。结合仅注册表出站流量策略（见下一条），Sidecar 资源还可以帮助限制攻击者通过 Envoy 的表面区域，因为不在 Sidecar 的 egress 部分的主机将是该 Envoy 实例的 \u0022出站流量\u0022。这本身并不是一个足够的安全策略（见下面的安全部分），而是增加了一个攻击者必须穿越的额外防御层。\n\n**编写明确的出站（egress）流量策略**。Istio 提供了一些选项来配置它如何处理网格中的服务，该服务试图与 Istio 未知的端点进行通信：[Outbound Traffic Policy](https:\/\/istio.io\/latest\/docs\/reference\/config\/istio.mesh.v1alpha1\/#MeshConfig-OutboundTrafficPolicy-Mode)。Istio 可以允许所有流量，也可以将流量限制在网格已知的服务上。你应该在安装时配置 Istio，只允许连接到注册表中的服务。此外，你应该将所有需要与之通信的外部服务建模为 Mesh 中的 ServiceEntries（例如，SaaS 服务的 DNS 解析等），使用 DestinationRules 来配置与它们通信的 TLS。这些外部服务应该由安全团队集中管理，或者由平台团队代表他们管理。\n\n## 运行时流量管理配置\n\n**为服务使用一致的全局名称，并使用 Istio 将它们映射到本地实例**。你应该使用一致的全局名称来访问服务。你可以使用 Istio 将这些全局名称映射到本地实例。例如，\u0060payments.tetrate.internal\u0060 可以被所有内部应用程序使用，而 Istio 可以用来将该名称映射到服务实例，例如“在 \u0060us-east-2\u0060 Kubernetes 集群中的 \u0060payments.default.svc.cluster.local\u0060 服务”。这种全局命名方案使开发人员可以像 SaaS 一样考虑所有服务，而无需仔细考虑运行时拓扑的细节，并且可以轻松地执行故障转移、金丝雀和跨集群路由等操作，作为你的网格使用成熟或组织需求演变。\n\n**在根配置中定义粗略的默认弹性设置**。你应该为网格中的所有服务定义粗略的超时、重试、熔断和异常值检测设置。你可以在根配置命名空间中使用 \u0060VirtualService\u0060 来实现此目的。各个团队应在其本地命名空间中指定自己的名称以覆盖默认值。\n\n**为应用程序团队提供简化的“低 \/ 中 \/ 高”弹性设置**。将网格的底层 API 隐藏在更高级别接口后面的系统中，为配置默认断路和异常值检测设置的应用程序开发人员提供简化的“低 \/ 中 \/ 高”旋钮很有价值，因为很多领域容易配置错误，导致该应用程序性能不佳。\n\n## 运行时安全配置\n\n以下安全建议来自我们为微服务应用程序建立美国安全标准的工作，该标准由美国国家标准与技术研究院（NIST）在 [SP 800-204 系列](https:\/\/tetrate.io\/blog\/nist-standards-for-zero-trust-the-sp-800-204-series\/) 中发布。[你可以在我们的综合指南](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/) 中阅读 NIST 针对微服务应用程序的所有安全建议。\n\n**最小控制**。运行时的零信任至少需要以下五个控制：\n\n1. **加密传输中的所有内容**：提供消息真实性和窃听保护（[SP 800-204，§MS-SS-4](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n2. **验证服务到服务的通信**：每个应用程序都应验证与之通信的应用程序的身份（[SP 800-204A，§SM-DR16；SP 800-204B，§APE-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n3. **授权服务到服务访问**：每个应用程序都应使用其运行时身份授权与之通信的应用程序（[SP 800-204B，§SAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n4. **验证最终用户身份**：每个请求都必须在服务调用图中的每个跃点进行身份验证（[SP 800-204B，§EAUN-SR-1，§EUAZ-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n5. **授权最终用户访问资源**：对每种资源的每次访问都应获得授权，而不仅仅是在前门访问一次（[SP 800-204B，§EAUZ-SR-3](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n\nIstio 提供传输中的加密（我们在上面讨论了全局启用），以及可验证的服务身份 ([SPIFFE](https:\/\/tetrate.io\/blog\/why-would-you-need-spire-for-authentication-with-istio\/) ) 和服务到服务的访问控制 (Istio \u0060AuthorizationPolicy\u0060)。此外，它可以配置为代表应用程序（JWT、OIDC 令牌）验证某些形式的最终用户身份，最后 Istio 支持可插拔授权系统（Envoy 的 \u0060ext_authz\u0060）以强制最终用户访问资源。\n\n**安装限制性默认授权策略**。根据 [Istio 最佳实践](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/#use-default-deny-patterns)，你应该安装一个不允许流量的默认授权策略，为每个服务发布对象创建 \u0060AuthorizationPolicy\u0060 对象以管理允许它们与之通信的对象（[SP 800-204B，SAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。有助于实现这一目标的两个授权策略：\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: deny-all-audit\n  namespace: istio-system\nspec:\n  action: AUDIT\n\u0060\u0060\u0060\n\n示例 2：\u0060IstioAuthorizationPolicy\u0060会拒绝所有流量，并审计记录它。你可能会运行这样的策略几周，以了解在启用强制执行之前你需要的策略。\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1beta1\nkind: AuthorizationPolicy\nmetadata:\n  name: deny-all\n  namespace: istio-system\nspec:\n  {} # or action: ALLOW\n\u0060\u0060\u0060\n\n示例 3：拒绝所有流量的 Istio AuthorizationPolicy。或者，你可以创建一个允许但具有空规则集的策略，这与空主体相同。\n\n**默认情况下需要 mTLS 进行服务到服务通信**。通过在由安全或平台团队管理的根命名空间中配置 \u0060PeerAuthentication\u0060 资源，应将传输中的加密设置为严格（即 [需要 mTLS 才能与服务通信](https:\/\/tetrate.io\/blog\/how-istios-mtls-traffic-encryption-works-as-part-of-a-zero-trust-security-posture\/)）。网格外部的服务调用网格中的应用程序应该通过应用程序入口网关进行通信，它可以向外部服务提供简单的 TLS（甚至明文），因为它不太可能有证书来对网格执行 mTLS。网格内部的服务呼出应配置为使用简单的 TLS 或明文，并带有用于外部服务的 DestinationRule 的明文 ([NIST SP 800-204A, §SM-DR8](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/) )。\n\n**TLS 配置默认值**。Istio 开箱即用，具有良好的 TLS 设置（[TLS 最低版本 1.2，具有一组有限的密码套件](https:\/\/istio.io\/latest\/docs\/concepts\/security\/#mutual-tls-authentication)），但你可能需要根据你的环境对其进行调整（例如，在 [FedRAMP](https:\/\/www.fedramp.gov\/) 环境中遵守 [FIPS 140-3](https:\/\/csrc.nist.gov\/publications\/detail\/fips\/140\/3\/final) ）：\n\n- Envoy 支持通过配置 [网关](https:\/\/istio.io\/latest\/docs\/reference\/config\/networking\/gateway\/#ServerTLSSettings-cipher_suites) 为每个服务配置最低 TLS 版本和一组受支持的密码套件。\n- 如果可能，我们建议将 **TLS 1.3 作为最低版本** 执行（如果你只执行 mTLS Envoy-to-Envoy），并为需要较旧或安全性较低的 TLS 配置的外部流量使用网关。\n\n**为每个服务分配一个唯一的运行时身份，以促进表达性强、细粒度的授权策略并限制暴露于攻击**。为你正在部署的每个服务分配一个唯一的运行时标识。在 Kubernetes 中，不要在每个命名空间中使用默认的 Kubernetes 服务帐户，而是为每个命名空间中的每个服务分配一个唯一的服务帐户。授权策略只能在身份的粒度上轻松管理。当多个运行时组件共享相同的身份时，很难管理一个访问控制策略来表达你的预期访问权限，同时不允许使用共享身份的某些组件进行过于广泛的访问。这导致更大的表面积暴露给可能危及系统的一个组件的攻击者（[NIST SP 800-204A §SM-DR11，§SM-DR18](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n\n**将服务到服务的通信限制在本地命名空间**。默认情况下，服务间通信应限制在本地名称空间内。不幸的是，这不能写为根配置命名空间中的单个 AuthorizationPolicy。相反，可以将仅允许在本地命名空间中访问的默认 AuthorizationPolicy 模板化为默认值，并且应允许应用程序团队编写他们自己的更专业（受限）的策略（[NIST SP800-204B，§SAUZ-SR-1](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)）。\n\n## 下一步\n\n我们希望从我们多年帮助客户构建成功的服务网格实践的经验中获得的这些最佳实践将有助于促进你的部署。如果你还没有，请查看服务网格最佳实践系列中的其他帖子： \n\n- [第 1 部分：如何将服务网格作为安全模型的一部分，以分层形式将微服务安全与传统安全结合起来](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/)\n- [第 2 部分：服务网格安全性和高可用性部署最佳实践](\/trans\/service-mesh-deployment-best-practices-for-security-and-high-availability\/)\n\n如需全面了解 NIST 微服务安全标准，请 [下载我们的免费指南](https:\/\/tetrate.io\/tetrates-guide-to-federal-security-requirements-for-microservices\/)。\n\n### 接下来：多租户的服务网格最佳实践\n\n在我们关于服务网格最佳实践系列的下一篇文章中，我们将讨论我们看到客户正在努力解决的常见租赁决策点，并重点关注网格如何帮助促进这些决策。我们将涵盖的主题包括 Kubernetes 集群所有权、命名空间所有权、配置所有权，以及如何使用服务网格应用程序网关来缓解中断。\n', '\/trans\/optimize-traffic-management-and-security-with-these-service-mesh-best-practices\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文推荐了服务网格安全性优化的一些最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/service-mesh-deployment-best-practices-for-security-and-high-availability/">[译] 服务网格安全性和高可用性部署最佳实践</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/30</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/service-mesh-deployment-best-practices-for-security-and-high-availability/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('服务网格安全性和高可用性部署最佳实践', '本文强调的是控制平面应该如何部署在应用程序附近，入口应该如何部署以促进安全性和敏捷性，如何使用 Envoy 促进跨集群负载均衡，以及网格内部如何使用证书。', '\n这是 [服务网格最佳实践系列文章](https:\/\/tetrate.io\/blog\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) 中的第二篇，摘自 Tetrate 创始工程师 Zack Butcher 即将出版的书籍 Istio in Production。\n\n当涉及到在多集群的基础设施中部署服务网格时，有一些可移动的部分。这里主要想强调的是控制平面应该如何部署在应用程序附近，入口应该如何部署以促进安全性和敏捷性，如何使用 Envoy 促进跨集群负载均衡，以及网格内部如何使用证书。\n\n## 使服务网格控制平面与故障域保持一致\n\n**建议：围绕故障域部署松散耦合的控制平面以实现高可用性。**\n\n构建高可用性系统可能具有挑战性，而且通常成本很高。我们知道的一种经过验证的技术是围绕故障域构建。故障域是当关键系统发生故障时受影响的基础架构部分。我们构建可靠系统的基本方法是将系统跨越的故障域分组为多个独立的孤岛。最终系统的整体可靠性取决于我们可以使孤岛的独立程度。实际上，总是存在一些相互依赖性，将其最小化总是成本与可用性的权衡。\n\n在没有耦合故障域的情况下创建隔离孤岛的最简单方法是在每个孤岛中运行关键服务的独立副本。我们可以说这些副本是筒仓的本地副本 —— 它们共享相同的故障域。在云原生架构中，Kubernetes 集群形成了最自然的筒仓边界。Istio 是一项关键服务，因此我们在每个应用程序集群中运行一个 Istio 控制平面实例。换句话说，我们部署 Istio 使其故障域与你的应用程序的故障域保持一致。\n\n此外，我们确保 Istio 控制平面实例是松散耦合的，不需要直接与其他集群通信，从而最大限度地减少其与孤岛外部的通信。有关如何实现此目的的详细信息，请参阅下面的多集群部分。\n\n## 使用应用程序入口网关隔离每个应用程序的流量\n\n**建议：从每个应用程序或应用程序团队的网关（应用程序入口网关）开始，以帮助缓解共享中断。随着时间的推移你操作经验的增加，将应用程序入口合并到共享网关以优化成本。**\n\n虽然 Istio 默认附带共享 \u0060istio-ingressgateway\u0060，但我们不建议使用共享网关。大多数采用网格的团队都需要时间来构建实施共享网关模型所需的审查实践和操作，而没有共享中断的风险。特别是在 Istio 实施的早期，我们建议每个团队部署一个 Envoy 网关。我们称这些为应用程序入口网关。随着你获得操作经验，你可以开始将应用程序合并到共享网关上以优化成本。\n\n使用共享网关模型实现每个团队隔离的捷径是为每个团队分配一个单独的主机名。按主机名隔离的团队可以更安全地配置共享网关实例。然而，其他共同命运的中断风险仍然存在，例如入口代理部署的错误配置、嘈杂的邻居消耗资源和增加所有应用程序的延迟等。根据我们的经验，每个团队一个网关的方法会产生最快的影响，并且失败的机会最少，并且总体成本相对较低。\n\n我们期望成熟部署的最终状态是 80-20 的比例：大多数应用程序将通过共享网关接收流量，而一小部分高度关键或敏感的应用程序将保留专用网关。\n\n## 使用应用程序边缘网关在多个集群之间分配入口流量\n\n**建议：使用应用程序边缘网关为客户端提供单一地址，以供客户端使用并将流量分配到跨多个集群的应用程序入口网关。**\n\n![图 1：基于 Envoy 的应用程序边缘网关。](f1.png)\n\n我们经常看到客户需要跨多个集群分配入口流量。例如，他们可能希望启用蓝 \/ 绿基础设施升级，以促进跨区域故障转移，或者通过使用 Envoy 的 L7 功能将流量从单体迁移到微服务来实现扼杀模式。我们称这些为应用程序边缘网关。\n\n为了实现这个用例，我们将部署 Envoy—— 在专用的 Kubernetes 集群中或作为一组虚拟机 —— 来接收外部流量。这些 Envoy 实例将通过其 Kubernetes 入口或 VM VIP 将流量转发到你的应用程序。这与 ingress-per-team 方法协同工作：多集群网关为客户端提供一个单一地址以供使用，根据你的基础设施需要提供尽可能多的应用程序网关和集群。\n\n虽然此网关确实存在共享故障域，但其配置远比每个应用程序一个入口网关的配置简单。因此，作为共享基础架构运行起来更容易，也更安全。每个集群都有一个应用程序入口网关的共享应用程序边缘网关是一种强大而灵活的模型，用于在网格上部署和操作应用程序，还可以更轻松地操作底层基础设施。\n\n## 证书和公钥基础设施 (PKI) 的建议\n\n**建议：从你现有的企业根目录为网格 mTLS 创建一个中间签名证书。**\n\nIstio 使用常规 X.509 证书进行身份验证并在网格中启用传输加密。我们建议为现有企业根目录中的所有网格 mTLS 创建一个网格中间签名证书。如果每个环境都有一个根，请为每个环境创建一个网格中间签名证书。使用该网格中间颁发证书为每个 Istio 安装创建一个签名证书。我们建议创建一个网格中间签名证书，以便在任何特定环境中网格的整个 PKI 是一棵树，如果需要可以一起失效。成本是一些额外的证书管理，与控制平面签名证书相比，在管理网格中间签名证书的生命周期时需要更加小心。\n\n![图 2. Tetrate 推荐的将网格与现有 PKI 集成的方法：在环境（如 prod）中为 Istio 生成中间签名证书，使用它向该环境中的每个 Istio 控制平面实例颁发签名证书，并让 Istio 像往常一样向每个集群中的所有 pod 颁发工作负载（叶）证书。](f2.png)\n\nIstio 监视文件系统，并在检测到文件更改时重新加载其签名证书。因此，只要你有一个批准的机制来将秘密加载到 *istiod* pod 的文件系统中 —— 比如 *cert-manager*、Vault 的 *init-agent* 或 sidecar，或者只是存储在加密 *etcd* 中的普通旧 Kubernetes Secret—— 集成 Istio 进入你的 PKI 应该很容易。控制平面签名证书的轮换应由你的 PKI 自动执行。\n\nIstio 使用众所周知的密码学库：Istio 的内部 CA 使用 Golang 的密码学套件，Envoy（sidecar 和 ingress）使用 BoringSSL 进行证书验证和传输中的加密。通过 Tetrate 的开源 Istio 发行版 [Tetrate Istio Distro](https:\/\/tetr8.io\/tid) ，经过 FIPS 验证的控制平面和数据平面构建也作为 [Tetrate Istio 订阅](https:\/\/tetr8.io\/tis) 的一部分提供，因此你可能期望的所有 X.509 约束（基本约束，如 CA 和深度，开箱即用地支持和强制执行命名约束、策略约束等）。\n\n### 使用极短寿命的工作负载证书以轻松吊销\n\n**建议：使用 Istio 来自动化证书管理，以便设置极短的工作负载证书 TTL 变得切实可行，从而使 [证书撤销列表（CRL）](https:\/\/csrc.nist.gov\/glossary\/term\/certificate_revocation_list) 保持简短且易于管理。**\n\n在证书颁发和轮换（Istio 为你自动执行）之后，PKI 中最大的挑战是证书吊销。证书吊销是通过证书吊销列表实现的，通常 CRL 具有 24 小时的强制执行 SLA：添加到列表中的证书在吊销后最多 24 小时内可能会被基础设施视为有效。此外，由于吊销的证书必须在其整个生命周期 (TTL) 内保留在列表中，因此吊销列表会变得庞大而笨拙。\n\nIstio 提供的一个更好的解决方案是自动化证书管理，以便设置极短的工作负载证书 TTL 是切实可行的。默认情况下，Istio 附带 24 小时的工作负载证书 TTL。这足够短，大多数安全组织可以选择让受损的证书过期，而不是明确地撤销它们。而且，当你向 CRL 添加证书时，它只需要在那里停留很短的时间（因为我们不需要在 CRL 上保留过期的证书）。通过这种方式，网格有助于解决大多数组织面临的最痛苦的 PKI 问题：它颁发和吊销短期证书，这意味着吊销列表可以在需要时保持简短且易于管理。\n\n**注意**：由于网格使用 mTLS 证书作为身份，Istio 将 Envoy 配置为自动丢弃已建立的连接，以强制客户端和服务器在任何一方轮换证书时重新验证彼此。这是 Istio 实现中的设计决策，通常通过 Istio 的弹性功能对应用程序隐藏：对应用程序透明的自动重试重新建立连接。在网格中设置较短的证书 TTL 会强制这些重新连接更频繁地发生。值得注意的是，这种行为偶尔会中断一些期望长期 TCP 连接的应用程序。\n\n### 进一步的证书推荐\n\n你应该与你的安全团队协调，为你的网格颁发的证书建立适当的约束。我们推荐的一些常见约束如下。\n\n**证书生命周期 (TTL)**。请注意，只要证书是从同一个根颁发的，Istio 就支持控制平面签名证书和工作负载证书的零停机轮换。我们建议每个级别的证书生命周期如下：\n\n- 网格中间签名证书 1-3 年\n- 控制平面签名证书 3 个月\n- 工作负载证书需要 12-24 小时\n\nIstio 自动处理工作负载证书的轮换。这些证书上的短 TTL（少于 24 小时）有助于限制可能被盗的凭据进行时间限制攻击，还可以减少对 CRL 的需求。控制平面证书应按一个月的偏移轮换以确保平稳过渡 —— 换句话说，在 3 个月的 TTL 到期前 1 个月轮换控制平面签名证书。类似地，当网格中间签名证书还剩一半到三分之一的生命周期时轮换（一年 TTL 提前 3-4 个月，三年 TTL 提前 6-8 个月）。\n\n**基础（CA 和深度）**。控制平面签名证书应该只能颁发叶证书：用于工作负载识别的非签名证书。因此，应配置深度限制以防止控制平面签名证书颁发任何其他签名证书。\n\n网格中间签名证书需要创建控制平面签名证书，因此它应该配置一个深度，以便能够**在它下面创建一个级别的签名证书，而不是更多**。\n\n**名称约束**。Istio 颁发的工作负载证书不会填充 X.509 主体名称 (SN) 字段；网格身份验证依赖于作为主体备用名称 (SAN) 字段携带的 SPIFFE 身份。阅读 [SPIFFE 规范以获取有关验证和身份验证工作的信息](https:\/\/github.com\/spiffe\/spiffe\/blob\/main\/standards\/X509-SVID.md#4-constraints-and-usage)，以及 Istio 的 [文档](https:\/\/istio.io\/latest\/docs\/concepts\/security\/#istio-identity) 以了解 Istio 如何根据 SPIFFE 对身份进行编码。在为网格中间和控制平面签名证书编写名称约束时，请记住这一点。\n\n**密钥用法**。 \u0060keyCertSign\u0060 必须为网格中间签名证书和控制平面签名证书设置，但应为工作负载证书禁用。换句话说，网格中间和控制平面证书是签名证书，而工作负载证书不是。\n\n根据 SPIFFE 的建议，不应将签名证书用于传输中的加密，并且应配置密钥使用以防止它（通过加密约束）。\n\n**扩展密钥用法**。虽然此处没有具体要求，但 SPIFFE X.509 SVID 规范说明 \u0060id-kp-serverAuth\u0060 和 \u0060id-kp-clientAuth\u0060 应针对叶（工作负载）证书进行配置。\n\nSPIFFE 规范还推荐了 [各种证书约束](https:\/\/github.com\/spiffe\/spiffe\/blob\/main\/standards\/X509-SVID.md#4-constraints-and-usage)，尽管其中大部分上面已经约束了。\n\n## 下一步\n\n我们希望从多年帮助我们的客户充分利用服务网格的经验中收集的这些最佳实践将有助于促进你的部署。如果你还没有，请查看 [如何将服务网格作为安全模型的一部分，以分层形式将微服务安全与传统安全结合起来](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/) 这篇文章。\n\n接下来：服务网格运行时配置建议。在我们的下一篇文章中，我们将谈论：\n\n- 命名约定\n- 全局设置\n- 流量管理\n- 安全\n- 遥测\n\n敬请关注。\n', '\/trans\/service-mesh-deployment-best-practices-for-security-and-high-availability\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文强调的是控制平面应该如何部署在应用程序附近，入口应该如何部署以促进安全性和敏捷性，如何使用 Envoy 促进跨集群负载均衡，以及网格内部如何使用证书。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/secure-ingress-gateway-of-istio/">使用 cert-manager ACME Issuer 为 Istio 中的入口网关设置证书</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/09</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 cert-manager ACME Issuer 为 Istio 中的入口网关设置证书', '本文就将使用 Let\u0027s Encrypt、cert-manager 来管理 Istio 中入口网关的证书。', '\n本文将以 Bookinfo 应用为例，为 Istio 的入口网关设置一个真实的 TLS\/SSL 证书。我们将使用 Let\u0027s Encrypt、cert-manager 来管理 Istio 中入口网关的证书。\n\n## 准备 {#prerequisite}\n\n请先参考 [Istio 文档](https:\/\/istio.io\/latest\/zh\/docs\/setup\/)安装 Istio 和 [Bookinfo 应用](https:\/\/istio.io\/latest\/zh\/docs\/examples\/bookinfo\/)，笔者在 GKE 中安装了 Istio 1.16。\n\n本文中安装的各组件版本信息如下：\n\n- Kubernetes 1.24.7\n- Istio 1.16\n- Gateway API 0.5.1\n- cert-manager 1.10.1\n\n## 架构 {#arch}\n\n本实验中包含以下关键组件：\n\n- 使用 Cloudflare 提供 DNS 解析\n- 使用 Let\u0027s Encrypt 创建证书\n- 使用 cert-manager 自动申请和续期证书\n- 使用 Gateway API 来创建入口网关\n- 所有组件部署在 GKE 中\n\n图 1 展示了本实验的架构以及流量路由过程。\n\n![图 1：Istio 入口网关证书挂载模式](arch.svg)\n\n流量路由过程如下：\n\n1. 在 Gateway 创建完成后通过 LoadBalancer 暴露网关 IP，将该 IP 配置在 DNS 解析记录中；\n2. Gateway 通过注解引用 [ACME Issuer](https:\/\/cert-manager.io\/docs\/configuration\/acme\/)；\n3. ACME Issuer 向 cert-manager 发送请求证书（[order 和 challenge](https:\/\/cert-manager.io\/docs\/concepts\/acme-orders-challenges\/)），并使用 [DNS01 Challenge Provider](https:\/\/cert-manager.io\/docs\/configuration\/acme\/dns01\/)；\n4. cert-manager 向 ACME 服务器 Let\u0027s Encrypt 请求证书并创建 Kubernetes Secret；\n5. 在 Gateway 中通过应用 Secret 挂载 TLS 证书；\n6. HTTPRoute 将入口流量路由到 productpage 服务；\n\n## ACME Issuer\n\nIstio 包含了开箱即用的 mTLS 支持，你也可以使用[自定义 CA](https:\/\/istio.io\/latest\/zh\/docs\/tasks\/security\/cert-management\/plugin-ca-cert\/) 或 [SPIRE](\/blog\/cert-manager-spire-istio\/) 来管理集群内证书，但是对于入口网关的证书，就需要我们单独设置。你可以[手动为入口网关配置证书](https:\/\/istio.tetratelabs.io\/zh\/istio-in-practice\/setting-up-ssl-certs\/)，不过管理起来会比较麻烦，因为你需要负责证书的轮换以防止证书过期，或使用 [Let\u0027s Encrypt](https:\/\/letsencrypt.org\/) 这样的 ACME Issuer 来自动化管理证书。\n\nACME (Automated Certificate Management Environment) Issuer 是一种认证机构，可以使用 ACME 协议为客户端申请和管理证书。ACME 是一种用于自动化 SSL\/TLS 证书颁发和管理的开放协议。它通常用于网站或其他在线服务的证书管理，以确保安全连接。\n\nLet\u0027s Encrypt 是一个非营利性的 ACME Issuer，可以为网站提供免费的 SSL\/TLS 证书。它的目标是使加密技术普及化，并帮助提升网络安全水平。Let\u0027s Encrypt 使用 ACME 协议与客户端通信，可以为客户端申请和管理证书。ACME 协议是开放的，因此任何机构都可以成为 ACME Issuer，只要它们遵守 ACME 协议的规定。\n\n## 详细步骤 {#details-steps}\n\n1. 安装 Gateway API：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f https:\/\/github.com\/kubernetes-sigs\/gateway-api\/releases\/download\/v0.5.1\/standard-install.yaml\n   \u0060\u0060\u0060\n\n2. 安装 cert-manager\n\n   \u0060\u0060\u0060bash\n   kubectl apply -f https:\/\/gist.githubusercontent.com\/rootsongjc\/78487acdea70a3c27c1a1b794546d031\/raw\/0df08b91dfaff6412bbd891ccedffaa882a9a99f\/cert-manager.yaml\n   \u0060\u0060\u0060\n\n   它为 cert-manager Deployment 增加了以下启动项：\n\n   \u0060\u0060\u0060bash\n   args:\n     - --feature-gates=ExperimentalGatewayAPISupport=true\n   \u0060\u0060\u0060\n\n3. 在 Cloudflare 中创建一个名为 \u0060lets-encrypt-token\u0060 的 API token，自定义模板设置如下：\n\n   Permissions：\n\n   - \u0060Zone - DNS - Edit\u0060\n   - \u0060Zone - Zone - Read\u0060\n\n   Zone Resources:\n\n   - \u0060Include - All Zones\u0060\n\n   将该 token 存储在一个 Secret 中：\n\n   \u0060\u0060\u0060yaml\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: v1\n   kind: Secret\n   metadata:\n     name: cloudflare-api-token-secret\n     namespace: istio-system\n   type: Opaque\n   stringData:\n     api-token: \u003cAPI Token\u003e\n   EOF\n   \u0060\u0060\u0060\n\n   {{\u003ccallout warning 注意\u003e}}\n\n   本次实验中该 Token 实际上并没起到作用，正常情况下 cert-manager 会通过 Cloudflare API 与 Cloudflare 交互，为我们配置 DNS 记录。该问题还需要进一步排查。\n\n   {{\u003c\/callout\u003e}}\n\n4. 配置 Let\u0027s Encrypt  Issuer：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: cert-manager.io\/v1\n   kind: Issuer\n   metadata:\n     name: letsencrypt\n   spec:\n     acme:\n       email: rootsongjc@gmail.com\n       server: https:\/\/acme-v02.api.letsencrypt.org\/directory\n       privateKeySecretRef:\n         name: lets-encrypt-issuer-account-key\n       solvers:\n       - dns01:\n           cloudflare:\n             apiTokenSecretRef:\n               name: cloudflare-api-token-secret\n               key: api-token\n         selector:\n           dnsNames:\n           - \u0027bookinfo.jimmysong.io\u0027\n   EOF\n   \u0060\u0060\u0060\n\n5. 配置 Gateway：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1beta1\n   kind: Gateway\n   metadata:\n     name: bookinfo-gateway\n     annotations:\n       cert-manager.io\/issuer: letsencrypt\n   spec:\n     gatewayClassName: istio\n     listeners:\n     - name: http\n       hostname: bookinfo.jimmysong.io\n       port: 443\n       protocol: HTTPS\n       allowedRoutes:\n         namespaces:\n           from: Same\n       tls:\n         mode: Terminate\n         certificateRefs:\n           kind: Secret\n           group: \u0022\u0022\n           name: bookinfo-tls\n   EOF\n   \u0060\u0060\u0060\n\n   在 Gateway 创建完成后，会在 default 命名空间中创建一个网关 Pod 以及 LoadBalancer 资源的服务。\n\n   查看 \u0060default\u0060 命名空间中的 Secret，你会发现 \u0060bookinfo-tls\u0060，它是由 cert-manager 创建的，查看该 Secret 中保存的证书，你将会看到由 Let\u0027s Encrypt 颁发的证书信任链：\n\n   - \u0060bookinfo.jimmysong.io\u0060 \n   - \u0060ISRG Root X1\u0060\n   - \u0060DST Root CA X3\u0060\n\n6. 配置 HTTPRoute：\n\n   \u0060\u0060\u0060bash\n   kubectl apply -n default -f - \u003c\u003cEOF\n   apiVersion: gateway.networking.k8s.io\/v1beta1\n   kind: HTTPRoute\n   metadata:\n     name: bookinfo\n   spec:\n     parentRefs:\n     - name: bookinfo-gateway\n     rules:\n     - matches:\n       - path:\n           type: Exact\n           value: \/productpage\n       - path:\n           type: PathPrefix\n           value: \/static\n       - path:\n           type: Exact\n           value: \/login\n       - path:\n           type: Exact\n           value: \/logout\n       - path:\n           type: PathPrefix\n           value: \/api\/v1\/products\n       backendRefs:\n       - name: productpage\n         port: 9080\n   EOF\n   \u0060\u0060\u0060\n\n7. 在 Cloudflare 中配置域名记录：将网关服务的外网 IP 及域名 \u0060bookinfo.jimmysong.io\u0060 添加到 Cloudflare 的 DNS 记录中就可以实现域名解析。\n\n   {{\u003ccallout warning 注意\u003e}}\n\n   本实验中发现网关 Pod 并没有挂载 \u0060bookinfo-tls\u0060  Secret 中的证书，我们只好通过 Cloudflare 来配置 TLS 证书：为网站开启全（严格）SSL\/TLS，这将使用 Cloudflare 颁发的 TLS 证书。\n\n   {{\u003c\/callout\u003e}}\n\n8. 在浏览器中访问 \u003chttps:\/\/bookinfo.jimmysong.io\/productpage\u003e 就可以访问 bookinfo 应用了。\n\n## 总结 {#summary}\n\n本次实验虽然实现了网关的 TLS 加密，也为网关生成了 TLS 证书，但实际上网关使用的是 Cloudflare 颁发的证书。这并不是我们最初的目标，即使用 ACME Server（Let\u0027s Encrypt）为网关颁发的证书。为什么网关 Pod 没有挂载我们应用的 Secret 中的证书，Cloudflare DNS01 Challenge Provider 为什么没有生效，这两个问题还需要我们进一步调查。\n\n## 参考 {#reference}\n\n- [Acquire SSL Certificates In Kubernetes From Let’s Encrypt With Cert-Manager - thinktecture.com](https:\/\/www.thinktecture.com\/en\/kubernetes\/ssl-certificates-with-cert-manager-in-kubernetes\/)\n- [How To Secure Kubernetes NGINX Ingress With Cert-Manager](https:\/\/getbetterdevops.io\/k8s-ingress-with-letsencrypt\/)\n- [Securing gateway.networking.k8s.io Gateway Resources - cert-manager.io](https:\/\/cert-manager.io\/docs\/usage\/gateway\/)\n', '\/blog\/secure-ingress-gateway-of-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文就将使用 Let&#39;s Encrypt、cert-manager 来管理 Istio 中入口网关的证书。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely/">[译] 如何通过服务网格增强微服务的安全性</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2023/01/05</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('如何通过服务网格增强微服务的安全性', '我们认为，服务网格最适合作为现有安全模型的一部分，通过在传统安全控制之上添加更细粒度的安全策略来实现。', '\n本文是 Tetrate 即将出版的《Istio in Production》一书中摘录的服务网格最佳实践系列的第一篇，作者是 Tetrate 创始工程师 Zack Butcher。\n\n我们接到许多实施网格的企业的问题，其中之一是“我还需要哪些控制，而网格提供哪些控制？”换句话说，他们想知道网格如何适应现有的安全模型。我们发现，网格最适合作为一组安全控制的内圈，这些控制从物理网络到应用本身的每一层都被实施。\n\n## 服务网格作为通用策略执行点\n\n我们看到网格的 Sidecar 作为通用策略执行点（[NIST SP 800-204B：使用服务网格的基于属性的访问控制](https:\/\/csrc.nist.gov\/publications\/detail\/sp\/800-204b\/final)）。由于它拦截了所有进出应用程序的流量，Sidecar 为我们提供了一个强大的位置来实现各种策略。我们可以实现传统的安全策略，如基于应用程序标识而非网络位置的更高保证的应用程序之间的授权。但我们也可以实施之前不切实际或需要与应用程序深度参与的策略。例如，网格允许你编写以下策略：“后端可以从数据库读取（使用应用级身份进行身份验证和授权），但前提是请求具有有效的最终用户凭证并具有读取范围（使用最终用户身份进行身份验证和授权）。”\n\n虽然服务网格提供了一个强大，动态和一致的安全基线，你可以在其上构建应用程序安全模型，但网格本身永远无法提供应用程序所需的 100% 运行时安全。例如，由于 Sidecar 位于用户空间中，网格在减轻许多类型的网络拒绝服务攻击方面不如传统防火墙机制。另一方面，由于同样的原因，网格在减轻许多应用级拒绝服务攻击方面比传统基础设施更有效。\n\n## 作为一个强大的中间层\n\n网格作为基础架构的强大中间层：位于物理网络和所实施的 L3\/L4 控制之上，但位于应用程序之下。这允许更脆弱和更难以改变的松散配置 —— 允许更高层的更大敏捷性 —— 因为控制体系在更高层被考虑。\n\n![图 1：增加细粒度策略层以增强传统安全。](f1.png)\n\n网格提供的主要安全功能是：\n\n- 作为 X.509 证书的**运行时身份**，用于在传输期间加密，以及服务之间通信的身份验证和授权。\n- **策略执行点**，用于在网格中的所有应用程序上实施一致的最终用户身份验证和授权。\n- 服务身份和最终用户身份的**运行时策略执行**（例如，“A 只能使用具有读取范围的有效最终用户凭证与 B 进行通信”）。\n- **速率限制和弹性功能**，用于减轻常见的应用级拒绝服务攻击，并保护免受常见的级联故障模式的影响。\n- **WAF** 和其他**深层包检测**功能，用于内部流量，而不仅仅是在边缘。\n- 来自网格中所有应用程序的**一致的操作遥测**，可用于理解、实施和审核安全策略。\n- 具有动态运行时更新的**策略即代码**（Policy-as-code）模型，独立于应用程序生命周期。\n\n## 服务网格作为分层防御的一部分\n\n考虑到网格的安全功能，我们认为，组织采用它作为分层防御方法的一部分是最合理的。\n\n![图 2：每层策略的示例以及一个示例部署拓扑。](f2.png)\n\n## L3 层的敏捷性：粗粒度的入口和出口策略以及 L7 的细粒度控制\n\n在边缘的 L3 控制（如防火墙）在粗粒度的入口和出口策略方面仍然有效，但通常会减慢应用程序开发敏捷性。由于网格提供了细粒度的服务间授权，所以可以在 L3 上设置更广泛的策略，为平台、安全和应用程序团队提供更多敏捷性。\n\n**实施对外部服务的访问控制**。网格的出口代理特别适用于实施应用程序到外部服务的控制，而只有出口代理本身被外出防火墙 allow-listed：这为平台或安全团队在管理哪些应用程序允许与企业基础架构之外的通信提供了很多敏捷性，同时保持现有的基于周界的模型。\n\n**使用加密和动态访问控制代替“可达性即授权”**。网格可以开始有效地取代 VPN 和基于 IPSec 的网络“可达性即授权”模式，提供传输中的加密，以及每个应用而不是每个主机的认证和授权。\n\n## L4 层的改进：更扁平和易于管理的网络微分段\n\n微分段之类的控制可以通过网格进一步改进：尽管我们可能允许整个（小）子网在基于分段的策略中进行通信，但我们可以使用网格按方法和动词对单独的服务间通信进行控制。\n\n**补充现有的微分段同时展平网络**。通过提供细粒度的服务间控制，网格往往会补充现有的微分段策略，同时使得组织更容易管理的较平的网络得以采用（例如，在云环境中）。\n\n**使用工作负载身份启用传输期间的加密（mTLS）和服务级别访问控制**。传输层几乎总是处理加密传输，网格通过根据 SPIFFE 规范发布和轮换短期（\u003c24 小时）工作负载身份证书来为应用程序实现此功能，从而允许传输期间的加密以及服务级别的身份验证和授权。\n\n## L7 层的增强：无处不在的边缘和访问控制\n\n**为所有流量提供边缘控制**。L7 控制，如 Web 应用程序防火墙（WAF）以及“API 网关功能”（如流量限制）几乎总是在边缘实施。网格可以通过为网格中所有流量（包括内部的“东西”通信）启用相同的功能来增强这些现有部署。\n\n**简化应用程序的访问控制**。除了使边缘控制无处不在之外，网格还可以在应用程序看到请求之前执行端用户身份验证和粗粒度授权，从而大大简化应用程序本身必须执行的访问控制。在未来，我们将看到越来越多的访问控制功能从应用程序迁移到网格中。\n\n## 总结和展望\n\n我们认为，服务网格最适合作为现有安全模型的一部分，通过在传统安全控制之上添加更细粒度的安全策略来实现。作为一个通用策略执行点，网格在更改最困难的较低层提供了更松散的策略，将敏捷性推向堆栈的顶部，其中更多的上下文允许在更高层实现更特定的控制。这种强大的安全层对于大多数组织来说都是采用分层防御深度方法的最佳选择。\n\n## 接下来：服务网格部署最佳实践\n\n我们服务网格最佳实践系列博客文章的下一篇将讨论部署拓扑。在多个集群的真实基础架构中部署服务网格时存在一些移动部分。在下一篇文章中，我们将更详细地研究：\n\n- 控制平面应如何部署在应用程序附近。 \n- 应该如何部署入口，以促进安全和敏捷性。\n- 如何使用 Envoy 促进跨集群的负载平衡。\n- 证书在网格中应该是什么样子的。\n\n---\n\n如果你不熟悉服务网格和 Kubernetes 安全性，我们在 [Tetrate Academy](https:\/\/tetr8.io\/academy) 提供了一系列免费在线课程，可以让你快速了解 Istio 和 Envoy。\n\n如果你正在寻找一种快速将 Istio 投入生产的方法，请查看 [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid)。TID 是 Tetrate 的强化、完全上游的 Istio 发行版，具有经过 FIPS 验证的构建和支持。这是开始使用 Istio 的好方法，因为你知道你有一个值得信赖的发行版，有一个支持你的专家团队，并且如果需要，还可以选择快速获得 FIPS 合规性。\n\n一旦启动并运行 Istio，你可能需要更简单的方法来管理和保护你的服务，而不仅仅是 Istio 中可用的方法，这就是 Tetrate Service Bridge 的用武之地。你可以[在这里](https:\/\/tetr8.io\/tsb)详细了解 Tetrate Service Bridge 如何使服务网格更安全、更易于管理和弹性，或[联系我们进行快速演示](https:\/\/tetr8.io\/contact)。\n', '\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">我们认为，服务网格最适合作为现有安全模型的一部分，通过在传统安全控制之上添加更细粒度的安全策略来实现。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/cert-manager-spire-istio/">使用 cert-manager 和 SPIRE 管理 Istio 中的证书</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/12/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 cert-manager 和 SPIRE 管理 Istio 中的证书', '本文介绍如何集成 SPIRE 和使用 cert-manager 实现细粒度的证书管理以及证书轮换。', '{{\u003ccallout warning\u0022注意\u0022\u003e}}\n\n从 v1.5.4 版本开始，SPIRE 移除了 Kubernetes Workload Registrar 组件，改用 SPIRE Controller Manager，详见 [spire\/spire issue #3853](https:\/\/github.com\/spiffe\/spire\/pull\/3853)。根据我的测试，本文中的程序在 v1.5.4 或更高版本上无法执行，因为会遇到一系列身份验证失败的问题。\n{{\u003c\/callout\u003e}}\n\n在[上一篇博客](\/blog\/istio-certificates-management\/)中我介绍了 Istio 中是如何管理证书的，这篇文章将指导你如何使用外置 CA，通过集成 [SPIRE](https:\/\/spiffe.io\/) 和 [cert-manager](https:\/\/cert-manager.io\/) 实现细粒度的证书管理和自动证书轮换。\n\n如果你还不了解什么是 SPIRE 以及为什么我们要使用 SPIRE，推荐你阅读以下内容：\n\n- [为什么 Istio 要使用 SPIRE 做身份认证？](\/blog\/why-istio-need-spire\/)\n- [如何在 Istio 中集成 SPIRE？](\/blog\/how-to-integrate-spire-with-istio\/)\n- [零信任的基石：使用 SPIFFE 为基础设施创建通用身份](\/book\/spiffe\/)\n\n## 证书签发管理流程简介 {#intro}\n\n下图展示了本文中使用的基于 cert-manager 和 SPIRE 的证书信任链：\n\n![基于 cert-manager、SPIRE 的证书信任链](spire-chain-tree.svg)\n\n从图中你可以看出：\n\n- cert-manager 作为根 CA 为 *istiod* 和 SPIRE 颁发证书，我们使用了[自签名 Issuer](https:\/\/cert-manager.io\/docs\/configuration\/selfsigned\/)，你还可以为其配置使用 Let\u0027s Encrypt、Vault、Venafi 等内置 Issuer，或其他外置的 Issuer；另外你也可以选择使用其他 [UpstreamAuthority](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/)，例如 Vault、SPIRE 联邦等；\n- SPIRE 为 Istio 网格内工作负载和 Ingress Gateway、Egress Gateway 颁发 SVID 证书，用于服务间 mTLS；\n- 其中网格外访问 Ingress Gateway 时的使用的证书及 Egress Gateway 访问网格外服务使用的证书需要额外配置；\n\n下图展示了在 Istio 中集成 SPIRE 和 cert-manger 后的证书颁发和更新流程。\n\n![Istio 集成 SPIRE 和 cert-manager 后的证书颁发和更新流程](cert-manager-spire-istio.svg)\n\n1. SPIRE Server 中的 SPIRE Controller Manager 自动注册 Kubernetes 中的工作负载，为所有工作负载生成 SPIFFE 标准的身份；\n2. cert-manager 为 *istiod* 颁发并管理 CA 证书；\n3. 工作负载中的 Envoy 代理通过 UNIX Domain Socket（UDS）通过 SDS API 向同节点上的 SPIRE Agent 发送 CSR 请求；\n4. SPIRE Agent 向 SPIRE Server 发送 CSR；\n5. SPIRE Server 向 SPIRE Agent 返回签名后的证书；\n6. SPIRE Agent 向工作负载返回签名后的证书；\n7. SPIRE 负责工作负载的证书管理和更新；\n\n在了解了大致流程后，下面我们将依次安装各个组件。各个组件版本如下：\n\n- cert-manager v1.15.1\n- SPIRE v1.2.0\n- Istio v1.21.1\n\n## 安装 cert-manager {#install-cert-manager}\n\n运行下面的命令安装 cert-manager，我们将使用它来实现自动证书轮换：\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/github.com\/cert-manager\/cert-manager\/releases\/download\/v1.15.1\/cert-manager.yaml\n\u0060\u0060\u0060\n\n根 CA 是用自签名证书，运行下面的命令配置根 CA：\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Issuer\nmetadata:\n  name: selfsigned\n  namespace: cert-manager\nspec:\n  selfSigned: {}\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: selfsigned-ca\n  namespace: cert-manager\nspec:\n  isCA: true\n  duration: 21600h\n  secretName: selfsigned-ca\n  commonName: certmanager-ca\n  subject:\n    organizations:\n      - cert-manager\n  issuerRef:\n    name: selfsigned\n    kind: Issuer\n    group: cert-manager.io\n---\napiVersion: cert-manager.io\/v1\nkind: ClusterIssuer\nmetadata:\n  name: selfsigned-ca\nspec:\n  ca:\n    secretName: selfsigned-ca\nEOF\n\u0060\u0060\u0060\n\n然后为 *istiod* 配置证书：\n\n\u0060\u0060\u0060yaml\nkubectl create namespace istio-system\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 1440h\n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\n现在我们已经安装好了 cert-manager，并创建了名为 \u0060selfsigned-ca\u0060 的 \u0060clusterIssuer\u0060，接下来，我们来安装 SPIRE 并将 cert-manager 作为 SPIRE 的  [\u0060UpstreamAuthority\u0060](https:\/\/github.com\/spiffe\/spire\/blob\/main\/doc\/plugin_server_upstreamauthority_cert_manager.md)。\n\n## 安装 SPIRE {#install-spire}\n\n运行下面的命令快速安装 SPIRE：\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/jimmysong.io\/blog\/cert-manager-spire-istio\/manifests\/spire-with-cert-manager-upstream-authority-quick-start.yaml\n\u0060\u0060\u0060\n\n该 YAML 文件比起 Istio 安装包中的 [\u0060samples\/security\/spire\/spire-quickstart.yaml\u0060](https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.22\/samples\/security\/spire\/spire-quickstart.yaml) 文件增加了对 cert-manager 的适配，如：\n\n- 为 \u0060spire-server-cluster-role\u0060 ClusterRole 增加了对 \u0060cert-manager.io\u0060 API 组的权限；\n- 在 SPIRE Server 的配置中增加了 \u0060UpstreamAuthority \u0022cert-manager\u0022\u0060 配置； \n\n{{\u003ccallout note \u0022注意\u0022\u003e}}\n\nSPIRE Server 配置中的 \u0060trust_domain\u0060 应与安装 Istio 时指定的 \u0060TRUST_DOMAIN\u0060 环境变量的值保持一致。\n\n{{\u003c\/callout\u003e}}\n\n该命令中会安装 SPIRE Controller Manager，自动注册 Kubernetes 中的工作负载。所有工作负载将根据其服务账户注册 SPIFFE 标准的服务身份格式 \u0060spiffe:\/\/\u003ctrust-domain\u003e\/ns\/\u003cnamespace\u003e\/sa\/\u003cservice-account\u003e\u0060。\n\n如果你想调整 SPIRE CA 和 SVID 证书的 TTL，可以在 SPIRE Server 的配置中修改 \u0060ca_ttl\u0060（默认 24h）和 \u0060default_svid_ttl\u0060（默认 1h），详见 [SPIRE Server 配置](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/)。\n\n## 安装 Istio {#install-istio}\n\nPod 中的 Envoy 代理将共享本地 SPIRE Agent 的 Unix Domain Socket，通过 Workload API 与 SPIRE Server 通信获取证书，如下图所示。\n\n![SPIRE Agent 架构图](spire-agent.svg)\n\n运行下面的命令安装 Istio 并启用 CA 证书自动轮换：\n\n\u0060\u0060\u0060yaml\nistioctl install --skip-confirmation -f - \u003c\u003cEOF\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\nspec:\n  profile: default\n  meshConfig:\n    # 信任域应与 SPIRE Server 中配置的信任域相同\n    trustDomain: example.org\n  values:\n    global:\n    # 自定义 sidecar 模板\n    sidecarInjectorWebhook:\n      templates:\n        spire: |\n          spec:\n            containers:\n            - name: istio-proxy\n              volumeMounts:\n              - name: workload-socket\n                mountPath: \/run\/secrets\/workload-spiffe-uds\n                readOnly: true\n            volumes:\n              - name: workload-socket\n                csi:\n                  driver: \u0022csi.spiffe.io\u0022\n                  readOnly: true\n  components:\n    pilot:\n      k8s:\n        env:\n          # 如果启用，如果用户引入新的中间插件 CA，用户不需要重新启动 istiod 来获取证书。Istiod 会获取新添加的中间插件 CA 的证书并更新它。不支持插入新的 Root-CA。\n          - name: AUTO_RELOAD_PLUGIN_CERTS\n            value: \u0022true\u0022 \n    ingressGateways:\n      - name: istio-ingressgateway\n        enabled: true\n        label:\n          istio: ingressgateway\n        k8s:\n          overlays:\n            - apiVersion: apps\/v1\n              kind: Deployment\n              name: istio-ingressgateway\n              patches:\n                - path: spec.template.spec.volumes.[name:workload-socket]\n                  value:\n                    name: workload-socket\n                    csi:\n                      driver: \u0022csi.spiffe.io\u0022\n                      readOnly: true\n                - path: spec.template.spec.containers.[name:istio-proxy].volumeMounts.[name:workload-socket]\n                  value:\n                    name: workload-socket\n                    mountPath: \u0022\/run\/secrets\/workload-spiffe-uds\u0022\n                    readOnly: true\nEOF\n\u0060\u0060\u0060\n\n因为我们要使用 Istio Operator 中声明的 \u0060spire\u0060 模板来部署工作负载，因此我们运行下面的命令部署 Bookinfo 应用：\n\n\u0060\u0060\u0060bash\nistioctl kube-inject -f bookinfo-with-spire-template.yaml | kubectl apply -n default -f -\n\u0060\u0060\u0060\n\n**注意**：上面命令中使用的 \u0060bookinfo-with-spire-template.yaml\u0060 文件可以在[这里](.\/manifests\/bookinfo-with-spire-template.yaml)找到，与 Istio 安装包中的 [\u0060samples\/bookinfo\/platform\/kube\/bookinfo.yaml\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml) 文件唯一的区别就是每个 Deployment 的 template 中都增加了以下注解：\n\n\u0060\u0060\u0060yaml\nannotations:\n  inject.istio.io\/templates: \u0022sidecar,spire\u0022\n\u0060\u0060\u0060\n\n## 验证 SPIRE {#validate-spire}\n\n我们将通过检查 productpage 服务的身份和证书配置来验证 SPIRE 是否生效。\n\n使用下面的命令可以检查 SPIRE 是否给工作负载颁发了身份证明：\n\n\u0060\u0060\u0060bash\nkubectl exec -i -t spire-server-0 -n spire -c spire-server -- \/bin\/sh -c \u0022bin\/spire-server entry show -socketPath \/run\/spire\/sockets\/server.sock -spiffeID spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\u0022\n\u0060\u0060\u0060\n\n你可以在输出结果中看到 protuctpage 服务的身份信息：\n\n\u0060\u0060\u0060\nFound 1 entry\nEntry ID         : 69fbf896-a296-4c3c-8179-44bf4e49e474\nSPIFFE ID        : spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\nParent ID        : spiffe:\/\/example.org\/k8s-workload-registrar\/demo-cluster\/node\/gke-cluster-1-default-pool-18d66649-z1lm\nRevision         : 1\nTTL              : default\nSelector         : k8s:node-name:gke-cluster-1-default-pool-18d66649-z1lm\nSelector         : k8s:ns:default\nSelector         : k8s:pod-uid:73347537-a3e5-4e43-b8c5-bd315c7385b7\nDNS name         : productpage-v1-7f444fc4dd-rq47m\nDNS name         : productpage.default.svc\n\u0060\u0060\u0060\n\n查看 \u0060productpage\u0060 pod 的证书信任链：\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\n查看根证书：\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes\u0027 | base64 --decode \u003e root.pem\n\u0060\u0060\u0060\n\n\u0060chain.pem\u0060 文件是证书信任链，其中包含两个证书，将它们保存到两个文件中：\n\n\u0060\u0060\u0060bash\nsplit -p \u0022-----BEGIN CERTIFICATE-----\u0022 chain.pem cert-\n\u0060\u0060\u0060\n\n后使用 OpenSSL 查看所有证书：\n\n\u0060\u0060\u0060\nopenssl x509 -noout -text -in cert-aa\nopenssl x509 -noout -text -in cert-ab\nopenssl x509 -noout -text -in root.pem\n\u0060\u0060\u0060\n\n你将看到如下的证书信任链 \u0060root.pem\u0060 -\u003e \u0060cert-aa\u0060  -\u003e \u0060cert-ab\u0060，如下图所示：\n\n![Productpage 服务的证书信任链](spire-bookinfo-cert-chain.svg)\n\n查看 Istiod 的证书：\n\n\u0060\u0060\u0060bash\nistioctl -n istio-system proxy-config secret deployment\/istiod -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\n从证书信任链中我们可以看到：\n\n- cert-manager 做为 PKI 的根节点为 *istiod* 颁发证书；\n- SPIRE 作为中间 CA 再为各个工作负载颁发证书；\n- Istio 网格中工作负载的 X509 v3 主体别名中的 URI 遵循了 SPIFF 身份规范；\n- Istio 服务网格中的所有工作负载的身份和证书都由 SPIRE 来管理；\n\n## 设置证书自动轮换 {#cert-auto-rotate}\n\n如果你要修改 *istiod* 证书的轮换周期，从 60 天（1440 小时）缩短到 30 天（720 小时），运行下面的命令：\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 720h \n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\n运行下面的命令查看 *istiod* 的日志：\n\n\u0060\u0060\u0060bash\nkubectl logs -l app=istiod -n istio-system -f\n\u0060\u0060\u0060\n\n过两分钟后，你将看到类似如下的证书更改记录：\n\n\u0060\u0060\u0060\n2022-12-23T03:48:42.697360Z\tinfo\tUpdate Istiod cacerts\n2022-12-23T03:48:42.697503Z\tinfo\tUsing kubernetes.io\/tls secret type for signing ca files\n2022-12-23T03:48:42.778241Z\tinfo\tIstiod has detected the newly added intermediate CA and updated its key and certs accordingly\n2022-12-23T03:48:42.779459Z\tinfo\tx509 cert - Issuer: \u0022CN=istiod.istio-system.svc\u0022, Subject: \u0022\u0022, SN: d7acac2301045f741e5e30cff380deaf, NotBefore: \u00222022-12-23T03:46:42Z\u0022, NotAfter: \u00222032-12-20T03:48:42Z\u0022\n2022-12-23T03:48:42.779561Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=istiod.istio-system.svc\u0022, SN: 164bf045670a1716ed3f0f1c89b56122, NotBefore: \u00222022-12-23T03:48:14Z\u0022, NotAfter: \u00222023-01-22T03:48:14Z\u0022\n2022-12-23T03:48:42.779642Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=certmanager-ca,O=cert-manager\u0022, SN: 8533dbfe0b84ed1fc4e3c76be7ef612f, NotBefore: \u00222022-12-20T07:50:12Z\u0022, NotAfter: \u00222025-06-07T07:50:12Z\u0022\n2022-12-23T03:48:42.779657Z\tinfo\tIstiod certificates are reloaded\n\u0060\u0060\u0060\n\n要修改工作负载证书的自动轮换周期，你可以设置 \u0060pilot-agent\u0060 命令的环境变量 \u0060SECRET_TTL\u0060，默认值为 \u006024h0m0s\u0060。\n\n## 总结 {#summary}\n\n在本文中，我们使用了 cert-manager 作为 PKI，将 SPIRE 集成到我们的证书信任链中，并为 Istio 网格中的工作负载创建身份和证书。通过使用 cert-manager，你不用担心 *istiod* 证书过期的问题，还可以根据需要更新证书。你还可以根据需要将 cert-manager 集成到其他证书供应商，如 [Let\u0027s Encrypt](https:\/\/letsencrypt.org\/)、[HashiCorp Vault](https:\/\/www.vaultproject.io\/)、[Venafi](https:\/\/www.venafi.com\/) 等。你也可以使用 [istio-csr](https:\/\/github.com\/cert-manager\/istio-csr) 直接让 cert-manager 来管理 Istio 中的证书，或[使用 Vault 来存储证书](https:\/\/cloudnative.to\/blog\/how-to-use-hashicorp-vault-as-a-more-secure-way-to-store-istio-certificates\/)。\n\n## 参考 {#reference}\n\n- [将 Istio 纳入信任链：使用现有 PKI 作为信任根 - cloudnative.to](https:\/\/cloudnative.to\/blog\/istio-trust\/)\n- [在生产中大规模自动化 Istio CA 轮换 - cloudnative.to](https:\/\/cloudnative.to\/blog\/automate-istio-ca-rotation-in-production-at-scale\/)\n- [如何使用 Hashicorp Vault 作为一种更安全的方式来存储 Istio 证书 - cloudnative.to](https:\/\/cloudnative.to\/blog\/how-to-use-hashicorp-vault-as-a-more-secure-way-to-store-istio-certificates\/)\n- [如何在 Istio 中集成 SPIRE - cloudnative.to](https:\/\/cloudnative.to\/blog\/istio-spire-integration\/)\n- [SPIRE Server Configuration Reference - spiffe.io](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/#built-in-plugins)\n- [Server plugin: UpstreamAuthority \u0022cert-manager\u0022 - github.com](https:\/\/github.com\/spiffe\/spire\/blob\/v1.5.3\/doc\/plugin_server_upstreamauthority_cert_manager.md)\n- [Configuring SPIRE - spiffe.io](https:\/\/spiffe.io\/docs\/latest\/deploying\/configuring\/)\n', '\/blog\/cert-manager-spire-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍如何集成 SPIRE 和使用 cert-manager 实现细粒度的证书管理以及证书轮换。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-trust/">[译] 将 Istio 纳入信任链：使用现有 PKI 作为信任根</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2022/12/20</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tetrate.io/blog/istio-trust/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('将 Istio 纳入信任链：使用现有 PKI 作为信任根', '本文讲解了如何让 Istio 信任现有 PKI 的步骤。', '\n当我们与想要使用 Istio 的客户或用户交流时，这一个问题时长会出现——Istio 中的证书信任如何工作的？Istio 有自己的证书颁发机构，而我们也有自己的证书颁发机构，如何确保它们相互信任？ \n\n简而言之，通过中间签名证书将 Istio 纳入到您现有的信任链中。 \n\n如果您使用 Istio 作为演示或开箱即用，它将拥有自己的自签名证书 —— 它是自己的根证书。对于在多个集群中运行 Istio 的用户来说，这是一个常见的痛点：他们无意中创建了两个互不不信任的孤岛，因此没有安全通信。\n\n以下是如何通过让 Istio 信任您现有的 PKI 的步骤。\n\n## 简述\n\n这是简短的版本：您应该通过为每个 Istio 部署创建一个中间签名证书来让 Istio 信任您现有的 PKI（并且每个集群应该有一个 Istio 部署）。然后你会：\n\n1. 启用跨 Istio 部署的通信\n2. 允许细粒度的证书撤销，而无需同时在整个基础架构中强制使用新证书（如果这听起来像是等待发生的重大中断，那么您是对的）。 \n3. 启用签名证书的轻松轮换。您需要做的就是创建一个新的中间件并使用新证书重新启动 Istio。因为它在同一个信任根中，所以一切都继续工作。 \n\nIstio 必须适应您现有的架构，以在组织内实现增量采用 —— 使网格适应您的组织，而不是让组织来适应网格。从了解对中间证书签名密钥的需求开始，将为您的成功做好准备，并使任何基础架构或环境更改更加顺利。\n\n## 详述\n\n我们先来了解一下证书验证的过程。在基本证书中，证书检查从信任根开始，向下延伸到特定身份（叶子）。证书路径验证算法是我们确保证书可信的方式。当我们使用 TLS 等安全协议连接到另一台机器时，服务器会向我们提供部分或全部证书链以证明其身份。如果链中的证书被确定为无效，则证书链将被拒绝且不会建立信任。如果我们顺利到达链的末端，则路径（以及证书）是有效的。成功！我们可以信任服务器！\n\n![带有叶证书、中间证书和根证书的证书链。服务器可以选择发送整个链，或者只发送一部分；只要有足够的链从根到叶，我们就可以验证证书。](f1.jpg)\n\n当 TLS 握手时，路径验证算法不关心有多少证书链驻留在我们的信任包中。基于我们带来的和他们提供的证书，它只关心我们能否构建一条从服务器的叶节点到我们的捆绑包中的信任根的链。上面的示例显示验证发生在证书交换中，这足以让叶子在证书颁发机构中找到它的位置。 \n\n当您在生产环境中运行 Istio 时，您将拥有多个叶节点和中间节点，但**只有一个根节点。**\n\n![具有根、三个中间签名 CA 和四个叶证书（由树中的各种中间体颁发）的 PKI 证书树。](f2.jpg)\n\n这就是为什么要在现有 PKI 中建立信任，因为有以下三个主要好处：\n\n1. 可以在 Istio 部署之间的交叉通信\n2. 细粒度证书撤销\n3. 轻松轮换证书\n\n### 跨 Istio 部署的通信\n\n对于 Istio，有两种方法可以确保跨部署的通信 —— 简单的方法和困难的方法。 \n\n困难的方法涉及 Istio 运维人员采取耗时、复杂且昂贵的步骤来确保两个根同时在另一个的证书颁发机构 (CA) 捆绑包中。\n\n![我们可以通过确保所有参与方的根都在 CA 捆绑包中来确保跨不同根的信任。如果它们不是彼此信任包的一部分，则来自每个 Citadel 的证书不能用于跨集群通信。](f3.jpg)\n\n简单的方法是为每个部署使用单独的中间签名证书部署 Istio，所有这些证书都共享相同的根。\n\n![当 Citadel 使用来自同一根 PKI 的中间证书时，最容易促进跨集群通信。我们看到与上面相同的 PKI 树，但中间 CA 被标记为不同集群中的 Citadel 实例。](f4.jpg)\n\n当涉及到细粒度撤销和证书轮换时，这一决定的连锁反应是巨大的。\n\n### 细粒度证书撤销\n\n撤销证书会将证书标记为不再受信任。当证书路径验证算法从叶节点走到根节点时，会对每个证书进行吊销状态检查。这使您能够撤销对单个组件或整个部署部分的信任。\n\n![使用与之前相同的 PKI 树，我们展示了在树的一部分中撤销中间 CA 如何使该中间证书以及由它创建的叶证书无效。](f5.jpg)\n\n这很重要，因为如果签名密钥被泄露，恶意行为者可能会通过出示您的客户认为是有效证书来冒充您的服务器。这在 Istio 中更为重要，因为我们使用证书来识别彼此的工作负载 —— 攻击者可以伪装成您网格中的任何服务！ \n\n通常，处理撤销是管理任何 PKI 中最困难的部分。Istio 帮助降低这种风险的方法之一是颁发非常短暂的证书。典型的吊销列表最多可能需要 24 小时才能在整个组织中传播。Istio 颁发的证书有效期少于 12 小时，因此几乎不需要撤销 Istio 颁发的身份证书。您只需要担心为每个 Istio 部署创建的签名证书。\n\n### 轻松轮换证书\n\n与吊销一样，中间证书的轮换更容易。优点包括，如果您能够按集群轮换证书而不是在根节点轮换证书，您将体验到更少的停机时间（以及相关的复杂性，即在任何地方发布一个带有新根的更新的 CA 包）。而且，就像任何好的 PKI 一样，这可以让您使根离线并安全地存储起来。\n\n## 总结\n\n用简单的方法来做！将 Istio 引入您现有的信任根中，以避免痛苦和心痛。中间签名证书的存在是为了让采用 Istio 更容易、更安全。\n', '\/trans\/istio-trust\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文讲解了如何让 Istio 信任现有 PKI 的步骤。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/tags/istio/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/tags/istio/page/5/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/tags/istio/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/tags/istio/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/tags/istio/page/6/" class="page-link">
             6
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/tags/istio/page/7/" class="page-link">
             7
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/tags/istio/page/8/" class="page-link">
             8
           </a>
         </li>
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/tags/istio/page/7/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/tags/istio/page/12/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(77)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(21)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(10)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/ai-ppt-to-hugo/">如何使用通义千问 AI 生成 PPT 并发布到个人网站</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/warp-modern-terminal-tool/">新一代终端工具 Warp：重新定义命令行体验</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/typora-notion-to-obsidian/">为什么我将笔记从 Notion 迁移到 Obsidian？</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />










<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
