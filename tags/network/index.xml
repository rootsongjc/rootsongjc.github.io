<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Network on Jimmy&#39;s blog</title>
    <link>http://rootsongjc.github.io/tags/network/index.xml</link>
    <description>Recent content in Network on Jimmy&#39;s blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="http://rootsongjc.github.io/tags/network/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Contiväººå‘æŒ‡å—-è¯•ç”¨å…¨è®°å½•</title>
      <link>http://rootsongjc.github.io/post/contiv_tryout/</link>
      <pubDate>Thu, 09 Mar 2017 14:23:04 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/post/contiv_tryout/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2017013129.jpg&#34; alt=&#34;é»„æ˜&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(é¢˜å›¾ï¼šåŒ—çº¬37åº¦é»„æµ·ä¹‹æ»¨é£åŠ›å‘ç”µåœºï¼Œå†¬å¤©çš„å¤§é£æŒç»­ç»™äººç±»æä¾›æ¸…æ´çš„èƒ½æºï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;å…³äºcontivçš„ä»‹ç»è¯·çœ‹æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« &lt;a href=&#34;http://rootsongjc.github.io/post/contiv_guide/&#34;&gt;Contiv Intro&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å¼€å‘ç¯å¢ƒä½¿ç”¨&lt;strong&gt;Vagrant&lt;/strong&gt;æ­å»ºï¼Œæ˜¨å¤©è¯•ç”¨äº†ä¸‹ï¼ŒçœŸä¸çŸ¥é“å®ƒä»¬æ˜¯æ€ä¹ˆæƒ³çš„ï¼Œå³ç„¶æ˜¯dockeræ’ä»¶ä¸ºå•¥ä¸ç›´æ¥åœ¨dockerä¸­å¼€å‘å‘¢ï¼Œæˆ‘çš„è¿™ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•æ­å»ºdockerå¼€å‘ç¯å¢ƒï¼Œ&lt;a href=&#34;http://rootsongjc.github.io/post/docker-dev-env/ï¼Œå¯ä»¥åœ¨dockerä¸­å¼€å‘dockerï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ¥å¼€å‘contivå•ŠğŸ˜„ï¼Œåªè¦ä¸‹è½½ä¸€ä¸ªdockeré•œåƒå³å¯`dockercore/docker:latest`ï¼Œä¸è¿‡æœ‰ç‚¹å¤§2.31Gã€‚&#34;&gt;http://rootsongjc.github.io/post/docker-dev-env/ï¼Œå¯ä»¥åœ¨dockerä¸­å¼€å‘dockerï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ¥å¼€å‘contivå•ŠğŸ˜„ï¼Œåªè¦ä¸‹è½½ä¸€ä¸ªdockeré•œåƒå³å¯`dockercore/docker:latest`ï¼Œä¸è¿‡æœ‰ç‚¹å¤§2.31Gã€‚&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;contivæ¦‚å¿µè§£æ&#34;&gt;Contivæ¦‚å¿µè§£æ&lt;/h3&gt;

&lt;p&gt;Contivç”¨äºç»™å®¹å™¨åˆ›å»ºå’Œåˆ†é…ç½‘è·¯ï¼Œå¯ä»¥åˆ›å»ºç­–ç•¥ç®¡ç†å®¹å™¨çš„å®‰å…¨ã€å¸¦å®½ã€ä¼˜å…ˆçº§ç­‰ï¼Œç›¸å½“äºä¸€ä¸ªSDNã€‚&lt;/p&gt;

&lt;h4 id=&#34;group&#34;&gt;Group&lt;/h4&gt;

&lt;p&gt;æŒ‰å®¹å™¨æˆ–Podçš„åŠŸèƒ½ç»™å®¹å™¨åˆ†é…ç­–ç•¥ç»„ï¼Œé€šå¸¸æ˜¯æŒ‰ç…§å®¹å™¨/Podçš„&lt;code&gt;label&lt;/code&gt;æ¥åˆ†ç»„ï¼Œåº”ç”¨ç»„è·Ÿcontivçš„networkä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¯ä»¥å¾ˆå¤šåº”ç”¨ç»„å±äºåŒä¸€ä¸ªnetworkæˆ–IP subnetã€‚&lt;/p&gt;

&lt;h4 id=&#34;polices&#34;&gt;Polices&lt;/h4&gt;

&lt;p&gt;ç”¨æ¥é™å®šgroupçš„è¡Œä¸ºï¼Œcontivæ”¯æŒä¸¤ç§ç±»å‹çš„policyï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Bandwidth é™å®šåº”ç”¨ç»„çš„èµ„æºä½¿ç”¨ä¸Šé™&lt;/li&gt;
&lt;li&gt;Isolation èµ„æºç»„çš„è®¿é—®æƒé™&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Groupå¯ä»¥åŒæ—¶åº”ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªpolicyï¼Œå½“æœ‰å®¹å™¨è°ƒåº¦åˆ°è¯¥groupé‡Œå°±ä¼šé€‚ç”¨è¯¥groupçš„policyã€‚&lt;/p&gt;

&lt;h4 id=&#34;network&#34;&gt;Network&lt;/h4&gt;

&lt;p&gt;IPv4æˆ–IPv6ç½‘ç»œï¼Œå¯ä»¥é…ç½®subnetå’Œgatewayã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Contivä¸­çš„ç½‘ç»œ&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;åœ¨contivä¸­å¯ä»¥é…ç½®ä¸¤ç§ç±»å‹çš„ç½‘ç»œ&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;application networkï¼šå®¹å™¨ä½¿ç”¨çš„ç½‘ç»œ&lt;/li&gt;
&lt;li&gt;infrastructure networkï¼šhost namespaceçš„è™šæ‹Ÿç½‘ç»œï¼Œæ¯”å¦‚åŸºç¡€è®¾æ–½ç›‘æ§ç½‘ç»œ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;ç½‘ç»œå°è£…&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Contivä¸­æœ‰ä¸¤ç§ç±»å‹çš„ç½‘ç»œå°è£…&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Routedï¼šoverlay topologyå’ŒL3-routed BGP topology&lt;/li&gt;
&lt;li&gt;Bridgedï¼šlayer2 VLAN&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;tenant&#34;&gt;Tenant&lt;/h4&gt;

&lt;p&gt;Tenantæä¾›contivä¸­çš„namespaceéš”ç¦»ã€‚ä¸€ä¸ªtenantå¯ä»¥æœ‰å¾ˆå¤šä¸ªnetworkï¼Œæ¯ä¸ªnetworkéƒ½æœ‰ä¸ªsubnetã€‚è¯¥tenantä¸­çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒçš„ä»»æ„networkå’Œsubnetçš„IPã€‚&lt;/p&gt;

&lt;p&gt;ç‰©ç†ç½‘ç»œä¸­çš„tenantç§°ä½œ&lt;code&gt;è™šæ‹Ÿè·¯ç”±è½¬å‘(VRF)&lt;/code&gt;ã€‚Contivä½¿ç”¨VLANå’ŒVXLAN IDæ¥å®ç°å¤–éƒ¨ç½‘ç»œè®¿é—®ï¼Œè¿™å–å†³ä½ ä½¿ç”¨çš„æ˜¯layer2ã€layer3è¿˜æ˜¯Cisco ACIã€‚&lt;/p&gt;

&lt;h3 id=&#34;contivä¸‹è½½&#34;&gt;Contivä¸‹è½½&lt;/h3&gt;

&lt;p&gt;Contivçš„ç¼–è¯‘å®‰è£…æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ç›´æ¥ä¸‹è½½githubä¸Šçš„&lt;a href=&#34;[1.0.0-beta.3-03-08-2017.18-51-20.UTC](https://github.com/contiv/netplugin/releases/tag/1.0.0-beta.3-03-08-2017.18-51-20.UTC)&#34;&gt;release-1.0.0-beta.3-03-08-2017.18-51-20.UTC&lt;/a&gt;æ–‡ä»¶è§£å‹è·å¾—äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/contiv/install/blob/master/README.mdè¿™ä¸ªå®˜æ–¹æ–‡æ¡£å·²ç»è¿‡æ—¶ï¼Œä¸è¦çœ‹äº†ã€‚&#34;&gt;https://github.com/contiv/install/blob/master/README.mdè¿™ä¸ªå®˜æ–¹æ–‡æ¡£å·²ç»è¿‡æ—¶ï¼Œä¸è¦çœ‹äº†ã€‚&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å¦‚æœè¯•ç”¨å¯ä»¥çš„è¯ï¼Œæˆ‘ä¼šåç»­å†™contivå¼€å‘ç¯å¢ƒæ­å»ºçš„æ–‡ç« ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªreleaseæ˜¯2017å¹´3æœˆ8æ—¥å‘å¸ƒçš„ï¼Œå°±åœ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„å‰ä¸€å¤©ã€‚æœ‰ä¸ª&lt;strong&gt;æœ€é‡è¦çš„æ›´æ–°&lt;/strong&gt;æ˜¯&lt;u&gt;æ”¯æŒdocker1.13 swarm mode&lt;/u&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å®‰è£…æ–‡æ¡£ï¼š&lt;a href=&#34;https://github.com/contiv/netplugin/blob/master/install/HowtoSetupContiv.md&#34;&gt;https://github.com/contiv/netplugin/blob/master/install/HowtoSetupContiv.md&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ä¸‹è½½è§£å‹åä¼šå¾—åˆ°å¦‚ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;contivk8s  k8sä¸“ç”¨çš„&lt;/li&gt;
&lt;li&gt;contrib  æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æœ‰ä¸ª&lt;code&gt;netctl&lt;/code&gt;çš„bashè„šæœ¬&lt;/li&gt;
&lt;li&gt;netcontiv  è¿™ä¸ªå‘½ä»¤å°±ä¸€ä¸ª-versioné€‰é¡¹ç”¨æ¥æŸ¥çœ‹contivçš„ç‰ˆæœ¬ğŸ˜“&lt;/li&gt;
&lt;li&gt;netctl  contivå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥é…ç½®ç½‘ç»œã€ç­–ç•¥ã€æœåŠ¡è´Ÿè½½å‡è¡¡ï¼Œ&lt;a href=&#34;http://contiv.github.io/documents/reference/netctlcli.html&#34;&gt;ä½¿ç”¨è¯´æ˜&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;netmaster  contivçš„ä¸»èŠ‚ç‚¹æœåŠ¡&lt;/li&gt;
&lt;li&gt;netplugin&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸‹é¢çš„å®‰è£…ä¸­ç”¨åˆ°çš„åªæœ‰netctlã€netmasterå’Œnetpluginè¿™ä¸‰ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å°†è¿™ä¸‰ä¸ªæ–‡ä»¶éƒ½copyåˆ°/usr/binç›®å½•ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨docker17.03-ceä¸­å®‰è£…contivã€‚&lt;/p&gt;

&lt;h3 id=&#34;contivå®‰è£…ä¾èµ–&#34;&gt;Contivå®‰è£…ä¾èµ–&lt;/h3&gt;

&lt;p&gt;Contivä¾èµ–äºconsulæˆ–etcdï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨etcdï¼Œslacké‡Œçš„äººè¯´åªæ”¯æŒ2.3.xç‰ˆæœ¬ï¼Œå¯èƒ½ä¸æ”¯æŒ3.0+ç‰ˆæœ¬çš„å§ï¼Œè¿˜æ²¡å®é™…æµ‹è¿‡ï¼Œå…ˆä½¿ç”¨2.3.7ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;contiv master&lt;/code&gt;å¯åŠ¨åè‡ªåŠ¨å‘etcdä¸­æ³¨å†Œä¿¡æ¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/contiv.io/oper
/contiv.io/oper/auto-vlan
/contiv.io/oper/auto-vlan/global
/contiv.io/oper/auto-vxlan
/contiv.io/oper/auto-vxlan/global
/contiv.io/oper/global
/contiv.io/oper/global/global
/contiv.io/oper/ovs-driver
/contiv.io/oper/ovs-driver/sz-pg-oam-docker-test-001.tendcloud.com
/contiv.io/master
/contiv.io/master/config
/contiv.io/master/config/global
/contiv.io/obj
/contiv.io/obj/modeldb
/contiv.io/obj/modeldb/global
/contiv.io/obj/modeldb/global/global
/contiv.io/obj/modeldb/tenant
/contiv.io/obj/modeldb/tenant/default
/contiv.io/lock
/contiv.io/lock/netmaster
/contiv.io/lock/netmaster/leader
/contiv.io/service
/contiv.io/service/netmaster
/contiv.io/service/netmaster/172.20.0.113:9999
/contiv.io/service/netmaster.rpc
/contiv.io/service/netmaster.rpc/172.20.0.113:9001
/contiv.io/state
/contiv.io/state/auto-vlan
/contiv.io/state/auto-vlan/global
/contiv.io/state/auto-vxlan
/contiv.io/state/auto-vxlan/global
/contiv.io/state/global
/contiv.io/state/global/global
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;contivå¯åŠ¨&#34;&gt;Contivå¯åŠ¨&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;å¯åŠ¨netmaster&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$nohup netmaster -cluster-mode docker -cluster-store etcd://172.20.0.113:2379 -debug -listen-url 172.20.0.113:9999 -plugin-name netplugin &amp;amp;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸ºäº†çªå‡ºnetmasterå‘½ä»¤çš„ä½¿ç”¨ï¼Œæˆ‘æŠŠæ‰€æœ‰å¯ä»¥ä½¿ç”¨é»˜è®¤å€¼çš„å‚æ•°éƒ½æ˜ç¡®çš„å†™å‡ºã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;netmaster&lt;/code&gt;ç›‘å¬9999ç«¯å£ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹å·²æœ‰çš„contivç½‘ç»œ&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$netctl --netmaster http://172.20.0.113:9999 network ls
Tenant  Network  Nw Type  Encap type  Packet tag  Subnet   Gateway  IPv6Subnet  IPv6Gateway
------  -------  -------  ----------  ----------  -------  ------   ----------  -----------
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸ºäº†ä»¥åæ‰§è¡Œå‘½ä»¤æ–¹ä¾¿ï¼Œä¸ç”¨æ¥å›è¾“å…¥&lt;code&gt;$NETMASTER&lt;/code&gt;åœ°å€ï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡&lt;/p&gt;

&lt;p&gt;&lt;code&gt;export NETMASTER=&amp;quot;http://172.20.0.113:9999&amp;quot;&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;netpluginéœ€è¦ä½¿ç”¨Open vSwitchï¼Œæ‰€ä»¥ä½ éœ€è¦å…ˆå®‰è£…&lt;strong&gt;Open vSwitch&lt;/strong&gt;ã€‚å¦åˆ™ä½ ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜&lt;a href=&#34;https://github.com/contiv/netplugin/issues/760&#34;&gt;netplugin issue-760&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;open-vswitchå®‰è£…&#34;&gt;Open vSwitchå®‰è£…&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://supercomputing.caltech.edu/blog/index.php/2016/05/03/open-vswitch-installation-on-centos-7-2/&#34;&gt;Open vSwitch installation on CentOS7.2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å‚è€ƒä¸Šé¢é“¾æ¥é‡Œçš„æ–¹æ³•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;#!/bin/bash
yum -y install make gcc openssl-devel autoconf automake rpm-build redhat-rpm-config python-devel openssl-devel kernel-devel kernel-debug-devel libtool wget
mkdir -p ~/rpmbuild/SOURCES
cp openvswitch-2.5.1.tar.gz ~/rpmbuild/SOURCES/
tar xfz openvswitch-2.5.1.tar.gz
sed &#39;s/openvswitch-kmod, //g&#39; openvswitch-2.5.1/rhel/openvswitch.spec &amp;gt; openvswitch-2.5.1/rhel/openvswitch_no_kmod.spec
rpmbuild -bb --nocheck ~/openvswitch-2.5.1/rhel/openvswitch_no_kmod.spec
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¯‘å¥½çš„rpmåŒ…åœ¨&lt;code&gt;~/rpmbuild/RPMS/x86_64/openvswitch-2.5.1-1.x86_64.rpm&lt;/code&gt;ç›®å½•ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;å®‰è£…å¥½Open vSwitchåå°±å¯ä»¥å¯åŠ¨&lt;strong&gt;netplugin&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åˆ›å»ºcontivç½‘ç»œ&#34;&gt;åˆ›å»ºcontivç½‘ç»œ&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;å¯åŠ¨netplugin&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;nohup netplugin -cluster-store etcd://172.20.0.113:2379 &amp;amp;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºnetwork&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;netctl --netmaster http://172.20.0.113:9999 network create --subnet=10.1.2.0/24 contiv-net&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;è·å¾—ä»¥ä¸‹æŠ¥é”™ï¼š&lt;/p&gt;

&lt;p&gt;ERRO[0000] Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯æ‰§è¡Œç¬¬äºŒæ¬¡çš„æ—¶å€™å±…ç„¶æˆåŠŸäº†ï¼Œä¸è¿‡å½“æˆ‘æŸ¥çœ‹docker networkçš„æ—¶å€™æ ¹æœ¬å°±çœ‹ä¸åˆ°åˆšåˆšåˆ›å»ºçš„contiv-netç½‘ç»œã€‚*è¿™åªæ˜¯ä¸€åœºæ¸¸æˆä¸€åœºæ¢¦ã€‚ã€‚ã€‚*ğŸ˜¢&lt;/p&gt;

&lt;p&gt;Creating network default:contiv-net&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$netctl network ls
Tenant   Network     Nw Type  Encap type  Packet tag  Subnet       Gateway  IPv6Subnet  IPv6Gateway
------   -------     -------  ----------  ----------  -------      ------   ----------  -----------
default  contiv-net  data     vxlan       0           10.1.2.0/24  
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹åˆšåˆ›å»ºçš„contiv-netç½‘ç»œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$netctl network inspect contiv-net
Inspeting network: contiv-net tenant: default
{
  &amp;quot;Config&amp;quot;: {
    &amp;quot;key&amp;quot;: &amp;quot;default:contiv-net&amp;quot;,
    &amp;quot;encap&amp;quot;: &amp;quot;vxlan&amp;quot;,
    &amp;quot;networkName&amp;quot;: &amp;quot;contiv-net&amp;quot;,
    &amp;quot;nwType&amp;quot;: &amp;quot;data&amp;quot;,
    &amp;quot;subnet&amp;quot;: &amp;quot;10.1.2.0/24&amp;quot;,
    &amp;quot;tenantName&amp;quot;: &amp;quot;default&amp;quot;,
    &amp;quot;link-sets&amp;quot;: {},
    &amp;quot;links&amp;quot;: {
      &amp;quot;Tenant&amp;quot;: {
        &amp;quot;type&amp;quot;: &amp;quot;tenant&amp;quot;,
        &amp;quot;key&amp;quot;: &amp;quot;default&amp;quot;
      }
    }
  },
  &amp;quot;Oper&amp;quot;: {
    &amp;quot;availableIPAddresses&amp;quot;: &amp;quot;10.1.2.1-10.1.2.254&amp;quot;,
    &amp;quot;externalPktTag&amp;quot;: 1,
    &amp;quot;pktTag&amp;quot;: 1
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»&lt;strong&gt;netmaster&lt;/strong&gt;æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;time=&amp;quot;Mar  9 21:44:14.746627381&amp;quot; level=debug msg=&amp;quot;NwInfra type is default, no ACI&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.750278056&amp;quot; level=info msg=&amp;quot;Creating docker network: {CheckDuplicate:true Driver:netplugin EnableIPv6:false IPAM:0xc4204d8ea0 Internal:false Attachable:true Options:map[tenant:default encap:vxlan pkt-tag:1] Labels:map[]}&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752034749&amp;quot; level=error msg=&amp;quot;Error creating network contiv-net. Err: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752067294&amp;quot; level=error msg=&amp;quot;Error creating network contiv-net.default in docker. Err: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752102735&amp;quot; level=error msg=&amp;quot;Error creating network {&amp;amp;{Key:default:contiv-net Encap:vxlan Gateway: Ipv6Gateway: Ipv6Subnet: NetworkName:contiv-net NwType:data PktTag:0 Subnet:10.1.2.0/24 TenantName:default LinkSets:{EndpointGroups:map[] Servicelbs:map[] Services:map[]} Links:{Tenant:{ObjType: ObjKey:}}}}. Err: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752129195&amp;quot; level=error msg=&amp;quot;NetworkCreate retruned error for: &amp;amp;{Key:default:contiv-net Encap:vxlan Gateway: Ipv6Gateway: Ipv6Subnet: NetworkName:contiv-net NwType:data PktTag:0 Subnet:10.1.2.0/24 TenantName:default LinkSets:{EndpointGroups:map[] Servicelbs:map[] Services:map[]} Links:{Tenant:{ObjType: ObjKey:}}}. Err: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752155973&amp;quot; level=error msg=&amp;quot;CreateNetwork error for: {Key:default:contiv-net Encap:vxlan Gateway: Ipv6Gateway: Ipv6Subnet: NetworkName:contiv-net NwType:data PktTag:0 Subnet:10.1.2.0/24 TenantName:default LinkSets:{EndpointGroups:map[] Servicelbs:map[] Services:map[]} Links:{Tenant:{ObjType: ObjKey:}}}. Err: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
time=&amp;quot;Mar  9 21:44:14.752172138&amp;quot; level=error msg=&amp;quot;Handler for POST /api/v1/networks/default:contiv-net/ returned error: Error response from daemon: legacy plugin netplugin of type NetworkDriver is not supported in swarm mode&amp;quot; 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h3&gt;

&lt;p&gt;ä»æ—¥å¿—ä¸­çœ‹åˆ°ä¸€ä¸ªä»¤äººæ‚²ç—›è¯­å¥çš„è¯*legacy plugin netplugin of type NetworkDriver is not supported in swarm mode*ï¼Œä½ ä»¬æ˜¨å¤©ä¸æ˜¯åˆšå‘çš„ç‰ˆæœ¬è¯´å·²ç»æ”¯æŒswarm modeå—ï¼Ÿ&lt;a href=&#34;https://github.com/contiv/netplugin/commit/8afd1b7718c8424a876760d18484124e0aad3557&#34;&gt;&lt;code&gt;commit-8afd1b7&lt;/code&gt;&lt;/a&gt;ä¸æ˜¯ç™½çº¸é»‘å­—çš„å†™ç€å—ï¼Ÿ&lt;/p&gt;

&lt;p&gt;æˆ‘æäº†ä¸ª&lt;a href=&#34;https://github.com/contiv/netplugin/issues/776&#34;&gt;issue-776&lt;/a&gt;ï¼Œçœ‹çœ‹æ€æ ·è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦å¤–netpluginå‘½ä»¤æ€ä¹ˆç”¨ï¼Œæ–‡æ¡£ä¸Šæ²¡å†™å•Šï¼Ÿ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;netplugin -h&lt;/code&gt;å¯ä»¥ä¸­æœ‰ä¸¤ä¸ªé€‰é¡¹æˆ‘ä¸æ˜ç™½ï¼Œä¸çŸ¥é“æ€ä¹ˆè®¾ç½®ï¼Œæœ‰çŸ¥é“çš„äººè¯·å‘Šè¯‰æˆ‘ä¸€å£°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  -vlan-if value
    	VLAN uplink interface
  -vtep-ip string
    	My VTEP ip address
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ—¶æˆ‘ä¼šç»§ç»­å…³æ³¨contivçš„slackå’Œgithub &lt;a href=&#34;https://github.com/contiv/netplugin/issues/776&#34;&gt;Issue-776&lt;/a&gt;çš„è¿›å±•ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Contiv Intro</title>
      <link>http://rootsongjc.github.io/post/contiv_guide/</link>
      <pubDate>Thu, 09 Mar 2017 11:28:34 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/post/contiv_guide/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://olz1di9xf.bkt.clouddn.com/2017021162.jpg&#34; alt=&#34;è“è‰²æ¸¯æ¹¾&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(é¢˜å›¾ï¼šåŒ—äº¬è“è‰²æ¸¯æ¹¾å¤œæ™¯)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Contiv&lt;/strong&gt;æ˜¯æ€ç§‘å¼€å‘çš„dockerç½‘ç»œæ’ä»¶ï¼Œä»2015å¹´å°±å¼€æºäº†ï¼Œä¸šç•Œé€šå¸¸æ‹¿å®ƒå’ŒCalicoæ¯”è¾ƒã€‚è²Œä¼¼Contivä»¥å‰è¿˜å¼€å‘è¿‡volume pluginï¼Œç°åœ¨é”€å£°åŒ¿è¿¹äº†ï¼Œåªæœ‰netpluginä»åœ¨æ´»è·ƒå¼€å‘ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://dockone.io/article/1935&#34;&gt;å®¹å™¨ç½‘ç»œæ’ä»¶ Calico ä¸ Contiv Netpluginæ·±å…¥æ¯”è¾ƒ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿˜æœ‰ç¯‡æ–‡ç« è®²è§£äº†&lt;a href=&#34;http://blog.dataman-inc.com/shurenyun-docker-133/&#34;&gt;dockerç½‘ç»œæ–¹æ¡ˆçš„æ”¹è¿›&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;contiv-netplugin-ç®€ä»‹&#34;&gt;Contiv Netplugin ç®€ä»‹&lt;/h3&gt;

&lt;p&gt;Contiv Netplugin æ˜¯æ¥è‡ªæ€ç§‘çš„è§£å†³æ–¹æ¡ˆã€‚ç¼–ç¨‹è¯­è¨€ä¸º Goã€‚å®ƒåŸºäº OpenvSwitchï¼Œä»¥æ’ä»¶åŒ–çš„å½¢å¼æ”¯æŒå®¹å™¨è®¿é—®ç½‘ç»œï¼Œæ”¯æŒ VLANï¼ŒVxlanï¼Œå¤šç§Ÿæˆ·ï¼Œä¸»æœºè®¿é—®æ§åˆ¶ç­–ç•¥ç­‰ã€‚ä½œä¸ºæ€ç§‘æ•´ä½“æ”¯æŒå®¹å™¨åŸºç¡€è®¾æ–½contivé¡¹ç›®çš„ç½‘ç»œéƒ¨åˆ†ï¼Œæœ€å¤§çš„äº®ç‚¹åœ¨äºå®¹å™¨è¢«èµ‹äºˆäº† SDN èƒ½åŠ›ï¼Œå®ç°å¯¹å®¹å™¨æ›´ç»†ç²’åº¦ï¼Œæ›´ä¸°å¯Œçš„è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚å¦å¤–ï¼Œå¯¹ Docker CNM ç½‘ç»œæ¨¡å‹çš„æ”¯æŒï¼Œå¹¶å†…ç½®äº† IPAM æ¥å£ï¼Œä¸ä»…ä»…æä¾›äº†ä¸€å®¹å™¨ä¸€ IPï¼Œè€Œä¸”å®¹å™¨çš„ç½‘ç»œä¿¡æ¯è¢«è®°å½•çš„å®¹å™¨é…ç½®ä¸­ï¼Œä¼´éšç€å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå‡ä½å› ä¸ºçŠ¶æ€ä¸åŒæ­¥é€ æˆç½‘ç»œä¿¡æ¯ä¸¢å¤±çš„é£é™©ã€‚æœ‰åˆ«äº CNIï¼Œè¿™ç§å†…èšåŒ–çš„è®¾è®¡æœ‰åˆ©äºå‡å°‘å¯¹ç¬¬ä¸‰æ–¹æ¨¡å—çš„ä¾èµ–ã€‚éšç€é¡¹ç›®çš„å‘å±•ï¼Œé™¤äº† Dockerï¼Œè¿˜æä¾›äº†å¯¹ Kubernetes ä»¥åŠ Mesos çš„æ”¯æŒï¼Œå³ CNI æ¥å£ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://dockerone.com/uploads/article/20161221/c737f78ce7c50c84e49648aaf771a6b4.png&#34;&gt;&lt;img src=&#34;http://dockerone.com/uploads/article/20161221/c737f78ce7c50c84e49648aaf771a6b4.png&#34; alt=&#34;9260E9B7-43C0-48B8-B5C7-CF8B952959D2.png&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Netmaster åå°è¿›ç¨‹è´Ÿè´£è®°å½•æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ï¼Œä¿å­˜ç½‘ç»œä¿¡æ¯ï¼Œåˆ†é… IP åœ°å€&lt;/li&gt;
&lt;li&gt;Netplugin åå°è¿›ç¨‹ä½œä¸ºæ¯ä¸ªå®¿ä¸»æœºä¸Šçš„ Agent ä¸ Docker åŠ OVS é€šä¿¡ï¼Œå¤„ç†æ¥è‡ª Docker çš„è¯·æ±‚ï¼Œç®¡ç† OVSã€‚Docker æ–¹é¢æ¥å£ä¸º remote driverï¼ŒåŒ…æ‹¬ä¸€ç³»åˆ— Docker å®šä¹‰çš„ JSON-RPC(POST) æ¶ˆæ¯ã€‚OVS æ–¹é¢æ¥å£ä¸º remote ovsdbï¼Œä¹Ÿæ˜¯ JSON-RPC æ¶ˆæ¯ã€‚ä»¥ä¸Šæ¶ˆæ¯éƒ½åœ¨ localhost ä¸Šå¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;é›†ç¾¤ç®¡ç†ä¾èµ– etcd/serf&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;http://dockerone.com/uploads/article/20161221/852b276222482c4740b690eb7f078409.png&#34;&gt;&lt;img src=&#34;http://dockerone.com/uploads/article/20161221/852b276222482c4740b690eb7f078409.png&#34; alt=&#34;580469BC-468C-49C8-B29E-8B88143AFE0A.png&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;netpluginçš„ä¼˜åŠ¿&#34;&gt;Netpluginçš„ä¼˜åŠ¿&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;è¾ƒæ—©æ”¯æŒCNMæ¨¡å‹ã€‚ä¸å·²æœ‰çš„ç½‘ç»œåŸºç¡€è®¾æ–½å…¼å®¹æ€§è¾ƒé«˜ï¼Œæ”¹é€ å½±å“å°ã€‚åŸºäºVLANçš„å¹³è¡Œæ‰©å±•ä¸ç°æœ‰ç½‘ç»œç»“æ„åœ°ä½å¯¹ç­‰&lt;/li&gt;
&lt;li&gt;SDNèƒ½åŠ›ï¼Œèƒ½å¤Ÿå¯¹å®¹å™¨çš„ç½‘ç»œè®¿é—®åšæ›´ç²¾ç»†çš„æ§åˆ¶&lt;/li&gt;
&lt;li&gt;å¤šç§Ÿæˆ·æ”¯æŒï¼Œå…·å¤‡æœªæ¥å‘æ··åˆäº‘/å…¬æœ‰äº‘è¿ç§»çš„æ½œåŠ›&lt;/li&gt;
&lt;li&gt;ä»£ç è§„æ¨¡ä¸å¤§ï¼Œé€»è¾‘ç»“æ„æ¸…æ™°ï¼Œå¹¶å‘å¥½ï¼ŒVLANåœ¨å…¬å¸å†…éƒ¨æœ‰å¼€å‘éƒ¨ç½²è¿ç»´å®è·µç»éªŒï¼Œç¨³å®šæ€§ç»è¿‡ç”Ÿäº§ç¯å¢ƒéªŒè¯&lt;/li&gt;
&lt;li&gt;&lt;u&gt;&lt;strong&gt;äº¬ä¸œ&lt;/strong&gt;åŸºäºç›¸åŒçš„æŠ€æœ¯æ ˆï¼ˆOVS + VLANï¼‰å·²æ”¯æŒ10w+ å®¹å™¨çš„è¿è¡Œã€‚&lt;/u&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;next&#34;&gt;Next&lt;/h3&gt;

&lt;p&gt;åç»­æ–‡ç« ä¼šè®²è§£contiv netpluginçš„ç¯å¢ƒé…ç½®å’Œå¼€å‘ã€‚ç›®å‰è¿˜åœ¨1.0-betaç‰ˆæœ¬ã€‚&lt;strong&gt;Docker store&lt;/strong&gt;ä¸Šæä¾›äº†contivæ’ä»¶çš„&lt;a href=&#34;https://store.docker.com/plugins/803eecee-0780-401a-a454-e9523ccf86b3&#34;&gt;ä¸‹è½½åœ°å€&lt;/a&gt;ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>docker service discovery</title>
      <link>http://rootsongjc.github.io/post/docker-service-discovery/</link>
      <pubDate>Mon, 27 Feb 2017 18:27:07 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/post/docker-service-discovery/</guid>
      <description>&lt;p&gt;Prior to Docker 1.12 release, setting up Swarm cluster needed some sort ofÂ &lt;a href=&#34;https://docs.docker.com/v1.11/swarm/discovery/&#34;&gt;service discovery backend&lt;/a&gt;. There are multiple discovery backends available like hosted discovery service, using a static file describing the cluster, etcd, consul, zookeeper or using static list of IP address.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pic-intro.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pic-intro.png&#34; alt=&#34;pic-intro&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Thanks to Docker 1.12 Swarm Mode&lt;/strong&gt;, we donâ€™t have to depend upon these external tools and complex configurations.Â &lt;a href=&#34;https://github.com/docker/docker/releases/tag/v1.12.0-rc5&#34;&gt;Docker Engine 1.12&lt;/a&gt;Â runs itâ€™s own internal DNS service to route services by name.Swarm manager nodes assign each service in the swarm a unique DNS name and load balances running containers. You can query every container running in the swarm through a DNS server embedded in the swarm.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;How does it help?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;When you create a service and provide a name for it, you can use just that name as a target hostname, and itâ€™s going to be automatically resolved to the proper container IP of the service. In short, within the swarm, containers can simply reference other services via their names and the built-in DNS will be used to find the appropriate IP and port automatically. It is important to note thatÂ if the service has multiple replicas,Â &lt;strong&gt;the requests would be round-robin load-balanced&lt;/strong&gt;. This would still work if you didnâ€™t forward any ports when you created your docker services.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic10.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic10.png&#34; alt=&#34;Pic10&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Embedded DNS is not a new concept. It was first included under Docker 1.10 release. Please note thatÂ DNS lookup for containers connected to user-defined networks works differently compared to the containers connected toÂ &lt;code&gt;default bridge&lt;/code&gt;Â network.Â As of Docker 1.10, the docker daemon implements an embedded DNS server which provides built-in service discovery for any container created with a validÂ &lt;code&gt;name&lt;/code&gt;Â orÂ &lt;code&gt;net-alias&lt;/code&gt;Â or aliased byÂ &lt;code&gt;link&lt;/code&gt;. Moreover,container name configured usingÂ &lt;code&gt;--name&lt;/code&gt;Â is used to discover a container within an user-defined docker network. The embedded DNS server maintains the mapping between the container name and its IP address (on the network the container is connected to).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;How does Embedded DNS resolve unqualified names?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic22.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic22.png&#34; alt=&#34;Pic22&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Â &lt;/p&gt;

&lt;p&gt;With Docker 1.12 release, a new API called â€œserviceâ€ is being included which clearly talks about theÂ functionality of service discovery. Â It is important to noteÂ that Service discovery is scoped within the network. What it really means is â€“ Â If youÂ have redis application and web client as two separate services , you combine into single application and put them into same network.If you try build your application in such a way that you are trying to reach to redis through name â€œredisâ€,it will always resolve to name â€œredisâ€. Reason â€“ both of these services are part of the same network.Â You donâ€™t need to be inside the application trying to resolve this service using FQDN. Reason â€“ FQDNÂ name is not going to be portable which in turn, makes your application non-portable.&lt;/p&gt;

&lt;p&gt;Internally, there is a listener opened inside the container itself. If we try to enter into the container which is providing a service discovery and look at /etc/resolv.conf, we will find that the nameserver entry holds something really different like 127.0.0.11.This is nothing but a loopback address. So, whenever resolver tried to resolve, it will resolve to 127.0.0.11 and this request is rightly trapped.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-12.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-12.png&#34; alt=&#34;Pic-12&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Once this request is trapped, it isÂ sent to particular random UDP / TCP port currently being listened under theÂ docker daemon. Consequently, theÂ socket is to be created inside the namespace. When DNS server and daemon gets the request, it knows that this is coming from which specific network, hence gets aware ofÂ Â the context of from where it is coming from.Once it knows the context, it can generate the appropriate DNS response.&lt;/p&gt;

&lt;p&gt;To demonstrate Service Discovery Â under Docker 1.12, I have upgraded Docker 1.12.rc5 to 1.12.0 GA version. The swarm cluster look like:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pico01.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pico01.png&#34; alt=&#34;Pico01&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have created a network called â€œcollabnetâ€ for the new services as shown below:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-2.jpg&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-2.jpg&#34; alt=&#34;Pic-2&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Letâ€™s create a service called â€œwordpressdbâ€ under collabnet network :&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-mysql.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-mysql.png&#34; alt=&#34;pico-mysql&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can list the running tasks(containers) and the node on which these containers are running on:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-4.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic-4.png&#34; alt=&#34;Pic-4&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Letâ€™s create another service called â€œwordpressappâ€ under the same network:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-app.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-app.png&#34; alt=&#34;pico-app&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now, we can list out the number ofÂ services running on our swarm cluster as shown below.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-2.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-2.png&#34; alt=&#34;pico-2&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have scaled out the number of wordpressapp and wordpressdb just for demonstration purpose.&lt;/p&gt;

&lt;p&gt;Letâ€™s consider my master node where I have two of the containers running as shown below:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pico-1.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pico-1.png&#34; alt=&#34;Pico-1&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I can reach out one service(wordpressapp) from another service(wordpressapp) through just service-name as shown below:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-last.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-last.png&#34; alt=&#34;pico-last&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, I can reach out to particular container by its name from other container running different service but on the same network. As shown below, I can reach out toÂ wordpressapp.3.6f8bthp container viaÂ wordpressdb.7.e62jl57qqu running wordpressdb.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-tasktoo.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-tasktoo.png&#34; alt=&#34;pico-tasktoo&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The below picture depicts the Service Discovery in a nutshell:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic23.png&#34; alt=&#34;Pic23&#34; /&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Every service has Virtual IP(VIP) associated which can be derived as shown below:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pic-list.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pic-list.png&#34; alt=&#34;pic-list&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As shown above,Â each service has an IP address and this IP address maps to multiple container IP address associated with that service. It is important to note thatÂ service IP associated with a service does not change even though containers associated with the service dies/ restarts.&lt;/p&gt;

&lt;p&gt;Few important points to remember:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;VIP based services use Linux IPVS load balancing to route to the backend containers. This works only for TCP/UDP protocols. When you use DNS-RR mode services donâ€™t have a VIP allocated. Instead service names resolves to one of the backend container IPs randomly.&lt;/li&gt;
&lt;li&gt;Ping not working for VIP is as designed. Technically, IPVS is a TCP/UDP load-balancer, while ping uses ICMP and hence IPVS is not going to load-balance the ping request.&lt;/li&gt;
&lt;li&gt;For VIP based services the reason ping works on the local node is because the VIP is added a 2nd IP address on the overlay network interface&lt;/li&gt;
&lt;li&gt;You can any of the tools like Â dig, nslookup or wget -O- &lt;service name&gt; to demonstrate the service discovery functionality&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Below picture depicts that the network is the scope of service discoverability which means that when you have a service running on one network , it is scoped to that network and wonâ€™t be able to reach out to different service running on different network(unless it is part of that network).&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/SD.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/SD.png&#34; alt=&#34;SD&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Letâ€™s dig littleÂ further introducing Load-balancing aspect too. To see what is basically enabling the load-balancingÂ functionality, we can go into sandbox of each containers and see how it has been resolved.&lt;/p&gt;

&lt;p&gt;Letâ€™s pick up the two containers running on the master node. We can see the sandbox running through the following command:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-namespace.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-namespace.png&#34; alt=&#34;pico-namespace&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Under /var/run/docker/netns, you will find various namespaces. The namespaces marked with x-{id} represents network namespace managed by the overlay network driver for its operation (such as creating a bridge, terminating vxlan tunnel, etcâ€¦). They donâ€™t represent the container network namespace. Since it is managed by the driver, it is not recommended to manipulate anything within this namespace. But if you are curious on the deep dive, then you can use the â€œnsenterâ€ tool to understand more about this internal namespace.&lt;/p&gt;

&lt;p&gt;We can enter into sandbox through the nsenter utility:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-mangle.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/pico-mangle.png&#34; alt=&#34;pico-mangle&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In case you faced an error stating â€œnsenter: reassociate to namespace â€˜ns/netâ€™ failed: Invalid argumentâ€, I suggest to look atÂ &lt;a href=&#34;http://tinyurl.com/gu5rsw9&#34;&gt;this&lt;/a&gt;Â workaround.&lt;/p&gt;

&lt;p&gt;10.0.3.4 service IP is marked 0x108 using iptables OUTPUT chain. ipvs uses this marking and load balances it to containers 10.0.3.5 and 10.0.3.6 as shown below:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/ipvs.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/ipvs.png&#34; alt=&#34;ipvs&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here are key takeaways from this entire post:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic34.png&#34;&gt;&lt;img src=&#34;http://collabnix.com/wp-content/uploads/2016/07/Pic34.png&#34; alt=&#34;Pic34&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From &lt;a href=&#34;http://collabnix.com/archives/1504&#34;&gt;http://collabnix.com/archives/1504&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>docker embedded dns</title>
      <link>http://rootsongjc.github.io/post/docker-embedded-dns/</link>
      <pubDate>Mon, 27 Feb 2017 18:23:42 +0800</pubDate>
      
      <guid>http://rootsongjc.github.io/post/docker-embedded-dns/</guid>
      <description>

&lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»äº†&lt;a href=&#34;http://lib.csdn.net/base/docker&#34;&gt;Docker&lt;/a&gt;å®¹å™¨çš„DNSé…ç½®åŠå…¶æ³¨æ„ç‚¹ï¼Œé‡ç‚¹å¯¹docker 1.10å‘å¸ƒçš„embedded DNS serverè¿›è¡Œäº†æºç åˆ†æï¼Œçœ‹çœ‹embedded DNS serveråˆ°åº•æ˜¯ä¸ªå•¥ï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;configure-container-dns&#34;&gt;Configure container DNS&lt;/h2&gt;

&lt;h3 id=&#34;dns-in-default-bridge-network&#34;&gt;DNS in default bridge network&lt;/h3&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Options&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;-h HOSTNAME or â€“hostname=HOSTNAME&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†HOSTNAMEè®¾ç½®åˆ°å®¹å™¨å†…çš„/etc/hosts, /etc/hostname, /bin/bashæç¤ºä¸­ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“link=CONTAINER_NAME or ID:ALIAS&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†ALIASå’ŒCONTAINER_NAME/IDå¯¹åº”çš„å®¹å™¨IPæ·»åŠ åˆ°/etc/hosts. å¦‚æœ CONTAINER_NAME/IDæœ‰å¤šä¸ªIPåœ°å€ ï¼Ÿ&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns=IP_ADDRESSâ€¦&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†&lt;code&gt;nameserver IP_ADDRESS&lt;/code&gt;æ·»åŠ åˆ°å®¹å™¨å†…çš„/etc/resolv.confä¸­ã€‚å¯ä»¥é…ç½®å¤šä¸ªã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns-search=DOMAINâ€¦&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†DOMAINæ·»åŠ åˆ°å®¹å™¨å†…/etc/resolv.confçš„dns searchåˆ—è¡¨ä¸­ã€‚å¯ä»¥é…ç½®å¤šä¸ªã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns-opt=OPTIONâ€¦&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†OPTIONæ·»åŠ åˆ°å®¹å™¨å†…/etc/resolv.confä¸­çš„optionsé€‰é¡¹ä¸­ï¼Œå¯ä»¥é…ç½®å¤šä¸ªã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœdocker runæ—¶ä¸å«&lt;code&gt;--dns=IP_ADDRESS..., --dns-search=DOMAIN..., or --dns-opt=OPTION...&lt;/code&gt;å‚æ•°ï¼Œdocker daemonä¼šå°†copyæœ¬ä¸»æœºçš„/etc/resolv.confï¼Œç„¶åå¯¹è¯¥copyè¿›è¡Œå¤„ç†ï¼ˆå°†é‚£äº›/etc/resolv.confä¸­pingä¸é€šçš„nameserveré¡¹ç»™æŠ›å¼ƒï¼‰,å¤„ç†å®Œæˆåç•™ä¸‹çš„éƒ¨åˆ†å°±ä½œä¸ºè¯¥å®¹å™¨å†…éƒ¨çš„/etc/resolv.confã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³åˆ©ç”¨å®¿ä¸»æœºä¸­çš„/etc/resolv.confé…ç½®çš„nameserverè¿›è¡ŒåŸŸåè§£æï¼Œé‚£ä¹ˆä½ éœ€è¦å®¿ä¸»æœºä¸­è¯¥dns serviceé…ç½®ä¸€ä¸ªå®¿ä¸»æœºå†…å®¹å™¨èƒ½pingé€šçš„IPã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå®¿ä¸»æœºçš„/etc/resolv.confå†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œdocker daemonæœ‰ä¸€ä¸ªå¯¹åº”çš„file change notifierä¼šwatchåˆ°è¿™ä¸€å˜åŒ–ï¼Œç„¶åæ ¹æ®å®¹å™¨çŠ¶æ€é‡‡å–å¯¹åº”çš„æªæ–½ï¼š

&lt;ul&gt;
&lt;li&gt;å¦‚æœå®¹å™¨çŠ¶æ€ä¸ºstoppedï¼Œåˆ™ç«‹åˆ»æ ¹æ®å®¿ä¸»æœºçš„/etc/resolv.confå†…å®¹æ›´æ–°å®¹å™¨å†…çš„/etc/resolv.conf.&lt;/li&gt;
&lt;li&gt;å¦‚æœå®¹å™¨çŠ¶æ€ä¸ºrunningï¼Œåˆ™å®¹å™¨å†…çš„/etc/resolv.confå°†ä¸ä¼šæ”¹å˜ï¼Œç›´åˆ°è¯¥å®¹å™¨çŠ¶æ€å˜ä¸ºstopped.&lt;/li&gt;
&lt;li&gt;å¦‚æœå®¹å™¨å¯åŠ¨åä¿®æ”¹è¿‡å®¹å™¨å†…çš„/etc/resolv.confï¼Œåˆ™ä¸ä¼šå¯¹è¯¥å®¹å™¨è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸¢å¤±å·²ç»å®Œæˆçš„ä¿®æ”¹ï¼Œæ— è®ºè¯¥å®¹å™¨ä¸ºä»€ä¹ˆçŠ¶æ€ã€‚Â 
å¦‚æœå®¹å™¨å¯åŠ¨æ—¶ï¼Œç”¨äº†â€“dns, â€“dns-search, or â€“dns-opté€‰é¡¹ï¼Œå…¶å¯åŠ¨æ—¶å·²ç»ä¿®æ”¹äº†å®¿ä¸»æœºçš„/etc/resolv.confè¿‡æ»¤åçš„å†…å®¹ï¼Œå› æ­¤docker daemonæ°¸è¿œä¸ä¼šæ›´æ–°è¿™ç§å®¹å™¨çš„/etc/resolv.confã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ³¨æ„&lt;/strong&gt;: docker daemonç›‘æ§å®¿ä¸»æœº/etc/resolv.confçš„è¿™ä¸ªfile change notifierçš„å®ç°æ˜¯ä¾èµ–linuxå†…æ ¸çš„inotifyç‰¹æ€§ï¼Œè€Œinotfyç‰¹æ€§ä¸å…¼å®¹overlay fsï¼Œå› æ­¤ä½¿ç”¨overlay fs driverçš„docker deamonå°†æ— æ³•ä½¿ç”¨è¯¥/etc/resolv.confè‡ªåŠ¨æ›´æ–°çš„åŠŸèƒ½ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;embedded-dns-in-user-defined-networks&#34;&gt;Embedded DNS in user-defined networks&lt;/h3&gt;

&lt;p&gt;åœ¨docker 1.10ç‰ˆæœ¬ä¸­ï¼Œdocker daemonå®ç°äº†ä¸€ä¸ªå«åš&lt;code&gt;embedded DNS server&lt;/code&gt;çš„ä¸œè¥¿ï¼Œç”¨æ¥å½“ä½ åˆ›å»ºçš„å®¹å™¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œï¼›&lt;/li&gt;
&lt;li&gt;å®¹å™¨åˆ›å»ºæ—¶å€™é€šè¿‡&lt;code&gt;--name&lt;/code&gt;,&lt;code&gt;--network-alias&lt;/code&gt;Â orÂ &lt;code&gt;--link&lt;/code&gt;æä¾›äº†ä¸€ä¸ªnameï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;docker daemonå°±ä¼šåˆ©ç”¨embedded DNS serverå¯¹æ•´ä¸ªè‡ªå®šä¹‰ç½‘ç»œä¸­æ‰€æœ‰å®¹å™¨è¿›è¡Œåå­—è§£æï¼ˆä½ å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç½‘ç»œä¸­çš„ä¸€ç§æœåŠ¡å‘ç°ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤å½“ä½ å¯åŠ¨å®¹å™¨æ—¶å€™æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶ï¼Œè¯¥å®¹å™¨çš„åŸŸåè§£æå°±ä¸åº”è¯¥å»è€ƒè™‘å®¹å™¨å†…çš„/etc/hosts, /etc/resolv.confï¼Œåº”è¯¥ä¿æŒå…¶ä¸å˜ï¼Œç”šè‡³ä¸ºç©ºï¼Œå°†éœ€è¦è§£æçš„åŸŸåéƒ½é…ç½®åˆ°å¯¹åº”embedded DNS serverä¸­ã€‚å…·ä½“é…ç½®å‚æ•°åŠè¯´æ˜å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Options&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;â€“name=CONTAINER-NAME&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šå°†CONTAINER-NAMEå’Œè¯¥å®¹å™¨çš„IPé…ç½®åˆ°è¯¥å®¹å™¨è¿æ¥åˆ°çš„è‡ªå®šä¹‰ç½‘ç»œä¸­çš„embedded DNS serverä¸­ï¼Œç”±å®ƒæä¾›è¯¥è‡ªå®šä¹‰ç½‘ç»œèŒƒå›´å†…çš„åŸŸåè§£æ&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“network-alias=ALIAS&lt;/td&gt;
&lt;td&gt;å°†å®¹å™¨çš„name-ip mapé…ç½®åˆ°å®¹å™¨è¿æ¥åˆ°çš„å…¶ä»–ç½‘ç»œçš„embedded DNS serverä¸­ã€‚PSï¼šä¸€ä¸ªå®¹å™¨å¯èƒ½è¿æ¥åˆ°å¤šä¸ªç½‘ç»œä¸­ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“link=CONTAINER_NAME:ALIAS&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œå°†ALIASå’ŒCONTAINER_NAME/IDå¯¹åº”çš„å®¹å™¨IPé…ç½®åˆ°è¯¥å®¹å™¨è¿æ¥åˆ°çš„è‡ªå®šä¹‰ç½‘ç»œä¸­çš„embedded DNS serverä¸­ï¼Œä½†ä»…é™äºé…ç½®äº†è¯¥linkçš„å®¹å™¨èƒ½è§£æè¿™æ¡ruleã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns=[IP_ADDRESSâ€¦]&lt;/td&gt;
&lt;td&gt;å½“embedded DNS serveræ— æ³•è§£æè¯¥å®¹å™¨çš„æŸä¸ªdns queryæ—¶ï¼Œä¼šå°†è¯·æ±‚fowardåˆ°è¿™äº›â€“dnsé…ç½®çš„IP_ADDRESS DNS Serverï¼Œç”±å®ƒä»¬è¿›ä¸€æ­¥è¿›è¡ŒåŸŸåè§£æã€‚æ³¨æ„ï¼Œè¿™äº›â€“dnsé…ç½®åˆ°&lt;code&gt;nameserver IP_ADDRESS&lt;/code&gt;å…¨éƒ¨ç”±å¯¹åº”çš„embedded DNS serverç®¡ç†ï¼Œå¹¶ä¸ä¼šæ›´æ–°åˆ°å®¹å™¨å†…çš„/etc/resolv.conf.&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns-search=DOMAINâ€¦&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šå°†â€“dns-searché…ç½®çš„DOMAINä»¬é…ç½®åˆ°the embedded DNS serverï¼Œå¹¶ä¸ä¼šæ›´æ–°åˆ°å®¹å™¨å†…çš„/etc/resolv.confã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;â€“dns-opt=OPTIONâ€¦&lt;/td&gt;
&lt;td&gt;åœ¨è¯¥å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šå°†â€“dns-opté…ç½®çš„OPTIONä»¬é…ç½®åˆ°the embedded DNS serverï¼Œå¹¶ä¸ä¼šæ›´æ–°åˆ°å®¹å™¨å†…çš„/etc/resolv.confã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœdocker runæ—¶ä¸å«&lt;code&gt;--dns=IP_ADDRESS..., --dns-search=DOMAIN..., or --dns-opt=OPTION...&lt;/code&gt;å‚æ•°ï¼Œdocker daemonä¼šå°†copyæœ¬ä¸»æœºçš„/etc/resolv.confï¼Œç„¶åå¯¹è¯¥copyè¿›è¡Œå¤„ç†ï¼ˆå°†é‚£äº›/etc/resolv.confä¸­pingä¸é€šçš„nameserveré¡¹ç»™æŠ›å¼ƒï¼‰,å¤„ç†å®Œæˆåç•™ä¸‹çš„éƒ¨åˆ†å°±ä½œä¸ºè¯¥å®¹å™¨å†…éƒ¨çš„/etc/resolv.confã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³åˆ©ç”¨å®¿ä¸»æœºä¸­çš„/etc/resolv.confé…ç½®çš„nameserverè¿›è¡ŒåŸŸåè§£æï¼Œé‚£ä¹ˆä½ éœ€è¦å®¿ä¸»æœºä¸­è¯¥dns serviceé…ç½®ä¸€ä¸ªå®¿ä¸»æœºå†…å®¹å™¨èƒ½pingé€šçš„IPã€‚&lt;/li&gt;
&lt;li&gt;æ³¨æ„å®¹å™¨å†…/etc/resolv.confä¸­é…ç½®çš„DNS serverï¼Œåªæœ‰å½“the embedded DNS serveræ— æ³•è§£ææŸä¸ªnameæ—¶ï¼Œæ‰ä¼šç”¨åˆ°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;embedded-dns-serveræºç åˆ†æ&#34;&gt;embedded DNS serveræºç åˆ†æ&lt;/h2&gt;

&lt;p&gt;æ‰€æœ‰embedded DNS serverç›¸å…³çš„ä»£ç éƒ½åœ¨libcontaineré¡¹ç›®ä¸­ï¼Œå‡ ä¸ªæœ€ä¸»è¦çš„æ–‡ä»¶åˆ†åˆ«æ˜¯&lt;code&gt;/libnetwork/resolver.Go&lt;/code&gt;,&lt;code&gt;/libnetwork/resolver_unix.go&lt;/code&gt;,&lt;code&gt;sandbox_dns_unix.go&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;OK, å…ˆæ¥çœ‹çœ‹embedded DNS serverå¯¹è±¡åœ¨dockerä¸­çš„å®šä¹‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Go&#34;&gt;libnetwork/resolver.go

// resolver implements the Resolver interface
type resolver struct {
    sb         *sandbox
    extDNSList [maxExtDNS]extDNSEntry
    server     *dns.Server
    conn       *net.UDPConn
    tcpServer  *dns.Server
    tcpListen  *net.TCPListener
    err        error
    count      int32
    tStamp     time.Time
    queryLock  sync.Mutex
}

// Resolver represents the embedded DNS server in Docker. It operates
// by listening on container&#39;s loopback interface for DNS queries.
type Resolver interface {
    // Start starts the name server for the container
    Start() error
    // Stop stops the name server for the container. Stopped resolver
    // can be reused after running the SetupFunc again.
    Stop()
    // SetupFunc() provides the setup function that should be run
    // in the container&#39;s network namespace.
    SetupFunc() func()
    // NameServer() returns the IP of the DNS resolver for the
    // containers.
    NameServer() string
    // SetExtServers configures the external nameservers the resolver
    // should use to forward queries
    SetExtServers([]string)
    // ResolverOptions returns resolv.conf options that should be set
    ResolverOptions() []string
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯è§ï¼Œresolverå°±æ˜¯embedded DNS serverï¼Œæ¯ä¸ªresolveréƒ½bindä¸€ä¸ªsandboxï¼Œå¹¶å®šä¹‰äº†ä¸€ä¸ªå¯¹åº”çš„dns.Serverï¼Œè¿˜å®šä¹‰äº†å¤–éƒ¨DNSå¯¹è±¡åˆ—è¡¨ï¼Œä½†embedded DNS serveræ— æ³•è§£ææŸä¸ªnameæ—¶ï¼Œå°±ä¼šforwardåˆ°é‚£äº›å¤–éƒ¨DNSã€‚&lt;/p&gt;

&lt;p&gt;Resolver Interfaceå®šä¹‰äº†embedded DNS serverå¿…é¡»å®ç°çš„æ¥å£ï¼Œè¿™é‡Œä¼šé‡ç‚¹å…³æ³¨SetupFunc()å’ŒStart()ï¼Œè§ä¸‹æ–‡åˆ†æã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;dns.Serverçš„å®ç°ï¼Œå…¨éƒ¨äº¤ç»™github.com/miekg/dnsï¼Œé™äºç¯‡å¹…ï¼Œè¿™é‡Œæˆ‘å°†ä¸ä¼šè·Ÿè¿›å»åˆ†æã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä»æ•´ä¸ª&lt;a href=&#34;http://lib.csdn.net/base/docker&#34;&gt;Container&lt;/a&gt;Â createçš„æµç¨‹ä¸Šæ¥çœ‹ï¼Œdocker daemonå¯¹embedded DNS serverçš„å¤„ç†æ˜¯ä»endpoint Join a sandboxå¼€å§‹çš„:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;libnetwork/endpoint.go


func (ep *endpoint) Join(sbox Sandbox, options ...EndpointOption) error {
    ...

    return ep.sbJoin(sb, options...)
}


func (ep *endpoint) sbJoin(sb *sandbox, options ...EndpointOption) error {
    ...

    if err = sb.populateNetworkResources(ep); err != nil {
        return err
    }

    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;sandbox join a sandboxçš„æµç¨‹ä¸­ï¼Œä¼šè°ƒç”¨sandbox. populateNetworkResourcesåšç½‘ç»œèµ„æºçš„è®¾ç½®ï¼Œè¿™å…¶ä¸­å°±åŒ…æ‹¬äº†embedded DNS serverçš„å¯åŠ¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Go&#34;&gt;libnetwork/sandbox.go
func (sb *sandbox) populateNetworkResources(ep *endpoint) error {
    ...
    if ep.needResolver() {
        sb.startResolver(false)
    }
    ...
}


libnetwork/sandbox_dns_unix.go
func (sb *sandbox) startResolver(restore bool) {
    sb.resolverOnce.Do(func() {
        var err error
        sb.resolver = NewResolver(sb)
        defer func() {
            if err != nil {
                sb.resolver = nil
            }
        }()

        // In the case of live restore container is already running with
        // right resolv.conf contents created before. Just update the
        // external DNS servers from the restored sandbox for embedded
        // server to use.
        if !restore {
            err = sb.rebuildDNS()
            if err != nil {
                log.Errorf(&amp;quot;Updating resolv.conf failed for container %s, %q&amp;quot;, sb.ContainerID(), err)
                return
            }
        }
        sb.resolver.SetExtServers(sb.extDNS)

        sb.osSbox.InvokeFunc(sb.resolver.SetupFunc())
        if err = sb.resolver.Start(); err != nil {
            log.Errorf(&amp;quot;Resolver Setup/Start failed for container %s, %q&amp;quot;, sb.ContainerID(), err)
        }
    })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;sandbox.startResolveræ˜¯æµç¨‹å…³é”®:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é€šè¿‡sanbdox.rebuildDNSç”Ÿæˆäº†containerå†…çš„/etc/resolv.conf&lt;/li&gt;
&lt;li&gt;é€šè¿‡resolver.SetExtServers(sb.extDNS)è®¾ç½®embedded DNS serverçš„forward DNS list&lt;/li&gt;
&lt;li&gt;é€šè¿‡resolver.SetupFunc()å¯åŠ¨ä¸¤ä¸ªéšæœºå¯ç”¨ç«¯å£ä½œä¸ºembedded DNS serverï¼ˆ127.0.0.11ï¼‰çš„TCPå’ŒUDP Linstener&lt;/li&gt;
&lt;li&gt;é€šè¿‡resolver.Start()å¯¹å®¹å™¨å†…çš„iptableè¿›è¡Œè®¾ç½®(è§ä¸‹)ï¼Œå¹¶é€šè¿‡miekg/dnså¯åŠ¨ä¸€ä¸ªnameserveråœ¨53ç«¯å£æä¾›æœåŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸‹é¢æˆ‘å°†é€ä¸€ä»‹ç»ä¸Šé¢çš„å„ä¸ªæ­¥éª¤ã€‚&lt;/p&gt;

&lt;h3 id=&#34;sanbdox-rebuilddns&#34;&gt;sanbdox.rebuildDNS&lt;/h3&gt;

&lt;p&gt;sanbdox.rebuildDNSè´Ÿè´£æ„å»ºå®¹å™¨å†…çš„resolv.confï¼Œæ„å»ºè§„åˆ™å°±æ˜¯ç¬¬ä¸€èŠ‚æ±Ÿå‚æ•°é…ç½®æ—¶å€™æåˆ°çš„ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Save the external name servers in resolv.conf in the sandbox&lt;/li&gt;
&lt;li&gt;Add only the embedded serverâ€™s IP to containerâ€™s resolv.conf&lt;/li&gt;
&lt;li&gt;If the embedded server needs any resolv.conf options add it to the current list&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-Go&#34;&gt;libnetwork/sandbox_dns_unix.go

func (sb *sandbox) rebuildDNS() error {
    currRC, err := resolvconf.GetSpecific(sb.config.resolvConfPath)
    if err != nil {
        return err
    }

    // localhost entries have already been filtered out from the list
    // retain only the v4 servers in sb for forwarding the DNS queries
    sb.extDNS = resolvconf.GetNameservers(currRC.Content, types.IPv4)

    var (
        dnsList        = []string{sb.resolver.NameServer()}
        dnsOptionsList = resolvconf.GetOptions(currRC.Content)
        dnsSearchList  = resolvconf.GetSearchDomains(currRC.Content)
    )

    dnsList = append(dnsList, resolvconf.GetNameservers(currRC.Content, types.IPv6)...)

    resOptions := sb.resolver.ResolverOptions()

dnsOpt:
    ...
    dnsOptionsList = append(dnsOptionsList, resOptions...)

    _, err = resolvconf.Build(sb.config.resolvConfPath, dnsList, dnsSearchList, dnsOptionsList)
    return err
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;resolver-setextservers&#34;&gt;resolver.SetExtServers&lt;/h3&gt;

&lt;p&gt;è®¾ç½®embedded DNS serverçš„forward DNS list, å½“embedded DNS serverä¸èƒ½è§£ææŸnameæ—¶ï¼Œå°±ä¼šå°†è¯·æ±‚forwardåˆ°ExtServersã€‚ä»£ç å¾ˆç®€å•ï¼Œä¸å¤šåºŸè¯ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-Go&#34;&gt;libnetwork/resolver.go
func (r *resolver) SetExtServers(dns []string) {
    l := len(dns)
    if l &amp;gt; maxExtDNS {
        l = maxExtDNS
    }
    for i := 0; i &amp;lt; l; i++ {
        r.extDNSList[i].ipStr = dns[i]
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;resolver-setupfunc&#34;&gt;resolver.SetupFunc&lt;/h3&gt;

&lt;p&gt;å¯åŠ¨ä¸¤ä¸ªéšæœºå¯ç”¨ç«¯å£ä½œä¸ºembedded DNS serverï¼ˆ127.0.0.11ï¼‰çš„TCPå’ŒUDP Linstenerã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;libnetwork/resolver.go

func (r *resolver) SetupFunc() func() {
    return (func() {
        var err error

        // DNS operates primarily on UDP
        addr := &amp;amp;net.UDPAddr{
            IP: net.ParseIP(resolverIP),
        }

        r.conn, err = net.ListenUDP(&amp;quot;udp&amp;quot;, addr)
        ...

        // Listen on a TCP as well
        tcpaddr := &amp;amp;net.TCPAddr{
            IP: net.ParseIP(resolverIP),
        }

        r.tcpListen, err = net.ListenTCP(&amp;quot;tcp&amp;quot;, tcpaddr)
        ...
    })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;resolver-start&#34;&gt;resolver.Start&lt;/h3&gt;

&lt;p&gt;resolver.Startä¸­ä¸¤ä¸ªé‡è¦æ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;setupIPTableè®¾ç½®å®¹å™¨å†…çš„iptables&lt;/li&gt;
&lt;li&gt;å¯åŠ¨dns nameserveråœ¨53ç«¯å£å¼€å§‹æä¾›åŸŸåè§£ææœåŠ¡&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;func (r *resolver) Start() error {
    ...
    if err := r.setupIPTable(); err != nil {
        return fmt.Errorf(&amp;quot;setting up IP table rules failed: %v&amp;quot;, err)
    }
    ...
    tcpServer := &amp;amp;dns.Server{Handler: r, Listener: r.tcpListen}
    r.tcpServer = tcpServer
    go func() {
        tcpServer.ActivateAndServe()
    }()
    return nil
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…ˆæ¥çœ‹çœ‹æ€ä¹ˆè®¾ç½®å®¹å™¨å†…çš„iptablesçš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (r *resolver) setupIPTable() error {
    ...
    // è·å–setupFunc()æ—¶çš„ä¸¤ä¸ªæœ¬åœ°éšæœºç›‘å¬ç«¯å£
    laddr := r.conn.LocalAddr().String()
    ltcpaddr := r.tcpListen.Addr().String()

    cmd := &amp;amp;exec.Cmd{
        Path:   reexec.Self(),
        // å°†è¿™ä¸¤ä¸ªç«¯å£ä¼ ç»™setup-resolverå‘½ä»¤å¹¶å¯åŠ¨æ‰§è¡Œ
        Args:   append([]string{&amp;quot;setup-resolver&amp;quot;}, r.sb.Key(), laddr, ltcpaddr),
        Stdout: os.Stdout,
        Stderr: os.Stderr,
    }
    if err := cmd.Run(); err != nil {
        return fmt.Errorf(&amp;quot;reexec failed: %v&amp;quot;, err)
    }
    return nil
}

// initæ—¶å°±æ³¨å†Œsetup-resolverå¯¹åº”çš„handler
func init() {
    reexec.Register(&amp;quot;setup-resolver&amp;quot;, reexecSetupResolver)
}

// setup-resolverå¯¹åº”çš„handlerå®šä¹‰
func reexecSetupResolver() {
    ...
    // å°è£…iptablesæ•°æ®
    _, ipPort, _ := net.SplitHostPort(os.Args[2])
    _, tcpPort, _ := net.SplitHostPort(os.Args[3])
    rules := [][]string{
        {&amp;quot;-t&amp;quot;, &amp;quot;nat&amp;quot;, &amp;quot;-I&amp;quot;, outputChain, &amp;quot;-d&amp;quot;, resolverIP, &amp;quot;-p&amp;quot;, &amp;quot;udp&amp;quot;, &amp;quot;--dport&amp;quot;, dnsPort, &amp;quot;-j&amp;quot;, &amp;quot;DNAT&amp;quot;, &amp;quot;--to-destination&amp;quot;, os.Args[2]},
        {&amp;quot;-t&amp;quot;, &amp;quot;nat&amp;quot;, &amp;quot;-I&amp;quot;, postroutingchain, &amp;quot;-s&amp;quot;, resolverIP, &amp;quot;-p&amp;quot;, &amp;quot;udp&amp;quot;, &amp;quot;--sport&amp;quot;, ipPort, &amp;quot;-j&amp;quot;, &amp;quot;SNAT&amp;quot;, &amp;quot;--to-source&amp;quot;, &amp;quot;:&amp;quot; + dnsPort},
        {&amp;quot;-t&amp;quot;, &amp;quot;nat&amp;quot;, &amp;quot;-I&amp;quot;, outputChain, &amp;quot;-d&amp;quot;, resolverIP, &amp;quot;-p&amp;quot;, &amp;quot;tcp&amp;quot;, &amp;quot;--dport&amp;quot;, dnsPort, &amp;quot;-j&amp;quot;, &amp;quot;DNAT&amp;quot;, &amp;quot;--to-destination&amp;quot;, os.Args[3]},
        {&amp;quot;-t&amp;quot;, &amp;quot;nat&amp;quot;, &amp;quot;-I&amp;quot;, postroutingchain, &amp;quot;-s&amp;quot;, resolverIP, &amp;quot;-p&amp;quot;, &amp;quot;tcp&amp;quot;, &amp;quot;--sport&amp;quot;, tcpPort, &amp;quot;-j&amp;quot;, &amp;quot;SNAT&amp;quot;, &amp;quot;--to-source&amp;quot;, &amp;quot;:&amp;quot; + dnsPort},
    }
    ...

    // insert outputChain and postroutingchain
    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨reexecSetupResolver()ä¸­æ¸…æ¥šçš„å®šä¹‰äº†iptablesæ·»åŠ outputChain å’Œpostroutingchainï¼Œå°†åˆ°å®¹å™¨å†…çš„dns queryè¯·æ±‚é‡å®šå‘åˆ°embedded DNS server(127.0.0.11)ä¸Šçš„udp/tcpä¸¤ä¸ªéšæœºå¯ç”¨ç«¯å£ï¼Œembedded DNS server(127.0.0.11)çš„è¿”å›æ•°æ®åˆ™é‡å®šå‘åˆ°å®¹å™¨å†…çš„53ç«¯å£ï¼Œè¿™æ ·å®Œæˆäº†æ•´ä¸ªdns queryè¯·æ±‚ã€‚&lt;/p&gt;

&lt;p&gt;æ¨¡å‹å›¾å¦‚ä¸‹ï¼šÂ 
&lt;img src=&#34;http://img.blog.csdn.net/20170105215440792?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&#34; alt=&#34;è¿™é‡Œå†™å›¾ç‰‡æè¿°&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è´´ä¸€å¼ å®ä¾‹å›¾ï¼šÂ 
&lt;img src=&#34;http://img.blog.csdn.net/20170105215310369?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&#34; alt=&#34;è¿™é‡Œå†™å›¾ç‰‡æè¿°&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://img.blog.csdn.net/20170105215322635?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&#34; alt=&#34;è¿™é‡Œå†™å›¾ç‰‡æè¿°&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åˆ°è¿™é‡Œï¼Œå…³äºembedded DNS serverçš„æºç åˆ†æå°±ç»“æŸäº†ã€‚å½“ç„¶ï¼Œå…¶ä¸­è¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œå°±ç•™ç»™è¯»è€…è‡ªå·±èµ°è¯»ä»£ç äº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç¦åˆ©&#34;&gt;ç¦åˆ©&lt;/h2&gt;

&lt;p&gt;ä»è¯¥æ—¶åºå›¾ä¸­çœ‹çœ‹embedded DNS serverçš„æ“ä½œåœ¨æ•´ä¸ªå®¹å™¨createæµç¨‹ä¸­çš„ä½ç½®ã€‚
&lt;img src=&#34;http://img.blog.csdn.net/20170105215401307?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2FsdG9uV2FuZw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast&#34; alt=&#34;è¿™é‡Œå†™å›¾ç‰‡æè¿°&#34; /&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>