<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" /> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="docker, docker plugin, plugin, develop, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Docker17.03-CEæ’ä»¶å¼€å‘æ¡ˆä¾‹ : jimmysong.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/docker-plugin-develop/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-15"/>
<meta property="article:modified_time" content="2017-03-15"/>



<meta property="article:tag" content="docker">
<meta property="article:tag" content="docker plugin">
<meta property="article:tag" content="plugin">
<meta property="article:tag" content="develop">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="Docker17.03-CEæ’ä»¶å¼€å‘æ¡ˆä¾‹ : jimmysong.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="jimmysong.io">

    <base href="http://rootsongjc.github.io/">
    <title> Docker17.03-CEæ’ä»¶å¼€å‘æ¡ˆä¾‹ - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/docker-plugin-develop/"> 
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>
    hljs.initHighlightingOnLoad();
</script>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function() {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden; '>
    <img src='http://olz1di9xf.bkt.clouddn.com/jimmy.jpg' />
</div>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
    <header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

    <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>
        <div class="dropdown share">
            <ul class="social">
                <li> <a href="https://twitter.com/intent/tweet?status=Docker17.03-CE%e6%8f%92%e4%bb%b6%e5%bc%80%e5%8f%91%e6%a1%88%e4%be%8b-http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f&title=Docker17.03-CE%e6%8f%92%e4%bb%b6%e5%bc%80%e5%8f%91%e6%a1%88%e4%be%8b&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fdocker-plugin-develop%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>
        <div class="dropdown follow">
            <ul class="social">
                <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="è±†ç“£" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                <li> <a href="https://rootsongjc.tuchong.com/" target="_blank" title="å›¾è™«" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>
            </ul>
            <span class="subcount">join 10k+ subscribers &amp; followers</span>
        </div>
    </li>
</ul>
    </nav>
</header>
 

    <section id="main">
        <h1 itemprop="name" id="title">Docker17.03-CEæ’ä»¶å¼€å‘æ¡ˆä¾‹</h1>
        <div>
            <article itemprop="articleBody" id="content">
                

<p><img src="http://olz1di9xf.bkt.clouddn.com/20161016022.jpg" alt="æ­å·å´å±±" /></p>

<p><em>ï¼ˆé¢˜å›¾ï¼šæ­å·å´å±±æ­¥é“æ—çš„å¢™å£ Oct 16,2016ï¼‰</em></p>

<blockquote>
<p>å½“ä½ çœ‹åˆ°è¿™ç¯‡æ–‡ç« æ—¶ï¼Œå¦‚æœä½ ä¹Ÿæ­£åœ¨è¿›è¡Œdocker1.13+ç‰ˆæœ¬ä¸‹çš„pluginå¼€å‘ï¼Œæ­å–œä½ ä¹Ÿå…¥å‘äº†ï¼Œå¦‚æœä½ è¶Ÿå‡ºå‘ï¼Œéº»çƒ¦å‘Šè¯‰ä½ çš„æ–¹æ³•ï¼Œæ„Ÿæ©ä¸å°½ğŸ™</p>
</blockquote>

<p>çœ‹äº†æ–‡ç« åä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œå®˜ç½‘ä¸Šçš„å¯èƒ½æ˜¯ä¸ªå‡ğŸŒ°ã€‚<strong>è™½ç„¶å®˜ç½‘ä¸Šçš„æ–‡æ¡£å†™çš„æœ‰ç‚¹ä¸å¯¹ï¼Œä¸è¿‡ä½ ä½¿ç”¨docker-ssh-volumeçš„å¼€æºä»£ç è‡ªå·±å»æ„å»ºpluginçš„è¿˜æ˜¯å¯ä»¥æˆåŠŸçš„ï¼</strong></p>

<h3 id="docker-pluginå¼€å‘æ–‡æ¡£">Docker pluginå¼€å‘æ–‡æ¡£</h3>

<p>é¦–å…ˆdockerå®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ª<a href="https://docs.docker.com/engine/extend/legacy_plugins/">docker legacy pluginæ–‡æ¡£</a>ï¼Œè¿™ç¯‡æ–‡ç« åŸºæœ¬å°±æ˜¯å‘Šè¯‰ä½ dockerç›®å‰æ”¯æŒå“ªäº›æ’ä»¶ï¼Œç½—åˆ—äº†ä¸€ç³»åˆ—è¿æ¥ï¼Œä¸è¿‡å¯¹ä¸èµ·ï¼Œè¿™äº›ä¸æ˜¯dockerå®˜æ–¹æ’ä»¶ï¼Œæœ‰é—®é¢˜å»æ‰¾å®ƒä»¬çš„å¼€å‘è€…å»å§ğŸ˜‚</p>

<p><strong>Docker pluginè²Œä¼¼å¼€å§‹ä½¿ç”¨äº†æ–°çš„v2 pluginäº†ï¼Œlegacyç‰ˆæœ¬çš„pluginå¯ä»¥èƒ½åœ¨åæœŸè¢«åºŸå¼ƒã€‚</strong></p>

<p>ä»dockerçš„æºç <strong>plugin/store.go</strong>ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>

<pre><code class="language-Go">/* allowV1PluginsFallback determines daemon's support for V1 plugins.
 * When the time comes to remove support for V1 plugins, flipping
 * this bool is all that will be needed.
 */
const allowV1PluginsFallback bool = true

/* defaultAPIVersion is the version of the plugin API for volume, network,
   IPAM and authz. This is a very stable API. When we update this API, then
   pluginType should include a version. e.g. &quot;networkdriver/2.0&quot;.
*/
const defaultAPIVersion string = &quot;1.0&quot;
</code></pre>

<blockquote>
<p>éšç€dockerå…¬å¸æ˜¯çš„æˆ˜ç•¥è°ƒæ•´ï¼Œæ¨å‡ºäº†docker-CEå’Œdocker-EEä¹‹åï¼Œæœªæ¥æœ‰äº›æ’ä»¶å°±å¯èƒ½è¦æ”¶è´¹äº†ï¼Œv2ç‰ˆæœ¬çš„æ’ä»¶éƒ½æ˜¯åœ¨docker storeä¸­ä¸‹è½½äº†ï¼Œè€Œè¿™ç§æ’ä»¶åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½æ˜¯æ‰“åŒ…æˆdocker imageï¼Œå¦‚æœä¸å¼€æ”¾æºç çš„è¯ï¼Œä½ å³ä½¿pullä¸‹æ¥æ’ä»¶ä¹Ÿæ— æ³•ä¿®æ”¹å’Œå¯¼å‡ºçš„ï¼Œ<strong>docker pluginç›®å‰æ²¡æœ‰å¯¼å‡ºæ¥å£</strong>ã€‚</p>
</blockquote>

<p>çœŸæ­£è¦å¼€å‘ä¸€ä¸ªdocker pluginè¿˜æ˜¯å¾—çœ‹<a href="https://docs.docker.com/engine/extend/plugin_api/">docker plugin API</a>ï¼Œè¿™ç¯‡æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬ï¼š</p>

<h4 id="æ’ä»¶å‘ç°">æ’ä»¶å‘ç°</h4>

<p>å½“ä½ å¼€å‘å¥½ä¸€ä¸ªæ’ä»¶<strong>docker engine</strong>æ€ä¹ˆæ‰èƒ½å‘ç°å®ƒä»¬å‘¢ï¼Ÿæœ‰ä¸‰ç§æ–¹å¼ï¼š</p>

<ul>
<li><strong>.sock</strong>ï¼Œlinuxä¸‹æ”¾åœ¨/run/docker/pluginsç›®å½•ä¸‹ï¼Œæˆ–è¯¥ç›®å½•ä¸‹çš„å­ç›®å½•æ¯”å¦‚<a href="https://github.com/ClusterHQ/flocker">flocker</a>æ’ä»¶çš„<code>.sock</code>æ–‡ä»¶æ”¾åœ¨<code>/run/docker/plugins/flocker/flocker.sock</code>ä¸‹</li>
<li><strong>.spec</strong>ï¼Œæ¯”å¦‚<strong>convoy</strong>æ’ä»¶åœ¨<code>/etc/docker/plugins/convoy.spec</code>å®šä¹‰ï¼Œå†…å®¹ä¸º<code>unix:///var/run/convoy/convoy.sock</code></li>
<li><strong>.json</strong>ï¼Œæ¯”å¦‚<strong>infinit</strong>æ’ä»¶åœ¨<code>/usr/lib/docker/plugins/infinit.json</code>å®šä¹‰ï¼Œå†…å®¹ä¸º<code>{&quot;Addr&quot;:&quot;https://infinit.sh&quot;,&quot;Name&quot;:&quot;infinit&quot;}</code></li>
</ul>

<p>æ–‡ç« ä¸­çš„å…¶å®ƒéƒ¨åˆ†<strong>è²Œä¼¼éƒ½è¿‡æ—¶</strong>äº†ï¼Œæ–°çš„æ’ä»¶ä¸æ˜¯ä½œä¸º<strong>systemd</strong>è¿›ç¨‹è¿è¡Œçš„ï¼Œè€Œæ˜¯å®Œå…¨é€šè¿‡<strong>docker plugin</strong>å‘½ä»¤æ¥ç®¡ç†çš„ã€‚</p>

<p>å½“ä½ ä½¿ç”¨<strong>docker plugin enable <plugin_name></strong>æ¥æ¿€æ´»äº†æ’ä»¶åï¼Œç†åº”åœ¨<code>/run/docker/plugins</code>ç›®å½•ä¸‹ç”Ÿæˆæ’ä»¶çš„<code>.sock</code>æ–‡ä»¶ï¼Œä½†æ˜¯ç°åœ¨åªæœ‰ä¸€ä¸ªä»¥runc IDå‘½åçš„ç›®å½•ï¼Œè¿™ä¸ªé—®é¢˜ä¸‹é¢æœ‰è¯¦ç»†çš„å™è¿°è¿‡ç¨‹ï¼Œä½ ä¹Ÿå¯ä»¥è·³è¿‡ï¼Œç›´æ¥çœ‹<a href="https://github.com/docker/docker/issues/31723">issue-31723</a></p>

<p><a href="https://docs.docker.com/engine/extend/">docker pluginç®¡ç†</a></p>

<h3 id="åˆ›å»ºsshfs-volume-plugin">åˆ›å»ºsshfs volume plugin</h3>

<p><a href="https://github.com/docker/docker/blob/17.03.x/docs/extend/index.md#developing-a-plugin">å®˜æ–¹ç¤ºä¾‹æ–‡æ¡£</a>ï¼ˆè¿™ä¸ªæ–‡æ¡£æœ‰é—®é¢˜ï¼‰<a href="https://github.com/docker/docker/issues/29886">docker-issue29886</a></p>

<p>å®˜æ–¹ä»¥å¼€å‘ä¸€ä¸ª<strong>sshfs</strong>çš„volume pluginä¸ºä¾‹ã€‚</p>

<p>æ‰§è¡Œ<code>docker plugin create</code>å‘½ä»¤çš„ç›®å½•ä¸‹å¿…é¡»åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
<li><strong>config.json</strong>æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯æ’ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œ<a href="https://github.com/docker/docker/blob/17.03.x/docs/extend/config.md">plugin configå‚è€ƒæ–‡æ¡£</a></li>
<li><strong>rootfs</strong>ç›®å½•ï¼Œæ’ä»¶é•œåƒè§£å‹åçš„ç›®å½•ã€‚v2ç‰ˆæœ¬çš„docker pluginéƒ½æ˜¯ä»¥dockeré•œåƒçš„æ–¹å¼åŒ…è£…çš„ã€‚</li>
</ul>

<pre><code>$ git clone https://github.com/vieux/docker-volume-sshfs
$ cd docker-volume-sshfs
$ go get github.com/docker/go-plugins-helpers/volume
$ go build -o docker-volume-sshfs main.go  
$ docker build -t rootfsimage .
$ id=$(docker create rootfsimage true) # id was cd851ce43a403 when the image was created
$ sudo mkdir -p myplugin/rootfs
$ sudo docker export &quot;$id&quot; | sudo tar -x -C myplugin/rootfs
$ docker rm -vf &quot;$id&quot;
$ docker rmi rootfsimage
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>sshfs</strong>çš„Dockerfileæ˜¯è¿™æ ·çš„ï¼š</p>

<pre><code class="language-Dockerfile">FROM alpine

RUN apk update &amp;&amp; apk add sshfs

RUN mkdir -p /run/docker/plugins /mnt/state /mnt/volumes

COPY docker-volume-sshfs docker-volume-sshfs

CMD [&quot;docker-volume-sshfs&quot;]
</code></pre>

<p>å®é™…ä¸Šæ˜¯ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ°alpine linuxå®¹å™¨ä¸­è¿è¡Œã€‚</p>

<p>ç¼–è¯‘rootfsimageé•œåƒçš„è¿‡ç¨‹ã€‚</p>

<pre><code>docker build -t rootfsimage .
Sending build context to Docker daemon 11.71 MB
Step 1/5 : FROM alpine
 ---&gt; 4a415e366388
Step 2/5 : RUN apk update &amp;&amp; apk add sshfs
 ---&gt; Running in 1551ecc1c847
fetch http://dl-cdn.alpinelinux.org/alpine/v3.5/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.5/community/x86_64/APKINDEX.tar.gz
v3.5.2-2-ge626ce8c3c [http://dl-cdn.alpinelinux.org/alpine/v3.5/main]
v3.5.1-71-gc7bb9a04f0 [http://dl-cdn.alpinelinux.org/alpine/v3.5/community]
OK: 7959 distinct packages available
(1/10) Installing openssh-client (7.4_p1-r0)
(2/10) Installing fuse (2.9.7-r0)
(3/10) Installing libffi (3.2.1-r2)
(4/10) Installing libintl (0.19.8.1-r0)
(5/10) Installing libuuid (2.28.2-r1)
(6/10) Installing libblkid (2.28.2-r1)
(7/10) Installing libmount (2.28.2-r1)
(8/10) Installing pcre (8.39-r0)
(9/10) Installing glib (2.50.2-r0)
(10/10) Installing sshfs (2.8-r0)
Executing busybox-1.25.1-r0.trigger
Executing glib-2.50.2-r0.trigger
OK: 11 MiB in 21 packages
 ---&gt; 1a73c501f431
Removing intermediate container 1551ecc1c847
Step 3/5 : RUN mkdir -p /run/docker/plugins /mnt/state /mnt/volumes
 ---&gt; Running in 032af3b2595a
 ---&gt; 30c7e8463e96
Removing intermediate container 032af3b2595a
Step 4/5 : COPY docker-volume-sshfs docker-volume-sshfs
 ---&gt; a924c6fcc1e4
Removing intermediate container ffc5e3c97707
Step 5/5 : CMD docker-volume-sshfs
 ---&gt; Running in 0dc938fe4f4e
 ---&gt; 0fd2e3d94860
Removing intermediate container 0dc938fe4f4e
Successfully built 0fd2e3d94860
</code></pre>

<p>ç¼–å†™<code>config.json</code>æ–‡æ¡£</p>

<pre><code class="language-Json">{
    &quot;description&quot;: &quot;sshFS plugin for Docker&quot;,
    &quot;documentation&quot;: &quot;https://docs.docker.com/engine/extend/plugins/&quot;,
    &quot;entrypoint&quot;: [
        &quot;/docker-volume-sshfs&quot;
    ],
    &quot;env&quot;: [
        {
            &quot;name&quot;: &quot;DEBUG&quot;,
            &quot;settable&quot;: [
                &quot;value&quot;
            ],
            &quot;value&quot;: &quot;0&quot;
        }
    ],
    &quot;interface&quot;: {
        &quot;socket&quot;: &quot;sshfs.sock&quot;,
        &quot;types&quot;: [
            &quot;docker.volumedriver/1.0&quot;
        ]
    },
    &quot;linux&quot;: {
        &quot;capabilities&quot;: [
            &quot;CAP_SYS_ADMIN&quot;
        ],
        &quot;devices&quot;: [
            {
                &quot;path&quot;: &quot;/dev/fuse&quot;
            }
        ]
    },
    &quot;mounts&quot;: [
        {
            &quot;destination&quot;: &quot;/mnt/state&quot;,
            &quot;options&quot;: [
                &quot;rbind&quot;
            ],
            &quot;source&quot;: &quot;/var/lib/docker/plugins/&quot;,
            &quot;type&quot;: &quot;bind&quot;
        }
    ],
    &quot;network&quot;: {
        &quot;type&quot;: &quot;host&quot;
    },
    &quot;propagatedmount&quot;: &quot;/mnt/volumes&quot;
}
</code></pre>

<p>è¯¥æ’ä»¶ä½¿ç”¨hostç½‘ç»œç±»å‹ï¼Œä½¿ç”¨/run/docker/plugins/sshfs.sockæ¥å£ä¸docker engineé€šä¿¡ã€‚</p>

<p><strong>æ³¨æ„å®˜ç½‘ä¸Šçš„è¿™ä¸ªæ–‡æ¡£æœ‰é—®é¢˜ï¼Œconfig.jsonä¸ä»£ç é‡Œçš„ä¸ç¬¦ï¼Œå°¤å…¶æ˜¯Entrypointçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ä¸å¯¹ã€‚</strong></p>

<blockquote>
<p>æ³¨æ„<strong>socket</strong>é…ç½®çš„åœ°å€ä¸è¦å†™è¯¦ç»†åœ°å€ï¼Œé»˜è®¤ä¼šåœ¨/run/docker/pluginsç›®å½•ä¸‹ç”Ÿæˆsocketæ–‡ä»¶ã€‚</p>
</blockquote>

<p><strong>åˆ›å»ºplugin</strong></p>

<p>ä½¿ç”¨<code>docker plugin create &lt;plugin_name&gt; /path/to/plugin/data/</code>å‘½ä»¤åˆ›å»ºæ’ä»¶ã€‚</p>

<p>å…·ä½“åˆ°sshfsæ’ä»¶ï¼Œåœ¨mypluginç›®å½•ä¸‹ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºæ’ä»¶ï¼š</p>

<pre><code class="language-shell">docker plugin create jimmmysong/sshfs:latest .
</code></pre>

<p>ç°åœ¨å°±å¯ä»¥çœ‹åˆ°åˆšåˆ›å»ºçš„æ’ä»¶äº†</p>

<pre><code>docker plugin ls
ID                  NAME                 DESCRIPTION               ENABLED
8aa1f6098fca        jimmysong/sshfs:latest   sshFS plugin for Docker   true
</code></pre>

<p><strong>push plugin</strong></p>

<p>å…ˆç™»å½•ä½ çš„docker hubè´¦æˆ·ï¼Œç„¶åä½¿ç”¨<code>docker plugin push jimmysong/sshfs:latest</code>å³å¯ä»¥æ¨é€docker pluginåˆ°docker hubä¸­ã€‚</p>

<p>ç›®å‰æ¨é€åˆ°<strong>harbor</strong>é•œåƒä»“åº“æœ‰é—®é¢˜ï¼ŒæŠ¥é”™ä¿¡æ¯ï¼š</p>

<pre><code>c08c951b53b7: Preparing 
denied: requested access to the resource is denied
</code></pre>

<p>å·²ç»™harboræ<a href="https://github.com/vmware/harbor/issues/1532">issue-1532</a></p>

<p><strong>pluginçš„ä½¿ç”¨</strong></p>

<p>æœ‰å‘ç°äº†ä¸ªé—®é¢˜<a href="https://github.com/docker/docker/issues/31723">docker issue-31723</a>ï¼Œä½¿ç”¨pluginåˆ›å»ºvolumeçš„æ—¶å€™å±…ç„¶æ‰¾ä¸åˆ°<code>sshfs.sock</code>æ–‡ä»¶ï¼ğŸ˜¢åˆšå¼€å§‹æ‰‹åŠ¨åˆ›å»ºpluginçš„æ—¶å€™æµ‹è¯•äº†ä¸‹æ˜¯æ­£å¸¸çš„ï¼Œä¸çŸ¥é“ä¸ºå•¥å¼„åˆ°è¿™å°æµ‹è¯•æœºå™¨ä¸Šå‡ºé—®é¢˜äº†ã€‚</p>

<h3 id="å…³äºdocker-plugin-enableå¤±è´¥çš„é—®é¢˜">å…³äºdocker plugin enableå¤±è´¥çš„é—®é¢˜</h3>

<p>å½“docker  pluginåˆ›å»ºæˆåŠŸå¹¶enableçš„æ—¶å€™dockerå¹¶æ²¡æœ‰æŠ¥é”™ï¼Œè¿™ä¸docker pluginçš„<strong>activate</strong>æœºåˆ¶æœ‰å…³ï¼Œåªæœ‰å½“ä½ æœ€ç»ˆä½¿ç”¨è¯¥pluginçš„æ—¶å€™æ‰ä¼šæ¿€æ´»å®ƒã€‚</p>

<p>ä½¿ç”¨<strong>sshfs</strong>æ’ä»¶åˆ›å»ºvolumeã€‚</p>

<pre><code class="language-shell">docker volume create -d jimmysong/sshfs --name sshvolume -o sshcmd=1.2.3.4:/remote -o password=password
</code></pre>

<p>æŠ¥é”™å¦‚ä¸‹ï¼š</p>

<pre><code>Error response from daemon: create sshvolume: Post http://%2Frun%2Fdocker%2Fplugins%2F8f7b8f931b38a4ef53d0e4f8d738e26e8f10ef8bd26c8244f4b8dcc7276b685f%2Fsshfs.sock/VolumeDriver.Create: dial unix /run/docker/plugins/8f7b8f931b38a4ef53d0e4f8d738e26e8f10ef8bd26c8244f4b8dcc7276b685f/sshfs.sock: connect: no such file or directory
</code></pre>

<p>Docker daemonåœ¨enableè¿™ä¸ªæ’ä»¶çš„æ—¶å€™ä¼šå¯»æ‰¾è¿™ä¸ª<strong>.sock</strong>æ–‡ä»¶ï¼Œç„¶ååœ¨è‡ªå·±çš„plugindbä¸­æ³¨å†Œå®ƒï¼Œç›¸å…³ä»£ç åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œï¼š<a href="https://github.com/docker/docker/blob/17.03.x/plugin/manager_linux.go">https://github.com/docker/docker/blob/17.03.x/plugin/manager_linux.go</a></p>

<p>ç›¸å…³ä»£ç ç‰‡æ®µï¼š</p>

<pre><code class="language-Go">func (pm *Manager) enable(p *v2.Plugin, c *controller, force bool) error {
	...
	return pm.pluginPostStart(p, c)
}

func (pm *Manager) pluginPostStart(p *v2.Plugin, c *controller) error {
    //è¿™é‡Œéœ€è¦è·å–.sockæ–‡ä»¶çš„åœ°å€ 
    //pm.conifg.ExecRootå°±æ˜¯/run/docker/plugins
    //p.GetID()è¿”å›çš„å°±æ˜¯å¾ˆé•¿çš„é‚£ä¸²plugin ID
	sockAddr := filepath.Join(pm.config.ExecRoot, p.GetID(), p.GetSocket())
	client, err := plugins.NewClientWithTimeout(&quot;unix://&quot;+sockAddr, nil, c.timeoutInSecs)
	if err != nil {
		c.restart = false
		shutdownPlugin(p, c, pm.containerdClient)
		return errors.WithStack(err)
	}

	p.SetPClient(client)

	maxRetries := 3
	var retries int
	for {
		time.Sleep(3 * time.Second)
		retries++

		if retries &gt; maxRetries {
			logrus.Debugf(&quot;error net dialing plugin: %v&quot;, err)
			c.restart = false
			shutdownPlugin(p, c, pm.containerdClient)
			return err
		}

		// net dial into the unix socket to see if someone's listening.
		conn, err := net.Dial(&quot;unix&quot;, sockAddr)
		if err == nil {
			conn.Close()
			break
		}
	}
	pm.config.Store.SetState(p, true)
	pm.config.Store.CallHandler(p)

	return pm.save(p)
}
</code></pre>

<p>æ³¨æ„è¿™æ®µä»£ç é‡Œçš„<strong>sockAddr := filepath.Join(pm.config.ExecRoot, p.GetID(), p.GetSocket())</strong>ï¼Œæˆ‘åœ¨ä¸Šé¢æ·»åŠ äº†æ³¨é‡Šã€‚</p>

<p>è¿™ä¸ª<strong>.sock</strong>æ–‡ä»¶åº”è¯¥æœ‰docker pluginæ¥ç”Ÿæˆï¼Œå…·ä½“æ€æ ·ç”Ÿæˆçš„å‘¢ï¼Ÿè¿˜ä»¥<strong>docker-volume-ssh</strong>è¿™ä¸ªæ’ä»¶ä¸ºä¾‹ã€‚</p>

<p>æ•´ä¸ªé¡¹ç›®å°±ä¸€ä¸ª<strong>main.go</strong>æ–‡ä»¶ï¼Œé‡Œé¢æœ€åä¸€è¡Œç”Ÿæˆäº†<strong>/run/docker/plugins/sshfs.sock</strong>è¿™ä¸ªsockã€‚</p>

<pre><code>logrus.Error(h.ServeUnix(socketAddress, 0))
</code></pre>

<p>è¿™è¡Œä»£ç è°ƒç”¨<strong>docker/go-plugin-helpers/sdk/handler.go</strong>ä¸­çš„:</p>

<pre><code class="language-Go">// ServeUnix makes the handler to listen for requests in a unix socket.
// It also creates the socket file on the right directory for docker to read.
func (h Handler) ServeUnix(addr string, gid int) error {
	l, spec, err := newUnixListener(addr, gid)
	if err != nil {
		return err
	}
	if spec != &quot;&quot; {
		defer os.Remove(spec)
	}
	return h.Serve(l)
}

// Serve sets up the handler to serve requests on the passed in listener
func (h Handler) Serve(l net.Listener) error {
	server := http.Server{
		Addr:    l.Addr().String(),
		Handler: h.mux,
	}
	return server.Serve(l)
}
</code></pre>

<pre><code class="language-Go">//unix_listener_unsupoorted.go
func newUnixListener(pluginName string, gid int) (net.Listener, string, error) {
	return nil, &quot;&quot;, errOnlySupportedOnLinuxAndFreeBSD
}
</code></pre>

<p>çœ‹äº†ä¸Šé¢è¿™è¿™äº›ï¼Œä½ çœ‹å‡ºsocketæ–‡ä»¶æ˜¯æ€ä¹ˆåˆ›å»ºçš„å—ï¼Ÿ</p>

<p>è¿™åˆæ˜¯ä¸€ä¸ª<a href="https://github.com/vieux/docker-volume-sshfs/issues/19">issue-19</a></p>

<p>å¦‚æœä½ ä¿®æ”¹<strong>config.json</strong>æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„<strong>interfaces - socket</strong>æŒ‡å®šä¸º<code>/run/docker/plugins/sshfs.sock</code>ç„¶ååˆ›å»ºpluginï¼Œåˆ™èƒ½æˆåŠŸç”Ÿæˆsocketæ–‡ä»¶ï¼Œä½†æ˜¯å½“ä½ enableå®ƒçš„æ—¶å€™åˆä¼šæŠ¥é”™</p>

<pre><code>Error response from daemon: Unix socket path &quot;/run/docker/plugins/ac34f7b246ac6c029023b1ebd48e166eadcdd2c9d0cc682cadca0336951d72f7/run/docker/plugins/sshfs.sock&quot; is too long
</code></pre>

<p>ä»docker daemonçš„æ—¥å¿—é‡Œå¯ä»¥çœ‹åˆ°è¯¦ç»†æŠ¥é”™ï¼š</p>

<pre><code>Mar 13 17:15:20 sz-pg-oam-docker-test-001.tendcloud.com dockerd[51757]: time=&quot;2017-03-13T17:15:20+08:00&quot; level=info msg=&quot;standard_init_linux.go:178: exec user process caused \&quot;no such file or directory\&quot;&quot; plugin=ac34f7b246ac6c029023b1ebd48e166eadcdd2c9d0cc682cadca0336951d72f7
Mar 13 17:15:20 sz-pg-oam-docker-test-001.tendcloud.com dockerd[51757]: time=&quot;2017-03-13T17:15:20.321277088+08:00&quot; level=error msg=&quot;Sending SIGTERM to plugin failed with error: rpc error: code = 2 desc = no such process&quot;
Mar 13 17:15:20 sz-pg-oam-docker-test-001.tendcloud.com dockerd[51757]: time=&quot;2017-03-13T17:15:20.321488680+08:00&quot; level=error msg=&quot;Handler for POST /v1.26/plugins/sshfs/enable returned error: Unix socket path \&quot;/run/docker/plugins/ac34f7b246ac6c029023b1ebd48e166eadcdd2c9d0cc682cadca0336951d72f7/run/docker/plugins/sshfs.sock\&quot; is too long\ngithub.com/docker/docker/plugin.(*Manager).pluginPostStart\n\t/root/rpmbuild/BUILD/docker-engine/.gopath/src/github.com/docker/docker/plugin/manager_linux.go:84\ngithub.com/docker/docker/plugin.(*Manager).enable\n\t/root/rpmbuild/BUILD/docker-
</code></pre>

<p>æ­£å¥½éªŒè¯äº†ä¸Šé¢çš„<strong>enable</strong>ä»£ç ï¼Œdockeré»˜è®¤æ˜¯åˆ°<code>/run/docker/plugins</code>ç›®å½•ä¸‹æ‰¾<strong>sshfs.sock</strong>è¿™ä¸ªæ–‡ä»¶çš„ã€‚</p>

<p>æˆ‘åœ¨docker daemonä¸­å‘ç°ä¸€ä¸ªå¾ˆè¯¡å¼‚çš„é”™è¯¯ï¼Œ</p>

<pre><code>Mar 13 17:29:41 sz-pg-oam-docker-test-001.tendcloud.com dockerd[51757]: time=&quot;2017-03-13T17:29:41+08:00&quot; level=info msg=&quot;standard_init_linux.go:178: exec user process caused \&quot;no such file or directory\&quot;&quot; plugin=85760810b4850009fc965f5c20d8534dc9aba085340a2ac0b4b9167a6fef7d53
</code></pre>

<p>æˆ‘æŸ¥çœ‹äº†ä¸‹<code>github.com/libnetwork/vendor/github.com/opencontainers/run/libcontainer/standard_init_linux.go</code>æ–‡ä»¶ï¼Œè¿™ä¸ªé‚£ä¸ªæ–‡ä»¶åªæœ‰114è¡Œï¼Œè§è¿™é‡Œ<a href="https://github.com/docker/libnetwork/blob/master/vendor/github.com/opencontainers/runc/libcontainer/standard_init_linux.go">https://github.com/docker/libnetwork/blob/master/vendor/github.com/opencontainers/runc/libcontainer/standard_init_linux.go</a></p>

<p>ä½†æ˜¯åœ¨<strong>opencontainers</strong>çš„githubé¡¹ç›®é‡Œæ‰æœ‰é‚£ä¹ˆå¤šè¡Œï¼Œè§è¿™é‡Œï¼š<a href="https://github.com/opencontainers/runc/blob/master/libcontainer/standard_init_linux.go">https://github.com/opencontainers/runc/blob/master/libcontainer/standard_init_linux.go</a></p>

<p>è¿™ä¸ªæŠ¥é”™å‰åçš„å‡½æ•°æ˜¯ï¼š</p>

<pre><code class="language-Go">// PR_SET_NO_NEW_PRIVS isn't exposed in Golang so we define it ourselves copying the value
// the kernel
const PR_SET_NO_NEW_PRIVS = 0x26

func (l *linuxStandardInit) Init() error {
	if !l.config.Config.NoNewKeyring {
		ringname, keepperms, newperms := l.getSessionRingParams()

		// do not inherit the parent's session keyring
		sessKeyId, err := keys.JoinSessionKeyring(ringname)
		if err != nil {
			return err
		}
		// make session keyring searcheable
		if err := keys.ModKeyringPerm(sessKeyId, keepperms, newperms); err != nil {
			return err
		}
	}

...
	}
	if l.config.Config.Seccomp != nil &amp;&amp; l.config.NoNewPrivileges {
         //ä¸‹é¢è¿™è¡Œæ˜¯ç¬¬178è¡Œ
		if err := seccomp.InitSeccomp(l.config.Config.Seccomp); err != nil {
			return newSystemErrorWithCause(err, &quot;init seccomp&quot;)
		}
	}
	// close the statedir fd before exec because the kernel resets dumpable in the wrong order
	// https://github.com/torvalds/linux/blob/v4.9/fs/exec.c#L1290-L1318
	syscall.Close(l.stateDirFD)
	if err := syscall.Exec(name, l.config.Args[0:], os.Environ()); err != nil {
		return newSystemErrorWithCause(err, &quot;exec user process&quot;)
	}
	return nil
}
</code></pre>

<h2 id="ç»“è®º"><del>ç»“è®º</del></h2>

<p><del>åˆ°æ­¤äº†é—®é¢˜è¿˜æ²¡è§£å†³ã€‚</del></p>

<p><del>é—®é¢˜çš„å…³é”®æ˜¯æ‰§è¡Œ<strong>docker create plugin</strong>ä¹‹å<strong>.sock</strong>æ–‡ä»¶åˆ›å»ºåˆ°å“ªé‡Œå»äº†ï¼Ÿä¸ºä»€ä¹ˆåœ¨<strong>config.json</strong>æŒ‡å®šæˆ<code>/run/docker/plugins/sshfs.sock</code>å°±å¯ä»¥åœ¨æŒ‡å®šçš„ç›®å½•ä¸‹åˆ›å»ºå‡º.sockæ–‡ä»¶ï¼Œè¯´æ˜<strong>åˆ›å»ºsocketçš„å®šä¹‰å’Œget socketæ—¶å¯»æ‰¾çš„è·¯å¾„ä¸ä¸€æ ·</strong>ï¼Œåˆ›å»ºsocketæ—¶å°±æ˜¯å›ºå®šåœ¨/run/docker/pluginsç›®å½•ä¸‹åˆ›å»ºï¼Œè€Œenable pluginçš„æ—¶å€™ï¼ŒGet socketçš„æ—¶å€™è¿˜è¦åŠ ä¸Šdocker pluginçš„IDï¼Œå¯æ˜¯æŒ‰ç…§å®˜ç½‘çš„é…ç½®åœ¨æœ¬åœ°create pluginåå¹¶æ²¡æœ‰åœ¨/run/docker/pluginsç›®å½•ä¸‹ç”Ÿæˆæ’ä»¶çš„socketæ–‡ä»¶ï¼Œç›´åˆ°enableæ’ä»¶çš„æ—¶å€™æ‰ä¼šç”Ÿæˆä»¥plugin IDå‘½åçš„ç›®å½•ï¼Œä½†æ˜¯socketæ–‡ä»¶æ²¡æœ‰ï¼â˜¹ï¸</del></p>

<h2 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h2>

<p>ä¹‹æ‰€ä»¥å‡ºç°ä¸Šé¢çš„é‚£äº›é—®é¢˜ï¼Œæ˜¯å› ä¸ºcreate docker pluginçš„æ—¶å€™æœ‰é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æœ‰é—®é¢˜ï¼Œæˆ‘åœ¨<strong>Mac</strong>ä¸Šbuildçš„imageï¼Œè€Œä¸”è¿˜æ²¡æœ‰ç”¨<strong>Dockerfile.dev</strong>è¿™ä¸ªä¸“é—¨ç”¨æ¥æ­å»ºäºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¯‘ç¯å¢ƒçš„Dockerfileæ¥åˆ›å»ºgolangçš„ç¼–è¯‘ç¯å¢ƒï¼Œè™½ç„¶docker pluginæ˜¯åˆ›å»ºæˆåŠŸäº†ï¼Œä½†æ˜¯å½“docker plugin enableçš„æ—¶å€™ï¼Œè¿™ä¸ªçƒ­ç´§å¼ æ–‡ä»¶ä¸èƒ½æ­£ç¡®çš„è¿è¡Œï¼Œæ‰€ä»¥å°±æ²¡èƒ½ç”Ÿæˆ<strong>sshfs.sock</strong>æ–‡ä»¶ã€‚</p>

<blockquote>
<p>è¯·åœ¨Linuxç¯å¢ƒä¸‹ä½¿ç”¨<strong>make all</strong>å‘½ä»¤æ¥åˆ›å»ºpluginã€‚</p>
</blockquote>

            </article>
        </div>
    </section>

    
    

<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Mar 15, 2017 </h4>
        <h5 id="wc"> 1100 Words </h5>
        <h5 id="readtime"> Read in about 5 Min </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li> <a href="http://rootsongjc.github.io//tags/docker">docker</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/docker-plugin">docker plugin</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/plugin">plugin</a> </li>
        
        <li> <a href="http://rootsongjc.github.io//tags/develop">develop</a> </li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://rootsongjc.github.io/blogs/contiv-ultimate/"><i class="icon-arrow-left"></i> Contiv Ultimate-Docker17.03CEä¸‹æ€ç§‘dockerç½‘ç»œæ’ä»¶contivè¶Ÿå‘ç»ˆæç‰ˆ</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/docker-create-plugin/">Docker 17.03-CE create pluginæºç è§£æ <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author</h4>
        <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer in Beijing, also an open source enthusiast and Big Data, Cloud Native fans. If you not see him front of computer, he must be traveling or taking pictures outside,
            visit the amazing pictures at <a href=https://rootsongjc.tuchong.com/>tuchong(å›¾è™«)</a>. Feel free to <a href=https://twitter.com/rootsongjc>follow him on twitter</a>.
        </p>
    </section>

</div>
</aside>

<meta itemprop="wordCount" content="1028">
<meta itemprop="datePublished" content="2017-03-15">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/docker-plugin-develop/">
 <footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

