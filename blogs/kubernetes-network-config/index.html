<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="g8IYR9SNLF" />
    <meta name="uyan_auth" content="419f63884b" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="kubernetes, cloud computing, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="KubernetesåŸºäºflannelçš„ç½‘ç»œé…ç½® : rootsongjc.github.io"/>
<meta property="og:site_name" content="rootsongjc is Jimmy Song"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-03-31"/>
<meta property="article:modified_time" content="2017-03-31"/>



<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="cloud computing">




<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@rootsongjc">
<meta name="twitter:title" content="KubernetesåŸºäºflannelçš„ç½‘ç»œé…ç½® : rootsongjc.github.io">
<meta name="twitter:creator" content="@rootsongjc">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="rootsongjc.github.io">

    <base href="http://rootsongjc.github.io/">
    <title> KubernetesåŸºäºflannelçš„ç½‘ç»œé…ç½® - Jimmy Song </title>
    <link rel="canonical" href="http://rootsongjc.github.io/blogs/kubernetes-network-config/">
    

    
<link rel="stylesheet" href="/static/css/style.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script>hljs.initHighlightingOnLoad();</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61142324" charset="UTF-8"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <figure>
      <a href="/" border=0 id="logolink"><div class="icon-octocat" id="logo"> </div></a>
    </figure>
    <div id="byline">by Jimmy Song</div>
    <nav id="nav">
            <ul id="mainnav">
            <li>
                <a href="/blogs/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> blogs </span>
            </a>
            </li>
            <li>
            <a href="/projects/">
                <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
                <span> projects </span>
            </a>
            </li>
            <li>
            <a href="/talks/">
                <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
                <span> talks </span>
            </a>
            </li>
            <li>
            <a href="http://www.linkedin.com/in/rootsongjc">
                <span class="icon"> <i aria-hidden="true" class="icon-linkedin"></i></span>
                <span> me </span>
            </a>
            </li>
        </ul>

            <ul id="social">
            <li id="share">
                <span class="icon icon-bubbles"> </span>
                <span class="title"> share </span>
                <div class="dropdown share">
                    <ul class="social">
                      <li> <a href="https://twitter.com/intent/tweet?status=Kubernetes%e5%9f%ba%e4%ba%8eflannel%e7%9a%84%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae-http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="https://plus.google.com/share?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Google+" class="googleplus"><span class="icon icon-google-plus"></span>Google+</a> </li>
                        <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f&title=Kubernetes%e5%9f%ba%e4%ba%8eflannel%e7%9a%84%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&source=spf13" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://del.icio.us/post?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Delicious" class="delicious"><span class="icon icon-delicious"></span>Delicious</a> </li>
                        <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2frootsongjc.github.io%2fblogs%2fkubernetes-network-config%2f" target="_blank" title="Reddit" class="reddit"><span class="icon icon-reddit"></span>Reddit</a> </li>
                    </ul>
                    <span class="subcount">sharing is caring</span>
                </div>
            </li>
            <li id="follow">
                <span class="icon icon-rocket"> </span>
                <span class="title"> follow </span>
                <div class="dropdown follow">
                    <ul class="social">
                        <li> <a href="http://www.twitter.com/rootsongjc" target="_blank" title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a> </li>
                        <li> <a href="http://www.facebook.com/rootsongjc" target="_blank" title="Join me on Facebook" class="facebook"><span class="icon icon-facebook"></span>Facebook</a> </li>
                        <li> <a href="http://www.linkedin.com/in/rootsongjc" target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a> </li>
                        <li> <a href="http://github.com/rootsongjc" target="_blank" title="GitHub" class="github"><span class="icon icon-github"></span>GitHub</a> </li>
                        <li> <a href="https://www.douban.com/people/deamonj/" target="_blank" title="è±†ç“£" class="facebook"><span class="icon icon-idea"></span>Douban</a> </li>
                        <li> <a href="https://tuchong.com/1425795/" target="_blank" title="å›¾è™«" class="github"><span class="icon icon-cc-2"></span>Tuchong</a> </li>                    </ul>
                    <span class="subcount">join 10k+ subscribers &amp; followers</span>
                </div>
            </li>
          </ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">KubernetesåŸºäºflannelçš„ç½‘ç»œé…ç½®</h1>
  <div>
        <article itemprop="articleBody" id="content">
           

<p><img src="http://olz1di9xf.bkt.clouddn.com/2014100402.jpg" alt="è¥¿å®‰é¼“æ¥¼" /></p>

<p><em>ï¼ˆé¢˜å›¾ï¼šè¥¿å®‰é¼“æ¥¼ Oct 4,2014ï¼‰</em></p>

<p>ä¹¦æ¥ä¸Šæ–‡<a href="http://rootsongjc.github.io/blogs/kubernetes-installation-on-centos/">åœ¨CentOSä¸­å®‰è£…Kubernetesè¯¦ç»†æŒ‡å—</a>ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»åˆ—æ–‡ç« ï¼Œä½œä¸ºå­¦ä¹ Kubernetesçš„å¿ƒè·¯å†ç¨‹å§ã€‚</p>

<p>æœ¬æ–‡ä¸»è¦è®²è§£<strong>Kubernetesçš„ç½‘ç»œé…ç½®</strong>ï¼ŒğŸ‘†æ–‡ä¸­æœ‰ä¸€ä¸ªå®‰è£…<strong>Flannel</strong>çš„æ­¥éª¤ï¼Œä½†æ˜¯å®‰è£…å¥½åå¹¶æ²¡æœ‰ç›¸åº”çš„é…ç½®è¯´æ˜ã€‚</p>

<h2 id="é…ç½®flannel">é…ç½®flannel</h2>

<p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨çš„yumå®‰è£…çš„flannleï¼Œå®‰è£…å¥½åä¼šç”Ÿæˆ<code>/usr/lib/systemd/system/flanneld.service</code>é…ç½®æ–‡ä»¶ã€‚</p>

<pre><code class="language-ini">[Unit]
Description=Flanneld overlay address etcd agent
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/flanneld
EnvironmentFile=-/etc/sysconfig/docker-network
ExecStart=/usr/bin/flanneld-start $FLANNEL_OPTIONS
ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart=on-failure

[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
</code></pre>

<p>å¯ä»¥çœ‹åˆ°flannelç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶åœ¨<code>/etc/sysconfig/flanneld</code>ã€‚</p>

<pre><code class="language-Ini"># Flanneld configuration options  

# etcd url location.  Point this to the server where etcd runs
FLANNEL_ETCD_ENDPOINTS=&quot;http://sz-pg-oam-docker-test-001.tendcloud.com:2379&quot;

# etcd config key.  This is the configuration key that flannel queries
# For address range assignment
FLANNEL_ETCD_PREFIX=&quot;/kube-centos/network&quot;

# Any additional options that you want to pass
#FLANNEL_OPTIONS=&quot;&quot;
</code></pre>

<ul>
<li>etcdçš„åœ°å€<code>FLANNEL_ETCD_ENDPOINT</code></li>
<li>etcdæŸ¥è¯¢çš„ç›®å½•ï¼ŒåŒ…å«dockerçš„IPåœ°å€æ®µé…ç½®ã€‚<code>FLANNEL_ETCD_PREFIX</code></li>
</ul>

<p><strong>åœ¨etcdä¸­åˆ›å»ºç½‘ç»œé…ç½®</strong></p>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ä¸ºdockeråˆ†é…IPåœ°å€æ®µã€‚</p>

<pre><code class="language-shell">etcdctl mkdir /kube-centos/network
etcdctl mk /kube-centos/network/config &quot;{ \&quot;Network\&quot;: \&quot;172.30.0.0/16\&quot;, \&quot;SubnetLen\&quot;: 24, \&quot;Backend\&quot;: { \&quot;Type\&quot;: \&quot;vxlan\&quot; } }&quot;
</code></pre>

<p><strong>é…ç½®Docker</strong></p>

<p>Flannelçš„<a href="https://github.com/coreos/flannel/blob/master/Documentation/running.md">æ–‡æ¡£</a>ä¸­æœ‰å†™<strong>Docker Integration</strong>ï¼š</p>

<p>Docker daemon accepts <code>--bip</code> argument to configure the subnet of the docker0 bridge. It also accepts <code>--mtu</code> to set the MTU for docker0 and veth devices that it will be creating. Since flannel writes out the acquired subnet and MTU values into a file, the script starting Docker can source in the values and pass them to Docker daemon:</p>

<pre><code>source /run/flannel/subnet.env
docker daemon --bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU} &amp;
</code></pre>

<p>Systemd users can use <code>EnvironmentFile</code> directive in the .service file to pull in <code>/run/flannel/subnet.env</code></p>

<p>ä¸‹è½½flannel github releaseä¸­çš„taråŒ…ï¼Œè§£å‹åä¼šè·å¾—ä¸€ä¸ª<strong>mk-docker-opts.sh</strong>æ–‡ä»¶ã€‚</p>

<p>è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥<code>Generate Docker daemon options based on flannel env file</code>ã€‚</p>

<p>æ‰§è¡Œ<code>./mk-docker-opts.sh -i</code>å°†ä¼šç”Ÿæˆå¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶ç¯å¢ƒå˜é‡æ–‡ä»¶ã€‚</p>

<p>/run/flannel/subnet.env</p>

<pre><code>FLANNEL_NETWORK=172.30.0.0/16
FLANNEL_SUBNET=172.30.46.1/24
FLANNEL_MTU=1450
FLANNEL_IPMASQ=false
</code></pre>

<p>/run/docker_opts.env</p>

<pre><code>DOCKER_OPT_BIP=&quot;--bip=172.30.46.1/24&quot;
DOCKER_OPT_IPMASQ=&quot;--ip-masq=true&quot;
DOCKER_OPT_MTU=&quot;--mtu=1450&quot;
</code></pre>

<p>ç°åœ¨æŸ¥è¯¢etcdä¸­çš„å†…å®¹å¯ä»¥çœ‹åˆ°ï¼š</p>

<pre><code>$etcdctl ls /kube-centos/network/subnets
/kube-centos/network/subnets/172.30.14.0-24
/kube-centos/network/subnets/172.30.38.0-24
/kube-centos/network/subnets/172.30.46.0-24
$etcdctl get /kube-centos/network/config
{ &quot;Network&quot;: &quot;172.30.0.0/16&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: { &quot;Type&quot;: &quot;vxlan&quot; } }
$etcdctl get /kube-centos/network/subnets/172.30.14.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.114&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;56:27:7d:1c:08:22&quot;}}
$etcdctl get /kube-centos/network/subnets/172.30.38.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.115&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;12:82:83:59:cf:b8&quot;}}
$etcdctl get /kube-centos/network/subnets/172.30.46.0-24
{&quot;PublicIP&quot;:&quot;172.20.0.113&quot;,&quot;BackendType&quot;:&quot;vxlan&quot;,&quot;BackendData&quot;:{&quot;VtepMAC&quot;:&quot;e6:b2:fd:f6:66:96&quot;}}
</code></pre>

<p><strong>è®¾ç½®docker0ç½‘æ¡¥çš„IPåœ°å€</strong></p>

<pre><code class="language-shell">source /run/flannel/subnet.env
ifconfig docker0 $FLANNEL_SUBNET
</code></pre>

<p>è¿™æ ·docker0å’Œflannelç½‘æ¡¥ä¼šåœ¨åŒä¸€ä¸ªå­ç½‘ä¸­ï¼Œå¦‚</p>

<pre><code>6: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN 
    link/ether 02:42:da:bf:83:a2 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.1/24 brd 172.30.38.255 scope global docker0
       valid_lft forever preferred_lft forever
7: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN 
    link/ether 9a:29:46:61:03:44 brd ff:ff:ff:ff:ff:ff
    inet 172.30.38.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
</code></pre>

<p>ç°åœ¨å°±å¯ä»¥é‡å¯dockeräº†ã€‚</p>

<p>é‡å¯äº†dockeråè¿˜è¦é‡å¯kubeletï¼Œè¿™æ—¶åˆé‡åˆ°é—®é¢˜ï¼Œkubeletå¯åŠ¨å¤±è´¥ã€‚æŠ¥é”™ï¼š</p>

<pre><code>Mar 31 16:44:41 sz-pg-oam-docker-test-002.tendcloud.com kubelet[81047]: error: failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;
</code></pre>

<p>è¿™æ˜¯kubeletä¸dockerçš„<strong>cgroup driver</strong>ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œkubeletå¯åŠ¨çš„æ—¶å€™æœ‰ä¸ª<code>â€”cgroup-driver</code>å‚æ•°å¯ä»¥æŒ‡å®šä¸º&rdquo;cgroupfs&rdquo;æˆ–è€…â€œsystemdâ€ã€‚</p>

<pre><code>--cgroup-driver string                                    Driver that the kubelet uses to manipulate cgroups on the host.  Possible values: 'cgroupfs', 'systemd' (default &quot;cgroupfs&quot;)
</code></pre>

<p><strong>å¯åŠ¨flannel</strong></p>

<pre><code class="language-shell">systemctl daemon-reload
systemctl start flanneld
systemctl status flanneld
</code></pre>

<p>é‡æ–°ç™»å½•è¿™ä¸‰å°ä¸»æœºï¼Œå¯ä»¥çœ‹åˆ°æ¯å°ä¸»æœºéƒ½å¤šäº†ä¸€ä¸ªIPã€‚</p>

<p>å‚è€ƒKuberneteså®˜æ–¹æ–‡æ¡£çš„<a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/">Exposing an External IP Address to Access an Application in a Cluster</a>ï¼Œå®˜æ–¹ä½¿ç”¨çš„Hello Worldæµ‹è¯•ï¼Œæˆ‘ä»¬å¯åŠ¨NginxæœåŠ¡æµ‹è¯•ã€‚</p>

<pre><code class="language-Shell">#å¯åŠ¨nginxçš„pod
kubectl run nginx --replicas=2 --labels=&quot;run=load-balancer-example&quot; --image=sz-pg-oam-docker-hub-001.tendcloud.com/library/nginx:1.9  --port=80
#åˆ›å»ºåä¸ºexample-serviceçš„æœåŠ¡
kubectl expose deployment nginx --type=NodePort --name=example-service
#æŸ¥çœ‹çŠ¶æ€
kubectl get deployments nginx
kubectl describe deployments nginx
kubectl get replicasets
kubectl describe replicasets
kubectl describe svc example-service
###################################################
Name:			example-service
Namespace:		default
Labels:			run=load-balancer-example
Annotations:		&lt;none&gt;
Selector:		run=load-balancer-example
Type:			NodePort
IP:			10.254.180.209
Port:			&lt;unset&gt;	80/TCP
NodePort:		&lt;unset&gt;	32663/TCP
Endpoints:		172.30.14.2:80,172.30.46.2:80
Session Affinity:	None
Events:			&lt;none&gt;
</code></pre>

<p>æˆ‘ä»¬ä¸Šé¢å¯åŠ¨çš„serivceçš„typeæ˜¯<strong>NodePort</strong>ï¼ŒKubernetesçš„serviceæ”¯æŒä¸‰ç§ç±»å‹çš„serviceï¼Œå‚è€ƒ<a href="http://www.cnblogs.com/xuxinkun/p/5331728.html">Kubernetes Serivceåˆ†æ</a>ã€‚</p>

<p>ç°åœ¨è®¿é—®ä¸‰å°ç‰©ç†æœºçš„IP:80ç«¯å£å°±å¯ä»¥çœ‹åˆ°nginxçš„é¡µé¢äº†ã€‚</p>

<p>ç¨ç­‰ä¸€ä¼šåœ¨è®¿é—®ClusterIP + Portä¹Ÿå¯ä»¥è®¿é—®åˆ°nginxã€‚</p>

<pre><code>$curl 10.254.180.209:80
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h2 id="è™šæ‹Ÿåœ°å€">è™šæ‹Ÿåœ°å€</h2>

<p>Kubernetesä¸­çš„Serviceäº†ä½¿ç”¨äº†è™šæ‹Ÿåœ°å€ï¼›è¯¥åœ°å€æ— æ³•pingé€šè¿‡ï¼Œä½†å¯ä»¥è®¿é—®å…¶ç«¯å£ã€‚é€šè¿‡ä¸‹é¢çš„å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œè¯¥è™šæ‹Ÿåœ°å€æ˜¯è‹¥å¹²æ¡iptablesçš„è§„åˆ™ã€‚åˆ°10.254.124.145:8080ç«¯å£çš„è¯·æ±‚ä¼šè¢«é‡å®šå‘åˆ°172.30.38.2æˆ–172.30.46.2çš„8080ç«¯å£ã€‚è¿™äº›è§„åˆ™æ˜¯ç”±kube-proxyç”Ÿæˆï¼›å¦‚æœéœ€è¦æŸå°æœºå™¨å¯ä»¥è®¿é—®Serviceï¼Œåˆ™éœ€è¦åœ¨è¯¥ä¸»æœºå¯åŠ¨kube-proxyã€‚</p>

<p><strong>æŸ¥çœ‹serviceçš„iptables</strong></p>

<pre><code>$iptables-save|grep example-service
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 32663 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp --dport 32663 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SEP-NCPBOLUH5XTTHG3E -s 172.30.46.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-NCPBOLUH5XTTHG3E -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.46.2:80
-A KUBE-SEP-ONEKQBIWICF7RAR3 -s 172.30.14.2/32 -m comment --comment &quot;default/example-service:&quot; -j KUBE-MARK-MASQ
-A KUBE-SEP-ONEKQBIWICF7RAR3 -p tcp -m comment --comment &quot;default/example-service:&quot; -m tcp -j DNAT --to-destination 172.30.14.2:80
-A KUBE-SERVICES -d 10.254.180.209/32 -p tcp -m comment --comment &quot;default/example-service: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-BR4KARPIGKMRMN3E
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-ONEKQBIWICF7RAR3
-A KUBE-SVC-BR4KARPIGKMRMN3E -m comment --comment &quot;default/example-service:&quot; -j KUBE-SEP-NCPBOLUH5XTTHG3E
</code></pre>

<p><strong>æŸ¥çœ‹clusterIPçš„iptables</strong></p>

<pre><code>$iptables -t nat -nL|grep 10.254
KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  0.0.0.0/0            10.254.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443
KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.180.209       /* default/example-service: cluster IP */ tcp dpt:80
</code></pre>

<p>å¯ä»¥çœ‹åˆ°åœ¨PREROUTINGç¯èŠ‚ï¼Œk8sè®¾ç½®äº†ä¸€ä¸ªtarget: KUBE-SERVICESã€‚è€ŒKUBE-SERVICESä¸‹é¢åˆè®¾ç½®äº†è®¸å¤štargetï¼Œä¸€æ—¦destinationå’ŒdstportåŒ¹é…ï¼Œå°±ä¼šæ²¿ç€chainè¿›è¡Œå¤„ç†ã€‚</p>

<p>æ¯”å¦‚ï¼šå½“æˆ‘ä»¬åœ¨podç½‘ç»œcurl 10.254.198.44 80æ—¶ï¼ŒåŒ¹é…åˆ°ä¸‹é¢çš„KUBE-SVC-BR4KARPIGKMRMN3E targetï¼š</p>

<pre><code>KUBE-SVC-BR4KARPIGKMRMN3E  tcp  --  0.0.0.0/0            10.254.180.209       /* default/example-service: cluster IP */ tcp dpt:80
</code></pre>

<p>å‚è€ƒ<a href="http://tonybai.com/2017/01/17/understanding-flannel-network-for-kubernetes/">ç†è§£Kubernetesç½‘ç»œä¹‹Flannelç½‘ç»œ</a>ï¼ŒTony Baiçš„æ–‡ç« ä¸­æœ‰å¯¹flannelçš„è¯¦ç»†ä»‹ç»ã€‚</p>

<h2 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h2>

<p>åœ¨è®¾ç½®ç½‘ç»œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œè®°å½•å¦‚ä¸‹ã€‚</p>

<h3 id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</h3>

<p><strong>é—®é¢˜æè¿°</strong></p>

<p>Kube-proxyå¼€æ”¾çš„<strong>NodePort</strong>ç«¯å£æ— æ³•è®¿é—®ã€‚å³æ— æ³•ä½¿ç”¨NodeIPåŠ NodePortçš„æ–¹å¼è®¿é—®serviceï¼Œè€Œä¸”æœ¬åœ°telnetä¹Ÿä¸é€šï¼Œä½†æ˜¯ç«¯å£ç¡®ç¡®å®å®åœ¨é‚£ã€‚</p>

<p><strong>é—®é¢˜çŠ¶æ€</strong></p>

<p>å·²è§£å†³</p>

<p><strong>è§£å†³æ–¹æ³•</strong></p>

<p>å…¶å®è¿™ä¸æ˜¯é—®é¢˜ï¼Œæ˜¯å› ä¸ºä»ä¸Šé¢çš„æ“ä½œè®°å½•ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<strong>åœ¨å¯åŠ¨Nginxçš„Pod</strong>æ—¶ï¼ŒæŒ‡å®športä¸º80å³å¯ã€‚ä»¥ClusterIP + Portçš„æ–¹å¼è®¿é—®serivceéœ€è¦ç­‰ä¸€æ®µæ—¶é—´ã€‚</p>

<p><strong>åæ€</strong></p>

<p>è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘ä»¬å·®ä¸å¤šä¸¤å¤©æ—¶é—´ï¼Œå‡ºç°è¿™ä¸ªé—®é¢˜çš„æ ¹æºè¿˜æ˜¯å› ä¸º<u>æ€æƒ³è§‚å¿µæ²¡æœ‰ä»è¿è¡Œdockerçš„å‘½ä»¤ä¸­è§£æ”¾å‡ºæ¥</u>,è¿˜æŠŠ<code>kubelet run â€”port</code>å½“æˆæ˜¯docker runä¸­çš„ç«¯å£æ˜ å°„ï¼Œè¿™ç§æƒ³æ³•æ˜¯å¤§é”™ç‰¹é”™çš„ï¼Œè¯¥ç«¯å£æ˜¯imageä¸­çš„åº”ç”¨å®é™…æš´éœ²çš„ç«¯å£ï¼Œå¦‚nginxçš„80ç«¯å£ã€‚ğŸ˜”</p>

<h3 id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</h3>

<p><strong>é—®é¢˜æè¿°</strong></p>

<p>åœ¨æ²¡æœ‰åˆ é™¤serviceå’Œdeployçš„æƒ…å†µä¸‹å°±é‡å¯kubeletçš„æ—¶å€™ï¼Œä¼šé‡åˆ°kubeletå¯åŠ¨å¤±è´¥çš„æƒ…å†µã€‚</p>

<p><strong>å‡ºé”™ä¿¡æ¯</strong></p>

<pre><code>Apr 01 14:24:08 sz-pg-oam-docker-test-001.tendcloud.com kubelet[103932]: I0401 14:24:08.359839  103932 kubelet.go:1752] skipping pod synchronization - [Failed to start ContainerManager failed to initialise top level QOS containers: failed to create top level Burstable QOS cgroup : Unit kubepods-burstable.slice already exists.]
</code></pre>

<p><a href="http://www.osbaike.net/article-show-id-229028.html">Kubernetes Resource QoSæœºåˆ¶è§£è¯»</a>ï¼Œè¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†QoSçš„æœºåˆ¶ã€‚</p>

<p>Kubernetesæ ¹æ®Podä¸­Containers Resourceçš„<code>request</code>å’Œ<code>limit</code>çš„å€¼æ¥å®šä¹‰Podçš„QoS Classã€‚</p>

<p>å¯¹äºæ¯ä¸€ç§Resourceéƒ½å¯ä»¥å°†å®¹å™¨åˆ†ä¸º3ä¸­QoS Classes: Guaranteed, Burstable, and Best-Effortï¼Œå®ƒä»¬çš„QoSçº§åˆ«ä¾æ¬¡é€’å‡ã€‚</p>

<ul>
<li><strong>Guaranteed</strong>ï¼šå¦‚æœPodä¸­æ‰€æœ‰Containerçš„æ‰€æœ‰Resourceçš„<code>limit</code>å’Œ<code>request</code>éƒ½ç›¸ç­‰ä¸”ä¸ä¸º0ï¼Œåˆ™è¿™ä¸ªPodçš„QoS Classå°±æ˜¯Guaranteedã€‚</li>
<li><strong>Burstable</strong>ï¼šé™¤äº†ç¬¦åˆGuaranteedå’ŒBest-Effortçš„åœºæ™¯ï¼Œå…¶ä»–åœºæ™¯çš„Pod QoS Classéƒ½å±äºBurstableã€‚</li>
<li><strong>Best-Effort</strong>ï¼šå¦‚æœPodä¸­æ‰€æœ‰å®¹å™¨çš„æ‰€æœ‰Resourceçš„requestå’Œlimitéƒ½æ²¡æœ‰èµ‹å€¼ï¼Œåˆ™è¿™ä¸ªPodçš„QoS Classå°±æ˜¯Best-Effortã€‚</li>
</ul>

<p><strong>è§£å†³æ–¹æ³•</strong></p>

<p>è¿™ä¸ªæš‚æ—¶è¿˜æ²¡æ‰¾åˆ°æ ¹æœ¬çš„è§£å†³åŠæ³•ï¼Œå‚è€ƒGithubä¸Šçš„<a href="https://github.com/kubernetes/kubernetes/issues/43856">Failed to start ContainerManager failed to initialize top level QOS containers #43856</a>ï¼Œé‡å¯ä¸»æœºåç¡®å®æ­£å¸¸äº†ï¼Œä¸è¿‡è¿™åªæ˜¯ä¸´æ—¶è§£å†³æ–¹æ³•ã€‚</p>

<h2 id="åè®°">åè®°</h2>

<p>å…¶å®æ˜¨å¤©å°±å·²ç»å®‰è£…å®Œæ¯•äº†ï¼Œæ˜¯æˆ‘ä»¬ä½¿ç”¨çš„å§¿åŠ¿ä¸å¯¹ï¼Œç™½ç™½è€½è¯¯è¿™ä¹ˆé•¿æ—¶é—´ï¼Œèº«è¾¹å·®ä¸ªè€å¸æœºå•Šï¼Œæ»´ï½å­¦ç”Ÿå¡ã€‚</p>

<p>æ„Ÿè°¢<a href="tonybai.com">Tony Bai</a>ã€<a href="https://godliness.github.io/">Peter Ma</a>çš„å¤§åŠ›æ”¯æŒã€‚</p>

<p>Apr 1,2017 æ„šäººèŠ‚ï¼Œä¸œç›´é—¨</p>

        </article>
  </div>
</section>



<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Fri Mar 31, 2017 </h4>
          <h5 id="wc"> 800 Words </h5>
          <h5 id="readtime"> Read in about 4 Min </h5>
        </section>
        <ul id="categories">
          
        </ul>
        <ul id="tags">
          
            <li> <a href="http://rootsongjc.github.io//tags/kubernetes">kubernetes</a> </li>
          
            <li> <a href="http://rootsongjc.github.io//tags/cloud-computing">cloud computing</a> </li>
          
        </ul>
    </div>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="http://rootsongjc.github.io/talks/picture-process/"><i class="icon-arrow-left"></i> ä¸¤ä¸ªå›¾ç‰‡å¤„ç†å·¥å…·â€”â€”Google Guetzliå’ŒåŸºäºAIçš„Deep Photo Style Transfer</a><br>
        </section><section id="next">
            &nbsp;<a class="next" href="http://rootsongjc.github.io/blogs/tensorflow-practice-03/">TensorFlowå®æˆ˜ï¼ˆæ‰äº‘éƒ‘æ³½å®‡è‘—ï¼‰è¯»ä¹¦ç¬”è®°â€”â€”ç¬¬ä¸‰ç« TensorFlowå…¥é—¨ <i class="icon-arrow-right"></i></a>
        </section>
    </div>

    <div>
        <section id="author">
             <h4>About the Author:</h4>
            <p>
            <a href="http://rootsongjc.github.io/about/">Jimmy Song</a> is a software engineer living in Beijing, he usually likes to hack on open source softwares, traveling and photographing. He is familiar with Java, python, golang, PAAS, hadoop and docker ecosystem. He took photos particularly sticky,<a href=https://tuchong.com/1425795/>Jimmy's tuchong homepage</a>.
            He has recently been keen on micro-services, DevOps, Kubernetes, TensorFlow and software architecture research.
            </p>
        </section>

</div>

</aside>

<meta itemprop="wordCount" content="771">
<meta itemprop="datePublished" content="2017-03-31">
<meta itemprop="url" content="http://rootsongjc.github.io/blogs/kubernetes-network-config/">


<aside id=comments>
    <div><h2> Comments </h2></div>
    
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2126256"></script>
    
</aside>

<footer>
  <div>
    <p>
    &copy; 2013-2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jimmy Song</span></span>
    Powered by <a href="http://gohugo.io">Hugo</a>.
    </p>
  </div>
</footer>
</body>
</html>

