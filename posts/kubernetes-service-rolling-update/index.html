<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> Kubernetesä¸­çš„Rolling UpdateæœåŠ¡æ»šåŠ¨å‡çº§ - Cloud NativeğŸ¤˜Big Data</title>
  <meta name="description" content="Cloud NativeğŸ¤˜Big Data" />
  <meta property="og:title" content="Kubernetesä¸­çš„Rolling UpdateæœåŠ¡æ»šåŠ¨å‡çº§" />
  <meta name="twitter:title" content="Kubernetesä¸­çš„Rolling UpdateæœåŠ¡æ»šåŠ¨å‡çº§" />
  <meta name="description" content="ï¼ˆé¢˜å›¾ï¼šåæµ·å¤œè‰² Apr 30,2017ï¼‰ å‰è¨€ æœ¬æ–‡å·²åŒæ­¥åˆ°gitbook kubernetes-handbookçš„ç¬¬8ç« ç¬¬1èŠ‚ã€‚ æœ¬æ–‡è¯´æ˜åœ¨Kubern">
  <meta property="og:description" content="ï¼ˆé¢˜å›¾ï¼šåæµ·å¤œè‰² Apr 30,2017ï¼‰ å‰è¨€ æœ¬æ–‡å·²åŒæ­¥åˆ°gitbook kubernetes-handbookçš„ç¬¬8ç« ç¬¬1èŠ‚ã€‚ æœ¬æ–‡è¯´æ˜åœ¨Kubern">
  <meta name="twitter:description" content="ï¼ˆé¢˜å›¾ï¼šåæµ·å¤œè‰² Apr 30,2017ï¼‰ å‰è¨€ æœ¬æ–‡å·²åŒæ­¥åˆ°gitbook kubernetes-handbookçš„ç¬¬8ç« ç¬¬1èŠ‚ã€‚ æœ¬æ–‡è¯´æ˜åœ¨Kubern">
  <meta name="author" content="{Description { .Site.Author.name }}"/>
  <link href='https://jimmysong.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://jimmysong.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://jimmysong.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jimmysongio" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/posts/kubernetes-service-rolling-update/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jimmy Song" />

  <meta name="generator" content="Hugo 0.30-DEV" />
  <link rel="canonical" href="https://jimmysong.io/posts/kubernetes-service-rolling-update/" />
  <link rel="alternate" href="https://jimmysong.io/index.xml" type="application/rss+xml" title="Jimmy Song">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://jimmysong.io/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  

<meta name="baidu-site-verification" content="g8IYR9SNLF" />
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>

<link rel="stylesheet" href="https://jimmysong.io/css/prism.css" />



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jimmysong.io/">Jimmy Song</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Articles</a>
              <div class="navlinks-children">
                
                  <a href="/posts">Posts</a>
                
                  <a href="/tags">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Categories</a>
              <div class="navlinks-children">
                
                  <a href="/categories/kubernetes">kubernetes</a>
                
                  <a href="/categories/cloud-native">Cloud Native</a>
                
                  <a href="/categories/github">Github</a>
                
                  <a href="/categories/devops">Devops</a>
                
                  <a href="/categories/docker">Docker</a>
                
                  <a href="/categories/code">Code</a>
                
                  <a href="/categories/architecture/">Architecture</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Books</a>
              <div class="navlinks-children">
                
                  <a href="/cloud-native-go">Cloud Native Go</a>
                
                  <a href="/posts/cloud-native-python">Cloud Native Python</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                  <a href="/kubernetes-handbook">Kubernetes handbook</a>
                
                  <a href="/spark-on-k8s">Spark on kubernetes</a>
                
                  <a href="/awesome-cloud-native">Awesome Cloud Native</a>
                
                  <a href="/migrating-to-cloud-native-application-architectures"> Migrating to Cloud native</a>
                
                  <a href="http://istio.doczh.cn">Istio service mesh</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Jimmy Song" href="https://jimmysong.io/">
            <img class="avatar-img" src="https://jimmysong.io/img/avatar-icon.png" alt="Jimmy Song" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
            
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">Kubernetesä¸­çš„Rolling UpdateæœåŠ¡æ»šåŠ¨å‡çº§</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            <div>
                <section id="datecount">
                    <h4 id="date"> Wed May 10, 2017</h4>
                </section>
                <h5 id="wc">3000 Words|Read in about 6 Min</h5>
                <h5 id="tags">Tags: 
                    <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> &nbsp;
                </h5>

            </div>
            <article role="main" class="blog-post">
                

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/20170430014.jpg" alt="åæµ·å¤œè‰²" /></p>

<p><em>ï¼ˆé¢˜å›¾ï¼šåæµ·å¤œè‰² Apr 30,2017ï¼‰</em></p>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>æœ¬æ–‡å·²åŒæ­¥åˆ°gitbook <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a>çš„ç¬¬8ç« ç¬¬1èŠ‚ã€‚</p>

<p>æœ¬æ–‡è¯´æ˜åœ¨Kubernetes1.6ä¸­æœåŠ¡å¦‚ä½•æ»šåŠ¨å‡çº§ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæµ‹è¯•ã€‚</p>

<p>å½“æœ‰é•œåƒå‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬æœåŠ¡ä¸Šçº¿æ—¶å¦‚ä½•å®ç°æœåŠ¡çš„æ»šåŠ¨å’Œå¹³æ»‘å‡çº§ï¼Ÿ</p>

<p>å¦‚æœä½ ä½¿ç”¨<strong>ReplicationController</strong>åˆ›å»ºçš„podå¯ä»¥ä½¿ç”¨<code>kubectl rollingupdate</code>å‘½ä»¤æ»šåŠ¨å‡çº§ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯<strong>Deployment</strong>åˆ›å»ºçš„Podå¯ä»¥ç›´æ¥ä¿®æ”¹yamlæ–‡ä»¶åæ‰§è¡Œ<code>kubectl apply</code>å³å¯ã€‚</p>

<p>Deploymentå·²ç»å†…ç½®äº†RollingUpdate strategyï¼Œå› æ­¤ä¸ç”¨å†è°ƒç”¨<code>kubectl rollingupdate</code>å‘½ä»¤ï¼Œå‡çº§çš„è¿‡ç¨‹æ˜¯å…ˆåˆ›å»ºæ–°ç‰ˆçš„podå°†æµé‡å¯¼å…¥åˆ°æ–°podä¸Šåé”€æ¯åŸæ¥çš„æ—§çš„podã€‚</p>

<p>Rolling Updateé€‚ç”¨äº<code>Deployment</code>ã€<code>Replication Controller</code>ï¼Œå®˜æ–¹æ¨èä½¿ç”¨Deploymentè€Œä¸å†ä½¿ç”¨Replication Controllerã€‚</p>

<p>ä½¿ç”¨ReplicationControlleræ—¶çš„æ»šåŠ¨å‡çº§è¯·å‚è€ƒå®˜ç½‘è¯´æ˜ï¼š<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</a></p>

<h2 id="replicationcontrollerä¸deploymentçš„å…³ç³»">ReplicationControllerä¸Deploymentçš„å…³ç³»</h2>

<p>ReplicationControllerå’ŒDeploymentçš„RollingUpdateå‘½ä»¤æœ‰äº›ä¸åŒï¼Œä½†æ˜¯å®ç°çš„æœºåˆ¶æ˜¯ä¸€æ ·çš„ï¼Œå…³äºè¿™ä¸¤ä¸ªkindçš„å…³ç³»æˆ‘å¼•ç”¨äº†<a href="https://segmentfault.com/a/1190000008232770">ReplicationControllerä¸Deploymentçš„åŒºåˆ«</a>ä¸­çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼Œè¯¦ç»†åŒºåˆ«è¯·æŸ¥çœ‹åŸæ–‡ã€‚</p>

<h3 id="replicationcontroller">ReplicationController</h3>

<p>Replication Controllerä¸ºKubernetesçš„ä¸€ä¸ªæ ¸å¿ƒå†…å®¹ï¼Œåº”ç”¨æ‰˜ç®¡åˆ°Kubernetesä¹‹åï¼Œéœ€è¦ä¿è¯åº”ç”¨èƒ½å¤ŸæŒç»­çš„è¿è¡Œï¼ŒReplication Controllerå°±æ˜¯è¿™ä¸ªä¿è¯çš„keyï¼Œä¸»è¦çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

<ul>
<li>ç¡®ä¿podæ•°é‡ï¼šå®ƒä¼šç¡®ä¿Kubernetesä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podåœ¨è¿è¡Œã€‚å¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„podï¼ŒReplication Controllerä¼šåˆ›å»ºæ–°çš„ï¼Œåä¹‹åˆ™ä¼šåˆ é™¤æ‰å¤šä½™çš„ä»¥ä¿è¯Podæ•°é‡ä¸å˜ã€‚</li>
<li>ç¡®ä¿podå¥åº·ï¼šå½“podä¸å¥åº·ï¼Œè¿è¡Œå‡ºé”™æˆ–è€…æ— æ³•æä¾›æœåŠ¡æ—¶ï¼ŒReplication Controllerä¹Ÿä¼šæ€æ­»ä¸å¥åº·çš„podï¼Œé‡æ–°åˆ›å»ºæ–°çš„ã€‚</li>
<li>å¼¹æ€§ä¼¸ç¼© ï¼šåœ¨ä¸šåŠ¡é«˜å³°æˆ–è€…ä½å³°æœŸçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡Replication ControlleråŠ¨æ€çš„è°ƒæ•´podçš„æ•°é‡æ¥æé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚åŒæ—¶ï¼Œé…ç½®ç›¸åº”çš„ç›‘æ§åŠŸèƒ½ï¼ˆHroizontal Pod Autoscalerï¼‰ï¼Œä¼šå®šæ—¶è‡ªåŠ¨ä»ç›‘æ§å¹³å°è·å–Replication Controllerå…³è”podçš„æ•´ä½“èµ„æºä½¿ç”¨æƒ…å†µï¼Œåšåˆ°è‡ªåŠ¨ä¼¸ç¼©ã€‚</li>
<li>æ»šåŠ¨å‡çº§ï¼šæ»šåŠ¨å‡çº§ä¸ºä¸€ç§å¹³æ»‘çš„å‡çº§æ–¹å¼ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼Œä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šï¼Œåœ¨åˆå§‹åŒ–å‡çº§çš„æ—¶å€™å°±å¯ä»¥åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ï¼Œé¿å…é—®é¢˜ä¸æ–­æ‰©å¤§ã€‚</li>
</ul>

<h3 id="deployment">Deployment</h3>

<p>DeploymentåŒæ ·ä¸ºKubernetesçš„ä¸€ä¸ªæ ¸å¿ƒå†…å®¹ï¼Œä¸»è¦èŒè´£åŒæ ·æ˜¯ä¸ºäº†ä¿è¯podçš„æ•°é‡å’Œå¥åº·ï¼Œ90%çš„åŠŸèƒ½ä¸Replication Controllerå®Œå…¨ä¸€æ ·ï¼Œå¯ä»¥çœ‹åšæ–°ä¸€ä»£çš„Replication Controllerã€‚ä½†æ˜¯ï¼Œå®ƒåˆå…·å¤‡äº†Replication Controllerä¹‹å¤–çš„æ–°ç‰¹æ€§ï¼š</p>

<ul>
<li>Replication Controllerå…¨éƒ¨åŠŸèƒ½ï¼šDeploymentç»§æ‰¿äº†ä¸Šé¢æè¿°çš„Replication Controllerå…¨éƒ¨åŠŸèƒ½ã€‚</li>
<li>äº‹ä»¶å’ŒçŠ¶æ€æŸ¥çœ‹ï¼šå¯ä»¥æŸ¥çœ‹Deploymentçš„å‡çº§è¯¦ç»†è¿›åº¦å’ŒçŠ¶æ€ã€‚</li>
<li>å›æ»šï¼šå½“å‡çº§podé•œåƒæˆ–è€…ç›¸å…³å‚æ•°çš„æ—¶å€™å‘ç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šçš„ç‰ˆæœ¬æˆ–è€…æŒ‡å®šçš„ç‰ˆæœ¬ã€‚</li>
<li>ç‰ˆæœ¬è®°å½•: æ¯ä¸€æ¬¡å¯¹Deploymentçš„æ“ä½œï¼Œéƒ½èƒ½ä¿å­˜ä¸‹æ¥ï¼Œç»™äºˆåç»­å¯èƒ½çš„å›æ»šä½¿ç”¨ã€‚</li>
<li>æš‚åœå’Œå¯åŠ¨ï¼šå¯¹äºæ¯ä¸€æ¬¡å‡çº§ï¼Œéƒ½èƒ½å¤Ÿéšæ—¶æš‚åœå’Œå¯åŠ¨ã€‚</li>
<li>å¤šç§å‡çº§æ–¹æ¡ˆï¼šRecreateï¼šåˆ é™¤æ‰€æœ‰å·²å­˜åœ¨çš„pod,é‡æ–°åˆ›å»ºæ–°çš„; RollingUpdateï¼šæ»šåŠ¨å‡çº§ï¼Œé€æ­¥æ›¿æ¢çš„ç­–ç•¥ï¼ŒåŒæ—¶æ»šåŠ¨å‡çº§æ—¶ï¼Œæ”¯æŒæ›´å¤šçš„é™„åŠ å‚æ•°ï¼Œä¾‹å¦‚è®¾ç½®æœ€å¤§ä¸å¯ç”¨podæ•°é‡ï¼Œæœ€å°å‡çº§é—´éš”æ—¶é—´ç­‰ç­‰ã€‚</li>
</ul>

<h2 id="åˆ›å»ºæµ‹è¯•é•œåƒ">åˆ›å»ºæµ‹è¯•é•œåƒ</h2>

<p>æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªç‰¹åˆ«ç®€å•çš„webæœåŠ¡ï¼Œå½“ä½ è®¿é—®ç½‘é¡µæ—¶ï¼Œå°†è¾“å‡ºä¸€å¥ç‰ˆæœ¬ä¿¡æ¯ã€‚é€šè¿‡åŒºåˆ†è¿™å¥ç‰ˆæœ¬ä¿¡æ¯è¾“å‡ºæˆ‘ä»¬å°±å¯ä»¥æ–­å®šå‡çº§æ˜¯å¦å®Œæˆã€‚</p>

<p>æ‰€æœ‰é…ç½®å’Œä»£ç è§Githubä¸Šçš„<a href="https://github.com/rootsongjc/kubernetes-handbook/tree/master/manifests/test/rolling-update-test">manifests/test/rolling-update-test</a>ç›®å½•ã€‚</p>

<p><strong>WebæœåŠ¡çš„ä»£ç main.go</strong></p>

<pre><code class="language-Go">package main

import (
	&quot;fmt&quot;
	&quot;log&quot;
	&quot;net/http&quot;
)

func sayhello(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, &quot;This is version 1.&quot;) //è¿™ä¸ªå†™å…¥åˆ°wçš„æ˜¯è¾“å‡ºåˆ°å®¢æˆ·ç«¯çš„
}

func main() {
	http.HandleFunc(&quot;/&quot;, sayhello) //è®¾ç½®è®¿é—®çš„è·¯ç”±
	log.Println(&quot;This is version 1.&quot;)
	err := http.ListenAndServe(&quot;:9090&quot;, nil) //è®¾ç½®ç›‘å¬çš„ç«¯å£
	if err != nil {
		log.Fatal(&quot;ListenAndServe: &quot;, err)
	}
}
</code></pre>

<p><strong>åˆ›å»ºDockerfile</strong></p>

<pre><code class="language-Dockerfile">FROM alpine:3.5
MAINTAINER Jimmy Song&lt;rootsongjc@gmail.com&gt;
ADD hellov2 /
ENTRYPOINT [&quot;/hellov2&quot;]
</code></pre>

<p>æ³¨æ„ä¿®æ”¹æ·»åŠ çš„æ–‡ä»¶çš„åç§°ã€‚</p>

<p><strong>åˆ›å»ºMakefile</strong></p>

<p>ä¿®æ”¹é•œåƒä»“åº“çš„åœ°å€ä¸ºä½ è‡ªå·±çš„ç§æœ‰é•œåƒä»“åº“åœ°å€ã€‚</p>

<p>ä¿®æ”¹<code>Makefile</code>ä¸­çš„<code>TAG</code>ä¸ºæ–°çš„ç‰ˆæœ¬å·ã€‚</p>

<pre><code class="language-cmake">all: build push clean
.PHONY: build push clean

TAG = v1

# Build for linux amd64
build:
	GOOS=linux GOARCH=amd64 go build -o hello${TAG} main.go
	docker build -t sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG} .

# Push to tenxcloud
push:
	docker push sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:${TAG}

# Clean 
clean:
	rm -f hello${TAG}
</code></pre>

<p><strong>ç¼–è¯‘</strong></p>

<pre><code class="language-Shell">make all
</code></pre>

<p>åˆ†åˆ«ä¿®æ”¹main.goä¸­çš„è¾“å‡ºè¯­å¥ã€Dockerfileä¸­çš„æ–‡ä»¶åç§°å’ŒMakefileä¸­çš„TAGï¼Œåˆ›å»ºä¸¤ä¸ªç‰ˆæœ¬çš„é•œåƒã€‚</p>

<h2 id="æµ‹è¯•">æµ‹è¯•</h2>

<p>æˆ‘ä»¬ä½¿ç”¨Deploymentéƒ¨ç½²æœåŠ¡æ¥æµ‹è¯•ã€‚</p>

<p>é…ç½®æ–‡ä»¶<code>rolling-update-test.yaml</code>ï¼š</p>

<pre><code class="language-Yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
    name: rolling-update-test
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: rolling-update-test
    spec:
      containers:
      - name: rolling-update-test
        image: sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:v1
        ports:
        - containerPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: rolling-update-test
  labels:
    app: rolling-update-test
spec:
  ports:
  - port: 9090
    protocol: TCP
    name: http
  selector:
    app: rolling-update-test
</code></pre>

<p><strong>éƒ¨ç½²service</strong></p>

<pre><code class="language-shell">kubectl create -f rolling-update-test.yaml
</code></pre>

<p><strong>ä¿®æ”¹traefik ingressé…ç½®</strong></p>

<p>åœ¨<code>ingress.yaml</code>æ–‡ä»¶ä¸­å¢åŠ æ–°serviceçš„é…ç½®ã€‚</p>

<pre><code class="language-Yaml">  - host: rolling-update-test.traefik.io
    http:
      paths:
      - path: /
        backend:
          serviceName: rolling-update-test
          servicePort: 9090
</code></pre>

<p>ä¿®æ”¹æœ¬åœ°çš„hosté…ç½®ï¼Œå¢åŠ ä¸€æ¡é…ç½®ï¼š</p>

<pre><code class="language-ini">172.20.0.119 rolling-update-test.traefik.io
</code></pre>

<p>æ³¨æ„ï¼š172.20.0.119æ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨keepalivedåˆ›å»ºçš„VIPã€‚</p>

<p>æ‰“å¼€æµè§ˆå™¨è®¿é—®<a href="http://rolling-update-test.traefik.ioå°†ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š">http://rolling-update-test.traefik.ioå°†ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</a></p>

<pre><code class="language-bash">This is version 1.
</code></pre>

<p><strong>æ»šåŠ¨å‡çº§</strong></p>

<p>åªéœ€è¦å°†<code>rolling-update-test.yaml</code>æ–‡ä»¶ä¸­çš„<code>image</code>æ”¹æˆæ–°ç‰ˆæœ¬çš„é•œåƒåï¼Œç„¶åæ‰§è¡Œï¼š</p>

<pre><code class="language-shell">kubectl apply -f rolling-update-test.yaml
</code></pre>

<p>ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Concept</a>ä¸­çš„æ–¹æ³•ï¼Œç›´æ¥è®¾ç½®æ–°çš„é•œåƒã€‚</p>

<pre><code class="language-bash">kubectl set image deployment/rolling-update-test rolling-update-test=sz-pg-oam-docker-hub-001.tendcloud.com/library/hello:v2
</code></pre>

<p>æˆ–è€…ä½¿ç”¨<code>kubectl edit deployment/rolling-update-test</code>ä¿®æ”¹é•œåƒåç§°åä¿å­˜ã€‚</p>

<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å‡çº§è¿›åº¦ï¼š</p>

<pre><code class="language-bash">kubectl rollout status deployment/rolling-update-test
</code></pre>

<p>å‡çº§å®Œæˆååœ¨æµè§ˆå™¨ä¸­åˆ·æ–°<a href="http://rolling-update-test.traefik.ioå°†ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š">http://rolling-update-test.traefik.ioå°†ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</a></p>

<pre><code class="language-bash">This is version 2.
</code></pre>

<p>è¯´æ˜æ»šåŠ¨å‡çº§æˆåŠŸã€‚</p>

<h2 id="ä½¿ç”¨replicationcontrolleråˆ›å»ºçš„podå¦‚ä½•rollingupdate">ä½¿ç”¨ReplicationControlleråˆ›å»ºçš„Podå¦‚ä½•RollingUpdate</h2>

<p>ä»¥ä¸Šè®²è§£ä½¿ç”¨<strong>Deployment</strong>åˆ›å»ºçš„Podçš„RollingUpdateæ–¹å¼ï¼Œé‚£ä¹ˆå¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„<strong>ReplicationController</strong>åˆ›å»ºçš„Podå¦‚ä½•Updateå‘¢ï¼Ÿ</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>

<pre><code class="language-bash">$ kubectl -n spark-cluster rolling-update zeppelin-controller --image sz-pg-oam-docker-hub-001.tendcloud.com/library/zeppelin:0.7.1
Created zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b
Scaling up zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b from 0 to 1, scaling down zeppelin-controller from 1 to 0 (keep 1 pods available, don't exceed 2 pods)
Scaling zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b up to 1
Scaling zeppelin-controller down to 0
Update succeeded. Deleting old controller: zeppelin-controller
Renaming zeppelin-controller-99be89dbbe5cd5b8d6feab8f57a04a8b to zeppelin-controller
replicationcontroller &quot;zeppelin-controller&quot; rolling updated
</code></pre>

<p>åªéœ€è¦æŒ‡å®šæ–°çš„é•œåƒå³å¯ï¼Œå½“ç„¶ä½ å¯ä»¥é…ç½®RollingUpdateçš„ç­–ç•¥ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="http://dockone.io/article/328">Rolling updateæœºåˆ¶è§£æ</a></p>

<p><a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">Running a Stateless Application Using a Deployment</a></p>

<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/simple-rolling-update.md">Simple Rolling Update</a></p>

<p><a href="https://segmentfault.com/a/1190000008232770">ä½¿ç”¨kubernetesçš„deploymentè¿›è¡ŒRollingUpdate</a></p>

<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployment Concept</a></p>

            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://jimmysong.io/posts/kubernetes-edge-node-configuration/" data-toggle="tooltip" data-placement="top" title="Kubernetesçš„è¾¹ç¼˜èŠ‚ç‚¹é…ç½®">&larr; Previous Post</a>
                </li>
                 
                <li class="next">
                    <a href="https://jimmysong.io/posts/kubernetes-concept-deployment/" data-toggle="tooltip" data-placement="top" title="Kuberneteæ¦‚å¿µè§£æä¹‹Deployment">Next Post &rarr;</a>
                </li>
                
            </ul>
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li><a href="/posts/kubernetes-edge-node-configuration/">Kubernetesçš„è¾¹ç¼˜èŠ‚ç‚¹é…ç½®</a></li>
                    
                    <li><a href="/posts/kubernetes-with-glusterfs/">åœ¨kubernetesä¸­ä½¿ç”¨glusterfsåšæŒä¹…åŒ–å­˜å‚¨</a></li>
                    
                    <li><a href="/posts/kubernetes-performance-test/">Kubernetesç½‘ç»œå’Œé›†ç¾¤æ€§èƒ½æµ‹è¯•</a></li>
                    
                    <li><a href="/posts/distributed-load-testing-using-kubernetes/">è¿ç”¨kubernetesè¿›è¡Œåˆ†å¸ƒå¼è´Ÿè½½æµ‹è¯•</a></li>
                    
                    <li><a href="/posts/ip-and-service-discovry-in-kubernetes/">Kubernetesä¸­çš„IPå’ŒæœåŠ¡å‘ç°ä½“ç³»</a></li>
                    
                </ul>
                
            </div>
            
            <div>
                <section id="datecount">
                    <h4 id="date"> Wed May 10, 2017</h4>
                </section>
                <h5 id="wc">3000 Words|Read in about 6 Min</h5>
                <h5 id="tags">Tags: 
                    <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> &nbsp;
                </h5>
            </div>
            
            <aside id=comments>
                <div>
                    <h2> Comments </h2>
                </div>
                <div id="container"></div>
                <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
                <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
                <script>
                    var gitment = new Gitment({
                        owner: 'rootsongjc', 
                        repo: 'rootsongjc.github.io', 
                        oauth: {
                            client_id: '93a0df08e0f93ff0c8a3',
                            client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
                        },
                    })
                    gitment.render('container')
                </script>
            </aside>

        </div>
    </div>
    </section>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:rootsongjc@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/jimmysongio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rootsongjc" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/jimmysongio" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/jimmysongio" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017
          
            
              Jimmy Song
                      
          
          
          &nbsp;&bull;&nbsp;
          October 4,2017
          updated
          
            &nbsp;&bull;&nbsp;
            <a href="https://jimmysong.io/">Jimmy Song</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.30-DEV</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

<script src="https://jimmysong.io/js/main.js"></script>

<script> renderMathInElement(document.body); </script>

<script src="https://jimmysong.io/js/prism.js"></script>
<script src="https://jimmysong.io/js/load-photoswipe.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.1/photoswipe.min.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.1/photoswipe-ui-default.min.js"></script>




  </body>
</html>

