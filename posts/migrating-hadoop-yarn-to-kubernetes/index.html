<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> è¿ç§»ä¼ ç»Ÿåº”ç”¨åˆ°Kubernetesæ­¥éª¤è¯¦è§£â€”â€”ä»¥Hadoop YARNä¸ºä¾‹ - Cloud NativeğŸ¤˜Big Data</title>
  <meta name="description" content="Cloud NativeğŸ¤˜Big Data" />
  <meta property="og:title" content="è¿ç§»ä¼ ç»Ÿåº”ç”¨åˆ°Kubernetesæ­¥éª¤è¯¦è§£â€”â€”ä»¥Hadoop YARNä¸ºä¾‹" />
  <meta name="twitter:title" content="è¿ç§»ä¼ ç»Ÿåº”ç”¨åˆ°Kubernetesæ­¥éª¤è¯¦è§£â€”â€”ä»¥Hadoop YARNä¸ºä¾‹" />
  <meta name="description" content="å‰è¨€ æœ¬æ–‡å·²å½’æ¡£åˆ° kubernetes-handbook ã€ç¬¬ä¸‰ç« ç”¨æˆ·æŒ‡å—ã€‘çš„ã€åœ¨Kubernetesä¸­å¼€å‘éƒ¨ç½²åº”ç”¨ã€‘å°èŠ‚ä¸­ï¼Œä¸€åˆ‡æ›´æ–°ä»¥ GitHub ä¸ºå‡†ã€‚ æœ¬æ–‡æ¡£ä¸æ˜¯è¯´æ˜å¦‚ä½•åœ¨ kubernetes ä¸­å¼€å‘å’Œéƒ¨ç½²åº”">
  <meta property="og:description" content="å‰è¨€ æœ¬æ–‡å·²å½’æ¡£åˆ° kubernetes-handbook ã€ç¬¬ä¸‰ç« ç”¨æˆ·æŒ‡å—ã€‘çš„ã€åœ¨Kubernetesä¸­å¼€å‘éƒ¨ç½²åº”ç”¨ã€‘å°èŠ‚ä¸­ï¼Œä¸€åˆ‡æ›´æ–°ä»¥ GitHub ä¸ºå‡†ã€‚ æœ¬æ–‡æ¡£ä¸æ˜¯è¯´æ˜å¦‚ä½•åœ¨ kubernetes ä¸­å¼€å‘å’Œéƒ¨ç½²åº”">
  <meta name="twitter:description" content="å‰è¨€ æœ¬æ–‡å·²å½’æ¡£åˆ° kubernetes-handbook ã€ç¬¬ä¸‰ç« ç”¨æˆ·æŒ‡å—ã€‘çš„ã€åœ¨Kubernetesä¸­å¼€å‘éƒ¨ç½²åº”ç”¨ã€‘å°èŠ‚ä¸­ï¼Œä¸€åˆ‡æ›´æ–°ä»¥ GitHub ä¸ºå‡†ã€‚ æœ¬æ–‡æ¡£ä¸æ˜¯è¯´æ˜å¦‚ä½•åœ¨ kubernetes ä¸­å¼€å‘å’Œéƒ¨ç½²åº”">
  <meta name="author" content="{Description { .Site.Author.name }}"/>
  <link href='https://jimmysong.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://jimmysong.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://jimmysong.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jimmysongio" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/posts/migrating-hadoop-yarn-to-kubernetes/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jimmy Song" />

  <meta name="generator" content="Hugo 0.30-DEV" />
  <link rel="canonical" href="https://jimmysong.io/posts/migrating-hadoop-yarn-to-kubernetes/" />
  <link rel="alternate" href="https://jimmysong.io/index.xml" type="application/rss+xml" title="Jimmy Song">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://jimmysong.io/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  

<meta name="baidu-site-verification" content="g8IYR9SNLF" />
<script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>

<link rel="stylesheet" href="https://jimmysong.io/css/prism.css" />



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jimmysong.io/">Jimmy Song</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Articles</a>
              <div class="navlinks-children">
                
                  <a href="/posts">Posts</a>
                
                  <a href="/tags">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Categories</a>
              <div class="navlinks-children">
                
                  <a href="/categories/kubernetes">kubernetes</a>
                
                  <a href="/categories/cloud-native">Cloud Native</a>
                
                  <a href="/categories/github">Github</a>
                
                  <a href="/categories/devops">Devops</a>
                
                  <a href="/categories/docker">Docker</a>
                
                  <a href="/categories/code">Code</a>
                
                  <a href="/categories/architecture/">Architecture</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Books</a>
              <div class="navlinks-children">
                
                  <a href="/cloud-native-go">Cloud Native Go</a>
                
                  <a href="/posts/cloud-native-python">Cloud Native Python</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
              <div class="navlinks-children">
                
                  <a href="/kubernetes-handbook">Kubernetes handbook</a>
                
                  <a href="/spark-on-k8s">Spark on kubernetes</a>
                
                  <a href="/awesome-cloud-native">Awesome Cloud Native</a>
                
                  <a href="/migrating-to-cloud-native-application-architectures"> Migrating to Cloud native</a>
                
                  <a href="http://istio.doczh.cn">Istio service mesh</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Jimmy Song" href="https://jimmysong.io/">
            <img class="avatar-img" src="https://jimmysong.io/img/avatar-icon.png" alt="Jimmy Song" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
            
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">è¿ç§»ä¼ ç»Ÿåº”ç”¨åˆ°Kubernetesæ­¥éª¤è¯¦è§£â€”â€”ä»¥Hadoop YARNä¸ºä¾‹</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            <div>
                <section id="datecount">
                    <h4 id="date"> Mon Aug 21, 2017</h4>
                </section>
                <h5 id="wc">2000 Words|Read in about 4 Min</h5>
                <h5 id="tags">Tags: 
                    <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> &nbsp;
                    <a href="https://jimmysong.io//tags/hadoop">hadoop</a> &nbsp;
                    <a href="https://jimmysong.io//tags/yarn">yarn</a> &nbsp;
                </h5>

            </div>
            <article role="main" class="blog-post">
                

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>æœ¬æ–‡å·²å½’æ¡£åˆ° <a href="https://github.com/rootsongjc/kubernetes-handbook">kubernetes-handbook</a> ã€ç¬¬ä¸‰ç« ç”¨æˆ·æŒ‡å—ã€‘çš„ã€åœ¨Kubernetesä¸­å¼€å‘éƒ¨ç½²åº”ç”¨ã€‘å°èŠ‚ä¸­ï¼Œä¸€åˆ‡æ›´æ–°ä»¥ GitHub ä¸ºå‡†ã€‚</p>

<p>æœ¬æ–‡æ¡£ä¸æ˜¯è¯´æ˜å¦‚ä½•åœ¨ kubernetes ä¸­å¼€å‘å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå¦‚æœæ‚¨æƒ³è¦ç›´æ¥å¼€å‘åº”ç”¨ç¨‹åºåœ¨ kubernetes ä¸­è¿è¡Œå¯ä»¥å‚è€ƒ <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/guide/deploy-applications-in-kubernetes.md">é€‚ç”¨äºkubernetesçš„åº”ç”¨å¼€å‘éƒ¨ç½²æµç¨‹</a>ã€‚</p>

<p>æœ¬æ–‡æ—¨åœ¨è¯´æ˜å¦‚ä½•å°†å·²æœ‰çš„åº”ç”¨ç¨‹åºå°¤å…¶æ˜¯ä¼ ç»Ÿçš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºè¿ç§»åˆ° kubernetes ä¸­ã€‚å¦‚æœè¯¥ç±»åº”ç”¨ç¨‹åºç¬¦åˆäº‘åŸç”Ÿåº”ç”¨è§„èŒƒï¼ˆå¦‚12å› ç´ æ³•åˆ™ï¼‰çš„è¯ï¼Œé‚£ä¹ˆè¿ç§»ä¼šæ¯”è¾ƒé¡ºåˆ©ï¼Œå¦åˆ™ä¼šé‡åˆ°ä¸€äº›éº»çƒ¦ç”šè‡³æ˜¯é˜»ç¢ã€‚å…·ä½“è¯·å‚è€ƒ <a href="https://github.com/rootsongjc/migrating-to-cloud-native-application-architectures">è¿ç§»è‡³äº‘åŸç”Ÿåº”ç”¨æ¶æ„</a>ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥ Spark on YARN with kubernetes ä¸ºä¾‹æ¥è¯´æ˜ï¼Œè¯¥ä¾‹å­è¶³å¤Ÿå¤æ‚ä¹Ÿå¾ˆæœ‰å…¸å‹æ€§ï¼Œäº†è§£äº†è¿™ä¸ªä¾‹å­å¯ä»¥å¸®åŠ©å¤§å®¶å°†è‡ªå·±çš„åº”ç”¨è¿ç§»åˆ° kubernetes é›†ç¾¤ä¸Šå»ï¼Œä»£ç å’Œé…ç½®æ–‡ä»¶å¯ä»¥åœ¨ <a href="https://github.com/rootsongjc/kube-yarn">è¿™é‡Œ</a> æ‰¾åˆ°ï¼ˆæœ¬æ–‡ä¸­åŠ å…¥ Spark çš„é…ç½®ï¼Œä»£ç ä¸­å¹¶æ²¡æœ‰åŒ…å«ï¼Œè¯»è€…å¯ä»¥è‡ªå·±é…ç½®ï¼‰ã€‚</p>

<p>ä¸‹å›¾ä¸ºæ•´ä¸ªæ¶æ„çš„ç¤ºæ„å›¾ï¼Œä»£ç å’Œè¯¦ç»†é…ç½®æ–‡ä»¶è¯·å‚è€ƒ <a href="https://github.com/rootsongjc/kube-yarn">kube-yarn</a>ï¼ˆä¸åŒ…å« ingressã€spark é…ç½®ï¼‰ï¼Œæ‰€æœ‰çš„è¿›ç¨‹ç®¡ç†å’Œå®¹å™¨æ‰©å®¹ç›´æ¥ä½¿ç”¨ Makefileï¼Œå¦‚ä½•ä½¿ç”¨è¯·å‚è€ƒè¯¥é¡¹ç›®æ–‡æ¡£ã€‚</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/spark-on-yarn-with-kubernetes.png" alt="spark on yarn with kubernetes æ¶æ„å›¾" /></p>

<p><strong>æ³¨æ„ï¼š è¯¥ä¾‹å­ä»…ç”¨æ¥è¯´æ˜å…·ä½“çš„æ­¥éª¤åˆ’åˆ†å’Œå¤æ‚æ€§ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿˜æœ‰å¾…éªŒè¯ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</strong></p>

<h2 id="æœ¯è¯­">æœ¯è¯­</h2>

<p>å¯¹äºä¸ºæ›¾æ¥è§¦è¿‡ kubernetes æˆ–å¯¹äº‘å¹³å°çš„æŠ€æœ¯ç»†èŠ‚ä¸å¤ªäº†è§£çš„äººæ¥è¯´ï¼Œå¦‚ä½•å°†åº”ç”¨è¿ç§»åˆ° kubernetes ä¸­å¯èƒ½æ˜¯ä¸ªå¤´ç–¼çš„é—®é¢˜ï¼Œåœ¨è¡ŒåŠ¨ä¹‹å‰æœ‰å¿…è¦å…ˆäº†è§£æ•´ä¸ªè¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°å“ªäº›æ¦‚å¿µå’Œæœ¯è¯­ï¼Œæœ‰åŠ©äºå¤§å®¶åœ¨è¡ŒåŠ¨ä¸­è¾¾æˆå…±è¯†ã€‚</p>

<p>è¿‡ç¨‹ä¸­å¯èƒ½ç”¨åˆ°çš„æ¦‚å¿µå’Œæœ¯è¯­åˆæ­¥æ•´ç†å¦‚ä¸‹ï¼š</p>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/terms-in-kubernetes-app-deployment.jpg" alt="Terms" /></p>

<p>ä¸ºäº†è®²è§£æ•´æ”¹è¿‡ç¨‹å’Œå…·ä½“ç»†èŠ‚ï¼Œæˆ‘ä»¬æ‰€æœ‰æ“ä½œéƒ½æ˜¯é€šè¿‡å‘½ä»¤æ‰‹åŠ¨å®Œæˆï¼Œä¸ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ã€‚å½“æ‚¨å……åˆ†äº†è§£åˆ°å…¶ä¸­çš„ç»†èŠ‚åå¯ä»¥é€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·æ¥ä¼˜åŒ–è¯¥è¿‡ç¨‹ï¼Œä»¥ä½¿å…¶æ›´åŠ è‡ªåŠ¨å’Œé«˜æ•ˆï¼ŒåŒæ—¶å‡å°‘å› ä¸ºäººä¸ºæ“ä½œå¤±è¯¯å¯¼è‡´çš„è¿ç§»å¤±è´¥ã€‚</p>

<h2 id="æ­¥éª¤è¯¦è§£">æ­¥éª¤è¯¦è§£</h2>

<p><img src="https://res.cloudinary.com/jimmysong/image/upload/images/migrating-hadoop-yarn-to-kubernetes.png" alt="åˆ†è§£æ­¥éª¤è§£æ" /></p>

<p>æ•´ä¸ªè¿ç§»è¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>

<h2 id="1-å°†åŸæœ‰åº”ç”¨æ‹†è§£ä¸ºæœåŠ¡">1. å°†åŸæœ‰åº”ç”¨æ‹†è§£ä¸ºæœåŠ¡</h2>

<p>æˆ‘ä»¬ä¸æ˜¯ä¸€ä¸Šæ¥å°±å¼€å§‹åšé•œåƒï¼Œå†™é…ç½®ï¼Œè€Œæ˜¯åº”è¯¥å…ˆæ¢³ç†ä¸‹è¦è¿ç§»çš„åº”ç”¨ä¸­æœ‰å“ªäº›å¯ä»¥ä½œä¸ºæœåŠ¡è¿è¡Œï¼Œå“ªäº›æ˜¯å˜çš„ï¼Œå“ªäº›æ˜¯ä¸å˜çš„éƒ¨åˆ†ã€‚</p>

<p>æœåŠ¡åˆ’åˆ†çš„åŸåˆ™æ˜¯æœ€å°å¯å˜åŸåˆ™ï¼Œè¿™ä¸ªåŒæ ·é€‚ç”¨äºé•œåƒåˆ¶ä½œï¼Œå°†æœåŠ¡ä¸­ä¸å˜çš„éƒ¨åˆ†ç¼–è¯‘åˆ°åŒä¸€ä¸ªé•œåƒä¸­ã€‚</p>

<p>å¯¹äºåƒ Spark on YARN è¿™æ ·å¤æ‚çš„åº”ç”¨ï¼Œå¯ä»¥å°†å…¶åˆ’åˆ†ä¸ºä¸‰å¤§ç±»æœåŠ¡ï¼š</p>

<ul>
<li>ResourceManager</li>
<li>NodeManager</li>
<li>Spark client</li>
</ul>

<h2 id="2-åˆ¶ä½œé•œåƒ">2. åˆ¶ä½œé•œåƒ</h2>

<p>æ ¹æ®æ‹†è§£å‡ºæ¥çš„æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œä¸¤ä¸ªé•œåƒï¼š</p>

<ul>
<li>Hadoop</li>
<li>Spark (From hadoop docker image)</li>
</ul>

<p>å› ä¸ºæˆ‘ä»¬è¿è¡Œçš„æ˜¯ Spark on YARNï¼Œå› æ­¤ Spark ä¾èµ–ä¸ Hadoop é•œåƒï¼Œæˆ‘ä»¬åœ¨ Spark çš„åŸºç¡€ä¸ŠåŒ…è£…äº†ä¸€ä¸ª web service ä½œä¸ºæœåŠ¡å¯åŠ¨ã€‚</p>

<p>é•œåƒåˆ¶ä½œè¿‡ç¨‹ä¸­ä¸éœ€è¦åœ¨ Dockerfile ä¸­æŒ‡å®š Entrypoint å’Œ CMDï¼Œè¿™äº›éƒ½æ˜¯åœ¨ kubernetes çš„ YAML æ–‡ä»¶ä¸­æŒ‡å®šçš„ã€‚</p>

<p>Hadoop YARN çš„ Dockerfile å‚è€ƒå¦‚ä¸‹é…ç½®ã€‚</p>

<pre><code class="language-dockerfile">FROM my-docker-repo/jdk:7u80

# Add native libs
ARG HADOOP_VERSION=2.6.0-cdh5.5.2
## Prefer to download from server not use local storage
ADD hadoop-${HADOOP_VERSION}.tar.gz /usr/local
ADD ./lib/* /usr/local/hadoop-${HADOOP_VERSION}/lib/native/
ADD ./jars/* /usr/local/hadoop-${HADOOP_VERSION}/share/hadoop/yarn/
ENV HADOOP_PREFIX=/usr/local/hadoop \
    HADOOP_COMMON_HOME=/usr/local/hadoop \
    HADOOP_HDFS_HOME=/usr/local/hadoop \
    HADOOP_MAPRED_HOME=/usr/local/hadoop \
    HADOOP_YARN_HOME=/usr/local/hadoop \
    HADOOP_CONF_DIR=/usr/local/hadoop/etc/hadoop \
    YARN_CONF_DIR=/usr/local/hadoop/etc/hadoop \
    PATH=${PATH}:/usr/local/hadoop/bin

RUN \
  cd /usr/local &amp;&amp; ln -s ./hadoop-${HADOOP_VERSION} hadoop &amp;&amp; \
  rm -f ${HADOOP_PREFIX}/logs/*

WORKDIR $HADOOP_PREFIX

# Hdfs ports
EXPOSE 50010 50020 50070 50075 50090 8020 9000
# Mapred ports
EXPOSE 19888
#Yarn ports
EXPOSE 8030 8031 8032 8033 8040 8042 8088
#Other ports
EXPOSE 49707 2122
</code></pre>

<h2 id="3-å‡†å¤‡åº”ç”¨çš„é…ç½®æ–‡ä»¶">3. å‡†å¤‡åº”ç”¨çš„é…ç½®æ–‡ä»¶</h2>

<p>å› ä¸ºæˆ‘ä»¬åªåˆ¶ä½œäº†ä¸€ä¸ª Hadoop çš„é•œåƒï¼Œè€Œéœ€è¦å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ï¼Œè¿™å°±è¦æ±‚åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™å¿…é¡»åŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦å‡†å¤‡ä¸¤ä¸ªæœåŠ¡ä¸­éœ€è¦åŒæ—¶ç”¨çš„çš„é…ç½®çš„éƒ¨åˆ†ã€‚</p>

<p>YARN ä¾èµ–çš„é…ç½®åœ¨ <code>artifacts</code> ç›®å½•ä¸‹ï¼ŒåŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š</p>

<pre><code class="language-ini">bootstrap.sh
capacity-scheduler.xml
container-executor.cfg
core-site.xml
hadoop-env.sh
hdfs-site.xml
log4j.properties
mapred-site.xml
nodemanager_exclude.txt
slaves
start-yarn-nm.sh
start-yarn-rm.sh
yarn-env.sh
yarn-site.xml
</code></pre>

<p>å…¶ä¸­ä½œä¸º bootstrap å¯åŠ¨è„šæœ¬çš„ <code>bootstrap.sh</code> ä¹ŸåŒ…å«åœ¨è¯¥ç›®å½•ä¸‹ï¼Œè¯¥è„šæœ¬å¦‚ä½•ç¼–å†™è¯·è§ä¸‹æ–‡ã€‚</p>

<h2 id="4-kubernetes-yaml-æ–‡ä»¶">4. Kubernetes YAML æ–‡ä»¶</h2>

<p>æ ¹æ®ä¸šåŠ¡çš„ç‰¹æ€§é€‰æ‹©æœ€é€‚åˆçš„ kubernetes çš„èµ„æºå¯¹è±¡æ¥è¿è¡Œï¼Œå› ä¸ºåœ¨ YARN ä¸­ NodeManager éœ€è¦ä½¿ç”¨ä¸»æœºåå‘ ResourceManger æ³¨å†Œï¼Œå› æ­¤éœ€è¦æ²¿ç”¨ YARN åŸæœ‰çš„æœåŠ¡å‘ç°æ–¹å¼ï¼Œä½¿ç”¨ headless service å’Œ StatefulSet èµ„æºã€‚æ›´å¤šèµ„æ–™è¯·å‚è€ƒ <a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/concepts/statefulset.md">StatefulSet</a>ã€‚</p>

<p>æ‰€æœ‰çš„ Kubernetes YAML é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ <code>manifest</code> ç›®å½•ä¸‹ï¼ŒåŒ…æ‹¬å¦‚ä¸‹é…ç½®ï¼š</p>

<ul>
<li>yarn-cluster çš„ namespace é…ç½®</li>
<li>Sparkã€ResourceManagerã€NodeManager çš„ headless service å’Œ StatefulSet é…ç½®</li>
<li>éœ€è¦æš´éœ²åˆ° kubernetes é›†ç¾¤å¤–éƒ¨çš„ ingress é…ç½®ï¼ˆResourceManager çš„ Webï¼‰</li>
</ul>

<pre><code class="language-Ini">kube-yarn-ingress.yaml
spark-statefulset.yaml
yarn-cluster-namespace.yaml
yarn-nm-statefulset.yaml
yarn-rm-statefulset.yaml
</code></pre>

<h2 id="5-bootstrap-è„šæœ¬">5. Bootstrap è„šæœ¬</h2>

<p>Bootstrap è„šæœ¬çš„ä½œç”¨æ˜¯åœ¨å¯åŠ¨æ—¶æ ¹æ® Pod çš„ç¯å¢ƒå˜é‡ã€ä¸»æœºåæˆ–å…¶ä»–å¯ä»¥åŒºåˆ†ä¸åŒ Pod å’Œå°†å¯åŠ¨è§’è‰²çš„å˜é‡æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å’Œå¯åŠ¨æœåŠ¡åº”ç”¨ã€‚</p>

<p>è¯¥è„šæœ¬åŒæ—¶å°†åŸæ¥ YARN çš„æ—¥å¿—ä½¿ç”¨ stdout è¾“å‡ºï¼Œä¾¿äºä½¿ç”¨ <code>kubectl logs</code> æŸ¥çœ‹æ—¥å¿—æˆ–å…¶ä»–æ—¥å¿—æ”¶é›†å·¥å…·è¿›è¡Œæ—¥å¿—æ”¶é›†ã€‚</p>

<p>å¯åŠ¨è„šæœ¬ <code>bootstrap.sh</code> è·Ÿ Hadoop çš„é…ç½®æ–‡ä»¶åŒæ—¶ä¿å­˜åœ¨ <code>artifacts</code> ç›®å½•ä¸‹ã€‚</p>

<p>è¯¥è„šæœ¬æ ¹æ® Pod çš„ä¸»æœºåï¼Œå†³å®šå¦‚ä½•ä¿®æ”¹ Hadoop çš„é…ç½®æ–‡ä»¶å’Œå¯åŠ¨ä½•ç§æœåŠ¡ã€‚<code>bootstrap.sh</code> æ–‡ä»¶çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">if [[ &quot;${HOSTNAME}&quot; =~ &quot;yarn-nm&quot; ]]; then
  sed -i '/&lt;\/configuration&gt;/d' $HADOOP_PREFIX/etc/hadoop/yarn-site.xml
  cat &gt;&gt; $HADOOP_PREFIX/etc/hadoop/yarn-site.xml &lt;&lt;- EOM
  &lt;property&gt;
    &lt;name&gt;yarn.nodemanager.resource.memory-mb&lt;/name&gt;
    &lt;value&gt;${MY_MEM_LIMIT:-2048}&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;yarn.nodemanager.resource.cpu-vcores&lt;/name&gt;
    &lt;value&gt;${MY_CPU_LIMIT:-2}&lt;/value&gt;
  &lt;/property&gt;
EOM
  echo '&lt;/configuration&gt;' &gt;&gt; $HADOOP_PREFIX/etc/hadoop/yarn-site.xml
  cp ${CONFIG_DIR}/start-yarn-nm.sh $HADOOP_PREFIX/sbin/
  cd $HADOOP_PREFIX/sbin
  chmod +x start-yarn-nm.sh
  ./start-yarn-nm.sh
fi

if [[ $1 == &quot;-d&quot; ]]; then
  until find ${HADOOP_PREFIX}/logs -mmin -1 | egrep -q '.*'; echo &quot;`date`: Waiting for logs...&quot; ; do sleep 2 ; done
  tail -F ${HADOOP_PREFIX}/logs/* &amp;
  while true; do sleep 1000; done
fi
</code></pre>

<p>ä»è¿™éƒ¨åˆ†ä¸­ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ Pod çš„ä¸»æœºåä¸­åŒ…å« <code>yarn-nm</code> å­—æ®µåˆ™å‘ <code>yarn-site.xml</code> é…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>

<pre><code class="language-xml">  &lt;property&gt;
    &lt;name&gt;yarn.nodemanager.resource.memory-mb&lt;/name&gt;
    &lt;value&gt;${MY_MEM_LIMIT:-2048}&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;yarn.nodemanager.resource.cpu-vcores&lt;/name&gt;
    &lt;value&gt;${MY_CPU_LIMIT:-2}&lt;/value&gt;
  &lt;/property&gt;
</code></pre>

<p>å…¶ä¸­ <code>MY_MEM_LIMIT</code> å’Œ <code>MY_CPU_LIMIT</code> æ˜¯ kubernetes YAML ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œè¯¥ç¯å¢ƒå˜é‡åˆæ˜¯å¼•ç”¨çš„ Resource limitã€‚</p>

<p>æ‰€æœ‰çš„é…ç½®å‡†å¤‡å®Œæˆåï¼Œæ‰§è¡Œ <code>start-yarn-nm.sh</code> è„šæœ¬å¯åŠ¨ NodeManagerã€‚</p>

<p>å¦‚æœ kubernetes YAML ä¸­çš„ container CMD args ä¸­åŒ…å« <code>-d</code> åˆ™åœ¨åå°è¿è¡Œ NodeManger å¹¶ tail è¾“å‡º NodeManager çš„æ—¥å¿—åˆ°æ ‡å‡†è¾“å‡ºã€‚</p>

<h2 id="6-configmaps">6. ConfigMaps</h2>

<p>å°† Hadoop çš„é…ç½®æ–‡ä»¶å’Œ bootstrap è„šæœ¬ä½œä¸º ConfigMap èµ„æºä¿å­˜ï¼Œç”¨ä½œ Pod å¯åŠ¨æ—¶æŒ‚è½½çš„ volumeã€‚</p>

<pre><code class="language-bash">kubectl create configmap hadoop-config \
	  --from-file=artifacts/hadoop/bootstrap.sh \
	  --from-file=artifacts/hadoop/start-yarn-rm.sh \
	  --from-file=artifacts/hadoop/start-yarn-nm.sh \
	  --from-file=artifacts/hadoop/slaves \
	  --from-file=artifacts/hadoop/core-site.xml \
	  --from-file=artifacts/hadoop/hdfs-site.xml \
	  --from-file=artifacts/hadoop/mapred-site.xml \
	  --from-file=artifacts/hadoop/yarn-site.xml \
	  --from-file=artifacts/hadoop/capacity-scheduler.xml \
	  --from-file=artifacts/hadoop/container-executor.cfg \
	  --from-file=artifacts/hadoop/hadoop-env.sh \
	  --from-file=artifacts/hadoop/log4j.properties \
	  --from-file=artifacts/hadoop/nodemanager_exclude.txt \
	  --from-file=artifacts/hadoop/yarn-env.sh
kubectl  create configmap spark-config \
	  --from-file=artifacts/spark/spark-bootstrap.sh \
	  --from-file=artifacts/spark/spark-env.sh \
	  --from-file=artifacts/spark/spark-defaults.conf
</code></pre>

<p>æ‰€æœ‰çš„é…ç½®å®Œæˆåï¼Œå¯ä»¥å¯ä»¥ä½¿ç”¨ kubectl å‘½ä»¤æ¥å¯åŠ¨å’Œç®¡ç†é›†ç¾¤äº†ï¼Œæˆ‘ä»¬ç¼–å†™äº† Makefileï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ Makefile å°è£…çš„å‘½ä»¤å®ç°éƒ¨åˆ†çš„è‡ªåŠ¨åŒ–ã€‚</p>

            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://jimmysong.io/posts/domain-name-jimmysong-io/" data-toggle="tooltip" data-placement="top" title="å³æ—¥èµ·æ›´æ¢åŸŸåä¸ºjimmysong.io">&larr; Previous Post</a>
                </li>
                 
                <li class="next">
                    <a href="https://jimmysong.io/posts/kubectl-user-authentication-authorization/" data-toggle="tooltip" data-placement="top" title="kubectlçš„ç”¨æˆ·è®¤è¯æˆæƒ">Next Post &rarr;</a>
                </li>
                
            </ul>
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li><a href="/posts/yarn-on-docker/">å®¹å™¨æŠ€æœ¯åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹çš„åº”ç”¨â€”â€”Yarn on Docker</a></li>
                    
                    <li><a href="/posts/kubernetes-tls-bootstrapping/">Kubernetes TLS bootstrapå¼•å¯¼ç¨‹åº</a></li>
                    
                    <li><a href="/posts/linkerd-user-guide/">Linkerd ä½¿ç”¨æŒ‡å—</a></li>
                    
                    <li><a href="/posts/deploy-applications-in-kubernetes/">é€‚ç”¨äºkubernetesçš„åº”ç”¨å¼€å‘ä¸éƒ¨ç½²æµç¨‹è¯¦è§£</a></li>
                    
                    <li><a href="/posts/book-kubernetes-management-design-patterns/">è®°ä¸€æœ¬å…³äºkubernetes management design patternsçš„ä¹¦</a></li>
                    
                </ul>
                
            </div>
            
            <div>
                <section id="datecount">
                    <h4 id="date"> Mon Aug 21, 2017</h4>
                </section>
                <h5 id="wc">2000 Words|Read in about 4 Min</h5>
                <h5 id="tags">Tags: 
                    <a href="https://jimmysong.io//tags/kubernetes">kubernetes</a> &nbsp;
                    <a href="https://jimmysong.io//tags/hadoop">hadoop</a> &nbsp;
                    <a href="https://jimmysong.io//tags/yarn">yarn</a> &nbsp;
                </h5>
            </div>
            
            <aside id=comments>
                <div>
                    <h2> Comments </h2>
                </div>
                <div id="container"></div>
                <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
                <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
                <script>
                    var gitment = new Gitment({
                        owner: 'rootsongjc', 
                        repo: 'rootsongjc.github.io', 
                        oauth: {
                            client_id: '93a0df08e0f93ff0c8a3',
                            client_secret: '3bdbf0b42c525f78582600bd38cf7f722ee40541',
                        },
                    })
                    gitment.render('container')
                </script>
            </aside>

        </div>
    </div>
    </section>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:rootsongjc@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/jimmysongio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rootsongjc" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/jimmysongio" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/jimmysongio" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017
          
            
              Jimmy Song
                      
          
          
          &nbsp;&bull;&nbsp;
          October 4,2017
          updated
          
            &nbsp;&bull;&nbsp;
            <a href="https://jimmysong.io/">Jimmy Song</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.30-DEV</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

<script src="https://jimmysong.io/js/main.js"></script>

<script> renderMathInElement(document.body); </script>

<script src="https://jimmysong.io/js/prism.js"></script>
<script src="https://jimmysong.io/js/load-photoswipe.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.1/photoswipe.min.js"></script>
<script src="https://cdn.bootcss.com/photoswipe/4.1.1/photoswipe-ui-default.min.js"></script>




  </body>
</html>

