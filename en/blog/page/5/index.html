<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Blog - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="Jimmy Song&#39;s Blog Posts">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/blog/" />
  <meta property="og:title" content="Blog | Jimmy Song" />
  <meta property="twitter:title" content="Blog | Jimmy Song" />

  
  <meta property="og:description" content="Jimmy Song&#39;s Blog Posts" />
  <meta property="twitter:description" content="Jimmy Song&#39;s Blog Posts" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    
                  
                
              
              
              
                
                  
                    
                    <a class="nav-link" href="/trans/">中文</a>
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>Search</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>Search</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="Close"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="Input the keyword">
        
        <div class="mt-4">
          <span>Search type: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">All</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">Blog</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">Book</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">Notice</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Blog
                </p>
                <p class="page-description">
                    Jimmy Song&rsquo;s Blog Posts
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/istio-1-18-released-now-with-ambient-mode-available/">Istio 1.18 Released, Now with Ambient Mode Available</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jun 26, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 1.18 Released, Now with Ambient Mode Available', 'This article introduces Istio 1.18, the latest release of the service mesh platform. It highlights the new features and improvements, such as ambient mode, which allows Istio to run on any Kubernetes cluster without requiring a dedicated control plane. It also explains how to get started with Istio 1.18 using Tetrate’s distribution and support.', '\nIn June, [Istio 1.18 was released](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/), marking the second release of Istio in 2023 and the first to offer official support for [ambient mode](https:\/\/tetrate.io\/blog\/istio-ambient-mesh-merged-to-main\/). Tetrate’s Paul Merrison was one of the release managers for this version, and Tetrate’s contributions to this release included various customer-driven usability enhancements and important work in the underlying Envoy Proxy upon which Istio depends. When asked about the experience of working on Istio 1.18, Paul said “working as the lead release manager for Istio 1.18 gave me a fascinating insight into how a group of super talented people from around the world come together, organize themselves and ship software. There was a steep learning curve, but the Istio community is awesome and I was supported brilliantly. The biggest challenge was definitely learning and executing all the steps that are needed to bring a release to life, but the feeling of achievement when it finally made its way out into the world will stay with me for a while!” Istio first announced the introduction of Ambient mode in September last year, which was covered in detail by Zack in[ this blog post](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/), where he explains the differences between ambient mode and sidecar mode.\n\nThis release introduces many [new features and changes](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/change-notes\/) in addition to ambient mode, including enhanced Kubernetes Gateway API support, health checks for virtual machines that are not automatically registered, support for expired metrics, enhanced \u0060istioctl analyze\u0060, and more. See the [release blog](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/) for details. The most significant of these are the ambient mode and Gateway API enhancements, detailed below.\n\n\u003e “Working as the lead release manager for Istio 1.18 gave me a fascinating insight into how a group of super talented people from around the world come together, organize themselves and ship software. There was a steep learning curve, but the Istio community is awesome and I was supported brilliantly. The biggest challenge was definitely learning and executing all the steps that are needed to bring a release to life, but the feeling of achievement when it finally made its way out into the world will stay with me for a while!”\n\u003e\n\u003e Paul Merrison, Tetrate Engineering and Istio Release Manager\n\n## What Is Ambient Mode?\n\nBefore discussing ambient mode, it is essential to understand the current “sidecar mode” used by Istio. Sidecar mode is the default data plane mode used by Istio, where each application pod comes equipped with a sidecar proxy (usually Envoy) that handles all network traffic in and out of the pod, providing Istio’s core functionality such as Zero Trust security, telemetry and traffic management. While sidecar mode is suitable for most users, ambient mode offers some advantages in specific circumstances. For more information on the differences between ambient mode and the standard sidecar mode, see[ our article on Ambient Mesh: What You Need to Know about This Experimental New Deployment Model for Istio](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/).\n\n## What Are the Design Goals of Ambient Mode?\n\n- **Non-intrusive**: Ambient mode does not require injecting sidecar proxies into the application’s pods and only requires the application to be tagged to automatically join the mesh, potentially reducing the mesh’s impact on the application.\n- **Efficient resource utilization**: Ambient mode can optimize resource utilization for some use cases by sharing the ztunnel proxy across the mesh. If certain L7 functionality of Istio is required, it can also be addressed by deploying Waypoints precisely for a ServiceAccount or Namespace, providing more control over resource consumption.\n- **Performance parity with sidecar mode**: Ambient mode initially adopted a shared proxy model based on Envoy, but during development, issues such as complex Envoy configuration were discovered, leading the Istio community to develop its shared proxy ([ztunnel](https:\/\/tetrate.io\/blog\/using-geneve-tunnels-to-implement-istio-ambient-mesh-traffic-interception\/)) based on Rust. In the future, ambient mode is expected to have comparable performance to traditional sidecar mode.\n- **Security**: Ambient mode provides TLS support by running a shared proxy ztunnel on each node, and when users require the same security as sidecar mode, they also need to deploy one or more Waypoints in each namespace to handle L7 traffic in that namespace.\n\nUsers can use \u0060istioctl x waypoint\u0060 for Waypoint configuration management. For example, running the \u0060istioctl x waypoint generate\u0060 command generates a Kubernetes Gateway API resource managed by Istio.\n\nOverall, ambient mode promises to offer additional flexibility to Istio’s deployment model which may prove helpful to some users. It should be noted that the ambient mode is still in the **alpha stage** and has yet to achieve production-level stability.\n\n## Enhanced Kubernetes Gateway API Support\n\nIstio 1.18 introduces several vital improvements and modifications to its Kubernetes Gateway API support:\n\n- **Support for v1beta1**: When upgrading to the new version of Istio, Gateway API version greater than 0.6.0\u002b is required. Use the \u0060istioctl x precheck \u0060command to check for upgrade issues.\n- **Gateway API automated deployment management upgrades**: All Kubernetes Gateway resources Istio manages will automatically configure Service and Deployment resources when created or updated. If the Gateway resource changes, the associated configuration will also be updated synchronously. In addition, the deployment of Gateway resources no longer depends on injection logic but has an independent creation process.\n- **Removal of support for the \u0060proxy.istio.io\/config\u0060 annotation**: The ProxyConfig resource only affects the Istio-managed Gateway.\n- **Fixes to Istiod handling of configuration changes**: If Service and Deployment configurations change, Istiod reprocesses them.\n\n- **It no longer supports the Alpha version of the Gateway API by default**: It can be re-enabled by setting \u0060PILOT_ENABLE_ALPHA_GATEWAY_API=true\u0060.\n\nIt is worth noting that when installing ambient mode, unlike previous Istio installations, IngressGateway is no longer included by default. In future development, Istio is leaning towards using the Gateway API to manage gateways. For more information on why the Gateway API is recommended over Ingress, please read[ my previous blog article on why the Gateway API Is the unified future of ingress for Kubernetes and service mesh](https:\/\/tetrate.io\/blog\/why-the-gateway-api-is-the-unified-future-of-ingress-for-kubernetes-and-service-mesh\/).\n\n## Next Steps to Ambient Mesh\n\nWe’re excited that ambient mode is now available to users in an official Istio release, especially as it promises to make mesh adoption easier for all users. The [easiest way to get started with Istio’s new ambient mode is Tetrate Istio Distro](https:\/\/istio.tetratelabs.io\/), Tetrate’s hardened, fully upstream Istio distribution, with [FIPS-verified builds](https:\/\/tetrate.io\/blog\/how-tetrate-istio-distro-became-the-first-fips-compliant-istio-distribution\/) and [support available](https:\/\/tetrate.io\/tetrate-istio-subscription\/). It’s a great way to get started with Istio knowing you have a trusted distribution, to begin with, an expert team supporting you, and also the option to get to FIPS compliance quickly if you need to.\n\nAs you add more apps to the mesh, you’ll need a unified way to manage those deployments and coordinate the mandates of the different teams involved. That’s where Tetrate Service Bridge comes in. Learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetrate.io\/tetrate-service-bridge\/), or [contact us for a quick demo](https:\/\/tetrate.io\/demo-request\/).\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/istio-1-18-released-now-with-ambient-mode-available\/).*\n', '\/en\/blog\/istio-1-18-released-now-with-ambient-mode-available\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces Istio 1.18, the latest release of the service mesh platform. It highlights the new features and improvements, such as ambient mode, which allows Istio to run on any Kubernetes cluster without requiring a dedicated control plane. It also explains how to get started with Istio 1.18 using Tetrate’s distribution and support.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               May 29, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception', 'This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.', '\nIn a previous[ blog post](\/en\/blog\/ambient-mesh-l7-traffic-path\/), I discussed how Istio Ambient Mesh uses iptables and Geneve tunnels to intercept traffic from application pods into Ztunnel. Many readers may not be familiar with this tunneling protocol, so this article will introduce the definition, packet structure and advantages of Geneve tunnels compared with the VXLAN protocol. Finally, this article will introduce how Istio Ambient Mesh applies Geneve tunnels to implement traffic interception and the new eBPF mode introduced in Istio 1.18.\n\n## Introduction to Geneve Tunnels\n\nIn order to address the lack of flexibility and security in current data transmissions, the Geneve (Generic Network Virtualization Encapsulation) network virtualization encapsulation (tunneling) protocol was created. Geneve only defines a data encapsulation format, excluding control plane information. The key advantage of Geneve over VXLAN encapsulation is that it extends the types of encapsulated protocols by adding TLV format options.\n\n### Geneve vs. VXLAN\n\nVXLAN and Geneve are both network virtualization protocols and they have many similarities. Virtualization protocols are technologies that separate virtual networks from physical networks. They allow network administrators to create multiple virtual networks in a virtual environment, each of which can have its own VLAN identifiers, IP addresses and routing. In addition, VXLAN and Geneve use UDP encapsulation, which enables them to be extended through existing network infrastructure. VXLAN and Geneve protocols are also flexible, can be used in different network topologies and are compatible with different virtualization platforms.\n\nFigure 1 shows the message structure of VXLAN and Geneve tunnels and the differences in their respective headers.\n\n![Figure 1: VXLAN and Geneve packet format schematic diagram.](vxlan-vs-geneve.svg)\n\nFrom the figure, we can see that the message structure of VXLAN and Geneve tunneling protocols is similar, with the main difference being the use of different UDP port numbers and protocol headers. VXLAN uses port 4789, while Geneve uses port 6081. The Geneve protocol header is more extendable than VXLAN.\n\nThe Geneve tunneling protocol adds variable-length options that can contain zero or more option data in TLV format, making it more scalable than VXLAN. TLV stands for Type-Length-Value, which is a format for parsing and transmitting metadata in network packets. Each metadata information in the Geneve protocol is composed of a TLV format field, making it simple to flexibly add, delete and modify these metadata.\n\nThe TLV format field contains the following data:\n\n- Type: 8-bit type field.\n- Length: 5-bit option length field, represented in multiples of 4 bytes, excluding the option header.\n- Data: Variable-length option data field, which may not exist or may be between 4 and 128 bytes.\n\nThe Geneve protocol can easily modify and extend metadata information while maintaining compatibility and flexibility by using the TLV format.\n\nPlease refer to[ RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) for more information about VXLAN. For more information about the Geneve tunnel packet format, please refer to[ RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i).\n\n### How it Works\n\nThe Geneve tunnel is mainly used in cloud computing and virtualization scenarios, and it can encapsulate packets in a new packet for transmission in a virtual network. The Geneve tunnel uses a 24-bit VNI (Virtual Network Identifier) to transmit packets from one physical network to another. The Geneve tunnel can also use security protocols such as IPsec and TLS to protect the transmission of packets.\n\nWhen a packet reaches the destination host, the Geneve tunnel protocol will de-encapsulate the packet from the Geneve protocol header and deliver it to the destination in the virtual network. During the de-encapsulation process, the VNI information in the Geneve protocol header is used to determine the destination of the packet, ensuring that the packet is correctly routed to the destination in the virtual network.\n\nAssuming there is a virtual network with a VNI of 1001. When a packet is transmitted from one physical network to another, a tunnel can be used to track the packet during transmission by setting the VNI between the source and target physical networks to 1001. When the packet reaches the target physical network, the VNI is removed from the packet and the packet is delivered to the target physical network.\n\n### Security\n\nThe Geneve tunnel protocol itself does not provide any security mechanisms, so packets transmitted in the Geneve tunnel can be subject to threats such as packet tampering, interception and replay.\n\nTo ensure the security of packets transmitted in the Geneve tunnel, some security protocols can be used. The following are some common security protocols:\n\n1. IPsec (Internet Protocol Security): IPsec is a network layer security protocol that can encrypt, authenticate and provide integrity protection to packets in the Geneve tunnel. IPsec can provide end-to-end security.\n2. TLS (Transport Layer Security): TLS is an encryption protocol based on the transport layer that can encrypt and authenticate packets in the Geneve tunnel. TLS can provide end-to-end security.\n3. MACSec (Media Access Control Security): MACSec is a data link layer security protocol that can encrypt and authenticate packets in the Geneve tunnel. MACSec can provide link-layer security.\n\nIt should be noted that the above security protocols require corresponding configuration and deployment and may have a certain impact on performance. When choosing the appropriate security protocol, factors such as security, performance, manageability and other aspects need to be considered.\n\n## Why Choose Geneve?\n\nThe following table compares the characteristics of VXLAN and Geneve in multiple aspects.\n\n| **Feature**   | **VXLAN**                          | **Geneve**                                   |\n| ------------- | ---------------------------------- | -------------------------------------------- |\n| Header format | Fixed format                       | Extensible format                            |\n| Scalability   | More focused on L2 extension       | Better support for emerging network services |\n| Operability   | Difficult to manage and extend     | Easier to manage and extend                  |\n| Performance   | Shorter header, higher performance | Longer header, slightly lower performance    |\n\n**Table 1:** *VXLAN vs Geneve characteristics*.\n\nThe main reason for using the Geneve protocol is to combine the advantages of current network virtualization encapsulation technologies (such as VXLAN, NVGRE and STT) into one protocol. Through years of network virtualization development experience, we know that one of the most important requirements is scalability. The Geneve protocol encodes metadata using an extensible TLV structure, so it can independently develop the functionality of software and hardware endpoints to meet growing needs.\n\n## How Istio Ambient Mesh Applies Geneve Tunnels\n\nIn the[ previous blog](https:\/\/tetrate.io\/blog\/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh\/), I explained how Istio Ambient Mesh uses Ztunnel to implement L4 proxies and Figure 2 shows the L4 transparent traffic interception path using iptables and Geneve tunnels.\n\n![Figure 2: L4 Transparent Traffic Interception Path Using Iptables and Geneve Tunnels.](geneve-tunnel.svg)\nFrom the figure, we can see that:\n\n- The Istio CNI creates an \u0060istioout\u0060 network card and iptables rules on the node, transparently intercepting the outbound traffic in the node to the \u0060pistioout\u0060 virtual network card.\n- The Istio CNI creates an \u0060istioin\u0060 network card and iptables rules on the node, transparently intercepting the inbound traffic in the node to the \u0060pistioin\u0060 virtual network card.\n- The Istio CNI creates \u0060pistioin\u0060 and \u0060pistioout\u0060 network cards in ztunnel to receive data packets in the Geneve tunnel.\n\nThe two network cards \u0060pistioin\u0060 and \u0060pistioout\u0060 are created by the init container or Istio CNI (see the \u0060CreateRulesWithinNodeProxyNS\u0060 function in [net_linux.go](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910)), and their IP addresses and ports are fixed. The data packets sent by the application container need to pass through the \u0060istioout\u0060 network card and be forwarded to the ztunnel container after being encapsulated in the Geneve tunnel. When the data packets are received by the ztunnel container, they are de-encapsulated and forwarded to the corresponding application containers through the \u0060pistioin\u0060 network card.\n\n## Using eBPF for Transparent Traffic Interception\n\neBPF (extended Berkeley Packet Filter) is a powerful technology that allows secure user-space programs to run within the Linux kernel. Initially developed as a technique for filtering network packets, eBPF has now been extended to other areas such as tracking system calls, performance analysis and security monitoring. The advantages of eBPF are its lightweight nature, efficiency, security and programmability. It can be used in real-time monitoring, network security, application debugging and optimization, container networking and various other fields.\n\nIstio Ambient Mesh also supports using the eBPF (extended Berkeley Packet Filter) mode for transparent traffic interception since 1.18. As shown in Figure 3, the eBPF program runs directly in the host kernel and forwards application traffic to ztunnel. Compared to the iptables-based approach, the eBPF mode can provide better network efficiency and scalability. However, it requires a higher version of the Linux kernel and is more difficult to implement.\n\n![Figure 3: Intercepting the Traffic of Application Using eBPF.](ebpf.svg)\n\nTo use the eBPF mode to run Ambient Mesh, simply set the \u0060values.cni.ambient.redirectMode\u0060 parameter to “ebpf” when installing Istio, as shown below:\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## Summary\n\nThis article introduced the working principle, security and comparison with VXLAN of the Geneve tunnel protocol. In addition, it also introduced how Istio Ambient Mesh uses Geneve tunnels to implement traffic interception and discussed the advantages and disadvantages of using eBPF for transparent traffic interception. The Geneve tunnel protocol is a universal tunneling protocol that can transmit packets in virtual networks, and it has more advantages than other tunneling protocols. Therefore, when choosing a tunneling protocol, users can consider using the Geneve tunnel. In Istio 1.18, the eBPF mode of Ambient Mesh is newly introduced, which can provide better network efficiency, but has higher requirements for the Linux kernel version. Users can choose according to their actual situation.\n\n## References\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid) . TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb) , or [contact us for a quick demo](https:\/\/tetr8.io\/contact) .\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/using-geneve-tunnels-to-implement-istio-ambient-mesh-traffic-interception\/).*\n', '\/en\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/envoy-gateway-customization/">Envoy Gateway 0.4.0: Extending the API for Customization</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               May 16, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy Gateway 0.4.0: Extending the API for Customization', 'In this blog post, we will discuss the new customizations available in this release and their significance for users.', '\n[Envoy Gateway](https:\/\/github.com\/envoyproxy\/gateway), the open-source API Gateway based on Envoy Proxy, has just released version 0.4.0. This release is centered around customization, with the goal of enabling more use cases for end-users. In this blog post, we will discuss the new customizations available in this release and their significance for users.\n\n## Customizing Envoy Proxy Infrastructure\n\nOne of the main customizations in this release is the ability to configure the exact type of EnvoyProxy (CRD) deployment. You can define the number of replicas, images, and resource limits that EnvoyProxy deploys. You can also add annotations to EnvoyProxy deployments and services. This makes different use cases possible, such as:\n\n- Linking Envoy Gateway to external load balancers like AWS, NLB, ELB, and GCP.\n- Injecting a sidecar alongside EnvoyProxy is very useful for managing the North-South traffic in the Envoy Gateway at the ingress layer and for managing the East-West traffic and enabling mutual TLS (mTLS) in the service mesh layer with the Envoy sidecar. This custom feature eliminates the need for users to create their own certificates, as it is based on Istio certificate management.\n\nRefer to the Envoy Gateway documentation for more customized features on Envoy Gateway.\n\n## Multi-Tenant Deployment Modes\n\nFurthermore, Envoy Gateway has added support for other deployment modes in addition to the default Kubernetes single-tenant mode, such as multi-tenancy, as shown in Figure 1 below.\n\n![Figure 1: Envoy Gateway multi-tenancy deployment mode.](eg-multi-tenancy.svg)\n\nDeploy an Envoy Gateway Controller to each tenant’s namespace, which watches HTTPRoute and Service resources in Kubernetes, and creates and manages EnvoyProxy deployments in their respective namespaces.\n\n## Customizing Envoy xDS Bootstrap\n\nAnother significant customization in this release is the ability to customize the Envoy xDS Bootstrap. With this feature, users can provide a bootstrap configuration to configure some static resources when starting up Envoy. A good case is configuring access logging, tracing and metrics to be sent to SkyWalking, which can work as an APM. Additionally, the release adds a lot of CLI tooling to help validate user configuration. Users can use the CLI as a dry run to change a specific field in Bootstrap, and it will fail if the config is not syntactically correct.\n\n## Extending the Control Plane\n\nEnvoy Gateway now provides the ability to allow vendors and extension developers to add gRPC hooks at different stages of the Envoy Gateway pipeline to further extend its functionality, allowing users to do things like enhance the xDS configuration being sent to Envoy, which was not possible before.\n\n## Summary\n\nIn conclusion, Envoy Gateway 0.4.0 extends the API for customization and enables more use cases for end-users. The new customizations include the ability to customize Envoy deployment, Envoy xDS Bootstrap, and the control plane. With the release of this version, Envoy Gateway is becoming more user-friendly and is positioning itself as a great alternative to ingress-nginx.\n\n*This blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/envoy-gateway-0-4-0-extending-the-api-for-customization\/)*.\n', '\/en\/blog\/envoy-gateway-customization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">In this blog post, we will discuss the new customizations available in this release and their significance for users.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/ai-tools-collection/">Useful AI Tools to Optimize Your Workflow</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Mar 15, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/ai"> 
             AI
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Useful AI Tools to Optimize Your Workflow', 'Are you looking for ways to optimize your workflow and increase productivity? Here are some useful AI tools for you.', '\nArtificial Intelligence (AI) is changing our lives, making our work more efficient and intelligent. In this rapidly developing field, there are many practical AI tools that can help us better accomplish our work. In the future, mastering various AI tools to optimize your workflow and improve work efficiency will be a necessary skill for everyone. It\u0027s time to gather some cheap and practical AI tools. Below are some recommended practical AI tools that are worth collecting. You can directly use these tools without additional programming knowledge. Most of these tools are free to use, or provide free usage quotas, or have low usage costs.\n\n## 1. ChatGPT\n\n![ChatGPT](chatgpt.jpg)\n\n[ChatGPT](https:\/\/chat.chatgpt.com\/) is an intelligent chatbot based on GPT technology, which can interact with users in natural language. It uses deep learning technology and large-scale trained language models to understand users\u0027 questions and provide useful answers.\n\nChatGPT can answer various questions, and users can directly input questions or topics on the website and get quick and accurate answers. It should be noted that ChatGPT is an online chatbot, and its answers may not be 100% accurate. In addition, the data that ChatGPT model is trained on is up to 2021, and it is still in the early development stage, and is constantly improving and optimizing.\n\n**Recommendation Reasons**\n\nChatGPT\u0027s response speed is super fast, and you can get an answer in a few seconds, which is especially suitable for situations where quick replies are needed. You can also use OpenAI\u0027s API to create your own tools. However, the free version of ChatGPT\u0027s response speed is sometimes slow, and frequently refreshing the page is required when following up, and there are also limits on the number of characters for questions and answers.\n\nThe commonly used functions include:\n\n- Writing code\n- Translation\n- Proofreading articles\n- Summarizing an article (you can output a URL)\n- Learning a knowledge area that you are not familiar with\n\nIn addition, a ChatGPT desktop application is recommended: [https:\/\/github.com\/lencx\/ChatGPT](https:\/\/github.com\/lencx\/ChatGPT), as well as the ChatGPT prompt project [https:\/\/github.com\/f\/awesome-chatgpt-prompts](https:\/\/github.com\/f\/awesome-chatgpt-prompts).\n\n### ChatGPT Plus\n\n[ChatGPT Plus](https:\/\/chat.chatgpt.com\/plus) is an enhanced version of ChatGPT that utilizes GPT-3 technology to provide more powerful and intelligent natural language processing capabilities. It can assist users in completing various tasks such as generating articles, translation, Q\u0026A, speech conversion, and chatbots.\n\nChatGPT Plus has a sleek and beautiful interface that is very intuitive and user-friendly. Users can input text using various methods such as keyboard input, voice input, and image input. ChatGPT Plus also offers multiple language and style options, making it easy for users to generate high-quality text and speech.\n\n## 2. Smodin\n\n![Smodin](smodin.jpg)\n\n[Smodin.io](https:\/\/smodin.io\/) is an online tool based on artificial intelligence and natural language processing technology that can help users generate content such as articles, press releases, blog posts, and social media posts. The website uses deep learning technology and language models to automatically generate high-quality text and offers a variety of language and style options.\n\nUsing [Smodin.io](https:\/\/smodin.io\/) is very simple. Simply enter the topic, keywords, desired language, and style you wish to generate, then click the \u0022Generate\u0022 button to obtain a high-quality article. You can also make adjustments and edits as needed to meet your specific needs.\n\nIn addition to generating text, [Smodin.io](https:\/\/smodin.io\/) also offers other useful features such as grammar and spell check, SEO optimization suggestions, and real-time translation. The website is very flexible and convenient to use, making it suitable for individuals and businesses who require high-quality text, such as marketers, editors, writers, and bloggers.\n\nIt\u0027s important to note that while [Smodin.io](https:\/\/smodin.io\/) can save you a lot of time and effort, since the text is generated automatically, there may be some syntax or logic errors. Therefore, appropriate review and editing are necessary when using it.\n\n**Recommended Reasons**\n\nThe website supports over 40 languages, limits input to 1000 characters per session, and returns rewritten results quickly. Free users have a limit on the number of calls they can make, while paid users have a limit. There are two payment tiers, both of which are relatively inexpensive.\n\n## 3. Bing\n\n![Bing chat](bing.jpg)\n\n[Bing](https:\/\/bing.com) is a search engine developed by Microsoft that integrates artificial intelligence technology to provide more intelligent search results. Recently, Microsoft announced a new feature called \u0022Chat\u0022 added to Bing, where users can input questions in the chat box and Bing will automatically answer them, just like an intelligent chatbot. Bing also provides multiple conversation styles to choose from.\n\nIt should be noted that the chat function is currently in the testing phase and may have some issues and limitations. Additionally, Bing\u0027s availability may be restricted in some countries and regions. However, it is still a very useful search engine that can help users quickly find the information they need.\n\n**Recommended Reasons**\n\nThe newly integrated Chat feature in Bing is quite stable as it can connect to the internet and crawl real-time data. You can use it as an auxiliary tool for search engines or ask it for real-time information.\n\n## 4. GitHub Copilot\n\n![GitHub Copilot](copilot.jpg)\n\nGitHub Copilot is an AI code assistant developed jointly by OpenAI and GitHub, which can help developers write code faster and more accurately. It uses natural language processing and machine learning technologies to automatically generate high-quality code for users, improving development efficiency and code quality.\n\nGitHub Copilot can be integrated with various development tools and programming languages, such as VS Code, Visual Studio, Python, and JavaScript. Users only need to input a small amount of natural language description in the editor, and Copilot can automatically generate high-quality code for them. For example, when a user inputs \u0022Create a function that takes two arrays as arguments and returns their dot product.\u0022 Copilot can automatically generate the following code:\n\n\u0060\u0060\u0060go\nfunction dotProduct(arr1, arr2) {\n  return arr1.map((n, i) =\u003e n * arr2[i]).reduce((a, b) =\u003e a \u002b b);\n}\n\u0060\u0060\u0060\n\nIt is worth noting that GitHub Copilot is currently in beta and is constantly being optimized and improved. Additionally, the quality and accuracy of code generated by GitHub Copilot may be impacted by various factors such as input descriptions, programming languages, coding standards, and more.\n\n**Recommended Reasons**\n\nGitHub Copilot\u0027s code generation speed is very fast and can help developers save a lot of time and effort. Additionally, GitHub Copilot can learn from users\u0027 code repositories, improving the quality and accuracy of code generation.\n\n## 5. Notion\n\n![Notion](notion.jpg)\n\n[Notion](https:\/\/www.notion.so\/) is a comprehensive tool that combines note-taking, to-do lists, project management, knowledge base, and team collaboration functions. It provides powerful editing and organizing features that can help users easily create various types of documents, including text, images, videos, tables, and databases.\n\nNotion has a clean and beautiful interface, making it very intuitive and user-friendly. Users can organize and find their documents in various ways, such as using tags, directories, and searches. In addition, Notion also provides rich collaboration and sharing features, making it easy for users to collaborate and share documents with team members.\n\nFor AI developers, Notion is a very useful tool that can help them easily manage projects, record experimental data, share notes, translations, and documents, etc. Notion also provides rich third-party applications and APIs, making it easy to integrate with other tools and services.\n\nIt should be noted that the free version of Notion has some limitations, such as file upload size limits and API call limits, etc. However, the paid version provides more features and services, such as unlimited file uploads, API calls, and team members, etc., suitable for team and enterprise users.\n\n**Recommended Features**\n\nNotion provides rich templates and plugins that can help users quickly create various types of documents and projects, such as product roadmaps, project plans, and work logs, etc. In addition, Notion\u0027s API and webhook features are also very powerful, allowing users to easily integrate with other tools and services. Free users can create an unlimited number of documents, but only have 20 calls to Notion AI. If you exceed this limit, you need to subscribe for $10\/month (Note: Notion AI functionality requires a separate subscription).\n\nNotion is my favorite AI text editor, and it supports Chinese very well. Moreover, it supports Markdown format, making it easy to export. It can replace some of the functions of Smodin, but the effect of text rewriting still needs to be verified.\n\n## 6. Grammarly\n\n![Grammarly](grammarly.jpg)\n\n[Grammarly](https:\/\/app.grammarly.com\/) is a writing assistant that uses artificial intelligence to help users improve their writing skills. It can recognize and correct grammar, spelling, and punctuation errors, as well as provide suggestions for improving writing clarity and style. Grammarly can be used as a browser extension, desktop application, and mobile application, and is suitable for various writing tasks, such as emails, social media posts, and academic papers. Grammarly has free and premium versions, which offer additional features.\n\nUsing Grammarly is simple. Users just need to install its extension in their browser or download the application on their computer or mobile device, and start typing in the text box where they need assistance. Grammarly will automatically check the text and provide suggestions and corrections when necessary. Users can also choose different writing styles and language settings to adapt to their writing needs.\n\nIn addition to basic spelling and grammar checks, Grammarly also offers advanced features such as vocabulary enhancement, sentence structure adjustment, text simplification, and style suggestions. These features can help users improve their writing skills and enhance their writing quality. Furthermore, Grammarly provides other useful tools such as writing goal setting, commenting, and feedback, which can help users better organize and manage their writing tasks.\n\nIt should be noted that while Grammarly can provide useful suggestions and corrections, it cannot completely replace human editing or review. When using Grammarly, users should still perform appropriate review and editing to ensure writing quality and accuracy.\n\n**Recommended Reasons**\n\nGrammarly\u0027s grammar check and correction features are very accurate and practical, helping users quickly correct spelling and grammar errors. In addition, Grammarly offers advanced features such as sentence structure adjustment and text simplification, which can help users improve their writing style and quality. For those who need to write frequently, Grammarly is a very useful tool that can improve writing efficiency and quality.\n\n## 7. Quillbot\n\n![Quillbot](quillbot.jpg)\n\nQuillbot is a tool that uses artificial intelligence technology to help users rewrite and translate text. It can help users convert existing text into a more concise, clear, and understandable version to meet different writing needs.\n\nUsing Quillbot is very simple. Just paste the text that needs to be rewritten or translated into the specified text box, and then select the desired rewriting or translation option to get high-quality rewriting or translation results. Quillbot also offers a variety of language and style options to meet the needs of different users.\n\nIn addition to rewriting and translating text, Quillbot also provides other useful features such as grammar check, spell check, synonym replacement, and academic paper check. These features can help users improve writing quality and efficiency, saving time and effort.\n\nIt is important to note that although Quillbot can save users a lot of time and effort, rewriting and translating text requires some skill and experience, so appropriate review and editing are necessary when using it.\n\n**Recommended Reasons**\n\nQuillbot\u0027s rewriting and translation functions are very powerful and practical, which can help users quickly convert existing text into a more concise, clear, and understandable version. In addition, Quillbot also provides other useful features such as grammar check, spell check, and synonym replacement, which can help users improve writing quality and efficiency. Quillbot offers multiple plugins that can be easily integrated into browsers and other applications.\n\n## 8. ChatPDF\n\n![ChatPDF](chatpdf.jpg)\n\nChatPDF is a tool that allows you to communicate with any PDF file, just like chatting with another person. It works by analyzing the PDF file to create a semantic index, and then sending relevant paragraphs to a text-generating AI to provide explanations based on your questions.\n\nChatPDF was developed by German developer Mathis Lichtenberger, who previously worked on other data processing tools such as firefoo. ChatPDF is currently free to use, but has a limit of 120 pages.\n\nYou can use ChatPDF to quickly extract information from large PDF files such as manuals, papers, contracts, and books. It supports both Chinese and English, and can also automatically translate.\n\nChatPDF also has an app version that can be used on iPhone, iPad, iPod touch, or Mac OS X 13.0 or higher.\n\n**Recommended Reasons**\n\nYou can use ChatPDF to quickly extract key information from PDF files, which is sufficient for PDF books up to 200 pages. If you need to process more than 120 pages, you will need to upgrade to a Plus account.\n\n## Conclusions\n\nThese AI tools all have the characteristics of being efficient, easy to use, and scalable, which can help people better complete various tasks. If you are looking for an excellent AI tool, then these tools are worth considering. If you have more useful AI tools, please feel free to add them in the comments section. This recommended list will continue to be updated, so stay tuned.\n', '\/en\/blog\/ai-tools-collection\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Are you looking for ways to optimize your workflow and increase productivity? Here are some useful AI tools for you.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/istio-certificates-management/">How Are Certificates Managed in Istio?</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 30, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How Are Certificates Managed in Istio?', 'This blog post will explain how Istio handles certificate management.', '\nI mentioned in [my last article](\/blog\/understanding-the-tls-encryption-in-istio\/) on understanding mTLS traffic encryption in Istio that the key to traffic encryption is certificate management. We can use the built-in certificate authority (CA) in Istio or a custom CA to manage certificates within the mesh. This blog post will explain how Istio handles certificate management.\n\n## What Is a Certificate?\n\nThere are many types of certificates, but in this article, I am explicitly referring to [X.509 V3](https:\/\/www.rfc-editor.org\/rfc\/rfc5280) certificates. X.509 certificates are a standard digital format used to identify entities in computer networks. X.509 is the international standard for public key infrastructure (PKI) and is primarily used for identity authentication and information encryption, such as TLS.\n\nThe contents of a certificate are hashed using a hash function and then signed with the issuer’s private key. This way, when a certificate is received, the recipient can use the issuer’s public key to verify the certificate’s validity.\n\nA hash function is a function that maps an input of any length (also called a message) to a fixed-length output, also called a *hash value* or *message digest*. There are many hash functions, such as MD5, SHA-1, etc.\n\nA certificate is like a business card issued by an authoritative agency for the user to prove their identity, and it can also be used to encrypt information to ensure the security and integrity of communication. The following diagram shows the general steps of TLS communication, where the certificate proves the server’s identity and encrypts the communication.\n\nFigure 1 shows an example of an HTTP call to a website, issuing a digital certificate, authenticating, and encrypting the communication.\n\n![Figure 1. TLS certificate issuance and validation process](tls.svg)\n\nHere are the detailed steps:\n\n1. The server (website owner) submits a certificate signing request to the CA;\n2. The CA verifies the server’s identity and the authenticity of the website and issues a digital certificate to the server, which the server installs so that visitors can verify the website’s security;\n3. The user sends a request to the website through a browser (client);\n4. The server returns the TLS certificate to the client;\n5. The client verifies the certificate’s validity with the CA and establishes the connection if the certificate is valid, or prompts the user to reject the connection if it is invalid;\n6. The client generates a pair of random public and private keys;\n7. The client sends its public key to the server;\n8. The server encrypts the message using the client’s public key;\n9. The server sends the encrypted data to the client;\n10. The client decrypts the data sent by the server using its private key.\n\nAt this point, both parties have established a secure channel and can transmit encrypted data in both directions.\n\n## How to Generate Certificates\n\nYou can generate X.509 certificates with the following open-source tools:\n\n- [Easy-RSA](https:\/\/github.com\/OpenVPN\/easy-rsa): A simple command-line tool maintained by the OpenVPN project, EasyRSA can easily generate secure certificates and keys for the OpenVPN network.\n- [OpenSSL](https:\/\/github.com\/openssl\/openssl): Originated by an individual in 1995 and now maintained by an independent organization, OpenSSL provides only a command-line tool.\n- [CFSSL](https:\/\/github.com\/cloudflare\/cfssl): Developed and maintained by CloudFlare, CFSSL is not just a command-line tool for generating certificates but also can serve as a PKI server.\n- [BoringSSL](https:\/\/github.com\/google\/boringssl): A branch of OpenSSL developed and maintained by Google, BoringSSL is used in the Chrome browser and Android operating system.\n\nSince most people are probably familiar with OpenSSL, we will use OpenSSL to create certificates in the following text.\n\n## Certificate Trust Chain\n\nThe validation of a certificate requires using a certificate trust chain (Certificate Trust Chain). A certificate trust chain refers to a series of certificates used for identity verification, which form a chain starting from a trusted root certificate issuing agency, connecting downward step by step, until a specific intermediate or terminal certificate is used for verifying a particular certificate. The trustworthiness of a digital certificate increases as the certificate level increases in the certificate trust chain.\n\nIn Figure 2, you can see four trust chains.\n\n![Figure 2. Certificate trust chains](certificate-trust-chain.svg)\n\nCertificate trust chains are tree-like structures, where each CA can have one or more child CAs. There are three roles:\n\n- **Root CA:** The top-level CA can issue certificates to intermediate CAs.\n- **Intermediate CA:** They can issue end-entity certificates.\n- **End entity:** A device or service that holds an end-entity certificate.\n\nRoot CAs are the top-level issuing authorities for digital certificates, so the certificates they issue are the most trustworthy. Root certificate authorities are usually operated and regulated by government agencies or other authoritative organizations such as the International Infrastructure Security Organization. Common root CAs include:\n\n- Symantec\/VeriSign\n- Comodo\n- DigiCert\n- GlobalSign\n- GoDaddy\n- Entrust\n- GeoTrust\n- RapidSSL\n- Baltimore CyberTrust Root\n\nPlease note that the above list is just a sample. There are many other root CAs.\n\nWhen you open an HTTPS webpage in a Chrome browser, you can view the certificate information by clicking on the lock icon on the left side of the address bar, which includes the certificate trust chain, such as the certificate trust chain of [https:\/\/tetrate.io](https:\/\/tetrate.io\/) shown in Figure 3.\n\n![Figure 3. Certificate hierarchy of tetrate.io](tetrate-cert.jpg)\n\nThe certificate trust chain allows the client (such as a web browser) to verify each certificate step by step when verifying the terminal certificate to determine whether it is trustworthy. The principle of digital certificate issuance is that the CA binds the certificate owner’s public key and identity information together. Then the CA uses its proprietary private key to generate a formal digital signature to indicate that the CA issued this certificate. The digital signature on the certificate can be verified using the CA’s public key during certificate verification.\n\n## How to Incorporate Istio into the PKI Certificate Trust Chain\n\nBefore using Istio, enterprises usually have their own internal public key infrastructure . How can Istio be incorporated into the PKI certificate trust chain?\n\nIstio has built-in certificate management functions that can be used out of the box. When Istio is started, it will create a self-signed certificate for *istiod* as the root certificate for all workloads in the mesh. The problem with this is that the built-in root certificate cannot achieve mutual trust between meshes if you have multiple meshes. The correct approach is not to use Istio’s self-signed certificate, but to incorporate Istio into your certificate trust chain and integrate Istio into your PKI, creating an intermediate certificate for each PKI mesh. In this way, two meshes have a shared trust root and can achieve mutual trust between meshes.\n\nIntegrate the Istio mesh into your internal PKI certificate trust chain by creating an intermediate CA, as shown in Figure 4.\n\n![Figure 4: Create intermediate CAs for the multi-cluster mesh to enable Istio to be included in the on-premises PKI certificate trust chain](cluster-ca.svg)\n\nThere are many benefits to incorporating Istio into your company’s internal PKI certificate trust chain:\n\n- **Secure communication across grids\/clusters**: with a common trust root, clusters can verify each other’s identities and communicate with each other;\n- **More granular certificate revocation:** you can revoke the certificate of an individual entity or intermediate CA to revoke the certificate for service or cluster;\n- **Easy implementation of certificate rotation:** you can rotate certificates by cluster\/mesh rather than rotating the root node certificate, which reduces downtime. It is recommended to use [cert-manager](https:\/\/github.com\/cert-manager\/cert-manager) to achieve automated large-scale CA certificate rotation in production. For more information, see [Automate Istio CA Rotation in Production at Scale](https:\/\/tetrate.io\/blog\/automate-istio-ca-rotation-in-production-at-scale\/);\n\nFor detailed instructions on incorporating Istio into your company’s internal PKI certificate trust chain, see [this blog post](https:\/\/tetrate.io\/blog\/istio-trust\/).\n\n## Steps for Using a Custom CA in Istio\n\nBy default, the Istio CA generates a self-signed root certificate and key and uses them to sign workload certificates. To protect the root CA key, you should use a root CA that runs offline on a secure machine and the root CA to issue intermediate certificates to the Istio CA running on each cluster. The Istio CA can then use the administrator-specified certificate and key to sign workload certificates and distribute the administrator-specified root certificate as the trusted root to workloads.\n\nFigure 5 shows the certificate issuance and mounting process in Istio.\n\n![Figure 5. Certificate issuance and mounting process in Istio](cert-process.svg)\n\n1. In Istio, the Envoy proxy injects two processes into the Pod: *envoy* and *pilot-agent*. The *pilot-agent* generates a private key and uses the Secret Discovery Service (SDS) via a Unix Domain Socket (UDS) to request a certificate signing request (CSR) from the Certificate Authority (CA) through the *istiod*, if you have not configured the CA plugin.\n2. *istiod*, which has a built-in CA, returns the certificate to the *pilot-agent*.\n3. The *pilot-agent* then sends the generated private key and the CA-returned certificate to the Envoy instance to mount.\n\nIstio defaults to using the CA built into *istiod*, but also supports injecting other CAs, see the [Istio documentation](https:\/\/istio.io\/latest\/docs\/tasks\/security\/cert-management\/plugin-ca-cert\/). Suppose you want to create identities for your services using custom CA certificates and keys. In that case, you will need to:\n\n- Create a CA configuration file and use it to create self-signed CA root certificates and keys.\n- Create a private key and signing request configuration files for the service.\n- Create a certificate signing request (CSR) for the service.\n- Use the root certificate and key, along with the service’s signing request file, to create a certificate for the service.\n\nNext, we will detail the process of creating and mounting a certificate for the Bookinfo *productpage* service using Istio’s built-in CA as an example.\n\n## Process for Istio’s Built-in CA to Issue a Certificate\n\nWhen Istio starts, it creates a self-signed CA certificate, which it then uses to issue certificates to services within the mesh. Below, we will manually simulate the steps for Istio’s built-in CA to issue a certificate:\n\n**Step 1:** Create a CA private key **ca.key**:\n\n\u0060\u0060\u0060bash\nopenssl genrsa -out ca.key\n\u0060\u0060\u0060\n\n**Step 2:** Create a CA configuration file **ca.conf**:\n\n\u0060\u0060\u0060ini\n[ req ]\ndefault_bits = 2048\nprompt = no\nutf8 = yes\nencrypt_key = no\ndistinguished_name  = req_dn\nreq_extensions = req_ext\nx509_extensions = req_ext\n\n[ req_dn ]\nO = Istio\nCN = Root CA\n\n[ req_ext ]\nsubjectKeyIdentifier = hash\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign\n\u0060\u0060\u0060\n\n**Step 3:** Use the CA private key **ca.key** to generate a self-signed certificate **ca.pem**, which contains the CA’s information in the subject:\n\n\u0060\u0060\u0060bash\nopenssl req -x509 -new -nodes -key ca.key -days 365 -out ca.pem -config ca.conf\n\u0060\u0060\u0060\n\n**Step 4:** Create the workload’s private key **workload.key**:\n\n\u0060\u0060\u0060bash\nopenssl genrsa -out workload.key\n\u0060\u0060\u0060\n\n**Step 5:** Create a certificate signing request configuration file **csr.conf**, which contains the address of the CA and additional information:\n\n\u0060\u0060\u0060ini\n[ req ]\ndefault_bits = 2048\nprompt = no\nutf8 = yes\nencrypt_key = no\ndistinguished_name  = dn\nreq_extensions = req_ext\nx509_extensions = req_ext\n\n[ req_dn ]\nO = Istio\nCN = productpage\n\n[ req_ext ]\nsubjectKeyIdentifier = hash\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign\n\u0060\u0060\u0060\n\n**Step 6:** Create a certificate signing request **workload.csr** based on the workload’s CSR configuration file **csr.conf** and the workload’s private key file **workload.key**:\n\n\u0060\u0060\u0060bash\nopenssl req -new -key workload.key -out workload.csr -config csr.conf\n\u0060\u0060\u0060\n\n**Step 7:** Create certificate **workload.pem** based on CA’s private key **ca.key**, CA’s certificate **ca.pem** and workload’s certificate signing request:\n\n\u0060\u0060\u0060bash\nopenssl x509 -req -in workload.csr -CA ca.pem -CAkey ca.key \\\n    -CAcreateserial -out workload.pem -days 365 \\\n    -extensions req_ext -extfile csr.conf -sha256\n\u0060\u0060\u0060\n\n**Step 8:** View the certificate chain mounted by the Envoy proxy in the workload:\n\n\u0060\u0060\u0060bash\nistioctl proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\nThe **chain.pem** file holds the certificate chain for the *productpage* service. Because we use the Istio built-in CA as the root CA, only one certificate is stored in this file, which can be viewed by running the following command:\n\n\u0060\u0060\u0060bash\nopenssl x509 -noout -text -in chain.pem\n\u0060\u0060\u0060\n\n**Step 9:** View the root certificate mounted by the Envoy proxy:\n\n\u0060\u0060\u0060bash\nistioctl proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes\u0027 | base64 --decode \u003e root.pem\n\u0060\u0060\u0060\n\n**root.pem** is the root certificate, run the following command to view:\n\n\u0060\u0060\u0060bash\nopenssl x509 -noout -text -in root.pem\n\u0060\u0060\u0060\n\nAfter the certificate is mounted to the Envoy proxy, *istiod* will take care of periodically replacing the key certificate and revoking the key certificate as needed.\n\n## Summary\n\nThis article introduces you to the function of digital certificates and the trust chain, and how the built-in, out-of-the-box certificate manager operates in Istio. However, the built-in CA in Istio still has certain limitations. In the next blog, I will introduce how to use the SPIRE and cert-manager plugins to achieve fine-grained certificate management and automatic certificate rotation.\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid). TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb), or [contact us for a quick demo](https:\/\/tetr8.io\/contact).\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/how-are-certificates-managed-in-istio\/).*\n', '\/en\/blog\/istio-certificates-management\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This blog post will explain how Istio handles certificate management.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/ambient-mesh-l7-traffic-path/">L7 Traffic Path in Ambient Mesh</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 6, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('L7 Traffic Path in Ambient Mesh', 'This article describes in detail the L7 traffic path in Ambient Mesh in both diagrammatic and hands-on form.', '\n[In my last blog](\/en\/blog\/ambient-mesh-l4-traffic-path\/), I introduced transparent traffic intercepting and L4 routing in Ambient mode. In this blog, I will show you how L7 traffic is routed.\n\nThe figure below shows the L7 network traffic path in ambient mode.\n\n![Figure 1: L7 network traffic in ambient mesh](ambient-mesh-l7-traffic-path.svg)\n\n\u003e Note: The Waypoint proxy can be located on the same node as the application, and even all of the service and the Waypoint proxy can be on the same node. I draw them on three nodes for display purposes, but it has no significant impact on the actual traffic path, except that it is no longer sent to another node via eth0.\n\nIn the following section, we will explore the process in Figure 1 from a hands-on perspective.\n\n## Environments for Waypoint Proxy\n\nLet’s continue to view the environment description using the ambient mode Istio deployed in the previous blog. To illustrate the L7 network routing, we need to create a Gateway on top of this.\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: gateway.networking.k8s.io\/v1alpha2\nkind: Gateway\nmetadata:\n name: productpage\n annotations:\n   istio.io\/service-account: bookinfo-productpage\nspec:\n gatewayClassName: istio-mesh\nEOF\n\u0060\u0060\u0060\n\nAfter executing this command, a Waypoint proxy is created under the default namespace; in my environment, this pod is named \u0060bookinfo-productpage-waypoint-proxy-6f88c55d59-4dzdx\u0060 and is specifically used to handle L7 traffic to the *productpage* service ( Service B), which I will call Waypoint proxy B.\n\nThe Waypoint proxy may be deployed in a different namespace, on a different node from the workload, or both. No matter where the Waypoint proxy is situated, the L7 traffic path is unaffected.\n\nWe will omit the sections of this blog dealing with intercepting inbound and outbound traffic because the way transparent traffic is handled in ambient mesh in L4 and L7 networks is similar. Details are available in the [prior blog](\/en\/blog\/ambient-mesh-l4-traffic-path\/).\n\nWe will start directly with the traffic intercepted at Ztunnel A and then forward it to Envoy port 15006.\n\n## Outbound Traffic Routing on Ztunnel A\n\nUse the following command to dump the Envoy proxy configuration on Ztunnel A:\n\n\u0060\u0060\u0060bash\nkubectl exec -n istio-system ztunnel-hptxk -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003eztunnel-a-all-include-eds.json\n\u0060\u0060\u0060\n\n10.8.14.226 is the Cluster IP of the target service, and the service port is 9080. The traffic will be routed to the \u0060spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0060 cluster. Let’s look at the configuration of that cluster.\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=2 12 18\u0022\u003e}}\n{\n  \u002210.8.14.226\u0022: {\n    \u0022matcher\u0022: {\n    \u0022matcher_tree\u0022: {\n      \u0022input\u0022: {\n      \u0022name\u0022: \u0022port\u0022,\n      \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput\u0022\n      }\n      },\n      \u0022exact_match_map\u0022: {\n      \u0022map\u0022: {\n        \u00229080\u0022: {\n        \u0022action\u0022: {\n          \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022,\n          \u0022typed_config\u0022: {\n          \u0022@type\u0022: \u0022type.googleapis.com\/google.protobuf.StringValue\u0022,\n          \u0022value\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022\n          }\n        }\n        }\n      }\n      }\n    }\n    }\n  }\n}\n{{\u003c\/highlight\u003e}}\n\n\u006010.8.14.226\u0060 is the Cluster IP of the target service, and the service port is 9080. The traffic will be routed to the \u0060spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0060 cluster. Let’s look at the configuration of that cluster.\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep_to_server_waypoint_proxy_spiffe:\/\/cluster.local\/ns\/default\/sa\/bookinfo-productpage\u0022,\n  \u0022type\u0022: \u0022EDS\u0022,\n  \u0022eds_cluster_config\u0022: {\n   \u0022eds_config\u0022: {\n    \u0022ads\u0022: {},\n    \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n    \u0022resource_api_version\u0022: \u0022V3\u0022\n   }\n  },\n  \/* omit *\/\n}\n{{\u003c\/highlight\u003e}}\n\nThe cluster is discovered using the EDS service. To view the EDS information for this cluster:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=11 12\u0022\u003e}}\n{ \n \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.endpoint.v3.ClusterLoadAssignment\u0022,\n \u0022endpoints\u0022: [\n  {\n   \u0022locality\u0022: {},\n   \u0022lb_endpoints\u0022: [\n    {\n     \u0022endpoint\u0022: {\n      \u0022address\u0022: {\n       \u0022socket_address\u0022: {\n        \u0022address\u0022: \u002210.4.3.14\u0022,\n        \u0022port_value\u0022: 15006\n       }\n      },\n      \u0022health_check_config\u0022: {}\n     },\n     \u0022health_status\u0022: \u0022HEALTHY\u0022,\n     \u0022load_balancing_weight\u0022: 1\n    }\n   ]\n  }\n ],\n \u0022policy\u0022: {\n  \u0022overprovisioning_factor\u0022: 140\n }\n}\n{{\u003c\/highlight\u003e}}\n\n\u003e Note: The output cluster_name field is still missing here. See the [GitHub issue](https:\/\/github.com\/istio\/istio\/issues\/42022).\n\nTraffic is forwarded here directly to the Waypoint Proxy endpoint at \u006010.4.3.14:15006\u0060.\n\n## Traffic Routing Using Waypoint Proxy\n\nLet’s dump the Envoy configuration into Waypoint Proxy B again.\n\n\u0060\u0060\u0060bash\nkubectl exec -n default bookinfo-productpage-waypoint-proxy-6f88c55d59-4dzdx -c istio-proxy -- curl \u0022127.0.0.1:15000\/config_dump?include_eds\u0022\u003ewaypoint-a-all-include-eds.json\n\u0060\u0060\u0060\n\nLook into the configuration of inbound_CONNECT_terminate listener:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=7 10 11 39 44 58 62\u0022\u003e}}\n{\n  \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022,\n  \u0022active_state\u0022: {\n    \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n    \u0022listener\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n    \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022,\n    \u0022address\u0022: {\n      \u0022socket_address\u0022: {\n      \u0022address\u0022: \u00220.0.0.0\u0022,\n      \u0022port_value\u0022: 15006\n      }\n    },\n    \u0022filter_chains\u0022: [{\n      \u0022filters\u0022: [{\n        \u0022name\u0022: \u0022capture_tls\u0022,\n        \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n        \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.CaptureTLS\u0022\n        }\n      },\n      {\n        \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n        \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n        \u0022stat_prefix\u0022: \u0022inbound_hcm\u0022,\n        \u0022route_config\u0022: {\n          \u0022name\u0022: \u0022local_route\u0022,\n          \u0022virtual_hosts\u0022: [{\n          \u0022name\u0022: \u0022connect\u0022,\n          \u0022domains\u0022: [\n            \u0022*\u0022\n          ],\n          \u0022routes\u0022: [{...},\n            {\n            \u0022match\u0022: {\n              \u0022headers\u0022: [{\n              \u0022name\u0022: \u0022:authority\u0022,\n              \u0022exact_match\u0022: \u002210.8.14.226:9080\u0022\n              }],\n              \u0022connect_matcher\u0022: {}\n            },\n            \u0022route\u0022: {\n              \u0022cluster\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n              \u0022upgrade_configs\u0022: [{\n              \u0022upgrade_type\u0022: \u0022CONNECT\u0022,\n              \u0022connect_config\u0022: {}\n              }]\n            }\n            }\n          ]\n          }],\n          \u0022validate_clusters\u0022: false\n        },\n        \u0022http_filters\u0022: [...],\n        \u0022tracing\u0022: {...},\n        \u0022http2_protocol_options\u0022: {\n          \u0022allow_connect\u0022: true\n        },\n        \u0022use_remote_address\u0022: false,\n        \u0022upgrade_configs\u0022: [{\n          \u0022upgrade_type\u0022: \u0022CONNECT\u0022\n        }],\n        \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n        \u0022normalize_path\u0022: true,\n        \u0022request_id_extension\u0022: {...},\n        \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n        }\n      }\n      ],\n      \u0022transport_socket\u0022: {...},\n      \u0022name\u0022: \u0022inbound_CONNECT_terminate\u0022\n    }]\n    },\n    \u0022last_updated\u0022: \u00222022-11-17T06:24:51.467Z\u0022\n  }\n}\n{{\u003c\/highlight\u003e}}\n\nTCP traffic destined for \u006010.8.14.226:9080\u0060 will be forwarded to the \u0060inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0060 cluster, and the HTTP method will be changed to CONNECT. To view the configuration of this cluster.\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6 37\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n  \u0022type\u0022: \u0022STATIC\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022passthrough_metadata\u0022: [\n     {\n      \u0022kind\u0022: {\n       \u0022cluster\u0022: {}\n      },\n      \u0022name\u0022: \u0022istio\u0022\n     }\n    ],\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {},\n  \u0022load_assignment\u0022: {\n   \u0022cluster_name\u0022: \u0022inbound-vip|9080|internal|productpage.default.svc.cluster.local\u0022,\n   \u0022endpoints\u0022: [\n    {\n     \u0022lb_endpoints\u0022: [\n      {\n       \u0022endpoint\u0022: {\n        \u0022address\u0022: {\n         \u0022envoy_internal_address\u0022: {\n          \u0022server_listener_name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022\n         }\n        }\n       }\n      }\n     ]\n    }\n   ]\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.137Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\nThe endpoint of the cluster is an Envoy internal listener \u0060inbound-vip|9080||productpage.default.svc.cluster.local\u0060：\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=21-47 73-80\u0022\u003e}}\n{\n \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local\u0022,\n   \u0022filter_chains\u0022: [{\n    \u0022filters\u0022: [{\n      \u0022name\u0022: \u0022restore_tls\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n       \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.RestoreTLS\u0022\n      }\n     },\n     {\n      \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n       \u0022stat_prefix\u0022: \u0022inbound_0.0.0.0_9080\u0022,\n       \u0022route_config\u0022: {\n        \u0022name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n        \u0022virtual_hosts\u0022: [{\n         \u0022name\u0022: \u0022inbound|http|9080\u0022,\n         \u0022domains\u0022: [\n          \u0022*\u0022\n         ],\n         \u0022routes\u0022: [{\n          \u0022match\u0022: {\n           \u0022prefix\u0022: \u0022\/\u0022\n          },\n          \u0022route\u0022: {\n           \u0022cluster\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n           \u0022timeout\u0022: \u00220s\u0022,\n           \u0022max_stream_duration\u0022: {\n            \u0022max_stream_duration\u0022: \u00220s\u0022,\n            \u0022grpc_timeout_header_max\u0022: \u00220s\u0022\n           }\n          },\n          \u0022decorator\u0022: {\n           \u0022operation\u0022: \u0022:9080\/*\u0022\n          },\n          \u0022name\u0022: \u0022default\u0022\n         }]\n        }],\n        \u0022validate_clusters\u0022: false\n       }\n      },\n      \u0022server_name\u0022: \u0022istio-envoy\u0022,\n      \u0022use_remote_address\u0022: false,\n      \u0022forward_client_cert_details\u0022: \u0022APPEND_FORWARD\u0022,\n      \u0022set_current_client_cert_details\u0022: {\n       \u0022subject\u0022: true,\n       \u0022dns\u0022: true,\n       \u0022uri\u0022: true\n      },\n      \u0022upgrade_configs\u0022: [{\n       \u0022upgrade_type\u0022: \u0022websocket\u0022\n      }],\n      \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n      \u0022normalize_path\u0022: true,\n      \u0022request_id_extension\u0022: {\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig\u0022,\n        \u0022use_request_id_for_trace_sampling\u0022: true\n       }\n      },\n      \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n     }\n    ],\n    \u0022name\u0022: \u0022inbound-vip|9080||productpage.default.svc.cluster.local-http\u0022\n   }],\n   \u0022listener_filters\u0022: [{\n     \u0022name\u0022: \u0022set_dst_address\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n      \u0022value\u0022: {}\n     }\n    },\n    {\n     \u0022name\u0022: \u0022envoy.filters.listener.metadata_to_peer_node\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.telemetry.metadatatopeernode.v1.Config\u0022\n     }\n    }\n   ],\n   \u0022traffic_direction\u0022: \u0022INBOUND\u0022,\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.300Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\nThe packets will be forwarded to the cluster \u0060inbound-vip|9080|http|productpage.default.svc.cluster.local\u0060:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n  \u0022type\u0022: \u0022EDS\u0022,\n  \u0022eds_cluster_config\u0022: {\n   \u0022eds_config\u0022: {\n    \u0022ads\u0022: {},\n    \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n    \u0022resource_api_version\u0022: \u0022V3\u0022\n   },\n   \u0022service_name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022\n  },\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022metadata\u0022: {\n   \u0022filter_metadata\u0022: {\n    \u0022istio\u0022: {\n     \u0022services\u0022: [{\n      \u0022namespace\u0022: \u0022default\u0022,\n      \u0022name\u0022: \u0022productpage\u0022,\n      \u0022host\u0022: \u0022productpage.default.svc.cluster.local\u0022\n     }]\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {}\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.138Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\nThe cluster type is EDS, check the Endpoint configuration:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=14\u0022\u003e}}\n{\n \u0022endpoint_config\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.endpoint.v3.ClusterLoadAssignment\u0022,\n  \u0022cluster_name\u0022: \u0022inbound-vip|9080|http|productpage.default.svc.cluster.local\u0022,\n  \u0022endpoints\u0022: [{\n   \u0022locality\u0022: {\n    \u0022region\u0022: \u0022us-west2\u0022,\n    \u0022zone\u0022: \u0022us-west2-a\u0022\n   },\n   \u0022lb_endpoints\u0022: [{\n    \u0022endpoint\u0022: {\n     \u0022address\u0022: {\n      \u0022envoy_internal_address\u0022: {\n       \u0022server_listener_name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022\n      }\n     },\n     \u0022health_check_config\u0022: {}\n    },\n    \u0022health_status\u0022: \u0022HEALTHY\u0022,\n    \u0022metadata\u0022: {\n     \u0022filter_metadata\u0022: {\n      \u0022istio\u0022: {\n       \u0022workload\u0022: \u0022productpage-v1;default;productpage;v1;Kubernetes\u0022\n      }\n     }\n    },\n    \u0022load_balancing_weight\u0022: 1\n   }]\n  }],\n  \u0022policy\u0022: {\n   \u0022overprovisioning_factor\u0022: 140\n  }\n }\n}\n{{\u003c\/highlight\u003e}}\n\nThe packets will be forwarded to the listener \u0060inbound-pod|9080||10.4.0.5\u0060 and \u0060inbound-pod|9080||10.4.0.5\u0060 cluster\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=33\u0022\u003e}}\n\n{\n \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n   \u0022filter_chains\u0022: [{\n    \u0022filters\u0022: [{\n      \u0022name\u0022: \u0022restore_tls\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/udpa.type.v1.TypedStruct\u0022,\n       \u0022type_url\u0022: \u0022type.googleapis.com\/istio.tls_passthrough.v1.RestoreTLS\u0022\n      }\n     },\n     {\n      \u0022name\u0022: \u0022envoy.filters.network.http_connection_manager\u0022,\n      \u0022typed_config\u0022: {\n       \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\u0022,\n       \u0022stat_prefix\u0022: \u0022inbound_0.0.0.0_9080\u0022,\n       \u0022route_config\u0022: {\n        \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n        \u0022virtual_hosts\u0022: [{\n         \u0022name\u0022: \u0022inbound|http|9080\u0022,\n         \u0022domains\u0022: [\n          \u0022*\u0022\n         ],\n         \u0022routes\u0022: [{\n          \u0022match\u0022: {\n           \u0022prefix\u0022: \u0022\/\u0022\n          },\n          \u0022route\u0022: {\n           \u0022cluster\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n           \u0022timeout\u0022: \u00220s\u0022,\n           \u0022max_stream_duration\u0022: {\n            \u0022max_stream_duration\u0022: \u00220s\u0022,\n            \u0022grpc_timeout_header_max\u0022: \u00220s\u0022\n           }\n          },\n          \u0022decorator\u0022: {\n           \u0022operation\u0022: \u0022:9080\/*\u0022\n          },\n          \u0022name\u0022: \u0022default\u0022\n         }]\n        }],\n        \u0022validate_clusters\u0022: false\n       },\n       \u0022http_filters\u0022: [{\n        \u0022name\u0022: \u0022envoy.filters.http.rbac\u0022,\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.http.rbac.v3.RBAC\u0022,\n         \u0022rules\u0022: {\n          \u0022policies\u0022: {\n           \u0022ns[default]-policy[productpage-viewer]-rule[0]\u0022: {\n            \u0022permissions\u0022: [{\n             \u0022and_rules\u0022: {\n              \u0022rules\u0022: [{\n               \u0022any\u0022: true\n              }]\n             }\n            }],\n            \u0022principals\u0022: [{\n             \u0022and_ids\u0022: {\n              \u0022ids\u0022: [{\n               \u0022or_ids\u0022: {\n                \u0022ids\u0022: [{\n                  \u0022authenticated\u0022: {\n                   \u0022principal_name\u0022: {\n                    \u0022exact\u0022: \u0022spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\u0022\n                   }\n                  }\n                 },\n                 {\n                  \u0022authenticated\u0022: {\n                   \u0022principal_name\u0022: {\n                    \u0022exact\u0022: \u0022spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\u0022\n                   }\n                  }\n                 }\n                ]\n               }\n              }]\n             }\n            }]\n           }\n          }\n         },\n         \u0022shadow_rules_stat_prefix\u0022: \u0022istio_dry_run_allow_\u0022\n        }\n       }],\n       \u0022server_name\u0022: \u0022istio-envoy\u0022,\n       \u0022use_remote_address\u0022: false,\n       \u0022forward_client_cert_details\u0022: \u0022APPEND_FORWARD\u0022,\n       \u0022set_current_client_cert_details\u0022: {\n        \u0022subject\u0022: true,\n        \u0022dns\u0022: true,\n        \u0022uri\u0022: true\n       },\n       \u0022upgrade_configs\u0022: [{\n        \u0022upgrade_type\u0022: \u0022websocket\u0022\n       }],\n       \u0022stream_idle_timeout\u0022: \u00220s\u0022,\n       \u0022normalize_path\u0022: true,\n       \u0022request_id_extension\u0022: {\n        \u0022typed_config\u0022: {\n         \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.request_id.uuid.v3.UuidRequestIdConfig\u0022,\n         \u0022use_request_id_for_trace_sampling\u0022: true\n        }\n       },\n       \u0022path_with_escaped_slashes_action\u0022: \u0022KEEP_UNCHANGED\u0022\n      }\n     }\n    ],\n    \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5-http\u0022\n   }],\n   \u0022listener_filters\u0022: [{\n    \u0022name\u0022: \u0022set_dst_address\u0022,\n    \u0022typed_config\u0022: {\n     \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n     \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n     \u0022value\u0022: {}\n    }\n   }],\n   \u0022traffic_direction\u0022: \u0022INBOUND\u0022,\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.339Z\u0022\n }\n}\n\n{{\u003c\/highlight\u003e}}\n\nPackets are forwarded to the \u0060inbound-pod|9080||10.4.0.5 cluster\u0060:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6 43 48-55\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n  \u0022type\u0022: \u0022STATIC\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.internal_upstream\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport\u0022,\n    \u0022passthrough_metadata\u0022: [\n     {\n      \u0022kind\u0022: {\n       \u0022host\u0022: {}\n      },\n      \u0022name\u0022: \u0022tunnel\u0022\n     },\n     {\n      \u0022kind\u0022: {\n       \u0022host\u0022: {}\n      },\n      \u0022name\u0022: \u0022istio\u0022\n     }\n    ],\n    \u0022transport_socket\u0022: {\n     \u0022name\u0022: \u0022envoy.transport_sockets.raw_buffer\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer\u0022\n     }\n    }\n   }\n  },\n  \u0022common_lb_config\u0022: {},\n  \u0022load_assignment\u0022: {\n   \u0022cluster_name\u0022: \u0022inbound-pod|9080||10.4.0.5\u0022,\n   \u0022endpoints\u0022: [\n    {\n     \u0022lb_endpoints\u0022: [\n      {\n       \u0022endpoint\u0022: {\n        \u0022address\u0022: {\n         \u0022envoy_internal_address\u0022: {\n          \u0022server_listener_name\u0022: \u0022inbound_CONNECT_originate\u0022,\n          \u0022endpoint_id\u0022: \u002210.4.0.5:9080\u0022\n         }\n        }\n       },\n       \u0022metadata\u0022: {\n        \u0022filter_metadata\u0022: {\n         \u0022tunnel\u0022: {\n          \u0022destination\u0022: \u002210.4.0.5:9080\u0022,\n          \u0022address\u0022: \u002210.4.0.5:15008\u0022\n         }\n        }\n       }\n      }\n     ]\n    }\n   ]\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.139Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\nThe cluster is of type STATIC, which contains the HBONE tunnel configuration (HTTP\/2 CONNECT address is \u006010.4.0.15008\u0060), and the endpoint is the Envoy internal listener \u0060inbound_CONNECT_originate\u0060:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=16-27 33 36\u0022\u003e}}\n{\n \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n \u0022active_state\u0022: {\n  \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n  \u0022listener\u0022: {\n   \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.listener.v3.Listener\u0022,\n   \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n   \u0022filter_chains\u0022: [\n    {\n     \u0022filters\u0022: [\n      {\n       \u0022name\u0022: \u0022envoy.filters.network.tcp_proxy\u0022,\n       \u0022typed_config\u0022: {\n        \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy\u0022,\n        \u0022stat_prefix\u0022: \u0022inbound_CONNECT_originate\u0022,\n        \u0022cluster\u0022: \u0022inbound_CONNECT_originate\u0022,\n        \u0022tunneling_config\u0022: {\n         \u0022hostname\u0022: \u0022%DYNAMIC_METADATA(tunnel:destination)%\u0022,\n         \u0022headers_to_add\u0022: [\n          {\n           \u0022header\u0022: {\n            \u0022key\u0022: \u0022x-envoy-original-dst-host\u0022,\n            \u0022value\u0022: \u0022%DYNAMIC_METADATA([\\\u0022tunnel\\\u0022, \\\u0022destination\\\u0022])%\u0022\n           }\n          }\n         ]\n        }\n       }\n      }\n     ]\n    }\n   ],\n   \u0022use_original_dst\u0022: false,\n   \u0022listener_filters\u0022: [\n    {\n     \u0022name\u0022: \u0022set_dst_address\u0022,\n     \u0022typed_config\u0022: {\n      \u0022@type\u0022: \u0022type.googleapis.com\/xds.type.v3.TypedStruct\u0022,\n      \u0022type_url\u0022: \u0022type.googleapis.com\/istio.set_internal_dst_address.v1.Config\u0022,\n      \u0022value\u0022: {}\n     }\n    }\n   ],\n   \u0022internal_listener\u0022: {}\n  },\n  \u0022last_updated\u0022: \u00222022-11-17T03:27:46.339Z\u0022\n }\n}\n{{\u003c\/highlight\u003e}}\n\nDescription:\n\n- \u0060set_dst_address\u0060 in \u0060listener_filters\u0060 sets the destination address to \u006010.4.0.5.15008\u0060.\n- A new header is added to the tunnel: \u0060x-envoy-original-dst-host\u0060, which has the value \u006010.4.0.5:9080\u0060.\n- The endpoint of this cluster is the \u0060inbound_CONNECT_originate\u0060 cluster.\n\nLook into the *inbound_CONNECT_originate* cluster:\n\n{{\u003chighlight json \u0022linenos=table,hl_lines=6\u0022\u003e}}\n{\n \u0022version_info\u0022: \u00222022-11-17T03:27:45Z\/82\u0022,\n \u0022cluster\u0022: {\n  \u0022@type\u0022: \u0022type.googleapis.com\/envoy.config.cluster.v3.Cluster\u0022,\n  \u0022name\u0022: \u0022inbound_CONNECT_originate\u0022,\n  \u0022type\u0022: \u0022ORIGINAL_DST\u0022,\n  \u0022connect_timeout\u0022: \u00222s\u0022,\n  \u0022lb_policy\u0022: \u0022CLUSTER_PROVIDED\u0022,\n  \u0022cleanup_interval\u0022: \u002260s\u0022,\n  \u0022transport_socket\u0022: {\n   \u0022name\u0022: \u0022envoy.transport_sockets.tls\u0022,\n   \u0022typed_config\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext\u0022,\n    \u0022common_tls_context\u0022: {\n     \u0022tls_params\u0022: {\n      \u0022tls_minimum_protocol_version\u0022: \u0022TLSv1_3\u0022,\n      \u0022tls_maximum_protocol_version\u0022: \u0022TLSv1_3\u0022\n     },\n     \u0022alpn_protocols\u0022: [\n      \u0022h2\u0022\n     ],\n     \u0022tls_certificate_sds_secret_configs\u0022: [\n      {\n       \u0022name\u0022: \u0022default\u0022,\n       \u0022sds_config\u0022: {\n        \u0022api_config_source\u0022: {\n         \u0022api_type\u0022: \u0022GRPC\u0022,\n         \u0022grpc_services\u0022: [\n          {\n           \u0022envoy_grpc\u0022: {\n            \u0022cluster_name\u0022: \u0022sds-grpc\u0022\n           }\n          }\n         ],\n         \u0022set_node_on_first_message_only\u0022: true,\n         \u0022transport_api_version\u0022: \u0022V3\u0022\n        },\n        \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n        \u0022resource_api_version\u0022: \u0022V3\u0022\n       }\n      }\n     ],\n     \u0022combined_validation_context\u0022: {\n      \u0022default_validation_context\u0022: {\n       \u0022match_subject_alt_names\u0022: [\n        {\n         \u0022prefix\u0022: \u0022spiffe:\/\/cluster.local\/\u0022\n        }\n       ]\n      },\n      \u0022validation_context_sds_secret_config\u0022: {\n       \u0022name\u0022: \u0022ROOTCA\u0022,\n       \u0022sds_config\u0022: {\n        \u0022api_config_source\u0022: {\n         \u0022api_type\u0022: \u0022GRPC\u0022,\n         \u0022grpc_services\u0022: [\n          {\n           \u0022envoy_grpc\u0022: {\n            \u0022cluster_name\u0022: \u0022sds-grpc\u0022\n           }\n          }\n         ],\n         \u0022set_node_on_first_message_only\u0022: true,\n         \u0022transport_api_version\u0022: \u0022V3\u0022\n        },\n        \u0022initial_fetch_timeout\u0022: \u00220s\u0022,\n        \u0022resource_api_version\u0022: \u0022V3\u0022\n       }\n      }\n     }\n    }\n   }\n  },\n  \u0022typed_extension_protocol_options\u0022: {\n   \u0022envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022: {\n    \u0022@type\u0022: \u0022type.googleapis.com\/envoy.extensions.upstreams.http.v3.HttpProtocolOptions\u0022,\n    \u0022explicit_http_config\u0022: {\n     \u0022http2_protocol_options\u0022: {\n      \u0022allow_connect\u0022: true\n     }\n    }\n   }\n  }\n },\n \u0022last_updated\u0022: \u00222022-11-17T03:27:46.140Z\u0022\n}\n{{\u003c\/highlight\u003e}}\n\nThis cluster, which is of type \u0060ORIGINAL_DST\u0060, creates a direct HBONE tunnel with the upstream in order to send packets to port 15008 on Pod B. The traffic intercepting and routing of the Ztunnel in Node B is the same as in L4, so I won’t go over it here.dsr5t\n\n## Summary\n\nL7 traffic routing is based on L4 with the addition of the Waypoint proxy, which is more complex to handle in Envoy. We can also create HPAs to scale it dynamically.\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid) . TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb) , or [contact us for a quick demo](https:\/\/tetr8.io\/contact) .\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/l7-traffic-path-in-ambient-mesh\/).*\n', '\/en\/blog\/ambient-mesh-l7-traffic-path\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article describes in detail the L7 traffic path in Ambient Mesh in both diagrammatic and hands-on form.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/what-is-tproxy/">How Istio&#39;s Ambient Mode Transparent Proxy - tproxy Works Under the Hood</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 5, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How Istio\u0027s Ambient Mode Transparent Proxy - tproxy Works Under the Hood', 'Tproxy is used to intercept traffic in Istio Ambient mode.', '\nIstio’s new “ambient mode” is [an experimental, “sidecar-less” deployment model for Istio](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/). Instead of a sidecar proxy in front of every workload, ambient mode uses [*tproxy*](https:\/\/www.kernel.org\/doc\/Documentation\/networking\/tproxy.txt) and [HTTP Based Overlay Network Environment (HBONE)](https:\/\/pkg.go.dev\/github.com\/costinm\/hbone) as key technologies for transparent traffic intercepting and routing that we covered in our recent article on [transparent traffic intercepting and routing in the L4 network of Istio Ambient Mesh](https:\/\/tetrate.io\/blog\/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh\/). In this article, we’ll take a closer look at *tproxy* and how it’s used.\n\n## What Is a Proxy For?\n\nProxies have a wide range of uses on the Internet, such as:\n\n- **Request caching:** to speed up network response, acting similarly to a CDN.\n- **Traffic filtering**: used for network supervision, blocking or allowing access to specific hosts and websites.\n- **Traffic forwarding:** used for load balancing or as a network relay.\n- **Traffic management:** fine-grained management of traffic to and from the proxy, such as publishing to different backends by percentage, timeout and retry settings, circuit breaking, etc.\n- **Security auditing:** logging and limiting client requests for billing or auditing purposes.\n\n## Proxy Types\n\nThere are a number of ways to classify proxies based on how they’re used. You can see two categories based on the location of the proxy in Figure 1:\n\n![Figure 1: Forward proxy and reverse proxy.](proxy.svg)\n\n- **Forward proxies** ([like shadowsocks](https:\/\/shadowsocks.org\/)) run on the client side and send requests to the server on behalf of the client.\n- **Reverse proxies** (often in the form of a web server) accept Internet or external requests on behalf of the server and route them to the corresponding backends.\n\nProxies may be located on the same node as the client or server or on a different node. We can classify them as **transparent** or **non-transparent** based on whether the client or server can see them. Figure 2 (below) shows the process of a client (A) sending a request to a server (C) through a proxy (B).\n\n![Figure 2: Transparent vs. non-transparent proxies](transparent-proxy.svg)\n\n- To use a **non-transparent proxy,** the client needs to explicitly change the destination address to that of the proxy server and use the proxy protocol to connect to the proxy server.\n- To use a **transparent proxy,** the client and the server do not know the proxy is there, which means the client does not need to modify the destination address, and does not need to use the proxy protocol to connect to the proxy server; all the destination address conversion is done in the transparent proxy.\n\n## Using the *tproxy* Transparent Proxy\n\n*tproxy* is a Linux kernel module (since Linux 2.2) that implements transparent proxies. To use *tproxy*, you must first use *iptables* to intercept the required packets at the required NIC, then listen for and forward the packet on that NIC.\n\nFollow these steps to use *tproxy* to implement a transparent proxy:\n\n1. First, you need to implement traffic interception: create a rule in the mangle table of the PREROUTING chain of iptables to intercept traffic and send it to tproxy for processing, for example, \u0060iptables -t mangle -A PREROUTING -p tcp -dport 9080 -j TPROXY --on-port 15001 --on-ip 127.0.0.1 --tproxy-mark 0x1\/0x1\u0060, marking all TCP packets destined for port 9080 with a mark 1. You can specify the source IP address or [IP set](https:\/\/ipset.netfilter.org\/) to further narrow the marking, with *tproxy* listening on port 15001.\n2. Create a routing rule that looks up all packets with mark 1 in a specific routing table: for example, \u0060add ip rule add fwmark 1 lookup 100\u0060, so that all packets with \u0060fwmark 1\u0060 look up to the routing table 100.\n3. Mapping packets to specific local addresses: for example, \u0060ip rule add local 0.0.0.0\/0 dev lo table 100\u0060, which declares all IPv4 addresses as local in the routing table 100, but of course, this is just an example. In practice, you will need to forward packets with specific IPs to the local *lo* loopback NIC.\n\nThe traffic has been intercepted on *tproxy’s* listening port 15001 (enter from Linux kernel space into user space). You can write a web application to process the packets or use *tproxy*-enabled software such as [Squid](http:\/\/www.squid-cache.org\/) or [Envoy](https:\/\/www.envoyproxy.io\/) to process the packets.\n\n## Pros and Cons of Transparent Proxies\n\nTransparent proxies have the following advantages:\n\n- Higher bandwidth and reduced transmission latency, thereby improving the quality of service.\n- No need for users to configure networks and hosts.\n- Control access to network services.\n\nTransparent proxies have the following disadvantages:\n\n- Incorrectly configured, the transparent proxy may prevent connection to the Internet, leaving users unable to troubleshoot and fix errors.\n- Security cannot be guaranteed, as intercepted user traffic may be tampered with by transparent proxies.\n- The risk that transparent proxies may cache user information, leading to privacy leaks.\n\n## Summary\n\nAs a vital type of proxy, transparent proxies are used in a wide range of applications, whether in proxy software such as *shadowsocks*, Xray, or in the Istio service mesh. Understanding how they work helps us use proxies correctly, and whether or not you use a transparent proxy depends on how much you trust and know about it.\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/what-is-tproxy-and-how-does-it-work\/).*\n', '\/en\/blog\/what-is-tproxy\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Tproxy is used to intercept traffic in Istio Ambient mode.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/distributed-tracing-with-skywalking-in-istio/">How to Use SkyWalking for Distributed Tracing in Istio?</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 4, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How to Use SkyWalking for Distributed Tracing in Istio?', 'This blog will guide you to use SkyWalking for distributed tracing with Istio.', '\nIn cloud native applications, a request often needs to be processed through a series of APIs or backend services, some of which are parallel and some serial and located on different platforms or nodes. How do we determine the service paths and nodes a call goes through to help us troubleshoot the problem? This is where distributed tracing comes into play.\n\nThis article covers:\n\n- How distributed tracing works\n- How to choose distributed tracing software\n- How to use distributed tracing in Istio\n- How to view distributed tracing data using Bookinfo and SkyWalking as examples\n\n## Distributed Tracing Basics\n\nDistributed tracing is a method for tracing requests in a distributed system to help users better understand, control, and optimize distributed systems. There are two concepts used in distributed tracing: TraceID and SpanID. You can see them in Figure 1 below.\n\n- **TraceID** is a globally unique ID that identifies the trace information of a request. All traces of a request belong to the same TraceID, and the TraceID remains constant throughout the trace of the request.\n- **SpanID** is a locally unique ID that identifies a request’s trace information at a certain time. A request generates different SpanIDs at different periods, and SpanIDs are used to distinguish trace information for a request at different periods.\n\nTraceID and SpanID are the basis of distributed tracing. They provide a uniform identifier for request tracing in distributed systems and facilitate users’ ability to query, manage, and analyze the trace information of requests.\n\n![Figure 1: Trace and span](basic.svg)\n\nThe following is the process of distributed tracing:\n\n- When a system receives a request, the distributed tracing system assigns a TraceID to the request, which is used to chain together the entire chain of invocations.\n- The distributed trace system generates a SpanID and ParentID for each service call within the system for the request, which is used to record the parent-child relationship of the call; a Span without a ParentID is used as the entry point of the call chain.\n- TraceID and SpanID are to be passed during each service call.\n- When viewing a distributed trace, query the full process of a particular request by TraceID.\n\n## How Istio Implements Distributed Tracing\n\nIstio’s distributed tracing is based on information collected by the Envoy proxy in the data plane. After a service request is intercepted by Envoy, Envoy adds tracing information as headers to the request forwarded to the destination workload. The following headers are relevant for distributed tracing:\n\n- As TraceID: x-request-id\n- Used to establish parent-child relationships for Span in the LightStep trace: x-ot-span-context\u003c\/li\n- Used for Zipkin, also for Jaeger, SkyWalking, see [b3-propagation](https:\/\/github.com\/openzipkin\/b3-propagation):\n  - *x-b3-traceid*\n  - *x-b3-traceid*\n  - *x-b3-spanid*\n  - *x-b3-parentspanid*\n  - *x-b3-sampled*\n  - *x-b3-flags*\n  - *b3*\n- For Datadog:\n  - *x-datadog-trace-id*\n  - *x-datadog-parent-id*\n  - *x-datadog-sampling-priority*\n- For SkyWalking: *sw8*\n- For AWS X-Ray: *x-amzn-trace-id*\n\nFor more information on how to use these headers, please see the [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers).\n\nRegardless of the language of your application, Envoy will generate the appropriate tracing headers for you at the Ingress Gateway and forward these headers to the upstream cluster. However, in order to utilize the distributed tracing feature, you must modify your application code to attach the tracing headers to upstream requests. Since neither the service mesh nor the application can automatically propagate these headers, you can integrate the agent for distributed tracing into the application or manually propagate these headers in the application code itself. Once the tracing headers are propagated to all upstream requests, Envoy will send the tracing data to the tracer’s back-end processing, and then you can view the tracing data in the UI.\n\nFor example, look at the code of the Productpage service in the [Bookinfo application](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/). You can see that it integrates the Jaeger client library and synchronizes the header generated by Envoy with the HTTP requests to the Details and Reviews services in the *getForwardHeaders (request)* function.\n\n\u0060\u0060\u0060python\ndef getForwardHeaders(request):\n    headers = {}\n\n    # Using Jaeger agent to get the x-b3-* headers\n    span = get_current_span()\n    carrier = {}\n    tracer.inject(\n        span_context=span.context,\n        format=Format.HTTP_HEADERS,\n        carrier=carrier)\n\n    headers.update(carrier)\n\n    # Dealing with the non x-b3-* header manually\n    if \u0027user\u0027 in session:\n        headers[\u0027end-user\u0027] = session[\u0027user\u0027]\n    incoming_headers = [\n        \u0027x-request-id\u0027,\n        \u0027x-ot-span-context\u0027,\n        \u0027x-datadog-trace-id\u0027,\n        \u0027x-datadog-parent-id\u0027,\n        \u0027x-datadog-sampling-priority\u0027,\n        \u0027traceparent\u0027,\n        \u0027tracestate\u0027,\n        \u0027x-cloud-trace-context\u0027,\n        \u0027grpc-trace-bin\u0027,\n        \u0027sw8\u0027,\n        \u0027user-agent\u0027,\n        \u0027cookie\u0027,\n        \u0027authorization\u0027,\n        \u0027jwt\u0027,\n    ]\n\n    for ihdr in incoming_headers:\n        val = request.headers.get(ihdr)\n        if val is not None:\n            headers[ihdr] = val\n\n    return headers\n\u0060\u0060\u0060\n\nFor more information, the [Istio documentation](https:\/\/istio.io\/latest\/about\/faq\/#distributed-tracing) provides answers to frequently asked questions about distributed tracing in Istio.\n\n## How to Choose A Distributed Tracing System\n\nDistributed tracing systems are similar in principle. There are many such systems on the market, such as [Apache SkyWalking](https:\/\/github.com\/apache\/skywalking), [Jaeger](https:\/\/github.com\/jaegertracing\/jaeger), [Zipkin](https:\/\/github.com\/openzipkin\/zipkin\/), Lightstep, [Pinpoint](https:\/\/github.com\/pinpoint-apm\/pinpoint), and so on. For our purposes here, we will choose three of them and compare them in several dimensions. Here are our inclusion criteria:\n\n- They are currently the most popular open-source distributed tracing systems.\n- All are based on the OpenTracing specification.\n- They support integration with Istio and Envoy.\n\n| Items               | Apache SkyWalking                                            | Jaeger                                       | Zipkin                                       |\n| ------------------- | ------------------------------------------------------------ | -------------------------------------------- | -------------------------------------------- |\n| Implementations     | Language-based probes, service mesh probes, eBPF agent, third-party instrumental libraries (Zipkin currently supported) | Language-based probes                        | Language-based probes                        |\n| Database            | ES, H2, MySQL, TiDB, Sharding-sphere, BanyanDB               | ES, MySQL, Cassandra, Memory                 | ES, MySQL, Cassandra, Memory                 |\n| Supported Languages | Java, Rust, PHP, NodeJS, Go, Python, C\u002b\u002b, .Net, Lua          | Java, Go, Python, NodeJS, C#, PHP, Ruby, C\u002b\u002b | Java, Go, Python, NodeJS, C#, PHP, Ruby, C\u002b\u002b |\n| Initiator           | Personal                                                     | Uber                                         | Twitter                                      |\n| Governance          | Apache Foundation                                            | CNCF                                         | CNCF                                         |\n| Version             | 9.3.0                                                        | 1.39.0                                       | 2.23.19                                      |\n| Stars               | 20.9k                                                        | 16.8k                                        | 15.8k                                        |\n\nAlthough Apache SkyWalking’s agent does not support as many languages as Jaeger and Zipkin, SkyWalking’s implementation is richer and compatible with Jaeger and Zipkin trace data, and development is more active, so it is one of the best choices for building a telemetry platform.\n\n## Demo\n\nRefer to the [Istio documentation](https:\/\/istio.io\/latest\/docs\/tasks\/observability\/distributed-tracing\/skywalking\/) to install and configure Apache SkyWalking.\n\n### Environment Description\n\nThe following is the environment for our demo:\n\n- Kubernetes 1.24.5\n- Istio 1.16\n- SkyWalking 9.1.0\n\n### Install Istio\n\nBefore installing Istio, you can check the environment for any problems:\n\n\u0060\u0060\u0060bash\n$ istioctl experimental precheck\n✔ No issues found when checking the cluster. Istio is safe to install or upgrade!\n  To get started, check out https:\/\/istio.io\/latest\/docs\/setup\/getting-started\/\n\u0060\u0060\u0060\n\nThen install Istio and configure the destination for sending tracing messages as SkyWalking:\n\n\u0060\u0060\u0060bash\n# Initial Istio Operator\nistioctl operator init\n# Configure tracing destination\nkubectl apply -f - \u003c\u003cEOF\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\n  name: istio-with-skywalking\nspec:\n  meshConfig:\n    defaultProviders:\n      tracing:\n      - \u0022skywalking\u0022\n    enableTracing: true\n    extensionProviders:\n    - name: \u0022skywalking\u0022\n      skywalking:\n        service: tracing.istio-system.svc.cluster.local\n        port: 11800\nEOF\n\u0060\u0060\u0060\n\n## Deploy Apache SkyWalking\n\nIstio 1.16 supports distributed tracing using Apache SkyWalking. Install SkyWalking by executing the following code:\n\n\u0060\u0060\u0060bash\nkubectl apply -f \nhttps:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.16\/samples\/addons\/extras\/skywalking.yaml\n\u0060\u0060\u0060\n\nIt will install the following components under the *istio-system* namespace:\n\n- SkyWalking Observability Analysis Platform (OAP): Used to receive trace data, supports SkyWalking native data formats, Zipkin v1 and v2 and Jaeger format.\n- UI: Used to query distributed trace data.\n\nFor more information about SkyWalking, please refer to the SkyWalking documentation.\n\n## Deploy the Bookinfo Application\n\nExecute the following command to install the bookinfo application:\n\n\u0060\u0060\u0060bash\nkubectl label namespace default istio-injection=enabled\nkubectl apply -f samples\/bookinfo\/platform\/kube\/bookinfo.yaml\nkubectl apply -f samples\/bookinfo\/networking\/bookinfo-gateway.yaml\n\u0060\u0060\u0060\n\nLaunch the SkyWalking UI:\n\n\u0060\u0060\u0060bash\nistioctl dashboard skywalking\n\u0060\u0060\u0060\n\nFigure 2 shows all the services available in the bookinfo application:\n\n![Figure 2: SkyWalking General Service page](general-service.jpg)\n\nYou can also see information about instances, endpoints, topology, tracing, etc. For example, Figure 3 shows the service topology of the bookinfo application:\n\n![Figure 3: Topology diagram of the Bookinfo application](topology.jpg)\n\nTracing views in SkyWalking can be displayed in a variety of formats, including list, tree, table, and statistics. See Figure 4:\n\n![Figure 4: SkyWalking General Service trace supports multiple display formats](gs-styles.jpg)\n\nTo facilitate our examination, set the sampling rate of the trace to 100%:\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: telemetry.istio.io\/v1alpha1\nkind: Telemetry\nmetadata:\n  name: mesh-default\n  namespace: istio-system\nspec:\n  tracing:\n  - randomSamplingPercentage: 100.00\nEOF\n\u0060\u0060\u0060\n\n\u003e **Important:** *It’s generally not good practice to set the sampling rate to 100% in a production environment. To avoid the overhead of generating too many trace logs in production, please adjust the sampling strategy (sampling percentage).*\n\n## Uninstall\n\nAfter experimenting, uninstall Istio and SkyWalking by executing the following command.\n\n\u0060\u0060\u0060bash\nsamples\/bookinfo\/platform\/kube\/cleanup.sh\nistioctl unintall --purge\nkubectl delete namespace istio-system\n\u0060\u0060\u0060\n\n## Understanding the Bookinfo Tracing Information\n\nNavigate to the General Service tab in the Apache SkyWalking UI, and you can see the trace information for the most recent *istio-ingressgateway* service, as shown in Figure 5. Click on each span to see the details.\n\n![Figure 5: The table view shows the basic information about each span.](span-table.jpg)\n\nSwitching to the list view, you can see the execution order and duration of each span, as shown in Figure 6:\n\n![Figure 6: List display](trace-list.jpg)\n\nYou might want to know why such a straightforward application generates so much span data. Because after we inject the Envoy proxy into the pod, every request between services will be intercepted and processed by Envoy, as shown in Figure 7:\n\n![Figure 7: Envoy intercepts requests to generate a span](span.svg)\n\nThe tracing process is shown in Figure 8:\n\n![Figure 8: Trace of the Bookinfo application](bookinfo-spans-with-time.svg)\n\nWe give each span a label with a serial number, and the time taken is indicated in parentheses. For illustration purposes, we have summarized all spans in the table below.\n\n| No.  | Endpoint     | Total Duration (ms) | Component Duration (ms) | Current Service      | Description                                 |\n| ---- | ------------ | ------------------- | ----------------------- | -------------------- | ------------------------------------------- |\n| 1    | \/productpage | 190                 | 0                       | istio-ingressgateway | Envoy Outbound                              |\n| 2    | \/productpage | 190                 | 1                       | istio-ingressgateway | Ingress -\u003e Productpage network transmission |\n| 3    | \/productpage | 189                 | 1                       | productpage          | Envoy Inbound                               |\n| 4    | \/productpage | 188                 | 21                      | productpage          | Application internal processing             |\n| 5    | \/details\/0   | 8                   | 1                       | productpage          | Envoy Outbound                              |\n| 6    | \/details\/0   | 7                   | 3                       | productpage          | Productpage -\u003e Details network transmission |\n| 7    | \/details\/0   | 4                   | 0                       | details              | Envoy Inbound                               |\n| 8    | \/details\/0   | 4                   | 4                       | details              | Application internal processing             |\n| 9    | \/reviews\/0   | 159                 | 0                       | productpage          | Envoy Outbound                              |\n| 10   | \/reviews\/0   | 159                 | 14                      | productpage          | Productpage -\u003e Reviews network transmission |\n| 11   | \/reviews\/0   | 145                 | 1                       | reviews              | Envoy Inbound                               |\n| 12   | \/reviews\/0   | 144                 | 109                     | reviews              | Application internal processing             |\n| 13   | \/ratings\/0   | 35                  | 2                       | reviews              | Envoy Outbound                              |\n| 14   | \/ratings\/0   | 33                  | 16                      | reviews              | Reviews -\u003e Ratings network transmission     |\n| 15   | \/ratings\/0   | 17                  | 1                       | ratings              | Envoy Inbound                               |\n| 16   | \/ratings\/0   | 16                  | 16                      | ratings              | Application internal processing             |\n\nFrom the above information, it can be seen that:\n\n- The total time consumed for this request is 190 ms.\n- In Istio sidecar mode, each traffic flow in and out of the application container must pass through the Envoy proxy once, each time taking 0 to 2 ms.\n- Network requests between Pods take between 1 and 16ms.\n- This is because the data itself has errors and the start time of the Span is not necessarily equal to the end time of the parent Span.\n- We can see that the most time-consuming part is the Reviews application, which takes 109 ms so that we can optimize it for that application.\n\n## Summary\n\nDistributed tracing is an indispensable tool for analyzing performance and troubleshooting modern distributed applications. In this tutorial, we’ve seen how, with just a few minor changes to your application code to propagate tracing headers, Istio makes distributed tracing simple to use. We’ve also reviewed [Apache SkyWalking](https:\/\/skywalking.apache.org\/) as one of the best distributed tracing systems that Istio supports. It is a fully functional platform for cloud native application analytics, with features such as metrics and log collection, alerting, Kubernetes monitoring, [service mesh performance diagnosis using eBPF](https:\/\/skywalking.apache.org\/blog\/diagnose-service-mesh-network-performance-with-ebpf\/), and more.\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid). TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.\n\nOnce you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb), or [contact us for a quick demo](https:\/\/tetr8.io\/contact).\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/how-to-use-skywalking-for-distributed-tracing-in-istio\/).*\n', '\/en\/blog\/distributed-tracing-with-skywalking-in-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This blog will guide you to use SkyWalking for distributed tracing with Istio.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/cert-manager-spire-istio/">Managing Certificates in Istio with cert-manager and SPIRE</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Dec 27, 2022</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Managing Certificates in Istio with cert-manager and SPIRE', 'This article describes how to integrate SPIRE and use cert-manager to achieve fine-grained certificate management and certificate rotation.', '\n{{\u003ccallout warning \u0022Note\u0022\u003e}}\nStarting from version v1.5.4, SPIRE has removed the Kubernetes Workload Registrar component in favor of the SPIRE Controller Manager, as detailed in [spire\/spire issue #3853](https:\/\/github.com\/spiffe\/spire\/pull\/3853). Based on my testing, the procedures outlined in this article cannot be executed on v1.5.4 or later due to a series of authentication failures.\n{{\u003c\/callout\u003e}}\n\nIn the [previous blog](\/blog\/istio-certificates-management\/), I discussed how certificates are managed in Istio. This article will guide you on how to use an external CA by integrating [SPIRE](https:\/\/spiffe.io\/) and [cert-manager](https:\/\/cert-manager.io\/) to achieve fine-grained certificate management and automatic certificate rotation.\n\nIf you are not familiar with what SPIRE is and why we use SPIRE, I recommend you read the following:\n\n- [Why does Istio use SPIRE for authentication?](\/en\/blog\/why-istio-need-spire\/)\n- [How to integrate SPIRE in Istio?](\/en\/blog\/how-to-integrate-spire-with-istio\/)\n\n## Overview of Certificate Issuance and Management Process\n\nThe diagram below shows the certificate trust chain used in this article based on cert-manager and SPIRE:\n\n![Certificate trust chain based on cert-manager and SPIRE](spire-chain-tree.svg)\n\nFrom the diagram, you can see:\n\n- cert-manager acts as the Root CA, issuing certificates to *istiod* and SPIRE. We use a [self-signed Issuer](https:\/\/cert-manager.io\/docs\/configuration\/selfsigned\/), but you can also configure it to use built-in Issuers like Let\u0027s Encrypt, Vault, Venafi, or other external Issuers. Additionally, you can choose other [UpstreamAuthorities](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/) such as Vault or SPIRE federations;\n- SPIRE issues SVID certificates to Istio mesh workloads and Ingress Gateway, Egress Gateway for inter-service mTLS;\n- Certificates used by the mesh-external access to the Ingress Gateway and those used by the Egress Gateway to access external services of the mesh need additional configuration;\n\nThe diagram below shows the certificate issuance and renewal process after integrating SPIRE and cert-manager in Istio.\n\n![Istio integration with SPIRE and cert-manager for certificate issuance and renewal](cert-manager-spire-istio.svg)\n\n1. The SPIRE Controller Manager in the SPIRE Server automatically registers workloads in Kubernetes, generating SPIFFE-standard identities for all workloads;\n2. cert-manager issues and manages CA certificates for *istiod*;\n3. The Envoy proxy in the workload sends a CSR request to the SPIRE Agent on the same node via a UNIX Domain Socket (UDS) through the SDS API;\n4. The SPIRE Agent sends the CSR to the SPIRE Server;\n5. The SPIRE Server returns the signed certificate to the SPIRE Agent;\n6. The SPIRE Agent returns the signed certificate to the workload;\n7. SPIRE manages and updates the certificates for the workloads;\n\nAfter understanding the general process, we will install the components in sequence. Versions of the components are as follows:\n\n- cert-manager v1.15.1\n- SPIRE v1.2.0\n- Istio v1.21.1\n\n## Installing cert-manager\n\nRun the following command to install cert-manager, which we will use to achieve automatic certificate rotation:\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/github.com\/cert-manager\/cert-manager\/releases\/download\/v1.15.1\/cert-manager.yaml\n\u0060\u0060\u0060\n\nThe Root CA uses a self-signed certificate, run the following command to configure the Root CA:\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Issuer\nmetadata:\n  name: selfsigned\n  namespace: cert-manager\nspec:\n  selfSigned: {}\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: selfsigned-ca\n  namespace: cert-manager\nspec:\n  isCA: true\n  duration: 21600h\n  secretName: selfsigned-ca\n  commonName: certmanager-ca\n  subject:\n    organizations:\n      - cert-manager\n  issuerRef:\n    name: selfsigned\n    kind: Issuer\n    group: cert-manager.io\n---\napiVersion: cert-manager.io\/v1\nkind: ClusterIssuer\nmetadata:\n  name: selfsigned-ca\nspec:\n  ca:\n    secretName: selfsigned-ca\nEOF\n\u0060\u0060\u0060\n\nThen configure a certificate for *istiod*:\n\n\u0060\u0060\u0060yaml\nkubectl create namespace istio-system\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 1440h\n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\nNow that we have installed cert-manager and created a \u0060clusterIssuer\u0060 named \u0060selfsigned-ca\u0060, next, we will install SPIRE and set cert-manager as SPIRE’s [\u0060UpstreamAuthority\u0060](https:\/\/github.com\/spiffe\/spire\/blob\/main\/doc\/plugin_server_upstreamauthority_cert_manager.md).\n\n## Installing SPIRE\n\nRun the following command to quickly install SPIRE:\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/jimmysong.io\/blog\/cert-manager-spire-istio\/manifests\/spire-with-cert-manager-upstream-authority-quick-start.yaml\n\u0060\u0060\u0060\n\nThis YAML file includes adaptations for cert-manager compared to the [\u0060samples\/security\/spire\/spire-quickstart.yaml\u0060](https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.22\/samples\/security\/spire\/spire-quickstart.yaml) file in the Istio installation package, such as:\n\n- Adding permissions for the \u0060cert-manager.io\u0060 API group to the \u0060spire-server-cluster-role\u0060 ClusterRole;\n- Adding the \u0060UpstreamAuthority \u0022cert-manager\u0022\u0060 configuration in the SPIRE Server settings;\n\n{{\u003ccallout note \u0022Note\u0022\u003e}}\nThe \u0060trust_domain\u0060 in the SPIRE Server configuration should match the \u0060TRUST_DOMAIN\u0060 environment variable specified when installing Istio.\n{{\u003c\/callout\u003e}}\n\nThis command installs the SPIRE Controller Manager, which automatically registers workloads in Kubernetes. All workloads are registered with SPIFFE standard service identity format \u0060spiffe:\/\/\u003ctrust-domain\u003e\/ns\/\u003cnamespace\u003e\/sa\/\u003cservice-account\u003e\u0060 based on their service accounts.\n\nIf you want to adjust the TTL of SPIRE CA and SVID certificates, you can modify \u0060ca_ttl\u0060 (default 24h) and \u0060default_svid_ttl\u0060 (default 1h) in the SPIRE Server configuration, detailed in [SPIRE Server Configuration](https:\/\/spiffe.io\/docs\/latest\/deploying\/spire_server\/).\n\n## Installing Istio\n\nThe Envoy Agent in Pod shares the Unix Domain Socket of the local SPIRE Agent and call the SPIRE Server through the Workload API to obtain the certificate, as shown in the following figure.\n\n![SPIRE Agent architecture](spire-agent.svg)\n\nRun the following command to install Istio and enable automatic CA certificate rotation:\n\n\u0060\u0060\u0060yaml\nistioctl install --skip-confirmation -f - \u003c\u003cEOF\napiVersion: install.istio.io\/v1alpha1\nkind: IstioOperator\nmetadata:\n  namespace: istio-system\nspec:\n  profile: default\n  meshConfig:\n    # Trust domain should be the same as configured in the SPIRE Server\n    trustDomain: example.org\n  values:\n    global:\n    # Custom sidecar template\n    sidecarInjectorWebhook:\n      templates:\n        spire: |\n          spec:\n            containers:\n            - name: istio-proxy\n              volumeMounts:\n              - name: workload-socket\n                mountPath: \/run\/secrets\/workload-spiffe-uds\n                readOnly: true\n            volumes:\n              - name: workload-socket\n                csi:\n                  driver: \u0022csi.spiffe.io\u0022\n                  readOnly: true\n  components:\n    pilot:\n      k8s:\n        env:\n          # If enabled, if users introduce a new intermediate plugin CA, users do not need to restart istiod to obtain certificates. Istiod will retrieve the newly added intermediate plugin CA\u0027s certificates and update them accordingly. Inserting a new Root-CA is not supported.\n          - name: AUTO_RELOAD_PLUGIN_CERTS\n            value: \u0022true\u0022 \n    ingressGateways:\n      - name: istio-ingressgateway\n        enabled: true\n        label:\n          istio: ingressgateway\n        k8s:\n          overlays:\n            - apiVersion: apps\/v1\n              kind: Deployment\n              name: istio-ingressgateway\n              patches:\n                - path: spec.template.spec.volumes.[name:workload-socket]\n                  value:\n                    name: workload\n\n-socket\n                    csi:\n                      driver: \u0022csi.spiffe.io\u0022\n                      readOnly: true\n                - path: spec.template.spec.containers.[name:istio-proxy].volumeMounts.[name:workload-socket]\n                  value:\n                    name: workload-socket\n                    mountPath: \u0022\/run\/secrets\/workload-spiffe-uds\u0022\n                    readOnly: true\nEOF\n\u0060\u0060\u0060\n\nSince we are using the \u0060spire\u0060 template declared in the Istio Operator to deploy workloads, we run the following command to deploy the Bookinfo application:\n\n\u0060\u0060\u0060bash\nistioctl kube-inject -f bookinfo-with-spire-template.yaml | kubectl apply -n default -f -\n\u0060\u0060\u0060\n\n**Note**: The \u0060bookinfo-with-spire-template.yaml\u0060 file used in the above command can be found [here](.\/manifests\/bookinfo-with-spire-template.yaml), and the only difference from the [\u0060samples\/bookinfo\/platform\/kube\/bookinfo.yaml\u0060](https:\/\/github.com\/istio\/istio\/blob\/master\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml) file in the Istio installation package is that each Deployment\u0027s template has the following annotation added:\n\n\u0060\u0060\u0060yaml\nannotations:\n  inject.istio.io\/templates: \u0022sidecar,spire\u0022\n\u0060\u0060\u0060\n\n## Verifying SPIRE\n\nWe will verify that SPIRE is effective by checking the identity and certificate configuration of the productpage service.\n\nUse the following command to check whether SPIRE has issued identity proofs to the workloads:\n\n\u0060\u0060\u0060bash\nkubectl exec -i -t spire-server-0 -n spire -c spire-server -- \/bin\/sh -c \u0022bin\/spire-server entry show -socketPath \/run\/spire\/sockets\/server.sock -spiffeID spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\u0022\n\u0060\u0060\u0060\n\nYou can see the identity information of the productpage service in the output result:\n\n\u0060\u0060\u0060\nFound 1 entry\nEntry ID         : 69fbf896-a296-4c3c-8179-44bf4e49e474\nSPIFFE ID        : spiffe:\/\/example.org\/ns\/default\/sa\/bookinfo-productpage\nParent ID        : spiffe:\/\/example.org\/k8s-workload-registrar\/demo-cluster\/node\/gke-cluster-1-default-pool-18d66649-z1lm\nRevision         : 1\nTTL              : default\nSelector         : k8s:node-name:gke-cluster-1-default-pool-18d66649-z1lm\nSelector         : k8s:ns:default\nSelector         : k8s:pod-uid:73347537-a3e5-4e43-b8c5-bd315c7385b7\nDNS name         : productpage-v1-7f444fc4dd-rq47m\nDNS name         : productpage.default.svc\n\u0060\u0060\u0060\n\nView the productpage pod\u0027s certificate trust chain:\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\nView the root certificate:\n\n\u0060\u0060\u0060bash\nistioctl -n default proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes\u0027 | base64 --decode \u003e root.pem\n\u0060\u0060\u0060\n\nThe \u0060chain.pem\u0060 file is the certificate trust chain, containing two certificates. Save them to two files:\n\n\u0060\u0060\u0060bash\nsplit -p \u0022-----BEGIN CERTIFICATE-----\u0022 chain.pem cert-\n\u0060\u0060\u0060\n\nThen use OpenSSL to view all certificates:\n\n\u0060\u0060\u0060\nopenssl x509 -noout -text -in cert-aa\nopenssl x509 -noout -text -in cert-ab\nopenssl x509 -noout -text -in root.pem\n\u0060\u0060\u0060\n\nYou will see the following certificate trust chain \u0060root.pem\u0060 -\u003e \u0060cert-aa\u0060  -\u003e \u0060cert-ab\u0060, as shown in the diagram:\n\n![Productpage service\u0027s certificate trust chain](spire-bookinfo-cert-chain.svg)\n\nView the certificate of Istiod:\n\n\u0060\u0060\u0060bash\nistioctl -n istio-system proxy-config secret deployment\/istiod -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\nFrom the certificate trust chain, we can see:\n\n- cert-manager acts as the PKI root node, issuing certificates to *istiod*;\n- SPIRE acts as an intermediate CA, issuing certificates to various workloads;\n- The X509 v3 subject alternative names of workloads in the Istio service mesh follow the SPIFF identity specification;\n- The identity and certificates of all workloads in the Istio service mesh are managed by SPIRE;\n\n## Setting Automatic Certificate Rotation\n\nIf you want to modify the rotation period of *istiod* certificates from 60 days (1440 hours) to 30 days (720 hours), run the following command:\n\n\u0060\u0060\u0060yaml\ncat \u003c\u003c EOF | kubectl apply -f -\n---\napiVersion: cert-manager.io\/v1\nkind: Certificate\nmetadata:\n  name: cacerts\n  namespace: istio-system\nspec:\n  secretName: cacerts\n  duration: 720h \n  renewBefore: 360h\n  commonName: istiod.istio-system.svc\n  isCA: true\n  usages:\n    - digital signature\n    - key encipherment\n    - cert sign\n  dnsNames:\n    - istiod.istio-system.svc\n  issuerRef:\n    name: selfsigned-ca\n    kind: ClusterIssuer\n    group: cert-manager.io\nEOF\n\u0060\u0060\u0060\n\nRun the following command to view the *istiod* logs:\n\n\u0060\u0060\u0060bash\nkubectl logs -l app=istiod -n istio-system -f\n\u0060\u0060\u0060\n\nAfter two minutes, you will see certificate change records similar to the following:\n\n\u0060\u0060\u0060\n2022-12-23T03:48:42.697360Z\tinfo\tUpdate Istiod cacerts\n2022-12-23T03:48:42.697503Z\tinfo\tUsing kubernetes.io\/tls secret type for signing ca files\n2022-12-23T03:48:42.778241Z\tinfo\tIstiod has detected the newly added intermediate CA and updated its key and certs accordingly\n2022-12-23T03:48:42.779459Z\tinfo\tx509 cert - Issuer: \u0022CN=istiod.istio-system.svc\u0022, Subject: \u0022\u0022, SN: d7acac2301045f741e5e30cff380deaf, NotBefore: \u00222022-12-23T03:46:42Z\u0022, NotAfter: \u00222032-12-20T03:48:42Z\u0022\n2022-12-23T03:48:42.779561Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=istiod.istio-system.svc\u0022, SN: 164bf045670a1716ed3f0f1c89b56122, NotBefore: \u00222022-12-23T03:48:14Z\u0022, NotAfter: \u00222023-01-22T03:48:14Z\u0022\n2022-12-23T03:48:42.779642Z\tinfo\tx509 cert - Issuer: \u0022CN=certmanager-ca,O=cert-manager\u0022, Subject: \u0022CN=certmanager-ca,O=cert-manager\u0022, SN: 8533dbfe0b84ed1fc4e3c76be7ef612f, NotBefore: \u00222022-12-20T07:50:12Z\u0022, NotAfter: \u00222025-06-07T07:50:12Z\u0022\n2022-12-23T03:48:42.779657Z\tinfo\tIstiod certificates are reloaded\n\u0060\u0060\u0060\n\nTo modify the automatic rotation period for workload certificates, you can set the environment variable \u0060SECRET_TTL\u0060 of the \u0060pilot-agent\u0060 command, which defaults to \u006024h0m0s\u0060.\n\n## Summary\n\nIn this article, we used *cert-manager* as the PKI, integrated SPIRE into our certificate chain of trust, and created identities and certificates for workloads in the Istio mesh. Using cert-manager means you don’t have to worry about istiod certificate expiration, and you can renew certificates as needed. You can also integrate cert-manager with certificate providers, such as [Let’s Encrypt](https:\/\/letsencrypt.org\/), [HashiCorp Vault](https:\/\/www.vaultproject.io\/), [Venafi](https:\/\/www.venafi.com\/), etc. You can also use [*istio-csr*](https:\/\/github.com\/cert-manager\/istio-csr) to let the *cert-manager* manage certificates in Istio directly. Or [use Vault to store certificates](https:\/\/tetrate.io\/blog\/how-to-use-hashicorp-vault-as-a-more-secure-way-to-store-istio-certificates\/).\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/managing-certificates-in-istio-with-cert-manager-and-spire\/).*', '\/en\/blog\/cert-manager-spire-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article describes how to integrate SPIRE and use cert-manager to achieve fine-grained certificate management and certificate rotation.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/understanding-the-tls-encryption-in-istio/">How Istio’s mTLS Traffic Encryption Works as Part of a Zero Trust Security Posture</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Dec 24, 2022</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How Istio’s mTLS Traffic Encryption Works as Part of a Zero Trust Security Posture', 'This article introduces TLS and mTLS, and describes how to enable mTLS in Istio and its application scenarios.', '\nThe Istio service mesh offers cloud native deployments a standard way to implement automatic [mutual transport layer security (mTLS)](https:\/\/en.wikipedia.org\/wiki\/Mutual_authentication#mTLS). This reduces the attack surface of network communication by using strong identities to establish encrypted channels between workloads within the mesh that are both confidential and tamper-resistant. mTLS is a key component for building zero-trust application networks. To understand mTLS traffic encryption in Istio, this article will cover the following:\n\n- An overview of TLS, mTLS, and TLS termination\n- An introduction to howTLS encryption works in Istio\n- How to use Istio to implement mTLS in Kubernetes\n- A discussion of when you do and don’t need mTLS\n\n## What Is TLS and mTLS?\n\nTLS, the successor to Secure Sockets Layer (SSL), is a widely adopted security protocol used to create authenticated and encrypted connections between networked computers. For this reason, people often use the terms TLS and SSL interchangeably. In this article, we will refer to them collectively as TLS. TLS 1.0 was released in 1999, and the latest version is 1.3 (released in August 2018); versions 1.0 and 1.1 are deprecated.\n\nThe HTTPS we see when browsing the web uses TLS, as shown in Figure 1, which is built on top of TCP as the session layer in the OSI model. To ensure compatibility, TLS usually uses port 443, but you can use any port you want.\n\n![Figure 1: HTTP vs. HTTPS](http-vs-https.svg)\n\nTLS encryption is required when a client needs to confirm the identity of the server in order to guard against man-in-the-middle attacks and ensure communication security. Figure 2 shows how TLS-encrypted communication proceeds.\n\n![Figure 2: simplified TLS handshake flow](tls-flow.svg)\n\n1. The server applies for and obtains a certificate (X.509 certificate) from a trusted [certificate authority](https:\/\/en.wikipedia.org\/wiki\/Certificate_authority) (CA).\n2. A request from the client to the server containing information such as the TLS version and password combination supported by the client.\n3. The server responds to the client request and attaches a digital certificate.\n4. The client verifies the status, validity, and digital signature of the certificate and confirms the identity of the server.\n5. Encrypted communication commences between the client and the server using a shared private key.\n\nThe above is only an outline description of the TLS communication flow. If you’re interested in the details, please see [this in-depth discussion of the complete TLS handshake process.](https:\/\/www.cloudflare.com\/learning\/ssl\/what-happens-in-a-tls-handshake\/)\n\nFrom the above process, you will find that the certificate is the critical element representing the server’s identity. The server must use a certificate issued by an authoritatively certified CA in order to provide public services over the Internet. In contrast, you can manage certificates using your own public key infrastructure (PKI) for services inside of a private environment.\n\nMutual TLS, also referred to as mTLS, is the use of a two-way encrypted channel between a server and a client that necessitates certificate exchange and identity authentication between the parties.\n\n## What Is TLS Termination?\n\nTLS termination is the process of decrypting TLS-encrypted traffic before it is forwarded to a web server. Offloading TLS traffic to an ingress gateway or specialized device improves web application performance while securing encrypted traffic. TLS termination is typically implemented at cluster ingress. All communication between the ingress and servers in the cluster will be conducted directly over HTTP in plaintext, enhancing service performance.\n\n![Figure 3: TLS termination](tls-termination.svg)\n\nBy default, Istio enables mTLS for mesh-based services and ends TLS at the ingress gateway. Furthermore, you can pass through traffic to back-end services for processing.\n\n\u0060\u0060\u0060yaml\napiVersion: networking.istio.io\/v1beta1\nkind: Gateway\nmetadata:\n  name: sample-gateway\nspec:\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: PASSTHROUGH\n\u0060\u0060\u0060\n\nSee [Gateway TLS Configuration](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/traffic-management\/tls-configuration\/#gateways) for details.\n\n## How to Implement Automatic mTLS in Istio\n\nFigure 4 depicts the security architecture of Istio. This figure clearly shows that at the entry point, JSON Web Token (JWT) \u002b TLS authentication and encryption are used, and that mTLS is enabled between all services within the Istio mesh.\n\n![Istio 安全架构图](istio-security.svg)\n\nIstio includes a built-in CA, and [Secret Discovery Service (SDS)](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/security\/secret)—one of the discovery services in Envoy [xDS](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-docs\/xds_protocol)—enables the issuance and rotation of SVID certificates. The mTLS flow in the Istio mesh is as follows:\n\n1. The sidecar of every service requests a certificate from Istiod on behalf of the workload at startup, and Istiod issues the [SVID](https:\/\/spiffe.io\/docs\/latest\/spiffe-about\/spiffe-concepts\/#spiffe-verifiable-identity-document-svid) certificate (the process is more complex, and I will explain it in a future blog).\n2. The sidecar of every workload intercepts all client requests within the pod.\n3. The client sidecar starts an mTLS handshake with the server sidecar. During the handshake, the [JWT](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/security\/jwt_authn_filter) and [authentication filter](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/security\/ext_authz_filter) in the client sidecar will authenticate the identity of the request, and store the identity in the filter metadata after the authentication. Then the request will go through the authorization filter to determine if the request is allowed.\n4. If the request is authenticated and authorized, the client and the server start to establish a connection for communication.\n\nIn Istio, authentication and authorization between services can be configured using one of three resource objects:\n\n- **[RequestAuthentication](https:\/\/istio.io\/latest\/docs\/reference\/config\/security\/request_authentication\/):** To specify the service’s only currently supported request-level authentication method, JWT.\n- **[PeerAuthentication](https:\/\/istio.io\/latest\/docs\/reference\/config\/security\/peer_authentication\/):** To enable mTLS or plaintext requests, set the transport authentication mode.\n- **[AuthorizationPolicy](https:\/\/istio.io\/latest\/docs\/reference\/config\/security\/authorization-policy\/):** To specify who can do what when traffic between services is authorized? For instance, subject A either permits (ALLOW) or forbids (DENY) traffic from subject B.\n\n## How to Enable Automatic mTLS in Istio\n\nIn PeerAuthentication, you can specify the mTLS mode that will be used for the target workload. Peer authentication is supported in the following modes:\n\n- PERMISSIVE: The workload’s default setting that allows it to accept either mTLS or plain text traffic.\n- STRICT: The workload accepts only mTLS traffic.\n- DISABLE: Disable mTLS. From a security perspective, mTLS should not be disabled unless you have your own security solution.\n- UNSET: Inherited from the parent, with the following priority: service specific \u003e namespace scope \u003e mesh scope setting.\n\nIstio’s peer authentication uses *PERMISSIVE* mode by default, automatically sending *mTLS* traffic to these workloads and clear text traffic to workloads without a sidecar. After including Kubernetes services in the Istio mesh, we can use *PERMISSIVE* mode first to prevent services from failing *mTLS*. We can use one of two ways to enable strict mTLS mode for certain services:\n\n- Use PeerAuthentication to define how traffic is transferred between sidecars.\n- Use DestinationRule to define the TLS settings in the traffic routing policy.\n\nThe reviews service’s mTLS configuration in the default namespace can be seen in the example below.\n\n### Use PeerAuthentication to Set mTLS for Workloads\n\nFor instance, the following configuration can be used to specify that a workload under a namespace has strict mTLS enabled.\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: foo-peer-policy\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      app: reviews\n  mtls:\n    mode: STRICT\n\u0060\u0060\u0060\n\nAccording to the [Istio documentation](https:\/\/istio.io\/latest\/docs\/tasks\/security\/authentication\/mtls-migration\/), you can also enable strict mTLS for all services in the mesh by configuring strict mTLS for the namespace istio-system where Istio is installed.\n\n### Use DestinationRule to Set up mTLS for Workloads\n\nTraffic routing policies, such as load balancing, anomaly detection, TLS settings, etc., are set using DestinationRule. In the TLS settings, there are various modes. As shown below, use ISTIO_MUTUAL mode to enable Istio’s workload-based automatic TLS.\n\n\u0060\u0060\u0060yaml\napiVersion: networking.istio.io\/v1beta1\nkind: DestinationRule\nmetadata:\n  name: reviews\n  namespace: default\nspec:\n  host: reviews\n  trafficPolicy:\n    tls:\n      mode: ISTIO_MUTUAL\n\u0060\u0060\u0060\n\n## When Should You Use mTLS?\n\nThe short answer is that you should use mTLS for network communication between application components that you have some control over—like between microservices in a cluster.\n\nOne-way TLS is typically used by Internet clients to connect to Web services, which means that only the server needs to show identification and is unconcerned with the identity of the client. One-way TLS allows you to use passwords, tokens, two-factor authentication, and other methods when you need to confirm the identity of the client. However, when using a service mesh, mTLS operates outside the application and doesn’t require many changes to the application logic, whereas such an authentication method requires internal application support.\n\nAs you can see from the example above, mTLS implementation calls for certificate exchange between services. As the number of services rises, managing numerous certificates becomes a laborious task. You can implement automatic mTLS and fix the certificate management issue with the aid of a service mesh.\n\n## When Shouldn’t You Use mTLS?\n\nAlthough mTLS is the preferred protocol for securing inter-service communication in cloud-native applications, implementing mTLS necessitates a more complex, symmetric encryption and decryption process than one-way TLS. In some cases where there is high traffic volume or CPU utilization must be optimized, terminatingTLS at the traffic entry point and turning on mTLS internally for specific services only can help minimize request response times and decrease compute resource consumption for some traffic with lower security levels.\n\nAdditionally, it is necessary to [disable probe rewriting for pods](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/mesh\/app-health-check\/#disable-the-http-probe-rewrite-for-a-pod) when using services that cannot obtain certificates, such as health checks performed via HTTP on Kubelet and the inability to access the service’s health check endpoint via TLS.\n\nFinally, when mesh services access some external services, mTLS is also not necessary.\n\n## Summary\n\nmTLS is a crucial component of creating a zero-trust application network, which makes it possible to encrypt traffic within the mesh. Istio makes it simple to enable automatic mTLS for Kubernetes services, doing away with the need to manage certificates. At the same time, we can selectively enable mTLS for a subset of the mesh’s services, enabling us to move services from Kubernetes to the mesh. In a subsequent blog, we’ll go into more detail about Istio’s certificate management system. Stay tuned.\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid). TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb), or [contact us for a quick demo](https:\/\/tetr8.io\/contact).\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/how-istios-mtls-traffic-encryption-works-as-part-of-a-zero-trust-security-posture\/).*\n', '\/en\/blog\/understanding-the-tls-encryption-in-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces TLS and mTLS, and describes how to enable mTLS in Istio and its application scenarios.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/en/blog/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/en/blog/page/4/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/en/blog/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/en/blog/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/en/blog/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/en/blog/page/6/" class="page-link">
             6
           </a>
         </li>
       
     
       
       
       
         
         
         
           
             
           
         
       
       
       
       
         <li class="page-item">
           <a href="/en/blog/page/7/" class="page-link">
             7
           </a>
         </li>
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
       
       
       
         
         
         
           
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/en/blog/page/6/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/en/blog/page/9/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Columns
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(50)</span>
        </a>
      
        <a href="/en/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(12)</span>
        </a>
      
        <a href="/en/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/cloud-native" class="sidebar-item">
            <span>Cloud Native</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/essays" class="sidebar-item">
            <span>Essays</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/open-source" class="sidebar-item">
            <span>Open Source</span>
            <span>(2)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Book
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/translation" class="sidebar-item">
            <span>Translation</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/original" class="sidebar-item">
            <span>Original</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">Contact</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s LinkedIn</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-linkedin.png" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Blog</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/istio-ambient-inpod-iptables/">In-Pod IPtables Rule Injection in Istio Ambient Mode Explained</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/istio-ambient-traffic-interception/">Detailed Explanation of Transparent Traffic Interception in Istio ambient mode</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/migrate-to-istio-telemetry-api/">Migrating from MeshConfig to Istio Telemetry API: Enhancing Observability and Flexibility in the Mesh</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">links</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" >
                  Awesome Cloud Native
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://gateway.envoyproxy.io" target="_blank" rel="noopener noreferrer">
                  Envoy Gateway
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io" target="_blank" rel="noopener noreferrer">
                  Istio
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate - Service Mesh Company
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://docs.tetrate.io/istio-subscription/" target="_blank" rel="noopener noreferrer">
                  Tetrate Istio Subscription
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Courses</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener noreferrer">
                  Envoy Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener noreferrer">
                  Istio Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">new notice</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-china-2024-panel/">KubeCon China 2024 panel Preview: Istio and Modern API Gateways – Leading the Future of Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/website-revamp-notice/">Website Revamp Notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-eu-2024/">See you in KubeCon Paris!</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2025 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>






  





<script src="/js/wowchemy-search.min.ce03c611044441cf6e84f9e4bef20818.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
