<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Understanding How Envoy Sidecar Intercept and Route Traffic in Istio Service Mesh · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Details about Envoy sidecar with iptables rules.">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.105.0">

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  
  <link rel="stylesheet" href="/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/plugins/hightlight/syntax.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/tocbot/tocbot.css">
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.css" media="screen">

  <!--Favicon-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="57x57" href="images/favicon-57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="images/favicon-72.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="images/favicon-114.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="images/favicon-144.png" />

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/blog/understanding-how-envoy-sidecar-intercept-and-route-traffic-in-istio-service-mesh/" />
  <meta property="og:title" content="Understanding How Envoy Sidecar Intercept and Route Traffic in Istio Service Mesh" />
  <meta property="twitter:title" content="Understanding How Envoy Sidecar Intercept and Route Traffic in Istio Service Mesh" />
  
  <meta property="og:description" content="Details about Envoy sidecar with iptables rules." />
  <meta property="twitter:description" content="Details about Envoy sidecar with iptables rules." />
  
  
  <meta property="og:image" content="https://jimmysong.io/images/banner/istio-logo.webp" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/istio-logo.webp" />
  
  
  
</head>
<body>
    <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>

<header class="fixed-top header">
  
  
  <div class="top-header py-2 bg-white">
    <div class="container">
      <div class="row no-gutters align-items-center">
        <div class="col-12 text-center">
          <ul class="list-inline">
            <li class="list-inline-item">
                <a href="https://bit.ly/3Vqrlfw" title="Download the eBook: The Current State and Future of the Istio Service Mesh" target="_blank" rel="noopener">Download the eBook: The Current State and Future of the Istio Service Mesh</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="navigation w-100  top-hider ">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en"><img class="img-fluid" width="200px"
            src="/images/logo.svg" alt="Jimmy Song&#39;s blog"></a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://lib.jimmysong.io" target="_blank" rel="noopener">Book</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            

          
          
          
          <!-- search -->
          <button id="searchOpen" class="search-btn js-search"><i class="fa fa-search text-dark"></i></button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


    <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>Search</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fa fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        <i class="fa fa-search" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Input the keyword">
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>

    
	
	
<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/page-title.webp'),url('/images/backgrounds/page-title.webp');">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <ul class="list-inline custom-breadcrumb">
                    <li class="list-inline-item h2"><a class="text-white font-secondary" href="/en/blog">
            
            
              
              Blogs
              
            
          </a></li>
                    <li class="list-inline-item"><i class="ti-angle-right text-white"></i></li>
                    <li class="list-inline-item text-white h3 font-secondary">Understanding How Envoy Sidecar Intercept and Route Traffic in Istio Service Mesh</li>
                </ul>
                <p class="text-white">Details about Envoy sidecar with iptables rules.</p>
            </div>
        </div>
    </div>
</section>

	


<section class="section-sm">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8 article-content">
        <div class="row">
          <div class="col-12">
            <ul class="list-inline">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Date
                  :</span>December 27, 2018</li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Category
                  :</span><a
                  href="/en/categories/service-mesh"> 
                  Service Mesh</a> </li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Word Count
                  :</span>1845 words</li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Reading Time
                  :</span>8 Minute</li>
            </ul>
          </div>
          
          <div class="col-12 my-4">
            <div class="border-bottom"></div>
          </div>
          
          <div class="col-12 content">
            
            <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">Click to show the outline</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview-of-sidecar-injection-and-traffic-interception-steps">Overview of Sidecar Injection and Traffic Interception Steps</a></li>
    <li><a href="#how-envoy-handles-route-forwarding">How Envoy handles route forwarding</a></li>
    <li><a href="#understanding-the-inbound-handler">Understanding the Inbound Handler</a></li>
    <li><a href="#understanding-the-outbound-handler">Understanding the Outbound Handler</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</details>

            
            <p>Updated at Mar 8, 2022</p>
<p>This article uses Istio&rsquo;s official <a href="https://istio.io/latest/docs/examples/bookinfo/" title="bookinfo sample" target="_blank" rel="noopener">bookinfo sample</a>
 to explain how Envoy performs routing forwarding after the traffic entering the Pod and forwarded to Envoy sidecar by iptables, detailing the inbound and outbound processing. For a detailed analysis of traffic interception, see <a href="https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/" title="Understanding Envoy Sidecar Proxy Injection and Traffic Interception in Istio Service Mesh" target="_blank" rel="noopener">Understanding Envoy Sidecar Proxy Injection and Traffic Interception in Istio Service Mesh</a>
.</p>
<h2 id="overview-of-sidecar-injection-and-traffic-interception-steps">Overview of Sidecar Injection and Traffic Interception Steps</h2>
<p>Below is an overview of the steps from Sidecar injection, Pod startup to Sidecar proxy interception traffic and Envoy processing routing.</p>
<ol>
<li>Kubernetes automatically injected through Admission Controller, or the user run <code>istioctl</code> command to manually inject sidecar container.</li>
<li>Apply the YAML configuration deployment application. At this time, the service creation configuration file received by the Kubernetes API server already includes the Init container and the sidecar proxy.</li>
<li>Before the sidecar proxy container and application container are started, the Init container started firstly. The Init container is used to set iptables (the default traffic interception method in Istio, and can also use BPF, IPVS, etc.) to Intercept traffic entering the pod to Envoy sidecar Proxy. All TCP traffic (Envoy currently only supports TCP traffic) will be Intercepted by sidecar, and traffic from other protocols will be requested as originally.</li>
<li>Launch the Envoy sidecar proxy and application container in the Pod.</li>
</ol>
<div class="alert">

<div class="alert-note py-1 px-2">
  <p><strong>Sidecar proxy and application container startup order issues</strong></p>
<p>Start the sidecar proxy and the application container. Which container is started first? Normally, Envoy Sidecar and the application container are all started up before receiving traffic requests. But we can&rsquo;t predict which container will start first, so does the container startup order have an impact on Envoy hijacking traffic? The answer is yes, but it is divided into the following two situations.</p>
<p><strong>Case 1: The application container starts first, and the sidecar proxy is still not ready</strong></p>
<p>In this case, the traffic is transferred to the 15001 port by iptables, and the port is not monitored in the Pod. The TCP link cannot be established and the request fails.</p>
<p><strong>Case 2: Sidecar starts first, the request arrives and the application is still not ready</strong></p>
<p>In this case, the request will certainly fail. As for the step at which the failure begins, the reader is left to think.</p>
<p><strong>Question</strong> : If adding a readiness and living probe for the sidecar proxy and application container can solve the problem?</p>

</div>
</div>

<ol start="5">
<li>TCP requests that are sent or received from the Pod will be hijacked by iptables. After the inbound traffic is hijacked, it is processed by the Inbound Handler and then forwarded to the application container for processing. The outbound traffic is hijacked by iptables and then forwarded to the Outbound Handler for processing. Upstream and Endpoint.</li>
<li>Sidecar proxy requests Pilot to use the xDS protocol to synchronize Envoy configurations, including LDS, EDS, CDS, etc., but to ensure the order of updates, Envoy will use ADS to request configuration updates from Pilot directly.</li>
</ol>
<h2 id="how-envoy-handles-route-forwarding">How Envoy handles route forwarding</h2>
<p>The following figure shows a <code>productpage</code>service access request <code>http://reviews.default.svc.cluster.local:9080/</code>, when traffic enters <code>reviews</code> the internal services, <code>reviews</code> internal services Envoy Sidecar is how to do traffic blocked the route forward.</p>
<p><figure class="mx-auto text-center">
  
  
  
  
    
    <img src="/en/blog/understanding-how-envoy-sidecar-intercept-and-route-traffic-in-istio-service-mesh/sidecar-iptables.webp" data-img="/en/blog/understanding-how-envoy-sidecar-intercept-and-route-traffic-in-istio-service-mesh/sidecar-iptables.webp" data-width="2968" data-height="1872" alt="image" data-caption="Istio transparent traffic hijacking and traffic routing schematic">
    
  
  <figcaption>Istio transparent traffic hijacking and traffic routing schematic</figcaption>
</figure>
</p>
<p>Before the first step, <code>productpage</code> Envoy Sidecar Pod has been selected by EDS of a request to <code>reviews</code> a Pod service of its IP address, it sends a TCP connection request.</p>
<p>The Envoy configuration in the official website of Istio is to describe the process of Envoy doing traffic forwarding. The party considering the traffic of the downstream is to receive the request sent by the downstream. You need to request additional services, such as <code>reviews</code> service requests need Pod <code>ratings</code> service.</p>
<p><code>reviews</code>, there are three versions of the service, there is one instance of each version, three versions sidecar similar working steps, only to later <code>reviews-v1-cb8655c75-b97zc</code> Sidecar flow Pod forwarding this step will be described.</p>
<h2 id="understanding-the-inbound-handler">Understanding the Inbound Handler</h2>
<p>The role of the inbound handler is to transfer the traffic from the downstream intercepted by iptables to localhost to establish a connection with the application container inside the Pod.</p>
<p>Look <code>reviews-v1-cb8655c75-b97zc</code> at the Listener in the pod.</p>
<p>Run <code>istioctl pc listener reviews-v1-cb8655c75-b97zc</code> to see what the Pod has a Listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">ADDRESS            PORT      TYPE </span>
</span></span><span class="line"><span class="cl"><span class="na">172.33.3.3         9080      HTTP &lt;---  Receives all inbound traffic on 9080 from listener 0.0.0.0_15006</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.0.1         443       TCP  &lt;--+</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.4.253       80        TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.4.253       8080      TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.109.182     443       TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.22.50       15011     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.22.50       853       TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.79.114      443       TCP     | </span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.143.179     15011     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.0.2         53        TCP     | Receives outbound non-HTTP traffic for relevant IP:PORT pair from listener 0.0.0.0_15001</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.22.50       443       TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.16.64       42422     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.127.202     16686     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.22.50       31400     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.22.50       8060      TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.169.13      14267     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.169.13      14268     TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.32.134      8443      TCP     |</span>
</span></span><span class="line"><span class="cl"><span class="na">10.254.118.196     443       TCP  &lt;--+</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            15004     HTTP &lt;--+</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            8080      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            15010     HTTP    | </span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            8088      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            15031     HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            9090      HTTP    | </span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            9411      HTTP    |  Receives outbound HTTP traffic for relevant port from listener 0.0.0.0_15001</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            80        HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            15030     HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            9080      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            9093      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            3000      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            8060      HTTP    |</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            9091      HTTP &lt;--+    </span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0            15006     TCP  &lt;--- Receives all inbound and outbound traffic to the pod from IP tables and hands over to virtual listener</span>
</span></span></code></pre></div><p>As from <code>productpage</code> traffic arriving <code>reviews</code> Pods, downstream must clearly know the IP address of the Pod which is <code>172.33.3.3</code>, so the request is <code>172.33.3.3:9080</code>.</p>
<p><strong>Virtual Listener</strong></p>
<p>As you can see from the Pod&rsquo;s Listener list, the 0.0.0.0:15001/TCP Listener (the actual name is <code>virtual</code>) listens for all inbound traffic, and the following is the detailed configuration of the Listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;virtual&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">15006</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;filterChains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.tcp_proxy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;useOriginalDst&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>UseOriginalDst</strong> : As can be seen from the configuration in <code>useOriginalDst</code>the configuration as specified <code>true</code>, which is a Boolean value, the default is false, using iptables redirect connections, the proxy may receive port <a href="http://www.servicemesher.com/envoy/configuration/listener_filters/original_dst_filter.html" title="original destination address" target="_blank" rel="noopener">original destination address</a>
 is not the same port, thus received at the proxy port It is 15001 and the original destination port is 9080. When this flag is set to true, the Listener redirects the connection to the Listener associated with the original destination address, here <code>172.33.3.3:9080</code>. Listener If no relationship to the original destination address, the connection processing by the Listener to receive it, i.e. the <code>virtual</code>Listener, after <code>envoy.tcp_proxy</code>forwarded to a filter process <code>BlackHoleCluster</code>, as the name implies, when no matching Envoy virtual listener when the effect of Cluster , will send the request to it and return 404. This will be referred to below Listener provided <code>bindToPort</code> echoes.</p>
<p><strong>Note</strong> : This parameter will be discarded, please use the Listener filter of the <a href="http://www.servicemesher.com/envoy/configuration/listener_filters/original_dst_filter.html" title="original destination address" target="_blank" rel="noopener">original destination address</a>
 instead. The main purpose of this parameter is: Envoy listens to the 15201 port to intercept the traffic intercepted by iptables via other Listeners instead of directly forwarding it. See the <a href="https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/#virtual-listener" title="Virtual Listener" target="_blank" rel="noopener">Virtual Listener</a>
 for details .</p>
<p><strong>Listener 172.33.3.3_9080</strong></p>
<p>As mentioned above, the traffic entering the inbound handler is <code>virtual</code> transferred to the <code>172.33.3.3_9080</code> Listener by the Listener. We are looking at the Listener configuration.</p>
<p>Run <code>istioctl pc listener reviews-v1-cb8655c75-b97zc --address 172.33.3.3 --port 9080 -o json</code> view.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;172.33.3.3_9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;172.33.3.3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">9080</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;filterChains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filterChainMatch&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;transportProtocol&#34;</span><span class="p">:</span> <span class="s2">&#34;raw_buffer&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.http_connection_manager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="err">...</span> 
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;route_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;validate_clusters&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;virtual_hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                        <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">],</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|http|9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="err">...</span>
</span></span><span class="line"><span class="cl">                                            <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;max_grpc_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">]</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;use_remote_address&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="err">...</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span><span class="err">，</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;deprecatedV1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;bindToPort&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="err">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filterChainMatch&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;transportProtocol&#34;</span><span class="p">:</span> <span class="s2">&#34;tls&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tlsContext&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span><span class="err">...</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="err">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}]</span>
</span></span></code></pre></div><p><strong>bindToPort</strong> : Note that there are a <a href="https://www.envoyproxy.io/docs/envoy/v1.6.0/api-v1/listeners/listeners" title="&lt;code&gt;bindToPort&lt;/code&gt;" target="_blank" rel="noopener"><code>bindToPort</code></a>
 configuration that is <code>false</code>, the default value of the configuration <code>true</code>, showing Listener bind to the port, set here to <code>false</code> the process flow can Listener Listener transferred from the other, i.e., above said <code>virtual</code> Listener, where we see filterChains.filters in the <code>envoy.http_connection_manager</code> configuration section:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;route_config&#34;</span><span class="err">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;validate_clusters&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;virtual_hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                        <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">],</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|http|9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="err">...</span>
</span></span><span class="line"><span class="cl">                                            <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;max_grpc_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">]</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span></code></pre></div><p>This configuration indicates that traffic will be handed off to the Cluster for <code>inbound|9080||reviews.default.svc.cluster.local</code> processing.</p>
<p><strong>Cluster <code>inbound|9080||reviews.default.svc.cluster.local</code></strong></p>
<p>Run <code>istioctl pc cluster reviews-v1-cb8655c75-b97zc --fqdn reviews.default.svc.cluster.local --direction inbound -o json</code> to see the Cluster configuration is as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;connectTimeout&#34;</span><span class="p">:</span> <span class="s2">&#34;1.000s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">9080</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;circuitBreakers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;thresholds&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>You can see that the Endpoint of the Cluster directly corresponds to localhost, and then the traffic is forwarded by the application container after iptables.</p>
<h2 id="understanding-the-outbound-handler">Understanding the Outbound Handler</h2>
<p>Because the <code>reviews</code> will to <code>ratings</code> send an HTTP request service, request address are: <code>http://ratings.default.svc.cluster.local:9080/</code> the role of Outbound handler is to intercept traffic to iptables to native applications sent via Envoy to determine how to route to the upstream.</p>
<p>The request sent by the application container is outbound traffic. After being hijacked by iptables, it is transferred to the Envoy Outbound handler for processing, then passed through <code>virtual</code> Listener and <code>0.0.0.0_9080</code> Listener, and then finds the cluster of upstream through Route 9080, and then finds Endpoint through EDS to perform routing action.</p>
<p><strong>Route 9080</strong></p>
<p><code>reviews</code> requests <code>ratings</code> service, run <code>istioctl proxy-config routes reviews-v1-cb8655c75-b97zc --name 9080 -o json</code> view route configuration because Envoy VirtualHost will be matched according to HTTP header of domains, so the following list only <code>ratings.default.svc.cluster.local:9080</code> this one VirtualHost.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc.cluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc.cluster:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default.svc:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ratings.default:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;10.254.234.130&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;10.254.234.130:9080&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;maxGrpcTimeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0.000s&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;decorator&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;perFilterConfig&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="err">..</span><span class="p">]</span>
</span></span></code></pre></div><p>You can see the routing of traffic to the Cluster from this Virtual Host configuration <code>outbound|9080||ratings.default.svc.cluster.local</code>.</p>
<p><strong>Endpoint <code>outbound|9080||ratings.default.svc.cluster.local</code></strong></p>
<p>Istio 1.1 previous versions do not support the use of <code>istioctl</code> commands to directly query Endpoint Cluster, you can use the debug queries Pilot endpoint way compromise.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> reviews-v1-cb8655c75-b97zc -c istio-proxy curl http://istio-pilot.istio-system.svc.cluster.local:9093/debug/edsz &gt; endpoints.json
</span></span></code></pre></div><p><code>endpoints.json</code> file contains all the Endpoint information of the Cluster, and we only select <code>outbound|9080||ratings.default.svc.cluster.local</code> the results of the Cluster as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;clusterName&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;locality&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;lbEndpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;172.33.100.2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">9080</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filterMetadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;istio&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nt">&#34;uid&#34;</span><span class="p">:</span> <span class="s2">&#34;kubernetes://ratings-v1-8558d4458d-ns6lk.default&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The Endpoint can be one or more, and Envoy will route it according to certain rules by selecting the appropriate Endpoint.</p>
<p><strong>Note</strong> : Istio 1.1 will support the <code>istioctl pc endpoint</code> command to query Endpoint.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://istio.io/latest/docs/ops/diagnostic-tools/proxy-cmd/" title="Debugging Envoy and Pilot - istio.io" target="_blank" rel="noopener">Debugging Envoy and Pilot - istio.io</a>
</li>
<li><a href="https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/" title="Understanding Envoy Agent Sidecar Injection and Traffic Interception in Istio Service Mesh - jimmysong.io" target="_blank" rel="noopener">Understanding Envoy Agent Sidecar Injection and Traffic Interception in Istio Service Mesh - jimmysong.io</a>
</li>
<li><a href="https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/" title="Istio traffic management implementation mechanism deep analysis - zhaohuabing.com" target="_blank" rel="noopener">Istio traffic management implementation mechanism deep analysis - zhaohuabing.com</a>
</li>
</ul>

          </div>

          <div class="col-12 mb-4">
            <div class="border-bottom">
            


<p class="edit-page">
<a href="https://github.com/rootsongjc/website/edit/master/content/en/blog/understanding-how-envoy-sidecar-intercept-and-route-traffic-in-istio-service-mesh/index.md">
  <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit this page
  </a>
</p>


            </div>
          </div>
          
          <div class="col-12">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light">
              
              <a href="/en/tags/envoy" class="badge"> 
                  Envoy</a> 
              <a href="/en/tags/istio" class="badge">  
                  Istio</a> </li>
          </div>

          
          
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://jimmysong.io/en/blog/cloud-native-and-me-the-past-current-and-future/" data-toggle="tooltip" data-placement="top" title="Cloud Native and me - the past, current and future">&larr; Previous Post</a>
</li>
 
<li class="next">
<a href="https://jimmysong.io/en/blog/cloud-native-sandbox/" data-toggle="tooltip" data-placement="top" title="Cloud Native Sandbox">Next Post &rarr;</a>
</li>

</ul>
</div>


          
          
          <div class="col-12">
          
           <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="en"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

          
          </div>
        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 sidebar">
      <!-- recommend -->
      


      <!-- /recommend -->
      <!-- toc -->
      
<div class="bg-white py-4 box-shadow mb-4 sticky-top aside-toc d-none d-sm-block">
    <p class="sidebar-title">
    Table of content
    </p>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview-of-sidecar-injection-and-traffic-interception-steps">Overview of Sidecar Injection and Traffic Interception Steps</a></li>
    <li><a href="#how-envoy-handles-route-forwarding">How Envoy handles route forwarding</a></li>
    <li><a href="#understanding-the-inbound-handler">Understanding the Inbound Handler</a></li>
    <li><a href="#understanding-the-outbound-handler">Understanding the Outbound Handler</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
</div>

      <!-- /toc -->
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>



      
    

<footer>
  
  <div class="footer bg-footer section-sm border-bottom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-sm-8 mb-5 mb-lg-0">
          
          <h4 class="text-white mb-5 text-uppercase">Follow Me</h4>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Fellow me on twitter</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-twitter-qr-code.webp" width="128px" alt="footer image"></li>
            
            
            
          
        </div>
        
        

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">Blog</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/why-istio-need-spire/">Why would you need SPIRE for authentication with Istio?</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/istio-service-mesh-book/">In-Depth Understanding of Istio: Announcing the Publication of a New Istio Book</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/how-to-build-istio/">How to build Istio?</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">links</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener">Awesome Cloud Native</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener">Cloud Native Community(China)</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener">Tetrate - Service Mesh Company</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://istio.tetratelabs.io/" target="_blank" rel="noopener">Tetrate Istio Distro</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">Courses</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener">Istio Fundamentals</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://lib.jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener">Kubernetes Handbook</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">new notice</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/cloud-native-public-library/">Cloud Native library launch</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/tetrate-recruit/">The Enterprise Service Mesh company Tetrate is hiring</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/tetrate-istio-fundamental-courses/">Tetrate Academy Releases Free Istio Fundamentals Course</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer">
    <div class="container">
      <div class="row">
        <div class="col-sm-9 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2022 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-3 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-twitter "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" rel="noopener"><i class="fa fa-github "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-linkedin "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="mailto:jimmysong@jimmysong.io" target="_blank" rel="noopener"><i class="fa fa-envelope "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="/blog/index.xml" target="_blank" rel="noopener"><i class="fa fa-rss "></i></a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-1', 'auto');
  ga('send', 'pageview');
</script>



<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script>
    anchors.add()
</script>




<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, 'Copied')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>




<script>
tocbot.init({
  
  tocSelector: '.aside-toc #TableOfContents',
  
  contentSelector: '.content',
  
  headingSelector: 'h1, h2, h3, h4',
  
  hasInnerContainers: false,
  collapseDepth: 3
});
</script>












<script src="/js/wowchemy-search.min.0b3293fc75f976f49fb5a3d247c91f2e.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content">
      <div class="search-hit-name">
        <div class="article-metadata search-hit-type">{{relpermalink}}</div>
        <a href="{{relpermalink}}">{{title}}</a>
        <p class="search-hit-description">{{snippet}}</p>
      </div>
    </div>
  </div>
</script>


</body>

</html>
