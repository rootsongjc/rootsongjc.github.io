<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Maintaining Traffic Transparency: Preserving Client Source IP in Istio · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/blog/preserve-source-ip-in-istio/" />
  <meta property="og:title" content="Maintaining Traffic Transparency: Preserving Client Source IP in Istio | Jimmy Song" />
  <meta property="twitter:title" content="Maintaining Traffic Transparency: Preserving Client Source IP in Istio | Jimmy Song" />

  
  <meta property="og:description" content="This article focuses on how to maintain transparency of the client source IP in the Istio service mesh." />
  <meta property="twitter:description" content="This article focuses on how to maintain transparency of the client source IP in the Istio service mesh." />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/ip-trans.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/ip-trans.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/book">Book</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    
                  
                
              
              
              
                
                  
                    
                    <a class="nav-link" href="/blog/preserve-source-ip-in-istio/">中文</a>
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>Search</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>Search</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="Close"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="Input the keyword">
        
        <div class="mt-4">
          <span>Search type: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">All</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">Blog</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">Book</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">Notice</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Maintaining Traffic Transparency: Preserving Client Source IP in Istio
                </p>
                <p class="page-description">
                    This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>Feb 28, 2024</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/en/categories/istio"> 
                        Istio</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>13 Minute</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>2792 words</li>
                    
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">
            
            <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>Click to show the outline</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#the-importance-of-preserving-source-ip">The Importance of Preserving Source IP</a></li>
    <li><a href="#meaning-of-preserving-source-ip">Meaning of Preserving Source IP</a></li>
    <li><a href="#how-to-confirm-client-source-ip">How to Confirm Client Source IP?</a></li>
    <li><a href="#testing-environment">Testing Environment</a></li>
    <li><a href="#deploying-test-example">Deploying Test Example</a>
      <ul>
        <li><a href="#resource-ip">Resource IP</a></li>
      </ul>
    </li>
    <li><a href="#north-south-traffic">North-South Traffic</a>
      <ul>
        <li><a href="#test-1-cluster-traffic-policy-iptables-traffic-hijacking">Test 1: Cluster Traffic Policy, iptables Traffic Hijacking</a></li>
        <li><a href="#how-is-the-source-ip-lost">How is the Source IP Lost?</a></li>
        <li><a href="#how-to-preserve-the-client-source-ip">How to Preserve the Client Source IP</a></li>
        <li><a href="#test-2-local-traffic-policy-iptables-traffic-hijacking">Test 2: Local Traffic Policy, iptables Traffic Hijacking</a></li>
      </ul>
    </li>
    <li><a href="#east-west-traffic">East-West Traffic</a>
      <ul>
        <li><a href="#test-3-local-traffic-policy-tproxy-traffic-hijacking">Test 3: Local Traffic Policy, tproxy Traffic Hijacking</a></li>
        <li><a href="#test-4-local-traffic-policy-iptables-traffic-hijacking">Test 4: Local Traffic Policy, iptables Traffic Hijacking</a></li>
      </ul>
    </li>
    <li><a href="#summary-for-single-layer-proxy-scenario">Summary for Single-Layer Proxy Scenario</a></li>
    <li><a href="#multi-layer-proxy">Multi-Layer Proxy</a></li>
    <li><a href="#tcp-traffic">TCP Traffic</a></li>
    <li><a href="#use-case-examples">Use Case Examples</a>
      <ul>
        <li><a href="#access-control-based-on-source-ip-address">Access Control Based on Source IP Address</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</details>

            
            <p>This blog post analyzes the challenges of server-side obtaining the client source IP in the Istio service mesh and provides solutions. The following topics will be covered:</p>
<ul>
<li>Reasons for the loss of source IP during packet transmission.</li>
<li>How to identify the client source IP.</li>
<li>Strategies for passing source IP in north-south and east-west requests.</li>
<li>Handling methods for HTTP and TCP protocols.</li>
</ul>
<h2 id="the-importance-of-preserving-source-ip">The Importance of Preserving Source IP</h2>
<p>The main reasons for preserving the client source IP include:</p>
<ul>
<li><strong>Access Control Policies</strong>: Performing authentication or security policies based on source IP.</li>
<li><strong>Load Balancing</strong>: Implementing request routing based on the client IP.</li>
<li><strong>Data Analysis</strong>: Access logs and monitoring metrics containing the actual source address, aiding developers in analysis.</li>
</ul>
<h2 id="meaning-of-preserving-source-ip">Meaning of Preserving Source IP</h2>
<p>Preserving the source IP refers to avoiding the situation where the actual client source IP is replaced as the request goes out from the client, and passes through a load balancer or reverse proxy.</p>
<p>Here is an example process of source IP address lost:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/9a331cc374c51421ecb64e58b25a6c4d.svg" data-img="/en/blog/preserve-source-ip-in-istio/9a331cc374c51421ecb64e58b25a6c4d.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>The above diagram represents the most common scenario. This article considers the following cases:</p>
<ol>
<li>North-South Traffic: Clients accessing servers through a load balancer (gateway)
<ol>
<li>Single-tier gateway</li>
<li>Multi-tier gateways</li>
</ol>
</li>
<li>East-West Traffic: Service-to-service communication within the mesh</li>
<li>Protocols: HTTP and TCP</li>
</ol>
<h2 id="how-to-confirm-client-source-ip">How to Confirm Client Source IP?</h2>
<p>In the Istio service mesh, Envoy proxies typically add the client IP to the &ldquo;X-Forwarded-For&rdquo; header of HTTP requests. Here are the steps to confirm the client IP:</p>
<ol>
<li><strong>Check the X-Forwarded-For Header</strong>: It contains the IP addresses of various proxies along the request path.</li>
<li><strong>Select the Last IP</strong>: Usually, the last IP is the client IP closest to the server.</li>
<li><strong>Verify the IP&rsquo;s Trustworthiness</strong>: Check the trustworthiness of the proxy servers.</li>
<li><strong>Use X-Envoy-External-Address</strong>: Envoy can set this header, which includes the real client IP.</li>
</ol>
<p>For more details, refer to the Envoy documentation on the <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-forwarded-for" title="&lt;code&gt;x-forwarded-for&lt;/code&gt; header" target="_blank" rel="noopener"><code>x-forwarded-for</code> header</a>. For TCP/IP connections, you can parse the client IP from the protocol field.</p>
<h2 id="testing-environment">Testing Environment</h2>
<p><strong>GKE</strong></p>
<ul>
<li>Client Version: v1.28.4</li>
<li>Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3</li>
<li>Server Version: v1.27.7-gke.1121000</li>
</ul>
<p><strong>Istio</strong></p>
<ul>
<li>Client version: 1.20.1</li>
<li>Control plane version: 1.20.1</li>
<li>Data plane version: 1.20.1 (12 proxies)</li>
</ul>
<p><strong>CNI</strong></p>
<p>We use Cilium CNI but have not enabled the kube-proxy-less mode.</p>
<ul>
<li>cilium-cli: v0.15.18 compiled with go1.21.5 on darwin/amd64</li>
<li>cilium image (default): v1.14.4</li>
<li>cilium image (stable): unknown</li>
<li>cilium image (running): 1.14.5</li>
</ul>
<p><strong>Node</strong></p>
<table>
<thead>
<tr>
<th>Node Name</th>
<th>Internal IP</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td>gke-cluster1-default-pool-5e4152ba-t5h3</td>
<td>10.128.0.53</td>
<td></td>
</tr>
<tr>
<td>gke-cluster1-default-pool-5e4152ba-ubc9</td>
<td>10.128.0.52</td>
<td></td>
</tr>
<tr>
<td>gke-cluster1-default-pool-5e4152ba-yzbg</td>
<td>10.128.0.54</td>
<td>Ingress Gateway Pod Node</td>
</tr>
</tbody>
</table>
<p>Public IP of the local client computer used for testing: <code>123.120.247.15</code></p>
<h2 id="deploying-test-example">Deploying Test Example</h2>
<p>The following diagram illustrates the testing approach:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/5f7a7c047a92dbcba5c733f206727c6a.svg" data-img="/en/blog/preserve-source-ip-in-istio/5f7a7c047a92dbcba5c733f206727c6a.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>First, deploy Istio according to the <a href="https://istio.io/latest/docs/setup/install/" title="Istio documentation" target="_blank" rel="noopener">Istio documentation</a>, and then enable sidecar auto-injection for the default namespace:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl label namespace default istio-injection<span class="o">=</span>enabled
</span></span></code></pre></div><p>Deploy the <code>echo-server</code> application in Istio:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create deployment echo-server --image<span class="o">=</span>registry.k8s.io/echoserver:1.4
</span></span><span class="line"><span class="cl">kubectl expose deployment echo-server --name<span class="o">=</span>clusterip --port<span class="o">=</span><span class="m">80</span> --target-port<span class="o">=</span><span class="m">8080</span>
</span></span></code></pre></div><p>Create an Ingress Gateway:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat &gt; config.yaml <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: networking.istio.io/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Gateway
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: clusterip-gateway
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    istio: ingressgateway # Choose the appropriate selector for your environment
</span></span></span><span class="line"><span class="cl"><span class="s">  servers:
</span></span></span><span class="line"><span class="cl"><span class="s">    - port:
</span></span></span><span class="line"><span class="cl"><span class="s">        number: 80
</span></span></span><span class="line"><span class="cl"><span class="s">        name: http
</span></span></span><span class="line"><span class="cl"><span class="s">        protocol: HTTP
</span></span></span><span class="line"><span class="cl"><span class="s">      hosts:
</span></span></span><span class="line"><span class="cl"><span class="s">        - &#34;clusterip.jimmysong.io&#34; # Replace with the desired hostname
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: networking.istio.io/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: VirtualService
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: clusterip-virtualservice
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  hosts:
</span></span></span><span class="line"><span class="cl"><span class="s">    - &#34;clusterip.jimmysong.io&#34; # Replace with the same hostname as in the Gateway
</span></span></span><span class="line"><span class="cl"><span class="s">  gateways:
</span></span></span><span class="line"><span class="cl"><span class="s">    - clusterip-gateway # Use the name of the Gateway here
</span></span></span><span class="line"><span class="cl"><span class="s">  http:
</span></span></span><span class="line"><span class="cl"><span class="s">    - route:
</span></span></span><span class="line"><span class="cl"><span class="s">        - destination:
</span></span></span><span class="line"><span class="cl"><span class="s">            host: clusterip.default.svc.cluster.local # Replace with the actual hostname of your Service
</span></span></span><span class="line"><span class="cl"><span class="s">            port:
</span></span></span><span class="line"><span class="cl"><span class="s">              number: 80 # Port of the Service
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">kubectl apply -f config.yaml
</span></span></code></pre></div><p>View the Envoy logs in the Ingress Gateway:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl logs -f deployment/istio-ingressgateway -n istio-system
</span></span></code></pre></div><p>View the Envoy logs in the Sleep Pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl logs -f deployment/sleep -n default -c istio-proxy
</span></span></code></pre></div><p>View the Envoy logs in the Echo Server:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl logs -f deployment/echo-server -n default -c istio-proxy
</span></span></code></pre></div><p>Get the public IP of the gateway:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GATEWAY_IP</span><span class="o">=</span><span class="k">$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class="k">)</span>
</span></span></code></pre></div><p>Test locally using curl:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -H <span class="s2">&#34;Host: clusterip.jimmysong.io&#34;</span> <span class="nv">$GATEWAY_IP</span>
</span></span></code></pre></div><h3 id="resource-ip">Resource IP</h3>
<p>After deploying the test application, you need to obtain the IP addresses of the following resources, which will be used in the upcoming experiments.</p>
<p><strong>Pod</strong></p>
<p>Here are the initial Pod IPs, but please note that as patches are applied to the Deployment, Pods may be recreated, and their names and IP addresses may change.</p>
<table>
<thead>
<tr>
<th>Pod Name</th>
<th>Pod IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>echo-server-6d9f5d97d7-fznrq</td>
<td>10.32.1.205</td>
</tr>
<tr>
<td>sleep-9454cc476-2dskx</td>
<td>10.32.3.202</td>
</tr>
<tr>
<td>istio-ingressgateway-6c96bdcd74-zh46d</td>
<td>10.32.1.221</td>
</tr>
</tbody>
</table>
<p><strong>Service</strong></p>
<table>
<thead>
<tr>
<th>Service Name</th>
<th>Cluster IP</th>
<th>External IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>clusterip</td>
<td>10.36.8.86</td>
<td>-</td>
</tr>
<tr>
<td>sleep</td>
<td>10.36.14.12</td>
<td>-</td>
</tr>
<tr>
<td>istio-ingressgateway</td>
<td>10.36.4.127</td>
<td>35.188.212.88</td>
</tr>
</tbody>
</table>
<h2 id="north-south-traffic">North-South Traffic</h2>
<p>Let&rsquo;s first consider the scenario where the client is outside the Kubernetes cluster and accesses internal services through a load balancer.</p>
<h3 id="test-1-cluster-traffic-policy-iptables-traffic-hijacking">Test 1: Cluster Traffic Policy, iptables Traffic Hijacking</h3>
<p>This is the default situation after deploying the test application using the steps above, and it represents the commonly encountered scenario where the source IP address is said to be lost.</p>
<p>curl test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -H <span class="s2">&#34;Host: clusterip.jimmysong.io&#34;</span> <span class="nv">$GATEWAY_IP</span>
</span></span></code></pre></div><details class="spoiler" id="spoiler-0">
  <summary>View Results</summary>
  <p><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CLIENT VALUES:
</span></span><span class="line hl"><span class="cl">client_address=127.0.0.6
</span></span><span class="line"><span class="cl">command=GET
</span></span><span class="line"><span class="cl">real path=/
</span></span><span class="line"><span class="cl">query=nil
</span></span><span class="line"><span class="cl">request_version=1.1
</span></span><span class="line"><span class="cl">request_uri=http://clusterip.jimmysong.io:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SERVER VALUES:
</span></span><span class="line"><span class="cl">server_version=nginx: 1.10.0 - lua: 10001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HEADERS RECEIVED:
</span></span><span class="line"><span class="cl">accept=*/*
</span></span><span class="line"><span class="cl">host=clusterip.jimmysong.io
</span></span><span class="line"><span class="cl">user-agent=curl/8.4.0
</span></span><span class="line"><span class="cl">x-b3-parentspanid=03c124c5f910001a
</span></span><span class="line"><span class="cl">x-b3-sampled=1
</span></span><span class="line"><span class="cl">x-b3-spanid=103dc912ec14f3b4
</span></span><span class="line"><span class="cl">x-b3-traceid=140ffa034822077f03c124c5f910001a
</span></span><span class="line"><span class="cl">x-envoy-attempt-count=1
</span></span><span class="line hl"><span class="cl">x-envoy-internal=true
</span></span><span class="line"><span class="cl">x-forwarded-client-cert=By=spiffe://cluster.local/ns/default/sa/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=&#34;&#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account
</span></span><span class="line hl"><span class="cl">x-forwarded-for=10.128.0.54
</span></span><span class="line"><span class="cl">x-forwarded-proto=http
</span></span><span class="line"><span class="cl">x-request-id=b3c05e22-594e-98da-ab23-da711a8f53ec
</span></span><span class="line"><span class="cl">BODY:
</span></span><span class="line"><span class="cl">-no body in request-</span></span></code></pre></td></tr></table>
</div>
</div>
</p>
</details>

<p>You only need to focus on the <code>client_address</code> and <code>x-forwarded-for</code> results. Other information in the curl test results will be omitted in the following curl test results.</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    Explanation
  </div>
  
  <div class="alert-note px-2">
    <p>Meaning of fields in the results:</p>
<ul>
<li><code>client_address</code>: The client IP address obtained through TCP/IP protocol resolution, referred to as the remote address in Envoy.</li>
<li><code>x-forwarded-for</code>: <code>x-forwarded-for</code> (XFF) is a standard proxy header used to indicate the IP addresses that the request has passed through from the client to the server. A compliant proxy will add the IP address of the most recent client to the XFF list before proxying the request. See <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for" title="Envoy documentation" target="_blank" rel="noopener">Envoy documentation</a> for details.</li>
</ul>
  </div>
</div>

<p>From the test results, we can see that the source IP address becomes the IP address of the Ingress Gateway Pod&rsquo;s node (<code>10.128.0.54</code>).</p>
<p>The following diagram shows the packet flow paths between the two Pods.</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/77c177b53601d1d83794cc1b2f4a8b5a.svg" data-img="/en/blog/preserve-source-ip-in-istio/77c177b53601d1d83794cc1b2f4a8b5a.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>For this scenario, preserving the source IP is straightforward and is also a standard option provided by Kubernetes.</p>
<h3 id="how-is-the-source-ip-lost">How is the Source IP Lost?</h3>
<p>The following diagram shows how the source IP of the client is lost during the request process.</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/708e3a4981b7deadfb203257e2ac5a64.svg" data-img="/en/blog/preserve-source-ip-in-istio/708e3a4981b7deadfb203257e2ac5a64.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>Because the load balancer sends packets to any node in the Kubernetes cluster, SNAT is performed during this process, resulting in the loss of the client&rsquo;s source IP when it reaches the Server Pod.</p>
<h3 id="how-to-preserve-the-client-source-ip">How to Preserve the Client Source IP</h3>
<p>You can control the load balancer to preserve the source IP by setting the <code>externalTrafficPolicy</code> field in the service to <code>Local</code>.</p>
<p><strong>externalTrafficPolicy</strong></p>
<p><code>externalTrafficPolicy</code> is a standard <a href="https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip" title="Service option" target="_blank" rel="noopener">Service option</a> that defines whether incoming traffic to Kubernetes nodes is load-balanced and how it&rsquo;s load-balanced. <code>Cluster</code> is the default policy, but <code>Local</code> is typically used to preserve the source IP of incoming traffic to cluster nodes. <code>Local</code> effectively disables load balancing on the cluster nodes so that traffic received by local Pods sees the source IP address.</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/02f4d9919bbd6f3d5fc5682c3793896a.svg" data-img="/en/blog/preserve-source-ip-in-istio/02f4d9919bbd6f3d5fc5682c3793896a.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>In other words, setting <code>externalTrafficPolicy</code> to <code>Local</code> allows packets to bypass kube-proxy on the nodes and reach the target Pod directly. However, most people do not set <code>externalTrafficPolicy</code> when creating a Service in Kubernetes, so the default <code>Cluster</code> policy is used.</p>
<p>Since using the Local external traffic policy in Service can preserve the client&rsquo;s source IP address, why isn&rsquo;t it the default in Kubernetes?</p>
<p>The default setting of Kubernetes Service&rsquo;s <code>externalTrafficPolicy</code> to <code>Cluster</code> instead of <code>Local</code> is primarily based on the following considerations:</p>
<ol>
<li><strong>Load Balancing</strong>: Ensures even distribution of traffic across all nodes, preventing overload on a single node.</li>
<li><strong>High Availability</strong>: Allows traffic to be received by any node in the cluster, enhancing service availability.</li>
<li><strong>Simplified Configuration</strong>: The <code>Cluster</code> mode reduces the complexity of network configurations.</li>
<li><strong>Performance Optimization</strong>: Avoids potential performance issues caused by preserving the client&rsquo;s source IP.</li>
<li><strong>Universality</strong>: Compatible with a variety of network environments and cluster configurations, suitable for a broader range of scenarios.</li>
</ol>
<h3 id="test-2-local-traffic-policy-iptables-traffic-hijacking">Test 2: Local Traffic Policy, iptables Traffic Hijacking</h3>
<p>Set the Ingress Gateway Service to use the Local external traffic policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch svc istio-ingressgateway -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;externalTrafficPolicy&#34;:&#34;Local&#34;}}&#39;</span> -n istio-system
</span></span></code></pre></div><p>Curl test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -H <span class="s2">&#34;Host: clusterip.jimmysong.io&#34;</span> <span class="nv">$GATEWAY_IP</span>
</span></span></code></pre></div><details class="spoiler" id="spoiler-2">
  <summary>View Results</summary>
  <p><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CLIENT VALUES:
</span></span><span class="line hl"><span class="cl">client_address=127.0.0.6
</span></span><span class="line"><span class="cl">command=GET
</span></span><span class="line"><span class="cl">real path=/
</span></span><span class="line"><span class="cl">query=nil
</span></span><span class="line"><span class="cl">request_version=1.1
</span></span><span class="line"><span class="cl">request_uri=http://clusterip.jimmysong.io:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SERVER VALUES:
</span></span><span class="line"><span class="cl">server_version=nginx: 1.10.0 - lua: 10001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HEADERS RECEIVED:
</span></span><span class="line"><span class="cl">accept=*/*
</span></span><span class="line"><span class="cl">host=clusterip.jimmysong.io
</span></span><span class="line"><span class="cl">user-agent=curl/8.4.0
</span></span><span class="line"><span class="cl">x-b3-parentspanid=060c393adb561603
</span></span><span class="line"><span class="cl">x-b3-sampled=1
</span></span><span class="line"><span class="cl">x-b3-spanid=8df3e10078cc826b
</span></span><span class="line"><span class="cl">x-b3-traceid=cf26040ae9536702060c393adb561603
</span></span><span class="line"><span class="cl">x-envoy-attempt-count=1
</span></span><span class="line hl"><span class="cl">x-envoy-external-address=123.120.247.15
</span></span><span class="line"><span class="cl">x-forwarded-client-cert=By=spiffe://cluster.local/ns/default/sa/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=&#34;&#34;;URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account
</span></span><span class="line hl"><span class="cl">x-forwarded-for=123.120.247.15
</span></span><span class="line"><span class="cl">x-forwarded-proto=http
</span></span><span class="line"><span class="cl">x-request-id=35bc2123-0971-9a9c-84c1-2aeee233a268
</span></span><span class="line"><span class="cl">BODY:
</span></span><span class="line"><span class="cl">-no body in request-</span></span></code></pre></td></tr></table>
</div>
</div>
</p>
</details>

<p>From the Envoy logs, we can see the current packet path:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/bd32b793946c9c3457a8a10db33f395d.svg" data-img="/en/blog/preserve-source-ip-in-istio/bd32b793946c9c3457a8a10db33f395d.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>The client&rsquo;s source IP is correctly identified as <code>123.120.247.15</code>.</p>
<h2 id="east-west-traffic">East-West Traffic</h2>
<p>In the default Istio configuration, for east-west traffic as well, the server cannot obtain the correct client source IP.</p>
<h3 id="test-3-local-traffic-policy-tproxy-traffic-hijacking">Test 3: Local Traffic Policy, tproxy Traffic Hijacking</h3>
<p>Change the traffic interception method from iptables to <a href="/en/blog/what-is-tproxy/" title="tproxy">tproxy</a> for the Echo Server:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch deployment -n default echo-server -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;sidecar.istio.io/interceptionMode&#34;:&#34;TPROXY&#34;}}}}}&#39;</span>
</span></span></code></pre></div><p>Note: At this point, the Pod for Echo Server will be recreated, and the new Pod&rsquo;s name is <code>echo-server-686d564647-r7nlq</code>, with an IP address of 10.32.1.140.</p>
<p>Curl test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it deployment/sleep -it -- curl clusterip
</span></span></code></pre></div><details class="spoiler" id="spoiler-3">
  <summary>View Results</summary>
  <p><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CLIENT VALUES:
</span></span><span class="line hl"><span class="cl">client_address=10.32.3.202
</span></span><span class="line"><span class="cl">command=GET
</span></span><span class="line"><span class="cl">real path=/
</span></span><span class="line"><span class="cl">query=nil
</span></span><span class="line"><span class="cl">request_version=1.1
</span></span><span class="line"><span class="cl">request_uri=http://clusterip:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SERVER VALUES:
</span></span><span class="line"><span class="cl">server_version=nginx: 1.10.0 - lua: 10001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HEADERS RECEIVED:
</span></span><span class="line"><span class="cl">accept=*/*
</span></span><span class="line"><span class="cl">host=clusterip
</span></span><span class="line"><span class="cl">user-agent=curl/8.5.0
</span></span><span class="line"><span class="cl">x-b3-parentspanid=3c07f3b87cc547dd
</span></span><span class="line"><span class="cl">x-b3-sampled=1
</span></span><span class="line"><span class="cl">x-b3-spanid=97844ebdde748bfc
</span></span><span class="line"><span class="cl">x-b3-traceid=90f57b0fb260dfbf3c07f3b87cc547dd
</span></span><span class="line"><span class="cl">x-envoy-attempt-count=1
</span></span><span class="line"><span class="cl">x-forwarded-client-cert=By=spiffe://cluster.local/ns/default/sa/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=&#34;&#34;;URI=spiffe://cluster.local/ns/default/sa/sleep
</span></span><span class="line"><span class="cl">x-forwarded-proto=http
</span></span><span class="line"><span class="cl">x-request-id=e9b27bde-3cf6-9d8b-8f23-1cb0fa35d405
</span></span><span class="line"><span class="cl">BODY:
</span></span><span class="line"><span class="cl">-no body in request-</span></span></code></pre></td></tr></table>
</div>
</div>
</p>
</details>

<p>The diagram below illustrates the packet path:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/eb87f7cdfe68c1b653b431af7281f2c9.svg" data-img="/en/blog/preserve-source-ip-in-istio/eb87f7cdfe68c1b653b431af7281f2c9.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>The client&rsquo;s IP is correctly identified as <code>10.32.3.202</code>.</p>
<h3 id="test-4-local-traffic-policy-iptables-traffic-hijacking">Test 4: Local Traffic Policy, iptables Traffic Hijacking</h3>
<p>Restore the traffic interception method in the Echo Server to redirect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch deployment -n default echo-server -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;sidecar.istio.io/interceptionMode&#34;:&#34;REDIRECT&#34;}}}}}&#39;</span>
</span></span></code></pre></div><p>Note: At this point, the Pod for the Echo Server will be recreated, and the new Pod&rsquo;s name is <code>echo-server-6d9f5d97d7-bgpk6</code>, with an IP address of 10.32.1.123.</p>
<p>Curl test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it deployment/sleep -it -- curl clusterip
</span></span></code></pre></div><details class="spoiler" id="spoiler-4">
  <summary>View Results</summary>
  <p><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CLIENT VALUES:
</span></span><span class="line hl"><span class="cl">client_address=127.0.0.6
</span></span><span class="line"><span class="cl">command=GET
</span></span><span class="line"><span class="cl">real path=/
</span></span><span class="line"><span class="cl">query=nil
</span></span><span class="line"><span class="cl">request_version=1.1
</span></span><span class="line"><span class="cl">request_uri=http://clusterip:8080/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SERVER VALUES:
</span></span><span class="line"><span class="cl">server_version=nginx: 1.10.0 - lua: 10001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HEADERS RECEIVED:
</span></span><span class="line"><span class="cl">accept=*/*
</span></span><span class="line"><span class="cl">host=clusterip
</span></span><span class="line"><span class="cl">user-agent=curl/8.5.0
</span></span><span class="line"><span class="cl">x-b3-parentspanid=6123380e58ca0ce7
</span></span><span class="line"><span class="cl">x-b3-sampled=1
</span></span><span class="line"><span class="cl">x-b3-spanid=633848c0065ec91e
</span></span><span class="line"><span class="cl">x-b3-traceid=dbcda8b3673e70a46123380e58ca0ce7
</span></span><span class="line"><span class="cl">x-envoy-attempt-count=1
</span></span><span class="line"><span class="cl">x-forwarded-client-cert=By=spiffe://cluster.local/ns/default/sa/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=&#34;&#34;;URI=spiffe://cluster.local/ns/default/sa/sleep
</span></span><span class="line"><span class="cl">x-forwarded-proto=http
</span></span><span class="line"><span class="cl">x-request-id=b05e07e1-08ba-9449-90a9-a4a98277a8c0
</span></span><span class="line"><span class="cl">BODY:
</span></span><span class="line"><span class="cl">-no body in request-</span></span></code></pre></td></tr></table>
</div>
</div>
</p>
</details>

<p>The diagram below illustrates the packet path:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/ae5e1e766d0262189226721772529ec8.svg" data-img="/en/blog/preserve-source-ip-in-istio/ae5e1e766d0262189226721772529ec8.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>The client&rsquo;s source IP is identified as <code>127.0.0.6</code>.</p>
<h2 id="summary-for-single-layer-proxy-scenario">Summary for Single-Layer Proxy Scenario</h2>
<p>In a single-tier proxy scenario, you only need to set the <code>externalTrafficPolicy</code> of the Ingress Gateway&rsquo;s Service to <code>Local</code> to preserve the client&rsquo;s source IP. Modifying the traffic interception mode of the target service to <code>TPROXY</code> will preserve the source IP in east-west requests.</p>
<h2 id="multi-layer-proxy">Multi-Layer Proxy</h2>
<p>If traffic has already passed through multiple tiers of proxies before entering the Istio Mesh, each time traffic passes through a proxy, the proxy parses the HTTP traffic and appends its own IP address to the <code>x-forwarded-for</code> header. You can use the <code>numTrustedProxies</code> configuration to specify the number of trusted proxy hops, referring to the <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for" title="Envoy documentation" target="_blank" rel="noopener">Envoy documentation</a> for how to determine the <code>X-Forwarded-For</code> header and trusted client addresses.</p>
<p>In practice, it can be challenging to determine how many tiers of proxy traffic have passed through before reaching the Istio Mesh, but you can use the <code>x-forwarded-for</code> header to understand the forwarding path of the traffic.</p>
<p>The diagram below shows how Envoy confirms the source IP based on the <code>x-forwarded-for</code> header and <code>xff_num_trusted_hops</code> (corresponding to the <code>numTrustedProxies</code> configuration in Istio). See the <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for" title="Envoy documentation" target="_blank" rel="noopener">Envoy documentation</a> for details.</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/b82caafefa304b53c996da072373043a.svg" data-img="/en/blog/preserve-source-ip-in-istio/b82caafefa304b53c996da072373043a.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<p>Execute the following command to enable trusted proxy configuration for the Ingress Gateway:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch deployment istio-ingressgateway -n istio-system -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;proxy.istio.io/config&#34;:&#34;{\&#34;gatewayTopology\&#34;:{\&#34;numTrustedProxies\&#34;: 2,\&#34;forwardClientCertDetails\&#34;:\&#34;SANITIZE_SET\&#34;}}&#34;}}}}}&#39;</span>
</span></span></code></pre></div><p>When the Istio Gateway receives a request, it sets the <code>X-Envoy-External-Address</code> header to the second-to-last address in your <code>X-Forwarded-For</code> header in the curl command (<code>numTrustedProxies: 2</code>). According to Istio&rsquo;s documentation, the Gateway appends its own IP to the <code>X-Forwarded-For</code> header before forwarding it to the service sidecar. However, in practice, only the client source IP and the External Gateway Pod IP are present in the header.</p>
<p>You can undo this patch by executing the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch deployment istio-ingressgateway -n istio-system -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;proxy.istio.io/config&#34;:&#34;{}&#34;}}}}}&#39;</span>
</span></span></code></pre></div><h2 id="tcp-traffic">TCP Traffic</h2>
<p>The method mentioned above for obtaining the client source IP using headers applies only to L7 networks. For L4 network TCP traffic, you can use the Proxy Protocol.</p>
<p>The Proxy Protocol is a network protocol that adds a header at the beginning of a TCP connection to pass along some metadata, such as the client&rsquo;s real IP address and port number, during the connection establishment. This is particularly useful for applications deployed behind load balancers (LB) because load balancers often change the original IP address of the client to the LB&rsquo;s address, making it difficult for the server to know the real client&rsquo;s IP. Many proxy software supports the Proxy Protocol, including <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol" title="Envoy" target="_blank" rel="noopener">Envoy</a>, HAProxy, NGINX, and others.</p>
<p>You can use the following command to patch the Ingress Gateway to support the Proxy Protocol:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl patch deployment istio-ingressgateway -n istio-system -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;template&#34;:{&#34;metadata&#34;:{&#34;annotations&#34;:{&#34;proxy.istio.io/config&#34;:&#34;{\\&#34;gatewayTopology\\&#34;:{\\&#34;proxyProtocol\\&#34;:{}}}&#34;}}}}}&#39;</span>
</span></span></code></pre></div><p>Note: Not all load balancers created by <code>LoadBalancer</code> type Services in Kubernetes in public clouds support this configuration. For example, GKE does not support it. To enable Proxy Protocol on AWS NLB, refer to <a href="https://istio.io/latest/blog/2020/show-source-ip/" title="this blog post" target="_blank" rel="noopener">this blog post</a>.</p>
<p>It&rsquo;s worth noting that Envoy does not recommend using the Proxy Protocol because it:</p>
<ul>
<li>Only supports the TCP protocol.</li>
<li>Requires upstream hosts to support it.</li>
<li>May impact performance.</li>
</ul>
<p>For Envoy&rsquo;s support of the Proxy Protocol, refer to <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/ip_transparency#proxy-protocol" title="this documentation" target="_blank" rel="noopener">this documentation</a>.</p>
<h2 id="use-case-examples">Use Case Examples</h2>
<p>The following are common scenarios for source IP addresses.</p>
<h3 id="access-control-based-on-source-ip-address">Access Control Based on Source IP Address</h3>
<p>In Istio, you can configure access control policies based on source IP using the Ingress Gateway. This is achieved by setting the authorization policy for the Ingress Gateway to restrict access based on source IP addresses.</p>
<p>The following diagram shows the flow of traffic:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/preserve-source-ip-in-istio/635bc14feb9b6939b3319929849cd0b5.svg" data-img="/en/blog/preserve-source-ip-in-istio/635bc14feb9b6939b3319929849cd0b5.svg" alt="image" data-caption="Mermaid Diagram">
        
      
    
  
  
  <figcaption>Mermaid Diagram</figcaption>
  
</figure>
<h4 id="scenario-assumptions">Scenario Assumptions</h4>
<p>Let&rsquo;s assume a request passes through three proxies with IP addresses <code>1.1.1.1</code>, <code>2.2.2.2</code>, and <code>3.3.3.3</code>. In the Ingress Gateway, <code>numTrustedProxies</code> is set to 2, so Istio trusts the source IP as <code>2.2.2.2</code> (i.e., <code>x-envoy-external-address</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -H <span class="s2">&#34;Host: clusterip.jimmysong.io&#34;</span> -H <span class="s1">&#39;X-Forwarded-For: 1.1.1.1,2.2.2.2,3.3.3.3&#39;</span> <span class="nv">$GATEWAY_IP</span>
</span></span></code></pre></div><h4 id="blocking-specific-source-ip">Blocking Specific Source IP</h4>
<p>If you need to block requests from <code>2.2.2.2</code>, you can use the following authorization policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">security.istio.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AuthorizationPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingressgateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">DENY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">remoteIpBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;2.2.2.2/24&#34;</span><span class="w">
</span></span></span></code></pre></div><h4 id="using-the-ultimate-client-ip">Using the Ultimate Client IP</h4>
<p>If you want to identify the client IP directly connected to the Istio Mesh (i.e., the last IP in <code>x-forwarded-for</code>, e.g., <code>123.120.234.15</code>), you need to configure it using <code>ipBlocks</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">security.istio.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AuthorizationPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">istio-ingressgateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">DENY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;123.120.234.15/24&#34;</span><span class="w">
</span></span></span></code></pre></div><p>This approach, by configuring authorization policies for Istio&rsquo;s Ingress Gateway, allows for effective access control based on source IP. It enables administrators to set rules flexibly based on different requirements, such as blocking specific IPs or trusting the ultimate client IP, enhancing the security and flexibility of the services.</p>
<h4 id="load-balancing-based-on-source-ip-address">Load Balancing Based on Source IP Address</h4>
<p>Here is an example configuration that shows how to use <code>DestinationRule</code> to load balance based on source IP address:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DestinationRule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-destination-rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">example-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">consistentHash</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpHeaderName</span><span class="p">:</span><span class="w"> </span><span class="l">x-forwarded-for</span><span class="w">
</span></span></span></code></pre></div><p>Note that if connecting directly to the Istio Ingress Gateway without going through another proxy, you may need to adjust <code>httpHeaderName</code> or use a different hash key, such as <code>useSourceIp</code> as shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">trafficPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">consistentHash</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">useSourceIp</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div>


<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    Notice
  </div>
  
  <div class="alert-note px-2">
    <ul>
<li>When using source IP addresses as keys for load balancing, make sure you understand how this may affect traffic distribution, especially if the source IP addresses are unevenly distributed.</li>
<li>As mentioned above, in some environments, the original source IP may be modified by network devices (such as load balancers or NAT devices), and you need to ensure that the <code>x-forwarded-for</code> header or other corresponding mechanism accurately reflects the original client IP.</li>
</ul>

  </div>
</div>

<h2 id="summary">Summary</h2>
<ul>
<li>Preserving the source IP is crucial for implementing access control, load balancing, and data analysis.</li>
<li>Envoy proxies use the <code>X-Forwarded-For</code> header to handle the client source IP in HTTP requests.</li>
<li>By setting <code>externalTrafficPolicy</code> and choosing the appropriate traffic interception method (<code>REDIRECT</code> or <code>TPROXY</code>), you can correctly obtain the client source IP in North-South and East-West traffic.</li>
<li>When dealing with traffic that passes through multiple tiers of proxies, configuring <code>numTrustedProxies</code> is crucial.</li>
<li>For TCP traffic, the Proxy Protocol is an effective solution.</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-forwarded-for" title="x-forwarded-for - envoyproxy.io" target="_blank" rel="noopener">x-forwarded-for - envoyproxy.io</a></li>
<li><a href="https://istio.io/latest/blog/2020/show-source-ip/" title="Proxy protocol on AWS NLB and Istio ingress gateway - istio.io" target="_blank" rel="noopener">Proxy protocol on AWS NLB and Istio ingress gateway - istio.io</a></li>
<li><a href="https://istio.io/latest/docs/ops/configuration/traffic-management/network-topologies/" title="Configuring Gateway Network Topology - istio.io" target="_blank" rel="noopener">Configuring Gateway Network Topology - istio.io</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/ip_transparency" title="IP Transparency - envoyproxy.io" target="_blank" rel="noopener">IP Transparency - envoyproxy.io</a></li>
<li><a href="https://kubernetes.io/docs/tutorials/services/source-ip/" title="Using Source IP - kubernetes.io" target="_blank" rel="noopener">Using Source IP - kubernetes.io</a></li>
<li><a href="https://github.com/haproxy/haproxy/blob/master/doc/proxy-protocol.txt" title="Proxy Protocol - github.com" target="_blank" rel="noopener">Proxy Protocol - github.com</a></li>
</ul>
<hr>
<p><em>This blog was initially published at <a href="https://tetrate.io/blog/istio-source-ip-transparency/" title="tetrate.io" target="_blank" rel="noopener">tetrate.io</a> .</em></p>

            <div class="border-bottom mb-2"></div>
          </div>

          <div class="col-12">
            <p>Last updated on Aug 16, 2024</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/en/tags/istio" class="badge"> 
                  Istio</a> 
              <a href="/en/tags/iptables" class="badge">  
                  Iptables</a> 
              <a href="/en/tags/tproxy" class="badge">  
                  Tproxy</a> 
              <a href="/en/tags/envoy" class="badge">  
                  Envoy</a> 
              <a href="/en/tags/kubernetes" class="badge">  
                  Kubernetes</a> </div>
          </div>

          
          <div class="col-12">
            









    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    






    



    


<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/en/blog/ica-certificate/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; Previous Post</span>
            <span class="text-align-left">ICA Certification: Latest Changes and Exam Preparation Guide for Istio Skills</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/en/blog/primary-remote-istio-ingress-gateway-mtls/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">Next Post &rarr;</span>
            <span class="text-align-right">Deciphering Istio Multi-Cluster Authentication &amp; mTLS Connection</span>
        </a>
    </div>
     
</div>

          </div>

          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="en"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          











<div>
  <p class="related-sidebar-title">
  Related article
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/en/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">
            Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception
          </a>
      </li>
    
      <li>
          <a href="/en/blog/ambient-mesh-l7-traffic-path/">
            L7 Traffic Path in Ambient Mesh
          </a>
      </li>
    
      <li>
          <a href="/en/blog/what-is-tproxy/">
            How Istio&#39;s Ambient Mode Transparent Proxy - tproxy Works Under the Hood
          </a>
      </li>
    
      <li>
          <a href="/en/blog/understanding-the-tls-encryption-in-istio/">
            How Istio’s mTLS Traffic Encryption Works as Part of a Zero Trust Security Posture
          </a>
      </li>
    
      <li>
          <a href="/en/blog/ambient-mesh-l4-traffic-path/">
            Transparent Traffic Intercepting and Routing in the L4 Network of Istio Ambient Mesh
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      Table of content
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#the-importance-of-preserving-source-ip">The Importance of Preserving Source IP</a></li>
    <li><a href="#meaning-of-preserving-source-ip">Meaning of Preserving Source IP</a></li>
    <li><a href="#how-to-confirm-client-source-ip">How to Confirm Client Source IP?</a></li>
    <li><a href="#testing-environment">Testing Environment</a></li>
    <li><a href="#deploying-test-example">Deploying Test Example</a>
      <ul>
        <li><a href="#resource-ip">Resource IP</a></li>
      </ul>
    </li>
    <li><a href="#north-south-traffic">North-South Traffic</a>
      <ul>
        <li><a href="#test-1-cluster-traffic-policy-iptables-traffic-hijacking">Test 1: Cluster Traffic Policy, iptables Traffic Hijacking</a></li>
        <li><a href="#how-is-the-source-ip-lost">How is the Source IP Lost?</a></li>
        <li><a href="#how-to-preserve-the-client-source-ip">How to Preserve the Client Source IP</a></li>
        <li><a href="#test-2-local-traffic-policy-iptables-traffic-hijacking">Test 2: Local Traffic Policy, iptables Traffic Hijacking</a></li>
      </ul>
    </li>
    <li><a href="#east-west-traffic">East-West Traffic</a>
      <ul>
        <li><a href="#test-3-local-traffic-policy-tproxy-traffic-hijacking">Test 3: Local Traffic Policy, tproxy Traffic Hijacking</a></li>
        <li><a href="#test-4-local-traffic-policy-iptables-traffic-hijacking">Test 4: Local Traffic Policy, iptables Traffic Hijacking</a></li>
      </ul>
    </li>
    <li><a href="#summary-for-single-layer-proxy-scenario">Summary for Single-Layer Proxy Scenario</a></li>
    <li><a href="#multi-layer-proxy">Multi-Layer Proxy</a></li>
    <li><a href="#tcp-traffic">TCP Traffic</a></li>
    <li><a href="#use-case-examples">Use Case Examples</a>
      <ul>
        <li><a href="#access-control-based-on-source-ip-address">Access Control Based on Source IP Address</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">Contact</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s LinkedIn</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-linkedin.png" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Blog</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/envoy-gateway-integration-istio-mesh/">Integrating Envoy Gateway as an Ingress Gateway in Istio Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">Securing Istio: Addressing Critical Security Gaps and Best Practices</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/gateway-api-istio-ingress-evolution/">How to Migrate from Kubernetes Ingress to the Gateway API</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">links</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" >
                  Awesome Cloud Native
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://gateway.envoyproxy.io" target="_blank" rel="noopener noreferrer">
                  Envoy Gateway
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io" target="_blank" rel="noopener noreferrer">
                  Istio
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate - Service Mesh Company
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://docs.tetrate.io/istio-subscription/" target="_blank" rel="noopener noreferrer">
                  Tetrate Istio Subscription
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Courses</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener noreferrer">
                  Envoy Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener noreferrer">
                  Istio Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">new notice</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-china-2024-panel/">KubeCon China 2024 panel Preview: Istio and Modern API Gateways – Leading the Future of Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/website-revamp-notice/">Website Revamp Notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-eu-2024/">See you in KubeCon Paris!</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>






  





<script src="/js/wowchemy-search.min.ce03c611044441cf6e84f9e4bef20818.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
