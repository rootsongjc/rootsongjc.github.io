<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>How to Implement Single Sign-On (SSO) with OIDC in API Gateway using Envoy Gateway? · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="This article provides a detailed guide on configuring Envoy Gateway to use OIDC for Single Sign-On. By using Auth0 as the identity provider, it demonstrates how to achieve secure and efficient SSO at the API Gateway level, enhancing user experience and system security.">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f25e1ff9bcb6a5d029ef3c0c4c5c51aec8832388d6321236cc72e9dc323217d6.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f25e1ff9bcb6a5d029ef3c0c4c5c51aec8832388d6321236cc72e9dc323217d6.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/blog/envoy-gateway-oidc/" />
  <meta property="og:title" content="How to Implement Single Sign-On (SSO) with OIDC in API Gateway using Envoy Gateway? | Jimmy Song" />
  <meta property="twitter:title" content="How to Implement Single Sign-On (SSO) with OIDC in API Gateway using Envoy Gateway? | Jimmy Song" />

  
  <meta property="og:description" content="This article provides a detailed guide on configuring Envoy Gateway to use OIDC for Single Sign-On. By using Auth0 as the identity provider, it demonstrates how to achieve secure and efficient SSO at the API Gateway level, enhancing user experience and system security." />
  <meta property="twitter:description" content="This article provides a detailed guide on configuring Envoy Gateway to use OIDC for Single Sign-On. By using Auth0 as the identity provider, it demonstrates how to achieve secure and efficient SSO at the API Gateway level, enhancing user experience and system security." />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/book">Book</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    
                  
                
              
              
              
                
                  
                    
                    <a class="nav-link" href="/blog/envoy-gateway-oidc/">中文</a>
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>Search</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>Search</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="Close"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="Input the keyword">
        
        <div class="mt-4">
          <span>Search type: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">All</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">Blog</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">Book</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">Notice</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    How to Implement Single Sign-On (SSO) with OIDC in API Gateway using Envoy Gateway?
                </p>
                <p class="page-description">
                    This article provides a detailed guide on configuring Envoy Gateway to use OIDC for Single Sign-On. By using Auth0 as the identity provider, it demonstrates how to achieve secure and efficient SSO at the API Gateway level, enhancing user experience and system security.
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>Jun 27, 2024</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/en/categories/envoy"> 
                        Envoy</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>9 Minute</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>1957 words</li>
                    
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">
            
            <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>Click to show the outline</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#authentication-methods-supported-by-envoy-gateway">Authentication Methods Supported by Envoy Gateway</a></li>
    <li><a href="#what-is-oidc">What is OIDC?</a></li>
    <li><a href="#why-implement-single-sign-on">Why Implement Single Sign-On?</a></li>
    <li><a href="#example-implementing-single-sign-on-with-envoy-gateway-and-auth0">Example: Implementing Single Sign-On with Envoy Gateway and Auth0</a>
      <ul>
        <li><a href="#implementing-single-sign-on-with-auth0">Implementing Single Sign-On with Auth0</a></li>
        <li><a href="#creating-an-application-on-auth0">Creating an Application on Auth0</a></li>
        <li><a href="#installing-envoy-gateway">Installing Envoy Gateway</a></li>
        <li><a href="#configuring-oidc-authentication-in-envoy-gateway">Configuring OIDC Authentication in Envoy Gateway</a></li>
        <li><a href="#verifying-single-sign-on-login">Verifying Single Sign-On: Login</a></li>
        <li><a href="#verifying-single-sign-on-logout">Verifying Single Sign-On: Logout</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</details>

            
            <p>In the blog post <a href="/en/blog/microservice-auth-methods/" title="Detailed Explanation of Common Authentication Methods in Microservices">Detailed Explanation of Common Authentication Methods in Microservices</a>, we discussed OAuth 2.0 authentication, which has several implementations, with OpenID Connect (OIDC) being the most popular one. OIDC provides both authentication and authorization for users. This article will explain how to implement OIDC authentication at the API Gateway level using Envoy Gateway.</p>
<h2 id="authentication-methods-supported-by-envoy-gateway">Authentication Methods Supported by Envoy Gateway</h2>
<p>Envoy Gateway is a high-performance API gateway implemented with Envoy, supporting various authentication methods to protect APIs and microservices:</p>
<ol>
<li><strong>JWT Authentication</strong>: Uses JSON Web Tokens (JWT) for authentication.</li>
<li><strong>mTLS (Mutual TLS)</strong>: Ensures secure communication between client and server using mutual TLS.</li>
<li><strong>HTTP Basic Authentication</strong>: Uses username and password for basic authentication.</li>
<li><strong>OIDC Authentication</strong>: Uses OpenID Connect protocol for identity verification and authorization.</li>
<li><strong>External Authentication</strong>: Calls external HTTP or gRPC services to check if incoming HTTP requests are authenticated.</li>
</ol>
<p>This article focuses on configuring and using OIDC authentication in Envoy Gateway to achieve Single Sign-On at the gateway level.</p>
<h2 id="what-is-oidc">What is OIDC?</h2>
<p>OpenID Connect (OIDC) is an identity verification protocol built on <a href="/blog/microservice-auth-methods/#oauth-20" title="OAuth 2.0">OAuth 2.0</a>. It allows clients to verify a user&rsquo;s identity via an authentication server and obtain information about the user.</p>
<p>The OIDC authentication process is illustrated below:</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/4e66a849ccc150b9ead3ba1bfb59dc08.svg" data-img="/en/blog/envoy-gateway-oidc/4e66a849ccc150b9ead3ba1bfb59dc08.svg" alt="image" data-caption="OIDC Authentication Flow Diagram">
        
      
    
  
  
  <figcaption>OIDC Authentication Flow Diagram</figcaption>
  
</figure>
<p>OIDC adds an identity layer on top of OAuth 2.0, introducing ID tokens and a standardized UserInfo endpoint, enabling OAuth 2.0 to be used not only for authorization but also for securely verifying user identities, thus achieving Single Sign-On (SSO) and obtaining user identity information.</p>
<h2 id="why-implement-single-sign-on">Why Implement Single Sign-On?</h2>
<p>Single Sign-On (SSO) is an identity verification method that allows users to log in to multiple independent applications with one account. Through a single authentication, users can seamlessly access all related applications, reducing the hassle of repeatedly entering usernames and passwords, thereby enhancing the user experience. SSO centralizes user identity and authentication management, enhancing system security and simplifying IT management processes.</p>
<p>For microservices architecture, SSO is particularly important because it achieves unified authentication and authorization across various microservices, avoiding the need for each service to implement its own identity verification logic, reducing user login redundancy, and enhancing the user experience. Centralized management also unifies application security policies, effectively monitors and responds to security events, and improves overall system security. Additionally, by using standardized tokens (like JWT), SSO simplifies the identity verification process between microservices, enhancing development efficiency and allowing developers to focus on business logic implementation.</p>
<h2 id="example-implementing-single-sign-on-with-envoy-gateway-and-auth0">Example: Implementing Single Sign-On with Envoy Gateway and Auth0</h2>
<p>Next, we will use Auth0 as the identity provider to demonstrate how to achieve Single Sign-On at the API Gateway level using Envoy Gateway.</p>
<h3 id="implementing-single-sign-on-with-auth0">Implementing Single Sign-On with Auth0</h3>
<p>First, let&rsquo;s illustrate the detailed process of implementing Single Sign-On with Auth0 in Envoy Gateway, as shown below.</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/0089f6fbc18bf3df6617cb57ed0ba6c2.svg" data-img="/en/blog/envoy-gateway-oidc/0089f6fbc18bf3df6617cb57ed0ba6c2.svg" alt="image" data-caption="Single Sign-On Flow Diagram with Auth0 and Envoy Gateway">
        
      
    
  
  
  <figcaption>Single Sign-On Flow Diagram with Auth0 and Envoy Gateway</figcaption>
  
</figure>
<p>Steps explanation:</p>
<ol>
<li><strong>User visits the website</strong>: The user accesses <code>https://www.example.com</code> via a browser.</li>
<li><strong>Request forwarding</strong>: The browser sends a GET request to Envoy Gateway.</li>
<li><strong>Check ID token</strong>: Envoy Gateway checks if the user&rsquo;s request contains a valid ID token in the cookie.</li>
<li><strong>Redirect to the identity provider</strong>: If no ID token is found, Envoy Gateway redirects the user to the identity provider&rsquo;s (IdP) authorization endpoint, in this case, Auth0. For more information on how Auth0 implements Login, refer to the <a href="https://auth0.com/docs/api/authentication#login" title="Auth0 documentation" target="_blank" rel="noopener">Auth0 documentation</a>.</li>
<li><strong>User login</strong>: The user enters their username and password on the identity provider&rsquo;s login page and submits the credentials for login.</li>
<li><strong>Obtain authorization code</strong>: After a successful login, the identity provider redirects the user back to Envoy Gateway, including an authorization code in the URL.</li>
<li><strong>Exchange ID token</strong>: Envoy Gateway uses the authorization code to request an ID token from the identity provider.</li>
<li><strong>Set Cookie</strong>: The identity provider returns the ID token, which Envoy Gateway sets as a cookie for the user.</li>
<li><strong>Redirect</strong>:  The URL redirected to <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a> again.</li>
<li><strong>Verify ID token</strong>: Envoy Gateway verifies the ID token in the user&rsquo;s request.</li>
<li><strong>Route the request</strong>: Upon successful verification, Envoy Gateway routes the request to the backend application (App).</li>
</ol>
<p>Through this process, Envoy Gateway achieves Single Sign-On functionality. HTTP requests from users that are not authenticated will be redirected to the SSO page. Besides Auth0, Envoy Gateway also supports multiple identity providers such as Azure AD, Keycloak, Okta, OneLogin, Salesforce, UAA, and more.</p>
<p>Next, we will configure Auth0 and Envoy Gateway according to the sequence diagram.</p>
<h3 id="creating-an-application-on-auth0">Creating an Application on Auth0</h3>
<p>Follow these steps to set up a Regular Web Application on Auth0:</p>
<ol>
<li>Visit <a href="https://auth0.com/" title="Auth0" target="_blank" rel="noopener">Auth0</a> and sign up for a free account.</li>
<li>Create a new application and choose Regular Web Applications.</li>
<li>In the application settings, record or set the following fields:
<ul>
<li><strong>Domain</strong>: <code>{DOMAIN}</code></li>
<li><strong>Client ID</strong>: <code>{CLIENT_ID}</code></li>
<li><strong>Client Secret</strong>: <code>{CLIENT_SECRET}</code></li>
<li><strong>Allowed Callback URLs</strong>: <a href="https://www.example.com/oauth2/myapp/callback" title="https://www.example.com/oauth2/myapp/callback" target="_blank" rel="noopener">https://www.example.com/oauth2/myapp/callback</a></li>
<li><strong>Allowed Logout URLs</strong>: <a href="https://www.example.com/myapp/logout" title="https://www.example.com/myapp/logout" target="_blank" rel="noopener">https://www.example.com/myapp/logout</a></li>
</ul>
</li>
</ol>
<p>Remember these Auth0 fields as we will use them to configure the Envoy Gateway&rsquo;s security policy.</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    Note
  </div>
  
  <div class="alert-note px-2">
    The Logout URL here is not functional because the backend service in our example does not implement the Auth0 logout interface. We are adding this field as a placeholder for future implementation.
  </div>
</div>

<p>Below are screenshots of the Auth0 configuration page. After setting up the user and creating a Regular Web Application, you only need to configure these two places.</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/auth0-1.webp" data-img="/en/blog/envoy-gateway-oidc/auth0-1.webp" data-width="1400" data-height="1079" alt="image" data-caption="Auth0 Configuration Page 1">
        
      
    
  
  
  <figcaption>Auth0 Configuration Page 1</figcaption>
  
</figure>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/auth0-2.webp" data-img="/en/blog/envoy-gateway-oidc/auth0-2.webp" data-width="1400" data-height="1079" alt="image" data-caption="Auth0 Configuration Page 2">
        
      
    
  
  
  <figcaption>Auth0 Configuration Page 2</figcaption>
  
</figure>
<p>This completes the configuration on Auth0. Next, we will install and configure Envoy Gateway.</p>
<h3 id="installing-envoy-gateway">Installing Envoy Gateway</h3>
<p>Refer to the <a href="/blog/envoy-gateway-introduction/#envoy-gateway-quick-start" title="Envoy Gateway Quick Start Guide">Envoy Gateway Quick Start Guide</a> to install Envoy Gateway on minikube:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube start --driver<span class="o">=</span>docker --cpus<span class="o">=</span><span class="m">2</span> --memory<span class="o">=</span>2g
</span></span><span class="line"><span class="cl">helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.0.1 -n envoy-gateway-system --create-namespace
</span></span><span class="line"><span class="cl">kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/v1.0.1/quickstart.yaml -n default
</span></span></code></pre></div><p>Refer to the Secure Gateway guide to configure TLS for Envoy Gateway:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create root certificate and private key to sign certificates</span>
</span></span><span class="line"><span class="cl">openssl req -x509 -sha256 -nodes -days <span class="m">365</span> -newkey rsa:2048 -subj <span class="s1">&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create certificate and private key for www.example.com</span>
</span></span><span class="line"><span class="cl">openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span class="s2">&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span class="line"><span class="cl">openssl x509 -req -days <span class="m">365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span class="m">0</span> -in www.example.com.csr -out www.example.com.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Store certificates/keys in a Secret</span>
</span></span><span class="line"><span class="cl">kubectl create secret tls example-cert --key<span class="o">=</span>www.example.com.key --cert<span class="o">=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the gateway created in the quickstart to include port <code>443</code> and reference the <code>example-cert</code> Secret in the HTTPS Listener:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;[
</span></span></span><span class="line"><span class="cl"><span class="s1">  {
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;op&#34;: &#34;add&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;value&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;name&#34;: &#34;https&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;port&#34;: 443,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;tls&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;mode&#34;: &#34;Terminate&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;certificateRefs&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s1">          {
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;kind&#34;: &#34;Secret&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;group&#34;: &#34;&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;name&#34;: &#34;example-cert&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">          }
</span></span></span><span class="line"><span class="cl"><span class="s1">        ]
</span></span></span><span class="line"><span class="cl"><span class="s1">      }
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">  }
</span></span></span><span class="line"><span class="cl"><span class="s1">]&#39;</span> <span class="p">|</span> kubectl patch gateway eg --type<span class="o">=</span>json --patch-file /dev/stdin
</span></span></code></pre></div><p>Create an HTTPRoute to add a route to the <code>backend</code> service for the <code>/myapp</code> endpoint:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: HTTPRoute
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: myapp
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  parentRefs:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: eg
</span></span></span><span class="line"><span class="cl"><span class="s">  hostnames: [&#34;www.example.com&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - matches:
</span></span></span><span class="line"><span class="cl"><span class="s">    - path:
</span></span></span><span class="line"><span class="cl"><span class="s">        type: PathPrefix
</span></span></span><span class="line"><span class="cl"><span class="s">        value: /myapp
</span></span></span><span class="line"><span class="cl"><span class="s">    backendRefs:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: backend
</span></span></span><span class="line"><span class="cl"><span class="s">      port: 3000
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><h3 id="configuring-oidc-authentication-in-envoy-gateway">Configuring OIDC Authentication in Envoy Gateway</h3>
<p>Create a Kubernetes Secret to store the OAuth Client&rsquo;s Client Secret:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret generic auth0-client-secret --from-literal<span class="o">=</span>client-secret<span class="o">=</span><span class="si">${</span><span class="nv">CLIENT_SECRET</span><span class="si">}</span>
</span></span></code></pre></div>


<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    Note
  </div>
  
  <div class="alert-note px-2">
    Replace <code>${CLIENT_SECRET}</code> with your Auth0 Client Secret.
  </div>
</div>

<p>Create a Security Policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: SecurityPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: oidc-example
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  targetRef:
</span></span></span><span class="line"><span class="cl"><span class="s">    group: gateway.networking.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">    kind: Gateway
</span></span></span><span class="line"><span class="cl"><span class="s">    name: eg
</span></span></span><span class="line"><span class="cl"><span class="s">  oidc:
</span></span></span><span class="line"><span class="cl"><span class="s">    provider:
</span></span></span><span class="line"><span class="cl"><span class="s">      issuer: &#34;https://${DOMAIN}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    clientID: &#34;${CLIENT_ID}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    clientSecret:
</span></span></span><span class="line"><span class="cl"><span class="s">      name: &#34;auth0-client-secret&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    redirectURL: &#34;https://www.example.com/myapp/oauth2/callback&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    logoutPath: &#34;/myapp/logout&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p><strong>Notes</strong></p>
<ul>
<li>The <code>issuer</code> here should be filled with the Auth0 Domain.</li>
<li>The value of <code>redirectURL</code> needs to appear in the Allowed Callback URLs in the Auth0 configuration.</li>
<li><code>logoutPath</code> is mandatory, even if its URL endpoint does not implement the logout logic.</li>
</ul>
<p>In this example, we set up OIDC for the Envoy Gateway. By modifying the <code>targetRef</code> to the HTTPRoute, OIDC can also be configured for individual routes. For detailed OIDC configuration, refer to the Envoy Gateway API Documentation.</p>
<h3 id="verifying-single-sign-on-login">Verifying Single Sign-On: Login</h3>
<p>Add <code>www.example.com</code> to the local <code>/etc/hosts</code> file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;127.0.0.1 www.example.com&#34;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><p>Configure port forwarding for the application to access the example application locally via the domain:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ENVOY_SERVICE</span><span class="o">=</span><span class="k">$(</span>kubectl get svc -n envoy-gateway-system --selector<span class="o">=</span>gateway.envoyproxy.io/owning-gateway-namespace<span class="o">=</span>default,gateway.envoyproxy.io/owning-gateway-name<span class="o">=</span>eg -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo kubectl -n envoy-gateway-system port-forward service/<span class="si">${</span><span class="nv">ENVOY_SERVICE</span><span class="si">}</span> 443:443
</span></span></code></pre></div><p>Now, visit <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a> in your browser, skip the certificate risk warning, and the page will redirect to the Auth0 login page, as shown below. Choose to log in with a Google account.</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/login.webp" data-img="/en/blog/envoy-gateway-oidc/login.webp" data-width="400" data-height="649" alt="image" data-caption="Login Page">
        
      
    
  
  
  <figcaption>Login Page</figcaption>
  
</figure>
<p>After logging in, the browser will redirect back to <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a> and display the HTTP request results, as shown in the JSON code below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;www.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;proto&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;headers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">/*Omit*/</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Authorization&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Bearer eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Cookie&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;OauthHMAC-167a6c5=RPdscXEBap0NeSIppJXoxkHt0qvMz4fNHXo2uvgDgIY=; OauthExpires-167a6c5=1716540771; BearerToken-167a6c5=eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ; IdToken-167a6c5=eyJhbG
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">ciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFKWkxWbnNrai0tYmhsNlJzVm51OCJ9.eyJpc3MiOiJodHRwczovL2Rldi1hd2hqbXkzOGdnNXF6eDd1LnVzLmF1dGgwLmNvbS8iLCJhdWQiOiJUZzhlNWVoa0xKM2hka3cxTzREMTBQd21QeTcxZHZtdiIsImlhdCI6MTcxNjQ1NDM3MSwiZXhwIjoxNzE2NDkwMzcxLCJzdWIiOiJnb29nbGUtb2F1dGgyfDExMjc0NDc3OTAyMjMzMTA0ODY0MCIsInNpZCI6IjRlSjhDZnZuZjd5Mm1kaE94QXBTY0JiUEhjOS1rZUVLIn0.r9dwIy_HeiO5_I3UlohLkeRES5FGoxqQnwmcA00cA_kdc5mUxgeVopXIhBUjJnTKv7bOUVJvFw21ew4gqVRJfllDyG-s_XfhSW1-lEXmCc2bGYDtOzva6k2S_VRgyMKfG04_DWFuTgO_pLtix28aYq8cGzKJ_VglT_KgRhoktzJu4Js5iCv9JPnydRJmpvRJwX3tDv_Q3mmUSazaLkhOTdiBJFrGlS07qEzJ_iWANZgR8uDNhpXdmlcqpb3MZkkMulr5-jXIgEhBQKpw28tUiSlzh6EpAVuBH9T1w8bUmFRzCc6JPPamJRfflYW5onNgYHDfcU0RpvpsCHRHRAZbdA&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="err">/*Omit*/</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Envoy-Internal&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Forwarded-For&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;10.244.0.51&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Forwarded-Proto&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;https&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Request-Id&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;c1e64057-c5c8-4fb2-a304-25c291eeed32&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ingress&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pod&#34;</span><span class="p">:</span> <span class="s2">&#34;backend-55d64d8794-4qvgd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At this point, you can see the ID Token in the Chrome browser&rsquo;s <em>Inspector - Application - Cookies</em>, as shown below:</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/en/blog/envoy-gateway-oidc/inspector.webp" data-img="/en/blog/envoy-gateway-oidc/inspector.webp" data-width="1400" data-height="983" alt="image" data-caption="View ID Token in Chrome Inspector">
        
      
    
  
  
  <figcaption>View ID Token in Chrome Inspector</figcaption>
  
</figure>
<p>Write a Python script <code>validate_id_token.py</code> to parse and validate the ID Token:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jwt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">jwt.algorithms</span> <span class="kn">import</span> <span class="n">RSAAlgorithm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">base64url_decode</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">rem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">rem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_signing_key</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">,</span> <span class="n">kid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">jwks</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">jwk</span> <span class="ow">in</span> <span class="n">jwks</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">jwk</span><span class="p">[</span><span class="s1">&#39;kid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">kid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">RSAAlgorithm</span><span class="o">.</span><span class="n">from_jwk</span><span class="p">(</span><span class="n">jwk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Public key not found.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">audience</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">jwk_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kid</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;kid&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">signing_key</span> <span class="o">=</span> <span class="n">get_signing_key</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">,</span> <span class="n">kid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">signing_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;RS256&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">audience</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">issuer</span><span class="o">=</span><span class="n">issuer</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decoded_token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Validate a JWT token.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The JWT token to validate&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parse the token&#39;s payload to extract audience and issuer</span>
</span></span><span class="line"><span class="cl">    <span class="n">header</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_payload</span> <span class="o">=</span> <span class="n">base64url_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">audience</span> <span class="o">=</span> <span class="n">payload_json</span><span class="p">[</span><span class="s1">&#39;aud&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">issuer</span> <span class="o">=</span> <span class="n">payload_json</span><span class="p">[</span><span class="s1">&#39;iss&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">jwk_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="s2">.well-known/jwks.json&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">audience</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">jwk_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Token is valid. Decoded payload:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">decoded</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Token validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Install the required packages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pip install pyjwt requests
</span></span></code></pre></div><p>Run the script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python validate_id_token.py <span class="si">${</span><span class="nv">ID_TOKEN</span><span class="si">}</span>
</span></span></code></pre></div><p>You will see an output similar to the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">Token is valid. Decoded payload:</span>
</span></span><span class="line"><span class="cl"><span class="na">iss: https://dev-awhjmy38gg5qzx7u.us.auth0.com/</span>
</span></span><span class="line"><span class="cl"><span class="na">aud: Tg8e5ehkLJ3hdkw1O4D10PwmPy71dvmv</span>
</span></span><span class="line"><span class="cl"><span class="na">iat: 1716470905</span>
</span></span><span class="line"><span class="cl"><span class="na">exp: 1716506905</span>
</span></span><span class="line"><span class="cl"><span class="na">sub: google-oauth2|112744779022331048640</span>
</span></span><span class="line"><span class="cl"><span class="na">sid: 4W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N</span>
</span></span></code></pre></div><p>From the values in the ID Token, you can conclude:</p>
<ul>
<li>The token is issued by Auth0 (<code>iss</code> field).</li>
<li>The audience of the token is a specific application or API (<code>aud</code> field), which is the Client ID for Auth0.</li>
<li>The token was issued at 2024-05-23 04:08:25 UTC (<code>iat</code> field) and will expire at 2024-05-23 14:08:25 UTC (<code>exp</code> field).</li>
<li>The subject (user) of the token has a unique identifier <code>google-oauth2|112744779022331048640</code> (<code>sub</code> field). This indicates that the user logged in using Google OAuth2.</li>
<li>The session ID is <code>4W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N</code> (<code>sid</code> field), used for session management.</li>
</ul>
<h3 id="verifying-single-sign-on-logout">Verifying Single Sign-On: Logout</h3>
<p>Since our example application does not implement the Auth0 logout logic, we need to explicitly tell Auth0 to logout via an HTTP request. Visit the following URL in your browser:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://<span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span>/v2/logout?client_id<span class="o">=</span><span class="si">${</span><span class="nv">CLIENT_ID</span><span class="si">}</span>
</span></span></code></pre></div><p>Replace <code>${DOMAIN}</code> and <code>${CLIENT_ID}</code> with the configuration items from your <a href="#auth0" title="Auth0 setup">Auth0 setup</a>. For detailed instructions on how to log users out using the OIDC endpoint in Auth0, refer to the <a href="https://auth0.com/docs/api/authentication#logout" title="Auth0 documentation" target="_blank" rel="noopener">Auth0 documentation</a>.</p>
<p>After logging out, the page will redirect to the login page again. Upon logging in, the page will redirect to <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a>.</p>
<h2 id="summary">Summary</h2>
<p>Through these steps, you can implement OIDC authentication in Envoy Gateway, ensuring API security. This method not only provides a flexible authentication mechanism but also simplifies application identity management. By integrating with identity providers like Auth0, Envoy Gateway can easily achieve Single Sign-On, enhancing user experience and system security. In the future, you can further configure and optimize Envoy Gateway based on your needs, leveraging its powerful authentication and authorization capabilities to meet more complex security requirements and business needs.</p>
<h2 id="references">References</h2>
<ul>
<li>Envoy Gateway OIDC Authentication - gateway.envoyproxy.io</li>
<li><a href="https://auth0.com/docs/authenticate/login/logout/log-users-out-of-auth0" title="Log Users Out of Auth0 with OIDC Endpoint - auth0.com" target="_blank" rel="noopener">Log Users Out of Auth0 with OIDC Endpoint - auth0.com</a></li>
</ul>

            <div class="border-bottom mb-2"></div>
          </div>

          <div class="col-12">
            <p>Last updated on Aug 5, 2024</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/en/tags/envoy" class="badge"> 
                  Envoy</a> 
              <a href="/en/tags/envoy-gateway" class="badge">  
                  Envoy Gateway</a> 
              <a href="/en/tags/oidc" class="badge">  
                  OIDC</a> 
              <a href="/en/tags/api-gateway" class="badge">  
                  API Gateway</a> 
              <a href="/en/tags/gateway" class="badge">  
                  Gateway</a> 
              <a href="/en/tags/auth0" class="badge">  
                  Auth0</a> 
              <a href="/en/tags/sso" class="badge">  
                  SSO</a> </div>
          </div>

          
          <div class="col-12">
            




    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    






    



    



<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/en/blog/how-to-integrate-third-party-registry-with-istio/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; Previous Post</span>
            <span class="text-align-left">How to Integrating Third-Party Service Registries with Istio?</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/en/blog/istio-delta-xds-for-envoy/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">Next Post &rarr;</span>
            <span class="text-align-right">Introduction to Envoy xDS and Configuration Distribution in Istio</span>
        </a>
    </div>
     
</div>

          </div>

          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="en"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          











<div>
  <p class="related-sidebar-title">
  Related article
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/en/blog/envoy-gateway-introduction/">
            Envoy Gateway Overview: Modern Kubernetes Ingress with Envoy Gateway and the Gateway API
          </a>
      </li>
    
      <li>
          <a href="/en/blog/why-gateway-api-is-the-future-of-ingress-and-mesh/">
            Why the Gateway API Is the Unified Future of Ingress for Kubernetes and Service Mesh
          </a>
      </li>
    
      <li>
          <a href="/en/blog/istio-delta-xds-for-envoy/">
            Introduction to Envoy xDS and Configuration Distribution in Istio
          </a>
      </li>
    
      <li>
          <a href="/en/blog/tetrate-vulnerability-scaner/">
            TVS: Istio and Envoy CVE Scanning Solution
          </a>
      </li>
    
      <li>
          <a href="/en/blog/preserve-source-ip-in-istio/">
            Maintaining Traffic Transparency: Preserving Client Source IP in Istio
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      Table of content
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#authentication-methods-supported-by-envoy-gateway">Authentication Methods Supported by Envoy Gateway</a></li>
    <li><a href="#what-is-oidc">What is OIDC?</a></li>
    <li><a href="#why-implement-single-sign-on">Why Implement Single Sign-On?</a></li>
    <li><a href="#example-implementing-single-sign-on-with-envoy-gateway-and-auth0">Example: Implementing Single Sign-On with Envoy Gateway and Auth0</a>
      <ul>
        <li><a href="#implementing-single-sign-on-with-auth0">Implementing Single Sign-On with Auth0</a></li>
        <li><a href="#creating-an-application-on-auth0">Creating an Application on Auth0</a></li>
        <li><a href="#installing-envoy-gateway">Installing Envoy Gateway</a></li>
        <li><a href="#configuring-oidc-authentication-in-envoy-gateway">Configuring OIDC Authentication in Envoy Gateway</a></li>
        <li><a href="#verifying-single-sign-on-login">Verifying Single Sign-On: Login</a></li>
        <li><a href="#verifying-single-sign-on-logout">Verifying Single Sign-On: Logout</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">Contact</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s LinkedIn</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-linkedin.png" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Blog</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/seamless-cross-cluster-access-istio/">A Definitive Guide to Cross-Cluster Seamless Access in Multicluster Istio Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/how-to-integrate-third-party-registry-with-istio/">How to Integrating Third-Party Service Registries with Istio?</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/envoy-gateway-oidc/">How to Implement Single Sign-On (SSO) with OIDC in API Gateway using Envoy Gateway?</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">links</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" >
                  Awesome Cloud Native
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://gateway.envoyproxy.io" target="_blank" rel="noopener noreferrer">
                  Envoy Gateway
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io" target="_blank" rel="noopener noreferrer">
                  Istio
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate - Service Mesh Company
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://docs.tetrate.io/istio-subscription/" target="_blank" rel="noopener noreferrer">
                  Tetrate Istio Subscription
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Courses</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener noreferrer">
                  Envoy Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener noreferrer">
                  Istio Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">new notice</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-china-2024-panel/">KubeCon China 2024 panel Preview: Istio and Modern API Gateways – Leading the Future of Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/website-revamp-notice/">Website Revamp Notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-eu-2024/">See you in KubeCon Paris!</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>






  





<script src="/js/wowchemy-search.min.ce03c611044441cf6e84f9e4bef20818.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
