<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Transparent Traffic Intercepting and Routing in the L4 Network of Istio Ambient Mesh · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This article details transparent traffic intercepting and L4 traffic paths in Ambient Mesh in both diagrammatic and hands-on form.">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.120.4">

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  
  <link rel="stylesheet" href="/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/plugins/hightlight/syntax.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/tocbot/tocbot.css">
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.css" media="screen">

  <!--Favicon-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="images/favicon.png" />

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/blog/ambient-mesh-l4-traffic-path/" />
  <meta property="og:title" content="Transparent Traffic Intercepting and Routing in the L4 Network of Istio Ambient Mesh" />
  <meta property="twitter:title" content="Transparent Traffic Intercepting and Routing in the L4 Network of Istio Ambient Mesh" />
  
  <meta property="og:description" content="This article details transparent traffic intercepting and L4 traffic paths in Ambient Mesh in both diagrammatic and hands-on form." />
  <meta property="twitter:description" content="This article details transparent traffic intercepting and L4 traffic paths in Ambient Mesh in both diagrammatic and hands-on form." />
  
  
  <meta property="og:image" content="https://jimmysong.io/images/banner/ambient-l4.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/ambient-l4.jpg" />
  
  
  
</head>
<body>
    <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>

<header class="fixed-top header">
  
  
  <div class="top-header py-2 bg-white">
    <div class="container">
      <div class="row no-gutters align-items-center">
        <div class="col-12 text-center">
          <ul class="list-inline">
            <li class="list-inline-item">
                <a href="https://bit.ly/3Vqrlfw" title="Download the eBook: The Current State and Future of the Istio Service Mesh" target="_blank" rel="noopener">Download the eBook: The Current State and Future of the Istio Service Mesh</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="navigation w-100  top-hider ">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>CLOUD NATIVE BLOG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://lib.jimmysong.io" target="_blank" rel="noopener">Book</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <a class="nav-link" href="/blog/ambient-mesh-l4-traffic-path/">中文</a>
            
            
            
            
            
            
          </li>
          
          
          <!-- search -->
          <button id="searchOpen" class="search-btn js-search"><i class="fa fa-search text-dark"></i></button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


    <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>Search</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fa fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        <i class="fa fa-search" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Input the keyword">
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

    
	
	
<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/page-title.webp'),url('/images/backgrounds/page-title.webp');">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <ul class="list-inline custom-breadcrumb">
                    <li class="list-inline-item h2"><a class="text-white font-secondary" href="/en/blog">
            
            
              
              Blogs
              
            
          </a></li>
                    <li class="list-inline-item"><i class="ti-angle-right text-white"></i></li>
                    <li class="list-inline-item text-white h3 font-secondary">Transparent Traffic Intercepting and Routing in the L4 Network of Istio Ambient Mesh</li>
                </ul>
                <p class="text-white">This article details transparent traffic intercepting and L4 traffic paths in Ambient Mesh in both diagrammatic and hands-on form.</p>
            </div>
        </div>
    </div>
</section>

	


<section class="section-sm">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8 article-content">
        <div class="row">
          <div class="col-12">
            <ul class="list-inline">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Date
                  :</span>December 15, 2022</li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Category
                  :</span><a
                  href="/en/categories/istio"> 
                  Istio</a> </li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Word Count
                  :</span>5151 words</li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Reading Time
                  :</span>23 Minute</li>
            </ul>
          </div>
          
          <div class="col-12 my-4">
            <div class="border-bottom"></div>
          </div>
          
          <div class="col-12 content">
            
            <details class="toc-inpage d-print-none d-show-block mb-0">
  <summary class="font-weight-bold">Click to show the outline</summary>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#principles">Principles</a></li>
        <li><a href="#what-is-tproxy">What Is tproxy?</a></li>
        <li><a href="#what-is-hbone">What Is HBONE?</a></li>
      </ul>
    </li>
    <li><a href="#environment">Environment</a></li>
    <li><a href="#outbound-traffic-intercepting">Outbound Traffic Intercepting</a>
      <ul>
        <li><a href="#check-the-routing-rules-on-node-a">Check The Routing Rules On Node A</a></li>
        <li><a href="#check-the-routing-rules-on-ztunnel-a">Check The Routing Rules On Ztunnel A</a></li>
      </ul>
    </li>
    <li><a href="#outbound-traffic-routing-on-ztunnel-a">Outbound Traffic Routing On Ztunnel A</a>
      <ul>
        <li><a href="#ztunnel_outbound-listener">Ztunnel_outbound Listener</a></li>
        <li><a href="#sleep-cluster">Sleep Cluster</a></li>
        <li><a href="#endpoints-of-the-sleep-cluster">Endpoints of The Sleep Cluster</a></li>
        <li><a href="#establishing-an-hbone-tunnel-through-envoys-internal-listener">Establishing an HBONE Tunnel Through Envoy’s Internal Listener</a></li>
        <li><a href="#hbone-tunnel-endpoints-for-the-sleep-cluster">HBONE Tunnel Endpoints For The Sleep Cluster</a></li>
      </ul>
    </li>
    <li><a href="#inbound-traffic-intercepting">Inbound Traffic Intercepting</a>
      <ul>
        <li><a href="#check-the-routing-rules-on-node-b">Check the Routing Rules on Node B</a></li>
        <li><a href="#check-the-routing-rules-on-ztunnel-b-pod">Check The Routing Rules On Ztunnel B Pod</a></li>
      </ul>
    </li>
    <li><a href="#inbound-traffic-routing-on-ztunnel-b">Inbound Traffic Routing On Ztunnel B</a>
      <ul>
        <li><a href="#ztunnel_inbound-listener">Ztunnel_inbound Listener</a></li>
        <li><a href="#virtual_inbound-cluster">Virtual_inbound Cluster</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
</details>

            
            <p>Ambient mesh is an experimental new deployment model recently introduced to Istio. It splits the duties currently performed by the Envoy sidecar into two separate components: a node-level component for encryption (called “ztunnel”) and an L7 Envoy instance deployed per service for all other processing (called “waypoint”). The ambient mesh model is an attempt to gain some efficiencies in potentially improved lifecycle and resource management. You can learn more about what ambient mesh is and how it differs from the Sidecar pattern <a href="https://tetrate.io/blog/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio/" title="here" target="_blank" rel="noopener">here</a>
.</p>
<p>This article takes you step-by-step through a hands-on approach to the transparent traffic intercepting and routing of L4 traffic paths in the Istio’s Ambient mode. If you don’t know what Ambient mode is, <a href="https://tetrate.io/blog/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio/" title="this article" target="_blank" rel="noopener">this article</a>
 can help you understand.</p>
<p>If you want to skip the actual hands-on steps and just want to know the L4 traffic path in Ambient mode, please see the figure below, it shows a Pod of Service A calling a Pod of Service B on a different node below.</p>
<p><figure class="mx-auto text-center">
  
  
  
  
    
    <img src="/en/blog/ambient-mesh-l4-traffic-path/ambient-mesh-l4-traffic-path.svg" data-img="/en/blog/ambient-mesh-l4-traffic-path/ambient-mesh-l4-traffic-path.svg" alt="image" data-caption="Figure 1: Transparent traffic intercepting and routing in the L4 network of Istio Ambient Mesh">
    
  
  <figcaption>Figure 1: Transparent traffic intercepting and routing in the L4 network of Istio Ambient Mesh</figcaption>
</figure>
</p>
<h3 id="principles">Principles</h3>
<p>Ambient mode uses <a href="https://www.kernel.org/doc/Documentation/networking/tproxy.txt" title="tproxy" target="_blank" rel="noopener">tproxy</a>
 and <a href="https://pkg.go.dev/github.com/costinm/hbone" title="HTTP Based Overlay Network Environment (HBONE)" target="_blank" rel="noopener">HTTP Based Overlay Network Environment (HBONE)</a>
 as key technologies for transparent traffic intercepting and routing:</p>
<ul>
<li>Using tproxy to intercept the traffic from the host Pod into the Ztunnel (Envoy Proxy).</li>
<li>Using HBONE to establish a tunnel for passing TCP traffic between Ztunnels.</li>
</ul>
<h3 id="what-is-tproxy">What Is tproxy?</h3>
<p>tproxy is a transparent proxy supported by the Linux kernel since version 2.2, where the t stands for transparent. You need to enable <em>NETFILTER_TPROXY</em> and policy routing in the kernel configuration. With tproxy, the Linux kernel can act as a router and redirect packets to user space. See the <a href="http://lxr.linux.no/linux&#43;v3.10/Documentation/networking/tproxy.txt" title="tproxy documentation" target="_blank" rel="noopener">tproxy documentation</a>
 for details.</p>
<h3 id="what-is-hbone">What Is HBONE?</h3>
<p>HBONE is a method of providing tunneling capabilities using the HTTP protocol. A client sends an <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/CONNECT" title="HTTP CONNECT" target="_blank" rel="noopener">HTTP CONNECT</a>
 request (which contains the destination address) to an HTTP proxy server to establish a tunnel, and the proxy server establishes a TCP connection to the destination on behalf of the client, which can then transparently transport TCP data streams to the destination server through the proxy. In Ambient mode, Ztunnel (Envoy inside) acts as a transparent proxy, using <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/other_features/internal_listener" title="Envoy Internal Listener" target="_blank" rel="noopener">Envoy Internal Listener</a>
 to receive HTTP CONNECT requests and pass TCP streams to the upstream cluster.</p>
<h2 id="environment">Environment</h2>
<p>Before starting the hands-on, it is necessary to explain the demo environment, and the corresponding object names in this article:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Items</th>
<th style="text-align:left">Name</th>
<th style="text-align:left">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Service A Pod</td>
<td style="text-align:left"><code>sleep-5644bdc767-2dfg7</code></td>
<td style="text-align:left">10.4.4.19</td>
</tr>
<tr>
<td style="text-align:left">Service B Pod</td>
<td style="text-align:left">productpage-v1-5586c4d4ff-qxz9f</td>
<td style="text-align:left">10.4.3.20</td>
</tr>
<tr>
<td style="text-align:left">Ztunnel A Pod</td>
<td style="text-align:left"><code>ztunnel-rts54</code></td>
<td style="text-align:left">10.4.4.18</td>
</tr>
<tr>
<td style="text-align:left">Ztunnel B Pod</td>
<td style="text-align:left"><code>ztunnel-z4qmh</code></td>
<td style="text-align:left">10.4.3.14</td>
</tr>
<tr>
<td style="text-align:left">Node A</td>
<td style="text-align:left"><code>gke-jimmy-cluster-default-pool-d5041909-d10i</code></td>
<td style="text-align:left">10.168.15.222</td>
</tr>
<tr>
<td style="text-align:left">Node B</td>
<td style="text-align:left"><code>gke-jimmy-cluster-default-pool-d5041909-c1da</code></td>
<td style="text-align:left">10.168.15.224</td>
</tr>
<tr>
<td style="text-align:left">Service B Cluster</td>
<td style="text-align:left"><code>productpage</code></td>
<td style="text-align:left">10.8.14.226</td>
</tr>
</tbody>
</table>
<p>Because these names will be used in subsequent command lines, the text will use pronouns, so that you can experiment in your own environment.</p>
<p>For the tutorial, I installed Istio Ambient mode in GKE. You can refer to this <a href="https://istio.io/latest/blog/2022/get-started-ambient/" title="Istio blog post" target="_blank" rel="noopener">Istio blog post</a>
 for installation instructions. Be careful not to install the Gateway, so as not to enable the L7 functionality; otherwise, the traffic path will be different from the descriptions in this blog.</p>
<p>In the following, we will experiment and dive into the L4 traffic path of a pod of <em>sleep</em> service to a pod of <em>productpage</em> service on different nodes. We will look at the outbound and inbound traffic of the Pods separately.</p>
<h2 id="outbound-traffic-intercepting">Outbound Traffic Intercepting</h2>
<p>The transparent traffic intercepting process for outbound traffic from a pod in Ambient mesh is as follows:</p>
<ol>
<li>Istio CNI creates the <em>istioout</em> NIC and iptables rules on the node, adds the Pods’ IP in Ambient mesh to the <a href="https://ipset.netfilter.org/" title="IP set" target="_blank" rel="noopener">IP set</a>
, and transparently intercepts outbound traffic from Ambient mesh to <em>pistioout</em> virtual NIC through <a href="https://datatracker.ietf.org/doc/rfc8926/" title="Geneve (Generic Network Virtualization Encapsulation)" target="_blank" rel="noopener">Geneve (Generic Network Virtualization Encapsulation)</a>
 tunnels with netfilter <em>nfmark</em> tags and routing rules.</li>
<li>The init container in Ztunnel creates iptables rules that forward all traffic from the <em>pistioout</em> NIC to port 15001 of the Envoy proxy in Ztunnel.</li>
<li>Envoy processes the packets and establishes an HBONE tunnel (HTTP CONNECT) with the upstream endpoints to forward the packets upstream.</li>
</ol>
<h3 id="check-the-routing-rules-on-node-a">Check The Routing Rules On Node A</h3>
<p>Log in to Node A, where Service A is located, and use <code>iptables-save</code> to check the rules.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="hl"><span class="lnt"> 3
</span></span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="hl"><span class="lnt">35
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* omit */
</span></span><span class="line hl"><span class="cl">-A PREROUTING -j ztunnel-PREROUTING
</span></span><span class="line hl"><span class="cl">-A PREROUTING -m comment --comment <span class="s2">&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</span></span><span class="line"><span class="cl">-A ztunnel-POSTROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span><span class="line hl"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span><span class="line"><span class="cl">/* omit */
</span></span><span class="line"><span class="cl">*mangle
</span></span><span class="line"><span class="cl">/* omit */
</span></span><span class="line"><span class="cl">-A PREROUTING -j ztunnel-PREROUTING
</span></span><span class="line"><span class="cl">-A INPUT -j ztunnel-INPUT
</span></span><span class="line"><span class="cl">-A FORWARD -j ztunnel-FORWARD
</span></span><span class="line"><span class="cl">-A OUTPUT -j ztunnel-OUTPUT
</span></span><span class="line"><span class="cl">-A OUTPUT -s 169.254.169.254/32 -j DROP
</span></span><span class="line"><span class="cl">-A POSTROUTING -j ztunnel-POSTROUTING
</span></span><span class="line"><span class="cl">-A ztunnel-FORWARD -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span class="line"><span class="cl">-A ztunnel-FORWARD -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span class="line"><span class="cl">-A ztunnel-INPUT -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span class="line"><span class="cl">-A ztunnel-INPUT -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span class="line"><span class="cl">-A ztunnel-OUTPUT -s 10.4.4.1/32 -j MARK --set-xmark 0x220/0xffffffff
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioin -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioin -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioout -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioout -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p udp -m udp --dport <span class="m">6081</span> -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m connmark --mark 0x220/0x220 -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING ! -i veth300a1d80 -m connmark --mark 0x210/0x210 -j MARK --set-xmark 0x40/0x40
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x40/0x40 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING ! -s 10.4.4.18/32 -i veth300a1d80 -j MARK --set-xmark 0x210/0x210
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i veth300a1d80 -j MARK --set-xmark 0x220/0x220
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p udp -j MARK --set-xmark 0x220/0x220
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line hl"><span class="cl">-A ztunnel-PREROUTING -p tcp -m <span class="nb">set</span> --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100/0x100</span></span></code></pre></td></tr></table>
</div>
</div>
<p>IPtables rule descriptions:</p>
<ul>
<li>Line 3: the <em>PREROUTING</em> chain is the first to run, and all packets will go to the <em>ztunnel-PEROUTING</em> chain first.</li>
<li>Line 4: packets are sent to the <em>KUBE-SERVICES</em> chain, where the Cluster IP of the Kubernetes Service is DNAT’d to the Pod IP.</li>
<li>Line 6: packets with 0x100/0x100 flags pass through the <em>PREROUTING</em> chain and no longer go through the <em>KUBE-SERVICES</em> chain.</li>
<li>Line 35: this is the last rule added to the <em>ztunnel-PREROUTING</em> chain; all TCP packets entering the <em>ztunnel-PREROUTING</em> chain that are in the <em>ztunnel-pods-ips</em> <a href="https://ipset.netfilter.org/" title="IP set" target="_blank" rel="noopener">IP set</a>
 (created by the Istio CNI) are marked with 0x100/0x100, which overrides all previous marks. See the <a href="https://ipset.netfilter.org/iptables-extensions.man.html#lbDD" title="Netfilter documentation" target="_blank" rel="noopener">Netfilter documentation</a>
 for more information about <em>nfmark</em>.</li>
</ul>
<p>By implementing the above iptables rules, we can ensure that ambient mesh only intercepts packets from the <em>ztunnel-pods-ips</em> IP set pods and marks the packets with 0x100/0x100 (<em>nfmark</em>, in value/mask format, both value and mask are 32-bit binary integers) without affecting other pods.</p>
<p>Let’s look at the routing rules for this node.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip rule
</span></span><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">100:    from all fwmark 0x200/0x200 goto <span class="m">32766</span>
</span></span><span class="line"><span class="cl">101:    from all fwmark 0x100/0x100 lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">102:    from all fwmark 0x40/0x40 lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">103:    from all lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>The routing table will be executed sequentially, with the first column indicating the priority of the routing table and the second column indicating the routing table to look for or jump to. You will see that all packets marked with 0x100/0x100 will look for the 101 routing table. Let’s look at that routing table.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">101</span>
</span></span><span class="line"><span class="cl">default via 192.168.127.2 dev istioout 
</span></span><span class="line"><span class="cl">10.4.4.18 dev veth52b75946 scope link 
</span></span></code></pre></div><p>You will see the 101 routing table with the keyword via, which indicates that the packets will be transmitted through the gateway, <a href="http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show" title="see the usage of the ip route command" target="_blank" rel="noopener">see the usage of the ip route command</a>
. All packets are sent through the <em>istioout</em> NIC to the gateway (IP is 192.168.127.2). The other line indicates the routing link for the <em>ztunnel</em> pod on the current node.</p>
<p>Let’s look at the details of the <em>istioout</em> NIC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d addr show istioout
</span></span><span class="line"><span class="cl">24: istioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether 62:59:1b:ad:79:01 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1001</span> remote 10.4.4.18 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span>
</span></span><span class="line hl"><span class="cl">    inet 192.168.127.1/30 brd 192.168.127.3 scope global istioout
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::6059:1bff:fead:7901/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>The <em>istioout</em> NIC in Pod A is connected to the <em>pstioout</em> NIC in <em>ztunnel</em> A through the Geneve tunnel.</p>
<h3 id="check-the-routing-rules-on-ztunnel-a">Check The Routing Rules On Ztunnel A</h3>
<p>Go to the <em>Ztunnel</em> A Pod and use the <em>ip -d</em> a command to check its NIC information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="hl"><span class="lnt">12
</span></span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d a
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity <span class="m">0</span> minmtu <span class="m">0</span> maxmtu <span class="m">0</span> numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if16: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1460</span> qdisc noqueue state UP group default 
</span></span><span class="line"><span class="cl">    link/ether 06:3e:d1:5d:95:16 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span> promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    veth numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    inet 10.4.2.1/24 brd 10.4.4.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line hl"><span class="cl">3: pistioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line hl"><span class="cl">    link/ether 06:18:ee:29:7e:e4 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1000</span> remote 10.4.2.1 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.126.2/30 scope global pistioin
</span></span><span class="line hl"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line hl"><span class="cl">4: pistioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line hl"><span class="cl">    link/ether aa:40:40:7c:07:b2 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1001</span> remote 10.4.2.1 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.127.2/30 scope global pistioout
</span></span><span class="line hl"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>You will find two NICs:</p>
<ul>
<li><em>pistioin</em> ：192.168.126.2, for the inbound traffic</li>
<li><em>pistioout</em>：192.168.127.2 for the outbound traffic</li>
</ul>
<p>How do you handle traffic from Pod A after it enters ztunnel? The answer is iptables. Look at the iptables rules in ztunnel A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* omit */
</span></span><span class="line"><span class="cl">*mangle
</span></span><span class="line"><span class="cl">:PREROUTING ACCEPT <span class="o">[</span>185880:96984381<span class="o">]</span>
</span></span><span class="line"><span class="cl">:INPUT ACCEPT <span class="o">[</span>185886:96984813<span class="o">]</span>
</span></span><span class="line"><span class="cl">:FORWARD ACCEPT <span class="o">[</span>0:0<span class="o">]</span>
</span></span><span class="line"><span class="cl">:OUTPUT ACCEPT <span class="o">[</span>167491:24099839<span class="o">]</span>
</span></span><span class="line"><span class="cl">:POSTROUTING ACCEPT <span class="o">[</span>167491:24099839<span class="o">]</span>
</span></span><span class="line"><span class="cl">-A PREROUTING -j LOG --log-prefix <span class="s2">&#34;mangle pre [ ztunnel-rts54] &#34;</span>
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -m tcp --dport <span class="m">15008</span> -j TPROXY --on-port <span class="m">15008</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line hl"><span class="cl">-A PREROUTING -i pistioout -p tcp -j TPROXY --on-port <span class="m">15001</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port <span class="m">15006</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">/* omit */</span></span></code></pre></td></tr></table>
</div>
</div>
<p>You can see that all TCP traffic in Ztunnel A destined for the pistioin NIC is transparently forwarded to port 15001 (Envoy’s outbound port) and tagged with 0x400/0xfff. This marker ensures that packets are sent to the correct NIC.</p>
<p>Check the routing rules In Ztunnel A:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip rule
</span></span><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">20000:  from all fwmark 0x400/0xfff lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">20001:  from all fwmark 0x401/0xfff lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">20002:  from all fwmark 0x402/0xfff lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">20003:  from all fwmark 0x4d3/0xfff lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>You will see that all packets marked 0x400/0xfff go to the 101 routing table, and we look at the details of that routing table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="nb">local</span> default dev lo scope host 
</span></span></code></pre></div><p>You will see that this is a local route and the packet is sent to the loopback NIC, which is 127.0.0.1.</p>
<p>This is the transparent intercepting process of outbound traffic in the pod.</p>
<h2 id="outbound-traffic-routing-on-ztunnel-a">Outbound Traffic Routing On Ztunnel A</h2>
<p>Outbound traffic is intercepted onto Ztunnel and processed into Envoy’s port 15001. Let’s see how Ztunnel routes outbound traffic.</p>
<blockquote>
<p>Note: The Envoy filter rules in Ztunnel are completely different from the Envoy filter rules in Sidecar mode, so instead of using the <em>istioctl proxy-config</em> command to inspect the configuration of Listener, Cluster, Endpoint, etc., we directly export the complete Envoy configuration in Ztunnel.</p>
</blockquote>
<p>You can get the Envoy configuration in Ztunnel A directly and remotely on your local machine</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -n istio-system ztunnel-hptxk -c istio-proxy -- curl <span class="s2">&#34;127.0.0.1:15000/config_dump?include_eds&#34;</span>&gt;ztunnel-a-all-include-eds.json
</span></span></code></pre></div><blockquote>
<p>Note: Do not use <em>istioctl proxy-config all ztunnel-rts54 -n istio-system</em> command to get the Envoy configuration, because the configuration so obtained does not contain the EDS part. The exported JSON file will have tens of thousands of lines, so it is recommended to use <a href="https://github.com/antonmedv/fx" title="fx " target="_blank" rel="noopener">fx </a>
or other tools to parse the file for readability.</p>
</blockquote>
<h3 id="ztunnel_outbound-listener">Ztunnel_outbound Listener</h3>
<p>The Envoy configuration contains the traffic rule configuration for all pods on this node. Let’s inspect the <em>ztunnel_outbound</em> Listener section configuration (some parts are omitted due to too much configuration):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="hl"><span class="lnt">  7
</span></span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="hl"><span class="lnt"> 10
</span></span><span class="hl"><span class="lnt"> 11
</span></span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="hl"><span class="lnt"> 14
</span></span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="hl"><span class="lnt"> 43
</span></span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="hl"><span class="lnt"> 59
</span></span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="hl"><span class="lnt"> 62
</span></span><span class="lnt"> 63
</span><span class="hl"><span class="lnt"> 64
</span></span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="hl"><span class="lnt"> 69
</span></span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="hl"><span class="lnt"> 76
</span></span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="hl"><span class="lnt"> 82
</span></span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="hl"><span class="lnt"> 85
</span></span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="hl"><span class="lnt"> 88
</span></span><span class="hl"><span class="lnt"> 89
</span></span><span class="hl"><span class="lnt"> 90
</span></span><span class="hl"><span class="lnt"> 91
</span></span><span class="hl"><span class="lnt"> 92
</span></span><span class="hl"><span class="lnt"> 93
</span></span><span class="hl"><span class="lnt"> 94
</span></span><span class="hl"><span class="lnt"> 95
</span></span><span class="hl"><span class="lnt"> 96
</span></span><span class="hl"><span class="lnt"> 97
</span></span><span class="hl"><span class="lnt"> 98
</span></span><span class="hl"><span class="lnt"> 99
</span></span><span class="hl"><span class="lnt">100
</span></span><span class="hl"><span class="lnt">101
</span></span><span class="hl"><span class="lnt">102
</span></span><span class="hl"><span class="lnt">103
</span></span><span class="hl"><span class="lnt">104
</span></span><span class="hl"><span class="lnt">105
</span></span><span class="hl"><span class="lnt">106
</span></span><span class="hl"><span class="lnt">107
</span></span><span class="hl"><span class="lnt">108
</span></span><span class="hl"><span class="lnt">109
</span></span><span class="hl"><span class="lnt">110
</span></span><span class="hl"><span class="lnt">111
</span></span><span class="hl"><span class="lnt">112
</span></span><span class="hl"><span class="lnt">113
</span></span><span class="hl"><span class="lnt">114
</span></span><span class="hl"><span class="lnt">115
</span></span><span class="hl"><span class="lnt">116
</span></span><span class="hl"><span class="lnt">117
</span></span><span class="hl"><span class="lnt">118
</span></span><span class="hl"><span class="lnt">119
</span></span><span class="hl"><span class="lnt">120
</span></span><span class="hl"><span class="lnt">121
</span></span><span class="hl"><span class="lnt">122
</span></span><span class="hl"><span class="lnt">123
</span></span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:10:40Z/13&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15001</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">},</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.original_dst&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.original_src&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mark&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.workload_metadata&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;config_discovery&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;30s&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type_urls&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;type.googleapis.com/istio.telemetry.workloadmetadata.v1.WorkloadMetadataResources&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;transparent&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;socket_options&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Set socket mark to packets coming back from outbound listener&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;36&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;int_value&#34;</span><span class="p">:</span> <span class="s2">&#34;1025&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;default_filter_chain&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span><span class="err">...</span><span class="p">],</span> <span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chain_matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;15001&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;on_no_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;source-ip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.SourceIPInput&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.168.15.222&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;10.4.4.19&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ip&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationIPInput&#34;</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;10.8.4.226&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">               <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                 <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput&#34;</span>
</span></span><span class="line hl"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                 <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">                 <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                   <span class="nt">&#34;9080&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                    <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                      <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span>
</span></span><span class="line hl"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                   <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="err">{...</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.4.4.7&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.4.4.11&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;on_no_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PassthroughFilterChain&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;PassthroughFilterChain&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:33:10.485Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<ul>
<li>Lines 10, 11, 59, 62, 64, 69, 76, 82, 85: Envoy listens to port 15001 and processes traffic forwarded using tproxy in the kernel; packets destined for port 15001 are directly discarded, and packets destined for other ports are then matched according to the source IP address to determine their destination.</li>
<li>Line 43: Use the <code>IP_TRANSPARENT</code> socket option to enable tproxy transparent proxy to forward traffic packets with destinations other than Ztunnel IPs.</li>
<li>Lines 88 to 123: based on the source IP (10.4.4.19 is the IP of Pod A), destination IP (10.8.14.226 is the Cluster IP of Service B) and port (9080) rule match, the packet will be sent to <code>spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal</code> cluster.</li>
</ul>
<h3 id="sleep-cluster">Sleep Cluster</h3>
<p>Let’s check the cluster’s configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="hl"><span class="lnt"> 5
</span></span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="hl"><span class="lnt">18
</span></span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="hl"><span class="lnt">31
</span></span><span class="hl"><span class="lnt">32
</span></span><span class="hl"><span class="lnt">33
</span></span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06Z/63&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;EDS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;eds_cluster_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;eds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;transport_socket_matches&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;internal_upstream&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.internal_upstream&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;passthrough_metadata&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tunnel&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-disabled&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06.619Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<ul>
<li>Line 6: This Cluster configuration uses EDS to get endpoints.</li>
<li>Line 18: <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/internal_upstream/v3/internal_upstream.proto#envoy-v3-api-msg-extensions-transport-sockets-internal-upstream-v3-internalupstreamtransport" title="InternalUpstreamTransport" target="_blank" rel="noopener">InternalUpstreamTransport</a>
 is applied to all byte streams with a tunnel: h2 metadata for internal addresses, defining loopback userspace sockets located in the same proxy instance. In addition to regular byte streams, this extension allows the additional structured state to be passed across userspace sockets (<code>passthrough_metadata</code>). The purpose is to facilitate communication between downstream filters and upstream internal connections. All filter state objects shared with the upstream connection are also shared with the downstream inner connection via this transportation socket.</li>
<li>Lines 23 to 37: structured data passed upstream.</li>
</ul>
<h3 id="endpoints-of-the-sleep-cluster">Endpoints of The Sleep Cluster</h3>
<p>Let’s check the EDS again, and you will find this entry in one of the many <code>endpoint_config</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;endpoint_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;locality&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lb_endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;envoy_internal_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;server_listener_name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;endpoint_id&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:9080&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">},</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;health_check_config&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;health_status&#34;</span><span class="p">:</span> <span class="s2">&#34;HEALTHY&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;filter_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;envoy.transport_socket_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:15008&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:9080&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;load_balancing_weight&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;policy&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;overprovisioning_factor&#34;</span><span class="p">:</span> <span class="mi">140</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<p>Line 4: As of the first release of Ambient mesh, this field was not actually present when the Envoy configuration was exported, but it is should have it. Otherwise, it would be impossible to determine which Cluster the Endpoint belongs to. The mandatory <code>cluster_name</code> field is missing from the <code>endpoint_config</code> here, probably due to a bug in Ambient mode that caused the field to be missing when exporting Envoy’s configuration.</p>
<p>Line 13: the address of the Endpoint is an <code>envoy_internal_address</code>，<code>Envoy internal listener</code>outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep`.</p>
<p>Lines 20 – 30: defining filter metadata to be passed to the Envoy internal listener using the HBONE tunnel.</p>
<h3 id="establishing-an-hbone-tunnel-through-envoys-internal-listener">Establishing an HBONE Tunnel Through Envoy’s Internal Listener</h3>
<p>Let’s look into the listener <code>outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="hl"><span class="lnt">40
</span></span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06Z/63&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.tcp_proxy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">},</span> <span class="err">...</span><span class="p">],</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;tunneling_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;%DYNAMIC_METADATA(tunnel:destination)%&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;headers_to_add&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;header&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;x-envoy-original-dst-host&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;%DYNAMIC_METADATA([\&#34;tunnel\&#34;, \&#34;destination\&#34;])%&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;set_dst_address&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/xds.type.v3.TypedStruct&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;type_url&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/istio.set_internal_dst_address.v1.Config&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;internal_listener&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06.750Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<ul>
<li>Line 14: packets will be forwarded to the <code>outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep cluster</code>.</li>
<li>Lines 18 – 28: <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/tcp_proxy/v3/tcp_proxy.proto#envoy-v3-api-msg-extensions-filters-network-tcp-proxy-v3-tcpproxy-tunnelingconfig" title="tunneling_config" target="_blank" rel="noopener">tunneling_config</a>
 , used to configure the upstream HTTP CONNECT tunnel. In addition, the TcpProxy filter in this listener passes traffic to the upstream p cluster. HTTP CONNECT tunnels (which carry traffic sent to <code>10.4.3.20:9080</code>) are set up on the TCP filter for use by the Ztunnel on the node where the productpage is located. As many tunnels are created, as there are endpoints. HTTP tunnels are the bearer protocol for secure communication between Ambient components. The packet in the tunnel also adds the <code>x-envoy-original-dst-host</code> header, which sets the destination address based on the parameters in the metadata of the endpoint selected in the previous EDS step. The endpoint selected in the previous EDS is 10.4.3.20:9080, so the tunnel listener here sets the header value to 10.4.3.20:9080, so keep an eye on this header as it will be used at the other end of the tunnel.</li>
<li>Line 40: The listener filter is executed first in the listener. The <code>set_dst_address</code> filter sets the upstream address to the downstream destination address.</li>
</ul>
<h3 id="hbone-tunnel-endpoints-for-the-sleep-cluster">HBONE Tunnel Endpoints For The Sleep Cluster</h3>
<p>Let’s look into the configuration of the <code>outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep cluster</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="hl"><span class="lnt">31
</span></span><span class="hl"><span class="lnt">32
</span></span><span class="hl"><span class="lnt">33
</span></span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="hl"><span class="lnt">38
</span></span><span class="hl"><span class="lnt">39
</span></span><span class="hl"><span class="lnt">40
</span></span><span class="hl"><span class="lnt">41
</span></span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="hl"><span class="lnt">45
</span></span><span class="hl"><span class="lnt">46
</span></span><span class="hl"><span class="lnt">47
</span></span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:30:10Z/37&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_pod_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ORIGINAL_DST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;2s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;lb_policy&#34;</span><span class="p">:</span> <span class="s2">&#34;CLUSTER_PROVIDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;cleanup_interval&#34;</span><span class="p">:</span> <span class="s2">&#34;60s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep~sleep-5644bdc767-2dfg7~85c8c34e-7ae3-4d29-9582-0819e2b10c69&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;original_dst_lb_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;upstream_port_override&#34;</span><span class="p">:</span> <span class="mi">15008</span>
</span></span><span class="line hl"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;typed_extension_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;explicit_http_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;http2_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;allow_connect&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:30:10.754Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<ul>
<li>Line 6: the type of this cluster is <code>ORIGINAL_DST</code>, i.e. the address 10.4.3.20:9080 obtained by EDS in the previous section.</li>
<li>Lines 22 – 41: the upstream TLS certificate is configured.</li>
<li>lines 45 – 48: the upstream port is overridden with 15008.</li>
</ul>
<p>The above is the whole process of transparent outbound traffic intercepting using tproxy and HBONE tunnel.</p>
<h2 id="inbound-traffic-intercepting">Inbound Traffic Intercepting</h2>
<p>Node B receives requests from Node A to <code>10.4.3.20:15008</code>. Inbound traffic intercepting in Ambient mode is similar to outbound. It also uses tproxy and HBONE to achieve transparent traffic intercepting.</p>
<p>The transparent traffic intercepting process for inbound traffic to the pod of Ambient mesh is as follows:</p>
<ol>
<li>Istio CNI creates the istioin NIC and iptables rules on the node, adds the pods IP in Ambient mesh to the IP set, and transparently hijacks outbound traffic from Ambient mesh to the pistioin VM through the Geneve tunnel by using Netfilter nfmark tags and routing rules. NICs.</li>
<li>The init container in Ztunnel creates iptables rules that forward all traffic from the pistioin NIC to port 15008 of the Envoy proxy in Ztunnel.</li>
<li>Envoy processes the packets and forwards them to Pod B.</li>
</ol>
<p>Since the checking procedure is similar to the outbound traffic, some of the output will be omitted below.</p>
<h3 id="check-the-routing-rules-on-node-b">Check the Routing Rules on Node B</h3>
<p>Log in to Node B, where Service B is located, and check the iptables on the node:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* omit */
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p tcp -m <span class="nb">set</span> --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100/0x100
</span></span><span class="line"><span class="cl">/* omit */
</span></span></code></pre></div><p>You will see the previous command mentioned in the previous section to mark all packets sent by the pods in the <code>ztunnel-pods-ips</code> IP set with 0x100/0x100: mark all packets with 0x200/0x200, and then continue with iptables.</p>
<p>Look into the routing table on node B:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">100:    from all fwmark 0x200/0x200 goto <span class="m">32766</span>
</span></span><span class="line"><span class="cl">101:    from all fwmark 0x100/0x100 lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">102:    from all fwmark 0x40/0x40 lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">103:    from all lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>The number of routing tables and rules are the same in all the nodes which belong to the ambient mesh. The routing table rules will be executed sequentially, looking first for the local table, then all packets with 0x200/0x200 flags will first jump to the main table (where veth routes are defined), and then to the 100 table, where the following rules are in place:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="hl"><span class="lnt">8
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">100</span>
</span></span><span class="line"><span class="cl">10.4.3.14 dev veth28865c45 scope link 
</span></span><span class="line"><span class="cl">10.4.3.15 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line"><span class="cl">10.4.3.16 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line"><span class="cl">10.4.3.17 via 192.168.126.2 dev istioin src 10.4.3. 
</span></span><span class="line"><span class="cl">10.4.3.18 via 192.168.126.2 dev istioin src 10.4.3. 
</span></span><span class="line"><span class="cl">10.4.3.19 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line hl"><span class="cl">10.4.3.20 via 192.168.126.2 dev istioin src 10.4.3.1</span></span></code></pre></td></tr></table>
</div>
</div>
<p>You will see that packets destined for <code>10.4.3.20</code> will be routed to the <code>192.168.126.2</code> gateway on the istioin NIC.</p>
<p>Look into the details of the istioin NIC:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d addr show istioin 
</span></span><span class="line"><span class="cl">17: istioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether 36:2a:2f:f1:5c:97 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1000</span> remote 10.4.3.14 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.126.1/30 brd 192.168.126.3 scope global istioin
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::342a:2fff:fef1:5c97/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>As you can see from the output, istioin is a Geneve type virtual NIC that creates a Geneve tunnel with a remote IP of 10.4.3.14, which is the Pod IP of Ztunnel B.</p>
<h3 id="check-the-routing-rules-on-ztunnel-b-pod">Check The Routing Rules On Ztunnel B Pod</h3>
<p>Go to the Ztunnel B Pod and use the ip -d a command to check its NIC information. You will see that there is a pistioout NIC with an IP of 192.168.127.2, which is the far end of the Geneve tunnel created with the istioin virtual NIC.</p>
<p>Use iptables-save to view the iptables rules within the Pod, and you will see that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -m tcp --dport <span class="m">15008</span> -j TPROXY --on-port <span class="m">15008</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port <span class="m">15006</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span></code></pre></div><p>All traffic destined for 10.4.3.20:15008 will be routed to port 15008 using tproxy.</p>
<p><strong>15006 and 15008</strong></p>
<ul>
<li>
<p>Port 15006 is used to process non-encrypted (plain) TCP packets.</p>
</li>
<li>
<p>Port 15008 is used to process encrypted (TLS) TCP packets.</p>
</li>
</ul>
<p>The above is the transparent intercepting process of inbound traffic in the Pod.</p>
<h2 id="inbound-traffic-routing-on-ztunnel-b">Inbound Traffic Routing On Ztunnel B</h2>
<p>The outbound TLS encrypted traffic is intercepted on Ztunnel and goes to Envoy’s port 15008 for processing. Let’s look at how Ztunnel routes inbound traffic.</p>
<p>Let’s remotely get the Envoy configuration in Ztunnel B directly on our local machine.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -n istio-system 	ztunnel-z4qmh -c istio-proxy -- curl <span class="s2">&#34;127.0.0.1:15000/config_dump?include_eds&#34;</span>&gt;ztunnel-b-all-include-eds.json
</span></span></code></pre></div><h3 id="ztunnel_inbound-listener">Ztunnel_inbound Listener</h3>
<p>Look into the details of the ztunnel_inbound listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="hl"><span class="lnt">  7
</span></span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="hl"><span class="lnt"> 10
</span></span><span class="hl"><span class="lnt"> 11
</span></span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="hl"><span class="lnt"> 17
</span></span><span class="hl"><span class="lnt"> 18
</span></span><span class="hl"><span class="lnt"> 19
</span></span><span class="hl"><span class="lnt"> 20
</span></span><span class="hl"><span class="lnt"> 21
</span></span><span class="hl"><span class="lnt"> 22
</span></span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="hl"><span class="lnt"> 39
</span></span><span class="hl"><span class="lnt"> 40
</span></span><span class="hl"><span class="lnt"> 41
</span></span><span class="hl"><span class="lnt"> 42
</span></span><span class="hl"><span class="lnt"> 43
</span></span><span class="hl"><span class="lnt"> 44
</span></span><span class="hl"><span class="lnt"> 45
</span></span><span class="hl"><span class="lnt"> 46
</span></span><span class="hl"><span class="lnt"> 47
</span></span><span class="hl"><span class="lnt"> 48
</span></span><span class="hl"><span class="lnt"> 49
</span></span><span class="hl"><span class="lnt"> 50
</span></span><span class="hl"><span class="lnt"> 51
</span></span><span class="hl"><span class="lnt"> 52
</span></span><span class="hl"><span class="lnt"> 53
</span></span><span class="hl"><span class="lnt"> 54
</span></span><span class="hl"><span class="lnt"> 55
</span></span><span class="hl"><span class="lnt"> 56
</span></span><span class="hl"><span class="lnt"> 57
</span></span><span class="hl"><span class="lnt"> 58
</span></span><span class="hl"><span class="lnt"> 59
</span></span><span class="hl"><span class="lnt"> 60
</span></span><span class="hl"><span class="lnt"> 61
</span></span><span class="hl"><span class="lnt"> 62
</span></span><span class="hl"><span class="lnt"> 63
</span></span><span class="hl"><span class="lnt"> 64
</span></span><span class="hl"><span class="lnt"> 65
</span></span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="hl"><span class="lnt"> 78
</span></span><span class="hl"><span class="lnt"> 79
</span></span><span class="hl"><span class="lnt"> 80
</span></span><span class="hl"><span class="lnt"> 81
</span></span><span class="hl"><span class="lnt"> 82
</span></span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:12:01Z/16&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15008</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filter_chain_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;prefix_ranges&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;address_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;prefix_len&#34;</span><span class="p">:</span> <span class="mi">32</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.rbac&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rules&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;tcp.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;shadow_rules_stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;istio_dry_run_allow_&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.http_connection_manager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_hcm&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;route_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;local_route&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;virtual_hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;local_service&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">            <span class="s2">&#34;*&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;connect_matcher&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;virtual_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;upgrade_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;upgrade_type&#34;</span><span class="p">:</span> <span class="s2">&#34;CONNECT&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;connect_config&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">              <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.http.router&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.http.router.v3.Router&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http2_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;allow_connect&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}],</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;upgrade_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;upgrade_type&#34;</span><span class="p">:</span> <span class="s2">&#34;CONNECT&#34;</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">}</span> 
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_10.4.3.20&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="err">...</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[{},</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;transparent&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;socket_options&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}</span><span class="err">}</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-14T03:54:07.040Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>You will see that:</p>
<ul>
<li>Traffic destined for 10.4.3.20 will be routed to the <code>virtual_inbound</code> cluster.</li>
<li>Lines 78 – 82: <code>upgrade_type: &quot;CONNECT&quot;</code> Enables the HTTP Connect tunnel for Envoy’s HCM to send TCP packets in that tunnel upstream.</li>
</ul>
<h3 id="virtual_inbound-cluster">Virtual_inbound Cluster</h3>
<p>Look into the configuration of the <code>virtual_inbound</code> cluster:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="hl"><span class="lnt"> 9
</span></span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;version_info&#34;</span>: <span class="s2">&#34;2022-11-11T07:10:40Z/13&#34;</span>,
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;cluster&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;@type&#34;</span>: <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;virtual_inbound&#34;</span>,
</span></span><span class="line hl"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ORIGINAL_DST&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;lb_policy&#34;</span>: <span class="s2">&#34;CLUSTER_PROVIDED&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;original_dst_lb_config&#34;</span>: <span class="o">{</span>
</span></span><span class="line hl"><span class="cl">   <span class="s2">&#34;use_http_header&#34;</span>: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>,
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;last_updated&#34;</span>: <span class="s2">&#34;2022-11-11T07:10:42.111Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>Descriptions:</p>
<ul>
<li>Line 7: the type of this cluster is ORIGINAL_DST, indicating that the original downstream destination is used as the route destination, i.e. 10.4.3.20:15008, which obviously has an incorrect port in this address.</li>
<li>Line 9: a use_http_header of true will use the HTTP header x-envoy-original-dst-host as the destination, which has been set to 10.4.3.20:9080 in the outbound Ztunnel, and it will override the previously set destination address.</li>
</ul>
<p>At this point, the inbound traffic is accurately routed to the destination by Ztunnel. The above is the flow of L4 traffic hijacking and routing between nodes in Ambient mode.</p>
<h2 id="summary">Summary</h2>
<p>For demonstration purposes, this article shows the paths of L4 network access packets for services on different nodes, even if the paths are similar for two services on the same node. Istio’s Ambient mode is still in its infancy, and during my testing, I also found that the EDS in the exported Envoy configuration was missing the cluster_name field. After understanding the L4 traffic path, I will share the L7 traffic path in Ambient mode in the future. Stay tuned.</p>
<hr>
<p>If you’re new to service mesh and Kubernetes security, we have a bunch of free online courses <a href="https://tetr8.io/academy" title="available at Tetrate Academy" target="_blank" rel="noopener">available at Tetrate Academy</a>
 that will quickly get you up to speed with Istio and Envoy.</p>
<p>If you’re looking for a fast way to get to production with Istio, check out <a href="https://tetr8.io/tid" title="Tetrate Istio Distribution (TID)" target="_blank" rel="noopener">Tetrate Istio Distribution (TID)</a>
 . TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient <a href="https://tetr8.io/tsb" title="here" target="_blank" rel="noopener">here</a>
 , or <a href="https://tetr8.io/contact" title="contact us for a quick demo" target="_blank" rel="noopener">contact us for a quick demo</a>
 .</p>
<p><em>This blog was originally published at <a href="https://tetrate.io/blog/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh/" title="tetrate.io" target="_blank" rel="noopener">tetrate.io</a>
.</em></p>

          </div>

          
          

          <div class="col-12 mb-4">
            <div class="border-bottom">
            


<p class="edit-page">
<a href="https://github.com/rootsongjc/website/edit/master//blog/ambient-mesh-l4-traffic-path/index.md">
  <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit this page
  </a>
</p>


            </div>
          </div>
          
          <div class="col-12">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light">
              
              <a href="/en/tags/istio" class="badge"> 
                  Istio</a> 
              <a href="/en/tags/ambient-mesh" class="badge">  
                  Ambient Mesh</a> 
              <a href="/en/tags/ztunnel" class="badge">  
                  Ztunnel</a> 
              <a href="/en/tags/envoy" class="badge">  
                  Envoy</a> </li>
          </div>

          
          
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://jimmysong.io/en/blog/the-future-of-istio/" data-toggle="tooltip" data-placement="top" title="The Future of Istio: the Path to Zero Trust Security">&larr; Previous Post</a>
</li>
 
<li class="next">
<a href="https://jimmysong.io/en/blog/understanding-the-tls-encryption-in-istio/" data-toggle="tooltip" data-placement="top" title="How Istio’s mTLS Traffic Encryption Works as Part of a Zero Trust Security Posture">Next Post &rarr;</a>
</li>

</ul>
</div>


          
          
          <div class="col-12">
          
           <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="en"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

          
          </div>
        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 sidebar">
      <!-- recommend -->
      

<div class="bg-white md-4">
  <p class="sidebar-title">
  Related article
  </p>
  <!-- post-item -->
  
  <div class="media border-bottom border-color pb-3 mb-3">
    <a href="/en/blog/why-istio-need-spire/"><img class="mr-3 post-thumb-sm" src="/images/banner/spiffe.jpg" alt="blog banner"></a>
    <div class="media-body">
      <a href="/en/blog/why-istio-need-spire/">
        <p class="mt-0">Why Would You Need Spire for Authentication With Istio?</p>
      </a>
      June 29, 2022
    </div>
  </div>
  
  <div class="media border-bottom border-color pb-3 mb-3">
    <a href="/en/blog/istio-service-mesh-book/"><img class="mr-3 post-thumb-sm" src="/images/banner/istio-book.jpg" alt="blog banner"></a>
    <div class="media-body">
      <a href="/en/blog/istio-service-mesh-book/">
        <p class="mt-0">In-Depth Understanding of Istio: Announcing the Publication of a New Istio Book</p>
      </a>
      June 15, 2022
    </div>
  </div>
  
</div>


      <!-- /recommend -->
      <!-- toc -->
      
<div class="bg-white py-4 box-shadow mb-4 sticky-top aside-toc d-none d-sm-block">
    <p class="sidebar-title">
    Table of content
    </p>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#principles">Principles</a></li>
        <li><a href="#what-is-tproxy">What Is tproxy?</a></li>
        <li><a href="#what-is-hbone">What Is HBONE?</a></li>
      </ul>
    </li>
    <li><a href="#environment">Environment</a></li>
    <li><a href="#outbound-traffic-intercepting">Outbound Traffic Intercepting</a>
      <ul>
        <li><a href="#check-the-routing-rules-on-node-a">Check The Routing Rules On Node A</a></li>
        <li><a href="#check-the-routing-rules-on-ztunnel-a">Check The Routing Rules On Ztunnel A</a></li>
      </ul>
    </li>
    <li><a href="#outbound-traffic-routing-on-ztunnel-a">Outbound Traffic Routing On Ztunnel A</a>
      <ul>
        <li><a href="#ztunnel_outbound-listener">Ztunnel_outbound Listener</a></li>
        <li><a href="#sleep-cluster">Sleep Cluster</a></li>
        <li><a href="#endpoints-of-the-sleep-cluster">Endpoints of The Sleep Cluster</a></li>
        <li><a href="#establishing-an-hbone-tunnel-through-envoys-internal-listener">Establishing an HBONE Tunnel Through Envoy’s Internal Listener</a></li>
        <li><a href="#hbone-tunnel-endpoints-for-the-sleep-cluster">HBONE Tunnel Endpoints For The Sleep Cluster</a></li>
      </ul>
    </li>
    <li><a href="#inbound-traffic-intercepting">Inbound Traffic Intercepting</a>
      <ul>
        <li><a href="#check-the-routing-rules-on-node-b">Check the Routing Rules on Node B</a></li>
        <li><a href="#check-the-routing-rules-on-ztunnel-b-pod">Check The Routing Rules On Ztunnel B Pod</a></li>
      </ul>
    </li>
    <li><a href="#inbound-traffic-routing-on-ztunnel-b">Inbound Traffic Routing On Ztunnel B</a>
      <ul>
        <li><a href="#ztunnel_inbound-listener">Ztunnel_inbound Listener</a></li>
        <li><a href="#virtual_inbound-cluster">Virtual_inbound Cluster</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
</div>

      <!-- /toc -->
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>



      
    

<footer>
  
  <div class="footer bg-footer section-sm border-bottom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-sm-8 mb-5 mb-lg-0">
          
          <h4 class="text-white mb-5 text-uppercase">Contact</h4>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s Twitter</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-twitter-qr-code.webp" width="128px" alt="footer image"></li>
            
            
            
          
        </div>
        
        

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">Blog</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/primary-remote-istio-ingress-gateway-mtls/">Deciphering Istio Multi-Cluster Authentication &amp; mTLS Connection</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/enhancing-istio-with-tis-comprehensive-installation-and-monitoring-guide/">Enhancing Istio with TIS: Comprehensive Installation and Monitoring Guide</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/introducing-istio-advisor-plus-gpt/">Introducing Istio Advisor Plus GPT</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">links</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener">Awesome Cloud Native</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener">Cloud Native Community(China)</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener">Tetrate - Service Mesh Company</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://docs.tetrate.io/istio-distro/" target="_blank" rel="noopener">Tetrate Istio Distro</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">Courses</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener">Envoy Fundamentals</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener">Istio Fundamentals</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">new notice</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/cloud-native-public-library/">Announcement of Cloud Native Library</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/tetrate-recruit/">The Enterprise Service Mesh company Tetrate is hiring</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/tetrate-istio-fundamental-courses/">Tetrate Academy Releases Free Istio Fundamentals Course</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer">
    <div class="container">
      <div class="row">
        <div class="col-sm-9 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-3 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-twitter "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" rel="noopener"><i class="fa fa-github "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-linkedin "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="mailto:jimmysong@jimmysong.io" target="_blank" rel="noopener"><i class="fa fa-envelope "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="/blog/index.xml" target="_blank" rel="noopener"><i class="fa fa-rss "></i></a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script>
    anchors.add()
</script>




<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, 'Copied')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>




<script>
tocbot.init({
  
  tocSelector: '.aside-toc #TableOfContents',
  
  contentSelector: '.content',
  
  headingSelector: 'h1, h2, h3, h4',
  
  hasInnerContainers: false,
  collapseDepth: 3
});
</script>












<script src="/js/wowchemy-search.min.0b3293fc75f976f49fb5a3d247c91f2e.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content">
      <div class="search-hit-name">
        <div class="article-metadata search-hit-type">{{relpermalink}}</div>
        <a href="{{relpermalink}}">{{title}}</a>
        <p class="search-hit-description">{{snippet}}</p>
      </div>
    </div>
  </div>
</script>


</body>

</html>
