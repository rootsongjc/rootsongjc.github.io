<svg xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" width="1505" height="442" version="1.1" viewBox="-248 364 1505 442"><defs><marker id="FilledArrow_Marker" stroke-linejoin="miter" stroke-miterlimit="10" color="#000" markerHeight="8" markerUnits="strokeWidth" markerWidth="10" orient="auto" overflow="visible" viewBox="-1 -4 10 8"><g><path fill="currentColor" stroke="currentColor" stroke-width="1" d="M 8 0 L 0 -3 L 0 3 Z"/></g></marker><marker id="FilledArrow_Marker_2" stroke-linejoin="miter" stroke-miterlimit="10" color="#00fa00" markerHeight="6" markerUnits="strokeWidth" markerWidth="7" orient="auto" overflow="visible" viewBox="-1 -3 7 6"><g><path fill="currentColor" stroke="currentColor" stroke-width="1" d="M 4.8 0 L 0 -1.8 L 0 1.8 Z"/></g></marker></defs><g id="ambient-traffic-on-the-same-node-l4" fill="none" fill-opacity="1" stroke="none" stroke-dasharray="none" stroke-opacity="1"><title>ambient-traffic-on-the-same-node-l4</title><rect width="1505" height="442" x="-248" y="364" fill="#fff"/><g id="ambient-traffic-on-the-same-node-l4_Layer_1"><title>Layer 1</title><g id="Graphic_34"><path stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M -217 387 L 320.5 387 C 322.70914 387 324.5 388.79086 324.5 391 L 324.5 714.5 C 324.5 716.7091 322.70914 718.5 320.5 718.5 L -217 718.5 C -219.20914 718.5 -221 716.7091 -221 714.5 L -221 391 C -221 388.79086 -219.20914 387 -217 387 Z"/><text fill="#000" transform="translate(-216 392)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Node A</tspan></text></g><g id="Graphic_33"><rect width="425.315" height="34.275" x="-164.034" y="659.256" fill="#dadada"/><text fill="#000" transform="translate(-159.0339 667.1698)"><tspan x="150.617" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Kubernetes CNI</tspan></text></g><g id="Graphic_32"><rect width="425.315" height="34.275" x="-164.034" y="613.12" fill="#dadada"/><text fill="#000" transform="translate(-159.0339 621.03324)"><tspan x="176.849" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Istio CNI</tspan></text></g><g id="Graphic_31"><rect width="425.315" height="38.672" x="-164.034" y="556.208" fill="#666"/><text fill="#fff" transform="translate(-159.0339 566.32005)"><tspan x="185.729" y="15" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Pod A</tspan></text></g><g id="Graphic_30"><path stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 689.4616 387 L 1226.9616 387 C 1229.1707 387 1230.9616 388.79086 1230.9616 391 L 1230.9616 714.5 C 1230.9616 716.7091 1229.1707 718.5 1226.9616 718.5 L 689.4616 718.5 C 687.2524 718.5 685.4616 716.7091 685.4616 714.5 L 685.4616 391 C 685.4616 388.79086 687.2524 387 689.4616 387 Z"/><text fill="#000" transform="translate(690.4616 392)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Node B</tspan></text></g><g id="Graphic_29"><rect width="425.315" height="34.275" x="753.244" y="659.256" fill="#dadada"/><text fill="#000" transform="translate(758.2444 667.1698)"><tspan x="150.617" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Kubernetes CNI</tspan></text></g><g id="Graphic_28"><rect width="425.315" height="34.275" x="753.244" y="613.12" fill="#dadada"/><text fill="#000" transform="translate(758.2444 621.03324)"><tspan x="176.849" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Istio CNI</tspan></text></g><g id="Graphic_27"><rect width="425.315" height="38.672" x="753.244" y="556.208" fill="#666"/><text fill="#fff" transform="translate(758.2444 566.32005)"><tspan x="185.433" y="15" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Pod B</tspan></text></g><g id="Group_24"><g id="Graphic_26"><path fill="#ff8080" d="M 1116.0166 556.20806 L 1116.0166 533.3465 L 1147.288 521.9329 L 1178.5594 533.3465 L 1178.5594 556.20806 Z"/></g><g id="Graphic_25"><text fill="#fff" transform="translate(1129.496 532.76006)"><tspan x="0" y="15" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">9080</tspan></text></g></g><g id="Graphic_23"><path fill="#456bb0" d="M -119.50591 453 L -3.5059135 453 C -1.2967745 453 .4940865 454.79086 .4940865 457 L .4940865 501 C .4940865 503.20914 -1.2967745 505 -3.5059135 505 L -119.50591 505 C -121.71505 505 -123.50591 503.20914 -123.50591 501 L -123.50591 457 C -123.50591 454.79086 -121.71505 453 -119.50591 453 Z"/><text fill="#fff" transform="translate(-118.50591 469.26794)"><tspan x="22.624" y="16" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">ztunnel A</tspan></text></g><g id="Group_18"><g id="Graphic_20"><path fill="#456bb0" d="M 793.1466 451.693 L 909.1466 451.693 C 911.3557 451.693 913.1466 453.48386 913.1466 455.693 L 913.1466 499.693 C 913.1466 501.90214 911.3557 503.693 909.1466 503.693 L 793.1466 503.693 C 790.9375 503.693 789.1466 501.90214 789.1466 499.693 L 789.1466 455.693 C 789.1466 453.48386 790.9375 451.693 793.1466 451.693 Z"/><text fill="#fff" transform="translate(794.1466 467.96094)"><tspan x="22.328" y="16" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">ztunnel B</tspan></text></g><g id="Graphic_19"><path fill="#ff8080" d="M 787.5196 502.386 L 764.6581 502.386 L 753.2444 477.693 L 764.6581 453 L 787.5196 453 Z"/><text fill="#fff" transform="translate(767.8757 497.386) rotate(-90)"><tspan x=".233" y="13" fill="#fff" font-family="Helvetica Neue" font-size="14" xml:space="preserve">15008</tspan></text></g></g><g id="Line_17"><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" marker-end="url(#FilledArrow_Marker)" d="M 202.76966 541.30514 C 125.93984 540.0874 -91.27048 535.4202 -158.8267 520.8955 C -203.21473 511.35203 -171.7759 499.96484 -133.19644 491.4726"/></g><g id="Line_16"><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" marker-end="url(#FilledArrow_Marker)" d="M 913.1466 476.0663 C 948.1104 476.46077 992.9128 479.1239 1034.0735 488.0597 C 1076.4802 497.266 1104.9421 510.9424 1122.7219 522.21794"/></g><g id="Group_11"><g id="Graphic_13"><path fill="#ff8080" d="M 198.73824 555.9003 L 198.73824 533.03875 L 230.00966 521.6251 L 261.28107 533.03875 L 261.28107 555.9003 Z"/></g><g id="Graphic_12"><text fill="#fff" transform="translate(207.76966 532.4523)"><tspan x="0" y="15" fill="#fff" font-family="Helvetica Neue" font-size="16" xml:space="preserve">15001</tspan></text></g></g><g id="Graphic_10"><text fill="#000" transform="translate(-117.53844 409)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">DaemonSets ztunnel</tspan> <tspan x="0" y="33.448" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">hostNetwork: true</tspan></text></g><g id="Graphic_9"><rect width="146.624" height="28.448" x="-141.121" y="517.089" fill="#fff"/><text fill="#000" transform="translate(-136.12069 522.0888)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">cross-netns socket</tspan></text></g><g id="Line_8"><line x1=".494" x2="740.357" y1="478.903" y2="477.74" stroke="#00fa00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" marker-end="url(#FilledArrow_Marker_2)"/></g><g id="Graphic_7"><rect width="67.792" height="29.464" x="465.736" y="463.386" fill="#fff"/><text fill="#000" transform="translate(470.7365 468.3863)"><tspan x="0" y="16" fill="#000" font-family="Helvetica Neue" font-size="16" font-weight="bold" xml:space="preserve">HBONE</tspan></text></g><g id="Graphic_6"><rect width="134.48" height="28.448" x="982.455" y="477.58" fill="#fff"/><text fill="#000" transform="translate(987.4547 482.58035)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">To Pod B IP:9080</tspan></text></g><g id="Graphic_69"><text fill="#000" transform="translate(361.10717 426.4319)"><tspan x="0" y="16" fill="#000" font-family="Helvetica Neue" font-size="16" font-weight="bold" xml:space="preserve">Destination</tspan> <tspan y="16" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">: </tspan> <tspan y="16" fill="#b1001c" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Node B IP</tspan> <tspan y="16" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:15008</tspan></text></g><g id="Graphic_70"><text fill="#000" transform="translate(361.10717 399.37723)"><tspan x="0" y="16" fill="#000" font-family="Helvetica Neue" font-size="16" font-weight="bold" xml:space="preserve">Source</tspan> <tspan y="16" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">: </tspan> <tspan y="16" fill="#b1001c" font-family="Helvetica Neue" font-size="16" xml:space="preserve">ztunnel A IP</tspan> <tspan y="16" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:Ephemeral Port</tspan></text></g><g id="Group_79"><g id="Graphic_71"><text fill="#000" transform="translate(364.26717 504.3614)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:method: CONNECT</tspan></text></g><g id="Graphic_72"><text fill="#000" transform="translate(364.26717 532.8094)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:scheme: https</tspan></text></g><g id="Graphic_73"><text fill="#000" transform="translate(364.26717 561.2574)"><tspan x="0" y="17" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:authority: </tspan> <tspan y="17" fill="#b1001c" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Po</tspan> <tspan y="17" fill="#b1001c" font-family="PingFang SC" font-size="16" xml:space="preserve">d B IP</tspan> <tspan y="17" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:9080</tspan></text></g><g id="Graphic_74"><text fill="#000" transform="translate(364.26717 593.2574)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:path: /api/v1/users?id=123</tspan></text></g><g id="Graphic_75"><text fill="#000" transform="translate(364.26717 621.7054)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">x-envoy-original-dst-host: </tspan> <tspan y="15" fill="#b1001c" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Pod B IP</tspan> <tspan y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">:9080</tspan></text></g><g id="Graphic_76"><text fill="#000" transform="translate(364.82234 650.1534)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">x-forwarded-proto: hbone</tspan></text></g><g id="Graphic_77"><text fill="#000" transform="translate(364.26717 678.6014)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">x-istio-attributes: ...</tspan></text></g><g id="Graphic_78"><text fill="#000" transform="translate(364.82234 707.0494)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">x-istio-auth-userinfo: ...</tspan></text></g></g><g id="Graphic_80"><path stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M 666.1072 562.40706 C 666.1072 540.13907 662.1702 537.3841 633.4115 515.34644 L 633.1077 515.1184 C 604.1971 492.85044 603.8964 492.85044 574.2263 492.85044 C 534.7199 492.85044 356.10717 492.85044 356.10717 492.85044 L 356.10717 727.9184 L 666.1072 727.9184 L 666.1072 562.40706 Z M 666.1072 561.2599 C 666.1072 540.13907 665.8034 540.13907 603.8964 540.13907 L 603.8964 540.13907 C 603.8964 493.0808 603.8964 492.85044 576.0429 492.85044"/></g><g id="Graphic_82"><text fill="#000" transform="translate(-216 735.4974)"><tspan x="0" y="15" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Iptables redirect the packets to the ports that ztunnel listening.</tspan></text></g><g id="Graphic_81"><text fill="#000" transform="translate(-216 763.9454)"><tspan x="0" y="17" fill="#000" font-family="Helvetica Neue" font-size="16" xml:space="preserve">Istio CNI will create a cross-netns socket for each Pod that listen on port 15001 </tspan> <tspan y="17" fill="#000" font-family="PingFang SC" font-size="16" xml:space="preserve">(outbound socket), 15006 (plaintext socket) and 15008 (HBONE socket).</tspan></text></g></g></g></svg>