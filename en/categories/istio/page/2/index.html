<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Istio Column - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="Welcome to the Istio Column, your comprehensive resource for all things related to the Istio service mesh. I cover a wide range of topics from introductory to advanced usage, including service discovery, load balancing, traffic management, policy enforcement, and observability. Whether you are a beginner or an experienced user, you will find valuable content here. ">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/categories/istio/" />
  <meta property="og:title" content="Istio Column | Jimmy Song" />
  <meta property="twitter:title" content="Istio Column | Jimmy Song" />

  
  <meta property="og:description" content="Welcome to the Istio Column, your comprehensive resource for all things related to the Istio service mesh. I cover a wide range of topics from introductory to advanced usage, including service discovery, load balancing, traffic management, policy enforcement, and observability. Whether you are a beginner or an experienced user, you will find valuable content here. " />
  <meta property="twitter:description" content="Welcome to the Istio Column, your comprehensive resource for all things related to the Istio service mesh. I cover a wide range of topics from introductory to advanced usage, including service discovery, load balancing, traffic management, policy enforcement, and observability. Whether you are a beginner or an experienced user, you will find valuable content here. " />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    
                  
                
              
              
              
                
                  
                    
                    <a class="nav-link" href="/categories/istio/">中文</a>
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>Search</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>Search</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="Close"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="Input the keyword">
        
        <div class="mt-4">
          <span>Search type: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">All</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">Blog</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">Book</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">Notice</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Istio Column
                </p>
                <p class="page-description">
                    Welcome to the Istio Column, your comprehensive resource for all things related to the Istio service mesh. I cover a wide range of topics from introductory to advanced usage, including service discovery, load balancing, traffic management, policy enforcement, and observability. Whether you are a beginner or an experienced user, you will find valuable content here.
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/preserve-source-ip-in-istio/">Maintaining Traffic Transparency: Preserving Client Source IP in Istio</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Feb 28, 2024</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Maintaining Traffic Transparency: Preserving Client Source IP in Istio', 'This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.', '\nThis blog post analyzes the challenges of server-side obtaining the client source IP in the Istio service mesh and provides solutions. The following topics will be covered:\n\n- Reasons for the loss of source IP during packet transmission.\n- How to identify the client source IP.\n- Strategies for passing source IP in north-south and east-west requests.\n- Handling methods for HTTP and TCP protocols.\n\n## The Importance of Preserving Source IP\n\nThe main reasons for preserving the client source IP include:\n\n- **Access Control Policies**: Performing authentication or security policies based on source IP.\n- **Load Balancing**: Implementing request routing based on the client IP.\n- **Data Analysis**: Access logs and monitoring metrics containing the actual source address, aiding developers in analysis.\n\n## Meaning of Preserving Source IP\n\nPreserving the source IP refers to avoiding the situation where the actual client source IP is replaced as the request goes out from the client, and passes through a load balancer or reverse proxy.\n\nHere is an example process of source IP address lost:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant LB as Load Balancer\n    participant IG as Ingress Gateway\n    participant S as Server\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Altered Request (IP Changed)\n    IG-\u003e\u003eS: Forwarded Request\n    Note over IG,S: Source IP Lost\n\u0060\u0060\u0060\n\n![Mermaid Diagram](9a331cc374c51421ecb64e58b25a6c4d.svg)\n\nThe above diagram represents the most common scenario. This article considers the following cases:\n\n1. North-South Traffic: Clients accessing servers through a load balancer (gateway)\n   1. Single-tier gateway\n   2. Multi-tier gateways\n2. East-West Traffic: Service-to-service communication within the mesh\n3. Protocols: HTTP and TCP\n\n## How to Confirm Client Source IP?\n\nIn the Istio service mesh, Envoy proxies typically add the client IP to the \u0022X-Forwarded-For\u0022 header of HTTP requests. Here are the steps to confirm the client IP:\n\n1. **Check the X-Forwarded-For Header**: It contains the IP addresses of various proxies along the request path.\n2. **Select the Last IP**: Usually, the last IP is the client IP closest to the server.\n3. **Verify the IP\u0027s Trustworthiness**: Check the trustworthiness of the proxy servers.\n4. **Use X-Envoy-External-Address**: Envoy can set this header, which includes the real client IP.\n\nFor more details, refer to the Envoy documentation on the [\u0060x-forwarded-for\u0060 header](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#config-http-conn-man-headers-x-forwarded-for). For TCP\/IP connections, you can parse the client IP from the protocol field.\n\n## Testing Environment\n\n**GKE**\n\n- Client Version: v1.28.4\n- Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3\n- Server Version: v1.27.7-gke.1121000\n\n**Istio**\n\n- Client version: 1.20.1\n- Control plane version: 1.20.1\n- Data plane version: 1.20.1 (12 proxies)\n\n**CNI**\n\nWe use Cilium CNI but have not enabled the kube-proxy-less mode.\n\n- cilium-cli: v0.15.18 compiled with go1.21.5 on darwin\/amd64\n- cilium image (default): v1.14.4\n- cilium image (stable): unknown\n- cilium image (running): 1.14.5\n\n**Node**\n\n| Node Name                              | Internal IP | Remarks                   |\n| --------------------------------------| ----------- | --------------------------|\n| gke-cluster1-default-pool-5e4152ba-t5h3 | 10.128.0.53 |                          |\n| gke-cluster1-default-pool-5e4152ba-ubc9 | 10.128.0.52 |                          |\n| gke-cluster1-default-pool-5e4152ba-yzbg | 10.128.0.54 | Ingress Gateway Pod Node  |\n\nPublic IP of the local client computer used for testing: \u0060123.120.247.15\u0060\n\n## Deploying Test Example\n\nThe following diagram illustrates the testing approach:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant LB as Load Balancer\n    participant IG as Ingress Gateway\n    participant S as Echo Server\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Forward Request \n    IG-\u003e\u003eS: Forwarded Request\n\u0060\u0060\u0060\n\n![Mermaid Diagram](5f7a7c047a92dbcba5c733f206727c6a.svg)\n\nFirst, deploy Istio according to the [Istio documentation](https:\/\/istio.io\/latest\/docs\/setup\/install\/), and then enable sidecar auto-injection for the default namespace:\n\n\u0060\u0060\u0060bash\nkubectl label namespace default istio-injection=enabled\n\u0060\u0060\u0060\n\nDeploy the \u0060echo-server\u0060 application in Istio:\n\n\u0060\u0060\u0060bash\nkubectl create deployment echo-server --image=registry.k8s.io\/echoserver:1.4\nkubectl expose deployment echo-server --name=clusterip --port=80 --target-port=8080\n\u0060\u0060\u0060\n\nCreate an Ingress Gateway:\n\n\u0060\u0060\u0060bash\ncat \u003e config.yaml \u003c\u003cEOF\napiVersion: networking.istio.io\/v1beta1\nkind: Gateway\nmetadata:\n  name: clusterip-gateway\nspec:\n  selector:\n    istio: ingressgateway # Choose the appropriate selector for your environment\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - \u0022clusterip.jimmysong.io\u0022 # Replace with the desired hostname\n---\napiVersion: networking.istio.io\/v1beta1\nkind: VirtualService\nmetadata:\n  name: clusterip-virtualservice\nspec:\n  hosts:\n    - \u0022clusterip.jimmysong.io\u0022 # Replace with the same hostname as in the Gateway\n  gateways:\n    - clusterip-gateway # Use the name of the Gateway here\n  http:\n    - route:\n        - destination:\n            host: clusterip.default.svc.cluster.local # Replace with the actual hostname of your Service\n            port:\n              number: 80 # Port of the Service\nEOF\nkubectl apply -f config.yaml\n\u0060\u0060\u0060\n\nView the Envoy logs in the Ingress Gateway:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/istio-ingressgateway -n istio-system\n\u0060\u0060\u0060\n\nView the Envoy logs in the Sleep Pod:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/sleep -n default -c istio-proxy\n\u0060\u0060\u0060\n\nView the Envoy logs in the Echo Server:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/echo-server -n default -c istio-proxy\n\u0060\u0060\u0060\n\nGet the public IP of the gateway:\n\n\u0060\u0060\u0060bash\nexport GATEWAY_IP=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0027{.status.loadBalancer.ingress[0].ip}\u0027)\n\u0060\u0060\u0060\n\nTest locally using curl:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n### Resource IP\n\nAfter deploying the test application, you need to obtain the IP addresses of the following resources, which will be used in the upcoming experiments.\n\n**Pod**\n\nHere are the initial Pod IPs, but please note that as patches are applied to the Deployment, Pods may be recreated, and their names and IP addresses may change.\n\n| Pod Name                              | Pod IP      |\n| ------------------------------------- | ----------- |\n| echo-server-6d9f5d97d7-fznrq          | 10.32.1.205 |\n| sleep-9454cc476-2dskx                 | 10.32.3.202 |\n| istio-ingressgateway-6c96bdcd74-zh46d | 10.32.1.221 |\n\n**Service**\n\n| Service Name         | Cluster IP  | External IP   |\n| -------------------- | ----------- | ------------- |\n| clusterip            | 10.36.8.86  | -             |\n| sleep                | 10.36.14.12 | -             |\n| istio-ingressgateway | 10.36.4.127 | 35.188.212.88 |\n\n## North-South Traffic\n\nLet\u0027s first consider the scenario where the client is outside the Kubernetes cluster and accesses internal services through a load balancer.\n\n### Test 1: Cluster Traffic Policy, iptables Traffic Hijacking\n\nThis is the default situation after deploying the test application using the steps above, and it represents the commonly encountered scenario where the source IP address is said to be lost.\n\ncurl test:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n\n{{\u003chighlight text \u0022linenos=table,hl_lines=2 21 23\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip.jimmysong.io:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip.jimmysong.io\nuser-agent=curl\/8.4.0\nx-b3-parentspanid=03c124c5f910001a\nx-b3-sampled=1\nx-b3-spanid=103dc912ec14f3b4\nx-b3-traceid=140ffa034822077f03c124c5f910001a\nx-envoy-attempt-count=1\nx-envoy-internal=true\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\nx-forwarded-for=10.128.0.54\nx-forwarded-proto=http\nx-request-id=b3c05e22-594e-98da-ab23-da711a8f53ec\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n\n{{\u003c\/detail\u003e}}\n\nYou only need to focus on the \u0060client_address\u0060 and \u0060x-forwarded-for\u0060 results. Other information in the curl test results will be omitted in the following curl test results.\n\n{{\u003ccallout note Explanation\u003e}}\n\nMeaning of fields in the results:\n\n- \u0060client_address\u0060: The client IP address obtained through TCP\/IP protocol resolution, referred to as the remote address in Envoy.\n- \u0060x-forwarded-for\u0060: \u0060x-forwarded-for\u0060 (XFF) is a standard proxy header used to indicate the IP addresses that the request has passed through from the client to the server. A compliant proxy will add the IP address of the most recent client to the XFF list before proxying the request. See [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for details.\n\n{{\u003c\/callout\u003e}}\n\nFrom the test results, we can see that the source IP address becomes the IP address of the Ingress Gateway Pod\u0027s node (\u006010.128.0.54\u0060).\n\nThe following diagram shows the packet flow paths between the two Pods.\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph IngressGatewayPod[Ingress Gateway Pod]\nA[\u0022Downstream Remote (Ingress Gateway Node)\u003cbr\u003e10.128.0.54:56532\u0022] --\u003e B\n    B[\u0022Downstream Local (Ingresss Gateway Pod)\u003cbr\u003e10.32.1.221:8080\u0022]--\u003eC\n    C[\u0022Upstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:59842\u0022]\n    C --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\n    E[\u0022Downstream Remote (Ingress Gateway Pod)\u003cbr\u003e10.128.0.54:0\u0022] --\u003e F\n    F[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    G[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:60481\u0022]\n    H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    F --\u003e G\n    G --\u003e H\nend\nIngressGatewayPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](77c177b53601d1d83794cc1b2f4a8b5a.svg)\n\nFor this scenario, preserving the source IP is straightforward and is also a standard option provided by Kubernetes.\n\n### How is the Source IP Lost?\n\nThe following diagram shows how the source IP of the client is lost during the request process.\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\u003cbr\u003e123.120.247.15\n    participant LB as Load Balancer\u003cbr\u003e35.188.212.88\n    participant IG as Ingress Gateway\u003cbr\u003e10.32.1.221\n    participant S as Echo Server Pod\u003cbr\u003e10.32.1.205\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Altered Request (IP Changed)\u003cbr\u003eSNAT: 123.120.234.15 -\u003e 10.128.0.54\n    IG-\u003e\u003eS: Forwarded Request\n    Note over IG,S: Source IP Lost\n\u0060\u0060\u0060\n\n![Mermaid Diagram](708e3a4981b7deadfb203257e2ac5a64.svg)\n\nBecause the load balancer sends packets to any node in the Kubernetes cluster, SNAT is performed during this process, resulting in the loss of the client\u0027s source IP when it reaches the Server Pod.\n\n### How to Preserve the Client Source IP\n\nYou can control the load balancer to preserve the source IP by setting the \u0060externalTrafficPolicy\u0060 field in the service to \u0060Local\u0060.\n\n**externalTrafficPolicy**\n\n\u0060externalTrafficPolicy\u0060 is a standard [Service option](https:\/\/kubernetes.io\/docs\/tasks\/access-application-cluster\/create-external-load-balancer\/#preserving-the-client-source-ip) that defines whether incoming traffic to Kubernetes nodes is load-balanced and how it\u0027s load-balanced. \u0060Cluster\u0060 is the default policy, but \u0060Local\u0060 is typically used to preserve the source IP of incoming traffic to cluster nodes. \u0060Local\u0060 effectively disables load balancing on the cluster nodes so that traffic received by local Pods sees the source IP address.\n\n\u0060\u0060\u0060mermaid\ngraph TD;\n    A[Client Request] --\u003e|Sent to Service| B[Load Balancer]\n    B --\u003e|externalTrafficPolicy: Local| C[Node with Service Endpoint]\n    C --\u003e|Source IP Preserved| D[Service Handling Request]\n    B --\u003e|\u0022externalTrafficPolicy: Cluster (Default)\u0022| E[Any Node in Cluster]\n    E --\u003e|Source IP Altered| D\n\u0060\u0060\u0060\n\n![Mermaid Diagram](02f4d9919bbd6f3d5fc5682c3793896a.svg)\n\nIn other words, setting \u0060externalTrafficPolicy\u0060 to \u0060Local\u0060 allows packets to bypass kube-proxy on the nodes and reach the target Pod directly. However, most people do not set \u0060externalTrafficPolicy\u0060 when creating a Service in Kubernetes, so the default \u0060Cluster\u0060 policy is used.\n\nSince using the Local external traffic policy in Service can preserve the client\u0027s source IP address, why isn\u0027t it the default in Kubernetes?\n\nThe default setting of Kubernetes Service\u0027s \u0060externalTrafficPolicy\u0060 to \u0060Cluster\u0060 instead of \u0060Local\u0060 is primarily based on the following considerations:\n\n1. **Load Balancing**: Ensures even distribution of traffic across all nodes, preventing overload on a single node.\n2. **High Availability**: Allows traffic to be received by any node in the cluster, enhancing service availability.\n3. **Simplified Configuration**: The \u0060Cluster\u0060 mode reduces the complexity of network configurations.\n4. **Performance Optimization**: Avoids potential performance issues caused by preserving the client\u0027s source IP.\n5. **Universality**: Compatible with a variety of network environments and cluster configurations, suitable for a broader range of scenarios.\n\n### Test 2: Local Traffic Policy, iptables Traffic Hijacking\n\nSet the Ingress Gateway Service to use the Local external traffic policy:\n\n\u0060\u0060\u0060bash\nkubectl patch svc istio-ingressgateway -p \u0027{\u0022spec\u0022:{\u0022externalTrafficPolicy\u0022:\u0022Local\u0022}}\u0027 -n istio-system\n\u0060\u0060\u0060\n\nCurl test:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n\n{{\u003chighlight text \u0022linenos=table,hl_lines=2 21 23\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip.jimmysong.io:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip.jimmysong.io\nuser-agent=curl\/8.4.0\nx-b3-parentspanid=060c393adb561603\nx-b3-sampled=1\nx-b3-spanid=8df3e10078cc826b\nx-b3-traceid=cf26040ae9536702060c393adb561603\nx-envoy-attempt-count=1\nx-envoy-external-address=123.120.247.15\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\nx-forwarded-for=123.120.247.15\nx-forwarded-proto=http\nx-request-id=35bc2123-0971-9a9c-84c1-2aeee233a268\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nFrom the Envoy logs, we can see the current packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph IngressGatewayPod[Ingress Gateway Pod]\n    B[\u0022Downstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:8080\u0022]\n    C[\u0022Upstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:59842\u0022]\nA[\u0022Downstream Remote (Client)\u003cbr\u003e123.120.247.15:62650\u0022] --\u003e B\nB --\u003e C\nC --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\n    F[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    G[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:58639\u0022]\n    H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nE[\u0022Downstream Remote (Client)\u003cbr\u003e123.120.247.15:0\u0022] --\u003e F\nF --\u003e G\nG --\u003e H\nend\nIngressGatewayPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](bd32b793946c9c3457a8a10db33f395d.svg)\n\nThe client\u0027s source IP is correctly identified as \u0060123.120.247.15\u0060.\n\n## East-West Traffic\n\nIn the default Istio configuration, for east-west traffic as well, the server cannot obtain the correct client source IP.\n\n### Test 3: Local Traffic Policy, tproxy Traffic Hijacking\n\nChange the traffic interception method from iptables to [tproxy](\/en\/blog\/what-is-tproxy\/) for the Echo Server:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment -n default echo-server -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022sidecar.istio.io\/interceptionMode\u0022:\u0022TPROXY\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: At this point, the Pod for Echo Server will be recreated, and the new Pod\u0027s name is \u0060echo-server-686d564647-r7nlq\u0060, with an IP address of 10.32.1.140.\n\nCurl test:\n\n\u0060\u0060\u0060bash\nkubectl exec -it deployment\/sleep -it -- curl clusterip\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n{{\u003chighlight text \u0022linenos=table,hl_lines=2\u0022\u003e}}\nCLIENT VALUES:\nclient_address=10.32.3.202\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip\nuser-agent=curl\/8.5.0\nx-b3-parentspanid=3c07f3b87cc547dd\nx-b3-sampled=1\nx-b3-spanid=97844ebdde748bfc\nx-b3-traceid=90f57b0fb260dfbf3c07f3b87cc547dd\nx-envoy-attempt-count=1\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\nx-forwarded-proto=http\nx-request-id=e9b27bde-3cf6-9d8b-8f23-1cb0fa35d405\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nThe diagram below illustrates the packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph SleepPod[Sleep Pod]\nA[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:38394\u0022] --\u003e B\nB[\u0022Downstream Local (Clusterip Service)\u003cbr\u003e10.36.8.86:80\u0022] --\u003e C\nC[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:33786\u0022] --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\nE[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:33786\u0022] --\u003e F\nF[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022] --\u003e G\nG[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:34173\u0022] --\u003e H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022]\nend\nSleepPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](eb87f7cdfe68c1b653b431af7281f2c9.svg)\n\nThe client\u0027s IP is correctly identified as \u006010.32.3.202\u0060.\n\n### Test 4: Local Traffic Policy, iptables Traffic Hijacking\n\nRestore the traffic interception method in the Echo Server to redirect:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment -n default echo-server -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022sidecar.istio.io\/interceptionMode\u0022:\u0022REDIRECT\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: At this point, the Pod for the Echo Server will be recreated, and the new Pod\u0027s name is \u0060echo-server-6d9f5d97d7-bgpk6\u0060, with an IP address of 10.32.1.123.\n\nCurl test:\n\n\u0060\u0060\u0060bash\nkubectl exec -it deployment\/sleep -it -- curl clusterip\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n{{\u003chighlight text \u0022linenos=table,hl_lines=2\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip\nuser-agent=curl\/8.5.0\nx-b3-parentspanid=6123380e58ca0ce7\nx-b3-sampled=1\nx-b3-spanid=633848c0065ec91e\nx-b3-traceid=dbcda8b3673e70a46123380e58ca0ce7\nx-envoy-attempt-count=1\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\nx-forwarded-proto=http\nx-request-id=b05e07e1-08ba-9449-90a9-a4a98277a8c0\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nThe diagram below illustrates the packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph Sleep[Sleep Pod]\nA[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:34238\u0022] --\u003e B\nB[\u0022Downstream Local (Clusterip Service)\u003cbr\u003e10.36.8.86:80\u0022] --\u003e C\nC[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:52776\u0022] --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022]\nend\nsubgraph SourceIPApp[Echo Server Pod]\nE[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:52776\u0022] --\u003e F\nF[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022] --\u003e G\nG[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:49803\u0022] --\u003e H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022]\nend\nSleep --\u003eSourceIPApp\n\u0060\u0060\u0060\n\n![Mermaid Diagram](ae5e1e766d0262189226721772529ec8.svg)\n\nThe client\u0027s source IP is identified as \u0060127.0.0.6\u0060.\n\n## Summary for Single-Layer Proxy Scenario\n\nIn a single-tier proxy scenario, you only need to set the \u0060externalTrafficPolicy\u0060 of the Ingress Gateway\u0027s Service to \u0060Local\u0060 to preserve the client\u0027s source IP. Modifying the traffic interception mode of the target service to \u0060TPROXY\u0060 will preserve the source IP in east-west requests.\n\n## Multi-Layer Proxy\n\nIf traffic has already passed through multiple tiers of proxies before entering the Istio Mesh, each time traffic passes through a proxy, the proxy parses the HTTP traffic and appends its own IP address to the \u0060x-forwarded-for\u0060 header. You can use the \u0060numTrustedProxies\u0060 configuration to specify the number of trusted proxy hops, referring to the [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for how to determine the \u0060X-Forwarded-For\u0060 header and trusted client addresses.\n\nIn practice, it can be challenging to determine how many tiers of proxy traffic have passed through before reaching the Istio Mesh, but you can use the \u0060x-forwarded-for\u0060 header to understand the forwarding path of the traffic.\n\nThe diagram below shows how Envoy confirms the source IP based on the \u0060x-forwarded-for\u0060 header and \u0060xff_num_trusted_hops\u0060 (corresponding to the \u0060numTrustedProxies\u0060 configuration in Istio). See the [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for details.\n\n\u0060\u0060\u0060mermaid\ngraph TD\n    A[Start] --\u003e|use_remote_address is false| B[Check XFF]\n    A --\u003e|use_remote_address is true| G[Check xff_num_trusted_hops]\n    B --\u003e|XFF contains at least one IP| C[Use last IP in XFF]\n    B --\u003e|XFF is empty| D[Use immediate downstream IP]\n    G --\u003e|xff_num_trusted_hops \u003e 0| H[\u0022Use (N)th IP from right in XFF\u0022]\n    G --\u003e|xff_num_trusted_hops \u003c= 0| D\n    H --\u003e|XFF contains \u003e= N addresses| I[Use Nth address from right]\n    H --\u003e|XFF contains \u003c N addresses| D\n\u0060\u0060\u0060\n\n![Mermaid Diagram](b82caafefa304b53c996da072373043a.svg)\n\nExecute the following command to enable trusted proxy configuration for the Ingress Gateway:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{\\\u0022gatewayTopology\\\u0022:{\\\u0022numTrustedProxies\\\u0022: 2,\\\u0022forwardClientCertDetails\\\u0022:\\\u0022SANITIZE_SET\\\u0022}}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nWhen the Istio Gateway receives a request, it sets the \u0060X-Envoy-External-Address\u0060 header to the second-to-last address in your \u0060X-Forwarded-For\u0060 header in the curl command (\u0060numTrustedProxies: 2\u0060). According to Istio\u0027s documentation, the Gateway appends its own IP to the \u0060X-Forwarded-For\u0060 header before forwarding it to the service sidecar. However, in practice, only the client source IP and the External Gateway Pod IP are present in the header.\n\nYou can undo this patch by executing the following command:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\n## TCP Traffic\n\nThe method mentioned above for obtaining the client source IP using headers applies only to L7 networks. For L4 network TCP traffic, you can use the Proxy Protocol.\n\nThe Proxy Protocol is a network protocol that adds a header at the beginning of a TCP connection to pass along some metadata, such as the client\u0027s real IP address and port number, during the connection establishment. This is particularly useful for applications deployed behind load balancers (LB) because load balancers often change the original IP address of the client to the LB\u0027s address, making it difficult for the server to know the real client\u0027s IP. Many proxy software supports the Proxy Protocol, including [Envoy](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/listeners\/listener_filters\/proxy_protocol), HAProxy, NGINX, and others.\n\nYou can use the following command to patch the Ingress Gateway to support the Proxy Protocol:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{\\\\\u0022gatewayTopology\\\\\u0022:{\\\\\u0022proxyProtocol\\\\\u0022:{}}}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: Not all load balancers created by \u0060LoadBalancer\u0060 type Services in Kubernetes in public clouds support this configuration. For example, GKE does not support it. To enable Proxy Protocol on AWS NLB, refer to [this blog post](https:\/\/istio.io\/latest\/blog\/2020\/show-source-ip\/).\n\nIt\u0027s worth noting that Envoy does not recommend using the Proxy Protocol because it:\n\n- Only supports the TCP protocol.\n- Requires upstream hosts to support it.\n- May impact performance.\n\nFor Envoy\u0027s support of the Proxy Protocol, refer to [this documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/other_features\/ip_transparency#proxy-protocol).\n\n## Use Case Examples\n\nThe following are common scenarios for source IP addresses.\n\n### Access Control Based on Source IP Address\n\nIn Istio, you can configure access control policies based on source IP using the Ingress Gateway. This is achieved by setting the authorization policy for the Ingress Gateway to restrict access based on source IP addresses.\n\nThe following diagram shows the flow of traffic:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant P1 as Proxy 1\n    participant P2 as Proxy 2\n    participant Pn as Proxy N\n    participant IG as Ingress Gateway\n    participant S as Service\n\n    C-\u003e\u003e\u002bP1: Request with Source IP\n    P1-\u003e\u003e\u002bP2: Forward Request\n    P2-\u003e\u003e\u002bPn: Forward Request\n    Pn-\u003e\u003e\u002bIG: Forward Request\n    Note over IG: numTrustedProxies Set\n    IG-\u003e\u003e\u002bS: Forwarded Request\n    Note over IG: Authorization Policy Based on Source IP\n\u0060\u0060\u0060\n\n![Mermaid Diagram](635bc14feb9b6939b3319929849cd0b5.svg)\n\n#### Scenario Assumptions\n\nLet\u0027s assume a request passes through three proxies with IP addresses \u00601.1.1.1\u0060, \u00602.2.2.2\u0060, and \u00603.3.3.3\u0060. In the Ingress Gateway, \u0060numTrustedProxies\u0060 is set to 2, so Istio trusts the source IP as \u00602.2.2.2\u0060 (i.e., \u0060x-envoy-external-address\u0060).\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 -H \u0027X-Forwarded-For: 1.1.1.1,2.2.2.2,3.3.3.3\u0027 $GATEWAY_IP\n\u0060\u0060\u0060\n\n#### Blocking Specific Source IP\n\nIf you need to block requests from \u00602.2.2.2\u0060, you can use the following authorization policy:\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ingress-policy\n  namespace: istio-system\nspec:\n  selector:\n    matchLabels:\n      app: istio-ingressgateway\n  action: DENY\n  rules:\n    - from:\n        - source:\n            remoteIpBlocks:\n            - \u00222.2.2.2\/24\u0022\n\u0060\u0060\u0060\n\n#### Using the Ultimate Client IP\n\nIf you want to identify the client IP directly connected to the Istio Mesh (i.e., the last IP in \u0060x-forwarded-for\u0060, e.g., \u0060123.120.234.15\u0060), you need to configure it using \u0060ipBlocks\u0060:\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ingress-policy\n  namespace: istio-system\nspec:\n  selector:\n    matchLabels:\n      app: istio-ingressgateway\n  action: DENY\n  rules:\n    - from:\n        - source:\n            ipBlocks:\n            - \u0022123.120.234.15\/24\u0022\n\u0060\u0060\u0060\n\nThis approach, by configuring authorization policies for Istio\u0027s Ingress Gateway, allows for effective access control based on source IP. It enables administrators to set rules flexibly based on different requirements, such as blocking specific IPs or trusting the ultimate client IP, enhancing the security and flexibility of the services.\n\n#### Load Balancing Based on Source IP Address\n\nHere is an example configuration that shows how to use \u0060DestinationRule\u0060 to load balance based on source IP address:\n\n\u0060\u0060\u0060yaml\napiVersion: networking.istio.io\/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: example-destination-rule\nspec:\n  host: example-service\n  trafficPolicy:\n    loadBalancer:\n      consistentHash:\n        httpHeaderName: x-forwarded-for\n\u0060\u0060\u0060\n\nNote that if connecting directly to the Istio Ingress Gateway without going through another proxy, you may need to adjust \u0060httpHeaderName\u0060 or use a different hash key, such as \u0060useSourceIp\u0060 as shown below:\n\n\u0060\u0060\u0060yaml\nspec:\n  trafficPolicy:\n    loadBalancer:\n      consistentHash:\n        useSourceIp: true\n\u0060\u0060\u0060\n\n{{\u003ccallout note Notice\u003e}}\n\n- When using source IP addresses as keys for load balancing, make sure you understand how this may affect traffic distribution, especially if the source IP addresses are unevenly distributed.\n- As mentioned above, in some environments, the original source IP may be modified by network devices (such as load balancers or NAT devices), and you need to ensure that the \u0060x-forwarded-for\u0060 header or other corresponding mechanism accurately reflects the original client IP.\n\n{{\u003c\/callout\u003e}}\n\n## Summary\n\n- Preserving the source IP is crucial for implementing access control, load balancing, and data analysis.\n- Envoy proxies use the \u0060X-Forwarded-For\u0060 header to handle the client source IP in HTTP requests.\n- By setting \u0060externalTrafficPolicy\u0060 and choosing the appropriate traffic interception method (\u0060REDIRECT\u0060 or \u0060TPROXY\u0060), you can correctly obtain the client source IP in North-South and East-West traffic.\n- When dealing with traffic that passes through multiple tiers of proxies, configuring \u0060numTrustedProxies\u0060 is crucial.\n- For TCP traffic, the Proxy Protocol is an effective solution.\n\n## References\n\n- [x-forwarded-for - envoyproxy.io](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for)\n- [Proxy protocol on AWS NLB and Istio ingress gateway - istio.io](https:\/\/istio.io\/latest\/blog\/2020\/show-source-ip\/)\n- [Configuring Gateway Network Topology - istio.io](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/traffic-management\/network-topologies\/)\n- [IP Transparency - envoyproxy.io](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/other_features\/ip_transparency)\n- [Using Source IP - kubernetes.io](https:\/\/kubernetes.io\/docs\/tutorials\/services\/source-ip\/)\n- [Proxy Protocol - github.com](https:\/\/github.com\/haproxy\/haproxy\/blob\/master\/doc\/proxy-protocol.txt)\n\n---\n\n*This blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/istio-source-ip-transparency\/) .*\n', '\/en\/blog\/preserve-source-ip-in-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/primary-remote-istio-ingress-gateway-mtls/">Deciphering Istio Multi-Cluster Authentication &amp; mTLS Connection</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 16, 2024</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Deciphering Istio Multi-Cluster Authentication \u0026 mTLS Connection', 'This blog deeply analyzes the initial authentication and mTLS connection process of remote gateways in Istio\u0027s primary-remote deployment mode.', '\n## Introduction\n\nI often answer questions on [Istio\u0027s GitHub Discussions](https:\/\/github.com\/istio\/istio\/discussions), and recently, I came across a [discussion](https:\/\/github.com\/istio\/istio\/discussions\/48343) about Istio\u0027s primary-remote deployment, specifically regarding how the remote cluster\u0027s gateway initially authenticates to an external Istiod instance. This issue touches upon the core security mechanisms of service meshes in multi-cluster configurations, which I think merits more in-depth sharing in the community.\n\nIn the official Istio documentation on [Installing Primary-Remote on different networks](https:\/\/istio.io\/latest\/docs\/setup\/install\/multicluster\/primary-remote_multi-network\/), one of the steps is to [attach cluster2 as a remote cluster of cluster1](https:\/\/istio.io\/latest\/docs\/setup\/install\/multicluster\/primary-remote_multi-network\/#attach-cluster2-as-a-remote-cluster-of-cluster1). This process creates a Secret containing a kubeconfig configuration, which includes the certificates and tokens required to access the remote cluster (cluster2).\n\n\u0060\u0060\u0060yaml\n# This file is autogenerated, do not edit.\napiVersion: v1\nkind: Secret\nmetadata:\n  annotations:\n    networking.istio.io\/cluster: cluster2\n  creationTimestamp: null\n  labels:\n    istio\/multiCluster: \u0022true\u0022\n  name: istio-remote-secret-cluster2\n  namespace: istio-system\nstringData:\n  cluster2: |\n    apiVersion: v1\n    clusters:\n    - cluster:\n        certificate-authority-data: {CERTIFICATE}\n        server: {CLUSTER2-APISERVER-ADDRESS}\n      name: cluster2\n    contexts:\n    - context:\n        cluster: cluster2\n        user: cluster2\n      name: cluster2\n    current-context: cluster2\n    kind: Config\n    preferences: {}\n    users:\n    - name: cluster2\n      user:\n        token: {TOKEN}\n\u0060\u0060\u0060\n\nThe key role of this Secret is to enable Istio in the primary cluster (cluster1) to access the API server of the remote cluster, thereby obtaining service information. Additionally, in the remote cluster (cluster2), the Istiod service points to the primary cluster\u0027s Istiod service\u0027s LoadBalancer IP (ports 15012 and 15017), allowing cluster2 to communicate with the primary cluster\u0027s Istiod.\n\n## Visualizing Authentication\n\nSince both clusters share a CA (provided by the primary cluster) and the remote cluster can access its own API server, the Istiod in the primary cluster can validate requests from the remote cluster (cluster2). The following sequence diagram clearly shows this process:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant IG as Ingress Gateway (Remote Cluster)\n    participant K8s as Kubernetes API (Remote Cluster)\n    participant SA as Service Account (Remote Cluster)\n    participant Istiod as Istiod (Primary Cluster)\n\n    Note over IG: Startup\n    IG-\u003e\u003eK8s: Request Service Account Token\n    K8s-\u003e\u003eSA: Create\/Retrieve Token\n    SA--\u003e\u003eIG: Return Token\n    Note over IG: Token Mounted in Pod\n\n    IG-\u003e\u003eIstiod: Authenticate with Token\n    Note over Istiod: Validate Token\n    Istiod-\u003e\u003eIstiod: Generate mTLS Certificates\n    Istiod--\u003e\u003eIG: Send mTLS Certificates\n\n    Note over IG: Use mTLS Certificates for Secure Communication in Mesh\n\u0060\u0060\u0060\n\n![Mermaid Diagram](72dd4a02f2175fd6f9cc1128148b0bf7.svg)\n\n\n\nThis process is a key component of Istio\u0027s multi-cluster configuration, ensuring secure cross-cluster communication within the service mesh. As seen in this discussion, both the remote gateway and the services depend on the primary cluster\u0027s CA for initial mTLS authentication, providing a solid foundation for secure communication across the entire service mesh.\n\n## Conclusion\n\nIn this blog, we explored how the gateway in a remote cluster initially authenticates to an external Istiod in Istio\u0027s primary-remote deployment. We explained how to create a Secret containing a kubeconfig to allow Istio in the primary cluster to access the remote cluster\u0027s API and how shared CA and service account tokens ensure the security of mTLS authentication. This process secures cross-cluster communication within the service mesh, providing key insights for understanding and implementing Istio\u0027s multi-cluster configuration.\n\n---\n\n*This blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/istio-multi-cluster-authentication-mtls\/).*', '\/en\/blog\/primary-remote-istio-ingress-gateway-mtls\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This blog deeply analyzes the initial authentication and mTLS connection process of remote gateways in Istio&#39;s primary-remote deployment mode.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/enhancing-istio-with-tis-comprehensive-installation-and-monitoring-guide/">Enhancing Istio with TIS: Comprehensive Installation and Monitoring Guide</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 10, 2024</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Enhancing Istio with TIS: Comprehensive Installation and Monitoring Guide', 'In this blog, I’ll guide you through installing Tetrate Istio Subscription (TIS) and activating its monitoring add-on.', '\nIn this blog, I’ll guide you through installing [Tetrate Istio Subscription (TIS)](https:\/\/tetrate.io\/tetrate-istio-subscription\/) and activating its monitoring add-on.\n\n## Understanding Tetrate Istio Subscription\n\nTetrate Istio Subscription is a comprehensive, enterprise-grade product offered by Tetrate. It provides thoroughly tested Istio versions compatible with all major cloud platforms. Derived from the open-source Tetrate Istio Distro project, TIS adds extensive support to these builds, including optional FIPS-validated cryptographic modules and a range of tested add-ons and integrations.\n\n## Why Choose TIS?\n\nTIS is not a fork but an upstream distribution of Istio tailored for specific environments. Enhancements made to Istio are integrated upstream. Key benefits of TIS include:\n\n1. **Extended Support**: TIS offers 14 months of security update support.\n2. **Commercial Support**: TIS provides business support options for enterprise use cases, including compliance needs.\n3. **Ease of Management**: TIS simplifies installation and management processes.\n4. **Multi-Environment Adaptability**: TIS supports various cloud environments.\n5. **FIPS Validation**: TIS offers FIPS-validated versions for high-security requirements.\n\n[Visit the TIS docs for more information ›](https:\/\/docs.tetrate.io\/istio-subscription\/)\n\n## Pre-Installation Requirements\n\nBefore installing TIS and its plugins, you’ll need:\n\n- [Terraform](https:\/\/www.terraform.io\/) for importing dashboards into Grafana.\n- Credentials from Tetrate for installing TIS.\n  - tis_username\n  - tis_password\n\n## Installing Istio and Monitoring Addons\n\nFirst, check the supported Istio versions with TIS:\n\n\u0060\u0060\u0060\nhelm search repo tetratelabs\/base --versions\nNAME            CHART VERSION  APP VERSION    DESCRIPTION\ntetratelabs\/base1.20.1\u002btetrate01.20.1-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.20.0\u002btetrate01.20.0-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.19.5\u002btetrate01.19.5-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.19.4\u002btetrate01.19.4-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.19.3\u002btetrate01.19.3-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.18.6\u002btetrate01.18.6-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.18.5\u002btetrate01.18.5-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.18.3\u002btetrate01.18.3-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.17.8\u002btetrate01.17.8-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.17.6\u002btetrate01.17.6-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.16.7\u002btetrate01.16.7-tetrate0Helm chart for deploying Istio cluster resource...\ntetratelabs\/base1.16.6\u002btetrate01.16.6-tetrate0Helm chart for deploying Istio cluster resource...\n\u0060\u0060\u0060\n\nWe’ll install the latest Istio version, 1.20.1.\n\n\u0060\u0060\u0060bash\nexport TIS_USER=\u0022\u003ctis_username\u003e\u0022\nexport TIS_PASS=\u0022\u003ctis_password\u003e\u0022\n# Helm chart version\nexport VERSION=1.20.1\u002btetrate0\n# Image tag\nexport TAG=1.20.1-tetrate0\nkubectl create namespace istio-system\n\nkubectl create secret docker-registry tetrate-tis-creds \\\n    --docker-server=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --docker-username=${TIS_USER} \\\n    --docker-password=${TIS_PASS} \\\n    -n istio-system\n\n# Install Istio\nhelm install istio-base tetratelabs\/base -n istio-system \\\n    --set global.tag=${TAG} \\\n    --set global.hub=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --set \u0022global.imagePullSecrets[0]=tetrate-tis-creds\u0022 \\\n    --version ${VERSION}\n\nhelm install istiod tetratelabs\/istiod -n istio-system \\\n    --set global.tag=${TAG} \\\n    --set global.hub=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --set \u0022global.imagePullSecrets[0]=tetrate-tis-creds\u0022 \\\n    --version ${VERSION} \\\n    --wait\n\n# install ingress Gateway\nkubectl create namespace istio-ingress\n\nkubectl create secret docker-registry tetrate-tis-creds \\\n    --docker-server=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --docker-username=${TIS_USER} \\\n    --docker-password=${TIS_PASS} \\\n    -n istio-ingress\n\nhelm install istio-ingress tetratelabs\/istio-ingress -n istio-ingress \\\n    --set global.tag=${TAG} \\\n    --set global.hub=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --set \u0022global.imagePullSecrets[0]=tetrate-tis-creds\u0022 \\\n    --version ${VERSION} \\\n    --wait\n\n# Install TIS addon\nhelm install istio-monitoring-demo tis-addons\/istio-monitoring-demo --namespace tis --create-namespace\n\u0060\u0060\u0060\n\nPort forward the Grafana service and open it in your local browser: [http:\/\/localhost:3000](http:\/\/localhost:3000\/):\n\n\u0060\u0060\u0060bash\nkubectl port-forward --namespace tis svc\/grafana 3000:3000\n\u0060\u0060\u0060\n\nNote: Keep the port-forwarding command running, as we’ll need access to this port for importing the dashboard into Grafana.\n\n## Why TIS Monitoring Addon?\n\nThe Tetrate Istio Subscription (TIS) Monitoring Addon stands out by offering a tailored and advanced monitoring experience compared to standard Istio dashboards. It focuses on modern needs with four specialized dashboards, replacing outdated elements with relevant metrics. Key enhancements include a unified panel design, detailed service insights, and critical metrics like sidecar performance. Reserved for TIS customers, these dashboards reflect Tetrate’s commitment to providing value beyond basic support, ensuring a personalized and evolving monitoring solution. Choosing TIS Monitoring Addon means accessing a service that not only meets current needs but also adapts to future demands.\n\n## Installing Istio Monitoring Addons\n\nAfter logging in with the default user name and password admin\/admin, select Administration-Service accounts in the left navigation bar, and follow the instructions in the Grafana documentation to create a Service account with admin privilege.\n\n![Grafana Service Account](grafana-service-account.jpg)\n\nCreate a Service account for Grafana then use Terraform to import dashboards into Grafana:\n\n\u0060\u0060\u0060bash\ncat\u003e~\/.terraformrc\u003c\u003cEOF\ncredentials \u0022terraform.cloudsmith.io\u0022 {\n  token = \u0022tetrate\/tis-containers\/\u003ctis_password\u003e\u0022\n}\nEOF\n\n# Create a terraform module file\ncat\u003eistio-monitoring-grafana.tf\u003c\u003cEOF\nmodule \u0022istio_monitoring_grafana\u0022 {\n  source = \u0022terraform.cloudsmith.io\/tis-containers\/istio-monitoring-grafana\/tetrate\u0022\n  version = \u0022v0.2.0\u0022\n  gf_url  = \u0022http:\/\/localhost:3000\u0022\n  gf_auth = \u0022\u003cgrafana_service_account_token\u003e\u0022\n}\nEOF\n\n# Run the commands\nterraform init\nterraform plan\nterraform apply -auto-approve\n\u0060\u0060\u0060\n\nCongratulations, you have successfully imported four dashboards into Grafana:\n\n- Istio Workload Dashboard\n- Istio Service Dashboard\n- Istio Wasm Extension Dashboard\n- Istio Control Plan Dashboard\n\nHowever, some dashboards might not have data yet. Let’s generate some traffic in the mesh.\n\n## Testing the Monitoring\n\nDeploy the Bookinfo application and ingress gateway:\n\n\u0060\u0060\u0060bash\nkubectl create secret docker-registry tetrate-tis-creds \\\n    --docker-server=\u0022addon-containers.istio.tetratelabs.com\u0022 \\\n    --docker-username=${TIS_USER} \\\n    --docker-password=${TIS_PASS} \\\n    -n default\nkubectl label namespace default istio-injection=enabled\nkubectl apply -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.20\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml -n default\nkubectl apply -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.20\/samples\/bookinfo\/platform\/kube\/bookinfo-gateway.yaml -n default\n\u0060\u0060\u0060\n\nRetrieve the ingress gateway IP and generate traffic:\n\n\u0060\u0060\u0060bash\nexport GATEWAY_IP=$(kubectl -n istio-ingress get service istio-ingressgateway -o jsonpath=\u0027{.status.loadBalancer.ingress[0].ip}\u0027)\nfor i in $(seq 1 100);do curl http:\/\/$GATEWAY_IP\/productpage ; sleep 3;done\n\u0060\u0060\u0060\n\nNow, when you visit the Grafana dashboard, you will see monitoring data.\n\n![Grafana Dashboard](istio-workload-dashboard.jpg)\n\nIn addition, while importing these dashboards, we also imported the following alert rules:\n\n![Altering Rules](alerting-rules.jpg)\n\nYou can also define alert rules in Grafana, such as [integrating Telegram](https:\/\/grafana.com\/blog\/2023\/12\/28\/how-to-integrate-grafana-alerting-and-telegram\/) and Slack to send notifications.\n\n## Cleanup\n\nRun the following command to clean up the Bookinfo app and TIS:\n\n\u0060\u0060\u0060bash\nkubectl delete -f samples\/bookinfo\/platform\/kube\/bookinfo.yaml\nkubectl delete -f samples\/bookinfo\/networking\/bookinfo-gateway.yaml\nhelm uninstall istio-ingress -n istio-ingress\nhelm uninstall istio-monitoring-demo -n tis\nhelm uninstall istiod -n istio-system\nhelm uninstall istio-base -n istio-system\nkubectl delete namespace tis\nkubectl delete namespace istio-ingress\nkubectl delete namespace istio-system\n\u0060\u0060\u0060\n\n## Conclusion\n\nBy following these steps, you have successfully set up and tested monitoring in Istio using TIS. Enjoy the insights and advantages of enhanced monitoring in your Istio environment!\n\n---\n\n*This blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/enhancing-istio-with-tis-comprehensive-installation-and-monitoring-guide\/).*\n', '\/en\/blog\/enhancing-istio-with-tis-comprehensive-installation-and-monitoring-guide\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">In this blog, I’ll guide you through installing Tetrate Istio Subscription (TIS) and activating its monitoring add-on.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/istio-119-release/">What’s New in Istio 1.19: Gateway API and Beyond</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Nov 9, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('What’s New in Istio 1.19: Gateway API and Beyond', 'I’m delighted to present Istio’s most recent release—Istio 1.19. This blog will provide an overview of the updates bundled in this release.', '\nI’m delighted to present Istio’s most recent release—[Istio 1.19](https:\/\/istio.io\/latest\/news\/releases\/1.19.x\/announcing-1.19\/). This blog will provide an overview of the updates bundled in this release.\n\n## Gateway API: Revolutionizing Service Mesh\n\nOur[ previous blog](https:\/\/tetrate.io\/blog\/why-the-gateway-api-is-the-unified-future-of-ingress-for-kubernetes-and-service-mesh\/) highlighted the Gateway API’s potential to harmonize ingress gateways in Kubernetes and service mesh, opening doors to cross-namespace traffic support. With Istio’s official endorsement, the Gateway API takes center stage. While traditionally applied to north-south traffic (the ingress and egress of the mesh), it now extends its prowess to the realm of east-west traffic, the lifeblood within the mesh.\n\nIn Kubernetes, services wear multiple hats, handling tasks from service discovery and DNS to workload selection, routing and load balancing. Yet, control over these functions has been limited, with workload selection being the notable exception. The Gateway API changes the game, putting you in command of service routing. This introduces some overlap with Istio’s VirtualService, as both wield influence over traffic routing. Here’s a glimpse into three scenarios:\n\n1. **Internal Kubernetes Requests:** Without Istio, all internal traffic in Kubernetes takes the service route.\n2. **North-South Traffic:** By applying the Gateway API to the Ingress gateway, incoming traffic to Kubernetes follows xRoute (currently supporting HTTPRoute, TCPRoute and gRPCRoute) to services.\n3. **East-West Traffic:** Inside Istio, as traffic enters the data plane, xRoute of the Gateway API takes charge. It guides the traffic to either the original or a new destination service.\n\n![Figure 1: Traffic routing.](gateway-api-request.svg)\n\nThis dynamic fusion of the Gateway API with Istio not only refines service networking but also solidifies Istio’s significance in the Kubernetes ecosystem.\n\n## Gateway API for Service Mesh: A Deeper Dive\n\nAt its current experimental stage (as of v0.8.0), the Gateway API for Service Mesh introduces a fresh approach to configuring service mesh support in Kubernetes. It directly links individual route resources (such as HTTPRoute) with Service resources, streamlining the configuration process.\n\nHere are some key takeaways:\n\n**Experimental Stage:** As of version v0.8.0, the Gateway API for Service Mesh is still experimental. It’s advised not to use it in production environments.\n\n**Service and Route Association:** Unlike using Gateway and GatewayClass resources, individual route resources are linked directly with Service resources when configuring a service mesh.\n\n**Frontend and Backend Aspects of Service:** The Service’s frontend encompasses its name and cluster IP, while the backend consists of its collection of endpoint IPs. This distinction facilitates routing within a mesh without introducing redundant resources.\n\n**Route Attachment to Service:** Routes are attached to a Service to apply configuration to any traffic directed to that Service. The traffic follows the mesh’s default behavior if no Routes are attached.\n\n**Namespace Relationships**:\n\n- *Same Namespace:* A Route in the same Namespace as its Service, known as a producer route, is typically created by the workload creator to define acceptable usage. It affects all requests from any client of the workload across any Namespace.\n- *Different Namespaces:* A Route in a different Namespace than its Service, termed a consumer route, refines how a consumer of a given workload makes requests. This Route only influences requests from workloads in the same Namespace as the Route.\n\n![Figure 2: Producer Route and Consumer Route.](gateway-api-reference.svg)\n\n**Combining Routes:** Multiple Routes for the same Service in a single Namespace, whether producer or consumer routes, will be merged according to the Gateway API Route merging rules. This means defining distinct consumer routes for multiple consumers in the same Namespace is impossible.\n\n**Request Flow**:\n\n- A client workload initiates a request for a specific Service in a Namespace.\n- The mesh data plane intercepts the request and identifies the target Service.\n- Based on associated Routes, the request is allowed, rejected, or forwarded to the appropriate workload based on matching rules.\n\nBear in mind that, in the experimental stage, the Gateway API for Service Mesh may undergo further changes and is not recommended for production use.\n\nBut wait, there’s more! Our journey doesn’t end here – the support for ingress traffic using the API is rapidly heading toward General Availability, promising even more dynamic developments!\n\nLet’s delve further into additional enhancements in this release.\n\n## Ambient Mesh Enhancements\n\nThe Istio team has been tirelessly refining the ambient mesh, an innovative deployment model that offers an alternative to the traditional sidecar approach. If you haven’t explored ambient yet, now’s the perfect time to dive into the[ introduction blog post](https:\/\/istio.io\/latest\/blog\/2022\/introducing-ambient-mesh\/).\n\nWith this update, we’ve amplified support for \u0060ServiceEntry\u0060, \u0060WorkloadEntry\u0060, \u0060PeerAuthentication\u0060 and DNS proxying. Alongside, bug fixes and reliability enhancements ensure a seamless experience.\n\nRemember, the ambient mesh is in its alpha phase for this release. The Istio community eagerly awaits your feedback to propel it toward Beta.\n\n## Simplified Virtual Machine and Multicluster Experiences\n\nSimplicity is key, especially when working with Virtual Machines and Multicluster setups. In this release, we’ve made the address field optional in the \u0060WorkloadEntry\u0060 resources. This seemingly small adjustment promises to streamline your workflow significantly.\n\n## Elevated Security Configurations\n\nYou can now configure \u0060OPTIONAL_MUTUAL\u0060 for your Istio ingress gateway’s TLS settings, providing the flexibility of optional client certificate validation. Additionally, you can fine-tune your preferred cipher suites used for non-Istio mTLS traffic via \u0060MeshConfig\u0060.\n\nWith these updates, Istio 1.19 empowers you with greater control, flexibility and security in managing your service mesh.\n\nFeel free to explore these enhancements and share your experiences with the Istio community. For more details, refer to the[ official release notes](https:\/\/istio.io\/latest\/news\/releases\/1.19.x\/announcing-1.19\/).\n\nHappy meshing!\n\n---\n\nThis blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/whats-new-in-istio-1-19-gateway-api-and-beyond\/).\n', '\/en\/blog\/istio-119-release\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">I’m delighted to present Istio’s most recent release—Istio 1.19. This blog will provide an overview of the updates bundled in this release.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/ica-review/">A Month in Review: The Impact of Istio Certified Associate (ICA) Certification with Tetrate&#39;s Contribution</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Nov 8, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('A Month in Review: The Impact of Istio Certified Associate (ICA) Certification with Tetrate\u0027s Contribution', 'CNCF and Tetrate\u0027s Istio certification marks 1 month, boosting Kubernetes skills in microservices, security, and traffic management.', '\nCloud computing professionals, it\u0027s been a month since the **Istio Certified Associate (ICA) Certification** journey began. A collaboration between the Cloud Native Computing Foundation (CNCF), Linux Foundation Training \u0026 Certification, and Tetrate, this certification has set a new benchmark in microservices management.\n\n[Tetrate](https:\/\/tetrate.io), a key contributor to the Istio project, initially crafted the Certified Istio Administrator by Tetrate (CIAT), which laid the groundwork for the ICA Certification. Since its introduction, the ICA has been an instrumental part of the Kubernetes ecosystem, helping thousands to harness the power of service mesh technology.\n\nThe certification curriculum covers essential domains such as **installation**, **traffic management**, and **security**, reflecting the comprehensive expertise needed in the field. In a short span, the ICA has gained significant momentum, underpinned by the vision and dedication of Tetrate to the cloud-native landscape.\n\nAs we celebrate one month of the ICA, Tetrate\u0027s commitment to open source education continues through their Tetrate Academy, providing free, high-quality courses on service mesh and Kubernetes security. For those aiming to deploy Istio in production, Tetrate offers the **Tetrate Istio Distribution (TID)**, a secure and supported Istio distribution.\n\nIf you haven\u0027t yet, now is the time to join this growing community of Istio experts. Enhance your career and contribute to the evolution of cloud-native technologies.\n\n### [Start Your ICA Certification Today!](https:\/\/training.linuxfoundation.org\/certification\/istio-certified-associate-ica\/)\n\nThis is just the beginning. Let\u0027s look forward to more milestones in service mesh proficiency, with Tetrate and CNCF leading the charge.\n', '\/en\/blog\/ica-review\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">CNCF and Tetrate&#39;s Istio certification marks 1 month, boosting Kubernetes skills in microservices, security, and traffic management.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/implementing-gitops-and-canary-deployment-with-argo-project-and-istio/">Implementing GitOps and Canary Deployment with Argo Project and Istio</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Aug 31, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Implementing GitOps and Canary Deployment with Argo Project and Istio', 'This article discusses how to use Deployment, ArgoCD, and Istio to implement GitOps and canary deployment. ', '\nThe development of cloud-native applications has led to a shift in development to the left and a higher frequency of application iteration, which has given rise to the need for GitOps. This article will introduce how to use the Argo project, including ArgoCD and Argo Rollouts, to achieve GitOps and canary deployment with Istio. There is also a demonstration in the article that shows how to achieve GitOps based on the Istio environment provided by Tetrate Service Express (also applicable to Tetrate Service Bridge).\n\nThe deployment architecture diagram of the demo in this article is shown in Figure 1. If you are already familiar with the deployment strategies and Argo projects introduced in this article, you can skip directly to the demo section.\n\n![Figure 1: Architecture diagram of using Istio and Argo projects in TSE\/TSB to achieve GitOps and canary release](f1.svg)\n\n## Deployment strategy\n\nFirst of all, I want to briefly introduce the two deployment strategies supported by Argo Rollouts, which can achieve zero-downtime deployment.\n\nThe steps of blue-green deployment and canary deployment are shown in Figure 2.\n\n![Figure 2: Steps of blue-green deployment and canary deployment](f2.svg)\n\n- Blue-green deployment is a strategy that deploys the new version of the application in a separate environment in parallel without affecting the current production environment. In blue-green deployment, the current production environment is called the \u0022blue environment,\u0022 and the environment where the new version of the application is deployed is called the \u0022green environment.\u0022 Once the green environment is considered stable and has passed the test, the traffic will gradually switch from the blue environment to the green environment, allowing users to gradually access the new version. If problems occur during the switching process, it can be quickly rolled back to the blue environment to minimize the impact on users. The advantage of blue-green deployment is that it can provide high availability and zero-downtime deployment.\n- Canary deployment is a strategy for gradually introducing new versions or features into the production environment. In canary deployment, the new version or feature is first deployed to a small number of users in the production environment, called \u0022canary users.\u0022 By monitoring the feedback and performance indicators of canary users, the development team can evaluate the stability and reliability of the new version or feature. If there are no problems, more users can be gradually included in the canary deployment until all users use the new version. If a problem is found, it can be quickly rolled back or fixed to avoid negative effects on the entire user group. The advantage of canary deployment is that it can quickly identify problems and make adjustments in a small impact area.\n\nThe main difference between blue-green deployment and canary deployment is the deployment method and the scale of the changes. Blue-green deployment deploys the entire application in a new environment and then switches, which is suitable for large-scale changes, such as major upgrades of the entire application. Canary deployment gradually introduces new versions or features, which is suitable for small-scale changes, such as adding or modifying a single feature.\n\nIn terms of application scenarios, blue-green deployment is suitable for systems with higher requirements for high availability and zero-downtime deployment. When deploying large-scale changes, blue-green deployment can ensure stability and reliability and can quickly roll back to cope with unexpected situations. Canary deployment is suitable for systems that need to quickly verify new features or versions. By gradually introducing changes, problems can be discovered early and adjustments can be made to minimize the impact on users.\n\n## Release strategy of Kubernetes Deployment\n\nIn Kubernetes, the Deployment resource object is one of the main tools for managing the deployment and updating of applications. Deployment provides a declarative way to define the expected state of an application and implements the release strategy through the controller\u0027s functionality. The architecture of Deployment is shown in Figure 3, where the colored squares represent pods of different versions.\n\n![Figure 3: Architecture diagram of Kubernetes Deployment](f3.svg)\n\nThe release strategy can be configured in the spec field of Deployment. Here are some common release policy options:\n\n1. **Management of ReplicaSet**: Deployment uses ReplicaSet to create and manage replicas of an application. The desired number of replicas can be specified by setting the \u0060spec.replicas\u0060 field. During the release process, the Kubernetes controller ensures that the number of replicas of the new version\u0027s ReplicaSet gradually increases when created, and the number of replicas of the old version\u0027s ReplicaSet gradually decreases when deleted to achieve a smooth switch.\n2. **Rolling update policy**: Deployment supports multiple rolling update policies, which can be selected by setting the \u0060spec.strategy.type\u0060 field. Common policies include:\n    - **RollingUpdate**: The default policy updates replicas gradually at a certain time interval. The number of replicas that are not available at the same time and the number of additional available replicas can be controlled by setting the \u0060spec.strategy.rollingUpdate.maxUnavailable\u0060 and \u0060spec.strategy.rollingUpdate.maxSurge\u0060 fields.\n    - **Recreate**: This policy first deletes all replicas of the old version during the update process and then creates replicas of the new version. This policy will cause the application to be temporarily unavailable during the update.\n3. **Version control**: Deployment sets labels for each version\u0027s ReplicaSet through the \u0060spec.template.metadata.labels\u0060 field so that the controller can track and manage them accurately. This way, multiple versions of ReplicaSet can coexist, and the number of replicas of each version can be accurately controlled.\n\nBy using these configuration options, Deployment can achieve different release strategies. Updating the spec field of the Deployment object can trigger the release of a new version. The Kubernetes controller will automatically handle the creation, update, and deletion of replicas according to the specified policy to achieve smooth application updates and deployment strategies.\n\n## Implementing GitOps with ArgoCD\n\nYou can use Deployment to manually manage release strategies, but to achieve automation, we also need to use GitOps tools such as ArgoCD.\n\nArgoCD is a GitOps-based continuous delivery tool used to automate and manage the deployment of Kubernetes applications. It provides some key help to improve the efficiency and reliability of application deployment.\n\nHere are some of the help ArgoCD provides for Kubernetes application deployment:\n\n1. **Declarative configuration**: ArgoCD uses a declarative way to define the expected state of an application and stores the application configuration in a Git repository. By versioning and continuous integration\/continuous delivery (CI\/CD) processes, it is easy to track and manage application configuration changes.\n2. **Continuous deployment**: ArgoCD can monitor configuration changes in the Git repository and automatically deploy the application to the Kubernetes environment. It provides customizable synchronization policies that can automatically trigger application deployment and updates, achieving continuous deployment.\n3. **State comparison and automatic repair**: ArgoCD periodically checks the current state of the application and compares it with the expected state. If inconsistencies are found, it will automatically try to repair and restore the application to the desired state to ensure consistency between the expected and actual states.\n4. **Multi-environment management**: ArgoCD supports managing multiple Kubernetes environments, such as development, testing, and production environments. It is easy to deploy and synchronize application configurations between different environments, ensuring consistency and controllability.\n\nCompared to Deployment resource objects, ArgoCD provides more advanced features and workflows that complement the capabilities of native Kubernetes resource objects:\n\n**GitOps-based configuration management**: ArgoCD stores application configuration in a Git repository, enabling GitOps-based configuration management. This approach ensures that configuration changes are traceable, auditable, and can be integrated with existing CI\/CD pipelines.\n\n**Automated deployment and continuous delivery**: ArgoCD can automatically detect configuration changes in the Git repository and deploy applications to Kubernetes environments, enabling automated deployment and continuous delivery.\n\n**State management and automatic recovery**: ArgoCD continuously monitors the state of applications and compares it to the expected state. If inconsistencies are detected, it automatically recovers and ensures that the application state remains consistent with the expected state.\n\n## Using Istio to achieve fine-grained traffic routing\n\nAlthough ArgoCD can implement GitOps, it essentially operates on Kubernetes Deployment and controls traffic routing through replica numbers. To achieve fine-grained traffic routing, services meshes like Istio are used.\n\nIstio achieves finer-grained traffic routing and application release through the following methods:\n\n**VirtualService**: Istio uses VirtualService to define traffic routing rules. By configuring VirtualService, traffic can be routed and distributed based on request attributes such as request headers, paths, weights, etc., directing requests to different service instances or versions.\n\n**DestinationRule**: Istio\u0027s DestinationRule is used to define service version policies and load balancing settings. By specifying different traffic weights between service instances of different versions, advanced application release policies such as canary release or blue-green deployment can be implemented.\n\n**Traffic control and policies**: Istio provides rich traffic control and policy capabilities such as traffic limiting, fault injection, timeout settings, retry mechanisms, etc. These features help applications achieve higher-level load balancing, fault tolerance, and reliability requirements.\n\nCompared to ArgoCD and Kubernetes Deployment objects, Istio provides the following advantages in application deployment:\n\n**Fine-grained traffic routing control**: Istio provides richer traffic routing capabilities, enabling flexible routing and distribution based on a variety of request attributes, allowing for finer-grained traffic control and management.\n\n**Advanced release policy support**: Istio\u0027s DestinationRule can specify traffic weights between different versions of service instances, supporting advanced application release policies such as canary release and blue-green deployment. This makes version management and release of applications more flexible and controllable.\n\n**Powerful traffic control and policy capabilities**: Istio provides rich traffic control and policy capabilities such as traffic limiting, fault injection, timeout settings, retry mechanisms, etc. These features help applications achieve higher-level load balancing, fault tolerance, and reliability requirements.\n\nCombining Istio with Argo Rollouts can fully leverage the advantages of Istio\u0027s fine-grained traffic routing. Let\u0027s now have a demo together. In our demo, we will use the Kubernetes and Istio environments provided by TSE, implement GitOps using ArgoCD, and implement canary release using Argo Rollouts.\n\n## Demo\n\nThe software versions used in our demo are:\n\n- Kubernetes v1.24.14\n- Istio v1.15.7\n- ArgoCD v2.7.4\n- Argo Rollouts v1.5.1\n- TSE Preview2\n\nWe will use Istio\u0027s VirtualService and DestinationRule to implement traffic grouping routing based on Subset, and use ArgoCD Rollouts for progressive release.\n\n### Deploy ArgoCD and Argo Rollouts\n\nI have created a Kubernetes cluster and added it to TSE in advance, and TSE will automatically install Istio control plane for the cluster. We also need to install ArgoCD and Argo Rollouts:\n\n\u0060\u0060\u0060bash\n# Install ArgoCD\nkubectl create namespace argocd\nkubectl apply -n argocd -f https:\/\/raw.githubusercontent.com\/argoproj\/argo-cd\/stable\/manifests\/install.yaml\n\n# Install ArgoCD CLI on macOS\nbrew install argocd\n\n# Change the service type of argocd-server to LoadBalancer\nkubectl patch svc argocd-server -n argocd -p \u0027{\u0022spec\u0022: {\u0022type\u0022: \u0022LoadBalancer\u0022}}\u0027\n\n# Get the ArgoCD UI address\nARGOCD_ADDR=$(kubectl get svc argocd-server -n argocd -o jsonpath=\u0027{.status.loadBalancer.ingress[0].hostname}\u0027)\n\n# Login using ArgoCD CLI, see https:\/\/argo-cd.readthedocs.io\/en\/stable\/getting_started\/#4-login-using-the-cli to get password\nargocd login $ARGOCD_ADDR --skip-test-tls --grpc-web --insecure\n\n# Install Argo Rollouts\nkubectl create namespace argo-rollouts\nkubectl apply -n argo-rollouts -f https:\/\/github.com\/argoproj\/argo-rollouts\/releases\/download\/latest\/install.yaml\n\n# Install rollouts plugin on macOS\ncurl -LO https:\/\/github.com\/argoproj\/argo-rollouts\/releases\/download\/v1.5.0\/kubectl-argo-rollouts-darwin-amd64\nchmod \u002bx .\/kubectl-argo-rollouts-darwin-amd64\nsudo mv .\/kubectl-argo-rollouts-darwin-amd64 \/usr\/local\/bin\/kubectl-argo-rollouts\n\n\u0060\u0060\u0060\n\nThis feature is not applicable to TSE Bridge Mode, so we will use TSE Direct Mode to achieve progressive release.\n\n{{\u003ccallout note \u0022💡 What is Bridge Mode and Direct Mode?\u0022\u003e}}\n\n\nDirect Mode and Bridge Mode are two modes in TSE for control plane to issue configuration. They are suitable for flow, security, and gateway group configuration modes. BRIDGED mode is a minimalist mode that allows users to quickly configure the most commonly used features in the service mesh using Tetrate-specific APIs, while DIRECT mode provides greater flexibility for advanced users, allowing them to configure using Istio APIs directly.\n\n{{\u003c\/callout\u003e}}\n\nNext, deploy Rollouts Dashboard:\n\n\u0060\u0060\u0060bash\ngit clone https:\/\/github.com\/argoproj\/argo-rollouts.git\nkustomize build manifests\/dashboard-install|kubectl apply -n argo-rollouts -f -\nkubectl port-forward svc\/argo-rollouts-dashboard -n argo-rollouts 3100:3100\n\u0060\u0060\u0060\n\nYou can now access the Rollouts Dashboard at [https:\/\/localhost:3100\/rollouts\/](https:\/\/localhost:3100\/rollouts\/).\n\n### Deploy Bookinfo Application\n\nWe have prepared the configuration file for the Bookinfo application (saved in the [tse-gitops-demo](https:\/\/github.com\/tetrateio\/tse-gitops-demo\/) repository), and you can also fork it to your own account and replace it with your own repository. Run the following command to deploy the Bookinfo application:\n\n\u0060\u0060\u0060\nargocd app create bookinfo-app --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path application --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated\n\n\u0060\u0060\u0060\n\nNote: We set \u0060replicas\u0060 to \u00600\u0060 in the [\u0060reviews\u0060 Deployment](https:\/\/github.com\/tetrateio\/tse-gitops-demo\/blob\/main\/application\/bookinfo.yaml#L151) because we will create Argo Rollouts to manipulate the number of instances of the \u0060reviews\u0060 service. If you set it to a non-zero positive integer here, we will not be able to achieve canary deployment.\n\nNow you can open the ArgoCD UI in your browser, as shown in Figure 4.\n\n![Figure 4: ArgoCD UI](f4.png)\n\nIf you find that the application status is not in sync, you can run the following command or click the SYNC button in the UI.\n\n\u0060\u0060\u0060bash\nargocd app sync bookinfo-app\n\u0060\u0060\u0060\n\n## Implementing Fine-grained Traffic Management with Istio\n\nFirst, let\u0027s use Argo CD to create Istio-related resource objects:\n\n\u0060\u0060\u0060bash\nargocd app create bookinfo-tse-conf --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path argo\/tse --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated --self-heal\n\n# Check the creation status\nargocd app get bookinfo-tse-conf\n\u0060\u0060\u0060\n\n### Converting Deployment to Rollout\n\nSuppose we want to release a new version of the \u0060reviews\u0060 service. To achieve zero downtime updates, we will use canary deployment, with the following steps:\n\n1. Reduce the \u0060replicas\u0060 of the \u0060reviews\u0060 Deployment to 0;\n2. Create a Rollout that references the \u0060reviews\u0060 Deployment previously deployed in the Bookinfo application;\n3. Send traffic to the \u0060reviews\u0060 service to achieve automatic canary deployment progress.\n\nYou can view the Rollout and AnalysisTemplate configurations used in this demo on [GitHub](https:\/\/github.com\/tetrateio\/tse-gitops-demo\/tree\/main\/argo\/rollout). Run the following command to deploy \u0060reivews-rollout\u0060:\n\n\u0060\u0060\u0060bash\nargocd app create reviews-rollout --repo https:\/\/github.com\/tetrateio\/tse-gitops-demo.git --path argo\/rollout --dest-server https:\/\/kubernetes.default.svc --dest-namespace bookinfo --sync-policy automated\n\u0060\u0060\u0060\n\nNote: We can use the \u0060argocd\u0060 command to deploy or use \u0060kubectl apply\u0060. It is recommended to use \u0060argocd\u0060 because you can view the deployment status in ArgoCD UI and Argo Rollouts Dashboard at the same time and manage the deployment using the \u0060argocd\u0060 command.\n\nView the status of the \u0060reviews\u0060 rollouts in the [Argo Rollouts Dashboard](https:\/\/localhost:3001\/rollouts\/bookinfo), and use the following command to send traffic to the \u0060reviews\u0060 service for a period of time:\n\n\u0060\u0060\u0060bash\nexport GATEWAY_HOSTNAME=$(kubectl -n bookinfo get service tsb-gateway-bookinfo -o jsonpath=\u0027{.status.loadBalancer.ingress[0].hostname}\u0027)\nwhile 1;do curl -H \u0022Host: bookinfo.tetrate.com\u0022 http:\/\/$GATEWAY_HOSTNAME\/api\/v1\/products\/1\/reviews;sleep 3;done\n\u0060\u0060\u0060\n\nYou will see responses from pods with different rollouts-pod-template-hash labels in the output, which proves that canary deployment is effective. After about 10 minutes, the Argo Rollouts Dashboard you see will be as shown in Figure 5.\n\n![Figure 5: Argo Rollout Dashboard](f5.png)\n\nFrom Figure 5, we can see that canary deployment is progressing smoothly and has reached the third step. This is because the \u0060apdex\u0060 (Application Performance Index) indicator of the \u0060reviews\u0060 service is normal. You can use [Postman to submit GraphQL queries to SkyWalking](https:\/\/tetrate.io\/blog\/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman\/) to verify this, as shown in Figure 6.\n\n![Figure 6: Submitting GraphQL queries to SkyWalking using Postman](f6.png)\n\nThe GraphQL query statement we built is as follows:\n\n\u0060\u0060\u0060graphql\nquery ReadMetricsValues {\n    readMetricsValues(condition: {\n    name: \u0022service_apdex\u0022, entity: {scope: Service, serviceName: \u0022canary|reviews|bookinfo|cluster-1|-\u0022, normal: true}\n  }, duration: {\n    start: \u00222023-07-13 0812\u0022,\n    end: \u00222023-07-13 0813\u0022,\n    step: MINUTE\n  }) {\n        label\n        values {\n            values {\n                id\n                value\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nThis statement queries the \u0060apdex\u0060 indicator of the \u0060canary|reviews|bookinfo|cluster-1|-\u0060 service from UTC \u00602023-07-13 8:12\u0060 to \u00602023 8:13\u0060 for two minutes and obtains the following results:\n\n\u0060\u0060\u0060json\n{\n    \u0022data\u0022: {\n        \u0022readMetricsValues\u0022: {\n            \u0022label\u0022: null,\n            \u0022values\u0022: {\n                \u0022values\u0022: [\n                    {\n                        \u0022id\u0022: \u0022service_apdex_202307130812_Y2FuYXJ5fHJldmlld3N8Ym9va2luZm98Y2x1c3Rlci0xfC0=.1\u0022,\n                        \u0022value\u0022: 10000\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_apdex_202307130813_Y2FuYXJ5fHJldmlld3N8Ym9va2luZm98Y2x1c3Rlci0xfC0=.1\u0022,\n                        \u0022value\u0022: 10000\n                    }\n                ]\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nThe value of the \u0060apdex\u0060 indicator is greater than 9900 (the threshold configured in the \u0060successCondition\u0060 of AnalysisTemplate), so Rollouts will progress smoothly. You can also click Promote manually on the Argo Rollouts Dashboard to promote it, or run the following command:\n\n\u0060\u0060\u0060bash\nkubectl argo rollouts promote reviews-rollout -n bookinf\n\u0060\u0060\u0060\n\n## Cleaning Up\n\nDelete the deployed ArgoCD Apps and Rollouts:\n\n\u0060\u0060\u0060bash\nargocd app delete -y reviews-rollout\nargocd app delete -y bookinfo-tse-conf\nargocd app delete -y bookinfo-app\n\u0060\u0060\u0060\n\n## Principles of Argo Rollouts\n\nWhen integrating with Istio, Argo Rollouts supports traffic splitting based on VirtualService and Subset, as shown in Figure 7.\n\n![Figure 7: Argo Rollouts uses Istio for traffic splitting](f7.svg)\n\nThe table below provides a detailed comparison of these two traffic segmentation methods.\n\n| Type | Applicable Scenario | Resource Object | Principle |\n| --- | --- | --- | --- |\n| Host-level Traffic Split | Applicable for accessing different versions of services based on hostname; | 2 Services, 1 VirtualService, 1 Rollout; | Rollout injects the rollouts-pod-template-hash label into the ReplicaSet and selects pods with these labels by updating the selector in the Service; |\n| Subset-level Traffic Split | Applicable for accessing different services based on labels; | 1 Service, 1 VirtualService, 1 DestinationRule, and 1 Rollout; | Rollout injects the rollouts-pod-template-hash label into the ReplicaSet and selects pods with these labels by updating the selector in the DestinationRule; |\n\nSubset-based traffic splitting is used in this demo, and Argo Rollouts continuously:\n\n- modify the VirtualService \u0060spec.http[].route[].weight\u0060 to match the current desired canary weight\n- modify the DestinationRule \u0060spec.subsets[].labels\u0060 to contain the \u0060rollouts-pod-template-hash\u0060 label of the canary and stable ReplicaSets\n\nVisit [Argo Rollouts documentation](https:\/\/argo-rollouts.readthedocs.io\/en\/stable\/features\/traffic-management\/istio\/) for details on using Istio for traffic management.\n\n## Summary\n\nThis article introduces how to use the Argo project and Istio to achieve GitOps and canary deployment. First, we use ArgoCD to achieve GitOps, and then use Argo Rollout and SkyWalking to achieve automated canary release. From the demo, we can see that the Istio deployed by TSE is fully compatible with the open-source version. There are many features of TSE worth exploring, visit the [Tetrate website](https:\/\/tetrate.io\/tetrate-service-express\/) for more information.\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/implementing-gitops-and-canary-deployment-with-argo-project-and-istio\/).*\n', '\/en\/blog\/implementing-gitops-and-canary-deployment-with-argo-project-and-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article discusses how to use Deployment, ArgoCD, and Istio to implement GitOps and canary deployment. </p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman/">How to Use GraphQL to Query Observability Data from SkyWalking with Postman</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jul 20, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How to Use GraphQL to Query Observability Data from SkyWalking with Postman', 'This article explains how to use GraphQL to query observability data from SkyWalking with Postman. It first introduces GraphQL and SkyWalking, then explains how to set up Postman to send GraphQL queries, and finally provides some example GraphQL queries that can be used to query observability data from SkyWalking.', '\nIn this article, I will explain how to use [GraphQL](https:\/\/graphql.org\/) to query data from [SkyWalking](https:\/\/skywalking.apache.org\/) with [Postman](https:\/\/www.postman.com\/). It includes steps to obtain the bearer token, construct a query to retrieve load metrics for a specific service, and use GraphQL introspection to see the schema of SkyWalking GraphQL APIs. The article also provides references for further information.\n\n## What Is GraphQL?\n\nGraphQL is a query language and runtime for APIs developed by Facebook. It provides a more efficient, powerful, and flexible alternative to traditional REST APIs by allowing clients to specify exactly what data they need and receive only that data in response. With GraphQL, clients can query multiple resources in a single request, reducing the number of roundtrips to the server and improving performance.\n\n## What’s the Difference between GraphQL and REST APIs?\n\nGraphQL allows clients to request only the data they need, while REST APIs require clients to retrieve everything in a resource regardless of whether they need it or not. Additionally, GraphQL allows clients to query multiple resources in a single request, making it more efficient and less chatty than REST APIs.\n\n## How Do I Query Data from SkyWalking?\n\nSkyWalking defines the communication protocol for the query stage. The SkyWalking native UI and CLI use this protocol to consistently fetch data from the backend, without needing to worry about backend updates.\n\nThere are two methods for querying metrics from SkyWalking:\n\n1. [GraphQL APIs](https:\/\/skywalking.apache.org\/docs\/main\/v9.4.0\/en\/api\/query-protocol\/)\n2. [PromQL APIs](https:\/\/skywalking.apache.org\/docs\/main\/v9.4.0\/en\/api\/promql-service\/)\n\nThis article provides a guide on how to use GraphQL to query metrics from SkyWalking. If you are interested in the PromQL APIs, you can refer to the article[ Build Grafana dashboards for Apache SkyWalking — Native PromQL Support](https:\/\/skywalking.apache.org\/blog\/2023-03-17-build-grafana-dashboards-for-apache-skywalking-native-promql-support\/).Continuing with the following steps requires a TSB installation. If you don’t have one and still want to experience using GraphQL to query data in SkyWalking, you can use the free[ demo environment](https:\/\/skywalking.apache.org\/) (username\/password: skywalking\/skywalking) provided by SkyWalking. Log in to the demo website and get a token for queries. Endpoint address for GraphQL queries is http:\/\/demo.skywalking.apache.org\/graphql. The steps to construct the query are the same as described below.\n\n## Observe GraphQL Queries in TSB\n\nBefore we use Postman to construct our own GraphQL query, let’s first observe how TSB obtains data from SkyWalking.\n\n1. Open Chrome DevTools and switch to the Network tab.\n2. Visit the **Organization – Services** tab on the website.\n\nWatch the network request list and right-click on the one of the graphql requests, like in the following image:\n\n![Figure 1: Chrome DevTool](f1.jpg)\n\nThe curl commands you see will look like this. Execute the command in your terminal, and you will get a list of services managed by TSB from SkyWalking.\n\n\u0060\u0060\u0060bash\ncurl \u0027\u003chttps:\/\/saturn.tetrate.work\/ui\/graphql\u003e\u0027 \\\n  -H \u0027Accept-Language: en,zh-CN;q=0.9,zh;q=0.8,en-US;q=0.7,zh-TW;q=0.6\u0027 \\\n  -H \u0027Cache-Control: no-cache\u0027 \\\n  -H \u0027Client-Timestamp: 1686104776136\u0027 \\\n  -H \u0027Connection: keep-alive\u0027 \\\n  -H \u0027Content-Type: application\/json\u0027 \\\n  -H \u0027Cookie: ...\u0027 \\\n  -H \u0027Origin: \u003chttps:\/\/saturn.tetrate.work\u003e\u0027 \\\n  -H \u0027Pragma: no-cache\u0027 \\\n  -H \u0027Referer: \u003chttps:\/\/saturn.tetrate.work\/mp\/services\u003e\u0027 \\\n  -H \u0027Request-Id: ...\u0027 \\\n  -H \u0027Sec-Fetch-Dest: empty\u0027 \\\n  -H \u0027Sec-Fetch-Mode: cors\u0027 \\\n  -H \u0027Sec-Fetch-Site: same-origin\u0027 \\\n  -H \u0027User-Agent: Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/114.0.0.0 Safari\/537.36\u0027 \\\n  -H \u0027X-Bridge-Csrf-Token: IOmJszLAqY3TRIUNhTuGu7vQgnfQY1FtgYFm\u002bl\/\u002bMu4EmVQU5T8EaQ7bngkCv4hQ12ZGids\u002bI21pHMdepE9\/qQ==\u0027 \\\n  -H \u0027X-Csrf-Token: xTbxZerD3t8N3PaS7nbjKCfxk1Q9dtvvrx4D\u002bIJohHicb0VfB4iAZaP0zh1eXDWctQyCYZWaKLhAYT3M6Drk3A==\u0027 \\\n  -H \u0027accept: application\/json\u0027 \\\n  -H \u0027sec-ch-ua: \u0022Not.A\/Brand\u0022;v=\u00228\u0022, \u0022Chromium\u0022;v=\u0022114\u0022, \u0022Google Chrome\u0022;v=\u0022114\u0022\u0027 \\\n  -H \u0027sec-ch-ua-mobile: ?0\u0027 \\\n  -H \u0027sec-ch-ua-platform: \u0022macOS\u0022\u0027 \\\n  --data-raw $\u0027{\u0022query\u0022:\u0022query ServiceRegistryListMetrics(...)}\u0027 \\\n  --compressed\n\u0060\u0060\u0060\n\n**Note:** *Some fields in the above example are too long and replaced with dots (…)*.\n\nNext, I will guide you through constructing a query to retrieve the load metrics for a specific service.\n\n## Obtain the Bearer Token\n\nFirstly, you need to obtain the bearer of the website. Log in to TSB UI, click on the user button in the upper right corner, and then click “Show token information”. In the pop-up window, you will see the Bearer Token, as shown in the following image.\n\n![Figure 2: Get the bearer token from the TSB UI](f2.jpg)\n\n**Note:** The validity period of the bearer token is relatively short. When it expires, you need to log in to TSB again to obtain a new token.\n\nWe have already deployed the[ bookinfo application](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/) in advance and sent some test traffic. To query the load metrics of reviews using GraphQL in the Postman client, follow these steps:\n\n1. Create a new GraphQL request and enter the request URL: \u0060$TSB_ADDRESS\/graphql\u0060\n2. Add the \u0060Authorization\u0060 header with the value\u0060 Bearer $TOKEN\u0060\n\nUse GraphQL Introspection to see the schema of SkyWalking GraphQL APIs. Find and click the \u0060readMetricsValues\u0060 item. You will see the variables on the right side. Fill in the \u0060condition\u0060 and \u0060duration\u0060 items, as shown in the following image.\n\n![Figure 3: Postman query](f3.jpg)\n\nThe variables look like this:\n\n\u0060\u0060\u0060graphql\nquery ReadMetricsValues {\n    readMetricsValues(condition: {\n    name: \u0022service_cpm\u0022, entity: {scope: Service, serviceName: \u0022reviews\u0022, normal: true}\n  }, duration: {\n    start: \u00222023-06-05 0625\u0022,\n    end: \u00222023-06-05 0627\u0022,\n    step: MINUTE\n  }) {\n        label\n        values {\n            values {\n                id\n                value\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nClick the **Query** button to get the result. It should look similar to this:\n\n\u0060\u0060\u0060json\n{\n    \u0022data\u0022: {\n        \u0022readMetricsValues\u0022: {\n            \u0022label\u0022: null,\n            \u0022values\u0022: {\n                \u0022values\u0022: [\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050625_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050626_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    },\n                    {\n                        \u0022id\u0022: \u0022service_cpm_202306050627_cmV2aWV3cw==.1\u0022,\n                        \u0022value\u0022: 0\n                    }\n                ]\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nThe above is using the SkyWalking Demo environment to test GraphQL queries. GraphQL query support is also provided in TSE, and the endpoint address is \u0060https:\/\/$TSB_SERVER\/graphql\u0060.\n\n**Note:** The query endpoint here is different from what we see in DevTool. The GraphQL query endpoint specific to the TSB UI is \u0060https:\/\/$TSB_SERVER\/ui\/graphql\u0060.For details about the SkyWalking GraphQL Query Protocol, please refer to[ GitHub](https:\/\/github.com\/apache\/skywalking-query-protocol\/tree\/master).\n\n## Summary\n\nIn this article, I have introduced how to use the GraphQL query protocol in Postman to query data in SkyWalking. You can construct your own query conditions based on the GraphQL schema of SkyWalking. This feature is also available in TSB\/TSE.\n\n## References\n\n- https:\/\/github.com\/apache\/skywalking-query-protocol\n- [SkyWalking Website](https:\/\/skywalking.apache.org\/)\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/what-is-tproxy-and-how-does-it-work\/).*\n', '\/en\/blog\/how-to-use-graphql-to-query-observability-data-from-skywalking-with-postman\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article explains how to use GraphQL to query observability data from SkyWalking with Postman. It first introduces GraphQL and SkyWalking, then explains how to set up Postman to send GraphQL queries, and finally provides some example GraphQL queries that can be used to query observability data from SkyWalking.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/istio-1-18-released-now-with-ambient-mode-available/">Istio 1.18 Released, Now with Ambient Mode Available</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jun 26, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 1.18 Released, Now with Ambient Mode Available', 'This article introduces Istio 1.18, the latest release of the service mesh platform. It highlights the new features and improvements, such as ambient mode, which allows Istio to run on any Kubernetes cluster without requiring a dedicated control plane. It also explains how to get started with Istio 1.18 using Tetrate’s distribution and support.', '\nIn June, [Istio 1.18 was released](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/), marking the second release of Istio in 2023 and the first to offer official support for [ambient mode](https:\/\/tetrate.io\/blog\/istio-ambient-mesh-merged-to-main\/). Tetrate’s Paul Merrison was one of the release managers for this version, and Tetrate’s contributions to this release included various customer-driven usability enhancements and important work in the underlying Envoy Proxy upon which Istio depends. When asked about the experience of working on Istio 1.18, Paul said “working as the lead release manager for Istio 1.18 gave me a fascinating insight into how a group of super talented people from around the world come together, organize themselves and ship software. There was a steep learning curve, but the Istio community is awesome and I was supported brilliantly. The biggest challenge was definitely learning and executing all the steps that are needed to bring a release to life, but the feeling of achievement when it finally made its way out into the world will stay with me for a while!” Istio first announced the introduction of Ambient mode in September last year, which was covered in detail by Zack in[ this blog post](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/), where he explains the differences between ambient mode and sidecar mode.\n\nThis release introduces many [new features and changes](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/change-notes\/) in addition to ambient mode, including enhanced Kubernetes Gateway API support, health checks for virtual machines that are not automatically registered, support for expired metrics, enhanced \u0060istioctl analyze\u0060, and more. See the [release blog](https:\/\/istio.io\/latest\/news\/releases\/1.18.x\/announcing-1.18\/) for details. The most significant of these are the ambient mode and Gateway API enhancements, detailed below.\n\n\u003e “Working as the lead release manager for Istio 1.18 gave me a fascinating insight into how a group of super talented people from around the world come together, organize themselves and ship software. There was a steep learning curve, but the Istio community is awesome and I was supported brilliantly. The biggest challenge was definitely learning and executing all the steps that are needed to bring a release to life, but the feeling of achievement when it finally made its way out into the world will stay with me for a while!”\n\u003e\n\u003e Paul Merrison, Tetrate Engineering and Istio Release Manager\n\n## What Is Ambient Mode?\n\nBefore discussing ambient mode, it is essential to understand the current “sidecar mode” used by Istio. Sidecar mode is the default data plane mode used by Istio, where each application pod comes equipped with a sidecar proxy (usually Envoy) that handles all network traffic in and out of the pod, providing Istio’s core functionality such as Zero Trust security, telemetry and traffic management. While sidecar mode is suitable for most users, ambient mode offers some advantages in specific circumstances. For more information on the differences between ambient mode and the standard sidecar mode, see[ our article on Ambient Mesh: What You Need to Know about This Experimental New Deployment Model for Istio](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/).\n\n## What Are the Design Goals of Ambient Mode?\n\n- **Non-intrusive**: Ambient mode does not require injecting sidecar proxies into the application’s pods and only requires the application to be tagged to automatically join the mesh, potentially reducing the mesh’s impact on the application.\n- **Efficient resource utilization**: Ambient mode can optimize resource utilization for some use cases by sharing the ztunnel proxy across the mesh. If certain L7 functionality of Istio is required, it can also be addressed by deploying Waypoints precisely for a ServiceAccount or Namespace, providing more control over resource consumption.\n- **Performance parity with sidecar mode**: Ambient mode initially adopted a shared proxy model based on Envoy, but during development, issues such as complex Envoy configuration were discovered, leading the Istio community to develop its shared proxy ([ztunnel](https:\/\/tetrate.io\/blog\/using-geneve-tunnels-to-implement-istio-ambient-mesh-traffic-interception\/)) based on Rust. In the future, ambient mode is expected to have comparable performance to traditional sidecar mode.\n- **Security**: Ambient mode provides TLS support by running a shared proxy ztunnel on each node, and when users require the same security as sidecar mode, they also need to deploy one or more Waypoints in each namespace to handle L7 traffic in that namespace.\n\nUsers can use \u0060istioctl x waypoint\u0060 for Waypoint configuration management. For example, running the \u0060istioctl x waypoint generate\u0060 command generates a Kubernetes Gateway API resource managed by Istio.\n\nOverall, ambient mode promises to offer additional flexibility to Istio’s deployment model which may prove helpful to some users. It should be noted that the ambient mode is still in the **alpha stage** and has yet to achieve production-level stability.\n\n## Enhanced Kubernetes Gateway API Support\n\nIstio 1.18 introduces several vital improvements and modifications to its Kubernetes Gateway API support:\n\n- **Support for v1beta1**: When upgrading to the new version of Istio, Gateway API version greater than 0.6.0\u002b is required. Use the \u0060istioctl x precheck \u0060command to check for upgrade issues.\n- **Gateway API automated deployment management upgrades**: All Kubernetes Gateway resources Istio manages will automatically configure Service and Deployment resources when created or updated. If the Gateway resource changes, the associated configuration will also be updated synchronously. In addition, the deployment of Gateway resources no longer depends on injection logic but has an independent creation process.\n- **Removal of support for the \u0060proxy.istio.io\/config\u0060 annotation**: The ProxyConfig resource only affects the Istio-managed Gateway.\n- **Fixes to Istiod handling of configuration changes**: If Service and Deployment configurations change, Istiod reprocesses them.\n\n- **It no longer supports the Alpha version of the Gateway API by default**: It can be re-enabled by setting \u0060PILOT_ENABLE_ALPHA_GATEWAY_API=true\u0060.\n\nIt is worth noting that when installing ambient mode, unlike previous Istio installations, IngressGateway is no longer included by default. In future development, Istio is leaning towards using the Gateway API to manage gateways. For more information on why the Gateway API is recommended over Ingress, please read[ my previous blog article on why the Gateway API Is the unified future of ingress for Kubernetes and service mesh](https:\/\/tetrate.io\/blog\/why-the-gateway-api-is-the-unified-future-of-ingress-for-kubernetes-and-service-mesh\/).\n\n## Next Steps to Ambient Mesh\n\nWe’re excited that ambient mode is now available to users in an official Istio release, especially as it promises to make mesh adoption easier for all users. The [easiest way to get started with Istio’s new ambient mode is Tetrate Istio Distro](https:\/\/istio.tetratelabs.io\/), Tetrate’s hardened, fully upstream Istio distribution, with [FIPS-verified builds](https:\/\/tetrate.io\/blog\/how-tetrate-istio-distro-became-the-first-fips-compliant-istio-distribution\/) and [support available](https:\/\/tetrate.io\/tetrate-istio-subscription\/). It’s a great way to get started with Istio knowing you have a trusted distribution, to begin with, an expert team supporting you, and also the option to get to FIPS compliance quickly if you need to.\n\nAs you add more apps to the mesh, you’ll need a unified way to manage those deployments and coordinate the mandates of the different teams involved. That’s where Tetrate Service Bridge comes in. Learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetrate.io\/tetrate-service-bridge\/), or [contact us for a quick demo](https:\/\/tetrate.io\/demo-request\/).\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/istio-1-18-released-now-with-ambient-mode-available\/).*\n', '\/en\/blog\/istio-1-18-released-now-with-ambient-mode-available\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces Istio 1.18, the latest release of the service mesh platform. It highlights the new features and improvements, such as ambient mode, which allows Istio to run on any Kubernetes cluster without requiring a dedicated control plane. It also explains how to get started with Istio 1.18 using Tetrate’s distribution and support.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               May 29, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception', 'This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.', '\nIn a previous[ blog post](\/en\/blog\/ambient-mesh-l7-traffic-path\/), I discussed how Istio Ambient Mesh uses iptables and Geneve tunnels to intercept traffic from application pods into Ztunnel. Many readers may not be familiar with this tunneling protocol, so this article will introduce the definition, packet structure and advantages of Geneve tunnels compared with the VXLAN protocol. Finally, this article will introduce how Istio Ambient Mesh applies Geneve tunnels to implement traffic interception and the new eBPF mode introduced in Istio 1.18.\n\n## Introduction to Geneve Tunnels\n\nIn order to address the lack of flexibility and security in current data transmissions, the Geneve (Generic Network Virtualization Encapsulation) network virtualization encapsulation (tunneling) protocol was created. Geneve only defines a data encapsulation format, excluding control plane information. The key advantage of Geneve over VXLAN encapsulation is that it extends the types of encapsulated protocols by adding TLV format options.\n\n### Geneve vs. VXLAN\n\nVXLAN and Geneve are both network virtualization protocols and they have many similarities. Virtualization protocols are technologies that separate virtual networks from physical networks. They allow network administrators to create multiple virtual networks in a virtual environment, each of which can have its own VLAN identifiers, IP addresses and routing. In addition, VXLAN and Geneve use UDP encapsulation, which enables them to be extended through existing network infrastructure. VXLAN and Geneve protocols are also flexible, can be used in different network topologies and are compatible with different virtualization platforms.\n\nFigure 1 shows the message structure of VXLAN and Geneve tunnels and the differences in their respective headers.\n\n![Figure 1: VXLAN and Geneve packet format schematic diagram.](vxlan-vs-geneve.svg)\n\nFrom the figure, we can see that the message structure of VXLAN and Geneve tunneling protocols is similar, with the main difference being the use of different UDP port numbers and protocol headers. VXLAN uses port 4789, while Geneve uses port 6081. The Geneve protocol header is more extendable than VXLAN.\n\nThe Geneve tunneling protocol adds variable-length options that can contain zero or more option data in TLV format, making it more scalable than VXLAN. TLV stands for Type-Length-Value, which is a format for parsing and transmitting metadata in network packets. Each metadata information in the Geneve protocol is composed of a TLV format field, making it simple to flexibly add, delete and modify these metadata.\n\nThe TLV format field contains the following data:\n\n- Type: 8-bit type field.\n- Length: 5-bit option length field, represented in multiples of 4 bytes, excluding the option header.\n- Data: Variable-length option data field, which may not exist or may be between 4 and 128 bytes.\n\nThe Geneve protocol can easily modify and extend metadata information while maintaining compatibility and flexibility by using the TLV format.\n\nPlease refer to[ RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) for more information about VXLAN. For more information about the Geneve tunnel packet format, please refer to[ RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i).\n\n### How it Works\n\nThe Geneve tunnel is mainly used in cloud computing and virtualization scenarios, and it can encapsulate packets in a new packet for transmission in a virtual network. The Geneve tunnel uses a 24-bit VNI (Virtual Network Identifier) to transmit packets from one physical network to another. The Geneve tunnel can also use security protocols such as IPsec and TLS to protect the transmission of packets.\n\nWhen a packet reaches the destination host, the Geneve tunnel protocol will de-encapsulate the packet from the Geneve protocol header and deliver it to the destination in the virtual network. During the de-encapsulation process, the VNI information in the Geneve protocol header is used to determine the destination of the packet, ensuring that the packet is correctly routed to the destination in the virtual network.\n\nAssuming there is a virtual network with a VNI of 1001. When a packet is transmitted from one physical network to another, a tunnel can be used to track the packet during transmission by setting the VNI between the source and target physical networks to 1001. When the packet reaches the target physical network, the VNI is removed from the packet and the packet is delivered to the target physical network.\n\n### Security\n\nThe Geneve tunnel protocol itself does not provide any security mechanisms, so packets transmitted in the Geneve tunnel can be subject to threats such as packet tampering, interception and replay.\n\nTo ensure the security of packets transmitted in the Geneve tunnel, some security protocols can be used. The following are some common security protocols:\n\n1. IPsec (Internet Protocol Security): IPsec is a network layer security protocol that can encrypt, authenticate and provide integrity protection to packets in the Geneve tunnel. IPsec can provide end-to-end security.\n2. TLS (Transport Layer Security): TLS is an encryption protocol based on the transport layer that can encrypt and authenticate packets in the Geneve tunnel. TLS can provide end-to-end security.\n3. MACSec (Media Access Control Security): MACSec is a data link layer security protocol that can encrypt and authenticate packets in the Geneve tunnel. MACSec can provide link-layer security.\n\nIt should be noted that the above security protocols require corresponding configuration and deployment and may have a certain impact on performance. When choosing the appropriate security protocol, factors such as security, performance, manageability and other aspects need to be considered.\n\n## Why Choose Geneve?\n\nThe following table compares the characteristics of VXLAN and Geneve in multiple aspects.\n\n| **Feature**   | **VXLAN**                          | **Geneve**                                   |\n| ------------- | ---------------------------------- | -------------------------------------------- |\n| Header format | Fixed format                       | Extensible format                            |\n| Scalability   | More focused on L2 extension       | Better support for emerging network services |\n| Operability   | Difficult to manage and extend     | Easier to manage and extend                  |\n| Performance   | Shorter header, higher performance | Longer header, slightly lower performance    |\n\n**Table 1:** *VXLAN vs Geneve characteristics*.\n\nThe main reason for using the Geneve protocol is to combine the advantages of current network virtualization encapsulation technologies (such as VXLAN, NVGRE and STT) into one protocol. Through years of network virtualization development experience, we know that one of the most important requirements is scalability. The Geneve protocol encodes metadata using an extensible TLV structure, so it can independently develop the functionality of software and hardware endpoints to meet growing needs.\n\n## How Istio Ambient Mesh Applies Geneve Tunnels\n\nIn the[ previous blog](https:\/\/tetrate.io\/blog\/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh\/), I explained how Istio Ambient Mesh uses Ztunnel to implement L4 proxies and Figure 2 shows the L4 transparent traffic interception path using iptables and Geneve tunnels.\n\n![Figure 2: L4 Transparent Traffic Interception Path Using Iptables and Geneve Tunnels.](geneve-tunnel.svg)\nFrom the figure, we can see that:\n\n- The Istio CNI creates an \u0060istioout\u0060 network card and iptables rules on the node, transparently intercepting the outbound traffic in the node to the \u0060pistioout\u0060 virtual network card.\n- The Istio CNI creates an \u0060istioin\u0060 network card and iptables rules on the node, transparently intercepting the inbound traffic in the node to the \u0060pistioin\u0060 virtual network card.\n- The Istio CNI creates \u0060pistioin\u0060 and \u0060pistioout\u0060 network cards in ztunnel to receive data packets in the Geneve tunnel.\n\nThe two network cards \u0060pistioin\u0060 and \u0060pistioout\u0060 are created by the init container or Istio CNI (see the \u0060CreateRulesWithinNodeProxyNS\u0060 function in [net_linux.go](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910)), and their IP addresses and ports are fixed. The data packets sent by the application container need to pass through the \u0060istioout\u0060 network card and be forwarded to the ztunnel container after being encapsulated in the Geneve tunnel. When the data packets are received by the ztunnel container, they are de-encapsulated and forwarded to the corresponding application containers through the \u0060pistioin\u0060 network card.\n\n## Using eBPF for Transparent Traffic Interception\n\neBPF (extended Berkeley Packet Filter) is a powerful technology that allows secure user-space programs to run within the Linux kernel. Initially developed as a technique for filtering network packets, eBPF has now been extended to other areas such as tracking system calls, performance analysis and security monitoring. The advantages of eBPF are its lightweight nature, efficiency, security and programmability. It can be used in real-time monitoring, network security, application debugging and optimization, container networking and various other fields.\n\nIstio Ambient Mesh also supports using the eBPF (extended Berkeley Packet Filter) mode for transparent traffic interception since 1.18. As shown in Figure 3, the eBPF program runs directly in the host kernel and forwards application traffic to ztunnel. Compared to the iptables-based approach, the eBPF mode can provide better network efficiency and scalability. However, it requires a higher version of the Linux kernel and is more difficult to implement.\n\n![Figure 3: Intercepting the Traffic of Application Using eBPF.](ebpf.svg)\n\nTo use the eBPF mode to run Ambient Mesh, simply set the \u0060values.cni.ambient.redirectMode\u0060 parameter to “ebpf” when installing Istio, as shown below:\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## Summary\n\nThis article introduced the working principle, security and comparison with VXLAN of the Geneve tunnel protocol. In addition, it also introduced how Istio Ambient Mesh uses Geneve tunnels to implement traffic interception and discussed the advantages and disadvantages of using eBPF for transparent traffic interception. The Geneve tunnel protocol is a universal tunneling protocol that can transmit packets in virtual networks, and it has more advantages than other tunneling protocols. Therefore, when choosing a tunneling protocol, users can consider using the Geneve tunnel. In Istio 1.18, the eBPF mode of Ambient Mesh is newly introduced, which can provide better network efficiency, but has higher requirements for the Linux kernel version. Users can choose according to their actual situation.\n\n## References\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid) . TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb) , or [contact us for a quick demo](https:\/\/tetr8.io\/contact) .\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/using-geneve-tunnels-to-implement-istio-ambient-mesh-traffic-interception\/).*\n', '\/en\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/istio-certificates-management/">How Are Certificates Managed in Istio?</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 30, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How Are Certificates Managed in Istio?', 'This blog post will explain how Istio handles certificate management.', '\nI mentioned in [my last article](\/blog\/understanding-the-tls-encryption-in-istio\/) on understanding mTLS traffic encryption in Istio that the key to traffic encryption is certificate management. We can use the built-in certificate authority (CA) in Istio or a custom CA to manage certificates within the mesh. This blog post will explain how Istio handles certificate management.\n\n## What Is a Certificate?\n\nThere are many types of certificates, but in this article, I am explicitly referring to [X.509 V3](https:\/\/www.rfc-editor.org\/rfc\/rfc5280) certificates. X.509 certificates are a standard digital format used to identify entities in computer networks. X.509 is the international standard for public key infrastructure (PKI) and is primarily used for identity authentication and information encryption, such as TLS.\n\nThe contents of a certificate are hashed using a hash function and then signed with the issuer’s private key. This way, when a certificate is received, the recipient can use the issuer’s public key to verify the certificate’s validity.\n\nA hash function is a function that maps an input of any length (also called a message) to a fixed-length output, also called a *hash value* or *message digest*. There are many hash functions, such as MD5, SHA-1, etc.\n\nA certificate is like a business card issued by an authoritative agency for the user to prove their identity, and it can also be used to encrypt information to ensure the security and integrity of communication. The following diagram shows the general steps of TLS communication, where the certificate proves the server’s identity and encrypts the communication.\n\nFigure 1 shows an example of an HTTP call to a website, issuing a digital certificate, authenticating, and encrypting the communication.\n\n![Figure 1. TLS certificate issuance and validation process](tls.svg)\n\nHere are the detailed steps:\n\n1. The server (website owner) submits a certificate signing request to the CA;\n2. The CA verifies the server’s identity and the authenticity of the website and issues a digital certificate to the server, which the server installs so that visitors can verify the website’s security;\n3. The user sends a request to the website through a browser (client);\n4. The server returns the TLS certificate to the client;\n5. The client verifies the certificate’s validity with the CA and establishes the connection if the certificate is valid, or prompts the user to reject the connection if it is invalid;\n6. The client generates a pair of random public and private keys;\n7. The client sends its public key to the server;\n8. The server encrypts the message using the client’s public key;\n9. The server sends the encrypted data to the client;\n10. The client decrypts the data sent by the server using its private key.\n\nAt this point, both parties have established a secure channel and can transmit encrypted data in both directions.\n\n## How to Generate Certificates\n\nYou can generate X.509 certificates with the following open-source tools:\n\n- [Easy-RSA](https:\/\/github.com\/OpenVPN\/easy-rsa): A simple command-line tool maintained by the OpenVPN project, EasyRSA can easily generate secure certificates and keys for the OpenVPN network.\n- [OpenSSL](https:\/\/github.com\/openssl\/openssl): Originated by an individual in 1995 and now maintained by an independent organization, OpenSSL provides only a command-line tool.\n- [CFSSL](https:\/\/github.com\/cloudflare\/cfssl): Developed and maintained by CloudFlare, CFSSL is not just a command-line tool for generating certificates but also can serve as a PKI server.\n- [BoringSSL](https:\/\/github.com\/google\/boringssl): A branch of OpenSSL developed and maintained by Google, BoringSSL is used in the Chrome browser and Android operating system.\n\nSince most people are probably familiar with OpenSSL, we will use OpenSSL to create certificates in the following text.\n\n## Certificate Trust Chain\n\nThe validation of a certificate requires using a certificate trust chain (Certificate Trust Chain). A certificate trust chain refers to a series of certificates used for identity verification, which form a chain starting from a trusted root certificate issuing agency, connecting downward step by step, until a specific intermediate or terminal certificate is used for verifying a particular certificate. The trustworthiness of a digital certificate increases as the certificate level increases in the certificate trust chain.\n\nIn Figure 2, you can see four trust chains.\n\n![Figure 2. Certificate trust chains](certificate-trust-chain.svg)\n\nCertificate trust chains are tree-like structures, where each CA can have one or more child CAs. There are three roles:\n\n- **Root CA:** The top-level CA can issue certificates to intermediate CAs.\n- **Intermediate CA:** They can issue end-entity certificates.\n- **End entity:** A device or service that holds an end-entity certificate.\n\nRoot CAs are the top-level issuing authorities for digital certificates, so the certificates they issue are the most trustworthy. Root certificate authorities are usually operated and regulated by government agencies or other authoritative organizations such as the International Infrastructure Security Organization. Common root CAs include:\n\n- Symantec\/VeriSign\n- Comodo\n- DigiCert\n- GlobalSign\n- GoDaddy\n- Entrust\n- GeoTrust\n- RapidSSL\n- Baltimore CyberTrust Root\n\nPlease note that the above list is just a sample. There are many other root CAs.\n\nWhen you open an HTTPS webpage in a Chrome browser, you can view the certificate information by clicking on the lock icon on the left side of the address bar, which includes the certificate trust chain, such as the certificate trust chain of [https:\/\/tetrate.io](https:\/\/tetrate.io\/) shown in Figure 3.\n\n![Figure 3. Certificate hierarchy of tetrate.io](tetrate-cert.jpg)\n\nThe certificate trust chain allows the client (such as a web browser) to verify each certificate step by step when verifying the terminal certificate to determine whether it is trustworthy. The principle of digital certificate issuance is that the CA binds the certificate owner’s public key and identity information together. Then the CA uses its proprietary private key to generate a formal digital signature to indicate that the CA issued this certificate. The digital signature on the certificate can be verified using the CA’s public key during certificate verification.\n\n## How to Incorporate Istio into the PKI Certificate Trust Chain\n\nBefore using Istio, enterprises usually have their own internal public key infrastructure . How can Istio be incorporated into the PKI certificate trust chain?\n\nIstio has built-in certificate management functions that can be used out of the box. When Istio is started, it will create a self-signed certificate for *istiod* as the root certificate for all workloads in the mesh. The problem with this is that the built-in root certificate cannot achieve mutual trust between meshes if you have multiple meshes. The correct approach is not to use Istio’s self-signed certificate, but to incorporate Istio into your certificate trust chain and integrate Istio into your PKI, creating an intermediate certificate for each PKI mesh. In this way, two meshes have a shared trust root and can achieve mutual trust between meshes.\n\nIntegrate the Istio mesh into your internal PKI certificate trust chain by creating an intermediate CA, as shown in Figure 4.\n\n![Figure 4: Create intermediate CAs for the multi-cluster mesh to enable Istio to be included in the on-premises PKI certificate trust chain](cluster-ca.svg)\n\nThere are many benefits to incorporating Istio into your company’s internal PKI certificate trust chain:\n\n- **Secure communication across grids\/clusters**: with a common trust root, clusters can verify each other’s identities and communicate with each other;\n- **More granular certificate revocation:** you can revoke the certificate of an individual entity or intermediate CA to revoke the certificate for service or cluster;\n- **Easy implementation of certificate rotation:** you can rotate certificates by cluster\/mesh rather than rotating the root node certificate, which reduces downtime. It is recommended to use [cert-manager](https:\/\/github.com\/cert-manager\/cert-manager) to achieve automated large-scale CA certificate rotation in production. For more information, see [Automate Istio CA Rotation in Production at Scale](https:\/\/tetrate.io\/blog\/automate-istio-ca-rotation-in-production-at-scale\/);\n\nFor detailed instructions on incorporating Istio into your company’s internal PKI certificate trust chain, see [this blog post](https:\/\/tetrate.io\/blog\/istio-trust\/).\n\n## Steps for Using a Custom CA in Istio\n\nBy default, the Istio CA generates a self-signed root certificate and key and uses them to sign workload certificates. To protect the root CA key, you should use a root CA that runs offline on a secure machine and the root CA to issue intermediate certificates to the Istio CA running on each cluster. The Istio CA can then use the administrator-specified certificate and key to sign workload certificates and distribute the administrator-specified root certificate as the trusted root to workloads.\n\nFigure 5 shows the certificate issuance and mounting process in Istio.\n\n![Figure 5. Certificate issuance and mounting process in Istio](cert-process.svg)\n\n1. In Istio, the Envoy proxy injects two processes into the Pod: *envoy* and *pilot-agent*. The *pilot-agent* generates a private key and uses the Secret Discovery Service (SDS) via a Unix Domain Socket (UDS) to request a certificate signing request (CSR) from the Certificate Authority (CA) through the *istiod*, if you have not configured the CA plugin.\n2. *istiod*, which has a built-in CA, returns the certificate to the *pilot-agent*.\n3. The *pilot-agent* then sends the generated private key and the CA-returned certificate to the Envoy instance to mount.\n\nIstio defaults to using the CA built into *istiod*, but also supports injecting other CAs, see the [Istio documentation](https:\/\/istio.io\/latest\/docs\/tasks\/security\/cert-management\/plugin-ca-cert\/). Suppose you want to create identities for your services using custom CA certificates and keys. In that case, you will need to:\n\n- Create a CA configuration file and use it to create self-signed CA root certificates and keys.\n- Create a private key and signing request configuration files for the service.\n- Create a certificate signing request (CSR) for the service.\n- Use the root certificate and key, along with the service’s signing request file, to create a certificate for the service.\n\nNext, we will detail the process of creating and mounting a certificate for the Bookinfo *productpage* service using Istio’s built-in CA as an example.\n\n## Process for Istio’s Built-in CA to Issue a Certificate\n\nWhen Istio starts, it creates a self-signed CA certificate, which it then uses to issue certificates to services within the mesh. Below, we will manually simulate the steps for Istio’s built-in CA to issue a certificate:\n\n**Step 1:** Create a CA private key **ca.key**:\n\n\u0060\u0060\u0060bash\nopenssl genrsa -out ca.key\n\u0060\u0060\u0060\n\n**Step 2:** Create a CA configuration file **ca.conf**:\n\n\u0060\u0060\u0060ini\n[ req ]\ndefault_bits = 2048\nprompt = no\nutf8 = yes\nencrypt_key = no\ndistinguished_name  = req_dn\nreq_extensions = req_ext\nx509_extensions = req_ext\n\n[ req_dn ]\nO = Istio\nCN = Root CA\n\n[ req_ext ]\nsubjectKeyIdentifier = hash\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign\n\u0060\u0060\u0060\n\n**Step 3:** Use the CA private key **ca.key** to generate a self-signed certificate **ca.pem**, which contains the CA’s information in the subject:\n\n\u0060\u0060\u0060bash\nopenssl req -x509 -new -nodes -key ca.key -days 365 -out ca.pem -config ca.conf\n\u0060\u0060\u0060\n\n**Step 4:** Create the workload’s private key **workload.key**:\n\n\u0060\u0060\u0060bash\nopenssl genrsa -out workload.key\n\u0060\u0060\u0060\n\n**Step 5:** Create a certificate signing request configuration file **csr.conf**, which contains the address of the CA and additional information:\n\n\u0060\u0060\u0060ini\n[ req ]\ndefault_bits = 2048\nprompt = no\nutf8 = yes\nencrypt_key = no\ndistinguished_name  = dn\nreq_extensions = req_ext\nx509_extensions = req_ext\n\n[ req_dn ]\nO = Istio\nCN = productpage\n\n[ req_ext ]\nsubjectKeyIdentifier = hash\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign\n\u0060\u0060\u0060\n\n**Step 6:** Create a certificate signing request **workload.csr** based on the workload’s CSR configuration file **csr.conf** and the workload’s private key file **workload.key**:\n\n\u0060\u0060\u0060bash\nopenssl req -new -key workload.key -out workload.csr -config csr.conf\n\u0060\u0060\u0060\n\n**Step 7:** Create certificate **workload.pem** based on CA’s private key **ca.key**, CA’s certificate **ca.pem** and workload’s certificate signing request:\n\n\u0060\u0060\u0060bash\nopenssl x509 -req -in workload.csr -CA ca.pem -CAkey ca.key \\\n    -CAcreateserial -out workload.pem -days 365 \\\n    -extensions req_ext -extfile csr.conf -sha256\n\u0060\u0060\u0060\n\n**Step 8:** View the certificate chain mounted by the Envoy proxy in the workload:\n\n\u0060\u0060\u0060bash\nistioctl proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes\u0027 | base64 --decode \u003e chain.pem\n\u0060\u0060\u0060\n\nThe **chain.pem** file holds the certificate chain for the *productpage* service. Because we use the Istio built-in CA as the root CA, only one certificate is stored in this file, which can be viewed by running the following command:\n\n\u0060\u0060\u0060bash\nopenssl x509 -noout -text -in chain.pem\n\u0060\u0060\u0060\n\n**Step 9:** View the root certificate mounted by the Envoy proxy:\n\n\u0060\u0060\u0060bash\nistioctl proxy-config secret deployment\/productpage-v1 -o json | jq -r \\\n\u0027.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes\u0027 | base64 --decode \u003e root.pem\n\u0060\u0060\u0060\n\n**root.pem** is the root certificate, run the following command to view:\n\n\u0060\u0060\u0060bash\nopenssl x509 -noout -text -in root.pem\n\u0060\u0060\u0060\n\nAfter the certificate is mounted to the Envoy proxy, *istiod* will take care of periodically replacing the key certificate and revoking the key certificate as needed.\n\n## Summary\n\nThis article introduces you to the function of digital certificates and the trust chain, and how the built-in, out-of-the-box certificate manager operates in Istio. However, the built-in CA in Istio still has certain limitations. In the next blog, I will introduce how to use the SPIRE and cert-manager plugins to achieve fine-grained certificate management and automatic certificate rotation.\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid). TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb), or [contact us for a quick demo](https:\/\/tetr8.io\/contact).\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/how-are-certificates-managed-in-istio\/).*\n', '\/en\/blog\/istio-certificates-management\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This blog post will explain how Istio handles certificate management.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/en/categories/istio/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/en/categories/istio/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/en/categories/istio/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item page-item active ">
           <a href="/en/categories/istio/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/en/categories/istio/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/en/categories/istio/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
       
       
       
         <li class="page-item">
           <a href="/en/categories/istio/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
     
     
     <li class="page-item">
       <a href="/en/categories/istio/page/3/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/en/categories/istio/page/5/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Columns
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(45)</span>
        </a>
      
        <a href="/en/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(12)</span>
        </a>
      
        <a href="/en/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/cloud-native" class="sidebar-item">
            <span>Cloud Native</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/essays" class="sidebar-item">
            <span>Essays</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/open-source" class="sidebar-item">
            <span>Open Source</span>
            <span>(2)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Book
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/translation" class="sidebar-item">
            <span>Translation</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/original" class="sidebar-item">
            <span>Original</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">Contact</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s LinkedIn</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-linkedin.png" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Blog</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/multi-cluster-pki-istio-recipe/">Multi-Cluster PKI &#43; Istio Recipe: Practical Example for a Trusted and Scalable PKI for Your Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/envoy-tracing/">How the Envoy Proxy Handles User Requests for Tracing</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/introducing-kmesh-kernel-native-service-mesh/">Introducing Kmesh: Revolutionizing Service Mesh Data Planes with Kernel-Native Technology</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">links</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" >
                  Awesome Cloud Native
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://gateway.envoyproxy.io" target="_blank" rel="noopener noreferrer">
                  Envoy Gateway
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io" target="_blank" rel="noopener noreferrer">
                  Istio
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate - Service Mesh Company
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://docs.tetrate.io/istio-subscription/" target="_blank" rel="noopener noreferrer">
                  Tetrate Istio Subscription
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Courses</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener noreferrer">
                  Envoy Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener noreferrer">
                  Istio Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">new notice</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-china-2024-panel/">KubeCon China 2024 panel Preview: Istio and Modern API Gateways – Leading the Future of Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/website-revamp-notice/">Website Revamp Notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-eu-2024/">See you in KubeCon Paris!</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>









<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>






  





<script src="/js/wowchemy-search.min.ce03c611044441cf6e84f9e4bef20818.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
