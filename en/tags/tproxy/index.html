<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  
  <title>Tproxy - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="Jimmy Song&#39;s Blog">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/en/tags/tproxy/" />
  <meta property="og:title" content="Tproxy | Jimmy Song" />
  <meta property="twitter:title" content="Tproxy | Jimmy Song" />

  
  <meta property="og:description" content="Jimmy Song&#39;s Blog" />
  <meta property="twitter:description" content="Jimmy Song&#39;s Blog" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/en">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/blog">Blog</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/tags">Tags</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/notice">Notice</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/contact">Contact</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/en/about">About</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    
                  
                
              
              
              
                
                  
                    
                    <a class="nav-link" href="/tags/tproxy/">中文</a>
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>Search</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>Search</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="Close"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="Input the keyword" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="Input the keyword">
        
        <div class="mt-4">
          <span>Search type: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">All</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">Blog</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">Book</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">Notice</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Tproxy
                </p>
                <p class="page-description">
                    
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/preserve-source-ip-in-istio/">Maintaining Traffic Transparency: Preserving Client Source IP in Istio</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Feb 28, 2024</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Maintaining Traffic Transparency: Preserving Client Source IP in Istio', 'This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.', '\nThis blog post analyzes the challenges of server-side obtaining the client source IP in the Istio service mesh and provides solutions. The following topics will be covered:\n\n- Reasons for the loss of source IP during packet transmission.\n- How to identify the client source IP.\n- Strategies for passing source IP in north-south and east-west requests.\n- Handling methods for HTTP and TCP protocols.\n\n## The Importance of Preserving Source IP\n\nThe main reasons for preserving the client source IP include:\n\n- **Access Control Policies**: Performing authentication or security policies based on source IP.\n- **Load Balancing**: Implementing request routing based on the client IP.\n- **Data Analysis**: Access logs and monitoring metrics containing the actual source address, aiding developers in analysis.\n\n## Meaning of Preserving Source IP\n\nPreserving the source IP refers to avoiding the situation where the actual client source IP is replaced as the request goes out from the client, and passes through a load balancer or reverse proxy.\n\nHere is an example process of source IP address lost:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant LB as Load Balancer\n    participant IG as Ingress Gateway\n    participant S as Server\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Altered Request (IP Changed)\n    IG-\u003e\u003eS: Forwarded Request\n    Note over IG,S: Source IP Lost\n\u0060\u0060\u0060\n\n![Mermaid Diagram](9a331cc374c51421ecb64e58b25a6c4d.svg)\n\nThe above diagram represents the most common scenario. This article considers the following cases:\n\n1. North-South Traffic: Clients accessing servers through a load balancer (gateway)\n   1. Single-tier gateway\n   2. Multi-tier gateways\n2. East-West Traffic: Service-to-service communication within the mesh\n3. Protocols: HTTP and TCP\n\n## How to Confirm Client Source IP?\n\nIn the Istio service mesh, Envoy proxies typically add the client IP to the \u0022X-Forwarded-For\u0022 header of HTTP requests. Here are the steps to confirm the client IP:\n\n1. **Check the X-Forwarded-For Header**: It contains the IP addresses of various proxies along the request path.\n2. **Select the Last IP**: Usually, the last IP is the client IP closest to the server.\n3. **Verify the IP\u0027s Trustworthiness**: Check the trustworthiness of the proxy servers.\n4. **Use X-Envoy-External-Address**: Envoy can set this header, which includes the real client IP.\n\nFor more details, refer to the Envoy documentation on the [\u0060x-forwarded-for\u0060 header](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#config-http-conn-man-headers-x-forwarded-for). For TCP\/IP connections, you can parse the client IP from the protocol field.\n\n## Testing Environment\n\n**GKE**\n\n- Client Version: v1.28.4\n- Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3\n- Server Version: v1.27.7-gke.1121000\n\n**Istio**\n\n- Client version: 1.20.1\n- Control plane version: 1.20.1\n- Data plane version: 1.20.1 (12 proxies)\n\n**CNI**\n\nWe use Cilium CNI but have not enabled the kube-proxy-less mode.\n\n- cilium-cli: v0.15.18 compiled with go1.21.5 on darwin\/amd64\n- cilium image (default): v1.14.4\n- cilium image (stable): unknown\n- cilium image (running): 1.14.5\n\n**Node**\n\n| Node Name                              | Internal IP | Remarks                   |\n| --------------------------------------| ----------- | --------------------------|\n| gke-cluster1-default-pool-5e4152ba-t5h3 | 10.128.0.53 |                          |\n| gke-cluster1-default-pool-5e4152ba-ubc9 | 10.128.0.52 |                          |\n| gke-cluster1-default-pool-5e4152ba-yzbg | 10.128.0.54 | Ingress Gateway Pod Node  |\n\nPublic IP of the local client computer used for testing: \u0060123.120.247.15\u0060\n\n## Deploying Test Example\n\nThe following diagram illustrates the testing approach:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant LB as Load Balancer\n    participant IG as Ingress Gateway\n    participant S as Echo Server\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Forward Request \n    IG-\u003e\u003eS: Forwarded Request\n\u0060\u0060\u0060\n\n![Mermaid Diagram](5f7a7c047a92dbcba5c733f206727c6a.svg)\n\nFirst, deploy Istio according to the [Istio documentation](https:\/\/istio.io\/latest\/docs\/setup\/install\/), and then enable sidecar auto-injection for the default namespace:\n\n\u0060\u0060\u0060bash\nkubectl label namespace default istio-injection=enabled\n\u0060\u0060\u0060\n\nDeploy the \u0060echo-server\u0060 application in Istio:\n\n\u0060\u0060\u0060bash\nkubectl create deployment echo-server --image=registry.k8s.io\/echoserver:1.4\nkubectl expose deployment echo-server --name=clusterip --port=80 --target-port=8080\n\u0060\u0060\u0060\n\nCreate an Ingress Gateway:\n\n\u0060\u0060\u0060bash\ncat \u003e config.yaml \u003c\u003cEOF\napiVersion: networking.istio.io\/v1beta1\nkind: Gateway\nmetadata:\n  name: clusterip-gateway\nspec:\n  selector:\n    istio: ingressgateway # Choose the appropriate selector for your environment\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n        - \u0022clusterip.jimmysong.io\u0022 # Replace with the desired hostname\n---\napiVersion: networking.istio.io\/v1beta1\nkind: VirtualService\nmetadata:\n  name: clusterip-virtualservice\nspec:\n  hosts:\n    - \u0022clusterip.jimmysong.io\u0022 # Replace with the same hostname as in the Gateway\n  gateways:\n    - clusterip-gateway # Use the name of the Gateway here\n  http:\n    - route:\n        - destination:\n            host: clusterip.default.svc.cluster.local # Replace with the actual hostname of your Service\n            port:\n              number: 80 # Port of the Service\nEOF\nkubectl apply -f config.yaml\n\u0060\u0060\u0060\n\nView the Envoy logs in the Ingress Gateway:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/istio-ingressgateway -n istio-system\n\u0060\u0060\u0060\n\nView the Envoy logs in the Sleep Pod:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/sleep -n default -c istio-proxy\n\u0060\u0060\u0060\n\nView the Envoy logs in the Echo Server:\n\n\u0060\u0060\u0060bash\nkubectl logs -f deployment\/echo-server -n default -c istio-proxy\n\u0060\u0060\u0060\n\nGet the public IP of the gateway:\n\n\u0060\u0060\u0060bash\nexport GATEWAY_IP=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=\u0027{.status.loadBalancer.ingress[0].ip}\u0027)\n\u0060\u0060\u0060\n\nTest locally using curl:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n### Resource IP\n\nAfter deploying the test application, you need to obtain the IP addresses of the following resources, which will be used in the upcoming experiments.\n\n**Pod**\n\nHere are the initial Pod IPs, but please note that as patches are applied to the Deployment, Pods may be recreated, and their names and IP addresses may change.\n\n| Pod Name                              | Pod IP      |\n| ------------------------------------- | ----------- |\n| echo-server-6d9f5d97d7-fznrq          | 10.32.1.205 |\n| sleep-9454cc476-2dskx                 | 10.32.3.202 |\n| istio-ingressgateway-6c96bdcd74-zh46d | 10.32.1.221 |\n\n**Service**\n\n| Service Name         | Cluster IP  | External IP   |\n| -------------------- | ----------- | ------------- |\n| clusterip            | 10.36.8.86  | -             |\n| sleep                | 10.36.14.12 | -             |\n| istio-ingressgateway | 10.36.4.127 | 35.188.212.88 |\n\n## North-South Traffic\n\nLet\u0027s first consider the scenario where the client is outside the Kubernetes cluster and accesses internal services through a load balancer.\n\n### Test 1: Cluster Traffic Policy, iptables Traffic Hijacking\n\nThis is the default situation after deploying the test application using the steps above, and it represents the commonly encountered scenario where the source IP address is said to be lost.\n\ncurl test:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n\n{{\u003chighlight text \u0022linenos=table,hl_lines=2 21 23\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip.jimmysong.io:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip.jimmysong.io\nuser-agent=curl\/8.4.0\nx-b3-parentspanid=03c124c5f910001a\nx-b3-sampled=1\nx-b3-spanid=103dc912ec14f3b4\nx-b3-traceid=140ffa034822077f03c124c5f910001a\nx-envoy-attempt-count=1\nx-envoy-internal=true\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\nx-forwarded-for=10.128.0.54\nx-forwarded-proto=http\nx-request-id=b3c05e22-594e-98da-ab23-da711a8f53ec\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n\n{{\u003c\/detail\u003e}}\n\nYou only need to focus on the \u0060client_address\u0060 and \u0060x-forwarded-for\u0060 results. Other information in the curl test results will be omitted in the following curl test results.\n\n{{\u003ccallout note Explanation\u003e}}\n\nMeaning of fields in the results:\n\n- \u0060client_address\u0060: The client IP address obtained through TCP\/IP protocol resolution, referred to as the remote address in Envoy.\n- \u0060x-forwarded-for\u0060: \u0060x-forwarded-for\u0060 (XFF) is a standard proxy header used to indicate the IP addresses that the request has passed through from the client to the server. A compliant proxy will add the IP address of the most recent client to the XFF list before proxying the request. See [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for details.\n\n{{\u003c\/callout\u003e}}\n\nFrom the test results, we can see that the source IP address becomes the IP address of the Ingress Gateway Pod\u0027s node (\u006010.128.0.54\u0060).\n\nThe following diagram shows the packet flow paths between the two Pods.\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph IngressGatewayPod[Ingress Gateway Pod]\nA[\u0022Downstream Remote (Ingress Gateway Node)\u003cbr\u003e10.128.0.54:56532\u0022] --\u003e B\n    B[\u0022Downstream Local (Ingresss Gateway Pod)\u003cbr\u003e10.32.1.221:8080\u0022]--\u003eC\n    C[\u0022Upstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:59842\u0022]\n    C --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\n    E[\u0022Downstream Remote (Ingress Gateway Pod)\u003cbr\u003e10.128.0.54:0\u0022] --\u003e F\n    F[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    G[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:60481\u0022]\n    H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    F --\u003e G\n    G --\u003e H\nend\nIngressGatewayPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](77c177b53601d1d83794cc1b2f4a8b5a.svg)\n\nFor this scenario, preserving the source IP is straightforward and is also a standard option provided by Kubernetes.\n\n### How is the Source IP Lost?\n\nThe following diagram shows how the source IP of the client is lost during the request process.\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\u003cbr\u003e123.120.247.15\n    participant LB as Load Balancer\u003cbr\u003e35.188.212.88\n    participant IG as Ingress Gateway\u003cbr\u003e10.32.1.221\n    participant S as Echo Server Pod\u003cbr\u003e10.32.1.205\n    C-\u003e\u003eLB: Initial Request\n    LB-\u003e\u003eIG: Altered Request (IP Changed)\u003cbr\u003eSNAT: 123.120.234.15 -\u003e 10.128.0.54\n    IG-\u003e\u003eS: Forwarded Request\n    Note over IG,S: Source IP Lost\n\u0060\u0060\u0060\n\n![Mermaid Diagram](708e3a4981b7deadfb203257e2ac5a64.svg)\n\nBecause the load balancer sends packets to any node in the Kubernetes cluster, SNAT is performed during this process, resulting in the loss of the client\u0027s source IP when it reaches the Server Pod.\n\n### How to Preserve the Client Source IP\n\nYou can control the load balancer to preserve the source IP by setting the \u0060externalTrafficPolicy\u0060 field in the service to \u0060Local\u0060.\n\n**externalTrafficPolicy**\n\n\u0060externalTrafficPolicy\u0060 is a standard [Service option](https:\/\/kubernetes.io\/docs\/tasks\/access-application-cluster\/create-external-load-balancer\/#preserving-the-client-source-ip) that defines whether incoming traffic to Kubernetes nodes is load-balanced and how it\u0027s load-balanced. \u0060Cluster\u0060 is the default policy, but \u0060Local\u0060 is typically used to preserve the source IP of incoming traffic to cluster nodes. \u0060Local\u0060 effectively disables load balancing on the cluster nodes so that traffic received by local Pods sees the source IP address.\n\n\u0060\u0060\u0060mermaid\ngraph TD;\n    A[Client Request] --\u003e|Sent to Service| B[Load Balancer]\n    B --\u003e|externalTrafficPolicy: Local| C[Node with Service Endpoint]\n    C --\u003e|Source IP Preserved| D[Service Handling Request]\n    B --\u003e|\u0022externalTrafficPolicy: Cluster (Default)\u0022| E[Any Node in Cluster]\n    E --\u003e|Source IP Altered| D\n\u0060\u0060\u0060\n\n![Mermaid Diagram](02f4d9919bbd6f3d5fc5682c3793896a.svg)\n\nIn other words, setting \u0060externalTrafficPolicy\u0060 to \u0060Local\u0060 allows packets to bypass kube-proxy on the nodes and reach the target Pod directly. However, most people do not set \u0060externalTrafficPolicy\u0060 when creating a Service in Kubernetes, so the default \u0060Cluster\u0060 policy is used.\n\nSince using the Local external traffic policy in Service can preserve the client\u0027s source IP address, why isn\u0027t it the default in Kubernetes?\n\nThe default setting of Kubernetes Service\u0027s \u0060externalTrafficPolicy\u0060 to \u0060Cluster\u0060 instead of \u0060Local\u0060 is primarily based on the following considerations:\n\n1. **Load Balancing**: Ensures even distribution of traffic across all nodes, preventing overload on a single node.\n2. **High Availability**: Allows traffic to be received by any node in the cluster, enhancing service availability.\n3. **Simplified Configuration**: The \u0060Cluster\u0060 mode reduces the complexity of network configurations.\n4. **Performance Optimization**: Avoids potential performance issues caused by preserving the client\u0027s source IP.\n5. **Universality**: Compatible with a variety of network environments and cluster configurations, suitable for a broader range of scenarios.\n\n### Test 2: Local Traffic Policy, iptables Traffic Hijacking\n\nSet the Ingress Gateway Service to use the Local external traffic policy:\n\n\u0060\u0060\u0060bash\nkubectl patch svc istio-ingressgateway -p \u0027{\u0022spec\u0022:{\u0022externalTrafficPolicy\u0022:\u0022Local\u0022}}\u0027 -n istio-system\n\u0060\u0060\u0060\n\nCurl test:\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 $GATEWAY_IP\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n\n{{\u003chighlight text \u0022linenos=table,hl_lines=2 21 23\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip.jimmysong.io:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip.jimmysong.io\nuser-agent=curl\/8.4.0\nx-b3-parentspanid=060c393adb561603\nx-b3-sampled=1\nx-b3-spanid=8df3e10078cc826b\nx-b3-traceid=cf26040ae9536702060c393adb561603\nx-envoy-attempt-count=1\nx-envoy-external-address=123.120.247.15\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=79253e34e1c28d389e9bfb1a62ffe8944b2c3c369b46bf4a9faf055b55dedb7f;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/istio-system\/sa\/istio-ingressgateway-service-account\nx-forwarded-for=123.120.247.15\nx-forwarded-proto=http\nx-request-id=35bc2123-0971-9a9c-84c1-2aeee233a268\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nFrom the Envoy logs, we can see the current packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph IngressGatewayPod[Ingress Gateway Pod]\n    B[\u0022Downstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:8080\u0022]\n    C[\u0022Upstream Local (Ingress Gateway Pod)\u003cbr\u003e10.32.1.221:59842\u0022]\nA[\u0022Downstream Remote (Client)\u003cbr\u003e123.120.247.15:62650\u0022] --\u003e B\nB --\u003e C\nC --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\n    F[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\n    G[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:58639\u0022]\n    H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.205:8080\u0022]\nE[\u0022Downstream Remote (Client)\u003cbr\u003e123.120.247.15:0\u0022] --\u003e F\nF --\u003e G\nG --\u003e H\nend\nIngressGatewayPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](bd32b793946c9c3457a8a10db33f395d.svg)\n\nThe client\u0027s source IP is correctly identified as \u0060123.120.247.15\u0060.\n\n## East-West Traffic\n\nIn the default Istio configuration, for east-west traffic as well, the server cannot obtain the correct client source IP.\n\n### Test 3: Local Traffic Policy, tproxy Traffic Hijacking\n\nChange the traffic interception method from iptables to [tproxy](\/en\/blog\/what-is-tproxy\/) for the Echo Server:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment -n default echo-server -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022sidecar.istio.io\/interceptionMode\u0022:\u0022TPROXY\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: At this point, the Pod for Echo Server will be recreated, and the new Pod\u0027s name is \u0060echo-server-686d564647-r7nlq\u0060, with an IP address of 10.32.1.140.\n\nCurl test:\n\n\u0060\u0060\u0060bash\nkubectl exec -it deployment\/sleep -it -- curl clusterip\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n{{\u003chighlight text \u0022linenos=table,hl_lines=2\u0022\u003e}}\nCLIENT VALUES:\nclient_address=10.32.3.202\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip\nuser-agent=curl\/8.5.0\nx-b3-parentspanid=3c07f3b87cc547dd\nx-b3-sampled=1\nx-b3-spanid=97844ebdde748bfc\nx-b3-traceid=90f57b0fb260dfbf3c07f3b87cc547dd\nx-envoy-attempt-count=1\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\nx-forwarded-proto=http\nx-request-id=e9b27bde-3cf6-9d8b-8f23-1cb0fa35d405\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nThe diagram below illustrates the packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph SleepPod[Sleep Pod]\nA[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:38394\u0022] --\u003e B\nB[\u0022Downstream Local (Clusterip Service)\u003cbr\u003e10.36.8.86:80\u0022] --\u003e C\nC[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:33786\u0022] --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022]\nend\nsubgraph SourceIPAppPod[Echo Server Pod]\nE[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:33786\u0022] --\u003e F\nF[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022] --\u003e G\nG[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:34173\u0022] --\u003e H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.140:8080\u0022]\nend\nSleepPod--\u003eSourceIPAppPod\n\u0060\u0060\u0060\n\n![Mermaid Diagram](eb87f7cdfe68c1b653b431af7281f2c9.svg)\n\nThe client\u0027s IP is correctly identified as \u006010.32.3.202\u0060.\n\n### Test 4: Local Traffic Policy, iptables Traffic Hijacking\n\nRestore the traffic interception method in the Echo Server to redirect:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment -n default echo-server -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022sidecar.istio.io\/interceptionMode\u0022:\u0022REDIRECT\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: At this point, the Pod for the Echo Server will be recreated, and the new Pod\u0027s name is \u0060echo-server-6d9f5d97d7-bgpk6\u0060, with an IP address of 10.32.1.123.\n\nCurl test:\n\n\u0060\u0060\u0060bash\nkubectl exec -it deployment\/sleep -it -- curl clusterip\n\u0060\u0060\u0060\n\n{{\u003cdetail \u0022View Results\u0022\u003e}}\n{{\u003chighlight text \u0022linenos=table,hl_lines=2\u0022\u003e}}\nCLIENT VALUES:\nclient_address=127.0.0.6\ncommand=GET\nreal path=\/\nquery=nil\nrequest_version=1.1\nrequest_uri=http:\/\/clusterip:8080\/\n\nSERVER VALUES:\nserver_version=nginx: 1.10.0 - lua: 10001\n\nHEADERS RECEIVED:\naccept=*\/*\nhost=clusterip\nuser-agent=curl\/8.5.0\nx-b3-parentspanid=6123380e58ca0ce7\nx-b3-sampled=1\nx-b3-spanid=633848c0065ec91e\nx-b3-traceid=dbcda8b3673e70a46123380e58ca0ce7\nx-envoy-attempt-count=1\nx-forwarded-client-cert=By=spiffe:\/\/cluster.local\/ns\/default\/sa\/default;Hash=25af59fcf9fbe745eb75a318c47d55059d75914632d2536a43a80d342eaed27c;Subject=\u0022\u0022;URI=spiffe:\/\/cluster.local\/ns\/default\/sa\/sleep\nx-forwarded-proto=http\nx-request-id=b05e07e1-08ba-9449-90a9-a4a98277a8c0\nBODY:\n-no body in request-\n{{\u003c\/highlight\u003e}}\n{{\u003c\/detail\u003e}}\n\nThe diagram below illustrates the packet path:\n\n\u0060\u0060\u0060mermaid\ngraph LR\nsubgraph Sleep[Sleep Pod]\nA[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:34238\u0022] --\u003e B\nB[\u0022Downstream Local (Clusterip Service)\u003cbr\u003e10.36.8.86:80\u0022] --\u003e C\nC[\u0022Upstream Local (Sleep Pod)\u003cbr\u003e10.32.3.202:52776\u0022] --\u003e D[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022]\nend\nsubgraph SourceIPApp[Echo Server Pod]\nE[\u0022Downstream Remote (Sleep Pod)\u003cbr\u003e10.32.3.202:52776\u0022] --\u003e F\nF[\u0022Downstream Local (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022] --\u003e G\nG[\u0022Upstream Local (InboundPassthroughClusterIpv4)\u003cbr\u003e127.0.0.6:49803\u0022] --\u003e H[\u0022Upstream Host (Echo Server Pod)\u003cbr\u003e10.32.1.123:8080\u0022]\nend\nSleep --\u003eSourceIPApp\n\u0060\u0060\u0060\n\n![Mermaid Diagram](ae5e1e766d0262189226721772529ec8.svg)\n\nThe client\u0027s source IP is identified as \u0060127.0.0.6\u0060.\n\n## Summary for Single-Layer Proxy Scenario\n\nIn a single-tier proxy scenario, you only need to set the \u0060externalTrafficPolicy\u0060 of the Ingress Gateway\u0027s Service to \u0060Local\u0060 to preserve the client\u0027s source IP. Modifying the traffic interception mode of the target service to \u0060TPROXY\u0060 will preserve the source IP in east-west requests.\n\n## Multi-Layer Proxy\n\nIf traffic has already passed through multiple tiers of proxies before entering the Istio Mesh, each time traffic passes through a proxy, the proxy parses the HTTP traffic and appends its own IP address to the \u0060x-forwarded-for\u0060 header. You can use the \u0060numTrustedProxies\u0060 configuration to specify the number of trusted proxy hops, referring to the [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for how to determine the \u0060X-Forwarded-For\u0060 header and trusted client addresses.\n\nIn practice, it can be challenging to determine how many tiers of proxy traffic have passed through before reaching the Istio Mesh, but you can use the \u0060x-forwarded-for\u0060 header to understand the forwarding path of the traffic.\n\nThe diagram below shows how Envoy confirms the source IP based on the \u0060x-forwarded-for\u0060 header and \u0060xff_num_trusted_hops\u0060 (corresponding to the \u0060numTrustedProxies\u0060 configuration in Istio). See the [Envoy documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for) for details.\n\n\u0060\u0060\u0060mermaid\ngraph TD\n    A[Start] --\u003e|use_remote_address is false| B[Check XFF]\n    A --\u003e|use_remote_address is true| G[Check xff_num_trusted_hops]\n    B --\u003e|XFF contains at least one IP| C[Use last IP in XFF]\n    B --\u003e|XFF is empty| D[Use immediate downstream IP]\n    G --\u003e|xff_num_trusted_hops \u003e 0| H[\u0022Use (N)th IP from right in XFF\u0022]\n    G --\u003e|xff_num_trusted_hops \u003c= 0| D\n    H --\u003e|XFF contains \u003e= N addresses| I[Use Nth address from right]\n    H --\u003e|XFF contains \u003c N addresses| D\n\u0060\u0060\u0060\n\n![Mermaid Diagram](b82caafefa304b53c996da072373043a.svg)\n\nExecute the following command to enable trusted proxy configuration for the Ingress Gateway:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{\\\u0022gatewayTopology\\\u0022:{\\\u0022numTrustedProxies\\\u0022: 2,\\\u0022forwardClientCertDetails\\\u0022:\\\u0022SANITIZE_SET\\\u0022}}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nWhen the Istio Gateway receives a request, it sets the \u0060X-Envoy-External-Address\u0060 header to the second-to-last address in your \u0060X-Forwarded-For\u0060 header in the curl command (\u0060numTrustedProxies: 2\u0060). According to Istio\u0027s documentation, the Gateway appends its own IP to the \u0060X-Forwarded-For\u0060 header before forwarding it to the service sidecar. However, in practice, only the client source IP and the External Gateway Pod IP are present in the header.\n\nYou can undo this patch by executing the following command:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\n## TCP Traffic\n\nThe method mentioned above for obtaining the client source IP using headers applies only to L7 networks. For L4 network TCP traffic, you can use the Proxy Protocol.\n\nThe Proxy Protocol is a network protocol that adds a header at the beginning of a TCP connection to pass along some metadata, such as the client\u0027s real IP address and port number, during the connection establishment. This is particularly useful for applications deployed behind load balancers (LB) because load balancers often change the original IP address of the client to the LB\u0027s address, making it difficult for the server to know the real client\u0027s IP. Many proxy software supports the Proxy Protocol, including [Envoy](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/listeners\/listener_filters\/proxy_protocol), HAProxy, NGINX, and others.\n\nYou can use the following command to patch the Ingress Gateway to support the Proxy Protocol:\n\n\u0060\u0060\u0060bash\nkubectl patch deployment istio-ingressgateway -n istio-system -p \u0027{\u0022spec\u0022:{\u0022template\u0022:{\u0022metadata\u0022:{\u0022annotations\u0022:{\u0022proxy.istio.io\/config\u0022:\u0022{\\\\\u0022gatewayTopology\\\\\u0022:{\\\\\u0022proxyProtocol\\\\\u0022:{}}}\u0022}}}}}\u0027\n\u0060\u0060\u0060\n\nNote: Not all load balancers created by \u0060LoadBalancer\u0060 type Services in Kubernetes in public clouds support this configuration. For example, GKE does not support it. To enable Proxy Protocol on AWS NLB, refer to [this blog post](https:\/\/istio.io\/latest\/blog\/2020\/show-source-ip\/).\n\nIt\u0027s worth noting that Envoy does not recommend using the Proxy Protocol because it:\n\n- Only supports the TCP protocol.\n- Requires upstream hosts to support it.\n- May impact performance.\n\nFor Envoy\u0027s support of the Proxy Protocol, refer to [this documentation](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/other_features\/ip_transparency#proxy-protocol).\n\n## Use Case Examples\n\nThe following are common scenarios for source IP addresses.\n\n### Access Control Based on Source IP Address\n\nIn Istio, you can configure access control policies based on source IP using the Ingress Gateway. This is achieved by setting the authorization policy for the Ingress Gateway to restrict access based on source IP addresses.\n\nThe following diagram shows the flow of traffic:\n\n\u0060\u0060\u0060mermaid\nsequenceDiagram\n    participant C as Client\n    participant P1 as Proxy 1\n    participant P2 as Proxy 2\n    participant Pn as Proxy N\n    participant IG as Ingress Gateway\n    participant S as Service\n\n    C-\u003e\u003e\u002bP1: Request with Source IP\n    P1-\u003e\u003e\u002bP2: Forward Request\n    P2-\u003e\u003e\u002bPn: Forward Request\n    Pn-\u003e\u003e\u002bIG: Forward Request\n    Note over IG: numTrustedProxies Set\n    IG-\u003e\u003e\u002bS: Forwarded Request\n    Note over IG: Authorization Policy Based on Source IP\n\u0060\u0060\u0060\n\n![Mermaid Diagram](635bc14feb9b6939b3319929849cd0b5.svg)\n\n#### Scenario Assumptions\n\nLet\u0027s assume a request passes through three proxies with IP addresses \u00601.1.1.1\u0060, \u00602.2.2.2\u0060, and \u00603.3.3.3\u0060. In the Ingress Gateway, \u0060numTrustedProxies\u0060 is set to 2, so Istio trusts the source IP as \u00602.2.2.2\u0060 (i.e., \u0060x-envoy-external-address\u0060).\n\n\u0060\u0060\u0060bash\ncurl -H \u0022Host: clusterip.jimmysong.io\u0022 -H \u0027X-Forwarded-For: 1.1.1.1,2.2.2.2,3.3.3.3\u0027 $GATEWAY_IP\n\u0060\u0060\u0060\n\n#### Blocking Specific Source IP\n\nIf you need to block requests from \u00602.2.2.2\u0060, you can use the following authorization policy:\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ingress-policy\n  namespace: istio-system\nspec:\n  selector:\n    matchLabels:\n      app: istio-ingressgateway\n  action: DENY\n  rules:\n    - from:\n        - source:\n            remoteIpBlocks:\n            - \u00222.2.2.2\/24\u0022\n\u0060\u0060\u0060\n\n#### Using the Ultimate Client IP\n\nIf you want to identify the client IP directly connected to the Istio Mesh (i.e., the last IP in \u0060x-forwarded-for\u0060, e.g., \u0060123.120.234.15\u0060), you need to configure it using \u0060ipBlocks\u0060:\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ingress-policy\n  namespace: istio-system\nspec:\n  selector:\n    matchLabels:\n      app: istio-ingressgateway\n  action: DENY\n  rules:\n    - from:\n        - source:\n            ipBlocks:\n            - \u0022123.120.234.15\/24\u0022\n\u0060\u0060\u0060\n\nThis approach, by configuring authorization policies for Istio\u0027s Ingress Gateway, allows for effective access control based on source IP. It enables administrators to set rules flexibly based on different requirements, such as blocking specific IPs or trusting the ultimate client IP, enhancing the security and flexibility of the services.\n\n#### Load Balancing Based on Source IP Address\n\nHere is an example configuration that shows how to use \u0060DestinationRule\u0060 to load balance based on source IP address:\n\n\u0060\u0060\u0060yaml\napiVersion: networking.istio.io\/v1alpha3\nkind: DestinationRule\nmetadata:\n  name: example-destination-rule\nspec:\n  host: example-service\n  trafficPolicy:\n    loadBalancer:\n      consistentHash:\n        httpHeaderName: x-forwarded-for\n\u0060\u0060\u0060\n\nNote that if connecting directly to the Istio Ingress Gateway without going through another proxy, you may need to adjust \u0060httpHeaderName\u0060 or use a different hash key, such as \u0060useSourceIp\u0060 as shown below:\n\n\u0060\u0060\u0060yaml\nspec:\n  trafficPolicy:\n    loadBalancer:\n      consistentHash:\n        useSourceIp: true\n\u0060\u0060\u0060\n\n{{\u003ccallout note Notice\u003e}}\n\n- When using source IP addresses as keys for load balancing, make sure you understand how this may affect traffic distribution, especially if the source IP addresses are unevenly distributed.\n- As mentioned above, in some environments, the original source IP may be modified by network devices (such as load balancers or NAT devices), and you need to ensure that the \u0060x-forwarded-for\u0060 header or other corresponding mechanism accurately reflects the original client IP.\n\n{{\u003c\/callout\u003e}}\n\n## Summary\n\n- Preserving the source IP is crucial for implementing access control, load balancing, and data analysis.\n- Envoy proxies use the \u0060X-Forwarded-For\u0060 header to handle the client source IP in HTTP requests.\n- By setting \u0060externalTrafficPolicy\u0060 and choosing the appropriate traffic interception method (\u0060REDIRECT\u0060 or \u0060TPROXY\u0060), you can correctly obtain the client source IP in North-South and East-West traffic.\n- When dealing with traffic that passes through multiple tiers of proxies, configuring \u0060numTrustedProxies\u0060 is crucial.\n- For TCP traffic, the Proxy Protocol is an effective solution.\n\n## References\n\n- [x-forwarded-for - envoyproxy.io](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_conn_man\/headers#x-forwarded-for)\n- [Proxy protocol on AWS NLB and Istio ingress gateway - istio.io](https:\/\/istio.io\/latest\/blog\/2020\/show-source-ip\/)\n- [Configuring Gateway Network Topology - istio.io](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/traffic-management\/network-topologies\/)\n- [IP Transparency - envoyproxy.io](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/intro\/arch_overview\/other_features\/ip_transparency)\n- [Using Source IP - kubernetes.io](https:\/\/kubernetes.io\/docs\/tutorials\/services\/source-ip\/)\n- [Proxy Protocol - github.com](https:\/\/github.com\/haproxy\/haproxy\/blob\/master\/doc\/proxy-protocol.txt)\n\n---\n\n*This blog was initially published at [tetrate.io](https:\/\/tetrate.io\/blog\/istio-source-ip-transparency\/) .*\n', '\/en\/blog\/preserve-source-ip-in-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article focuses on how to maintain transparency of the client source IP in the Istio service mesh.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/">Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               May 29, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception', 'This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.', '\nIn a previous[ blog post](\/en\/blog\/ambient-mesh-l7-traffic-path\/), I discussed how Istio Ambient Mesh uses iptables and Geneve tunnels to intercept traffic from application pods into Ztunnel. Many readers may not be familiar with this tunneling protocol, so this article will introduce the definition, packet structure and advantages of Geneve tunnels compared with the VXLAN protocol. Finally, this article will introduce how Istio Ambient Mesh applies Geneve tunnels to implement traffic interception and the new eBPF mode introduced in Istio 1.18.\n\n## Introduction to Geneve Tunnels\n\nIn order to address the lack of flexibility and security in current data transmissions, the Geneve (Generic Network Virtualization Encapsulation) network virtualization encapsulation (tunneling) protocol was created. Geneve only defines a data encapsulation format, excluding control plane information. The key advantage of Geneve over VXLAN encapsulation is that it extends the types of encapsulated protocols by adding TLV format options.\n\n### Geneve vs. VXLAN\n\nVXLAN and Geneve are both network virtualization protocols and they have many similarities. Virtualization protocols are technologies that separate virtual networks from physical networks. They allow network administrators to create multiple virtual networks in a virtual environment, each of which can have its own VLAN identifiers, IP addresses and routing. In addition, VXLAN and Geneve use UDP encapsulation, which enables them to be extended through existing network infrastructure. VXLAN and Geneve protocols are also flexible, can be used in different network topologies and are compatible with different virtualization platforms.\n\nFigure 1 shows the message structure of VXLAN and Geneve tunnels and the differences in their respective headers.\n\n![Figure 1: VXLAN and Geneve packet format schematic diagram.](vxlan-vs-geneve.svg)\n\nFrom the figure, we can see that the message structure of VXLAN and Geneve tunneling protocols is similar, with the main difference being the use of different UDP port numbers and protocol headers. VXLAN uses port 4789, while Geneve uses port 6081. The Geneve protocol header is more extendable than VXLAN.\n\nThe Geneve tunneling protocol adds variable-length options that can contain zero or more option data in TLV format, making it more scalable than VXLAN. TLV stands for Type-Length-Value, which is a format for parsing and transmitting metadata in network packets. Each metadata information in the Geneve protocol is composed of a TLV format field, making it simple to flexibly add, delete and modify these metadata.\n\nThe TLV format field contains the following data:\n\n- Type: 8-bit type field.\n- Length: 5-bit option length field, represented in multiples of 4 bytes, excluding the option header.\n- Data: Variable-length option data field, which may not exist or may be between 4 and 128 bytes.\n\nThe Geneve protocol can easily modify and extend metadata information while maintaining compatibility and flexibility by using the TLV format.\n\nPlease refer to[ RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348) for more information about VXLAN. For more information about the Geneve tunnel packet format, please refer to[ RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i).\n\n### How it Works\n\nThe Geneve tunnel is mainly used in cloud computing and virtualization scenarios, and it can encapsulate packets in a new packet for transmission in a virtual network. The Geneve tunnel uses a 24-bit VNI (Virtual Network Identifier) to transmit packets from one physical network to another. The Geneve tunnel can also use security protocols such as IPsec and TLS to protect the transmission of packets.\n\nWhen a packet reaches the destination host, the Geneve tunnel protocol will de-encapsulate the packet from the Geneve protocol header and deliver it to the destination in the virtual network. During the de-encapsulation process, the VNI information in the Geneve protocol header is used to determine the destination of the packet, ensuring that the packet is correctly routed to the destination in the virtual network.\n\nAssuming there is a virtual network with a VNI of 1001. When a packet is transmitted from one physical network to another, a tunnel can be used to track the packet during transmission by setting the VNI between the source and target physical networks to 1001. When the packet reaches the target physical network, the VNI is removed from the packet and the packet is delivered to the target physical network.\n\n### Security\n\nThe Geneve tunnel protocol itself does not provide any security mechanisms, so packets transmitted in the Geneve tunnel can be subject to threats such as packet tampering, interception and replay.\n\nTo ensure the security of packets transmitted in the Geneve tunnel, some security protocols can be used. The following are some common security protocols:\n\n1. IPsec (Internet Protocol Security): IPsec is a network layer security protocol that can encrypt, authenticate and provide integrity protection to packets in the Geneve tunnel. IPsec can provide end-to-end security.\n2. TLS (Transport Layer Security): TLS is an encryption protocol based on the transport layer that can encrypt and authenticate packets in the Geneve tunnel. TLS can provide end-to-end security.\n3. MACSec (Media Access Control Security): MACSec is a data link layer security protocol that can encrypt and authenticate packets in the Geneve tunnel. MACSec can provide link-layer security.\n\nIt should be noted that the above security protocols require corresponding configuration and deployment and may have a certain impact on performance. When choosing the appropriate security protocol, factors such as security, performance, manageability and other aspects need to be considered.\n\n## Why Choose Geneve?\n\nThe following table compares the characteristics of VXLAN and Geneve in multiple aspects.\n\n| **Feature**   | **VXLAN**                          | **Geneve**                                   |\n| ------------- | ---------------------------------- | -------------------------------------------- |\n| Header format | Fixed format                       | Extensible format                            |\n| Scalability   | More focused on L2 extension       | Better support for emerging network services |\n| Operability   | Difficult to manage and extend     | Easier to manage and extend                  |\n| Performance   | Shorter header, higher performance | Longer header, slightly lower performance    |\n\n**Table 1:** *VXLAN vs Geneve characteristics*.\n\nThe main reason for using the Geneve protocol is to combine the advantages of current network virtualization encapsulation technologies (such as VXLAN, NVGRE and STT) into one protocol. Through years of network virtualization development experience, we know that one of the most important requirements is scalability. The Geneve protocol encodes metadata using an extensible TLV structure, so it can independently develop the functionality of software and hardware endpoints to meet growing needs.\n\n## How Istio Ambient Mesh Applies Geneve Tunnels\n\nIn the[ previous blog](https:\/\/tetrate.io\/blog\/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh\/), I explained how Istio Ambient Mesh uses Ztunnel to implement L4 proxies and Figure 2 shows the L4 transparent traffic interception path using iptables and Geneve tunnels.\n\n![Figure 2: L4 Transparent Traffic Interception Path Using Iptables and Geneve Tunnels.](geneve-tunnel.svg)\nFrom the figure, we can see that:\n\n- The Istio CNI creates an \u0060istioout\u0060 network card and iptables rules on the node, transparently intercepting the outbound traffic in the node to the \u0060pistioout\u0060 virtual network card.\n- The Istio CNI creates an \u0060istioin\u0060 network card and iptables rules on the node, transparently intercepting the inbound traffic in the node to the \u0060pistioin\u0060 virtual network card.\n- The Istio CNI creates \u0060pistioin\u0060 and \u0060pistioout\u0060 network cards in ztunnel to receive data packets in the Geneve tunnel.\n\nThe two network cards \u0060pistioin\u0060 and \u0060pistioout\u0060 are created by the init container or Istio CNI (see the \u0060CreateRulesWithinNodeProxyNS\u0060 function in [net_linux.go](https:\/\/github.com\/istio\/istio\/blob\/master\/cni\/pkg\/ambient\/net_linux.go#L910)), and their IP addresses and ports are fixed. The data packets sent by the application container need to pass through the \u0060istioout\u0060 network card and be forwarded to the ztunnel container after being encapsulated in the Geneve tunnel. When the data packets are received by the ztunnel container, they are de-encapsulated and forwarded to the corresponding application containers through the \u0060pistioin\u0060 network card.\n\n## Using eBPF for Transparent Traffic Interception\n\neBPF (extended Berkeley Packet Filter) is a powerful technology that allows secure user-space programs to run within the Linux kernel. Initially developed as a technique for filtering network packets, eBPF has now been extended to other areas such as tracking system calls, performance analysis and security monitoring. The advantages of eBPF are its lightweight nature, efficiency, security and programmability. It can be used in real-time monitoring, network security, application debugging and optimization, container networking and various other fields.\n\nIstio Ambient Mesh also supports using the eBPF (extended Berkeley Packet Filter) mode for transparent traffic interception since 1.18. As shown in Figure 3, the eBPF program runs directly in the host kernel and forwards application traffic to ztunnel. Compared to the iptables-based approach, the eBPF mode can provide better network efficiency and scalability. However, it requires a higher version of the Linux kernel and is more difficult to implement.\n\n![Figure 3: Intercepting the Traffic of Application Using eBPF.](ebpf.svg)\n\nTo use the eBPF mode to run Ambient Mesh, simply set the \u0060values.cni.ambient.redirectMode\u0060 parameter to “ebpf” when installing Istio, as shown below:\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=ambient --set values.cni.ambient.redirectMode=\u0022ebpf\u0022\n\u0060\u0060\u0060\n\n## Summary\n\nThis article introduced the working principle, security and comparison with VXLAN of the Geneve tunnel protocol. In addition, it also introduced how Istio Ambient Mesh uses Geneve tunnels to implement traffic interception and discussed the advantages and disadvantages of using eBPF for transparent traffic interception. The Geneve tunnel protocol is a universal tunneling protocol that can transmit packets in virtual networks, and it has more advantages than other tunneling protocols. Therefore, when choosing a tunneling protocol, users can consider using the Geneve tunnel. In Istio 1.18, the eBPF mode of Ambient Mesh is newly introduced, which can provide better network efficiency, but has higher requirements for the Linux kernel version. Users can choose according to their actual situation.\n\n## References\n\n- [RFC 7348 Virtual eXtensible Local Area Network (VXLAN): A Framework for Overlaying Virtualized Layer 2 Networks over Layer 3 Networks](https:\/\/tools.ietf.org\/html\/rfc7348)\n- [RFC 8926 Geneve: Generic Network Virtualization Encapsulation](https:\/\/www.rfc-editor.org\/rfc\/rfc8926#name-geneve-packet-format-over-i)\n- [Istio Ambient Mesh](https:\/\/istio.io\/latest\/docs\/ops\/deployment\/architecture\/#istio-ambient-mesh)\n- [Open vSwitch Geneve(8) man page](https:\/\/www.mankier.com\/8\/ovs-vswitchd.conf.db(5))\n\n---\n\nIf you’re new to service mesh and Kubernetes security, we have a bunch of free online courses [available at Tetrate Academy](https:\/\/tetr8.io\/academy) that will quickly get you up to speed with Istio and Envoy.\n\nIf you’re looking for a fast way to get to production with Istio, check out [Tetrate Istio Distribution (TID)](https:\/\/tetr8.io\/tid) . TID is Tetrate’s hardened, fully upstream Istio distribution, with FIPS-verified builds and support available. It’s a great way to get started with Istio knowing you have a trusted distribution to begin with, have an expert team supporting you, and also have the option to get to FIPS compliance quickly if you need to.Once you have Istio up and running, you will probably need simpler ways to manage and secure your services beyond what’s available in Istio, that’s where Tetrate Service Bridge comes in. You can learn more about how Tetrate Service Bridge makes service mesh more secure, manageable, and resilient [here](https:\/\/tetr8.io\/tsb) , or [contact us for a quick demo](https:\/\/tetr8.io\/contact) .\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/using-geneve-tunnels-to-implement-istio-ambient-mesh-traffic-interception\/).*\n', '\/en\/blog\/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">This article introduces Geneve tunnels, a network virtualization protocol that can intercept Istio ambient mesh traffic more flexibly and securely than VXLAN. It also explains how Istio Ambient Mesh uses Geneve tunnels and the new eBPF mode in Istio 1.18.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/en/blog/what-is-tproxy/">How Istio&#39;s Ambient Mode Transparent Proxy - tproxy Works Under the Hood</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               Jan 5, 2023</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/en/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('How Istio\u0027s Ambient Mode Transparent Proxy - tproxy Works Under the Hood', 'Tproxy is used to intercept traffic in Istio Ambient mode.', '\nIstio’s new “ambient mode” is [an experimental, “sidecar-less” deployment model for Istio](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/). Instead of a sidecar proxy in front of every workload, ambient mode uses [*tproxy*](https:\/\/www.kernel.org\/doc\/Documentation\/networking\/tproxy.txt) and [HTTP Based Overlay Network Environment (HBONE)](https:\/\/pkg.go.dev\/github.com\/costinm\/hbone) as key technologies for transparent traffic intercepting and routing that we covered in our recent article on [transparent traffic intercepting and routing in the L4 network of Istio Ambient Mesh](https:\/\/tetrate.io\/blog\/transparent-traffic-intercepting-and-routing-in-the-l4-network-of-istio-ambient-mesh\/). In this article, we’ll take a closer look at *tproxy* and how it’s used.\n\n## What Is a Proxy For?\n\nProxies have a wide range of uses on the Internet, such as:\n\n- **Request caching:** to speed up network response, acting similarly to a CDN.\n- **Traffic filtering**: used for network supervision, blocking or allowing access to specific hosts and websites.\n- **Traffic forwarding:** used for load balancing or as a network relay.\n- **Traffic management:** fine-grained management of traffic to and from the proxy, such as publishing to different backends by percentage, timeout and retry settings, circuit breaking, etc.\n- **Security auditing:** logging and limiting client requests for billing or auditing purposes.\n\n## Proxy Types\n\nThere are a number of ways to classify proxies based on how they’re used. You can see two categories based on the location of the proxy in Figure 1:\n\n![Figure 1: Forward proxy and reverse proxy.](proxy.svg)\n\n- **Forward proxies** ([like shadowsocks](https:\/\/shadowsocks.org\/)) run on the client side and send requests to the server on behalf of the client.\n- **Reverse proxies** (often in the form of a web server) accept Internet or external requests on behalf of the server and route them to the corresponding backends.\n\nProxies may be located on the same node as the client or server or on a different node. We can classify them as **transparent** or **non-transparent** based on whether the client or server can see them. Figure 2 (below) shows the process of a client (A) sending a request to a server (C) through a proxy (B).\n\n![Figure 2: Transparent vs. non-transparent proxies](transparent-proxy.svg)\n\n- To use a **non-transparent proxy,** the client needs to explicitly change the destination address to that of the proxy server and use the proxy protocol to connect to the proxy server.\n- To use a **transparent proxy,** the client and the server do not know the proxy is there, which means the client does not need to modify the destination address, and does not need to use the proxy protocol to connect to the proxy server; all the destination address conversion is done in the transparent proxy.\n\n## Using the *tproxy* Transparent Proxy\n\n*tproxy* is a Linux kernel module (since Linux 2.2) that implements transparent proxies. To use *tproxy*, you must first use *iptables* to intercept the required packets at the required NIC, then listen for and forward the packet on that NIC.\n\nFollow these steps to use *tproxy* to implement a transparent proxy:\n\n1. First, you need to implement traffic interception: create a rule in the mangle table of the PREROUTING chain of iptables to intercept traffic and send it to tproxy for processing, for example, \u0060iptables -t mangle -A PREROUTING -p tcp -dport 9080 -j TPROXY --on-port 15001 --on-ip 127.0.0.1 --tproxy-mark 0x1\/0x1\u0060, marking all TCP packets destined for port 9080 with a mark 1. You can specify the source IP address or [IP set](https:\/\/ipset.netfilter.org\/) to further narrow the marking, with *tproxy* listening on port 15001.\n2. Create a routing rule that looks up all packets with mark 1 in a specific routing table: for example, \u0060add ip rule add fwmark 1 lookup 100\u0060, so that all packets with \u0060fwmark 1\u0060 look up to the routing table 100.\n3. Mapping packets to specific local addresses: for example, \u0060ip rule add local 0.0.0.0\/0 dev lo table 100\u0060, which declares all IPv4 addresses as local in the routing table 100, but of course, this is just an example. In practice, you will need to forward packets with specific IPs to the local *lo* loopback NIC.\n\nThe traffic has been intercepted on *tproxy’s* listening port 15001 (enter from Linux kernel space into user space). You can write a web application to process the packets or use *tproxy*-enabled software such as [Squid](http:\/\/www.squid-cache.org\/) or [Envoy](https:\/\/www.envoyproxy.io\/) to process the packets.\n\n## Pros and Cons of Transparent Proxies\n\nTransparent proxies have the following advantages:\n\n- Higher bandwidth and reduced transmission latency, thereby improving the quality of service.\n- No need for users to configure networks and hosts.\n- Control access to network services.\n\nTransparent proxies have the following disadvantages:\n\n- Incorrectly configured, the transparent proxy may prevent connection to the Internet, leaving users unable to troubleshoot and fix errors.\n- Security cannot be guaranteed, as intercepted user traffic may be tampered with by transparent proxies.\n- The risk that transparent proxies may cache user information, leading to privacy leaks.\n\n## Summary\n\nAs a vital type of proxy, transparent proxies are used in a wide range of applications, whether in proxy software such as *shadowsocks*, Xray, or in the Istio service mesh. Understanding how they work helps us use proxies correctly, and whether or not you use a transparent proxy depends on how much you trust and know about it.\n\n---\n\n*This blog was originally published at [tetrate.io](https:\/\/tetrate.io\/blog\/what-is-tproxy-and-how-does-it-work\/).*\n', '\/en\/blog\/what-is-tproxy\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Tproxy is used to intercept traffic in Istio Ambient mode.</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Columns
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(46)</span>
        </a>
      
        <a href="/en/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(12)</span>
        </a>
      
        <a href="/en/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/cloud-native" class="sidebar-item">
            <span>Cloud Native</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/essays" class="sidebar-item">
            <span>Essays</span>
            <span>(5)</span>
        </a>
      
        <a href="/en/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(2)</span>
        </a>
      
        <a href="/en/categories/open-source" class="sidebar-item">
            <span>Open Source</span>
            <span>(2)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      Book
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/en/categories/translation" class="sidebar-item">
            <span>Translation</span>
            <span>(6)</span>
        </a>
      
        <a href="/en/categories/original" class="sidebar-item">
            <span>Original</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">Contact</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">Jimmy&rsquo;s LinkedIn</li>
            
            
            <li class="mb-4"><img src="/images/jimmysong-linkedin.png" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Blog</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/blog/migrating-from-aws-app-mesh-to-istio-a-comprehensive-guide/">Migrating from AWS App Mesh to Istio: A Comprehensive Guide</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/multi-cluster-pki-istio-recipe/">Multi-Cluster PKI &#43; Istio Recipe: Practical Example for a Trusted and Scalable PKI for Your Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/blog/envoy-tracing/">How the Envoy Proxy Handles User Requests for Tracing</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">links</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" >
                  Awesome Cloud Native
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://gateway.envoyproxy.io" target="_blank" rel="noopener noreferrer">
                  Envoy Gateway
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io" target="_blank" rel="noopener noreferrer">
                  Istio
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate - Service Mesh Company
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://docs.tetrate.io/istio-subscription/" target="_blank" rel="noopener noreferrer">
                  Tetrate Istio Subscription
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">Courses</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals" target="_blank" rel="noopener noreferrer">
                  Envoy Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals" target="_blank" rel="noopener noreferrer">
                  Istio Fundamentals
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">new notice</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-china-2024-panel/">KubeCon China 2024 panel Preview: Istio and Modern API Gateways – Leading the Future of Service Mesh</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/website-revamp-notice/">Website Revamp Notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="/en/notice/kubecon-eu-2024/">See you in KubeCon Paris!</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song All Right Reserved</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/en/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />










<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>






  





<script src="/js/wowchemy-search.min.ce03c611044441cf6e84f9e4bef20818.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
