<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>博客 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="专注开源技术、云原生与生活随笔的分享与思考。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/" />
  <meta property="og:title" content="博客 | Jimmy Song" />
  <meta property="twitter:title" content="博客 | Jimmy Song" />

  
  <meta property="og:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />
  <meta property="twitter:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    博客
                </p>
                <p class="page-description">
                    专注开源技术、云原生与生活随笔的分享与思考。
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/kubernetes-next-decade/">[译] 云原生网络：展望 Kubernetes 的下一个十年</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/28</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/kubernetes"> 
             Kubernetes
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thenewstack.io/cloud-native-networking-as-kubernetes-starts-its-second-decade/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('云原生网络：展望 Kubernetes 的下一个十年', '随着 Kubernetes 进入下一个十年，其网络与安全体系将迎来新挑战，eBPF、Gateway API 和 AI 的发展为其未来注入更多可能性。', '\n随着 Kubernetes 迈入青春期，让我们思考其网络和安全系统如何进一步发展与适应。\n\nKubernetes 最近迎来了[十周年](https:\/\/kubernetes.io\/blog\/2024\/06\/06\/10-years-of-kubernetes\/)纪念。作为一名家有三子的父亲，我感觉有责任提醒 Kubernetes 的管理员们：成长中的 Kubernetes 并不总是“乖巧”。\n\n可以预见，[Kubernetes](https:\/\/roadmap.sh\/kubernetes) 将进入其“叛逆期”。\n\nKubernetes 未来将经历增长的阵痛（随着新用例迫使它进行调整）；它或许会遭遇“身份危机”（到底是平台还是API？）；它将寻求更少的监控与更大的自主性（依赖AI工具来减少人类的直接监督）。\n\n借此机会，随着 KubeCon 北美大会即将在盐湖城召开，让我们展望一下云原生网络的发展方向，并探讨一些未来的趋势。\n\n### eBPF 将无处不在\n\n作为能够在 Linux 内核（未来也将支持 [Windows](https:\/\/thenewstack.io\/ebpf-is-coming-for-windows\/)）中运行自定义程序的技术，[eBPF](https:\/\/ebpf.io\/) 的势头不减。除了网络和安全功能（例如 [Cilium](https:\/\/cilium.io\/) 和 [Tetragon](https:\/\/tetragon.io\/) 项目），还出现了更多的应用场景：\n\n- 测量[功耗](https:\/\/sched.co\/1iW8V)：使用 eBPF。\n- 引入[混沌测试](https:\/\/youtu.be\/_5Zabryx0nE?si=KhGFMmeay9LtoJ_-)来验证系统的弹性：使用 eBPF。\n- 加速[加密流量](https:\/\/sched.co\/1i7lP)：使用 eBPF。\n- 在高流量加密数据中[检测异常](https:\/\/sched.co\/1i7ms)：使用 eBPF。\n\n我们可能会面临一种情况，不选择 eBPF 作为网络编程平台反而成为少数。尽管 [eBPF 是一种强大的工具](https:\/\/thenewstack.io\/ebpf-security-power-and-shortfalls\/)，我们不能将所有网络问题都视为“钉子”。\n\n### 最酷的组合：eBPF 与 OpenTelemetry\n\n在 eBPF 可以访问每一个数据包的能力下，网络可视化是一个非常强大的用例。\n\n[OpenTelemetry](https:\/\/www.cncf.io\/reports\/opentelemetry-project-journey-report\/) 作为 CNCF 项目中最活跃的项目之一，提供了标准的可观测框架，通过简单的应用程序仪表来生成和管理遥测数据。\n\n考虑到网络经常被认为是应用性能问题的根源，我们可以期待使用 [OpenTelemetry Network](https:\/\/sched.co\/1how7)，直接从 Linux 内核获取低级遥测数据，以提供关于应用健康状况的有价值见解。\n\n### 展望未来：回顾与反思\n\n在 Kubernetes 迈向十周年之际，我们也开始反思其网络架构的一些设计决策是否依然适用。\n\n例如，Ingress API 是 Kubernetes 早期的一个重要选择，然而其继任者 Gateway API 正在取代它。\n\n服务网格架构也在演变，从传统的 sidecar 架构向 [Cilium Service Mesh](https:\/\/isovalent.com\/blog\/post\/cilium-service-mesh\/) 和 Istio Ambient 模式的无 sidecar 方式转变。\n\n这似乎是反思的好时机。甚至 Kubernetes 的 SIG-Network 组也在考虑是否要放弃[容器网络接口插件模型](https:\/\/kubernetes.io\/docs\/concepts\/extend-kubernetes\/compute-storage-net\/network-plugins\/)，并可能引入更现代的 [Kubernetes 网络接口](https:\/\/github.com\/kubernetes\/enhancements\/issues\/4410)（KNI）。\n\n### 是时候告别 Ingress\n\n[Gateway API](https:\/\/gateway-api.sigs.k8s.io\/) 是 Kubernetes 生态系统中最具创新性的项目之一。它不仅解决了 Ingress 的不足，且其开发充满合作与包容精神。\n\n随着近三十个 Gateway API 的实现和即将推出的 1.2 版本，在今年的 KubeCon 上，Gateway API 的讨论将深入到实际的部署经验，而非入门课程。\n\nIngress 曾经广泛使用，但现在是时候迈向 Gateway API 了。\n\n### AI 在 Kubernetes 网络中的应用\n\n在讨论 [AI 与网络](https:\/\/www.youtube.com\/watch?v=mUbeiDF2B4k)时，我总是将其分为“面向 AI 工作负载的网络”和“用 AI 改善网络”。后者是当下的重点。\n\n我曾经尝试使用大型语言模型（LLM）来创建网络策略和分析日志，然而效果不一。我们期待 Kubernetes 能借助 AI 技术做出更智能的网络决策，例如自动生成网络策略。\n\n### 面向 AI 的 Kubernetes 网络\n\n随着 Kubernetes 成为 AI\/ML 应用的理想平台，AI 工作负载对网络的需求也愈加显著。它不仅需要本地 GPU，还需要通过远程直接内存访问（RDMA）连接远程 GPU。\n\n或许 Kubernetes 近期的动态资源分配（[DRA](https:\/\/kubernetes.io\/docs\/concepts\/scheduling-eviction\/dynamic-resource-allocation\/)）功能可以用来访问专门的网络硬件资源。\n\n### 结语\n\n是的，Kubernetes 将经历类似青少年的成长过程。但没关系，它有一个支持性强、不断创新的社区来帮助其发展成为一个稳定的系统。\n', '\/trans\/kubernetes-next-decade\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">随着 Kubernetes 进入下一个十年，其网络与安全体系将迎来新挑战，eBPF、Gateway API 和 AI 的发展为其未来注入更多可能性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/shanxi-trip/">地上文物看山西：宝藏文物大省不该被埋没</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e6%97%85%e8%a1%8c"> 
             旅行
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('地上文物看山西：宝藏文物大省不该被埋没', '我曾三次游山西，历大同、忻州、朔州、晋城等地，赏众多名胜古迹。谈山西旅游优缺，景区分散等问题存，望借游戏热度促保护，提升文化素养以感其深厚内涵。', '\n我前后三次到访过山西：\n\n- 第一次是 2017 年 12 月，公司组织团建，去了山西大同，游览了悬空寺、云冈石窟和北岳恒山\n- 第二次是 2019 年 4 月，清明节期间，和几位好友自驾去了山西五台山、佛光寺、雁门关和应县木塔\n- 第三次是 2021 年 6 月，到山西晋城参加朋友婚礼，因为当时正值疫情期，没有办法进到景区游览，只是用无人机俯瞰了下「皇城相府」\n\n第一次去山西就被山西厚重的文化内涵所打动，而最近随着首款国产 3A 游戏《黑神话：悟空》的火爆，游戏中的取景地山西的各种古建筑接连出圈。俗话说”地下文物看陕西，地上文物看山西“，如此宝藏文物大省不该被埋没。\n\n## 大同\n\n去大同的时候是 12 月，当地的天气不是很好，到处都是灰蒙蒙的。大同是山西省省域副中心城市。曾是北魏京都、辽金陪都，有“三代京华、两朝重镇”之称。\n\n![大同一隅](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/datong.webp)\n\n### 云冈石窟\n\n云冈石窟蔚为壮观，这也是我第一次游览古代石窟。云冈石窟是中国四大石窟之一。其始凿于北魏文成帝时期，历时 64 年。石窟依山开凿，东西绵延约 1 公里，现存主要洞窟 45 个，附属洞窟 209 个，它于 2001 年被列入“世界文化遗产”名录，2007 年成为国家首批 5A 级旅游景区。\n\n![云冈石窟](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/yungangshiku.webp)\n\n86 版《西游记》第 18 集《扫塔辨奇冤》在云冈石窟有多处取景。该集一开始，师徒四人刚抵达祭赛国时行走的场景，就是在云冈石窟西部洞窟前拍摄的。后来，孙悟空躲在石窟上面查看僧众被殴打的场面，也是在此拍摄。再后来，一位僧侣向唐僧师徒透露冤情，由于几年前寺中塔顶的舍利子佛宝被盗，僧侣们因此遭受不白之冤和苦难，这一对话场景实际上是在云冈石窟的第五窟拍摄完成的。\n\n### 北岳恒山\n\n攀爬北岳恒山相对比较容易，恒山的山势虽然险峻，但攀登过程中坡度相对较为缓和，没有特别陡峭难行的路段。恒山的海拔约 2016.1 米。恒山的垂直落差相对其他一些著名高山来说不是特别大，大约在 1000 多米。\n\n![北岳恒山](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/hengshan.jpg)\n\n### 悬空寺\n\n悬空寺位于恒山金龙峡西侧翠屏峰峭壁间。始建于北魏后期，为木质框架结构，呈“一院两楼”布局，是佛、道、儒三教合一的独特寺庙。它与恒山地理位置紧密相邻，游客游览恒山时常将悬空寺作为重要景点。\n\n![悬空寺](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/xuankongsi.webp)\n\n## 忻州\n\n忻州古称“秀容”。它是山西面积最大的市，有“晋北锁钥”之称。\n\n### 五台山\n\n![五台山](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/wutaishan.webp)\n\n五台山是中国佛教四大名山之首。因五座山峰峰顶平坦如台得名，有东台望海峰、西台挂月峰、南台锦绣峰、北台叶斗峰、中台翠岩峰。其最高海拔 3061 米，有“华北屋脊”之称。这里寺庙林立，现存北魏、唐等朝代寺庙建筑 68 处，如显通寺、塔院寺等。它还是世界文化遗产，自然景观与人文景观完美融合，是著名的避暑胜地和佛教圣地。\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113371735134030\u0026bvid=BV1Jb1pYHEtA\u0026cid=26467238392\u0026p=1\u0022\u003e}}\n\n五台山的佛寺中有大量的壁画，但是想要理解它们就需要一定的知识积累。\n\n![伏虎罗汉](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/fuhuluohan.webp)\n\n伏虎罗汉是佛教十八罗汉中的一位，他的故事象征着降服野性、平息人类内心的狂野和欲望。老虎通常被视为一种强大且危险的动物，象征着人类的恐惧、欲望或其他负面情绪。而罗汉降伏老虎的形象，展示了通过修行、智慧和慈悲来降伏内在和外在的困境与挑战。\n\n![六道轮回](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/liudaolunhui.jpg)\n\n这张图片显示的是“轮回图”，也称为“生命之轮”（藏语：སྐར་འཁོར, 英文：Wheel of Life）。这是佛教艺术中的一个重要象征，描述了众生在六道轮回中的生命状态。\n\n1. **中心部分的三种动物**：\n   - 中心有三种动物：**公鸡**、**蛇**和**猪**，象征着轮回的三毒，分别是**贪**、**嗔**和**痴**。这些是导致众生轮回的根本原因：\n     - 公鸡象征“贪”。\n     - 蛇象征“嗔”。\n     - 猪象征“痴”。\n\n2. **外圈的黑白色部分**：\n   - 紧邻中心的黑白圆环代表轮回中的**善道**和**恶道**。白色部分显示众生通过善行累积功德进入更好的境界，而黑色部分代表恶行导致堕入低劣的境界。\n\n3. **六道轮回**：\n   - 图中的六个区域代表“六道轮回”，即众生可能经历的六种存在状态，分别是：\n     - **天道**（上方）：善业积累多的众生会生于天界，享受较为安乐的生活。\n     - **人道**（右上）：人类的境界，最有可能修行成佛，脱离轮回。\n     - **阿修罗道**（右下）：好斗的众生，拥有强大的能力，但内心常怀嫉妒和愤怒。\n     - **畜生道**（左下）：以愚昧和无知为特点的生命状态，常受苦役。\n     - **饿鬼道**（左上）：贪欲无尽的状态，饿鬼永远无法满足自己的欲望，处于极度痛苦中。\n     - **地狱道**（下方）：最痛苦的境界，因恶业而堕入，受极大的折磨。\n\n4. **外圈代表十二因缘**：\n   - 图外的最外圈代表十二因缘，是轮回的因果链，说明了众生如何因无明和业力陷入轮回的循环。\n\n### 佛光寺\n\n佛光寺在忻州。具体位于山西省忻州市五台县豆村镇东北的佛光山中。佛光寺始建于北魏孝文帝时期（471－499 年），唐大中十一年（857 年）重建。寺内现有殿、堂、楼、阁等一百二十余间，其中东大殿为唐代建筑，文殊殿为金代建筑，其余建筑主要为明、清时期的风格。其唐代建筑、雕塑、壁画、题记，具有极高的历史价值和艺术价值。1961 年，佛光寺被国务院公布为第一批全国重点文物保护单位；2009 年，包括佛光寺在内的五台山被联合国教科文组织世界遗产委员会列入《世界遗产名录》。\n\n![佛光寺](https:\/\/jimmysong.io\/img\/blog\/shanxi-trip\/foguangsi.jpg)\n\n### 雁门关\n\n雁门关是位于忻州市代县县城以北约20公里处雁门山中，是一个咽喉要道，它是长城上的重要关隘，以地势险要、历史上战事频繁而闻名，见证了众多朝代的军事防御和民族交融。第一次听说雁门这个地名还是从唐代诗人李贺的《雁门太守行》：“黑云压城城欲摧，甲光向日金鳞开。角声满天秋色里，塞上燕脂凝夜紫。半卷红旗临易水，霜重鼓寒声不起。报君黄金台上意，提携玉龙为君死。”李贺写《雁门太守行》时约在814年（元和九年）八月前后北游雁门。虽然诗中描述的并非雁门关的特定战争，但创作地点靠近雁门关，雁门地区的边塞氛围、战争历史等对李贺的创作产生了影响，使其在诗中营造出了紧张、悲壮的战争场景和氛围。\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113371668022523\u0026bvid=BV1bg1pYeEsZ\u0026cid=26467043445\u0026p=1\u0022\u003e}}\n\n去过青岛的人应该都知道青岛有一个著名的“八大关”，原以为雁门关会属于“八大关”之一，未料到居然不在其中。这里是古代中原地区与北方游牧民族的分界线，其地势险要，“外壮大同之藩卫，内固太原之锁钥，根抵三关，咽喉全晋”，许多朝代都在此重兵把守，是古代兵家必争之地。历史上，无数次的战争都围绕雁门关展开。例如，北宋时期，杨家将就曾在此抵御辽军的入侵。\n\n## 朔州\n\n朔州的旅游资源相对于忻州匮乏了许多，为人所熟知的大概只有应县木塔、桑干河。我也只去过应县木塔，对于很多外省人，可能都不知道应县属于朔州吧。\n\n### 应县木塔\n\n应县木塔位于一个小县城，可以说这个县城因该木塔而闻名，从航拍视角来看，该塔已有一定程度的歪斜。\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113371550648022\u0026bvid=BV1a11pY6EaJ\u0026cid=26466584412\u0026p=1\u0022\u003e}}\n\n应县木塔全称佛宫寺释迦塔，位于山西省朔州市应县。建于辽清宁二年（1056 年）。塔高 67.31 米，底层直径 30.27 米，呈平面八角形。它是世界上现存最高、最古老的纯木结构楼阁式建筑。全塔无钉无铆，由数万个木构件搭建，共用斗栱 54 种，有“斗栱博物馆”之称。木塔历经风雨、地震、炮击等仍屹立不倒，与比萨斜塔、埃菲尔铁塔并称“世界三大奇塔”。\n\n## 晋城\n\n晋城是位于山西省东南部的城市，拥有丰富的煤炭资源，是山西省重要的能源重化工基地。因为去山西是为了参加朋友的婚礼，待的时间比较短，而且还是在疫情期间，很多景区都未开放，只是用无人机匆匆游览了下皇城相府。\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113371970012277\u0026bvid=BV1Yc1pY6E2n\u0026cid=26468090617\u0026p=1\u0022\u003e}}\n\n皇城相府是位于山西省晋城市阳城县北留镇的一座明清城堡式官宅建筑群，为康熙大帝的老师、《康熙字典》的总裁官陈廷敬的故居，有“中国北方第一文化巨族之宅”的美誉。\n\n## 感想\n\n几次去山西，体会到“表里山河”和煤炭大省资源禀赋。但去过的城市不适合度假，更适合朝拜和访古。山西景区分散，涵盖多领域旅游资源却分布不同地区，距离远。游客奔波耗时耗力，增加成本和疲劳度，降低游玩效率和体验感。部分景区过度依赖门票盈利有弊端，配套设施不完善，餐饮购物选择有限且品质不一，活动项目开发滞后，游客停留短，难感受魅力价值。文物保护有不足，山西文物大省却修缮不及时、保护不到位，影响保存展示，游客难领略价值，威胁文物安全可持续。山西旅游资源文化内涵深，对游客文化素养要求高。景点专业知识多，游客易走马观花，景区文化讲解普及不足，影响体验深度满意度。\n\n最后，希望随着《黑神话：悟空》让山西旅游爆火之际，让更多人关注古建筑和遗迹保护，个人还要增加对古建筑和文物的文化素养，才能更好领略其中的文化内涵。\n', '\/blog\/shanxi-trip\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">我曾三次游山西，历大同、忻州、朔州、晋城等地，赏众多名胜古迹。谈山西旅游优缺，景区分散等问题存，望借游戏热度促保护，提升文化素养以感其深厚内涵。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/multi-cluster-pki-istio-recipe/">多集群 PKI 与 Istio 实践：为服务网格构建可信且可扩展的 PKI</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('多集群 PKI 与 Istio 实践：为服务网格构建可信且可扩展的 PKI', '本文详细介绍了如何使用 EJBCA 和 cert-manager 在多集群 Istio 服务网格中实现可信且可扩展的 PKI 解决方案，包括环境设置、证书管理和自动续期等关键步骤。', '\n作者：Cristofer TenEyck（Keyfactor 高级解决方案工程师）和 Jimmy Song（Tetrate 布道师）\n\n## 引言\n\n在云原生应用程序不断发展的背景下，确保跨多个集群的服务网格安全对于保证安全性和合规性至关重要。Istio 作为领先的开源服务网格，提供了用于保护微服务之间通信的工具。然而，在此环境中实施一个强大且可扩展的公钥基础设施（PKI）来管理证书仍然是一个重大挑战。\n\n在本文中，我们将深入探讨使用 EJBCA 开源 PKI 为跨多个集群的 Istio 服务网格实现 PKI 解决方案。我们将重点介绍设置 EJBCA、配置 cert-manager 的 EJBCA 外部签发器，以及确保 Istio 工作负载的证书自动续期的过程。本指南将帮助你构建可信且可扩展的 PKI，实现安全、合规且具有弹性的服务网格。\n\n为什么选择多集群？随着组织扩大其 Kubernetes 基础设施，多集群部署正变得越来越流行。多集群 Istio 设置提供了增强的可用性、容错性以及跨集群的工作负载隔离。\n\n## 理解 PKI 及其在服务网格中的作用\n\nPKI 是现代数字安全的基石。它涉及管理密钥和证书，以确保用户、应用程序或服务等实体之间的安全通信。在像 Istio 这样的服务网格中，有效的 PKI 对于保护微服务之间的通信，尤其是在多集群环境中，至关重要。\n\nEJBCA 提供了一个用于大规模管理 PKI 的开源解决方案。与 OpenSSL 或 Istio 内置的 PKI 等其他选项相比，EJBCA 提供了一个功能齐全、企业级的 PKI，适用于从简单到更复杂和多用途的部署。EJBCA 的能力超越了仅仅签发 mTLS 证书，提供了合规性特性、安全的可扩展性、密码灵活性，以及与广泛的应用程序集成。\n\n## Istio、EJBCA 和 cert-manager\n\n使用 EJBCA 为多集群 Istio 环境设置 PKI。以下是包含的内容：\n\n1. **环境准备**：我们使用了由主集群和远程集群组成的 MicroK8s 多集群 Istio 设置。两个集群都配置为使用 EJBCA 作为根证书颁发机构（CA）。\n2. **cert-manager 集成**：我们展示了 cert-manager 与 EJBCA 的集成，包括 EJBCA 自定义签发器的配置。cert-manager 将处理证书的签发和续期。\n3. **自动证书续期**：PKI 管理中的一个关键挑战是确保证书在到期前自动续期。cert-manager 与 EJBCA 一起，可以在所有集群中实现无缝、对应用程序透明的证书续期。\n\n![架构图](arch.webp)\n\n## 使用 EJBCA 作为外部 CA 的 Istio 架构设置高级摘要\n\n本节概述了使用 EJBCA 作为外部证书颁发机构（CA）在 Kubernetes 集群上设置 Istio 的步骤。该设置涉及配置两个带有 MetalLB 用于负载均衡的 MicroK8s 集群，集成 EJBCA 进行证书管理，并使用 Helm 安装 Istio 组件。完整指南可在[此处](https:\/\/docs.keyfactor.com\/ejbca\/latest\/tutorial-deploy-istio-service-mesh-in-a-multi)找到。\n\n关键步骤包括：\n\n1. **安装和配置 Helm 仓库**：为 Istio、cert-manager 和 EJBCA 添加必要的 Helm 仓库。\n2. **部署 cert-manager 和 EJBCA**：在主集群和远程集群中使用 Helm 安装 cert-manager，然后部署带有自定义签发器的 EJBCA。此步骤还包括生成并将必要的证书存储为 Kubernetes 密钥。\n3. **使用 EJBCA 配置 Istio**：在 Kubernetes 中创建一个指向 EJBCA 实例的自定义签发器用于签发证书。然后将此签发器集成到 Istio 配置中。\n4. **安装 Istio 组件**：部署 cert-manager-istio-csr 以处理 Istio 的证书签名请求，然后安装 Istio 的基础组件、Istio CNI（容器网络接口）、Istiod（Istio 控制平面）和 Istio 入口网关。\n5. **自定义和覆盖**：应用自定义值以定制 Istio 的行为，例如特定的集群 ID、信任域和用于服务间安全通信的 DNS 配置。\n6. **自动证书续期**：设置配置为 cert-manager 在证书到期前自动续期，而不会对正在运行的应用程序造成中断。\n\n![证书更新流程图](cert-renew-flow.webp)\n\n上图是表示 Istio 中 mTLS 证书签发和续期流程的流程图。它展示了从 Istiod 控制平面推送 Envoy 配置到 EJBCA 最终签发证书的流程。\n\n## PKI 最佳实践和合规性\n\n为你的 Istio 服务网格构建安全的 PKI，不仅仅是设置任意 PKI 并开始签发证书。它需要遵循最佳实践并符合法规要求，以保持安全性和未来适用性。以下是一些需要考虑的关键点：\n\n1. **遵守法规**：确保你的 PKI 实施符合如欧盟网络弹性法案和美国提升国家网络安全的行政命令等法规要求。这包括实施弹性的架构，维护审计跟踪，并确保稳健的密钥管理实践。\n2. **密码灵活性和量子准备**：随着密码标准的发展，你的 PKI 必须具备足够的灵活性以适应新的算法和密钥长度。随着量子计算的潜在出现，具备量子准备性变得越来越重要。\n3. **与信息安全团队合作**：与你的信息安全（InfoSec）团队有效合作对于维护 PKI 的安全性和合规性至关重要。这包括定期审查安全策略、持续培训，以及确保 PKI 管理流程与组织的安全目标一致。\n\n## 结论\n\n在多集群环境中为 Istio 服务网格实施 PKI 看似艰巨，但使用正确的工具和实践，可以高效且有效地实现。EJBCA 结合 cert-manager，提供了一个用于大规模管理证书的解决方案，确保你的 Istio 服务网格 PKI 既安全又合规。\n\n通过遵循本指南中概述的步骤，你将能够建立一个可信的 PKI，实现无缝且强大的证书管理，并与你的信息安全团队有效合作，维护服务网格的安全性。\n\n有关本文中涵盖的主题的更多详细信息和进一步资源，请务必查看下面提供的链接和参考资料。\n\n## 资源\n\n- [教程——使用 EJBCA 作为外部 PKI 提供商在多集群 Kubernetes 环境中部署 Istio 服务网格](https:\/\/docs.keyfactor.com\/ejbca\/latest\/tutorial-deploy-istio-service-mesh-in-a-multi)\n- [Istio 文档](https:\/\/istio.io\/latest\/docs\/)\n- [EJBCA 社区版](https:\/\/www.ejbca.org\/)\n- [cert-manager 文档](https:\/\/cert-manager.io\/docs\/)\n- [欧盟网络弹性法案](https:\/\/digital-strategy.ec.europa.eu\/en\/policies\/cyber-resilience-act)\n- [美国网络安全行政命令](https:\/\/www.whitehouse.gov\/briefing-room\/statements-releases\/2021\/05\/12\/executive-order-on-improving-the-nations-cybersecurity\/)\n- [多集群 Istio 服务网格的跨集群无缝访问指南](\/blog\/seamless-cross-cluster-access-istio\/)\n\n---\n\n本文首发为英文版：[Multi-Cluster PKI \u002b Istio Recipe: Practical Example for a Trusted and Scalable PKI for Your Service Mesh](https:\/\/tetrate.io\/blog\/multi-cluster-pki-istio-recipe-practical-example-for-a-trusted-and-scalable-pki-for-your-service-mesh\/)\n', '\/blog\/multi-cluster-pki-istio-recipe\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细介绍了如何使用 EJBCA 和 cert-manager 在多集群 Istio 服务网格中实现可信且可扩展的 PKI 解决方案，包括环境设置、证书管理和自动续期等关键步骤。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-mesh-open-policy-agent-authorization/">[译] 在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/15</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tylerscha.de/articles/2024-09-22-opa-istio-ambient.html" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权', '本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。', '\n*这是关于在 Istio Ambient Mesh 中使用 Open Policy Agent (OPA) 的系列文章的第一篇。系列文章将涵盖如何使用 OPA 作为外部授权服务，建议的部署模式，以及提高可靠性和可扩展性的最佳架构。我们还将讨论使用 OPA 进行资源验证和控制 Istio 功能。*\n\n正如我在[之前的文章](https:\/\/tylerscha.de\/articles\/2024-08-29-five-things-i-like-lately.html)中提到的，我对 Istio Ambient Mesh 感到非常兴奋。这是服务网格的显著进步，我致力于帮助大家理解如何利用 Ambient 来实现目标。我认为目前关于 Ambient 的用例和教程内容还比较少，我希望能帮助填补这个空白。\n\n本文将介绍如何在 Istio Ambient Mesh 中设置 Open Policy Agent (OPA) 作为外部授权服务。授权是任何安全模型的重要组成部分，而 OPA 是实现细粒度访问控制策略的强大工具。通过将 OPA 用作外部授权服务，你可以强制执行比 Istio 内置授权策略更复杂的策略。\n\nOPA 具有插件模型，允许在基础策略引擎之上添加额外功能。虽然这是一个复杂的用例，但幸运的是，[OPA 社区已经创建并维护了](https:\/\/github.com\/open-policy-agent\/opa-envoy-plugin)实现 [Envoy 外部授权 API](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/ext_authz_filter) 的 OPA 引擎版本。因此，你无需编写任何自定义代码即可在 Istio Ambient Mesh 中使用 OPA 作为外部授权服务。\n\n#### 集群架构图\n\n![OPA 和 Istio Ambient](istio-ambient-opa-without-traffic.webp)\n\n在上图中，你可以看到我们集群中的资源架构。我们有三个命名空间：默认的 \u0060istio-system\u0060 命名空间（Istio 控制平面 istiod 和 ztunnel 代理运行的地方）、安装示例应用的 \u0060app\u0060 命名空间，以及 OPA 运行的 \u0060platform\u0060 命名空间。在这个例子中，我们将 OPA 部署为单个 Deployment。在后续文章中，我会介绍如何将 OPA 部署为 DaemonSet。\n\n#### 带有流量的集群架构图\n\n![OPA 和 Istio Ambient（带有流量）](istio-ambient-opa-with-traffic.webp)\n\n上图展示了与之前相同的集群，但此时有流量通过系统。在本教程中，我们将发送流量到 \u0060app\u0060 命名空间中的 Waypoint 代理，该代理会向 \u0060platform\u0060 命名空间中的 OPA 服务进行授权检查。OPA 服务根据定义的策略返回决策，允许或拒绝请求。如果请求被允许，Waypoint 代理会将请求转发到 \u0060app\u0060 命名空间中的目标服务，否则将返回 403 Forbidden 响应。\n\n### 集群安装与配置\n\n首先，让我们创建集群并使用 Ambient 模式安装 Istio，以及 Kubernetes Gateway API：\n\n\u0060\u0060\u0060bash\n# 创建集群\nkind create cluster --name istio-opa\n\n# 使用 Ambient 模式安装 Istio\nistioctl install --set profile=ambient --skip-confirmation\n\n# 安装 gateway-api CRD\nkubectl get crd gateways.gateway.networking.k8s.io \u0026\u003e \/dev\/null || \\\n    { kubectl apply -f https:\/\/github.com\/kubernetes-sigs\/gateway-api\/releases\/download\/v1.1.0\/standard-install.yaml; }\n\u0060\u0060\u0060\n\n接下来，创建 \u0060app\u0060 命名空间并安装 Istio 的 bookinfo 示例应用及 \u0060sleep\u0060 Pod，这将帮助我们进行集群内的测试：\n\n\u0060\u0060\u0060bash\n# 创建命名空间\nkubectl create namespace app\n\n# 安装 bookinfo 示例应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo-versions.yaml\n\n# 安装 sleep 应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/sleep\/sleep.yaml\n\u0060\u0060\u0060\n\n我们还需要创建 Waypoint 代理，作为集群入口网关，并为 \u0060app\u0060 命名空间配置 Ambient 模式：\n\n\u0060\u0060\u0060bash\n# 为 productpage 应用创建网关\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/gateway-api\/bookinfo-gateway.yaml\nistioctl waypoint apply -n app --enroll-namespace --wait\n\n# 为网关添加 ClusterIP 类型\nkubectl annotate gateway bookinfo-gateway networking.istio.io\/service-type=ClusterIP --namespace=app\n\n# 将命名空间标记为 Ambient 模式\nkubectl label namespace app istio.io\/dataplane-mode=ambient\n\u0060\u0060\u0060\n\n接下来，创建 \u0060platform\u0060 命名空间来运行 OPA 服务：\n\n\u0060\u0060\u0060bash\nkubectl create namespace platform\n\u0060\u0060\u0060\n\n### 部署 Open Policy Agent\n\n首先，部署 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: opa-istio\n  template:\n    metadata:\n      labels:\n        app: opa-istio\n    spec:\n      containers:\n      - name: opa-istio\n        image: openpolicyagent\/opa:0.68.0-istio-4-static\n        ports:\n        - containerPort: 9191\n        - containerPort: 8282\n        - containerPort: 8181\n        args:\n        - \u0022run\u0022\n        - \u0022--server\u0022\n        - \u0022--addr=0.0.0.0:8181\u0022\n        - \u0022--config-file=\/config\/config.yaml\u0022\n        - \u0022\/policy\/policy.rego\u0022\n        volumeMounts:\n        - name: opa-istio-config\n          mountPath: \/config\n        - name: opa-policy\n          mountPath: \/policy\nEOF\n\u0060\u0060\u0060\n\n接着，我们需要定义两个 ConfigMap 来配置 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-istio-config\n  namespace: platform\ndata:\n  config.yaml: |\n    plugins:\n      envoy_ext_authz_grpc:\n        addr: 0.0.0.0:9191\n        path: istio\/authz\/allow\n    decision_logs:\n      console: true\nEOF\n\u0060\u0060\u0060\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-policy\n  namespace: platform\ndata:\n  policy.rego: |\n    package istio.authz\n    import input.attributes.request.http as http_request\n    import input.parsed_path\n    default allow = false\n    allow { roles_for_user[r] required_roles[r] }\n    roles_for_user[r] { r := user_roles[user_name][_] }\n    required_roles[r] { perm := role_perms[r][_] perm.method = http_request.method perm.path = http_request.path }\n    user_name = parsed { [_, encoded] := split(http_request.headers.authorization, \u0022 \u0022) [parsed, _] := split(base64url.decode(encoded), \u0022:\u0022) }\n    user_roles = { \u0022alice\u0022: [\u0022guest\u0022], \u0022bob\u0022: [\u0022admin\u0022] }\n    role_perms = { \u0022guest\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, ], \u0022admin\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/api\/v1\/products\u0022 }, ], }\nEOF\n\u0060\u0060\u0060\n\n最后，为 OPA 创建服务并配置 Istio MeshConfig：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  ports:\n  - name: grpc\n    port: 9191\n    targetPort: 9191\n  selector:\n    app: opa-istio\nEOF\n\u0060\u0060\u0060\n\n编辑 Istio \u0060MeshConfig\u0060，将 OPA 注册为 \u0060extensionProvider\u0060：\n\n\u0060\u0060\u0060bash\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: istio\n  namespace: istio-system\ndata:\n  mesh: |-\n    extensionProviders:\n    - name: opa-ext-authz-grpc\n      envoyExtAuthzGrpc:\n        service: opa-istio.platform.svc.cluster.local\n        port: 9191\n\u0060\u0060\u0060\n\n### 测试\n\n通过 \u0060kubectl port-forward\u0060 命令，将 \u0060bookinfo-gateway\u0060 服务的端口转发到本地：\n\n\u0060\u0060\u0060bash\nkubectl port-forward -n app svc\/bookinfo-gateway-istio 8080:80\n\u0060\u0060\u0060\n\n然后，使用 Alice 和 Bob 用户发送请求，验证不同权限的访问控制：\n\n\u0060\u0060\u0060bash\ncurl --user alice:password -vik http:\/\/localhost\n\n:8080\/api\/v1\/products # 应返回 403\ncurl --user alice:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/api\/v1\/products # 应返回 JSON 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\n\u0060\u0060\u0060\n\n最后，应用 Istio 的 \u0060AuthorizationPolicy\u0060：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ext-authz\n  namespace: app\nspec:\n  action: CUSTOM\n  provider:\n    name: opa-ext-authz-grpc\n  rules:\n  - to:\n    - operation:\n        paths: [\u0022*\u0022]\nEOF\n\u0060\u0060\u0060\n\n通过上述步骤，你已经成功配置了 OPA 作为 Istio Ambient Mesh 中的外部授权服务。在后续文章中，我们将讨论 OPA 在 Waypoint 代理中的最佳实践。\n', '\/trans\/istio-ambient-mesh-open-policy-agent-authorization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-waypoint-proxy-deployment-model-explained/">[译] 解读 Istio Ambient Waypoint Proxy 部署模型</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://www.solo.io/blog/istio-ambient-waypoint-proxy-deployment-model-explained/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('解读 Istio Ambient Waypoint Proxy 部署模型', '本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。', '\n\u003e 译者注：Istio Ambient Waypoint Proxy 为服务网格的 L7 处理提供了灵活且高效的解决方案。通过了解不同的部署模式，团队可以根据自身需求选择最合适的架构，避免资源浪费和性能瓶颈。避免按节点部署 waypoint proxy，有助于降低故障域的影响，提升应用的稳定性和性能。正确地部署和配置 waypoint proxy，将有助于充分发挥 Istio Ambient 模式的优势，实现高效、安全的服务通信。\n\nAmbient 模式是 Istio 在 2022 年引入的新型无边车数据平面，并于今年 5 月达到 [Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 状态。Istio 社区正努力在下一个 Istio v1.24 版本中将 Ambient 推向 GA（一般可用）状态。Ambient 将 Istio 的功能分为两个独立的层：安全覆盖层和第 7 层处理层。在与许多试用 Ambient 的用户合作时，我想澄清关于 waypoint proxy 的一些常见问题和困惑。它是一个可选的基于 Envoy 的组件，负责处理其管理的工作负载的 L7 事务。\n\n## Waypoint Proxy 的常见部署模式是什么？\n\n### 理解 Waypoint Proxy\n\n你可以将 waypoint proxy 简单地视为一组目的地的网关，这些目的地可以是来自一个或多个命名空间的一个或多个服务和工作负载。除了处理集群内部的 L7 流量外，它与你的入口或出口网关没有太大区别。这也是为什么在部署 waypoint proxy 时需要使用 Kubernetes 的 Gateway 资源的原因。\n\n我非常喜欢 waypoint 架构的灵活性，你可以选择适合自己需求的架构。以下是一些常见的模式：\n\n### A: 针对命名空间的 Waypoint Proxy\n\n最常见的模式是，每个团队在集群中拥有一个命名空间，并管理该命名空间内的服务和部署。在这种模式下，我们期望每个团队都有自己的 waypoint proxy，供命名空间内的服务使用。按照这种模式，我们将默认的 waypoint 部署设计为命名空间范围，供命名空间内的所有服务使用。在下图中，服务 A、B、C 位于同一命名空间内。所有到服务 A、B 或 C 的 Ambient Mesh 客户端流量将通过命名空间的 waypoint proxy，由客户端的 ztunnel 进行编程。\n\n![Istio Ambient Waypoint 代理部署模型](f1.webp)\n\n注意：为简洁起见，省略了目的地端的 ztunnel\n\n### B: 针对部分服务的 Waypoint Proxy\n\n如果你不希望到服务 B 的流量经过 waypoint proxy 怎么办？一个常见的原因是，你只需要对服务 B 的流量进行 L4 层的控制，这样在调用它时就不需要通过 waypoint proxy。例如，你有一个调用 MySQL 数据库服务的 Web 服务，只需要对其进行 L4 控制。另一个例子是，当服务是“内部”的，只被命名空间内的其他服务调用，你只需要对跨命名空间边界的服务进行授权策略。例如，在著名的 [Bookinfo 应用程序](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/)中，你可以为 productpage 服务启用零信任，拒绝除端口 9080 上 GET 方法的流量之外的所有流量。对于所有内部服务，如 reviews 或 details 服务，你可以继续允许命名空间内的所有流量。\n\n另一个用例是，服务 A 的流量非常大，你希望有一个专用的 waypoint proxy 来处理其 L7 处理，以便调整资源配置来应对高负载。你可以配置服务 B 或 C 使用不同的 waypoint，避免受到服务 A 的影响，或根据需要跳过它。我们将在下面的部分中详细讨论这一点。\n\n![Istio ambient waypoint 代理部署模型](f2.webp)\n\n### C: 多个命名空间共享一个 Waypoint Proxy\n\n你也可以通过为命名空间添加 \u0060istio.io\/use-waypoint\u0060 标签，并在 Gateway 资源中配置 \u0060allowRoutes\u0060，来让多个命名空间共享一个 waypoint proxy。如果你运行的是小型集群，想要优化资源效率，并且对嘈杂邻居问题不太担心，你可能希望为整个集群使用一个 waypoint proxy。这种情况下的一个常见例子是所谓的 [K8S-at-the-edge](https:\/\/events.linuxfoundation.org\/kubecon-cloudnativecon-europe\/co-located-events\/kubernetes-on-edge-day\/#about)。\n\n\u003e “当应用程序跨越太多命名空间时，使用 waypoint 为多个命名空间服务更具资源效率，通过提升无边车服务网格的概念，并在不同的命名空间中使用集中式的 L7 功能，而不影响性能和应用可用性”，[Ahmad Al-Masry](https:\/\/www.linkedin.com\/in\/ahmad-al-masry-9ab90858\/)，DevSecOps 工程经理说道。\n\n另一个例子是，一个团队拥有几个组成单一信任域的命名空间，你希望通过共享一个 waypoint proxy 来降低资源成本。在下图中，ns-1 和 ns-2 命名空间中的所有服务都使用部署在 ns-1 命名空间中的 waypoint proxy：\n\n![Istio ambient waypoint 代理部署模型](f3.webp)\n\n由于 ns-2 与 ns-1 共享相同的 waypoint proxy，任何在 ns-1 中部署并附加到整个 waypoint 的策略都会影响两个命名空间。例如，如果你部署了一个附加到整个 waypoint 的 \u0060AuthorizationPolicy\u0060，该策略将在两个命名空间中的所有服务上由 waypoint 执行。\n\n## 为什么不简单地为每个节点部署一个 Waypoint Proxy？\n\n虽然将 waypoint proxy 配置为上述不同目的地范围的网关非常好，但你可能会想，为什么不保持简单，为每个节点部署一个 waypoint proxy 作为 Kubernetes [DaemonSet](https:\/\/kubernetes.io\/docs\/concepts\/workloads\/controllers\/daemonset\/) 来处理该节点的所有 L7 处理呢？\n\nWaypoint proxy 需要高度可配置，因为应用程序可能有完全不同的性能要求和运行时自定义。例如，你可以插入针对特定服务的外部授权策略或 WASM 扩展。一个租户的错误 Envoy 配置可能会导致节点代理崩溃，影响该节点上的所有工作负载。\n\n此外，需要在 waypoint proxy 上有大量处理的嘈杂邻居可能会导致另一个应用程序性能不佳，仅仅因为该应用程序也部署在同一节点上。通过为 waypoint proxy 每个节点部署 Envoy，实际上是强制节点上的所有应用程序共享相同的故障域，而不管它们的应用延迟或运行时要求。Envoy 没有租户控制，你无法划分其 CPU 或内存来防止嘈杂邻居抢占其他应用程序。具有复杂 L7 策略的高流量应用程序将需要更多的 CPU 和 waypoint 的内存。Kubernetes DaemonSet 的资源预留是固定的，无法在不增加所有 waypoint pod 的 CPU 和内存的情况下，根据流量负载水平水平或垂直扩展特定的 DaemonSet pod。成本分摊在此模型中也很困难，你无法正确地将 waypoint 引起的资源成本归因于每个租户。\n\n让我们通过一个具体的例子来说明。我在两个命名空间中部署了 Bookinfo 应用程序，每个命名空间都有其默认配置的命名空间 waypoint。我将每个命名空间的 waypoint proxy 配置为与各自的 \u0060productpage\u0060 pod 共置。在每个命名空间中，我部署了一个简单的 L7 \u0060AuthorizationPolicy\u0060，只允许特定命名空间执行 GET 方法：\n\n![Istio ambient waypoint 代理部署模型](f4.webp)\n\n注意：为简洁起见，省略了源和目的地端的 ztunnel\n\n当我从 Fortio 向第一个命名空间的 productpage 服务发送 6500 RPS 的请求，并在 3 秒后向第二个命名空间的 productpage 服务发送相同的请求时，平均响应时间分别为 30.8ms 和 30.4ms，如下图所示：\n\n![命名空间 1](f5.webp)\n\n命名空间 1：通过其 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2](f6.webp)\n\n命名空间 2：通过其 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n由于两个 Bookinfo 应用程序都有非常大的负载，每个应用程序都有自己的 waypoint proxy 是合理的，这样它们不会相互争抢资源。那么，如果 waypoint proxy 改为按节点部署会怎样？\n\n我可以手动将 waypoint proxy 作为 DaemonSet 部署，使用非常复杂的 Envoy 配置。在运行两个 productpage pod 的节点上，waypoint proxy pod 将被两个 productpage pod 使用。然而，这需要深入了解 Envoy 配置，这方面我并不擅长。一种简单的测试方法是，将两个命名空间配置为使用相同的 waypoint proxy，这对于不需要非常高负载或专用 waypoint proxy 的应用程序是推荐的（参见前面的模式 C 了解更多信息）。注意：对于这种情况，我不推荐模式 C，因为两个 Bookinfo 应用程序的负载非常大。\n\n在确保 ns-1 命名空间中的 waypoint proxy pod 也部署在与两个 productpage pod 相同的节点上后，我进行了一个简单的更改，将两个命名空间都配置为使用 ns-1 命名空间中的 waypoint proxy。这使我能够快速测试一个 waypoint proxy pod，被部署在同一节点上的两个 productpage pod 使用，就像我将 waypoint 作为 DaemonSet 部署一样。\n\n![5_Istio ambient waypoint proxy deployment model explained](f7.webp)\n\n当我从 Fortio 负载客户端向第一个命名空间的 productpage 服务发送 6500 RPS 时，平均响应时间从 30ms 增加到了 59ms！在 3 秒后向第二个命名空间的 productpage 发送相同的负载（基本上重复之前的测试，但这次使用共享的 waypoint），它报告了 32% 的错误，从之前的 0% 增加了！当它们共享同一节点上的同一个 waypoint proxy 时，对两者的影响有多大！由于两个应用程序在高负载下都变得非常嘈杂，waypoint proxy 达到了其默认的 CPU 限制（2 核）和 [上游连接限制](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/cluster\/v3\/circuit_breaker.proto#envoy-v3-api-field-config-cluster-v3-circuitbreakers-thresholds-max-connections)（1024），因此许多稍后开始的来自第二个命名空间的请求以高比例的错误失败。Kubernetes 工作节点仍然有充足的 CPU，在峰值时有约 50% 的 CPU 和 6% 的内存利用率。\n\n![命名空间 1.2](f8.webp)\n\n命名空间 1：通过共享的 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2.1](f9.webp)\n\n命名空间 2：通过共享的 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n这个实验表明，在节点上使用相同的 waypoint proxy 共享相同的故障域，可能很容易在嘈杂的邻居下触发故障场景，而这些可以通过为非常繁忙的租户提供专用的 waypoint 来避免。虽然在测试中使用了非常嘈杂的邻居，但也可能是错误的 Envoy 配置或特定的 Envoy 扩展，在多个租户共享相同的故障域时触发类似的问题。\n', '\/trans\/istio-ambient-waypoint-proxy-deployment-model-explained\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-tracing/">Envoy 代理如何处理用户请求以实现追踪</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy 代理如何处理用户请求以实现追踪', '深入探讨 Envoy 代理在云原生环境中如何处理用户请求，实现分布式追踪，提升应用可观测性。', '\n在云原生环境中，提升对应用程序的可观测性以更好地理解用户体验是至关重要的。然而，单纯依靠指标和日志无法提供个别案例的具体细节。这时，追踪（Tracing）技术就显得尤为重要。\n\n## 追踪的基本原理\n\n追踪通过为每个用户请求附加一个关联 ID，向开发人员提供完整的用户体验上下文。这个关联 ID 就像一根线，将跨越多个服务的追踪串联起来，从而实现全面的可观测性。\n\n下图展示了 Envoy 处理用户请求的流程。\n\n\u0060\u0060\u0060mermaid \u0022用户请求与 Envoy 代理的处理流程图\u0022\nsequenceDiagram\n    participant 用户\n    participant Envoy\n    participant 应用程序\n    participant 后端\n\n    %% 用户发送带有各种头部的初始请求\n    用户-\u003e\u003eEnvoy: 用户请求（包含头部：Host, X-User-Identity, X-B3-TraceId）\n\n    %% Envoy 将请求转发给应用程序\n    Envoy-\u003e\u003e应用程序: 转发请求（带头部）\n\n    %% 应用程序处理请求并发出外部请求\n    应用程序-\u003e\u003eEnvoy: 外部请求（发往后端，带头部）\n    Envoy-\u003e\u003e后端: 转发请求（X-B3-TraceId: 1234, X-User-Identity）\n\n    %% 后端对外部请求做出响应\n    后端-\u003e\u003eEnvoy: 对应用程序请求的响应\n    Envoy-\u003e\u003e应用程序: 转发响应\n\n    %% 应用程序处理响应并将响应发送回用户\n    应用程序-\u003e\u003eEnvoy: 对用户请求的响应\n    Envoy-\u003e\u003e用户: 转发响应（给原始用户请求）\n\n    %% 处理多个并发请求\n    用户-\u003e\u003eEnvoy: 多个并发请求\n    Envoy-\u003e\u003e应用程序: 转发多个请求\n    应用程序-\u003e\u003eEnvoy: 转发响应\n    Envoy-\u003e\u003e用户: 多个并发响应\n\u0060\u0060\u0060\n\n![用户请求与 Envoy 代理的处理流程图](98285f54b4811bd9ece87523444f4e02.svg)\n\n**追踪**可以通过为每个用户请求附加一个关联 ID，向开发人员提供完整的用户体验上下文。这个关联 ID 就像一根线，将跨越多个服务的追踪串联起来。\n\n尽管所有请求都会经过 Envoy 代理，但 Envoy 无法独立提供完整的追踪信息。它只看到应用程序作为网络的一部分，无法洞察内部处理。这使得 Envoy 无法区分入站请求和出站请求是否来自同一个用户，因此无法自动转发追踪上下文。\n\n## 服务网格中的请求上下文\n\nEnvoy 可以在 Istio 服务网格中作为 Sidecar 或 Waypoint 代理，下图展示了 Envoy 在服务网格中如何处理请求上下文的。\n\n### 1. 用户请求的开始\n\n追踪涉及通过多个服务跟踪路径，以理解用户体验的完整上下文。追踪从一个用户请求开始，该请求被分配了一个关联 ID。\n\n\u0060\u0060\u0060mermaid \u0022用户请求的开始\u0022\nsequenceDiagram\n    participant User\n    participant Envoy\n    participant Application\n    User-\u003e\u003eEnvoy: 请求（包含Headers）\n    Note right of User: Headers:\u003cbr\/\u003e- Host: example.com\u003cbr\/\u003e- X-User-Identity: Base64 Token\u003cbr\/\u003e- X-B3-TraceId: 1234\n\u0060\u0060\u0060\n\n![用户请求的开始](51fd90d791099a4f158c823a821fba6d.svg)\n\n### 2. 请求通过 Envoy 代理\n\nEnvoy 位于应用程序旁边，所有进入的请求都会经过 Envoy。\n\n\u0060\u0060\u0060mermaid \u0022用户请求的开始\u0022\nsequenceDiagram\n    participant User\n    participant Envoy\n    participant Application\n    User-\u003e\u003eEnvoy: 发起请求\n    Envoy-\u003e\u003eApplication: 转发请求\n\u0060\u0060\u0060\n\n![用户请求的开始](aebbb0ea064ee93575ec5a1ec9bdf329.svg)\n\n### 3. Envoy 附加额外的 Headers\n\nEnvoy 可以在请求中附加额外的 Headers，以收集关于应用程序内部发生情况的信息。\n\n\u0060\u0060\u0060mermaid \u0022Envoy 附加额外的 Headers\u0022\nsequenceDiagram\n    participant Envoy\n    participant Application\n    Envoy-\u003e\u003eApplication: 转发请求（附加Headers）\n    Note right of Envoy: 附加Headers:\u003cbr\/\u003e- X-Forwarded-For\u003cbr\/\u003e- X-Forwarded-Client-Cert\n\u0060\u0060\u0060\n\n![Envoy 附加额外的 Headers](7ab35160ac9d07cfdcaa9436b8706548.svg)\n\n### 4. 应用程序处理请求并调用后端服务\n\n应用程序在处理请求的过程中，可能需要联系其他系统来处理该请求。比如外部的认证和授权服务。\n\n\u0060\u0060\u0060mermaid \u0022应用程序处理请求并调用后端服务\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy2 as Envoy（出站）\n    participant Backend\n    Application-\u003e\u003eEnvoy2: 调用后端请求\n    Envoy2-\u003e\u003eBackend: 转发请求\n\u0060\u0060\u0060\n\n![应用程序处理请求并调用后端服务](d1016c81280b99d35a642a80caa3af52.svg)\n\n### 5. 应用程序需要复制关联 ID\n\n应用程序知道出站请求是代表哪个入站请求发起的（例如 Trace ID 为 1234 的请求）。但是，Envoy 并不知道这一点。因此，应用程序需要将关联 ID 等上下文从入站请求复制到出站请求中。\n\n\u0060\u0060\u0060mermaid \u0022应用程序需要复制关联 ID\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy2 as Envoy（出站）\n    participant Backend\n    Application-\u003e\u003eEnvoy2: 调用后端请求（复制Headers）\n    Note right of Application: 复制Headers:\u003cbr\/\u003e- X-B3-TraceId: 1234\u003cbr\/\u003e- X-User-Identity: Base64 Token\n    Envoy2-\u003e\u003eBackend: 转发请求\n\u0060\u0060\u0060\n\n![应用程序需要复制关联 ID](1409785fdd6f8909dffee3c5bd1b44ba.svg)\n\n### 6. 多个请求的并发处理\n\n在实际场景中，应用程序同时处理多个用户请求，这导致了并发性。由于 Envoy 只能看到网络层面的请求和响应，无法区分这些请求之间的因果关系。\n\n\u0060\u0060\u0060mermaid \u0022多个请求的并发处理\u0022\nsequenceDiagram\n    participant User1\n    participant User2\n    participant Envoy\n    participant Application\n    User1-\u003e\u003eEnvoy: 请求1\n    User2-\u003e\u003eEnvoy: 请求2\n    Envoy-\u003e\u003eApplication: 转发请求1\n    Envoy-\u003e\u003eApplication: 转发请求2\n    Application-\u003e\u003eEnvoy: 响应请求1的出站请求\n    Application-\u003e\u003eEnvoy: 响应请求2的出站请求\n\u0060\u0060\u0060\n\n![多个请求的并发处理](2aebfd544f726da5fe6f4389aed924bd.svg)\n\n### 7. Envoy 的局限性\n\n因为 Envoy 无法看到应用程序内部的处理逻辑，它只能看到一系列的网络请求和响应，无法知道哪些出站请求是由哪些入站请求触发的。\n\n\u0060\u0060\u0060mermaid \u0022Envoy 的局限性\u0022\nsequenceDiagram\n    participant Envoy\n    participant Application\n    Envoy-\u003e\u003eApplication: 多个请求\n    Application-\u003e\u003eEnvoy: 多个响应\n    Note over Envoy: 无法区分请求的因果关系\n\u0060\u0060\u0060\n\n![Envoy 的局限性](d048f6f9fc9af6f29a9f2e4bfe599613.svg)\n\n## 需要应用程序的参与\n\n由于 Envoy 无法自动转发追踪上下文，应用程序本身需要负责将入站请求的 Headers 复制到出站请求中，以保持追踪信息的完整性。\n\n### 应用程序复制 Headers\n\n应用程序在处理入站请求时，需要将必要的 Headers（如关联 ID、用户身份等）复制到任何出站请求中。\n\n\u0060\u0060\u0060mermaid \u0022应用程序复制 Headers\u0022\nsequenceDiagram\n    participant Application\n    participant Backend\n    Application-\u003e\u003eBackend: 出站请求（包含复制的Headers）\n\u0060\u0060\u0060\n\n![应用程序复制 Headers](d1f00ba65d1c61edf996a19a6b5145d7.svg)\n\n### 响应返回给用户\n\n应用程序完成对用户请求的处理后，将响应返回给用户。\n\n\u0060\u0060\u0060mermaid \u0022响应返回给用户\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy\n    participant User\n    Application-\u003e\u003eEnvoy: 响应\n    Envoy-\u003e\u003eUser: 转发响应\n\u0060\u0060\u0060\n\n![响应返回给用户](ed0816d0cb881c7c7d5eb19e6d0826bf.svg)\n\n## 解决方案与推荐\n\n为了确保追踪信息的完整性，应用程序需要主动复制和传递追踪相关的 Headers。这可以通过集成如 [Apache SkyWalking](https:\/\/skywalking.apache.org\/) 的工具来实现，SkyWalking 不仅支持分布式追踪，还包括性能监控、日志分析等功能。利用 SkyWalking 的库和代理，可以简化 Headers 的复制和追踪信息的传递。\n\n关于如何在 Istio 中使用 SkyWalking 实现分布式追踪详见[这篇博客](\/blog\/distributed-tracing-with-skywalking-in-istio\/)。\n\n## 总结\n\n- **追踪的重要性**：追踪为开发人员提供了用户请求的完整上下文，帮助更好地理解和改进用户体验。\n- **Envoy 的局限性**：Envoy 只能看到网络层面的请求和响应，无法跟踪请求的因果关系，因此无法自动转发追踪上下文。\n- **应用程序的角色**：应用程序需要主动复制和传递追踪相关的 Headers，以确保追踪信息的完整性。\n- **推荐的工具**：使用 SkyWalking 等追踪工具的库，可以简化在应用程序中实现 Headers 复制的过程。\n\n## 参考\n\n- [How the Envoy proxy handles a user request - tetrate.io](https:\/\/tetrate.io\/blog\/how-the-envoy-proxy-handles-a-user-request\/)\n- [如何在 Istio 中使用 SkyWalking 进行分布式追踪？- jimmysong.io](https:\/\/jimmysong.io\/blog\/distributed-tracing-with-skywalking-in-istio\/)\n', '\/blog\/envoy-tracing\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入探讨 Envoy 代理在云原生环境中如何处理用户请求，实现分布式追踪，提升应用可观测性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/black-myth-wukong-review/">《黑神话：悟空》一周目评测：瑕不掩瑜，期待更丰富内容</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e9%9a%8f%e7%ac%94"> 
             随笔
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('《黑神话：悟空》一周目评测：瑕不掩瑜，期待更丰富内容', '《黑神话：悟空》一周目体验总结：虽然游戏有不少亮点，但整体内容稍显不足，导致游戏进程偏快，令人意犹未尽。', '\n最近完成了《黑神话：悟空》的一周目体验。总体来说，音乐和美术表现出色，但战斗系统略显单调，地图设计不够理想，整体内容偏少，让人感到意犹未尽。\n\n![黑神话：悟空](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/wukong.webp)\n\n{{\u003ccallout tip \u0022什么是一周目？\u0022\u003e}}\n\n“一周目”指的是玩家首次完整进行游戏的过程，这个阶段充满新鲜感和探索性，可以体验到完整的剧情与玩法，为后续的游戏体验奠定基础，通常难度适中。\n\n{{\u003c\/callout\u003e}}\n\n## 音乐\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113055920818374\u0026bvid=BV1S9noeREf3\u0026cid=25673204847\u0026p=1\u0022\u003e}}\n\n第二章开头，熊竹英老师用陕北说书的形式演绎了《黄风起兮》，令人印象深刻。熊竹英是陕北说书的非遗传承人。陕北说书起源于陕西北部的延安和榆林地区，最初由贫苦盲人用陕北民歌小调演唱民间传说和故事，后来融入了多种曲调，形成了独特的说唱艺术。通常是一人自弹自唱，伴奏乐器以三弦为主，还会用绑在小腿的甩板和手腕的“嘛喳喳”小木板来打节奏。2006 年，陕北说书被列入国家级非物质文化遗产名录。\n\n## 美术设计\n\n![黑神话悟空截图](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/jietu.webp)\n\n游戏前两章的美术设计非常出色，古建筑的还原相当精致。以下是我对每个章节的感受：\n\n- **第一回：火照黑云（黑风山）**：我很喜欢开头翠绿的丛林，还有偶尔出现的妖怪，营造出一种神秘的氛围。\n- **第二回：风起黄昏（黄风岭）**：漫天黄沙带来了一种苍凉和破败的感觉。\n- **第三回：夜生白露（小雷音寺）**：浮屠界让我头晕目眩，过桥时经常被打落，茫茫雪地既刺眼又让人迷失方向，唯一觉得好些的是**安身寺**的部分。\n- **第四回：曲度紫鸳（盘丝洞）**：层层洞窟让人容易迷路，不过黄花观和紫云山的景色还不错。\n- **第五回：日落红尘（火焰山）**：这种场景不太对我胃口，不由得让我联想到《艾尔登法环》中的火山地形。\n- **第六回：未竟（花果山）**：地图很大，但更容易迷路了，只能不断用筋斗云在空中飞来飞去。\n\n![花果山](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/jindouyun.webp)\n\n总体来说，缺少地图功能让人非常无语，即便没有地图，搞个指南针也不难，但游戏中什么都没有，只能靠空气墙来判断边界。玩家在游戏中不断兜圈子，浪费了不少时间在找路上，真正玩游戏的时间可能不足七成。\n\n## 故事\n\n《黑神话：悟空》的故事设定很简单，背景发生在唐僧师徒取经之后。孙悟空虽被封为斗战胜佛，却辞去佛位回到花果山。天庭不满，派二郎神等前来捉拿，紧箍咒再现使悟空落败，他的“六根”（眼、耳、鼻、舌、身、意）被分为六块。“意”化作天命人（玩家），其余五块被分给五个妖王。花果山的猴子猴孙踏上寻找“六根”复活悟空的征程。玩家扮演的天命人在老猴子的指引下，一路打怪升级，集齐悟空的“五根”，最终战胜悟空的意念和身躯，孙悟空复活却又重新戴上紧箍咒，在石头中等待新的宿命。\n\n第一回的故事比较直白，金池长老因贪财觊觎唐僧的袈裟，最终葬身火海，这也契合了大圣的六根之一——“眼见喜”。观音菩萨的那句“若不披上这件衣裳，众生又怎知我尘缘已断，金海尽干。”（第一章结尾 CG《看见》）也可谓经典。\n\n![灵吉菩萨](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/lingjipusa.webp)\n\n我最喜欢的是第二章关于黄风大圣的故事，网上有很多解读，我比较认可的说法是灵吉菩萨作祟，惩罚黄金佛国的百姓，而黄风大圣是个好妖。尤其是黄风大圣的那句“我来助你”，喊在了多少人的心坎上。\n\n![黄风大圣：我来助你](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/wolaizhuni.webp)\n\n## 金句\n\n除了观音菩萨对黑熊精说的那句“金海尽干”外，游戏中还有许多金句，大多以旁白的形式出现，还有一些是角色的对白。最精彩的当属黄眉大王 boss 战中的那大段对白。以下是我收集的一些精彩对白：\n\n- **旁白**：“只要心中还有放不下的偶像，终有一天，它将化为修行路上的无解业障。”\n- **旁白**：“有圣就有盗，有高山就有深渊，有天地悬殊就有腥风血雨，我逃不掉，你也逃不掉！”\n- **旁白**：“他们想看的，是如今我们跪着的模样！”\n- **旁白**：“人也，兽也，佛也，妖也，众生自有根器，持优劣为次第，可乱来不得。你说，对吗？孙悟空？”\n- **旁白**：“信什么狗屁如来，不如我自己来！”\n- **旁白**：“既见未来，为何不拜？”\n- **旁白**：“不杀生，仇恨永无止息；不偷盗，强弱如我何异；不邪淫，一切有情皆孽；不妄语，梦幻泡影空虚；不馋酒，忧怖涨落无常；不耽乐，芳华刹那而已；不贪眠，苦苦不得解脱；不纵欲，诸行了无生趣。”\n- **旁白**：“可命运呐，就像爱人的舌头，嘴里一套，心里一套。哪怕亲口尝到，也不知到底是想要，还是不想要。”\n- **旁白**：“后来啊，这禅院又被重建了。可人心若是烧没了，修好一座破庙，又有什么用呢？”\n- **旁白**：“天地万物皆炉鼎，唯有上品得我心。”（戌狗炼丹完成时说）\n- **黑风大王**：“前程暗漆本难知，乘风得势各有时。既成南海修真士，却叫财迷作钱痴。”（黑风大王相关剧情）\n- **寅虎**：“六丁六甲，从不吃素。\u0022（击败玩家后）\n- **虎先锋**：“打不过，就跪下。猴头留着下酒，剩下的交给大王。”（击败玩家后）\n\n## 战斗系统\n\n《黑神话：悟空》的战斗系统极具特色。主角以多样棍法战斗，分为轻棍、重棍等多种类型，各种棍法的表现和打击范围各异。但在一周目时，我只使用了劈棍，因为灵光点有限，无法同时加到多个棍法上，二周目再尝试其他棍法吧。\n\n此外，游戏中还可以使用其他武器和多种法术神通，如奇术、身法、毫毛和变身等。闪避机制相当灵活，并带有无敌帧效果，这点在游戏刚开始时我没注意到，一上来就盲目攻击，不懂得躲避，因此死了无数次才明白。\n\n游戏中有生命值、法力值和气力值三种数值条，各自对应不同的恢复机制。与其他魂类游戏不同的是，这款游戏竟然没有恢复法力的药水，直到二周目我才找到这种丹药。\n\n![击败广智](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/guangzhi.webp)\n\n至于游戏中的那些精魄，大部分我都没用过，一直到一周目过半，我基本上只使用了广智。\n\n## 期待\n\n玩这款游戏时我一直有个疑问：为什么天命人不能开口说话？而且游戏过程中也无法控制天命人的姿势，不像《艾尔登法环》那样可以摆个 pose 拍照，这在拍照模式中还是挺实用的。\n\n另外，希望在未来的 DLC 中能增加地图和更多章节，现在的游戏内容确实有些单薄，熟悉地图后，二周目真的很快就能完成。此外，希望能引入更多的武器系统。我们都知道悟空的经典武器是棍子，但如果能有更多武器选择，战斗会不会更精彩些？\n\n## 总结\n\n总的来说，《黑神话：悟空》是一部充满诚意的作品，但内容略显不足。希望未来的续作能在保持现有优点的基础上，进一步优化游戏体验，增加更多内容和玩法，使《黑神话》系列成为国产游戏的经典之作，也希望未来能有更多优秀的 3A 大作从国内诞生。', '\/blog\/black-myth-wukong-review\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">《黑神话：悟空》一周目体验总结：虽然游戏有不少亮点，但整体内容稍显不足，导致游戏进程偏快，令人意犹未尽。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/macao-trip/">澳门 City Walk：感受精致濠江</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e6%97%85%e8%a1%8c"> 
             旅行
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('澳门 City Walk：感受精致濠江', '澳门虽小，却处处藏着惊喜。从大三巴到新葡京，城市漫步中感受它的独特魅力。', '\n在决定去澳门之前，我对这座小城的印象仅限于大三巴、官也街、葡式蛋挞、何鸿燊，以及七子之歌里那句“你可知 macao 不是我真姓…”。但当我亲自踏上这片 33.3 平方公里的土地时，才发现这个中国最小的一级行政区，竟然充满了独特的韵味。\n\n## 对澳门的第一印象\n\n这次我是从香港乘坐大巴从港珠澳大桥进入澳门。在此之前我就对查阅过资料，了解到澳门面积不大，只有 33.3 平方公里，而北京二环内的面积有 62 公里，近乎澳门的两倍。澳门行政区域内包含包括澳门半岛、氹仔岛和路环岛。澳门的陆地面积是经过长期不断填海逐渐扩大的。澳门与珠海隔河相望，如果说两地“鸡犬相闻”那好不为过。澳门与内地的距离远没有香港与内地那么远。\n\n从澳门妈阁山眺望对岸，珠海近在眼前。珠海和澳门以前山水道相隔，距离不过 300 多米。\n\n![从澳门远眺珠海](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/zhuhai.webp)\n\n澳门半岛是老城区，街道上车水马龙，留给行人步行的空间十分有限。\n\n![澳门半岛的街道](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/street.webp)\n\n## 城市漫步：City Walk\n\n步行到大三巴牌坊，它是圣保禄大教堂前壁遗址，位于花王堂区炮台山下，左邻澳门博物馆和大炮台。牌坊总共有五层，主要以花岗岩建成，宽 23 米，高 25.5 米，坊前有 68 级台阶。大三巴牌坊位列“澳门八景”之首，2005 年，包含大三巴牌坊在内的“澳门历史城区”列入世界文化遗产名录。\n\n![前往大三巴的街道](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/renqun.webp)\n\n在前往大三巴牌坊的路上经过一段小吃街，街道上人声鼎沸，摩肩接踵，因为当天的天气比较炎热，再加上小吃街上散发的牛杂、猪肉铺、蛋挞等的味道，让人心里五味杂陈。原以为大三巴牌坊前会有一块开阔的广场，没想到只有台阶，而且台阶上还坐了很多人。\n\n![大三巴牌坊的背面还在施工](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/dasanba.webp)\n\n在炮台山上可以俯瞰澳门半岛。\n\n![从炮台山上俯瞰澳门半岛](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/paotai.webp)\n\n此地不宜久留，我继续拾阶而上，前往主教座堂。\n\n![主教座堂](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/churt.webp)\n\n澳门的街道上可以看到，墨绿色的防撞柱，嫩绿色的墙，明黄的建筑，配色让人眼前一亮。\n\n![大堂附近的建筑](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/wall.webp)\n\n还有西望洋眺望主教山小堂，在登上斜坡的时候我看到有人在用抹布清洁墙壁。\n\n![从西望洋眺望主教山小堂](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/hill.webp)\n\n澳门半道上最惹眼的建筑非新葡京莫属了。新葡京的全称是新葡京酒店，它的造型设计极度浮夸，内部装饰更是奢华，它是澳门“赌王”何鸿燊耗资 50 亿元兴建的位于澳门葡京路端的赌场酒店，其外形如巨大金莲花，是澳门最知名的地标建筑之一，也是世界 20 座最具标志性大楼之一。它是澳门首家打造“七星级”的豪华酒店，集赌场、住宿、餐饮、娱乐、艺术展览等多种功能于一体。\n\n![可以在澳门半岛上随处仰望可见的新葡京酒店](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/xinpujing.webp)\n\n澳门虽小，但是各种交通工具都很齐全，澳门现有一条运营中的轻轨线路，从妈阁庙到澳门机场和码头，已经连接了澳门的三大区域及交通枢纽。据悉，还有另外两条线路在建。\n\n![威尼斯人娱乐场](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/weinisiren.webp)\n\n夜幕将至，我来到了路凼的威尼斯人娱乐场（内设赌场），没想到这里门口几十辆大巴排列成行，行人入职，内部更是像一个迷宫，三大主体建筑——威尼斯人、巴黎人、伦敦人串联在一起，让人绕来绕起，就是走不出去。威尼斯人娱乐场里的那条人工河充斥着消毒水味，这里面我是一刻也待不下去，真搞不懂为什么要在这里设置一条河。\n\n## 澳门的堂区\n\n在查看地图上我发现澳门有很多“堂区”，那是澳门在葡萄牙殖民统治时期，以天主教的堂区作为行政区划的基础，不过现在“堂区”已经不是正式的行政机构建置，不具法律地位。澳门有七个堂区和一个无堂区划分区域。其中澳门半岛有五个堂区，分别是花地玛堂区、圣安多尼堂区、大堂区、望德堂区、风顺堂区；澳门离岛有两个堂区，分别是嘉模堂区、圣方济各堂区。位于氹仔和路环之间的填海地段为称为路氹城，不属于任何堂区。\n\n葡萄牙以天主教信仰为重要的社会和文化核心，在海外殖民地也推行以教堂为中心的堂区划分制度。教堂在堂区的形成和发展过程中起到了关键的源头性作用，一个地区往往先有重要的教堂建立，随后围绕教堂逐渐形成了具有一定人口规模和社会经济活动的聚居区域，进而被划定为一个堂区。\n\n## 总结\n\n澳门虽小，但每个角落都有它的故事。无论是大三巴的宏伟遗迹，还是街头小吃的烟火气息，这座小城总能给人留下深刻印象。小而精，这就是澳门的魅力所在。\n', '\/blog\/macao-trip\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">澳门虽小，却处处藏着惊喜。从大三巴到新葡京，城市漫步中感受它的独特魅力。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/introducing-kmesh-kernel-native-service-mesh/">介绍 Kmesh：用内核原生技术革新服务网格数据平面</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('介绍 Kmesh：用内核原生技术革新服务网格数据平面', 'Kmesh 利用 eBPF 和内核增强，实现高性能、低延迟的服务网格数据平面。它革新了传统的 Sidecar 架构，降低了资源消耗，适用于现代云原生应用。', '\n在近期整理服务网格数据平面的几种部署模式时，我关注到了徐中虎在 KubeCon China 2024 的分享《[Istio 数据平面的新选择：全新性能体验的架构创新](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)》。该分享介绍了 Kmesh，它利用 eBPF 和内核增强技术，消除了 Sidecar，并提出了双引擎模式，是一种创新性的服务网格解决方案。去年我已听闻 Kmesh，借此契机我深入研究了 Kmesh，撰写此博客与大家分享。\n\n{{\u003ccallout note \u0022注意\u0022\u003e}}\n\n**注意**：本文中所展示的所有数据均引用自 [《Istio 数据平面的新选择：全新性能体验的架构创新》](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)，我并未对这些数据的准确性进行独立验证。请读者自行判断和核实这些数据的可靠性。\n\n{{\u003c\/callout\u003e}}\n\n\n## 背景\n\n像 Istio 这样的服务网格已成为管理复杂微服务架构的核心，提供流量管理、安全性和可观测性等功能。Sidecar 模型，即在每个服务实例旁运行一个代理，已成为主要方法。虽然功能有效，但这种架构引入了显著的延迟和资源开销。\n\n## 传统 Sidecar 架构的局限性\n\n1. **延迟开销**：增加 Sidecar 代理会导致网络跳数和上下文切换增加，每次服务调用引入额外 **2 至 3 毫秒** 的延迟。对于对延迟敏感的应用，这种延迟是不可接受的。\n\n2. **资源消耗**：每个 Sidecar 都会消耗 CPU 和内存资源。在拥有数千个服务的大规模部署中，累积的资源开销巨大，虽然可以通过一定的技术手段进行优化，但依然降低了部署密度并增加了运营成本。\n\nIstio 的性能测量显示，即使没有流量分发，仍存在约 3 毫秒的固有延迟开销。随着连接数量的增长，延迟相应增加，这突显了 Sidecar 模型在高性能应用中的低效。\n\n## 行业应对挑战的尝试\n\n已经提出了多种解决方案来缓解 Sidecar 架构的缺点：\n\n### Cilium 服务网格\n\n- **方法**：将 eBPF 与 Envoy 相结合，创建一个无 Sidecar 的服务网格。\n- **机制**：\n  - **L4 流量**：使用 eBPF 进行高效的内核级数据路由。\n  - **L7 流量**：依赖 Envoy 进行应用层解析。\n- **局限性**：\n  - **L7 额外跳数**：通过 Envoy 进行 L7 管理引入了额外的网络跳数。\n  - **故障隔离**：在确保治理故障隔离方面存在挑战。\n\n### Istio Ambient Mesh\n\n- **方法**：使用 **ztunnel** 和 **waypoint** 代理，引入无 Sidecar 的架构。\n- **机制**：\n  - **用户空间处理**：所有流量拦截和管理都在用户空间进行。\n- **局限性**：\n  - **复杂的流量拦截**：用户空间的拦截增加了复杂性。\n  - **跳数增加**：L7 连接涉及多个网络跳数，增加了延迟。\n\n这些解决方案虽然创新，但并未完全解决 Sidecar 架构固有的延迟和资源开销问题。\n\n更多详细信息可以参考我的另一篇文章：[数据平面的几种部署模式](\/blog\/service-mesh-data-plane-deployment-modes\/)。\n\n## 介绍 Kmesh：一种内核原生的方法\n\n[Kmesh](https:\/\/github.com\/kmesh-net\/kmesh) 通过将流量治理直接集成到操作系统内核，定义了一种新的服务网格数据平面。利用 eBPF（扩展伯克利数据包过滤器）和内核增强，Kmesh 提供高性能、低延迟和资源高效的服务网格能力。\n\n### 技术架构\n\n下图展示了 Kmesh 的架构。\n\n![Kmesh 架构图：（根据 [Kmesh GitHub](https:\/\/github.com\/kmesh-net\/kmesh) 绘制）](kmesh-arch.svg)\n\n**核心组件**：\n\n- **Kmesh-Daemon**：每个节点的管理组件，负责：\n  - 管理 eBPF 程序。\n  - 从控制平面（如 Istiod）订阅 xDS 配置。\n  - 处理可观测性和指标收集。\n\n- **eBPF 编排**：在内核级实现流量拦截和管理，支持：\n  - L4 负载均衡。\n  - 流量加密和解密。\n  - 监控和简单的 L7 动态路由。\n\n- **Waypoint Proxy（双引擎模式下可选）**：处理高级 L7 流量治理，可按命名空间或服务进行部署。\n\n### 关键优势\n\n该分享中指出 Kmesh 具有以下优势，尤其是性能和资源利用率上：\n\n![Kmesh vs Sidecar vs Ambient（[来源](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)）](performance.webp)\n\n1. **高性能**：\n   - **延迟降低**：与传统 Sidecar 架构相比，内核原生的 L7 管理将转发延迟降低了超过 **60%**。\n   - **应用启动改进**：由于消除了 Sidecar 初始化，应用启动时间提升了 **40%**。\n\n2. **低资源开销**：\n   - **资源效率**：无需 Sidecar 代理，资源消耗减少了超过 **70%**。\n\n3. **高可用性**：\n   - **无缝升级**：内核级流量管理确保升级或重启 Kmesh 组件不会中断现有的服务连接。\n\n4. **安全隔离**：\n   - **增强的安全性**：利用基于 BPF 的虚拟机安全和 cgroup 级别的治理隔离，确保安全的多租户环境。\n\n5. **灵活的治理模型**：\n   - **部署模式**：提供内核原生模式以实现最大性能，和双引擎模式以获得部署灵活性。\n\n6. **无缝兼容性**：\n   - **控制平面集成**：完全兼容 xDS 协议，允许与 Istio 控制平面集成，支持 Istio API 和 Gateway API。\n\n## Kmesh vs Ambient vs Cilium mesh\n\n通过上文中对 Kmesh 的介绍，你会发现它与 Istio Ambient 模式及 Cilium mesh 有很多相似性，下表将从多个维度对比它们之间的区别。\n\n| 比较维度               | Kmesh                                                        | Istio Ambient 模式                                           | Cilium Mesh                                                  |\n| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| **流量拦截与处理方式** | \u0026bull; **内核级处理：** 利用 eBPF 和内核增强，将流量治理直接集成到操作系统内核中。\u003cbr\u003e\u0026bull;**模式选择：**\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026bull; **内核原生模式：** L4 和 L7 流量全部在内核中处理，无需用户空间代理。\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026bull; **双引擎模式：** L4 在内核中处理，L7 由 Waypoint Proxy 处理。 | \u0026bull; **用户空间处理：** 引入 **ztunnel** 和 **Waypoint Proxy**，在用户空间进行流量拦截和管理。\u003cbr\u003e\u0026bull; **无 Sidecar 架构：** 消除了 Sidecar，但增加了新的用户空间组件。 | \u0026bull; **混合处理：** 结合 eBPF 和 Envoy。\u003cbr\u003e\u0026bull; **L4 流量：** 在内核中使用 eBPF 处理。\u003cbr\u003e\u0026bull; **L7 流量：** 由用户空间的 Envoy 代理处理。 |\n| **性能与延迟**         | \u0026bull; **高性能：** 内核级处理，减少上下文切换和数据拷贝。\u003cbr\u003e\u0026bull; **延迟降低：** 转发延迟降低超过 **60%**。\u003cbr\u003e\u0026bull; **低延迟启动：** 应用启动时间提高 **40%**。 | \u0026bull; **性能改进但仍有延迟：** 比传统 Sidecar 架构有所提升，但用户空间处理和增加的网络跳数仍带来延迟。 | \u0026bull; **L4 性能优异：** L4 流量内核处理，高效。\u003cbr\u003e\u0026bull; **L7 存在开销：** L7 流量通过 Envoy，增加网络跳数和潜在延迟。 |\n| **架构复杂度**         | \u0026bull; **内核依赖：** 需要特定内核版本或增强，部署复杂度增加。\u003cbr\u003e\u0026bull; **组件简洁：** 内核处理，减少对用户空间组件的依赖。 | \u0026bull; **新增组件：** 引入 ztunnel 和 Waypoint Proxy，架构更复杂。\u003cbr\u003e\u0026bull; **Istio 生态：** 继承 Istio 的复杂性。 | \u0026bull; **双重组件：** 需要管理 eBPF 和 Envoy。\u003cbr\u003e\u0026bull; **L7 复杂性：** 处理 L7 流量时架构更复杂。\u003cbr\u003e\u0026bull; **CNI 集成：** 简化部分网络配置。 |\n| **安全性与隔离**       | \u0026bull; **内核级安全：** 利用 BPF 虚拟机和 cgroup 隔离，提供高安全保障。\u003cbr\u003e\u0026bull; **mTLS 内核支持：** 内核实现双向 TLS，加密性能高。 | \u0026bull; **用户空间安全：** 通过用户空间组件实现安全功能，可能增加攻击面。\u003cbr\u003e\u0026bull; **丰富策略支持：** 继承 Istio 的安全策略和配置能力。 | \u0026bull; **eBPF 安全特性：** 利用 eBPF 的安全模型。\u003cbr\u003e\u0026bull; **隔离挑战：** 治理故障隔离需额外考虑。 |\n| **兼容性与集成**       | \u0026bull; **Istio 控制平面：** 集成 Istio 控制平面，支持 xDS 协议，兼容 Istio API 和 Gateway API。\u003cbr\u003e\u0026bull; **Kubernetes 原生：** 无缝运行在 Kubernetes 上。 | \u0026bull; **完全兼容：** 作为 Istio 的一部分，完全兼容 Istio API 和生态系统。 | \u0026bull; **CNI 角色：** 作为 Kubernetes 的 CNI 插件，提供网络和服务网格功能。\u003cbr\u003e\u0026bull; **网络策略：** 提供强大的网络策略和安全功能。 |\n| **部署与运维考虑**     | \u0026bull; **内核要求：** 需修改内核或使用特定版本，注意兼容性。\u003cbr\u003e\u0026bull; **性能优先：** 适合追求极致性能的场景。 | \u0026bull; **易于迁移：** 为 Istio 用户提供无 Sidecar 替代方案，便于过渡。\u003cbr\u003e\u0026bull; **复杂性管理：** 需管理新增用户空间组件。 | \u0026bull; **现有 Cilium 用户：** 已使用 Cilium 时，集成服务网格功能简单。\u003cbr\u003e\u0026bull; **学习曲线：** 需熟悉 eBPF 与 Envoy 的结合。 |\n\n**总结：**\n\n- **Kmesh**：通过将流量治理下沉到内核，实现高性能和低延迟，适用于对性能和资源效率要求极高的应用。但需要特定的内核支持，部署时需考虑兼容性。\n\n- **Istio Ambient Mesh**：消除了 Sidecar，改进了性能，保留了 Istio 的丰富功能，但用户空间处理可能带来新的复杂性和延迟。\n\n- **Cilium Mesh**：利用 eBPF 提高 L4 性能，但 L7 流量处理依赖 Envoy，可能增加复杂性和延迟。适合已经使用 Cilium 的环境，提供强大的网络策略和安全功能。\n\n## Kmesh 的两种运行模式\n\nKmesh 提供两种运行模式，以满足不同的部署需求：\n\n### 内核原生模式\n\n**概述**：\n\n- **极致性能**：在 L4 和 L7 流量中实现最低的延迟，无额外的网络跳数。\n- **机制**：\n  - **内核增强**：使用 eBPF 和内核模块（ko）增强内核。\n  - **伪造的 TCP 连接**：在内核中利用“伪建链”来管理复杂的应用层流量。\n  - **流量管理**：在客户端发起通信时直接管理流量，消除不必要的上下文切换和数据拷贝。\n\n{{\u003ccallout tip \u0022伪建链\u0022\u003e}}\n\nKmesh 采用了一种称为“伪建链”的技术，当收到 downstream 的 TCP 请求时，eBPF 程序首先与 downstream 创建一个“伪 TCP 连接”，而不会立即与 upstream 服务建立实际连接。eBPF 程序在获取到 downstream 发出的 HTTP 消息后，根据消息进行 L7 路由处理，找到目标服务后再与 upstream 建立连接。通过这种方式，Kmesh 将 L7 层的处理下沉到内核中，提高了处理效率。\n\n{{\u003c\/callout\u003e}}\n\n**优势**：\n\n- **延迟降低**：转发延迟减少超过 60%。\n- **无需用户空间代理**：整个流量管理在内核内完成。\n\n**考虑因素**：\n\n- **内核版本要求**：可能需要特定的内核版本或增强，这可能影响部署的灵活性。\n\n### 双引擎模式\n\n**概述**：\n\n- **灵活治理**：在性能和更广泛的兼容性之间取得平衡。\n- **机制**：\n  - **内核级拦截**：使用 eBPF 在内核空间拦截流量。\n  - **Waypoint Proxy**：部署远程的 Waypoint Proxy 来处理复杂的 L7 流量管理。\n  - **层次分离**：将 L4 和 L7 的治理在内核空间（eBPF）和用户空间（Waypoint）之间分离。\n\n**优势**：\n\n- **延迟降低**：相比 Istio 的 Ambient Mesh，延迟减少了 **30%**。\n- **简化的流量拦截**：内核空间的拦截比用户空间更安全、更简单。\n- **降低采用门槛**：减少对特定内核版本的依赖，便于用户采用。\n\n**与 Ambient Mesh 的比较**：\n\n- **更少的网络跳数**：Kmesh 对于 L7 连接仅增加一个额外跳数，而 Ambient Mesh 可能增加多达三个。\n- **更简单的架构**：内核级拦截避免了用户空间拦截机制的复杂性。\n\n## 深入了解 Kmesh 的技术\n\n### eBPF 和内核增强\n\n**eBPF（扩展伯克利数据包过滤器）** 是一种强大的技术，允许安全高效地将自定义代码注入到 Linux 内核。Kmesh 利用 eBPF 来：\n\n- **拦截网络流量**：将 eBPF 程序附加到网络事件，实现对数据包的实时拦截和操作。\n- **实现负载均衡**：根据策略将流量导向合适的服务实例。\n- **执行流量加密**：在内核中处理 mTLS 加解密（开发中，计划 2024 年底支持），降低开销。\n- **收集可观测性数据**：在不影响应用性能的情况下收集指标和遥测数据。\n\n### 流量拦截和管理\n\n在内核原生模式中：\n\n- **伪造的连接**：Kmesh 在内核中创建伪造的 TCP 连接，避免涉及用户空间代理来管理流量。\n- **直接的数据包操作**：在内核级拦截和重定向数据包，消除在用户空间和内核空间之间移动数据包时的上下文切换和数据拷贝。\n\n在双引擎模式中：\n\n- **eBPF 拦截**：eBPF 程序处理初始的流量拦截和基本的 L4 管理。\n- **Waypoint Proxy**：对于路由、重试和头部操作等高级 L7 功能，流量被转发到按服务或命名空间部署的 Waypoint Proxy。\n\n### 安全和隔离\n\n- **BPF 虚拟机安全**：eBPF 在内核中的受限虚拟机中运行，确保注入的代码不会破坏内核稳定性。\n- **cgroup 级别隔离**：在 cgroup 级别应用治理策略，为不同的服务和工作负载提供隔离。\n- **mTLS 支持**：计划在内核中实现双向 TLS，提供零信任安全，而无需用户空间的加密开销。\n\n## 性能分析\n\n**测试设置**：\n\n- **基准工具**：使用 [Fortio](https:\/\/github.com\/fortio\/fortio) 生成负载并测量延迟。\n- **比较对象**：在四种配置下测量性能：\n  1. **基线**：没有任何服务网格的直接通信。\n  2. **Istio Sidecar**：传统的 Sidecar 部署。\n  3. **Istio Ambient Mesh**：使用 ztunnel 和 Waypoint 的无 Sidecar 部署。\n  4. **Kmesh**：包括内核原生模式和双引擎模式。\n\n**结果**：\n\n- **延迟**：\n  - **Kmesh 内核原生模式**：相比 Istio Sidecar，转发延迟降低了超过 **60%**。\n  - **Kmesh 双引擎模式**：相比 Istio Ambient Mesh，延迟减少了 **30%**。\n- **资源消耗**：\n  - **CPU 和内存**：Kmesh 将资源开销降低了超过 **70%**，因为无需 Sidecar 代理。\n- **应用启动时间**：\n  - 提高了 **40%**，因为应用不再需要等待 Sidecar 初始化。\n\n**解读**：\n\n- Kmesh 接近基线性能，使服务网格的开销可以忽略不计。\n- 消除上下文切换和数据拷贝对性能提升贡献显著。\n- 内核原生方法确保即使服务数量增加，性能也能保持一致。\n\n## 云原生集成与兼容性\n\n- **Kubernetes 原生**：Kmesh 无缝运行在 Kubernetes 上，管理 Pod 的进出流量，无需更改应用代码。\n- **控制平面集成**：\n  - **xDS 协议支持**：从 Istiod 订阅 xDS 配置，确保与 Istio 控制平面兼容。\n  - **Istio API 兼容性**：支持现有的 Istio API，允许用户使用熟悉的配置和策略。\n- **Gateway API 支持**：兼容 Gateway API，支持更灵活和丰富的流量管理。\n- **可观测性**：\n  - 集成 Prometheus 进行指标收集。\n  - 利用 eBPF 高效地收集数据，不影响性能。\n- **安全策略**：\n  - 支持现有的 Istio 安全策略，包括认证和授权。\n\n## 结论\n\nKmesh 通过将流量管理移入内核，代表了服务网格技术的范式转变。利用 eBPF 和内核增强，它解决了传统 Sidecar 架构中延迟和资源开销的关键问题。Kmesh 为现代云原生应用提供了灵活、高性能的解决方案，特别适用于需要低延迟和高吞吐量的场景。\n\n**主要收获**：\n\n- **性能**：通过消除不必要的开销，实现接近基线的性能。\n- **资源效率**：降低 CPU 和内存消耗，提升部署密度。\n- **灵活性**：提供多种运行模式，适应不同的部署场景。\n- **安全性**：通过内核级的执行和隔离机制增强安全性。\n- **兼容性**：与包括 Kubernetes 和 Istio 在内的现有云原生生态系统无缝集成。\n\n## 参考\n\n- [IstioCon 2023 要点总结](https:\/\/www.zhaohuabing.com\/post\/2023-09-26-istiocon-china\/)\n- [Istio 数据平面的新选择：全新性能体验的架构创新](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)', '\/blog\/introducing-kmesh-kernel-native-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Kmesh 利用 eBPF 和内核增强，实现高性能、低延迟的服务网格数据平面。它革新了传统的 Sidecar 架构，降低了资源消耗，适用于现代云原生应用。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/noisy-neighbor-detection-with-ebpf/">[译] 使用 eBPF 检测和优化 Linux 容器的噪声邻居问题</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/12</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             其他
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://netflixtechblog.com/noisy-neighbor-detection-with-ebpf-64b1f4b3bbdd" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 eBPF 检测和优化 Linux 容器的噪声邻居问题', 'Netflix 利用 eBPF 技术实现了 Linux 调度器的低开销持续检测，有效地监控和优化了多租户环境中容器的噪声邻居问题。', '\nNetflix 的计算与性能工程团队定期调查我们多租户环境中的性能问题。首先是确定问题是源自应用程序还是底层基础设施。一个经常复杂化这一过程的问题是“噪声邻居”问题。在我们的多租户计算平台 [Titus](https:\/\/netflixtechblog.com\/titus-the-netflix-container-management-platform-is-now-open-source-f868c9fb5436)，“噪声邻居”指的是大量使用服务器资源的容器或系统服务，导致相邻容器的性能下降。我们通常关注 CPU 利用率，因为它是我们工作负载中噪声邻居问题的最常见来源。\n\n检测噪声邻居的影响是复杂的。传统的性能分析工具如 [perf](https:\/\/www.brendangregg.com\/perf.html) 可能会引入显著的开销，从而加剧性能下降。此外，这些工具通常在事后部署，对有效调查来说已经太迟了。另一个挑战是，调试噪声邻居问题需要相当的底层专业知识和专门的工具。在这篇博客文章中，我们将展示我们如何利用 [eBPF](https:\/\/ebpf.io\/) 实现 Linux 调度器的持续、低开销的检测，有效地自助监控噪声邻居问题。你将学习到 Linux 内核检测如何改善你的基础设施可观测性，并带来更深入的洞察和增强的监控。\n\n## 持续检测 Linux 调度器\n\n为了确保我们依赖低延迟响应的工作负载的可靠性，我们对每个容器的 [run queue](https:\/\/en.wikipedia.org\/wiki\/Run_queue) 延迟进行了检测，这个指标衡量进程在调度队列中等待被派发到 CPU 的时间。在此队列中的长时间等待可能是性能问题的征兆，尤其是当容器没有使用其全部 CPU 分配时。持续的检测对于抓住这类问题至关重要，而 eBPF 通过最小的开销进入 Linux 调度器，使我们能够有效地监控 run queue 延迟。\n\n为了发出 run queue 延迟指标，我们利用了三个 eBPF 钩子：\u0060sched_wakeup\u0060、\u0060sched_wakeup_new\u0060 和 \u0060sched_switch\u0060。\n\n![图 1：测量和检测 run queue 延迟的图示](f1.png)\n\n\u0060sched_wakeup\u0060 和 \u0060sched_wakeup_new\u0060 钩子在进程状态从“睡眠”变为“可运行”时调用。它们让我们识别出进程准备运行并等待 CPU 时间的时刻。在此事件中，我们生成一个时间戳，并使用进程 ID 作为键，将其存储在 eBPF 哈希图中。\n\n\u0060\u0060\u0060c\u002b\u002b\nstruct {\n    __uint(type, BPF_MAP_TYPE_HASH);\n    __uint(max_entries, MAX_TASK_ENTRIES);\n    __uint(key_size, sizeof(u32));\n    __uint(value_size, sizeof(u64));\n} runq_enqueued SEC(\u0022.maps\u0022);\n\nSEC(\u0022tp_btf\/sched_wakeup\u0022)\nint tp_sched_wakeup(u64 *ctx)\n{\n    struct task_struct *task = (void *)ctx[0];\n    u32 pid = task-\u003epid;\n    u64 ts = bpf_ktime_get_ns();\n\n    bpf_map_update_elem(\u0026runq_enqueued, \u0026pid, \u0026ts, BPF_NOEXIST);\n    return 0;\n}\n\u0060\u0060\u0060\n\n相反，\u0060sched_switch\u0060 钩子在 CPU 在进程间切换时触发。这个钩子提供了当前利用 CPU 的进程和即将接管的进程的指针。我们使用即将执行任务的进程 ID (PID) 来获取之前存储的时间戳。然后，我们通过简单地减去时间戳来计算 run queue 延迟。\n\n\u0060\u0060\u0060c\u002b\u002b\nSEC(\u0022tp_btf\/sched_switch\u0022)\nint tp_sched_switch(u64 *ctx)\n{\n    struct task_struct *prev = (struct task_struct *)ctx[1];\n    struct task_struct *next = (struct task_struct *)ctx[2];\n    u32 prev_pid = prev-\u003epid;\n    u32 next_pid = next-\u003epid;\n \n    \/\/ 获取下一个任务入队的时间戳\n    u64 *tsp = bpf_map_lookup_elem(\u0026runq_enqueued, \u0026next_pid);\n    if (tsp == NULL) {\n        return 0; \/\/ 未记录入队\n    }\n\n    \/\/ 在删除存储的时间戳前计算 runq 延迟\n    u64 now = bpf_ktime_get_ns();\n    u64 runq_lat = now - *tsp;\n\n    \/\/ 从 enqueued 图中删除 PID\n    bpf_map_delete_elem(\u0026runq_enqueued, \u0026next_pid);\n    ....\n\u0060\u0060\u0060\n\neBPF 的一个优势是它能提供指向实际内核数据结构的指针，这些结构代表进程或线程，也称为内核术语中的任务。这一特性使得我们能够访问关于进程存储的大量信息。我们需要进程的 cgroup ID 以将其与容器关联，但是进程结构中的 cgroup 信息受到 [RCU (Read Copy Update) 锁](https:\/\/elixir.bootlin.com\/linux\/v6.6.16\/source\/include\/linux\/sched.h#L1225) 的保护。\n\n为了安全地访问这些受 RCU 保护的信息，我们可以利用 eBPF 中的 [kfuncs](https:\/\/docs.kernel.org\/bpf\/kfuncs.html)。kfuncs 是可以从 eBPF 程序调用的内核函数。这些函数确保我们的 eBPF 程序在检索任务结构中的 cgroup ID 时保持安全和高效。\n\n\u0060\u0060\u0060c\u002b\u002b\nvoid bpf_rcu_read_lock(void) __ksym;\nvoid bpf_rcu_read_unlock(void) __ksym;\n\nu64 get_task_cgroup_id(struct task_struct *task)\n{\n    struct css_set *cgroups;\n    u64 cgroup_id;\n    bpf_rcu_read_lock();\n    cgroups = task-\u003ecgroups;\n    cgroup_id = cgroups-\u003edfl_cgrp-\u003ekn-\u003eid;\n    bpf_rcu_read_unlock();\n    return cgroup_id;\n}\n\u0060\u0060\u0060\n\n数据准备好后，我们必须将其打包并发送到用户空间。为此，我们选择了 eBPF [环形缓冲区](https:\/\/nakryiko.com\/posts\/bpf-ringbuf\/)。它既高效又高性能，且用户友好。它可以处理变长数据记录，并允许数据读取而无需额外的内存复制或系统调用。然而，大量数据点使得用户空间程序的 CPU 使用过多，所以我们在 eBPF 中实施了速率限制以采样数据。\n\n\u0060\u0060\u0060c\u002b\u002b\nstruct {\n    __uint(type, BPF_MAP_TYPE_RINGBUF);\n    __uint(max_entries, RINGBUF_SIZE_BYTES);\n} events SEC(\u0022.maps\u0022);\n\nstruct {\n    __uint(type, BPF_MAP_TYPE_PERCPU_HASH);\n    __uint(max_entries, MAX_TASK_ENTRIES);\n    __uint(key_size, sizeof(u64));\n    __uint(value_size, sizeof(u64));\n} cgroup_id_to_last_event_ts SEC(\u0022.maps\u0022);\n\nstruct\n\n runq_event {\n    u64 prev_cgroup_id;\n    u64 cgroup_id;\n    u64 runq_lat;\n    u64 ts;\n};\n\nSEC(\u0022tp_btf\/sched_switch\u0022)\nint tp_sched_switch(u64 *ctx)\n{\n    \/\/ ....\n    \/\/ 上述代码\n    \/\/ ....\n \n    u64 prev_cgroup_id = get_task_cgroup_id(prev);\n    u64 cgroup_id = get_task_cgroup_id(next);\n \n    \/\/ 按每个 cgroup ID 每个 CPU 进行速率限制\n    \/\/ 平衡可观测性与性能开销\n    u64 *last_ts = \n        bpf_map_lookup_elem(\u0026cgroup_id_to_last_event_ts, \u0026cgroup_id);\n    u64 last_ts_val = last_ts == NULL ? 0 : *last_ts;\n\n    \/\/ 在进行更多工作之前检查考虑中的 cgroup ID 的速率限制\n    if (now - last_ts_val \u003c RATE_LIMIT_NS) {\n        \/\/ 速率限制超出，丢弃事件\n        return 0;\n    }\n\n    struct runq_event *event;\n    event = bpf_ringbuf_reserve(\u0026events, sizeof(*event), 0);\n  \n    if (event) {\n        event-\u003eprev_cgroup_id = prev_cgroup_id;\n        event-\u003ecgroup_id = cgroup_id;\n        event-\u003erunq_lat = runq_lat;\n        event-\u003ets = now;\n        bpf_ringbuf_submit(event, 0);\n        \/\/ 更新当前 cgroup ID 的最后一个事件时间戳\n        bpf_map_update_elem(\u0026cgroup_id_to_last_event_ts, \u0026cgroup_id,\n            \u0026now, BPF_ANY);\n\n    }\n\n    return 0;\n}\n\u0060\u0060\u0060\n\n我们在 Go 开发的用户空间应用程序处理环形缓冲区中的事件，以向我们的度量后端 [Atlas](https:\/\/netflixtechblog.com\/introducing-atlas-netflixs-primary-telemetry-platform-bd31f4d8ed9a) 发出度量。每个事件包含一个带有 cgroup ID 的 run queue 延迟样本，我们将其与主机上运行的容器关联。如果没有发现这种关联，我们会将其分类为系统服务。当 cgroup ID 与容器关联时，我们会为该容器发出百分位计时器 Atlas 度量（\u0060runq.latency\u0060）。我们还增加了一个计数器度量（\u0060sched.switch.out\u0060）来监控容器进程的抢占情况。通过访问被抢占进程的 \u0060prev_cgroup_id\u0060，我们可以为度量标记抢占的原因，无论是同一容器（或 cgroup）内的进程、另一个容器的进程还是系统服务的进程。\n\n值得强调的是，\u0060runq.latency\u0060 度量和 \u0060sched.switch.out\u0060 度量都需要确定容器是否受到噪声邻居的影响，这是我们旨在实现的目标。单独依赖 \u0060runq.latency\u0060 度量可能会导致误解。例如，如果容器处于或超过其 cgroup CPU 限制，调度器将对其进行限制，导致队列中的延迟明显增加。如果我们只考虑这个度量，我们可能错误地将性能下降归咎于噪声邻居，而实际上是因为容器触及了其 CPU 配额。然而，当两个度量同时出现尖峰，尤其是当原因是不同容器或系统进程时，明显表明了噪声邻居问题。\n\n## 噪声邻居的故事\n\n以下是一台运行单个容器的服务器的 \u0060runq.latency\u0060 度量，该容器拥有充足的 CPU 容量。99 百分位平均为 83.4 微秒（微秒），作为我们的基准。尽管有些尖峰达到 400 微秒，但延迟仍在可接受的参数范围内。\n\n![](f2.png)\n\ncontainer1 的 99 百分位 runq.latency 平均为 83 微秒（微秒），尖峰可达 400 微秒，没有相邻容器。这作为一个容器在主机上未争夺 CPU 的基准。\n\n在 10:35，启动 \u0060container2\u0060，它充分利用了主机上的所有 CPU，导致 \u0060container1\u0060 的 P99 run queue 延迟出现了 131 毫秒的尖峰（131,000 微秒）。如果用户空间应用程序正在服务 HTTP 流量，则这一尖峰将在用户空间应用程序中可见。如果用户空间应用程序所有者报告了无法解释的延迟尖峰，我们可以通过 run queue 延迟度量迅速识别噪声邻居问题。\n\n![](f3.png)\n\n在 10:35 启动的 container2 充分利用了主机上的所有 CPU，**导致 container1 的 P99 run queue 延迟出现了 131 毫秒的尖峰**，因为系统进程的抢占增加。这表明存在一个噪声邻居问题，即系统服务与容器竞争 CPU 时间。我们的度量显示，噪声邻居实际上是系统进程，可能是由 \u0060container2\u0060 消耗所有可用 CPU 容量触发的。\n\n## 优化 eBPF 代码\n\n我们开发了一个名为 [bpftop](https:\/\/netflixtechblog.com\/announcing-bpftop-streamlining-ebpf-performance-optimization-6a727c1ae2e5) 的开源 eBPF 进程监控工具，用来测量此内核热路径中 eBPF 代码的开销。我们使用 \u0060bpftop\u0060 进行的性能分析显示，检测仪增加的开销不到每个 \u0060sched_*\u0060 钩子 600 纳秒。我们对在容器中运行的 Java 服务进行了性能分析，发现检测代码未引入显著开销。开启与关闭 run queue 检测代码的性能差异在毫秒级不可测。\n\n在我们对内核中如何测量 eBPF 统计信息的研究中，我们发现了一个改进计算的机会。我们提交了这个 [patch](https:\/\/git.kernel.org\/pub\/scm\/linux\/kernel\/git\/torvalds\/linux.git\/commit\/?id=ce09cbdd988887662546a1175bcfdfc6c8fdd150)，并包括在 Linux 内核 6.10 版本中。\n\n![](f4.gif)\n\n通过试错和使用 \u0060bpftop\u0060，我们确定了几种优化，帮助保持了我们 eBPF 代码的低开销：\n\n- 我们发现 \u0060BPF_MAP_TYPE_HASH\u0060 存储入队时间戳时最为高效。使用 \u0060BPF_MAP_TYPE_TASK_STORAGE\u0060 会导致性能下降近一倍。\u0060BPF_MAP_TYPE_PERCPU_HASH\u0060 的性能略低于 \u0060BPF_MAP_TYPE_HASH\u0060，这是意料之外的，需要进一步调查。\n- \u0060BPF_MAP_TYPE_LRU_HASH\u0060 映射的操作比常规哈希映射慢 40-50 纳秒。由于 PID 流失引起的空间问题，我们最初使用了它们来存储入队时间戳。最终，我们选择了增大尺寸的 \u0060BPF_MAP_TYPE_HASH\u0060，以降低这一风险。\n- \u0060BPF_CORE_READ\u0060 帮助每次调用增加 20-30 纳秒。在特别是那些“BTF 启用”的原始跟踪点（\u0060tp_btf\/*\u0060）的情况下，直接访问任务结构成员是安全且更高效的。Andrii Nakryiko 在这篇 [博客文章](https:\/\/nakryiko.com\/posts\/bpf-core-reference-guide\/#btf-enabled-bpf-program-types-with-direct-memory-reads) 中推荐了这种方法。\n- \u0060sched_switch\u0060、\u0060sched_wakeup\u0060 和 \u0060sched_wakeup_new\u0060 都会因内核任务触发，这些任务的 PID 为 0。我们发现监控这些任务是不必要的，因此我们实施了几种提前退出条件和条件逻辑，以防在处理内核任务时执行代价高昂的操作，如访问 BPF 映射。值得注意的是，内核任务就像任何常规进程一样通过调度队列操作。\n\n## 结论\n\n我们的发现突出了使用 eBPF 对 Linux 内核进行低开销持续检测的价值。我们已将这些度量整合到客户仪表板中，使其能够提供可操作的洞察，并指导多租户性能讨论。我们现在也可以使用这些度量来完善 CPU 隔离策略，以最小化噪声邻居的影响。此外，这些度量使我们深入了解了 Linux 调度器。\n\n这项工作还加深了我们对 eBPF 技术的理解，并强调了像 \u0060bpftop\u0060 这样的工具对优化 eBPF 代码的重要性。随着 eBPF 的采用增加，我们预见更多的基础设施可观测性和业务逻辑将转向使用它。在这方面有一个前景广阔的项目是 [sched_ext](https:\/\/github.com\/sched-ext\/scx)，它有潜力革新调度决策的制定方式，并根据特定工作负载需求进行定制。\n', '\/trans\/noisy-neighbor-detection-with-ebpf\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Netflix 利用 eBPF 技术实现了 Linux 调度器的低开销持续检测，有效地监控和优化了多租户环境中容器的噪声邻居问题。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     <li class="page-item">
       <a class="page-link" href="/blog/">
         ««
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a href="/blog/page/2/" class="page-link">
         «
       </a>
     </li>
     
     
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/blog/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/blog/page/4/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/blog/page/29/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(83)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(20)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%b7%a5%e5%85%b7" class="sidebar-item">
            <span>工具</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/napkin-ai-visualization-tool/">AI 工具推荐 Napkin.ai：让复杂想法一键变成直观图表</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/cilium-annual-report-2024/">Cilium 2024 年度报告解读</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-ambient-packet-lifecycle-optimization/">Istio Ambient 模式中的数据包生命周期及流量优化</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-community-domain-migration/">云原生社区网站域名变更通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
