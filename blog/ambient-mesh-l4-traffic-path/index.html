<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Istio Ambient 模式中的透明流量劫持四层网络路由路径详解 · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.123.7">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.38ab4e47c5642975d2df8e2aaf513aff41a8914f7e6cc83b4e2b29eaf4e7e41d.css" as="style">
  <link rel="stylesheet" href="/css/combined.38ab4e47c5642975d2df8e2aaf513aff41a8914f7e6cc83b4e2b29eaf4e7e41d.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.00b4a6de372c636bebba4cbd5ba308aa154fb16e9e89325264f68ad9642dcbc3.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.00b4a6de372c636bebba4cbd5ba308aa154fb16e9e89325264f68ad9642dcbc3.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/ambient-mesh-l4-traffic-path/" />
  <meta property="og:title" content="Istio Ambient 模式中的透明流量劫持四层网络路由路径详解 | Jimmy Song" />
  <meta property="twitter:title" content="Istio Ambient 模式中的透明流量劫持四层网络路由路径详解 | Jimmy Song" />

  
  <meta property="og:description" content="本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。" />
  <meta property="twitter:description" content="本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/ambient-l4.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/ambient-l4.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                导航
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="/categories">分类</a>
                
                <a class="dropdown-item" href="/tags">标签</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://cloudnative.to" target="_blank" rel="noopener">社区 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
            
            
            
            
            
            
            
            <a class="nav-link" href="/en/blog/ambient-mesh-l4-traffic-path/">English</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            <input type="radio" id="blog" name="search_type" value="blog">
            <label for="blog">博客</label>
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    Istio Ambient 模式中的透明流量劫持四层网络路由路径详解
                </p>
                <p class="page-description">
                    本文以图示和实际操作的形式详细介绍了 Ambient Mesh 中的透明流量劫持和四层（L4）流量路径。
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>2022/11/14</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/categories/istio"> 
                        Istio</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>42 分钟</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>9328 字</li>
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">
            
            <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#principles">原理</a>
      <ul>
        <li><a href="#what-is-tproxy">什么是 tproxy？</a></li>
        <li><a href="#what-is-hbone">什么是 HBONE？</a></li>
      </ul>
    </li>
    <li><a href="#environment">环境说明</a></li>
    <li><a href="#outbound">Outbound 流量劫持</a>
      <ul>
        <li><a href="#node-a-rules">检查节点 A 上的路由规则</a></li>
        <li><a href="#ztunnel-a-rules">检查 Ztunnel A 上的路由规则</a></li>
      </ul>
    </li>
    <li><a href="#ztunnel-a-outbound">Ztunnel A 上的出站流量路由</a>
      <ul>
        <li><a href="#ztunnel_outbound-listener">ztunnel_outbound 监听器</a></li>
        <li><a href="#sleep-集群">Sleep 集群</a></li>
        <li><a href="#sleep-endpoints">Sleep 集群的端点</a></li>
        <li><a href="#sleep-internal-upstream">通过 Envoy 内部监听器建立 HBONE 隧道</a></li>
        <li><a href="#sleep-tunnel-cluster">Sleep 集群的 HBONE 隧道端点</a></li>
      </ul>
    </li>
    <li><a href="#inbound">Inbound 流量劫持</a>
      <ul>
        <li><a href="#node-b-rules">检查节点 B 上的路由规则</a></li>
        <li><a href="#ztunnel-b-rules">检查 Ztunnel B Pod 上的路由规则</a></li>
      </ul>
    </li>
    <li><a href="#ztunnel-b-inbound">Ztunnel B 上的入站流量路由</a>
      <ul>
        <li><a href="#ztunnel_inbound-listener">ztunnel_inbound 监听器</a></li>
        <li><a href="#virtual_inbound-cluster">virtual_inbound 集群</a></li>
      </ul>
    </li>
    <li><a href="#summary">总结</a></li>
    <li><a href="#reference">参考</a></li>
  </ul>
</nav>
</details>

            
            <p>本文通过动手操作，带领读者一步步了解 Istio ambient 模式中的四层流量路径。如果你还不了解什么是 Ambient 模式，以下文章可以帮助你了解：</p>
<ul>
<li><a href="/blog/istio-ambient-mode/" title="关于 Istio 推出 Ambient 数据平面模式的看法">关于 Istio 推出 Ambient 数据平面模式的看法</a></li>
<li><a href="https://cloudnative.to/blog/introducing-ambient-mesh/" title="Istio 无 sidecar 代理数据平面 ambient 模式简介" target="_blank" rel="noopener">Istio 无 sidecar 代理数据平面 ambient 模式简介</a></li>
<li><a href="https://cloudnative.to/blog/ambient-security/" title="Istio 服务网格 ambient 模式安全详解" target="_blank" rel="noopener">Istio 服务网格 ambient 模式安全详解</a></li>
<li><a href="https://cloudnative.to/blog/what-is-ambient-mesh/" title="什么是 Ambient Mesh，它与 sidecar 模式有什么区别？" target="_blank" rel="noopener">什么是 Ambient Mesh，它与 sidecar 模式有什么区别？</a></li>
</ul>
<p>如果你想略过实际动手步骤，只是想知道 Ambient 模式中的四层流量路径，请看下面服务 A 的一个 Pod 访问不同节点上服务 B 的 Pod 的四层流量路径图。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/ambient-mesh-l4-traffic-path/ambient-mesh-l4-traffic-path.svg" data-img="/blog/ambient-mesh-l4-traffic-path/ambient-mesh-l4-traffic-path.svg" alt="image" data-caption="Ambient 模式中的四层流量路径">
        
      
    
  
  
  <figcaption>Ambient 模式中的四层流量路径</figcaption>
  
</figure>
<h2 id="principles">原理</h2>
<p>Ambient 模式使用 <strong>tproxy</strong> 和 <strong>HBONE</strong> 这两个关键技术实现透明流量劫持和路由的：</p>
<ul>
<li>使用 tproxy 将主机 Pod 中的流量劫持到 Ztunnel（Envoy Proxy）中，实现透明流量劫持；</li>
<li>使用 HBONE 建立在 Ztunnel 之间传递 TCP 数据流隧道；</li>
</ul>
<h3 id="what-is-tproxy">什么是 tproxy？</h3>
<p><code>tproxy</code> 是 Linux 内核自 2.2 版本以来支持的透明代理（Transparent proxy），其中的 t 代表 transparent，即透明。你需要在内核配置中启用 <code>NETFILTER_TPROXY</code> 和策略路由。通过 tproxy，Linux 内核就可以作为一个路由器，将数据包重定向到用户空间。详见 <a href="http://lxr.linux.no/linux&#43;v3.10/Documentation/networking/tproxy.txt" title="tproxy 文档" target="_blank" rel="noopener">tproxy 文档</a> 。</p>
<h3 id="what-is-hbone">什么是 HBONE？</h3>
<p>HBONE 是 HTTP-Based Overlay Network Environment 的缩写，是一种使用 HTTP 协议提供隧道能力的方法。客户端向 HTTP 代理服务器发送 HTTP CONNECT 请求（其中包含了目的地址）以建立隧道，代理服务器代表客户端与目的地建立 TCP 连接，然后客户端就可以通过代理服务器透明的传输 TCP 数据流到目的服务器。在 Ambient 模式中，Ztunnel（其中的 Envoy）实际上是充当了透明代理，它使用 <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/other_features/internal_listener" title="Envoy Internal Listener" target="_blank" rel="noopener">Envoy Internal Listener</a> 来接收 HTTP CONNECT 请求和传递 TCP 流给上游集群。</p>
<h2 id="environment">环境说明</h2>
<p>在开始动手操作之前，需要先说明一下笔者的演示环境，本文中对应的对象名称：</p>
<table>
<thead>
<tr>
<th>代号</th>
<th>名称</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务 A Pod</td>
<td>sleep-5644bdc767-2dfg7</td>
<td>10.4.4.19</td>
</tr>
<tr>
<td>服务 B Pod</td>
<td>productpage-v1-5586c4d4ff-qxz9f</td>
<td>10.4.3.20</td>
</tr>
<tr>
<td>Ztunnel A Pod</td>
<td>ztunnel-rts54</td>
<td>10.4.4.18</td>
</tr>
<tr>
<td>Ztunnel B Pod</td>
<td>ztunnel-z4qmh</td>
<td>10.4.3.14</td>
</tr>
<tr>
<td>节点 A</td>
<td>gke-jimmy-cluster-default-pool-d5041909-d10i</td>
<td>10.168.15.222</td>
</tr>
<tr>
<td>节点 B</td>
<td>gke-jimmy-cluster-default-pool-d5041909-c1da</td>
<td>10.168.15.224</td>
</tr>
<tr>
<td>服务 B Cluster</td>
<td>productpage</td>
<td>10.8.14.226</td>
</tr>
</tbody>
</table>
<p>注意：因为这些名称将在后续的命令行中用到，文中将使用代称，以便你在自己的环境中实验。</p>
<p>笔者在 GKE 中安装了 Ambient 模式的 Istio，请参考<a href="/blog/istio-ambient-mode/#setup" title="该步骤">该步骤</a>安装，注意不要安装 Gateway，以免启用 L7 功能，否则流量路径将于 L4 流量不同。</p>
<p>下面我们将动手实验，深入探究 <code>sleep</code> 服务的 Pod 访问不同节点上 <code>productpage</code> 服务的 Pod 的四层流量路径。我们将分别检视 Pod 的 outbound 和 inbound 流量。</p>
<h2 id="outbound">Outbound 流量劫持</h2>
<p>Ambient mesh 的 pod 出站流量的透明流量劫持流程如下：</p>
<ol>
<li>Istio CNI 在节点上创建 <code>istioout</code> 网卡和 iptables 规则，将 Ambient mesh 中的 Pod IP 加入 <a href="https://ipset.netfilter.org/" title="IP 集" target="_blank" rel="noopener">IP 集</a>，并通过 netfilter <code>nfmark</code> 标记和路由规则，将 Ambient mesh 中的出站流量通过 Geneve 隧道透明劫持到 <code>pistioout</code> 虚拟网卡；</li>
<li>ztunnel 中的 init 容器创建 iptables 规则，将 <code>pistioout</code> 网卡中的所有流量转发到 ztunnel 中的 Envoy 代理的 15001 端口；</li>
<li>Envoy 对数据包进行处理，并与上游端点建立 HBONE 隧道（HTTP CONNECT），将数据包转发到上游。</li>
</ol>
<h3 id="node-a-rules">检查节点 A 上的路由规则</h3>
<p>登录到服务 A 所在的节点 A，使用 <code>iptables-save</code> 查看规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="hl"><span class="lnt"> 3
</span></span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="hl"><span class="lnt">35
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span><span class="line hl"><span class="cl">-A PREROUTING -j ztunnel-PREROUTING
</span></span><span class="line hl"><span class="cl">-A PREROUTING -m comment --comment <span class="s2">&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</span></span><span class="line"><span class="cl">-A ztunnel-POSTROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span><span class="line hl"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span><span class="line"><span class="cl">*mangle
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span><span class="line"><span class="cl">-A PREROUTING -j ztunnel-PREROUTING
</span></span><span class="line"><span class="cl">-A INPUT -j ztunnel-INPUT
</span></span><span class="line"><span class="cl">-A FORWARD -j ztunnel-FORWARD
</span></span><span class="line"><span class="cl">-A OUTPUT -j ztunnel-OUTPUT
</span></span><span class="line"><span class="cl">-A OUTPUT -s 169.254.169.254/32 -j DROP
</span></span><span class="line"><span class="cl">-A POSTROUTING -j ztunnel-POSTROUTING
</span></span><span class="line"><span class="cl">-A ztunnel-FORWARD -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span class="line"><span class="cl">-A ztunnel-FORWARD -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span class="line"><span class="cl">-A ztunnel-INPUT -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span class="line"><span class="cl">-A ztunnel-INPUT -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span class="line"><span class="cl">-A ztunnel-OUTPUT -s 10.4.4.1/32 -j MARK --set-xmark 0x220/0xffffffff
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioin -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioin -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioout -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i istioout -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p udp -m udp --dport <span class="m">6081</span> -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m connmark --mark 0x220/0x220 -j MARK --set-xmark 0x200/0x200
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING ! -i veth300a1d80 -m connmark --mark 0x210/0x210 -j MARK --set-xmark 0x40/0x40
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x40/0x40 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING ! -s 10.4.4.18/32 -i veth300a1d80 -j MARK --set-xmark 0x210/0x210
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -i veth300a1d80 -j MARK --set-xmark 0x220/0x220
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p udp -j MARK --set-xmark 0x220/0x220
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line hl"><span class="cl">-A ztunnel-PREROUTING -p tcp -m <span class="nb">set</span> --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100/0x100</span></span></code></pre></td></tr></table>
</div>
</div>
<p>iptables 规则说明：</p>
<ul>
<li>第 3 行：PREROUTING 链是最先运行的，所有数据包将先进入 <code>ztunnel-PREROUTING</code> 链；</li>
<li>第 4 行：将数据包发往 <code>KUBE-SERVICES</code> 链，在那里将 Kubernetes Service 的 Cluster IP 进行 DNAT 转换为 Pod IP；</li>
<li>第 6 行：带有 <code>0x100/0x100</code> 标记的数据包通过 PREROUTING 链，不再经过 <code>KUBE-SERVICES</code> 链；</li>
<li>第 35 行：这是添加到 <code>ztunnel-PREROUTING</code> 链上的最后一条规则，进入 <code>ztunnel-PREROUTING</code> 链中的在 <code>ztunnel-pods-ips</code> IP 集中的所有 TCP 数据包都会被打上 <code>0x100/0x100</code> 的标记，它将覆盖前面的所有标记；</li>
</ul>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 iptables 设置 mark 和 xmark 标记
  </div>
  
  <div class="alert-note px-2">
    <p><code>MARK</code> 这个扩展目标可以用来给数据包打标记，标记分两种：一种是用于标记链接的 <code>ctmark</code>，一种是用于标记数据包的 <code>nfmark</code> 。<code>nfmark</code>占四个字节共 32 位，我们可以把它看成是一个长度为 32 位的无符号整数，一般用 16 进制来表示。</p>
<p>Mark 的设置一共有五个选项，分别是 <code>--set-xmark</code>、<code>--set-mark</code>、<code>--and-mark</code>、<code>--and-mark</code>、<code>--or-mark</code> 和 <code>--xor-mark</code>。在本文用到了前两种，下面将分别为大家介绍。</p>
<p><strong><code>--set-xmark value[/mask]</code></strong></p>
<p>上面的 <code>value</code> 和掩码 <code>mask</code> 都是 32 位无符号整数，一般用 16 进制表示。内核设置数据包 nfmark 值的流程分为两步：</p>
<ol>
<li>首先，内核会先用 mask 预处理数据包原来的 nfmark，处理方法是：如果 mask 的第 N 位（二进制）为 1，则将数据包的 nfmark 第的 N 位（二进制）清零（Zero out） ，如果 mask 的第 N 位为 0，那么数据包的 nfmark 位保持不变</li>
<li>再用上面预处理后的 nfmark 和 value 做异或运算，得到数据包最后的 nfmark 值。</li>
</ol>
<p>举个例子：假设我们设置了 <code>--set-xmark 0x4000/0xffffffff</code>，掩码为 <code>0xffffffff</code>，掩码表示为二进制的话 32 位每一位都是 <code>1</code>，那么内核首先会将数据包原来的 <code>nfmark</code> 所有的位都清零（异或运算，相当于是先把 <code>nfmark</code> 置 0），然后再和 value 做异或操作，那么得到的最后的 <code>nfmark</code> 值就是 <code>0x4000</code>。所以，数据包经过这条规则后，它的 nfmark 值就是 <code>0x4000</code>。</p>
<p>上面的掩码 <code>mask</code> 是个可选项，如果没有设置的话，默认为 <code>0xffffffff</code>。</p>
<p>根据上面的规则，省略 <code>mask</code> 的值或者将 <code>mask</code> 和 <code>value</code> 的值设置成一样可以快速设置数据包的 <code>nfmark</code> 值为 <code>value</code>。读者可以自己推导一下：<code>value XOR 0xFFFFFFFF XOR value =value</code>，<code>value XOR value XOR value = value</code>。</p>
<p><strong><code>--set-mark value[/mask]</code></strong></p>
<p>设置步骤与上文类似。第一步预处理也是将原来的 <code>nfmark</code> 与 mask 进行异或运算，第二步不同，该方法是将预处理的 nfmark 和 value 做或（OR）运算。</p>
<p>根据上面的规则，省略 <code>mask</code> 的值，或者将 <code>mask</code> 与 <code>value</code> 值设置成一样可以快速设置数据包的 <code>nfmark</code> 值为 <code>value</code>。读者可以自己推导一下：<code>value XOR 0xFFFFFFFF OR value = value</code>，<code>0 OR value = value</code>）。</p>
<p>查看 <a href="https://ipset.netfilter.org/iptables-extensions.man.html#lbDD" title="netfilter 文档" target="_blank" rel="noopener">netfilter 文档</a> 了解详情。</p>

  </div>
</div>

<p>通过执行以上 iptables 规则，可以确保 Ambient Mesh 仅拦截 <code>ztunnel-pods-ips</code> IP 集 Pod 中的数据包并给数据包打上 <code>0x100/0x100</code> 标记（<code>nfmark</code>，格式为 <code>值/掩码</code>，值和掩码都是 32 位的二进制整数，），而不影响其他 Pod。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 ztunnel-pods-ips IP 集
  </div>
  
  <div class="alert-note px-2">
    <code>ztunnel-pods-ips</code> 是由 Istio CNI 创建的 <a href="https://ipset.netfilter.org/" title="IP 集（IP Set）" target="_blank" rel="noopener">IP 集（IP Set）</a>，这里面保存着该节点上 Ambient Mesh 中的所有 Pod 的 IP 地址。IP 集是 Linux 内核中的一个框架，可由 <a href="https://ipset.netfilter.org/ipset.man.html" title="ipset" target="_blank" rel="noopener">ipset</a> 实用程序管理。IP 集可以存储不同类型的数据，例如 IP 地址、网络、（TCP/UDP）端口号、MAC 地址、接口名称或它们的组合，从而确保在条目与集合匹配时具有闪电般的速度。
  </div>
</div>

<details class="spoiler" id="spoiler-3">
  <summary>用 <code>iptables -t nat -L</code> 按顺序查看 iptables 规则，将可以更明显的看到路由路径。</summary>
  <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables -t nat -L
</span></span><span class="line"><span class="cl">Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="c1"># 数据包首先进入 ztunnel-PREROUTING 链处理</span>
</span></span><span class="line"><span class="cl">ztunnel-PREROUTING  all  --  anywhere             anywhere
</span></span><span class="line"><span class="cl"><span class="c1"># 然后进入 KUBE-SERVICES 链处理</span>
</span></span><span class="line"><span class="cl">KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain POSTROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ztunnel-POSTROUTING  all  --  anywhere             anywhere            
</span></span><span class="line"><span class="cl">KUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */
</span></span><span class="line"><span class="cl">IP-MASQ    all  --  anywhere             anywhere             /* ip-masq: ensure nat POSTROUTING directs all non-LOCAL destination traffic to our custom IP-MASQ chain */ ADDRTYPE match dst-type !LOCAL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/* Omit KUBE-SVC chains */
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain ztunnel-POSTROUTING <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     all  --  anywhere             anywhere             mark match 0x100/0x100
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain ztunnel-PREROUTING <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination   
</span></span><span class="line"><span class="cl"><span class="c1"># 通过所有被打上 0x100/0x100 标记的数据包</span>
</span></span><span class="line"><span class="cl">ACCEPT     all  --  anywhere             anywhere             mark match 0x100/0x100
</span></span></code></pre></div></p>
</details>

<p>我们再查看一下该节点的路由规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip rule
</span></span><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">100:    from all fwmark 0x200/0x200 goto <span class="m">32766</span>
</span></span><span class="line"><span class="cl">101:    from all fwmark 0x100/0x100 lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">102:    from all fwmark 0x40/0x40 lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">103:    from all lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>路由表将按顺序执行，第一列表示的是路由表的优先级，第二列表示要查找或跳转的路由表。你会看到所有带有 <code>0x100/0x100</code> 标记的数据包将查找 101 路由表。我们再查看一下该路由表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">101</span>
</span></span><span class="line"><span class="cl">default via 192.168.127.2 dev istioout 
</span></span><span class="line"><span class="cl">10.4.4.18 dev veth52b75946 scope link 
</span></span></code></pre></div><p>你会看到 <code>101</code> 路由表中带有关键字 <code>via</code> ，这表示数据包将通过网关传输，查看 <a href="http://linux-ip.net/html/tools-ip-route.html#tools-ip-route-show" title="ip route 命令的用法" target="_blank" rel="noopener">ip route 命令的用法</a>。所有数据包被通过 <code>istioout</code> 网卡发送到网关（IP 是 <code>192.168.127.2</code>）。另一行表示是当前节点上 ztunnel pod 的路由链路。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 101 路由表
  </div>
  
  <div class="alert-note px-2">
    <p>所谓路由表（Routing Table），指的是路由器或者其他互联网网络设备上存储的表，该表中存有到达特定网络终端的路径。路由器的主要工作就是为经过路由器的每个数据包寻找一条最佳的传输路径，并将该数据有效地传送到目的站点。为了完成这项工作，在路由器中保存着各种传输路径的相关数据，供路由选择时使用，表中包含的信息决定了数据转发的策略。路由表根据其建立的方法，可以分为<strong>动态路由表</strong>和<strong>静态路由表</strong>。</p>
<p>101 路由表是由 Istio CNI 创建的，它的作用是将带有 <code>0x100/0x00</code> fwmark 的数据包转发到 ztunnel 中。</p>
<p>在 Linux 系统中，用户可以自定义编号 1 到 252 的路由表，Linux 系统维护了 4 个路由表：</p>
<ul>
<li>0：系统保留表</li>
<li>253：defulte 表，没特别指定的默认路由都放在改表</li>
<li>254：main 表，没指明路由表的所有路由放在该表，默认表，我们使用 <code>ip route list</code> 或 <code>route -n</code> 或 <code>netstat -rn</code> 查看的路由记录即为 main 表中的记录</li>
<li>255：locale 表，保存本地接口地址，广播地址、NAT 地址 由系统维护，用户不得更改</li>
</ul>

  </div>
</div>

<p>我们再查看一下 <code>istioout</code> 网卡的详细信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d addr show istioout
</span></span><span class="line"><span class="cl">24: istioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether 62:59:1b:ad:79:01 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1001</span> remote 10.4.4.18 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span>
</span></span><span class="line hl"><span class="cl">    inet 192.168.127.1/30 brd 192.168.127.3 scope global istioout
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::6059:1bff:fead:7901/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Pod A 中的 <code>istioout</code> 网卡通过 Geneve tunnel 与 ztunnel A 中的 <code>pstioout</code> 网卡连通。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 istioout 网卡
  </div>
  
  <div class="alert-note px-2">
    <code>istioout</code> 是一个 <a href="https://datatracker.ietf.org/doc/html/draft-gross-geneve-00" title="Geneve（Generic Network Virtualization Encapsulation）" target="_blank" rel="noopener">Geneve（Generic Network Virtualization Encapsulation）</a>类型的虚拟网卡，它的 IP 是 <code>192.168.127.1</code>，远端是 <code>10.4.2.19</code>（节点 A 上的 ztunnel Pod 的 IP），网关是 <code>192.168.127.2</code>（节点 A 上 ztunnel Pod 中 <code>pistioout</code> 网卡的 IP，在下文会看到）。
  </div>
</div>

<h3 id="ztunnel-a-rules">检查 Ztunnel A 上的路由规则</h3>
<p>进入 Ztunnel A Pod，使用 <code>ip -d a</code> 命令检查它的网卡信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="hl"><span class="lnt">12
</span></span><span class="hl"><span class="lnt">13
</span></span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d a
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity <span class="m">0</span> minmtu <span class="m">0</span> maxmtu <span class="m">0</span> numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0@if16: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1460</span> qdisc noqueue state UP group default 
</span></span><span class="line"><span class="cl">    link/ether 06:3e:d1:5d:95:16 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span> promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    veth numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line"><span class="cl">    inet 10.4.2.1/24 brd 10.4.4.255 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line hl"><span class="cl">3: pistioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line hl"><span class="cl">    link/ether 06:18:ee:29:7e:e4 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1000</span> remote 10.4.2.1 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.126.2/30 scope global pistioin
</span></span><span class="line hl"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line hl"><span class="cl">4: pistioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line hl"><span class="cl">    link/ether aa:40:40:7c:07:b2 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1001</span> remote 10.4.2.1 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.127.2/30 scope global pistioout
</span></span><span class="line hl"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>你将发现其中有两个网卡：</p>
<ul>
<li><code>pistioin</code> ：IP 为 <code>192.168.126.2</code></li>
<li><code>pistioout</code>：IP 为 <code>192.168.127.2</code></li>
</ul>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 pistioin 和 pistioout 网卡
  </div>
  
  <div class="alert-note px-2">
    这两个网卡都是由 ztunnel 中的 init 容器创建的 Geneve 类型的虚拟网卡，其 IP 地址也是固定的，如果你查看 ztunnel 的 YAML 配置将发现其中的网卡创建命令，在此我们按下不表，因为 Ambient 模式还在开发初期，这些启动命令未来可能有很大变化，感兴趣的读者可以自行查阅。
  </div>
</div>

<p>自 Pod A 的流量进入 ztunnel 之后，如何对流量进行处理呢？答案是 iptables，查看 ztunnel A 中的 iptables 规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span><span class="line"><span class="cl">*mangle
</span></span><span class="line"><span class="cl">:PREROUTING ACCEPT <span class="o">[</span>185880:96984381<span class="o">]</span>
</span></span><span class="line"><span class="cl">:INPUT ACCEPT <span class="o">[</span>185886:96984813<span class="o">]</span>
</span></span><span class="line"><span class="cl">:FORWARD ACCEPT <span class="o">[</span>0:0<span class="o">]</span>
</span></span><span class="line"><span class="cl">:OUTPUT ACCEPT <span class="o">[</span>167491:24099839<span class="o">]</span>
</span></span><span class="line"><span class="cl">:POSTROUTING ACCEPT <span class="o">[</span>167491:24099839<span class="o">]</span>
</span></span><span class="line"><span class="cl">-A PREROUTING -j LOG --log-prefix <span class="s2">&#34;mangle pre [ ztunnel-rts54] &#34;</span>
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -m tcp --dport <span class="m">15008</span> -j TPROXY --on-port <span class="m">15008</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line hl"><span class="cl">-A PREROUTING -i pistioout -p tcp -j TPROXY --on-port <span class="m">15001</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port <span class="m">15006</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">/* 省略 */</span></span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到 ztunnel A 中的所有发往 <code>pistioin</code> 网卡的 TCP 流量透明转发到 <code>15001</code> 端口（Envoy 的 outbound 端口），并打上了 <code>0x400/0xfff</code> 的标记。这个标记可以保证数据包发往正确的网卡。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 tproxy
  </div>
  
  <div class="alert-note px-2">
    <code>tproxy</code> 是 Linux 内核自 2.2 版本以来支持的透明代理（Transparent proxy），其中的 t 代表 transparent，即透明。你需要在内核配置中启用 <code>NETFILTER_TPROXY</code> 和策略路由。通过 tproxy，Linux 内核就可以作为一个路由器，将数据包重定向到用户空间。详见 <a href="http://lxr.linux.no/linux&#43;v3.10/Documentation/networking/tproxy.txt" title="tproxy 文档" target="_blank" rel="noopener">tproxy 文档</a>。
  </div>
</div>

<p>查看 Ztunnel A 中的路由表。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip rule
</span></span><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">20000:  from all fwmark 0x400/0xfff lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">20001:  from all fwmark 0x401/0xfff lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">20002:  from all fwmark 0x402/0xfff lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">20003:  from all fwmark 0x4d3/0xfff lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>你会看到所有标记 <code>0x400/0xfff</code> 的数据包应用 101 路由表，我们查看该路由表详情：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="nb">local</span> default dev lo scope host 
</span></span></code></pre></div><p>你会看到这是一条本地路由，数据包发送到本地的回环网卡，即 <code>127.0.0.1</code>。</p>
<p>以上就是 Pod 中出站流量的透明劫持过程。</p>
<h2 id="ztunnel-a-outbound">Ztunnel A 上的出站流量路由</h2>
<p>出站流量在被劫持到 Ztunnel 上，进入 Envoy 的 15001 端口处理。下面我们来查看 Ztunnel 如何路由出站流量。</p>
<p>注意：Ztunnel 中的 Envoy 过滤器规则与 Sidecar 模式中的 Envoy 过滤器规则完全不同，我们不使用 <code>istioctl proxy-config</code> 命令来检视 Listener、Cluster、Endpoint 等配置，而是直接导出 ztunnel 中的 Envoy 完整配置。</p>
<p>我们直接在自己的本地机器上远程获取 ztunnel A 中的 Envoy 配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -n istio-system ztunnel-hptxk -c istio-proxy -- curl <span class="s2">&#34;127.0.0.1:15000/config_dump?include_eds&#34;</span>&gt;ztunnel-a-all-include-eds.json
</span></span></code></pre></div><p>注意：不要使用 <code>istioctl proxy-config all ztunnel-rts54 -n istio-system</code> 命令来获取 Envoy 配置，因为这样获取的配置中不包含 EDS 部分。导出的 Json 文件将有上万行，为了便于阅读，建议使用 <a href="https://github.com/antonmedv/fx" title="fx" target="_blank" rel="noopener">fx</a> 或其他工具来解析该文件。</p>
<h3 id="ztunnel_outbound-listener">ztunnel_outbound 监听器</h3>
<p>在这个 Envoy 配置中包含了该节点上的所有 Pod 访问的流量规则配置，查看 <code>ztunnel_outbound</code> Listener 部分配置（因配置太多，省略部分内容）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="hl"><span class="lnt">  7
</span></span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="hl"><span class="lnt"> 10
</span></span><span class="hl"><span class="lnt"> 11
</span></span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="hl"><span class="lnt"> 14
</span></span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="hl"><span class="lnt"> 43
</span></span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="hl"><span class="lnt"> 59
</span></span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="hl"><span class="lnt"> 62
</span></span><span class="lnt"> 63
</span><span class="hl"><span class="lnt"> 64
</span></span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="hl"><span class="lnt"> 69
</span></span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="hl"><span class="lnt"> 76
</span></span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="hl"><span class="lnt"> 82
</span></span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="hl"><span class="lnt"> 85
</span></span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="hl"><span class="lnt"> 88
</span></span><span class="hl"><span class="lnt"> 89
</span></span><span class="hl"><span class="lnt"> 90
</span></span><span class="hl"><span class="lnt"> 91
</span></span><span class="hl"><span class="lnt"> 92
</span></span><span class="hl"><span class="lnt"> 93
</span></span><span class="hl"><span class="lnt"> 94
</span></span><span class="hl"><span class="lnt"> 95
</span></span><span class="hl"><span class="lnt"> 96
</span></span><span class="hl"><span class="lnt"> 97
</span></span><span class="hl"><span class="lnt"> 98
</span></span><span class="hl"><span class="lnt"> 99
</span></span><span class="hl"><span class="lnt">100
</span></span><span class="hl"><span class="lnt">101
</span></span><span class="hl"><span class="lnt">102
</span></span><span class="hl"><span class="lnt">103
</span></span><span class="hl"><span class="lnt">104
</span></span><span class="hl"><span class="lnt">105
</span></span><span class="hl"><span class="lnt">106
</span></span><span class="hl"><span class="lnt">107
</span></span><span class="hl"><span class="lnt">108
</span></span><span class="hl"><span class="lnt">109
</span></span><span class="hl"><span class="lnt">110
</span></span><span class="hl"><span class="lnt">111
</span></span><span class="hl"><span class="lnt">112
</span></span><span class="hl"><span class="lnt">113
</span></span><span class="hl"><span class="lnt">114
</span></span><span class="hl"><span class="lnt">115
</span></span><span class="hl"><span class="lnt">116
</span></span><span class="hl"><span class="lnt">117
</span></span><span class="hl"><span class="lnt">118
</span></span><span class="hl"><span class="lnt">119
</span></span><span class="hl"><span class="lnt">120
</span></span><span class="hl"><span class="lnt">121
</span></span><span class="hl"><span class="lnt">122
</span></span><span class="hl"><span class="lnt">123
</span></span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:10:40Z/13&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_outbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15001</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">},</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.original_dst&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.original_src&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.original_src.v3.OriginalSrc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mark&#34;</span><span class="p">:</span> <span class="mi">1234</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.workload_metadata&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;config_discovery&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;30s&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type_urls&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;type.googleapis.com/istio.telemetry.workloadmetadata.v1.WorkloadMetadataResources&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;transparent&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;socket_options&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Set socket mark to packets coming back from outbound listener&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;36&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;int_value&#34;</span><span class="p">:</span> <span class="s2">&#34;1025&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;default_filter_chain&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span><span class="err">...</span><span class="p">],</span> <span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chain_matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;15001&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;BlackHoleCluster&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;on_no_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;source-ip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.SourceIPInput&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.168.15.222&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;10.4.4.19&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ip&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationIPInput&#34;</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;10.8.4.226&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">               <span class="nt">&#34;matcher&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;matcher_tree&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                 <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput&#34;</span>
</span></span><span class="line hl"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                 <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">                 <span class="nt">&#34;exact_match_map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                  <span class="nt">&#34;map&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                   <span class="nt">&#34;9080&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                    <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                      <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span>
</span></span><span class="line hl"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                   <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                 <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">                <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="err">{...</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">             <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.4.4.7&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;10.4.4.11&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;on_no_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PassthroughFilterChain&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/google.protobuf.StringValue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;PassthroughFilterChain&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:33:10.485Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 10、11、59、62、64、69、76、82、85 行：Envoy 监听 15001 端口，处理内核中使用 tproxy 转发的流量；对于目的地是 15001 端口的数据包直接抛弃，对于目的地是其他端口的流量再根据源 IP 地址匹配决定数据包去向；</li>
<li>第 43 行：使用 <code>IP_TRANSPARENT</code> 套接字选项，开启 tproxy 透明代理，转发目的地非 ztunnel IP 的流量包；</li>
<li>第 88 到 123 行：根据源 IP（<code>10.4.4.19</code> 是 Pod A 的 IP）、目的 IP（<code>10.8.14.226</code> 是服务 B 的 Cluster IP）和端口（9080）规则匹配，数据包将被发往 <code>spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal</code> 集群。</li>
</ul>
<h3 id="sleep-集群">Sleep 集群</h3>
<p>我们再查看一下该集群的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="hl"><span class="lnt"> 5
</span></span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="hl"><span class="lnt">18
</span></span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="hl"><span class="lnt">31
</span></span><span class="hl"><span class="lnt">32
</span></span><span class="hl"><span class="lnt">33
</span></span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06Z/63&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;EDS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;eds_cluster_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;eds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;transport_socket_matches&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;internal_upstream&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.internal_upstream&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.internal_upstream.v3.InternalUpstreamTransport&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;passthrough_metadata&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tunnel&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-disabled&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06.619Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 6 行：该 Cluster 配置使用 EDS 获取端点</li>
<li>第 18 行：对所有具有 <code>tunnel: h2</code> 元数据的字节流应用 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/internal_upstream/v3/internal_upstream.proto#envoy-v3-api-msg-extensions-transport-sockets-internal-upstream-v3-internalupstreamtransport" title="&lt;code&gt;InternalUpstreamTransport&lt;/code&gt;" target="_blank" rel="noopener"><code>InternalUpstreamTransport</code></a>，用于内部地址，定义位于同一代理实例中的环回用户空间 socket。除了常规字节流之外，该扩展还允许跨用户空间 socket 传递额外的结构化状态（<code>passthrough_metadata</code>）。目的是促进下游过滤器和上游内部连接之间的通信。与上游连接共享的所有过滤器状态对象也通过此传输 socket 与下游内部连接共享。</li>
<li>第 23 到 37 行：向上游传递的结构化数据；</li>
</ul>
<h3 id="sleep-endpoints">Sleep 集群的端点</h3>
<p>我们再检查下 EDS，你会发现在众多的 <code>endpoint_config</code> 中有这样一条：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="hl"><span class="lnt">13
</span></span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;endpoint_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;locality&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lb_endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;envoy_internal_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;server_listener_name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;endpoint_id&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:9080&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">},</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;health_check_config&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;health_status&#34;</span><span class="p">:</span> <span class="s2">&#34;HEALTHY&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;filter_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;envoy.transport_socket_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;tunnel&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:15008&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20:9080&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;load_balancing_weight&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;policy&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;overprovisioning_factor&#34;</span><span class="p">:</span> <span class="mi">140</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 4 行：截止 2022 年 11 月 14 日，实际在导出 Envoy 配置的时候并没有该字段，但是理应有这个字段，否则无法判断 Endpoint 属于哪个 Cluster；</li>
<li>第 13 行：该端点的地址是一个 <code>envoy_internal_address</code>，Envoy 内部监听器 <code>outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep</code>；</li>
<li>第 20 - 30 行：定义过滤器元数据，使用 HBONE 隧道传递给 Envoy 内部监听器；</li>
</ul>



<div class="alert alert-warning-container">
  
  <div class="alert-warning-title px-2 py-2">
    关于 endpoint_config 中未显示 cluster_name 字段的问题
  </div>
  
  <div class="alert-warning px-2">
    这里的 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint.proto" title="&lt;code&gt;endpoint_config&lt;/code&gt;" target="_blank" rel="noopener"><code>endpoint_config</code></a> 中缺少了必选的 <code>cluster_name</code> 字段，这可能是 Ambient 模式的一个 bug 导致了在导出 Envoy 的配置时缺少了该字段。我在 GItHub 上创建了一个 Issue 来追踪这个问题，详见 <a href="https://github.com/istio/istio/issues/42022" title="Istio Issue-42022" target="_blank" rel="noopener">Istio Issue-42022</a>。
  </div>
</div>

<h3 id="sleep-internal-upstream">通过 Envoy 内部监听器建立 HBONE 隧道</h3>
<p>我们再看下这个监听器 <code>outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="hl"><span class="lnt">40
</span></span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06Z/63&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.tcp_proxy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">},</span> <span class="err">...</span><span class="p">],</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;tunneling_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;%DYNAMIC_METADATA(tunnel:destination)%&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;headers_to_add&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;header&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;x-envoy-original-dst-host&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;%DYNAMIC_METADATA([\&#34;tunnel\&#34;, \&#34;destination\&#34;])%&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;set_dst_address&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/xds.type.v3.TypedStruct&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;type_url&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/istio.set_internal_dst_address.v1.Config&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;internal_listener&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-08T06:40:06.750Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 14 行：数据包将被转发到 <code>outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep</code> 集群；</li>
<li>第 18 - 28 行： <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/tcp_proxy/v3/tcp_proxy.proto#envoy-v3-api-msg-extensions-filters-network-tcp-proxy-v3-tcpproxy-tunnelingconfig" title="&lt;code&gt;tunneling_config&lt;/code&gt;" target="_blank" rel="noopener"><code>tunneling_config</code></a> ，用来配置上游 HTTP CONNECT 隧道。另外该监听器中的 <code>TcpProxy</code> 过滤器将流量传给上游 <code>outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep</code> 集群。TCP 过滤器上设置了 HTTP CONNECT 隧道（承载发送到 <code>10.4.3.20:9080</code> 的流量），供 <code>productpage</code> 所在节点的 ztunnel 使用。有多少个端点，就会创建多少条隧道。HTTP 隧道是 Ambient 组件之间安全通信的承载协议。同时在隧道中的数据包添加了 <code>x-envoy-original-dst-host</code> header，根据上一步 EDS 中选择的端点的 <code>metadata</code> 里的参数设置目的地址。前面 EDS  选择的端点是 <code>10.4.3.20:9080</code> ，那么这里的 tunnel 监听器就会 header 的值设置为 <code>10.4.3.20:9080</code>，请留意这个 header，它会在隧道的另一端被用到；</li>
<li>第 40 行：监听器中首先执行监听器过滤器，<code>set_dst_address</code> 过滤器将上游地址设置为下游的目的地址。</li>
</ul>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 HBONE 隧道
  </div>
  
  <div class="alert-note px-2">
    HBONE 是 HTTP-Based Overlay Network Environment 的缩写，是一种使用 HTTP 协议提供隧道能力的方法。客户端向 HTTP 代理服务器发送 HTTP CONNECT 请求（其中包含了目的地址）以建立隧道，代理服务器代表客户端与目的地建立 TCP 连接，然后客户端就可以通过代理服务器透明的传输 TCP 数据流到目的服务器。在 Ambient 模式中，Ztunnel（其中的 Envoy）实际上是充当了透明代理，它使用 <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/other_features/internal_listener" title="Envoy Internal Listener" target="_blank" rel="noopener">Envoy Internal Listener</a> 来接收 HTTP CONNECT 请求和传递 TCP 流给上游集群。
  </div>
</div>

<h3 id="sleep-tunnel-cluster">Sleep 集群的 HBONE 隧道端点</h3>
<p>我们再查看一下 <code>outbound_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep</code> 集群的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="hl"><span class="lnt">24
</span></span><span class="hl"><span class="lnt">25
</span></span><span class="hl"><span class="lnt">26
</span></span><span class="hl"><span class="lnt">27
</span></span><span class="hl"><span class="lnt">28
</span></span><span class="hl"><span class="lnt">29
</span></span><span class="hl"><span class="lnt">30
</span></span><span class="hl"><span class="lnt">31
</span></span><span class="hl"><span class="lnt">32
</span></span><span class="hl"><span class="lnt">33
</span></span><span class="hl"><span class="lnt">34
</span></span><span class="hl"><span class="lnt">35
</span></span><span class="hl"><span class="lnt">36
</span></span><span class="hl"><span class="lnt">37
</span></span><span class="hl"><span class="lnt">38
</span></span><span class="hl"><span class="lnt">39
</span></span><span class="hl"><span class="lnt">40
</span></span><span class="hl"><span class="lnt">41
</span></span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="hl"><span class="lnt">45
</span></span><span class="hl"><span class="lnt">46
</span></span><span class="hl"><span class="lnt">47
</span></span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:30:10Z/37&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_pod_tunnel_clus_spiffe://cluster.local/ns/default/sa/sleep&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ORIGINAL_DST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;2s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;lb_policy&#34;</span><span class="p">:</span> <span class="s2">&#34;CLUSTER_PROVIDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;cleanup_interval&#34;</span><span class="p">:</span> <span class="s2">&#34;60s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;h2&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/default/sa/sleep~sleep-5644bdc767-2dfg7~85c8c34e-7ae3-4d29-9582-0819e2b10c69&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">       <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;original_dst_lb_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;upstream_port_override&#34;</span><span class="p">:</span> <span class="mi">15008</span>
</span></span><span class="line hl"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;typed_extension_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;explicit_http_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;http2_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;allow_connect&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:30:10.754Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 6 行：该集群的类型是 <code>ORIGINAL_DST</code>，即前文中 EDS 获取到的地址 <code>10.4.3.20:9080</code>；</li>
<li>第 22 - 41 行：配置了上游的 TLS 证书；</li>
<li>第 45 - 48 行：将上游端口修改为 15008；</li>
</ul>
<p>以上就是使用 tproxy 和 HBONE 隧道实现的出站流量透明劫持的全过程。</p>
<h2 id="inbound">Inbound 流量劫持</h2>
<p>节点 B 接收节点 A 对 <code>10.4.3.20:15008</code> 的请求。Ambient 模式的入站流量劫持与出站流量类似，同样使用 tproxy 和 HBONE 实现透明流量劫持。</p>
<p>Ambient mesh 的 pod 入站流量的透明流量劫持流程如下：</p>
<ol>
<li>Istio CNI 在节点上创建 <code>istioin</code> 网卡和 iptables 规则，将 Ambient mesh 中的 Pod IP 加入 IP 集，并通过 netfilter <code>nfmark</code> 标记和路由规则，将 Ambient mesh 中的出站流量通过 Geneve 隧道透明劫持到 <code>pistioin</code> 虚拟机网卡；</li>
<li>ztunnel 中的 init 容器创建 iptables 规则，将 <code>pistioin</code> 网卡中的所有流量转发到 ztunnel 中的 Envoy 代理的 15008 端口；</li>
<li>Envoy 对数据包进行处理后转发给 Pod B。</li>
</ol>
<p>因为操作步骤与上文中的检查出站流量时相同，因此下文将省略部分输出。</p>
<h3 id="node-b-rules">检查节点 B 上的路由规则</h3>
<p>登录到服务 B 所在的节点 B，查看节点上的 iptables：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ iptables-save
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span class="line"><span class="cl">-A ztunnel-PREROUTING -p tcp -m <span class="nb">set</span> --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100/0x100
</span></span><span class="line"><span class="cl">/* 省略 */
</span></span></code></pre></div><p>你将看到在前文中提到的给所有 <code>ztunnel-pods-ips</code> IP 集中 Pod 发送的数据包打上 <code>0x100/0x100</code> 标记的上一条命令：给所有数据包打上 <code>0x200/0x200</code> 标记，然后继续执行 iptables。</p>
<p>查看节点 B 上的路由表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:      from all lookup <span class="nb">local</span>
</span></span><span class="line"><span class="cl">100:    from all fwmark 0x200/0x200 goto <span class="m">32766</span>
</span></span><span class="line"><span class="cl">101:    from all fwmark 0x100/0x100 lookup <span class="m">101</span>
</span></span><span class="line"><span class="cl">102:    from all fwmark 0x40/0x40 lookup <span class="m">102</span>
</span></span><span class="line"><span class="cl">103:    from all lookup <span class="m">100</span>
</span></span><span class="line"><span class="cl">32766:  from all lookup main
</span></span><span class="line"><span class="cl">32767:  from all lookup default
</span></span></code></pre></div><p>所有 Ambient Mesh 节点中的路由表数量和规则是一样的，路由表规则将按顺序执行，首先查找 <code>local</code> 表，然后所有带有 <code>0x200/0x200</code> 标记的数据包将首先跳转到 <code>main</code> 表（其中定义了 veth 路由），然后查找 <code>100</code> 表，在 <code>100</code> 表中有以下规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="hl"><span class="lnt">8
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip route show table <span class="m">100</span>
</span></span><span class="line"><span class="cl">10.4.3.14 dev veth28865c45 scope link 
</span></span><span class="line"><span class="cl">10.4.3.15 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line"><span class="cl">10.4.3.16 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line"><span class="cl">10.4.3.17 via 192.168.126.2 dev istioin src 10.4.3. 
</span></span><span class="line"><span class="cl">10.4.3.18 via 192.168.126.2 dev istioin src 10.4.3. 
</span></span><span class="line"><span class="cl">10.4.3.19 via 192.168.126.2 dev istioin src 10.4.3.1
</span></span><span class="line hl"><span class="cl">10.4.3.20 via 192.168.126.2 dev istioin src 10.4.3.1</span></span></code></pre></td></tr></table>
</div>
</div>
<p>你会看到发往 <code>10.4.3.20</code> 的数据包将被路由到 <code>istioin</code> 网卡上的 <code>192.168.126.2</code> 网关。</p>
<p>查看 <code>istioin</code> 网卡的详细信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="hl"><span class="lnt">5
</span></span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip -d addr show istioin 
</span></span><span class="line"><span class="cl">17: istioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1410</span> qdisc noqueue state UNKNOWN group default 
</span></span><span class="line"><span class="cl">    link/ether 36:2a:2f:f1:5c:97 brd ff:ff:ff:ff:ff:ff promiscuity <span class="m">0</span> minmtu <span class="m">68</span> maxmtu <span class="m">65485</span> 
</span></span><span class="line hl"><span class="cl">    geneve id <span class="m">1000</span> remote 10.4.3.14 ttl auto dstport <span class="m">6081</span> noudpcsum udp6zerocsumrx numtxqueues <span class="m">1</span> numrxqueues <span class="m">1</span> gso_max_size <span class="m">65536</span> gso_max_segs <span class="m">65535</span> 
</span></span><span class="line hl"><span class="cl">    inet 192.168.126.1/30 brd 192.168.126.3 scope global istioin
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::342a:2fff:fef1:5c97/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever</span></span></code></pre></td></tr></table>
</div>
</div>
<p>从输出中可以看到，<code>istioin</code> 是一个 Geneve 类型虚拟网卡，它创建了一个 Geneve 隧道，远端的 IP 是 <code>10.4.3.14 </code>，这是 Ztunnel B 的 Pod IP。</p>
<h3 id="ztunnel-b-rules">检查 Ztunnel B Pod 上的路由规则</h3>
<p>进入 Ztunnel B Pod，使用 <code>ip -d a</code> 命令检查它的网卡信息，你会看到有一个 <code>pistioout</code> 网卡，它的 IP 为 <code>192.168.127.2</code>，这正是与 <code>istioout</code> 虚拟网卡建立的 Geneve 隧道的远端。</p>
<p>使用 <code>iptables-save</code> 查看 Pod 内的 iptables 规则，你会看到：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -m tcp --dport <span class="m">15008</span> -j TPROXY --on-port <span class="m">15008</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span class="line"><span class="cl">-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port <span class="m">15006</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span></code></pre></div><p>所有发往 <code>10.4.3.20:15008</code> 的流量将使用 tproxy 被路由到 15008 端口。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    关于 15006 和 15008 端口
  </div>
  
  <div class="alert-note px-2">
    <ul>
<li>15006 端口用于处理非加密的（plain）TCP 数据包。</li>
<li>15008 端口用于处理加密的（TLS）TCP 数据包。</li>
</ul>

  </div>
</div>

<p>以上就是 Pod 中入站流量的透明劫持过程。</p>
<h2 id="ztunnel-b-inbound">Ztunnel B 上的入站流量路由</h2>
<p>出站的 TLS 加密流量在被劫持到 Ztunnel 上，进入 Envoy 的 15008 端口处理。下面我们来查看 Ztunnel 如何路由入站流量。</p>
<p>我们直接在自己的本地机器上远程获取 ztunnel B 中的 Envoy 配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -n istio-system 	ztunnel-z4qmh -c istio-proxy -- curl <span class="s2">&#34;127.0.0.1:15000/config_dump?include_eds&#34;</span>&gt;ztunnel-b-all-include-eds.json
</span></span></code></pre></div><h3 id="ztunnel_inbound-listener">ztunnel_inbound 监听器</h3>
<p>查看 <code>ztunnel_inbound</code> 监听器的详细信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="hl"><span class="lnt">  7
</span></span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="hl"><span class="lnt"> 10
</span></span><span class="hl"><span class="lnt"> 11
</span></span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="hl"><span class="lnt"> 17
</span></span><span class="hl"><span class="lnt"> 18
</span></span><span class="hl"><span class="lnt"> 19
</span></span><span class="hl"><span class="lnt"> 20
</span></span><span class="hl"><span class="lnt"> 21
</span></span><span class="hl"><span class="lnt"> 22
</span></span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="hl"><span class="lnt"> 39
</span></span><span class="hl"><span class="lnt"> 40
</span></span><span class="hl"><span class="lnt"> 41
</span></span><span class="hl"><span class="lnt"> 42
</span></span><span class="hl"><span class="lnt"> 43
</span></span><span class="hl"><span class="lnt"> 44
</span></span><span class="hl"><span class="lnt"> 45
</span></span><span class="hl"><span class="lnt"> 46
</span></span><span class="hl"><span class="lnt"> 47
</span></span><span class="hl"><span class="lnt"> 48
</span></span><span class="hl"><span class="lnt"> 49
</span></span><span class="hl"><span class="lnt"> 50
</span></span><span class="hl"><span class="lnt"> 51
</span></span><span class="hl"><span class="lnt"> 52
</span></span><span class="hl"><span class="lnt"> 53
</span></span><span class="hl"><span class="lnt"> 54
</span></span><span class="hl"><span class="lnt"> 55
</span></span><span class="hl"><span class="lnt"> 56
</span></span><span class="hl"><span class="lnt"> 57
</span></span><span class="hl"><span class="lnt"> 58
</span></span><span class="hl"><span class="lnt"> 59
</span></span><span class="hl"><span class="lnt"> 60
</span></span><span class="hl"><span class="lnt"> 61
</span></span><span class="hl"><span class="lnt"> 62
</span></span><span class="hl"><span class="lnt"> 63
</span></span><span class="hl"><span class="lnt"> 64
</span></span><span class="hl"><span class="lnt"> 65
</span></span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="hl"><span class="lnt"> 78
</span></span><span class="hl"><span class="lnt"> 79
</span></span><span class="hl"><span class="lnt"> 80
</span></span><span class="hl"><span class="lnt"> 81
</span></span><span class="hl"><span class="lnt"> 82
</span></span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-11T07:12:01Z/16&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ztunnel_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">     <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15008</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filter_chain_match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">      <span class="nt">&#34;prefix_ranges&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;address_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.3.20&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;prefix_len&#34;</span><span class="p">:</span> <span class="mi">32</span>
</span></span><span class="line hl"><span class="cl">       <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.rbac&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.rbac.v3.RBAC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;rules&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;tcp.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;shadow_rules_stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;istio_dry_run_allow_&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.http_connection_manager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_hcm&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;route_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;local_route&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">         <span class="nt">&#34;virtual_hosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;local_service&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">            <span class="s2">&#34;*&#34;</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">           <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;connect_matcher&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">},</span>
</span></span><span class="line hl"><span class="cl">             <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;virtual_inbound&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">              <span class="nt">&#34;upgrade_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;upgrade_type&#34;</span><span class="p">:</span> <span class="s2">&#34;CONNECT&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">                <span class="nt">&#34;connect_config&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line hl"><span class="cl">               <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">              <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">             <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">            <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">           <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">          <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">]</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.http.router&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.http.router.v3.Router&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;http2_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&#34;allow_connect&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}],</span>
</span></span><span class="line hl"><span class="cl">        <span class="nt">&#34;upgrade_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">          <span class="nt">&#34;upgrade_type&#34;</span><span class="p">:</span> <span class="s2">&#34;CONNECT&#34;</span>
</span></span><span class="line hl"><span class="cl">         <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span><span class="err">...</span><span class="p">}</span> 
</span></span><span class="line"><span class="cl">     <span class="p">},</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_10.4.3.20&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="err">...</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;use_original_dst&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[{},</span><span class="err">...</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;transparent&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;socket_options&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}</span><span class="err">}</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;access_log&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="err">...</span><span class="p">}</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-11-14T03:54:07.040Z&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>从上面的配置中可以看出：</p>
<ul>
<li>发往 <code>10.4.3.20</code> 的流量将被路由到 <code>virtual_inbound</code> 集群；</li>
<li>第 78 - 82 行：<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#config-route-v3-routeaction-upgradeconfig" title="&lt;code&gt;upgrade_type: &amp;quot;CONNECT&amp;quot;&lt;/code&gt;" target="_blank" rel="noopener"><code>upgrade_type: &quot;CONNECT&quot;</code></a> 为 Envoy 的 HCM 启用 HTTP Connect 隧道，将该隧道中的 TCP 数据发送到上游；</li>
</ul>
<h3 id="virtual_inbound-cluster">virtual_inbound 集群</h3>
<p>查看 <code>virtual_inbound</code> 集群的信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="hl"><span class="lnt"> 9
</span></span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;version_info&#34;</span>: <span class="s2">&#34;2022-11-11T07:10:40Z/13&#34;</span>,
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;cluster&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;@type&#34;</span>: <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;virtual_inbound&#34;</span>,
</span></span><span class="line hl"><span class="cl">  <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;ORIGINAL_DST&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;lb_policy&#34;</span>: <span class="s2">&#34;CLUSTER_PROVIDED&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;original_dst_lb_config&#34;</span>: <span class="o">{</span>
</span></span><span class="line hl"><span class="cl">   <span class="s2">&#34;use_http_header&#34;</span>: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">}</span>,
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;last_updated&#34;</span>: <span class="s2">&#34;2022-11-11T07:10:42.111Z&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>
<ul>
<li>第 7 行：该集群的类型是 <code>ORIGINAL_DST</code>，表示使用下游的原始目的地作为路由目的地，即 <code>10.4.3.20:15008</code>，显然这个地址中的端口不正确；</li>
<li>第 9 行：<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster-originaldstlbconfig" title="&lt;code&gt;use_http_header&lt;/code&gt;" target="_blank" rel="noopener"><code>use_http_header</code></a> 为 <code>true</code> 时将使用 HTTP header <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-envoy-original-dst-host" title="&lt;code&gt;x-envoy-original-dst-host&lt;/code&gt;" target="_blank" rel="noopener"><code>x-envoy-original-dst-host</code></a> 作为目的地址，而这个 header <a href="/#sleep-internal-upstream" title="在出站的 Ztunnel 中已设置">在出站的 Ztunnel 中已设置</a>为 <code>10.4.3.20:9080</code>，它将覆盖之前设置的目的地址；</li>
</ul>
<p>至此，入站流量被 ztunnel 准确地路由到了目的地。以上就是 Ambient 模式中不同节点间 L4 流量劫持和路由流程。</p>
<h2 id="summary">总结</h2>
<p>为了方便演示，本文中展示的是不同节点上的服务 L4 网络访问数据包的路径，即使两个服务在同一个节点上路径也是类似的。根据本文中提供的操作说明，读者可以在自己的环境中尝试。Istio 的 Ambient 模式还在初级阶段，在笔者测试过程中，也发现导出的 Envoy 配置中 EDS 缺少 <code>cluster_name</code> 字段的问题（<a href="https://github.com/istio/istio/issues/42022" title="Issue Istio-42022" target="_blank" rel="noopener">Issue Istio-42022</a>）。另外 Ambient 模式使用 Istio CNI 在节点中注入 iptables 规则，通过设置 <code>nfmark</code> 的方式拦截 Pod 的流量到 Ztunnel 中，这种方式可能造成对其他 CNI 的兼容性问题，<a href="https://merbridge.io/zh/blog/2022/11/11/ambient-mesh-support/" title="Merbridge" target="_blank" rel="noopener">Merbridge</a> 项目正在寻求使用 eBPF 来绕过 IPtables，从而无需安装 Istio CNI，这样也就不会存在 CNI 兼容性问题。</p>
<p>在了解了 L4 流量路径之后，今后笔者会再分享 Ambient 模式中的 L7 流量路径，欢迎关注。</p>
<h2 id="reference">参考</h2>
<ul>
<li><a href="https://istio.io/latest/blog/2022/get-started-ambient/" title="安装 Ambient Mesh - istio.io" target="_blank" rel="noopener">安装 Ambient Mesh - istio.io</a></li>
<li><a href="https://mp.weixin.qq.com/s/PpP0pmxdJR8PknHeR-pVHQ" title="深入 Ambient Mesh - 流量路径 - mp.weixin.qq.com" target="_blank" rel="noopener">深入 Ambient Mesh - 流量路径 - mp.weixin.qq.com</a></li>
<li><a href="https://mp.weixin.qq.com/s/TXMyxbzBSfuYNquOZJmZTg" title="一文读懂 Ambient Mesh 七层服务治理 - mp.weixin.qq.com" target="_blank" rel="noopener">一文读懂 Ambient Mesh 七层服务治理 - mp.weixin.qq.com</a></li>
<li><a href="https://mp.weixin.qq.com/s/B0q73ACAvmY4SjW42A2GVw" title="深度剖析！Istio 共享代理新模式 Ambient Mesh - mp.weixin.qq.com" target="_blank" rel="noopener">深度剖析！Istio 共享代理新模式 Ambient Mesh - mp.weixin.qq.com</a></li>
<li><a href="https://www.zhaohuabing.com/post/2022-09-11-ambient-deep-dive-1/" title="Istio Ambient 模式流量管理实现机制详解（一）- zhaohuabing.com" target="_blank" rel="noopener">Istio Ambient 模式流量管理实现机制详解（一）- zhaohuabing.com</a></li>
<li><a href="https://www.zhaohuabing.com/post/2022-09-11-ambient-deep-dive-2/" title="Istio Ambient 模式流量管理实现机制详解（二） - zhaohuabing.com" target="_blank" rel="noopener">Istio Ambient 模式流量管理实现机制详解（二） - zhaohuabing.com</a></li>
<li><a href="https://www.zhaohuabing.com/post/2022-10-17-ambient-deep-dive-3/" title="Istio Ambient 模式流量管理实现机制详解（三）- zhaohuabing.com" target="_blank" rel="noopener">Istio Ambient 模式流量管理实现机制详解（三）- zhaohuabing.com</a></li>
<li><a href="https://merbridge.io/zh/blog/2022/11/11/ambient-mesh-support/" title="Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！- merbridge.io" target="_blank" rel="noopener">Merbridge 支持 Ambient Mesh，无惧 CNI 兼容性！- merbridge.io</a></li>
</ul>

            <div class="border-bottom mb-2"></div>
          </div>

          <div class="col-12">
            <p>最后更新于 2024/07/20</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/tags/istio" class="badge"> 
                  Istio</a> 
              <a href="/tags/ambient" class="badge">  
                  Ambient</a> 
              <a href="/tags/ztunnel" class="badge">  
                  Ztunnel</a> 
              <a href="/tags/envoy" class="badge">  
                  Envoy</a> 
              <a href="/tags/hbone" class="badge">  
                  HBONE</a> </div>
          </div>

          
          <div class="col-12">
            
<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/blog/ambient-mesh-l7-traffic-path/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; 上一篇</span>
            <span class="text-align-left">Istio Ambient 模式中的七层流量路由路径详解</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/blog/why-gateway-api-is-the-future-of-ingress-and-mesh/" class="d-flex flex-column align-items-end">
           <span class="nav mb-2 text-color-dark">下一篇 &rarr;</span>
           <span class="text-align-right">Gateway API：Kubernetes 和服务网格入口中网关的未来</span>
         </a>
    </div>
     
</div>

          </div>

          
          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="zh-CN"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          





<div>
  <p class="related-sidebar-title">
  相关文章
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/blog/istio-ambient-mode/">
            关于 Istio 推出 ambient 数据平面模式的看法
          </a>
      </li>
    
      <li>
          <a href="/blog/istio-arm64-support/">
            Istio 1.15 新增对 arm64 架构处理器的支持
          </a>
      </li>
    
      <li>
          <a href="/blog/istiocon-2022-recap/">
            IstioCon 2022 回顾及录像、PPT 分享
          </a>
      </li>
    
      <li>
          <a href="/blog/beyond-istio-oss/">
            Beyond Istio OSS —— Istio 服务网格的现状与未来
          </a>
      </li>
    
      <li>
          <a href="/blog/how-to-integrate-spire-with-istio/">
            如何在 Istio 中集成 SPIRE？
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#principles">原理</a>
      <ul>
        <li><a href="#what-is-tproxy">什么是 tproxy？</a></li>
        <li><a href="#what-is-hbone">什么是 HBONE？</a></li>
      </ul>
    </li>
    <li><a href="#environment">环境说明</a></li>
    <li><a href="#outbound">Outbound 流量劫持</a>
      <ul>
        <li><a href="#node-a-rules">检查节点 A 上的路由规则</a></li>
        <li><a href="#ztunnel-a-rules">检查 Ztunnel A 上的路由规则</a></li>
      </ul>
    </li>
    <li><a href="#ztunnel-a-outbound">Ztunnel A 上的出站流量路由</a>
      <ul>
        <li><a href="#ztunnel_outbound-listener">ztunnel_outbound 监听器</a></li>
        <li><a href="#sleep-集群">Sleep 集群</a></li>
        <li><a href="#sleep-endpoints">Sleep 集群的端点</a></li>
        <li><a href="#sleep-internal-upstream">通过 Envoy 内部监听器建立 HBONE 隧道</a></li>
        <li><a href="#sleep-tunnel-cluster">Sleep 集群的 HBONE 隧道端点</a></li>
      </ul>
    </li>
    <li><a href="#inbound">Inbound 流量劫持</a>
      <ul>
        <li><a href="#node-b-rules">检查节点 B 上的路由规则</a></li>
        <li><a href="#ztunnel-b-rules">检查 Ztunnel B Pod 上的路由规则</a></li>
      </ul>
    </li>
    <li><a href="#ztunnel-b-inbound">Ztunnel B 上的入站流量路由</a>
      <ul>
        <li><a href="#ztunnel_inbound-listener">ztunnel_inbound 监听器</a></li>
        <li><a href="#virtual_inbound-cluster">virtual_inbound 集群</a></li>
      </ul>
    </li>
    <li><a href="#summary">总结</a></li>
    <li><a href="#reference">参考</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

 
 
 
 
 
    

<div class="sticky-top aside-toc loaded subscribe-module mt-4">
     <button class="close-ad" style="position: absolute; top: 0; right: 0; border: none; background: none; cursor: pointer;">✖</button>
     <p class="subscribe-module-title">推荐课程 </p>
     
          <div class="d-flex">
          <span class="mr-2"><img src="/images/ads/01-baiyuan-sre.png" alt="QR Code"></span>
     
     <span>
          <p class="subscribe-module-subtitle"><a href="http://gk.link/a/12pcr" title="SRE 实践：服务可靠性案例课" target="_blank" rel="noopener">SRE 实践：服务可靠性案例课</a></p>
          <p class="subscribe-module-author">讲师：白园，前百度资深运维专家</p>
          <p class="subscribe-module-description">搞定 SRE，为你的系统保驾护航。</p>
     </span>
     
     </div>
</div>


          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h4 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h4 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/exploring-envoy-1-31-features-performance/">探索 Envoy 1.31.0：新特性与性能提升全解析</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-gateway-contributor-guide/">如何参与 Envoy Gateway 社区：贡献或提交代码指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/exploring-fantastic-planet/">Fantastic Planet：权力、解放与文明间的微妙平衡 — 深入探索原始星球中知识和自由的力量</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h4 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h4 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h4 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024 圆桌论坛预告：Istio 和现代 API 网关——引领服务网格的未来</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 大连云原生技术开放日</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.19a9d2eaabea2cd81f7d1b4f5f6ec267fbdba497ba1b5fee18a6ade6dcba8edf.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.1cfcfe652ddcffb2f20c4854df30e36e.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
