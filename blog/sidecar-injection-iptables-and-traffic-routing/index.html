<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£ Â· Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œä»‹ç»äº† sidecar æ¨¡å¼åŠå…¶ä¼˜åŠ¿ sidecar å¦‚ä½•æ³¨å…¥åˆ°æ•°æ®å¹³é¢ï¼ŒEnvoy å¦‚ä½•åšæµé‡åŠ«æŒå’Œè·¯ç”±è½¬å‘çš„ï¼ŒåŒ…æ‹¬ Inbound æµé‡å’Œ Outbound æµé‡ã€‚">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.98.0" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  
  <link rel="stylesheet" href="/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/plugins/hightlight/syntax.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/tocbot/tocbot.css">
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.css" media="screen">

  <!--Favicon-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="57x57" href="images/favicon-57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="images/favicon-72.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="images/favicon-114.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="images/favicon-144.png" />

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css">
  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/" />
  <meta property="og:title" content="Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£" />
  <meta property="twitter:title" content="Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£" />
  
  <meta property="og:description" content="æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œä»‹ç»äº† sidecar æ¨¡å¼åŠå…¶ä¼˜åŠ¿ sidecar å¦‚ä½•æ³¨å…¥åˆ°æ•°æ®å¹³é¢ï¼ŒEnvoy å¦‚ä½•åšæµé‡åŠ«æŒå’Œè·¯ç”±è½¬å‘çš„ï¼ŒåŒ…æ‹¬ Inbound æµé‡å’Œ Outbound æµé‡ã€‚" />
  <meta property="twitter:description" content="æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œä»‹ç»äº† sidecar æ¨¡å¼åŠå…¶ä¼˜åŠ¿ sidecar å¦‚ä½•æ³¨å…¥åˆ°æ•°æ®å¹³é¢ï¼ŒEnvoy å¦‚ä½•åšæµé‡åŠ«æŒå’Œè·¯ç”±è½¬å‘çš„ï¼ŒåŒ…æ‹¬ Inbound æµé‡å’Œ Outbound æµé‡ã€‚" />
  
  
  <meta property="og:image" content="https://jimmysong.io/images/banner/istio-sidecar-iptables.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/istio-sidecar-iptables.jpg" />
  
  
  
</head>
<body>
    <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>

<header class="fixed-top header">
  
  
  <div class="top-header py-2 bg-white">
    <div class="container">
      <div class="row no-gutters align-items-center">
        <div class="col-12 text-center">
          <ul class="list-inline">
            <li class="list-inline-item">
                ğŸ“£ äº‘åŸç”Ÿç¤¾åŒºè‘—çš„ã€Šæ·±å…¥ç†è§£ Istioã€‹å‡ºç‰ˆå•¦ï¼Œ<a href="https://item.jd.com/13200745.html" title="å‰å¾€è´­ä¹°" target="_blank" rel="noopener">å‰å¾€è´­ä¹°</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  
  <div class="navigation w-100  top-hider ">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/"><img class="img-fluid" width="200px"
            src="/images/logo.svg" alt="Jimmy Song - ä¸“æ³¨äºæ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼"></a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">åšå®¢</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://lib.jimmysong.io/" target="_blank" rel="noopener">å›¾ä¹¦</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://lib.jimmysong.io/blog/" target="_blank" rel="noopener">è¯‘æ–‡</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://cloudnative.to" target="_blank" rel="noopener">ç¤¾åŒº</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://lib.jimmysong.io/event/" target="_blank" rel="noopener">æ´»åŠ¨</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">æ ‡ç­¾</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">è”ç³»</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">é€šçŸ¥</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">å…³äº</a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
            
            
            
            
            
            
            
            <a class="nav-link" href="/en/blog/sidecar-injection-iptables-and-traffic-routing/">English</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
          </li>
          
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


	
<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/page-title.webp'),url('/images/backgrounds/page-title.webp');">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <ul class="list-inline custom-breadcrumb">
                    <li class="list-inline-item h2"><a class="text-white font-secondary" href="/blog">
            
            
              
              åšå®¢
              
            
          </a></li>
                    <li class="list-inline-item"><i class="ti-angle-right text-white"></i></li>
                    <li class="list-inline-item text-white h3 font-secondary">Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£</li>
                </ul>
                <p class="text-white">æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œä»‹ç»äº† sidecar æ¨¡å¼åŠå…¶ä¼˜åŠ¿ sidecar å¦‚ä½•æ³¨å…¥åˆ°æ•°æ®å¹³é¢ï¼ŒEnvoy å¦‚ä½•åšæµé‡åŠ«æŒå’Œè·¯ç”±è½¬å‘çš„ï¼ŒåŒ…æ‹¬ Inbound æµé‡å’Œ Outbound æµé‡ã€‚</p>
            </div>
        </div>
    </div>
</section>

	


<section class="section-sm">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8 article-content">
        <div class="row">
          <div class="col-12">
            <ul class="list-inline">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">æ—¥æœŸ
                  :</span>2022å¹´5æœˆ12æ—¥</li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">åˆ†ç±»
                  :</span><a
                  href="/categories/istio"> 
                  Istio</a> </li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">å­—æ•°
                  :</span>8155 å­—</li>
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">é˜…è¯»å¤§çº¦éœ€è¦
                  :</span>37 åˆ†é’Ÿ</li>
            </ul>
          </div>
          
          <div class="col-12 my-4">
            <div class="border-bottom"></div>
          </div>
          
          <div class="col-12 content">
            <p>æœ¬æ–‡æœ€æ—©æ˜¯åŸºäº Istio 1.11 æ’°å†™ï¼Œä¹‹åéšç€ Istio çš„ç‰ˆæœ¬é™†ç»­æ›´æ–°ï¼Œæœ€æ–°æ›´æ–°æ—¶é—´ä¸º 2022 å¹´ 5 æœˆ 12 æ—¥ï¼Œå…³äºæœ¬æ–‡å†å²ç‰ˆæœ¬çš„æ›´æ–°è¯´æ˜è¯·è§æ–‡ç« æœ€åã€‚æœ¬æ–‡è®°å½•äº†è¯¦ç»†çš„å®è·µè¿‡ç¨‹ï¼ŒåŠ›å›¾èƒ½å¤Ÿè®©è¯»è€…å¤ç°ï¼Œå› æ­¤äº‹æ— å·¨ç»†ï¼Œæƒ³è¦ç†è§£æŸä¸ªéƒ¨åˆ†è¿‡ç¨‹çš„è¯»è€…å¯ä»¥ä½¿ç”¨ç›®å½•è·³è½¬åˆ°å¯¹åº”çš„å°èŠ‚é˜…è¯»ã€‚</p>
<p>ä¸ºäº†ä½¿è¯»è€…èƒ½å¤Ÿæ›´åŠ ç›´è§‚çš„äº†è§£æœ¬æ–‡ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œåœ¨é˜…è¯»æœ¬æ–‡å‰ä½ ä¹Ÿå¯ä»¥å…ˆè§‚çœ‹ä¸‹ <a href="https://bilibili.com/video/BV1cF411T72o/" title="Istio Workshop ç¬¬å…«è®²è§†é¢‘" target="_blank" rel="noopener">Istio Workshop ç¬¬å…«è®²è§†é¢‘</a>
ã€‚</p>
<figure class="mx-auto text-center">
    <a href="https://bilibili.com/video/BV1cF411T72o/"><img src="bilibili.jpg" loading="lazy" decoding="async" width="70%"data-img="bilibili.jpg"
         data-caption="å›¾ç‰‡"
         
         
         data-width="689"
         data-height="350"
         
         
    /></a><figcaption>
            <p><a href="https://bilibili.com/video/BV1cF411T72o/" title="ç‚¹å‡»è§‚çœ‹" target="_blank" rel="noopener">ç‚¹å‡»è§‚çœ‹</a></p>
        </figcaption>
</figure>

<p>ä¸ºäº†ç†è§£æœ¬æ–‡å¸Œæœ›ä½ å…ˆé˜…è¯»ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li><a href="/blog/understanding-iptables/" title="ç†è§£ iptables">ç†è§£ iptables</a>
</li>
<li><a href="/blog/istio-pod-process-lifecycle/" title="Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£">Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£</a>
</li>
</ul>
<h2 id="å†…å®¹ä»‹ç»">å†…å®¹ä»‹ç»</h2>
<p>æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œå°†ä¸ºå¤§å®¶ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>ä»€ä¹ˆæ˜¯ sidecar æ¨¡å¼å’Œå®ƒçš„ä¼˜åŠ¿åœ¨å“ªé‡Œã€‚</li>
<li>Istio ä¸­æ˜¯å¦‚ä½•åš sidecar æ³¨å…¥çš„ã€‚</li>
<li>Sidecar ä»£ç†æ˜¯å¦‚ä½•åšé€æ˜æµé‡åŠ«æŒçš„ã€‚</li>
<li>iptables çš„è·¯ç”±è§„åˆ™ã€‚</li>
<li>Envoy ä»£ç†æ˜¯å¦‚ä½•è·¯ç”±æµé‡åˆ°ä¸Šæ¸¸çš„ã€‚</li>
</ul>
<p>è¯·å¤§å®¶ç»“åˆä¸‹å›¾ç†è§£æœ¬æ–‡ä¸­çš„å†…å®¹ï¼Œæœ¬å›¾åŸºäº Istio å®˜æ–¹æä¾›çš„ Bookinfo ç¤ºä¾‹ç»˜åˆ¶ï¼Œå±•ç¤ºçš„æ˜¯ <code>reviews</code> Pod çš„å†…éƒ¨ç»“æ„ï¼ŒåŒ…æ‹¬ Linux Kernel ç©ºé—´ä¸­çš„ iptables è§„åˆ™ã€Sidecar å®¹å™¨ã€åº”ç”¨å®¹å™¨ã€‚</p>
<p><figure class="mx-auto text-center">
  
  
    
    <img src="/blog/sidecar-injection-iptables-and-traffic-routing/istio-iptables.svg" data-img="/blog/sidecar-injection-iptables-and-traffic-routing/istio-iptables.svg" alt="istio-iptables.svg" data-caption="Istio æµé‡åŠ«æŒç¤ºæ„å›¾">
    
  
  <figcaption>Istio æµé‡åŠ«æŒç¤ºæ„å›¾</figcaption>
</figure>
</p>
<p><code>productpage</code> è®¿é—® <code>reviews</code> Podï¼Œå…¥ç«™æµé‡å¤„ç†è¿‡ç¨‹å¯¹åº”äºå›¾ç¤ºä¸Šçš„æ­¥éª¤ï¼š1ã€2ã€3ã€4ã€Envoy Inbound Handlerã€5ã€6ã€7ã€8ã€åº”ç”¨å®¹å™¨ã€‚</p>
<p><code>reviews</code> Pod è®¿é—® <code>rating</code> æœåŠ¡çš„å‡ºç«™æµé‡å¤„ç†è¿‡ç¨‹å¯¹åº”äºå›¾ç¤ºä¸Šçš„æ­¥éª¤æ˜¯ï¼š9ã€10ã€11ã€12ã€Envoy Outbound Handlerã€13ã€14ã€15ã€‚</p>
<p>æ³¨æ„ï¼šå›¾ä¸­çš„è·¯å¾„ 16 è¿‘ç”¨äºè·¯ç”±è§„åˆ™è¯´æ˜ï¼Œå®ƒä¸ä¸å‡ºç°åœ¨å½“å‰ç¤ºä¾‹ä¸­ã€‚å®é™…ä¸Šä»…å½“ Pod å†…å‘å‡ºçš„å¯¹å½“å‰ Pod å†…çš„æœåŠ¡è®¿é—®çš„æ—¶å€™æ‰ä¼šé€”å¾„å®ƒã€‚</p>
<p>ä¸Šå›¾ä¸­å…³äºæµé‡è·¯ç”±éƒ¨åˆ†ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li><code>productpage</code> æœåŠ¡è¯·æ±‚è®¿é—® <code>http://reviews.default.svc.cluster.local:9080/</code>ï¼Œå½“æµé‡è¿›å…¥ <code>reviews</code> Pod å†…éƒ¨æ—¶ï¼Œæµé‡æ˜¯å¦‚ä½•è¢« iptables åŠ«æŒåˆ° Envoy ä»£ç†è¢« Inbound Handler å¤„ç†çš„ï¼›</li>
<li><code>reviews</code> è¯·æ±‚è®¿é—® <code>ratings</code> æœåŠ¡çš„ Podï¼Œåº”ç”¨ç¨‹åºå‘å‡ºçš„å‡ºç«™æµé‡è¢« iptables åŠ«æŒåˆ° Envoy ä»£ç†çš„ Outbound Handler çš„å¤„ç†ã€‚</li>
</ul>
<p>åœ¨é˜…è¯»ä¸‹æ–‡æ—¶ï¼Œè¯·å¤§å®¶ç¡®ç«‹ä»¥ä¸‹å·²çŸ¥ç‚¹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œ<code>productpage</code> å‘å‡ºçš„å¯¹ <code>reivews</code> çš„è®¿é—®æµé‡ï¼Œæ˜¯åœ¨ Envoy å·²ç»é€šè¿‡ EDS é€‰æ‹©å‡ºäº†è¦è¯·æ±‚çš„ <code>reviews</code> æœåŠ¡çš„æŸä¸ª Podï¼ŒçŸ¥æ™“äº†å…¶ IP åœ°å€ï¼Œç›´æ¥å‘è¯¥ IP å‘é€çš„ TCP è¿æ¥è¯·æ±‚ã€‚</li>
<li><code>reviews</code> æœåŠ¡æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä¸‰ä¸ªç‰ˆæœ¬ä¸­çš„ sidecar å·¥ä½œæ­¥éª¤ç±»ä¼¼ï¼Œä¸‹æ–‡åªä»¥å…¶ä¸­ä¸€ä¸ª Pod ä¸­çš„ sidecar æµé‡è½¬å‘æ­¥éª¤æ¥è¯´æ˜ã€‚</li>
<li>æ‰€æœ‰è¿›å…¥ <code>reviews</code> Pod çš„ TCP æµé‡éƒ½æ ¹æ® Pod ä¸­çš„ iptables è§„åˆ™è½¬å‘åˆ°äº† Envoy ä»£ç†çš„ 15006 ç«¯å£ï¼Œç„¶åç»è¿‡ Envoy çš„å¤„ç†ç¡®å®šè½¬å‘ç»™ Pod å†…çš„åº”ç”¨å®¹å™¨è¿˜æ˜¯é€ä¼ ã€‚</li>
</ul>
<h2 id="sidecar-æ¨¡å¼">Sidecar æ¨¡å¼</h2>
<p>å°†åº”ç”¨ç¨‹åºçš„åŠŸèƒ½åˆ’åˆ†ä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œåœ¨åŒä¸€ä¸ªæœ€å°è°ƒåº¦å•å…ƒä¸­ï¼ˆä¾‹å¦‚ Kubernetes ä¸­çš„ Podï¼‰å¯ä»¥è¢«è§†ä¸º <strong>sidecar æ¨¡å¼</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œsidecar æ¨¡å¼å…è®¸æ‚¨åœ¨åº”ç”¨ç¨‹åºæ—è¾¹æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼Œè€Œæ— éœ€é¢å¤–ç¬¬ä¸‰æ–¹ç»„ä»¶é…ç½®æˆ–ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚</p>
<figure class="mx-auto text-center">
    <img src="sidecar-pattern.svg" loading="lazy" decoding="async"
         alt="Sidecar æ¨¡å¼ç¤ºæ„å›¾" width="60%"data-img="sidecar-pattern.svg"
         data-caption="å›¾ç‰‡"
         
         
         
    /><figcaption>
            Sidecar æ¨¡å¼ç¤ºæ„å›¾
        </figcaption>
</figure>

<p>å°±åƒè¿æ¥äº† Sidecar çš„ä¸‰è½®æ‘©æ‰˜è½¦ä¸€æ ·ï¼Œåœ¨è½¯ä»¶æ¶æ„ä¸­ï¼Œ Sidecar è¿æ¥åˆ°çˆ¶åº”ç”¨å¹¶ä¸”ä¸ºå…¶æ·»åŠ æ‰©å±•æˆ–è€…å¢å¼ºåŠŸèƒ½ã€‚Sidecar åº”ç”¨ä¸ä¸»åº”ç”¨ç¨‹åºæ¾æ•£è€¦åˆã€‚å®ƒå¯ä»¥å±è”½ä¸åŒç¼–ç¨‹è¯­è¨€çš„å·®å¼‚ï¼Œç»Ÿä¸€å®ç°å¾®æœåŠ¡çš„å¯è§‚å¯Ÿæ€§ã€ç›‘æ§ã€æ—¥å¿—è®°å½•ã€é…ç½®ã€æ–­è·¯å™¨ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="ä½¿ç”¨-sidecar-æ¨¡å¼çš„ä¼˜åŠ¿">ä½¿ç”¨ Sidecar æ¨¡å¼çš„ä¼˜åŠ¿</h3>
<p>ä½¿ç”¨ sidecar æ¨¡å¼éƒ¨ç½²æœåŠ¡ç½‘æ ¼æ—¶ï¼Œæ— éœ€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä»£ç†ï¼Œä½†æ˜¯é›†ç¾¤ä¸­å°†è¿è¡Œå¤šä¸ªç›¸åŒçš„ sidecar å‰¯æœ¬ã€‚åœ¨ sidecar éƒ¨ç½²æ–¹å¼ä¸­ï¼Œæ¯ä¸ªåº”ç”¨çš„å®¹å™¨æ—éƒ½ä¼šéƒ¨ç½²ä¸€ä¸ªä¼´ç”Ÿå®¹å™¨ï¼ˆå¦‚ Envoy æˆ– MOSNï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ç§°ä¹‹ä¸º sidecar å®¹å™¨ã€‚Sidecar æ¥ç®¡è¿›å‡ºåº”ç”¨å®¹å™¨çš„æ‰€æœ‰æµé‡ã€‚åœ¨ Kubernetes çš„ Pod ä¸­ï¼Œåœ¨åŸæœ‰çš„åº”ç”¨å®¹å™¨æ—è¾¹æ³¨å…¥ä¸€ä¸ª Sidecar å®¹å™¨ï¼Œä¸¤ä¸ªå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œå¯ä»¥å¹¿ä¹‰çš„å°†è¿™ä¸ªåŒ…å«äº† sidecar å®¹å™¨çš„ Pod ç†è§£ä¸ºä¸€å°ä¸»æœºï¼Œä¸¤ä¸ªå®¹å™¨å…±äº«ä¸»æœºèµ„æºã€‚</p>
<p>å› å…¶ç‹¬ç‰¹çš„éƒ¨ç½²ç»“æ„ï¼Œä½¿å¾— sidecar æ¨¡å¼å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ul>
<li>å°†ä¸åº”ç”¨ä¸šåŠ¡é€»è¾‘æ— å…³çš„åŠŸèƒ½æŠ½è±¡åˆ°å…±åŒåŸºç¡€è®¾æ–½ï¼Œé™ä½äº†å¾®æœåŠ¡ä»£ç çš„å¤æ‚åº¦ã€‚</li>
<li>å› ä¸ºä¸å†éœ€è¦ç¼–å†™ç›¸åŒçš„ç¬¬ä¸‰æ–¹ç»„ä»¶é…ç½®æ–‡ä»¶å’Œä»£ç ï¼Œæ‰€ä»¥èƒ½å¤Ÿé™ä½å¾®æœåŠ¡æ¶æ„ä¸­çš„ä»£ç é‡å¤åº¦ã€‚</li>
<li>Sidecar å¯ç‹¬ç«‹å‡çº§ï¼Œé™ä½åº”ç”¨ç¨‹åºä»£ç å’Œåº•å±‚å¹³å°çš„è€¦åˆåº¦ã€‚</li>
</ul>
<h2 id="sidecar-æ³¨å…¥ç¤ºä¾‹åˆ†æ">Sidecar æ³¨å…¥ç¤ºä¾‹åˆ†æ</h2>
<p>ä»¥ Istio å®˜æ–¹æä¾›çš„ <code>bookinfo</code> ä¸­ <code>productpage</code> çš„ YAML ä¸ºä¾‹ï¼Œå…³äº <code>bookinfo</code> åº”ç”¨çš„è¯¦ç»† YAML é…ç½®è¯·å‚è€ƒ <a href="https://github.com/istio/istio/blob/master/samples/bookinfo/platform/kube/bookinfo.yaml" title="bookinfo.yaml" target="_blank" rel="noopener">bookinfo.yaml</a>
ã€‚</p>
<p>ä¸‹æ–‡å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è®²è§£ï¼š</p>
<ul>
<li>Sidecar å®¹å™¨çš„æ³¨å…¥</li>
<li>iptables è§„åˆ™çš„åˆ›å»º</li>
<li>è·¯ç”±çš„è¯¦ç»†è¿‡ç¨‹</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">productpage-v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">bookinfo-productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><p>å†æŸ¥çœ‹ä¸‹ <code>productpage</code> å®¹å™¨çš„ <a href="https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/Dockerfile" title="Dockerfile" target="_blank" rel="noopener">Dockerfile</a>
ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-docker" data-lang="docker"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> python:3.7.4-slim</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> requirements.txt ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install --no-cache-dir -r requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> test-requirements.txt ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install --no-cache-dir -r test-requirements.txt<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> productpage.py /opt/microservices/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> tests/unit/* /opt/microservices/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> templates /opt/microservices/templates<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> static /opt/microservices/static<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> requirements.txt /opt/microservices/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ARG</span> flood_factor<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> FLOOD_FACTOR <span class="si">${</span><span class="nv">flood_factor</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 9080</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /opt/microservices</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> python -m unittest discover<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> 1</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;productpage.py&#34;</span><span class="p">,</span> <span class="s2">&#34;9080&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ° <code>Dockerfile</code> ä¸­æ²¡æœ‰é…ç½® <code>ENTRYPOINT</code>ï¼Œæ‰€ä»¥ <code>CMD</code> çš„é…ç½® <code>python productpage.py 9080</code> å°†ä½œä¸ºé»˜è®¤çš„ <code>ENTRYPOINT</code>ï¼Œè®°ä½è¿™ä¸€ç‚¹ï¼Œå†çœ‹ä¸‹æ³¨å…¥ sidecar ä¹‹åçš„é…ç½®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></div><p>æˆ‘ä»¬åªæˆªå–å…¶ä¸­ä¸ <code>productpage</code> ç›¸å…³çš„ <code>Deployment</code> é…ç½®ä¸­çš„éƒ¨åˆ† YAML é…ç½®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class="w"> </span><span class="c"># åº”ç”¨é•œåƒ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">productpage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">sidecar</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">$(POD_NAMESPACE).svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">configPath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">/etc/istio/proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">binaryPath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">/usr/local/bin/envoy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">serviceCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">productpage.$(POD_NAMESPACE)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">drainDuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">45s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">parentShutdownDuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">1m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">discoveryAddress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">istiod.istio-system.svc:15012</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">zipkinAddress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">zipkin.istio-system:9411</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">proxyLogLevel=warning</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">proxyComponentLogLevel=misc:error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">connectTimeout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">proxyAdminPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;15000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">concurrency</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">controlPlaneAuthPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">NONE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">dnsRefreshRate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">300s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">statusPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;15020&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">trust-domain=cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- --<span class="l">controlPlaneBootstrap=false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/proxyv2:1.5.1</span><span class="w"> </span><span class="c"># sidecar proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">15090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-envoy-prom</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">istio-iptables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;15001&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;15006&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;1337&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">REDIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">i</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- -<span class="l">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="m">15090</span><span class="p">,</span><span class="m">15020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/proxyv2:1.5.1</span><span class="w"> </span><span class="c"># init å®¹å™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-init</span><span class="w">
</span></span></span></code></pre></div><p>Istio ç»™åº”ç”¨ Pod æ³¨å…¥çš„é…ç½®ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>Init å®¹å™¨ <code>istio-init</code>ï¼šç”¨äº pod ä¸­è®¾ç½® iptables ç«¯å£è½¬å‘</li>
<li>Sidecar å®¹å™¨ <code>istio-proxy</code>ï¼šè¿è¡Œ sidecar ä»£ç†ï¼Œå¦‚ Envoy æˆ– MOSNã€‚</li>
</ul>
<h2 id="iptables-è§„åˆ™æ³¨å…¥è§£æ">iptables è§„åˆ™æ³¨å…¥è§£æ</h2>
<p>ä¸ºäº†æŸ¥çœ‹ iptables é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦ç™»é™†åˆ° sidecar å®¹å™¨ä¸­ä½¿ç”¨ root ç”¨æˆ·æ¥æŸ¥çœ‹ï¼Œå› ä¸º <code>kubectl</code> æ— æ³•ä½¿ç”¨ç‰¹æƒæ¨¡å¼æ¥è¿œç¨‹æ“ä½œ docker å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç™»é™†åˆ° <code>productpage</code> pod æ‰€åœ¨çš„ä¸»æœºä¸Šä½¿ç”¨ <code>docker</code> å‘½ä»¤ç™»é™†å®¹å™¨ä¸­æŸ¥çœ‹ã€‚</p>
<p>å¦‚æœæ‚¨ä½¿ç”¨ minikube éƒ¨ç½²çš„ Kubernetesï¼Œå¯ä»¥ç›´æ¥ç™»å½•åˆ° minikube çš„è™šæ‹Ÿæœºä¸­å¹¶åˆ‡æ¢ä¸º root ç”¨æˆ·ã€‚æŸ¥çœ‹ iptables é…ç½®ï¼Œåˆ—å‡º NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå› ä¸ºåœ¨ Init å®¹å™¨å¯åŠ¨çš„æ—¶å€™é€‰æ‹©ç»™ <code>istio-iptables</code> ä¼ é€’çš„å‚æ•°ä¸­æŒ‡å®šå°†å…¥ç«™æµé‡é‡å®šå‘åˆ° sidecar çš„æ¨¡å¼ä¸º <code>REDIRECT</code>ï¼Œå› æ­¤åœ¨ iptables ä¸­å°†åªæœ‰ NAT è¡¨çš„è§„æ ¼é…ç½®ï¼Œå¦‚æœé€‰æ‹© <code>TPROXY</code> è¿˜ä¼šæœ‰ <code>mangle</code> è¡¨é…ç½®ã€‚<code>iptables</code> å‘½ä»¤çš„è¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ <a href="https://wangchujiang.com/linux-command/c/iptables.html" title="iptables" target="_blank" rel="noopener">iptables</a>
 å‘½ä»¤ã€‚</p>
<p>æˆ‘ä»¬ä»…æŸ¥çœ‹ä¸ <code>productpage</code> æœ‰å…³çš„ iptables è§„åˆ™å¦‚ä¸‹ï¼Œå› ä¸ºè¿™äº›è§„åˆ™æ˜¯è¿è¡Œåœ¨è¯¥å®¹å™¨ç‰¹å®šçš„ç½‘ç»œç©ºé—´ä¸‹ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ <code>nsenter</code> å‘½ä»¤è¿›å…¥å…¶ç½‘ç»œç©ºé—´ã€‚è¿›å…¥çš„æ—¶å€™éœ€è¦æŒ‡å®šè¿›ç¨‹ IDï¼ˆPIDï¼‰ï¼Œå› æ­¤é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ° <code>productpage</code> å®¹å™¨çš„ PIDã€‚å¯¹äºåœ¨ä¸åŒå¹³å°ä¸Šå®‰è£…çš„ Kubernetesï¼ŒæŸ¥æ‰¾å®¹å™¨çš„æ–¹å¼ä¼šç•¥æœ‰ä¸åŒï¼Œä¾‹å¦‚åœ¨ GKE ä¸Šï¼Œæ‰§è¡Œ <code>docker ps -a</code> å‘½ä»¤æ˜¯æŸ¥çœ‹ä¸åˆ°ä»»ä½•å®¹å™¨è¿›ç¨‹çš„ã€‚ä¸‹é¢å·² minikube å’Œ GKE ä¸¤ä¸ªå…¸å‹çš„å¹³å°ä¸ºä¾‹ï¼ŒæŒ‡å¯¼ä½ å¦‚ä½•è¿›å…¥å®¹å™¨çš„ç½‘ç»œç©ºé—´ã€‚</p>
<h3 id="åœ¨-minikube-ä¸­æŸ¥çœ‹å®¹å™¨ä¸­çš„-iptabes-è§„åˆ™">åœ¨ minikube ä¸­æŸ¥çœ‹å®¹å™¨ä¸­çš„ iptabes è§„åˆ™</h3>
<p>å¯¹äº minikubeï¼Œå› ä¸ºæ‰€æœ‰çš„è¿›ç¨‹éƒ½è¿è¡Œåœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ä½ åªéœ€è¦ç™»å½•åˆ° minikube è™šæ‹Ÿæœºï¼Œåˆ‡æ¢ä¸º root ç”¨æˆ·ç„¶åæŸ¥æ‰¾ <code>productpage</code> è¿›ç¨‹å³å¯ï¼Œå‚è€ƒä¸‹é¢çš„æ­¥éª¤ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¿›å…¥ minikube å¹¶åˆ‡æ¢ä¸º root ç”¨æˆ·ï¼Œminikube é»˜è®¤ç”¨æˆ·ä¸º docker</span>
</span></span><span class="line"><span class="cl">$ minikube ssh
</span></span><span class="line"><span class="cl">$ sudo -i
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹ productpage pod çš„ istio-proxy å®¹å™¨ä¸­çš„è¿›ç¨‹</span>
</span></span><span class="line"><span class="cl">$ docker top <span class="sb">`</span>docker ps<span class="p">|</span>grep <span class="s2">&#34;istio-proxy_productpage&#34;</span><span class="p">|</span>cut -d <span class="s2">&#34; &#34;</span> -f1<span class="sb">`</span>
</span></span><span class="line"><span class="cl">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
</span></span><span class="line"><span class="cl"><span class="m">1337</span>                <span class="m">10576</span>               <span class="m">10517</span>               <span class="m">0</span>                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span class="o">=</span>warning --proxyComponentLogLevel<span class="o">=</span>misc:error --connectTimeout 10s --proxyAdminPort <span class="m">15000</span> --concurrency <span class="m">2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span class="m">15020</span> --trust-domain<span class="o">=</span>cluster.local --controlPlaneBootstrap<span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl"><span class="m">1337</span>                <span class="m">10660</span>               <span class="m">10576</span>               <span class="m">0</span>                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span class="m">0</span> --drain-time-s <span class="m">45</span> --parent-shutdown-time-s <span class="m">60</span> --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len <span class="m">189</span> --local-address-ip-version v4 --log-format <span class="o">[</span>Envoy <span class="o">(</span>Epoch 0<span class="o">)]</span> <span class="o">[</span>%Y-%m-%d %T.%e<span class="o">][</span>%t<span class="o">][</span>%l<span class="o">][</span>%n<span class="o">]</span> %v -l warning --component-log-level misc:error --concurrency <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ nsenter è¿›å…¥ sidecar å®¹å™¨çš„å‘½åç©ºé—´ï¼ˆä»¥ä¸Šä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥ï¼‰</span>
</span></span><span class="line"><span class="cl">$ nsenter -n --target <span class="m">10660</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æŸ¥çœ‹ NAT è¡¨ä¸­è§„åˆ™é…ç½®çš„è¯¦ç»†ä¿¡æ¯ã€‚</span>
</span></span><span class="line"><span class="cl">$ iptables -t nat -L
</span></span></code></pre></div><h3 id="åœ¨-gke-ä¸­æŸ¥çœ‹å®¹å™¨çš„-iptables-è§„åˆ™">åœ¨ GKE ä¸­æŸ¥çœ‹å®¹å™¨çš„ iptables è§„åˆ™</h3>
<p>å¦‚æœä½ åœ¨ GKE ä¸­å®‰è£…çš„å¤šèŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ï¼Œé¦–å…ˆä½ éœ€è¦ç¡®å®šè¿™ä¸ª Pod è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œç„¶åç™»é™†åˆ°é‚£å°ä¸»æœºï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹çš„ PIDï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ps aux<span class="p">|</span>grep <span class="s2">&#34;productpage&#34;</span>
</span></span><span class="line"><span class="cl">chronos     <span class="m">4268</span>  0.0  0.6  <span class="m">43796</span> <span class="m">24856</span> ?        Ss   Apr22   0:00 python productpage.py <span class="m">9080</span>
</span></span><span class="line"><span class="cl">chronos     <span class="m">4329</span>  0.9  0.6 <span class="m">117524</span> <span class="m">24616</span> ?        Sl   Apr22  13:43 /usr/local/bin/python /opt/microservices/productpage.py <span class="m">9080</span>
</span></span><span class="line"><span class="cl">root      <span class="m">361903</span>  0.0  0.0   <span class="m">4536</span>   <span class="m">812</span> pts/0    S+   01:54   0:00 grep --colour<span class="o">=</span>auto productpage
</span></span></code></pre></div><p>ç„¶ååœ¨ç»ˆç«¯ä¸­è¾“å‡º <code>iptables -t nat -L</code> å³å¯æŸ¥çœ‹ iptables è§„åˆ™ã€‚</p>
<h2 id="iptables-æµé‡åŠ«æŒè¿‡ç¨‹è¯¦è§£">iptables æµé‡åŠ«æŒè¿‡ç¨‹è¯¦è§£</h2>
<p>ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œä½ å·²ç»å¯ä»¥æŸ¥çœ‹åˆ° init å®¹å™¨å‘ Pod ä¸­æ³¨å…¥çš„ iptables è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># PREROUTING é“¾ï¼šç”¨äºç›®æ ‡åœ°å€è½¬æ¢ï¼ˆDNATï¼‰ï¼Œå°†æ‰€æœ‰å…¥ç«™ TCP æµé‡è·³è½¬åˆ° ISTIO_INBOUND é“¾ä¸Šã€‚</span>
</span></span><span class="line"><span class="cl">Chain PREROUTING <span class="o">(</span>policy ACCEPT <span class="m">2701</span> packets, 162K bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"> <span class="m">2701</span>  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># INPUT é“¾ï¼šå¤„ç†è¾“å…¥æ•°æ®åŒ…ï¼Œé TCP æµé‡å°†ç»§ç»­ OUTPUT é“¾ã€‚</span>
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">2701</span> packets, 162K bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OUTPUT é“¾ï¼šå°†æ‰€æœ‰å‡ºç«™æ•°æ®åŒ…è·³è½¬åˆ° ISTIO_OUTPUT é“¾ä¸Šã€‚</span>
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">79</span> packets, <span class="m">6761</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">   <span class="m">15</span>   <span class="m">900</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># POSTROUTING é“¾ï¼šæ‰€æœ‰æ•°æ®åŒ…æµå‡ºç½‘å¡æ—¶éƒ½è¦å…ˆè¿›å…¥ POSTROUTING é“¾ï¼Œå†…æ ¸æ ¹æ®æ•°æ®åŒ…ç›®çš„åœ°åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬å‘å‡ºå»ï¼Œæˆ‘ä»¬çœ‹åˆ°æ­¤å¤„æœªåšä»»ä½•å¤„ç†ã€‚</span>
</span></span><span class="line"><span class="cl">Chain POSTROUTING <span class="o">(</span>policy ACCEPT <span class="m">79</span> packets, <span class="m">6761</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ISTIO_INBOUND é“¾ï¼šå°†æ‰€æœ‰å…¥ç«™æµé‡é‡å®šå‘åˆ° ISTIO_IN_REDIRECT é“¾ä¸Šã€‚ç›®çš„åœ°ä¸º 15090ï¼ˆPrometheus ä½¿ç”¨ï¼‰å’Œ 15020ï¼ˆIngress gateway ä½¿ç”¨ï¼Œç”¨äº Pilot å¥åº·æ£€æŸ¥ï¼‰ç«¯å£çš„æµé‡é™¤å¤–ï¼Œå‘é€åˆ°ä»¥ä¸Šä¸¤ä¸ªç«¯å£çš„æµé‡å°†è¿”å› iptables è§„åˆ™é“¾çš„è°ƒç”¨ç‚¹ï¼Œå³ PREROUTING é“¾çš„åç»§ POSTROUTING åç›´æ¥è°ƒç”¨åŸå§‹ç›®çš„åœ°ã€‚</span>
</span></span><span class="line"><span class="cl">Chain ISTIO_INBOUND <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
</span></span><span class="line"><span class="cl">    <span class="m">2</span>   <span class="m">120</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
</span></span><span class="line"><span class="cl"> <span class="m">2699</span>  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ISTIO_IN_REDIRECT é“¾ï¼šå°†æ‰€æœ‰çš„å…¥ç«™æµé‡è·³è½¬åˆ°æœ¬åœ°çš„ 15006 ç«¯å£ï¼Œè‡³æ­¤æˆåŠŸçš„æ‹¦æˆªäº†æµé‡åˆ° sidecar ä»£ç†çš„ Inbound Handler ä¸­ã€‚</span>
</span></span><span class="line"><span class="cl">Chain ISTIO_IN_REDIRECT <span class="o">(</span><span class="m">3</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class="m">15006</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ISTIO_OUTPUT é“¾ï¼šè§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œå°†åœ¨ä¸‹æ–‡è§£é‡Š</span>
</span></span><span class="line"><span class="cl">Chain ISTIO_OUTPUT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere <span class="c1">#è§„åˆ™1</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span class="m">1337</span> <span class="c1">#è§„åˆ™2</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span class="m">1337</span> <span class="c1">#è§„åˆ™3</span>
</span></span><span class="line"><span class="cl">   <span class="m">15</span>   <span class="m">900</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span class="m">1337</span> <span class="c1">#è§„åˆ™4</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span class="m">1337</span> <span class="c1">#è§„åˆ™5</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span class="m">1337</span> <span class="c1">#è§„åˆ™6</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span class="m">1337</span> <span class="c1">#è§„åˆ™7</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> RETURN     all  --  any    any     anywhere             localhost <span class="c1">#è§„åˆ™8</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere <span class="c1">#è§„åˆ™9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ISTIO_REDIRECT é“¾ï¼šå°†æ‰€æœ‰æµé‡é‡å®šå‘åˆ° Envoy ä»£ç†çš„ 15001 ç«¯å£ã€‚</span>
</span></span><span class="line"><span class="cl">Chain ISTIO_REDIRECT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class="m">15001</span>
</span></span></code></pre></div><p>è¿™é‡Œç€é‡éœ€è¦è§£é‡Šçš„æ˜¯ <code>ISTIO_OUTPUT</code> é“¾ä¸­çš„ 9 æ¡è§„åˆ™ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œæˆ‘å°†ä»¥ä¸Šè§„åˆ™ä¸­çš„éƒ¨åˆ†å†…å®¹ä½¿ç”¨è¡¨æ ¼çš„å½¢å¼æ¥å±•ç¤ºå¦‚ä¸‹ï¼š</p>

<table>
<thead>
<tr>
<th><strong>è§„åˆ™</strong></th>
<th><strong>target</strong></th>
<th><strong>in</strong></th>
<th><strong>out</strong></th>
<th><strong>source</strong></th>
<th><strong>destination</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>RETURN</td>
<td>any</td>
<td>lo</td>
<td>127.0.0.6</td>
<td>anywhere</td>
</tr>
<tr>
<td>2</td>
<td>ISTIO_IN_REDIRECT</td>
<td>any</td>
<td>lo</td>
<td>anywhere</td>
<td>!localhost owner UID match 1337</td>
</tr>
<tr>
<td>3</td>
<td>RETURN</td>
<td>any</td>
<td>lo</td>
<td>anywhere</td>
<td>anywhere !owner UID match 1337</td>
</tr>
<tr>
<td>4</td>
<td>RETURN</td>
<td>any</td>
<td>any</td>
<td>anywhere</td>
<td>anywhere owner UID match 1337</td>
</tr>
<tr>
<td>5</td>
<td>ISTIO_IN_REDIRECT</td>
<td>any</td>
<td>lo</td>
<td>anywhere</td>
<td>!localhost owner GID match 1337</td>
</tr>
<tr>
<td>6</td>
<td>RETURN</td>
<td>any</td>
<td>lo</td>
<td>anywhere</td>
<td>anywhere !owner GID match 1337</td>
</tr>
<tr>
<td>7</td>
<td>RETURN</td>
<td>any</td>
<td>any</td>
<td>anywhere</td>
<td>anywhere owner GID match 1337</td>
</tr>
<tr>
<td>8</td>
<td>RETURN</td>
<td>any</td>
<td>any</td>
<td>anywhere</td>
<td>localhost</td>
</tr>
<tr>
<td>9</td>
<td>ISTIO_REDIRECT</td>
<td>any</td>
<td>any</td>
<td>anywhere</td>
<td>anywhere</td>
</tr>
</tbody>
</table>

<figcaption class="text-center">
    ISTIO_OUTPUT é“¾ä¸­çš„è·¯ç”±è§„åˆ™
</figcaption>

<p>ä¸‹å›¾å±•ç¤ºäº† <code>ISTIO_ROUTE</code> è§„åˆ™çš„è¯¦ç»†æµç¨‹ã€‚</p>
<figure class="mx-auto text-center">
    <img src="istio-route-iptables.svg" loading="lazy" decoding="async"
         alt="Istio_ROUTE iptalbes è§„åˆ™åˆ¤æ–­æµç¨‹å›¾" width="70%"data-img="istio-route-iptables.svg"
         data-caption="å›¾ç‰‡"
         
         
         
    /><figcaption>
            Istio_ROUTE iptalbes è§„åˆ™åˆ¤æ–­æµç¨‹å›¾
        </figcaption>
</figure>

<p>æˆ‘å°†æŒ‰ç…§è§„åˆ™çš„å‡ºç°é¡ºåºæ¥è§£é‡Šæ¯æ¡è§„åˆ™çš„ç›®çš„ã€å¯¹åº”æ–‡ç« å¼€å¤´å›¾ç¤ºä¸­çš„æ­¥éª¤åŠè¯¦æƒ…ã€‚å…¶ä¸­è§„åˆ™ 5ã€6ã€7 æ˜¯åˆ†åˆ«å¯¹è§„åˆ™ 2ã€3ã€4 çš„åº”ç”¨èŒƒå›´æ‰©å¤§ï¼ˆä» UID æ‰©å¤§ä¸º GIDï¼‰ï¼Œä½œç”¨æ˜¯ç±»ä¼¼çš„ï¼Œå°†åˆå¹¶è§£é‡Šã€‚æ³¨æ„ï¼Œå…¶ä¸­çš„è§„åˆ™æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ’åºè¶Šé åçš„è§„åˆ™å°†ä½œä¸ºé»˜è®¤å€¼ã€‚å‡ºç«™ç½‘å¡ï¼ˆoutï¼‰ä¸º <code>lo</code> ï¼ˆæœ¬åœ°å›ç¯åœ°å€ï¼Œloopback æ¥å£ï¼‰æ—¶ï¼Œè¡¨ç¤ºæµé‡çš„ç›®çš„åœ°æ˜¯æœ¬åœ° Podï¼Œå¯¹äº Pod å‘å¤–éƒ¨å‘é€çš„æµé‡å°±ä¸ä¼šç»è¿‡è¿™ä¸ªæ¥å£ã€‚æ‰€æœ‰ <code>review</code> Pod çš„å‡ºç«™æµé‡åªé€‚ç”¨äºè§„åˆ™ 4ã€7ã€8ã€9ã€‚</p>
<p><strong>è§„åˆ™ 1</strong></p>
<ul>
<li>ç›®çš„ï¼š<strong>é€ä¼ </strong> Envoy ä»£ç†å‘é€åˆ°æœ¬åœ°åº”ç”¨å®¹å™¨çš„æµé‡ï¼Œä½¿å…¶ç»•è¿‡ Envoy ä»£ç†ï¼Œç›´è¾¾åº”ç”¨å®¹å™¨ã€‚</li>
<li>å¯¹åº”å›¾ç¤ºä¸­çš„æ­¥éª¤ï¼š6 åˆ° 7ã€‚</li>
<li>è¯¦æƒ…ï¼šè¯¥è§„åˆ™ä½¿å¾—æ‰€æœ‰æ¥è‡ª <code>127.0.0.6</code>ï¼ˆè¯¥ IP åœ°å€å°†åœ¨ä¸‹æ–‡è§£é‡Šï¼‰ çš„è¯·æ±‚ï¼Œè·³å‡ºè¯¥é“¾ï¼Œè¿”å› iptables çš„è°ƒç”¨ç‚¹ï¼ˆå³ <code>OUTPUT</code>ï¼‰åç»§ç»­æ‰§è¡Œå…¶ä½™è·¯ç”±è§„åˆ™ï¼Œå³ <code>POSTROUTING</code> è§„åˆ™ï¼ŒæŠŠæµé‡å‘é€åˆ°ä»»æ„ç›®çš„åœ°å€ï¼Œå¦‚æœ¬åœ° Pod å†…çš„åº”ç”¨å®¹å™¨ã€‚å¦‚æœæ²¡æœ‰è¿™æ¡è§„åˆ™ï¼Œç”± Pod å†… Envoy ä»£ç†å‘å‡ºçš„å¯¹ Pod å†…å®¹å™¨è®¿é—®çš„æµé‡å°†ä¼šæ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ï¼Œå³è§„åˆ™ 2ï¼Œæµé‡å°†å†æ¬¡è¿›å…¥åˆ°äº† Inbound Handler ä¸­ï¼Œä»è€Œå½¢æˆäº†æ­»å¾ªç¯ã€‚å°†è¿™æ¡è§„åˆ™æ”¾åœ¨ç¬¬ä¸€ä½å¯ä»¥é¿å…æµé‡åœ¨ Inbound Handler ä¸­æ­»å¾ªç¯çš„é—®é¢˜ã€‚</li>
</ul>
<p><strong>è§„åˆ™ 2ã€5</strong></p>
<ul>
<li>ç›®çš„ï¼šå¤„ç† Envoy ä»£ç†å‘å‡ºçš„ç«™å†…æµé‡ï¼ˆPod å†…éƒ¨çš„æµé‡ï¼‰ï¼Œä½†ä¸æ˜¯å¯¹ localhost çš„è¯·æ±‚ï¼Œé€šè¿‡åç»­è§„åˆ™å°†å…¶è½¬å‘ç»™ Envoy ä»£ç†çš„ Inbound Handlerã€‚è¯¥è§„åˆ™é€‚ç”¨äº Pod å¯¹è‡ªèº« IP åœ°å€è°ƒç”¨çš„åœºæ™¯ï¼Œå³ Pod å†…æœåŠ¡ä¹‹é—´çš„è®¿é—®ã€‚</li>
<li>è¯¦æƒ…ï¼šå¦‚æœæµé‡çš„ç›®çš„åœ°é localhostï¼Œä¸”æ•°æ®åŒ…æ˜¯ç”± 1337 UIDï¼ˆå³ <code>istio-proxy</code> ç”¨æˆ·ï¼ŒEnvoy ä»£ç†ï¼‰å‘å‡ºçš„ï¼Œæµé‡å°†è¢«ç»è¿‡ <code>ISTIO_IN_REDIRECT</code> æœ€ç»ˆè½¬å‘åˆ° Envoy çš„ Inbound Handlerã€‚</li>
</ul>
<p><strong>è§„åˆ™ 3ã€6</strong></p>
<ul>
<li>ç›®çš„ï¼š<strong>é€ä¼ </strong> Pod å†…çš„åº”ç”¨å®¹å™¨çš„ç«™å†…æµé‡ã€‚è¯¥è§„åˆ™é€‚ç”¨äºå®¹å™¨å†…éƒ¨çš„æµé‡ã€‚ä¾‹å¦‚åœ¨ Pod å†…å¯¹ Pod IP æˆ– localhost çš„è®¿é—®ã€‚</li>
<li>å¯¹åº”å›¾ç¤ºä¸­çš„æ­¥éª¤ï¼š6 åˆ° 7ã€‚</li>
<li>è¯¦æƒ…ï¼šå¦‚æœæµé‡ä¸æ˜¯ç”± Envoy ç”¨æˆ·å‘å‡ºçš„ï¼Œé‚£ä¹ˆå°±è·³å‡ºè¯¥é“¾ï¼Œè¿”å› <code>OUTPUT</code> è°ƒç”¨ <code>POSTROUTING</code>ï¼Œç›´è¾¾ç›®çš„åœ°ã€‚</li>
</ul>
<p><strong>è§„åˆ™ 4ã€7</strong></p>
<ul>
<li>ç›®çš„ï¼š<strong>é€ä¼ </strong>  Envoy ä»£ç†å‘å‡ºçš„å‡ºç«™è¯·æ±‚ã€‚</li>
<li>å¯¹åº”å›¾ç¤ºä¸­çš„æ­¥éª¤ï¼š14 åˆ° 15ã€‚</li>
<li>è¯¦æƒ…ï¼šå¦‚æœè¯·æ±‚æ˜¯ç”± Envoy ä»£ç†å‘å‡ºçš„ï¼Œåˆ™è¿”å› <code>OUTPUT</code> ç»§ç»­è°ƒç”¨ <code>POSTROUTING</code> è§„åˆ™ï¼Œæœ€ç»ˆç›´æ¥è®¿é—®ç›®çš„åœ°ã€‚</li>
</ul>
<p><strong>è§„åˆ™ 8</strong></p>
<ul>
<li>ç›®çš„ï¼š<strong>é€ä¼ </strong> Pod å†…éƒ¨å¯¹ localhost çš„è¯·æ±‚ã€‚</li>
<li>è¯¦æƒ…ï¼šå¦‚æœè¯·æ±‚çš„ç›®çš„åœ°æ˜¯ localhostï¼Œåˆ™è¿”å› OUTPUT è°ƒç”¨ <code>POSTROUTING</code>ï¼Œç›´æ¥è®¿é—® localhostã€‚</li>
</ul>
<p><strong>è§„åˆ™ 9</strong></p>
<ul>
<li>ç›®çš„ï¼šæ‰€æœ‰å…¶ä»–çš„æµé‡å°†è¢«è½¬å‘åˆ° <code>ISTIO_REDIRECT</code> åï¼Œæœ€ç»ˆè¾¾åˆ° Envoy ä»£ç†çš„ Outbound Handlerã€‚</li>
<li>å¯¹åº”å›¾ç¤ºä¸­çš„æ­¥éª¤ï¼š10 åˆ° 11ã€‚</li>
</ul>
<p>ä»¥ä¸Šè§„åˆ™é¿å…äº† Envoy ä»£ç†åˆ°åº”ç”¨ç¨‹åºçš„è·¯ç”±åœ¨ iptables è§„åˆ™ä¸­çš„æ­»å¾ªç¯ï¼Œä¿éšœäº†æµé‡å¯ä»¥è¢«æ­£ç¡®çš„è·¯ç”±åˆ° Envoy ä»£ç†ä¸Šï¼Œä¹Ÿå¯ä»¥å‘å‡ºçœŸæ­£çš„å‡ºç«™è¯·æ±‚ã€‚</p>
<p><strong>å…³äº RETURN target</strong></p>
<p>ä½ å¯èƒ½ç•™æ„åˆ°ä¸Šè¿°è§„åˆ™ä¸­æœ‰å¾ˆå¤š RETURN targetï¼Œå®ƒçš„æ„æ€æ˜¯ï¼ŒæŒ‡å®šåˆ°è¿™æ¡è§„åˆ™æ—¶ï¼Œè·³å‡ºè¯¥è§„åˆ™é“¾ï¼Œè¿”å› iptables çš„è°ƒç”¨ç‚¹ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å³ <code>OUTPUT</code>ï¼‰åç»§ç»­æ‰§è¡Œå…¶ä½™è·¯ç”±è§„åˆ™ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å³ <code>POSTROUTING</code> è§„åˆ™ï¼ŒæŠŠæµé‡å‘é€åˆ°ä»»æ„ç›®çš„åœ°å€ï¼Œä½ å¯ä»¥æŠŠå®ƒç›´è§‚çš„ç†è§£ä¸º<strong>é€ä¼ </strong>ã€‚</p>
<p><strong>å…³äº 127.0.0.6 IP åœ°å€</strong></p>
<p>127.0.0.6 è¿™ä¸ª IP æ˜¯ Istio ä¸­é»˜è®¤çš„ <code>InboundPassthroughClusterIpv4</code>ï¼Œåœ¨ Istio çš„ä»£ç ä¸­æŒ‡å®šã€‚å³æµé‡åœ¨è¿›å…¥ Envoy ä»£ç†åè¢«ç»‘å®šçš„ IP åœ°å€ï¼Œä½œç”¨æ˜¯è®© Outbound æµé‡é‡æ–°å‘é€åˆ°  Pod ä¸­çš„åº”ç”¨å®¹å™¨ï¼Œå³ <strong>Passthoughtï¼ˆé€ä¼ ï¼‰ï¼Œç»•è¿‡ Outbound Handler</strong>ã€‚è¯¥æµé‡æ˜¯å¯¹ Pod è‡ªèº«çš„è®¿é—®ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„å¯¹å¤–æµé‡ã€‚è‡³äºä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ª IP ä½œä¸ºæµé‡é€ä¼ ï¼Œè¯·å‚è€ƒ <a href="https://github.com/istio/istio/issues/29603" title="Istio Issue-29603" target="_blank" rel="noopener">Istio Issue-29603</a>
ã€‚</p>
<h2 id="æµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£">æµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£</h2>
<p>é€šè¿‡ä¸Šæ–‡ï¼Œä½ å·²ç»äº†è§£äº† Istio æ˜¯å¦‚ä½•åœ¨ Pod ä¸­åšé€æ˜æµé‡åŠ«æŒçš„ï¼Œé‚£ä¹ˆæµé‡è¢«åŠ«æŒåˆ° Envoy ä»£ç†ä¸­ä¹‹åæ˜¯å¦‚ä½•è¢«å¤„ç†çš„å‘¢ï¼Ÿæµé‡è·¯ç”±åˆ†ä¸º Inbound å’Œ Outbound ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢å°†æ ¹æ®ä¸Šæ–‡ä¸­çš„ç¤ºä¾‹åŠ sidecar çš„é…ç½®ä¸ºè¯»è€…è¯¦ç»†åˆ†ææ­¤è¿‡ç¨‹ã€‚</p>
<h3 id="ç†è§£-inbound-handler">ç†è§£ Inbound Handler</h3>
<p>Inbound Handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„ downstream çš„æµé‡è½¬å‘ç»™ Pod å†…çš„åº”ç”¨ç¨‹åºå®¹å™¨ã€‚åœ¨æˆ‘ä»¬çš„å®ä¾‹ä¸­ï¼Œå‡è®¾å…¶ä¸­ä¸€ä¸ª Pod çš„åå­—æ˜¯ <code>reviews-v1-545db77b95-jkgv2</code>ï¼Œè¿è¡Œ <code>istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006</code> æŸ¥çœ‹è¯¥ Pod ä¸­ 15006 ç«¯å£ä¸Šçš„ç›‘å¬å™¨æƒ…å†µ ï¼Œä½ å°†çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">ADDRESS PORT  MATCH                                                                                           DESTINATION</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                           InboundPassthroughClusterIpv4</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080||</span>
</span></span><span class="line"><span class="cl"><span class="na">0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080                                                                 Cluster: inbound|9080||</span>
</span></span></code></pre></div><p>ä¸‹é¢åˆ—å‡ºäº†ä»¥ä¸Šè¾“å‡ºä¸­å„å­—æ®µçš„å«ä¹‰ï¼š</p>
<ul>
<li>ADDRESSï¼šä¸‹æ¸¸åœ°å€</li>
<li>PORTï¼šEnvoy ç›‘å¬å™¨ç›‘å¬çš„ç«¯å£</li>
<li>MATCHï¼šè¯·æ±‚ä½¿ç”¨çš„ä¼ è¾“åè®®æˆ–åŒ¹é…çš„ä¸‹æ¸¸åœ°å€</li>
<li>DESTINATIONï¼šè·¯ç”±ç›®çš„åœ°</li>
</ul>
<p><code>reviews</code> Pod ä¸­çš„ Iptables å°†å…¥ç«™æµé‡åŠ«æŒåˆ° 15006 ç«¯å£ä¸Šï¼Œä»ä¸Šé¢çš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Envoy çš„ Inbound Handler åœ¨ 15006 ç«¯å£ä¸Šç›‘å¬ï¼Œå¯¹ç›®çš„åœ°ä¸ºä»»ä½• IP çš„ 9080 ç«¯å£çš„è¯·æ±‚å°†è·¯ç”±åˆ° <code>inbound|9080||</code> Cluster ä¸Šã€‚</p>
<p>ä»è¯¥ Pod çš„ Listener åˆ—è¡¨çš„æœ€åä¸¤è¡Œä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>0.0.0.0:15006/TCP</code> çš„ Listenerï¼ˆå…¶å®é™…åå­—æ˜¯ <code>virtualInbound</code>ï¼‰ç›‘å¬æ‰€æœ‰çš„ Inbound æµé‡ï¼Œå…¶ä¸­åŒ…å«äº†åŒ¹é…è§„åˆ™ï¼Œæ¥è‡ªä»»æ„ IP çš„å¯¹ <code>9080</code> ç«¯å£çš„è®¿é—®æµé‡ï¼Œå°†ä¼šè·¯ç”±åˆ° <code>inbound|9080||</code> Clusterï¼Œå¦‚æœä½ æƒ³ä»¥ Json æ ¼å¼æŸ¥çœ‹è¯¥ Listener çš„è¯¦ç»†é…ç½®ï¼Œå¯ä»¥æ‰§è¡Œ <code>istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json</code> å‘½ä»¤ï¼Œä½ å°†è·å¾—ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;virtualInbound&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">15006</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;filterChains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;filterChainMatch&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;destinationPort&#34;</span><span class="p">:</span> <span class="mi">9080</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;transportProtocol&#34;</span><span class="p">:</span> <span class="s2">&#34;tls&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;applicationProtocols&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;istio&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;istio-http/1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;istio-http/1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;istio-h2&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.http_connection_manager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;typedConfig&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;statPrefix&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_0.0.0.0_9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;routeConfig&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;virtualHosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|http|9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                            <span class="s2">&#34;*&#34;</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">],</span>
</span></span><span class="line"><span class="cl">                                        <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nt">&#34;prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nt">&#34;maxStreamDuration&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nt">&#34;maxStreamDuration&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                        <span class="nt">&#34;grpcTimeoutHeaderMax&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span>
</span></span><span class="line"><span class="cl">                                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                                                <span class="nt">&#34;decorator&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                    <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class="line"><span class="cl">                                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">]</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;validateClusters&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">                            <span class="p">},</span>
</span></span><span class="line"><span class="cl">                            <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">        <span class="err">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;listenerFilters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;listenerFiltersTimeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;continueOnListenerFiltersTimeout&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;trafficDirection&#34;</span><span class="p">:</span> <span class="s2">&#34;INBOUND&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>æ—¢ç„¶ Inbound Handler çš„æµé‡ä¸­å°†æ¥è‡ªä»»æ„åœ°å€çš„å¯¹è¯¥ Pod <code>9080</code> ç«¯å£çš„æµé‡è·¯ç”±åˆ° <code>inbound|9080||</code> Clusterï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿è¡Œ <code>istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json</code> æŸ¥çœ‹ä¸‹è¯¥ Cluster é…ç½®ï¼Œä½ å°†è·å¾—ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound|9080||&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ORIGINAL_DST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;connectTimeout&#34;</span><span class="p">:</span> <span class="s2">&#34;10s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;lbPolicy&#34;</span><span class="p">:</span> <span class="s2">&#34;CLUSTER_PROVIDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;circuitBreakers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;thresholds&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxConnections&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxPendingRequests&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRequests&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRetries&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;trackRemaining&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;cleanupInterval&#34;</span><span class="p">:</span> <span class="s2">&#34;60s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;upstreamBindConfig&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sourceAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;127.0.0.6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;filterMetadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;istio&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;services&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;reviews&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹å…¶ä¸­çš„ <code>TYPE</code> ä¸º <code>ORIGINAL_DST</code>ï¼Œå°†æµé‡å‘é€åˆ°åŸå§‹ç›®æ ‡åœ°å€ï¼ˆPod IPï¼‰ï¼Œå› ä¸ºåŸå§‹ç›®æ ‡åœ°å€å³å½“å‰ Podï¼Œä½ è¿˜åº”è¯¥æ³¨æ„åˆ° <code>upstreamBindConfig.sourceAddress.address</code> çš„å€¼è¢«æ”¹å†™ä¸ºäº† <code>127.0.0.6</code>ï¼Œè€Œä¸”å¯¹äº Pod å†…æµé‡æ˜¯é€šè¿‡ <code>lo</code> ç½‘å¡å‘é€çš„ï¼Œè¿™åˆšå¥½å‘¼åº”äº†ä¸Šæ–‡ä¸­çš„ iptables <code>ISTIO_OUTPUT</code> é“¾ä¸­çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œæ ¹æ®è¯¥è§„åˆ™ï¼Œæµé‡å°†è¢«é€ä¼ åˆ° Pod å†…çš„åº”ç”¨å®¹å™¨ã€‚</p>
<h3 id="ç†è§£-outbound-handler">ç†è§£ Outbound Handler</h3>
<p>åœ¨æœ¬ç¤ºä¾‹ä¸­ <code>reviews</code> ä¼šå‘ <code>ratings</code> æœåŠ¡å‘é€ HTTP è¯·æ±‚ï¼Œè¯·æ±‚çš„åœ°å€æ˜¯ï¼š<code>http://ratings.default.svc.cluster.local:9080/</code>ï¼ŒOutbound Handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„æœ¬åœ°åº”ç”¨ç¨‹åºå‘å¤–å‘å‡ºçš„æµé‡ï¼Œç»ç”± Envoy ä»£ç†è·¯ç”±åˆ°ä¸Šæ¸¸ã€‚</p>
<p>Envoy ç›‘å¬åœ¨ 15001 ç«¯å£ä¸Šç›‘å¬æ‰€æœ‰ Outbound æµé‡ï¼ŒOutbound Handler å¤„ç†ï¼Œç„¶åç»è¿‡ <code>virtualOutbound</code> Listenerã€<code>0.0.0.0_9080</code> Listenerï¼Œç„¶åé€šè¿‡ Route 9080 æ‰¾åˆ°ä¸Šæ¸¸çš„ clusterï¼Œè¿›è€Œé€šè¿‡ EDS æ‰¾åˆ° Endpoint æ‰§è¡Œè·¯ç”±åŠ¨ä½œã€‚</p>
<p><strong><code>ratings.default.svc.cluster.local:9080</code> è·¯ç”±</strong></p>
<p>è¿è¡Œ <code>istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json</code> æŸ¥çœ‹ route é…ç½®ï¼Œå› ä¸º sidecar ä¼šæ ¹æ® HTTP header ä¸­çš„ domains æ¥åŒ¹é… VirtualHostï¼Œæ‰€ä»¥ä¸‹é¢åªåˆ—ä¸¾äº† <code>ratings.default.svc.cluster.local:9080</code> è¿™ä¸€ä¸ª VirtualHostã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;virtualHosts&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;domains&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default.svc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default.svc:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;ratings.default:9080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;10.8.8.106&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;10.8.8.106:9080&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">               <span class="p">{</span>
</span></span><span class="line"><span class="cl">                   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="p">},</span>
</span></span><span class="line"><span class="cl">                   <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;retryPolicy&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;retryOn&#34;</span><span class="p">:</span> <span class="s2">&#34;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;numRetries&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;retryHostPredicate&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                               <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.retry_host_predicates.previous_hosts&#34;</span>
</span></span><span class="line"><span class="cl">                               <span class="p">}</span>
</span></span><span class="line"><span class="cl">                           <span class="p">],</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;hostSelectionRetryMaxAttempts&#34;</span><span class="p">:</span> <span class="s2">&#34;5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;retriableStatusCodes&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">503</span>
</span></span><span class="line"><span class="cl">                           <span class="p">]</span>
</span></span><span class="line"><span class="cl">                       <span class="p">},</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;maxStreamDuration&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;maxStreamDuration&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="nt">&#34;grpcTimeoutHeaderMax&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span>
</span></span><span class="line"><span class="cl">                       <span class="p">}</span>
</span></span><span class="line"><span class="cl">                   <span class="p">},</span>
</span></span><span class="line"><span class="cl">                   <span class="nt">&#34;decorator&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                       <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class="line"><span class="cl">                   <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&#34;includeRequestAttemptCount&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">       <span class="p">},</span>
</span></span><span class="line"><span class="cl">       <span class="err">/*çœç•¥éƒ¨åˆ†å†…å®¹*/</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&#34;validateClusters&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>ä»è¯¥ Virtual Host é…ç½®ä¸­å¯ä»¥çœ‹åˆ°å°†æµé‡è·¯ç”±åˆ°<code>outbound|9080||ratings.default.svc.cluster.local</code> é›†ç¾¤ã€‚</p>
<p><strong><code>outbound|9080||ratings.default.svc.cluster.local</code> é›†ç¾¤çš„ç«¯ç‚¹</strong></p>
<p>è¿è¡Œ <code>istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster &quot;outbound|9080||ratings.default.svc.cluster.local&quot;</code> æŸ¥çœ‹é›†ç¾¤çš„ Endpoint é…ç½®ï¼Œç»“æœå¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;addedViaApi&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;hostStatuses&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;socketAddress&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;10.4.1.12&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;portValue&#34;</span><span class="p">:</span> <span class="mi">9080</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;stats&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;cx_connect_fail&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;cx_total&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;rq_error&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;rq_success&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;rq_timeout&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;rq_total&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;GAUGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;cx_active&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;GAUGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;rq_active&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;healthStatus&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;edsHealthStatus&#34;</span><span class="p">:</span> <span class="s2">&#34;HEALTHY&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;locality&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;region&#34;</span><span class="p">:</span> <span class="s2">&#34;us-west2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;zone&#34;</span><span class="p">:</span> <span class="s2">&#34;us-west2-a&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;circuitBreakers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;thresholds&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxConnections&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxPendingRequests&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRequests&#34;</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRetries&#34;</span><span class="p">:</span> <span class="mi">4294967295</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;priority&#34;</span><span class="p">:</span> <span class="s2">&#34;HIGH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxConnections&#34;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxPendingRequests&#34;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRequests&#34;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;maxRetries&#34;</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;observabilityName&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°ç«¯ç‚¹çš„åœ°å€æ˜¯ <code>10.4.1.12</code>ã€‚å®é™…ä¸Šï¼ŒEndpoint å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œsidecar å°†æ ¹æ®ä¸€å®šè§„åˆ™é€‰æ‹©é€‚å½“çš„ Endpoint æ¥è·¯ç”±ã€‚è‡³æ­¤ <code>review</code> Podæ‰¾åˆ°äº†å®ƒä¸Šæ¸¸æœåŠ¡ <code>rating</code> çš„ Endpointã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2>
<p>æœ¬æ–‡ä½¿ç”¨äº† Istio å®˜æ–¹æä¾›çš„ bookinfo ç¤ºä¾‹ï¼ŒæŒ‰å›¾ç´¢éª¥å¾—å¸¦é¢†è¯»è€…äº†è§£äº† sidecar æ³¨å…¥ã€iptables é€æ˜æµé‡åŠ«æŒåŠ sidecar ä¸­æµé‡è·¯ç”±èƒŒåçš„å®ç°ç»†èŠ‚ã€‚Sidecar æ¨¡å¼å’Œæµé‡é€æ˜åŠ«æŒæ˜¯ Istio æœåŠ¡ç½‘æ ¼çš„ç‰¹è‰²å’ŒåŸºç¡€åŠŸèƒ½ï¼Œç†è§£è¯¥åŠŸèƒ½çš„èƒŒåè¿‡ç¨‹åŠå®ç°ç»†èŠ‚ï¼Œå°†æœ‰åŠ©äºå¤§å®¶ç†è§£ Service Mesh çš„åŸç†å’Œ <a href="https://www.servicemesher.com/istio-handbook/" title="Istio Handbook" target="_blank" rel="noopener">Istio Handbook</a>
 åé¢ç« èŠ‚ä¸­çš„å†…å®¹ï¼Œå› æ­¤å¸Œæœ›è¯»è€…å¯ä»¥åœ¨è‡ªå·±çš„ç¯å¢ƒä¸­ä»å¤´æ¥è¯•éªŒä¸€éä»¥åŠ æ·±ç†è§£ã€‚</p>
<p>ä½¿ç”¨ iptables åšæµé‡åŠ«æŒåªæ˜¯ service mesh çš„æ•°æ®å¹³é¢ä¸­åšæµé‡åŠ«æŒçš„æ–¹å¼ä¹‹ä¸€ï¼Œè¿˜æœ‰æ›´å¤šçš„æµé‡åŠ«æŒæ–¹æ¡ˆï¼Œä¸‹é¢å¼•ç”¨è‡ª <a href="https://mosn.io/docs/products/structure/traffic-hijack/" title="äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å®˜ç½‘ä¸­ç»™å‡ºçš„æµé‡åŠ«æŒ" target="_blank" rel="noopener">äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å®˜ç½‘ä¸­ç»™å‡ºçš„æµé‡åŠ«æŒ</a>
éƒ¨åˆ†çš„æè¿°ã€‚</p>
<h3 id="ä½¿ç”¨-iptables-åšæµé‡åŠ«æŒæ—¶å­˜åœ¨çš„é—®é¢˜">ä½¿ç”¨ iptables åšæµé‡åŠ«æŒæ—¶å­˜åœ¨çš„é—®é¢˜</h3>
<p>ç›®å‰ Istio ä½¿ç”¨ iptables å®ç°é€æ˜åŠ«æŒï¼Œä¸»è¦å­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>éœ€è¦å€ŸåŠ©äº conntrack æ¨¡å—å®ç°è¿æ¥è·Ÿè¸ªï¼Œåœ¨è¿æ¥æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä¼šé€ æˆè¾ƒå¤§çš„æ¶ˆè€—ï¼ŒåŒæ—¶å¯èƒ½ä¼šé€ æˆ track è¡¨æ»¡çš„æƒ…å†µï¼Œä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä¸šå†…æœ‰å…³é—­ conntrack çš„åšæ³•ã€‚</li>
<li>iptables å±äºå¸¸ç”¨æ¨¡å—ï¼Œå…¨å±€ç”Ÿæ•ˆï¼Œä¸èƒ½æ˜¾å¼çš„ç¦æ­¢ç›¸å…³è”çš„ä¿®æ”¹ï¼Œå¯ç®¡æ§æ€§æ¯”è¾ƒå·®ã€‚</li>
<li>iptables é‡å®šå‘æµé‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ loopback äº¤æ¢æ•°æ®ï¼Œoutbond æµé‡å°†ä¸¤æ¬¡ç©¿è¶Šåè®®æ ˆï¼Œåœ¨å¤§å¹¶å‘åœºæ™¯ä¸‹ä¼šæŸå¤±è½¬å‘æ€§èƒ½ã€‚</li>
</ol>
<p>ä¸Šè¿°å‡ ä¸ªé—®é¢˜å¹¶éåœ¨æ‰€æœ‰åœºæ™¯ä¸­éƒ½å­˜åœ¨ï¼Œæ¯”æ–¹è¯´æŸäº›åœºæ™¯ä¸‹ï¼Œè¿æ¥æ•°å¹¶ä¸å¤šï¼Œä¸” NAT è¡¨æœªè¢«ä½¿ç”¨åˆ°çš„æƒ…å†µä¸‹ï¼Œiptables æ˜¯ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ç®€å•æ–¹æ¡ˆã€‚ä¸ºäº†é€‚é…æ›´åŠ å¹¿æ³›çš„åœºæ™¯ï¼Œé€æ˜åŠ«æŒéœ€è¦è§£å†³ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜ã€‚</p>
<h3 id="é€æ˜åŠ«æŒæ–¹æ¡ˆä¼˜åŒ–">é€æ˜åŠ«æŒæ–¹æ¡ˆä¼˜åŒ–</h3>
<p>ä¸ºäº†ä¼˜åŒ– Istio ä¸­çš„é€æ˜æµé‡åŠ«æŒçš„æ€§èƒ½ï¼Œä¸šç•Œæå‡ºäº†ä»¥ä¸‹æ–¹æ¡ˆã€‚</p>
<p><strong>ä½¿ç”¨ Merbridge å¼€æºé¡¹ç›®åˆ©ç”¨ eBPF åŠ«æŒæµé‡</strong></p>
<p><a href="https://github.com/merbridge/merbridge" title="Merbridge" target="_blank" rel="noopener">Merbridge</a>
 æ˜¯ç”± DaoCloud åœ¨ 2022 å¹´åˆå¼€æºçš„çš„ä¸€æ¬¾åˆ©ç”¨ eBPF åŠ é€Ÿ Istio æœåŠ¡ç½‘æ ¼çš„æ’ä»¶ã€‚ä½¿ç”¨ Merbridge å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–æ•°æ®å¹³é¢çš„ç½‘ç»œæ€§èƒ½ã€‚</p>
<p>Merbridge åˆ©ç”¨ eBPF çš„ <code>sockops</code> å’Œ <code>redir</code> èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥å°†æ•°æ®åŒ…ä» inbound socket ä¼ è¾“åˆ° outbound socketã€‚eBPF æä¾›äº† <code>bpf_msg_redirect_hash</code> å‡½æ•°å¯ä»¥ç›´æ¥è½¬å‘åº”ç”¨ç¨‹åºçš„æ•°æ®åŒ…ã€‚</p>
<p>è¯¦è§ <a href="https://jimmysong.io/istio-handbook/ecosystem/merbridge.html" title="Istio æœåŠ¡ç½‘æ ¼ â€”â€” äº‘åŸç”Ÿåº”ç”¨ç½‘ç»œæ„å»ºæŒ‡å—" target="_blank" rel="noopener">Istio æœåŠ¡ç½‘æ ¼ â€”â€” äº‘åŸç”Ÿåº”ç”¨ç½‘ç»œæ„å»ºæŒ‡å—</a>
ã€‚</p>
<p><strong>ä½¿ç”¨ tproxy å¤„ç† inbound æµé‡</strong></p>
<p>tproxy å¯ä»¥ç”¨äº inbound æµé‡çš„é‡å®šå‘ï¼Œä¸”æ— éœ€æ”¹å˜æŠ¥æ–‡ä¸­çš„ç›®çš„ IP/ç«¯å£ï¼Œä¸éœ€è¦æ‰§è¡Œè¿æ¥è·Ÿè¸ªï¼Œä¸ä¼šå‡ºç° conntrack æ¨¡å—åˆ›å»ºå¤§é‡è¿æ¥çš„é—®é¢˜ã€‚å—é™äºå†…æ ¸ç‰ˆæœ¬ï¼Œtproxy åº”ç”¨äº outbound å­˜åœ¨ä¸€å®šç¼ºé™·ã€‚ç›®å‰ Istio æ”¯æŒé€šè¿‡ tproxy å¤„ç† inbound æµé‡ã€‚</p>
<p><strong>ä½¿ç”¨ hook connect å¤„ç† outbound æµé‡</strong></p>
<p>ä¸ºäº†é€‚é…æ›´å¤šåº”ç”¨åœºæ™¯ï¼Œoutbound æ–¹å‘é€šè¿‡ hook connect æ¥å®ç°ï¼Œå®ç°åŸç†å¦‚ä¸‹ï¼š</p>
<figure class="mx-auto text-center">
    <img src="hook-connect.svg" loading="lazy" decoding="async"
         alt="hook-connect åŸç†ç¤ºæ„å›¾" width="50%"data-img="hook-connect.svg"
         data-caption="hook-connect åŸç†ç¤ºæ„å›¾"
         
         
         
    /><figcaption>
            hook-connect åŸç†ç¤ºæ„å›¾
        </figcaption>
</figure>

<p>æ— è®ºé‡‡ç”¨å“ªç§é€æ˜åŠ«æŒæ–¹æ¡ˆï¼Œå‡éœ€è¦è§£å†³è·å–çœŸå®ç›®çš„ IP/ç«¯å£çš„é—®é¢˜ï¼Œä½¿ç”¨ iptables æ–¹æ¡ˆé€šè¿‡ getsockopt æ–¹å¼è·å–ï¼Œtproxy å¯ä»¥ç›´æ¥è¯»å–ç›®çš„åœ°å€ï¼Œé€šè¿‡ä¿®æ”¹è°ƒç”¨æ¥å£ï¼Œhook connect æ–¹æ¡ˆè¯»å–æ–¹å¼ç±»ä¼¼äº tproxyã€‚</p>
<p>å®ç°é€æ˜åŠ«æŒåï¼Œåœ¨å†…æ ¸ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ï¼ˆ4.16ä»¥ä¸Šï¼‰çš„å‰æä¸‹ï¼Œé€šè¿‡ sockmap å¯ä»¥ç¼©çŸ­æŠ¥æ–‡ç©¿è¶Šè·¯å¾„ï¼Œè¿›è€Œæ”¹å–„ outbound æ–¹å‘çš„è½¬å‘æ€§èƒ½ã€‚</p>
<h2 id="æ›´æ–°è¯´æ˜">æ›´æ–°è¯´æ˜</h2>
<p>ä¸‹é¢æ˜¯æœ¬æ–‡çš„å‡ æ¬¡æ›´æ–°è¯´æ˜ã€‚</p>
<p><strong>2020 å¹´ 4 æœˆ 27 æ—¥ï¼Œç¬¬ä¸€ç‰ˆï¼ŒåŸºäº Istio 1.5</strong></p>
<p>æœ¬æ–‡çš„ç¬¬ä¸€ç‰ˆï¼ŒåŸºäº Istio 1.5 åˆ›ä½œï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘æ›¾å†™è¿‡åŸºäº Istio 1.1 ç‰ˆæœ¬çš„<a href="/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/" title="ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ">ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒ</a>
ï¼Œä¸ºäº†æ›´ç»†è‡´çš„ç†è§£ Istio ä¸­é€æ˜æµé‡åŠ«æŒçš„å…¨è¿‡ç¨‹ï¼Œä¸“é—¨åˆ›ä½œæœ¬æ–‡ã€‚</p>
<p><strong>2022 å¹´  1 æœˆ 17 æ—¥ï¼Œç¬¬äºŒç‰ˆï¼ŒåŸºäº Istio 1.11</strong></p>
<p>æœ¬æ–‡ç¬¬ä¸€ç‰ˆå‘å¸ƒåï¼Œåœ¨ç¤¾åŒºé‡Œè·å¾—äº†æ¯”è¾ƒå¤§çš„åå“ï¼Œæ”¶åˆ°äº†å¾ˆå¤šè¯»è€…çš„è¯„è®ºå’Œç•™è¨€ã€‚åŸºäºè¿™äº›è¯„è®ºï¼Œæˆ‘ä¹Ÿå‘ç°äº†ç¬¬ä¸€ç‰ˆä¸­çš„å¾ˆå¤šé”™è¯¯ï¼Œåœ¨åŠ ä¸Š Istio ç‰ˆæœ¬å‘å¸ƒé¢‘ç¹ï¼Œåœ¨è¿‘ä¸¤å¹´çš„æ—¶é—´å†…ï¼ŒIstio å·²ç»ä½œå‡ºäº†ä¼—å¤šæ›´æ–°ï¼Œå…¶ä¸­ä¸ä¹é‡å¤§æ›´æ–°ã€‚å› æ­¤ç¬”è€…æ’°å†™äº†æœ¬æ–‡çš„ç¬¬äºŒç‰ˆï¼Œä¿®æ”¹äº†ä¹‹å‰ç‰ˆæœ¬ä¸­çš„çº°æ¼å¹¶æ ¹æ®æ—¶ä¸‹ Istio çš„æœ€æ–°ç‰ˆæœ¬æ›´æ–°äº†æœ¬æ–‡ã€‚</p>
<p>Istio 1.11 ä¸ Istio 1.1 ä¸­çš„ sidecar æ³¨å…¥å’Œæµé‡åŠ«æŒç¯èŠ‚æœ€å¤§çš„å˜åŒ–æ˜¯ï¼š</p>
<ul>
<li>iptables æ”¹ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸å†ä½¿ç”¨ shell è„šæœ¬ã€‚</li>
<li>sidecar inbound å’Œ outbound åˆ†åˆ«æŒ‡å®šäº†ç«¯å£ï¼Œè€Œä¹‹å‰æ˜¯ä½¿ç”¨åŒä¸€ä¸ªç«¯å£ï¼ˆ15001ï¼‰ã€‚</li>
</ul>
<p><strong>2022 å¹´ 4 æœˆ 24ï¼Œç¬¬ä¸‰ç‰ˆï¼ŒåŸºäº Istio  1.13</strong></p>
<p>è¿™ä¸ªç‰ˆæœ¬çš„æ–‡ç« ä¸»è¦æ˜¯æ ¹æ®å½“æ—¶ Istio çš„æœ€æ–°ç‰ˆæœ¬æ›´æ–°äº†æ–‡ç« çš„éƒ¨åˆ†å†…å®¹ï¼Œå¹¶é‡æ–°æ’ç‰ˆï¼Œå¢åŠ æ›´æ–°è¯´æ˜ã€‚</p>
<p>Istio 1.13 ç›¸æ¯” Istio 1.11 çš„å˜åŒ–æ˜¯ <code>istioctl proxy-config</code> å‘½ä»¤çš„è¾“å‡ºæœ‰äº†è¾ƒå¤§å˜åŒ–ã€‚</p>
<p><strong>2022 å¹´ 5 æœˆ 6 æ—¥ï¼Œç¬¬å››ç‰ˆï¼ŒåŸºäº Istio 1.13</strong></p>
<ul>
<li>ä¿®æ”¹äº†å¯¹ <code>ISTIO_ROUTE</code> iptables è§„åˆ™ 2ã€5 çš„è§£é‡Š</li>
<li>åœ¨ç¤ºæ„å›¾ä¸­å¢åŠ äº†è·¯å¾„ 16</li>
</ul>
<p><strong>2022 å¹´ 5 æœˆ 12 æ—¥ï¼Œç¬¬äº”ç‰ˆï¼ŒåŸºäº Istio 1.13</strong></p>
<ul>
<li>å°† iptables è¯´æ˜å’Œ sidecar æ³¨å…¥ã€init å®¹å™¨éƒ¨åˆ†ç‹¬ç«‹æˆäº†ä¸¤ç¯‡å•ç‹¬çš„åšå®¢ï¼Œä»¥ç¼©å‡åšå®¢çš„ç¯‡å¹…ï¼Œè§ <a href="/blog/istio-pod-process-lifecycle/" title="Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£">Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£</a>
å’Œ<a href="/blog/understanding-iptables/" title="ç†è§£ iptables">ç†è§£ iptables</a>
ã€‚</li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://istio.io/latest/docs/ops/diagnostic-tools/proxy-cmd/" title="Debugging Envoy and Istiod - istio.io" target="_blank" rel="noopener">Debugging Envoy and Istiod - istio.io</a>
</li>
<li><a href="https://istio.io/latest/zh/blog/2019/data-plane-setup/" title="æ­å¼€ Istio Sidecar æ³¨å…¥æ¨¡å‹çš„ç¥ç§˜é¢çº± - istio.io" target="_blank" rel="noopener">æ­å¼€ Istio Sidecar æ³¨å…¥æ¨¡å‹çš„ç¥ç§˜é¢çº± - istio.io</a>
</li>
<li><a href="https://mosn.io/docs/products/structure/traffic-hijack/" title="MOSN ä½œä¸º Sidecar ä½¿ç”¨æ—¶çš„æµé‡åŠ«æŒæ–¹æ¡ˆ - mosn.io" target="_blank" rel="noopener">MOSN ä½œä¸º Sidecar ä½¿ç”¨æ—¶çš„æµé‡åŠ«æŒæ–¹æ¡ˆ - mosn.io</a>
</li>
</ul>

          </div>

          <div class="col-12 mb-4">
            <div class="border-bottom">
          


<p class="edit-page">
<a href="https://github.com/rootsongjc/website/edit/master/content/zh/blog/sidecar-injection-iptables-and-traffic-routing/index.md">
  <i class="fa fa-pencil-square-o" aria-hidden="true"></i> ç¼–è¾‘æœ¬é¡µ
  </a>
</p>


            </div>
          </div>
          
          <div class="col-12">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light">
              
              <a href="/tags/istio" class="badge"> 
                  Istio</a> 
              <a href="/tags/iptables" class="badge">  
                  Iptables</a> 
              <a href="/tags/envoy" class="badge">  
                  Envoy</a> 
              <a href="/tags/sidecar" class="badge">  
                  Sidecar</a> </li>
          </div>

          
          
<div class="col-12">
<ul class="pager blog-pager">

<li class="previous">
<a href="https://jimmysong.io/blog/istio-pod-process-lifecycle/" data-toggle="tooltip" data-placement="top" title="Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£">&larr; ä¸Šä¸€ç¯‡</a>
</li>
 
<li class="next">
<a href="https://jimmysong.io/blog/how-to-build-istio/" data-toggle="tooltip" data-placement="top" title="å¦‚ä½•ç¼–è¯‘ Istioï¼Ÿ">ä¸‹ä¸€ç¯‡ &rarr;</a>
</li>

</ul>
</div>


          
          
          <div class="col-12">
          
           <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="zh-CN"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

          
          </div>
        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 sidebar">
      <!-- categories -->
<div class="bg-white mb-4">
  <p class="sidebar-title">
      åˆ†ç±»
  </p>
  <ul class="list-unstyled">
    <li class="border-bottom"><a href="/categories/istio" class="d-block pb-3 mt-3 text-capitalize">Istio</a></li>
    <li class="border-bottom"><a href="/categories/kubernetes" class="d-block pb-3 mt-3 text-capitalize">Kubernetes</a></li>
    <li class="border-bottom"><a href="/categories/service-mesh" class="d-block pb-3 mt-3 text-capitalize">Service mesh</a></li>
    <li class="border-bottom"><a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="d-block pb-3 mt-3 text-capitalize">äº‘åŸç”Ÿ</a></li>
    <li class="border-bottom"><a href="/categories/%e5%85%b6%e4%bb%96" class="d-block pb-3 mt-3 text-capitalize">å…¶ä»–</a></li>
    <li class="border-bottom"><a href="/categories/%e5%ae%b9%e5%99%a8" class="d-block pb-3 mt-3 text-capitalize">å®¹å™¨</a></li>
    <li class="border-bottom"><a href="/categories/%e5%bc%80%e6%ba%90" class="d-block pb-3 mt-3 text-capitalize">å¼€æº</a></li>
    <li class="border-bottom"><a href="/categories/%e6%96%87%e5%8c%96" class="d-block pb-3 mt-3 text-capitalize">æ–‡åŒ–</a></li>
    <li class="border-bottom"><a href="/categories/%e6%97%85%e8%a1%8c" class="d-block pb-3 mt-3 text-capitalize">æ—…è¡Œ</a></li>
  </ul>
</div>

<!-- tags -->
<div class="bg-white mb-4">
    <p class="sidebar-title">
    æ ‡ç­¾
    </p>
    
    
    
    
    
    
    
    
    

    <div id="tag-cloud">
        
            
            
            
            
            
            
            <a href="/tags/abac" style="font-size:0.8rem">Abac</a>
        
            
            
            
            
            
            
            <a href="/tags/aeraki" style="font-size:0.8rem">Aeraki</a>
        
            
            
            
            
            
            
            <a href="/tags/api-gateway" style="font-size:0.8rem">API gateway</a>
        
            
            
            
            
            
            
            <a href="/tags/aws" style="font-size:0.8rem">Aws</a>
        
            
            
            
            
            
            
            <a href="/tags/cloudfoundry" style="font-size:0.8rem">Cloudfoundry</a>
        
            
            
            
            
            
            
            <a href="/tags/cncf" style="font-size:1.1770432991281177rem">Cncf</a>
        
            
            
            
            
            
            
            <a href="/tags/contiv" style="font-size:1.1770432991281177rem">Contiv</a>
        
            
            
            
            
            
            
            <a href="/tags/day2" style="font-size:0.8rem">Day2</a>
        
            
            
            
            
            
            
            <a href="/tags/devops" style="font-size:0.8rem">Devops</a>
        
            
            
            
            
            
            
            <a href="/tags/docker" style="font-size:1.7057234225485516rem">Docker</a>
        
            
            
            
            
            
            
            <a href="/tags/ebpf" style="font-size:0.8rem">Ebpf</a>
        
            
            
            
            
            
            
            <a href="/tags/envoy" style="font-size:1.4149311349327904rem">Envoy</a>
        
            
            
            
            
            
            
            <a href="/tags/github" style="font-size:0.8rem">Github</a>
        
            
            
            
            
            
            
            <a href="/tags/hadoop" style="font-size:0.8rem">Hadoop</a>
        
            
            
            
            
            
            
            <a href="/tags/helm" style="font-size:0.8rem">Helm</a>
        
            
            
            
            
            
            
            <a href="/tags/how-to" style="font-size:0.8rem">How to</a>
        
            
            
            
            
            
            
            <a href="/tags/hugo" style="font-size:0.8rem">Hugo</a>
        
            
            
            
            
            
            
            <a href="/tags/infoq" style="font-size:0.8rem">Infoq</a>
        
            
            
            
            
            
            
            <a href="/tags/iptables" style="font-size:1.1770432991281177rem">Iptables</a>
        
            
            
            
            
            
            
            <a href="/tags/istio" style="font-size:1.9894391790233632rem">Istio</a>
        
            
            
            
            
            
            
            <a href="/tags/katacoda" style="font-size:0.8rem">Katacoda</a>
        
            
            
            
            
            
            
            <a href="/tags/kubernetes" style="font-size:1.6229567008718824rem">Kubernetes</a>
        
            
            
            
            
            
            
            <a href="/tags/multicluster" style="font-size:0.8rem">Multicluster</a>
        
            
            
            
            
            
            
            <a href="/tags/ngac" style="font-size:0.8rem">Ngac</a>
        
            
            
            
            
            
            
            <a href="/tags/nocalhost" style="font-size:0.8rem">Nocalhost</a>
        
            
            
            
            
            
            
            <a href="/tags/oam" style="font-size:0.8rem">Oam</a>
        
            
            
            
            
            
            
            <a href="/tags/obs" style="font-size:0.8rem">Obs</a>
        
            
            
            
            
            
            
            <a href="/tags/rbac" style="font-size:0.8rem">Rbac</a>
        
            
            
            
            
            
            
            <a href="/tags/service-mesh" style="font-size:1.6528189707374632rem">Service mesh</a>
        
            
            
            
            
            
            
            <a href="/tags/sidecar" style="font-size:1.3523584493868213rem">Sidecar</a>
        
            
            
            
            
            
            
            <a href="/tags/slime" style="font-size:1.0378878358046726rem">Slime</a>
        
            
            
            
            
            
            
            <a href="/tags/spiffe" style="font-size:1.0378878358046726rem">Spiffe</a>
        
            
            
            
            
            
            
            <a href="/tags/spire" style="font-size:1.0378878358046726rem">Spire</a>
        
            
            
            
            
            
            
            <a href="/tags/swarm" style="font-size:0.8rem">Swarm</a>
        
            
            
            
            
            
            
            <a href="/tags/telepresence" style="font-size:0.8rem">Telepresence</a>
        
            
            
            
            
            
            
            <a href="/tags/tetrate" style="font-size:1.0378878358046726rem">Tetrate</a>
        
            
            
            
            
            
            
            <a href="/tags/thenewstack" style="font-size:1.0378878358046726rem">Thenewstack</a>
        
            
            
            
            
            
            
            <a href="/tags/tsb" style="font-size:0.8rem">Tsb</a>
        
            
            
            
            
            
            
            <a href="/tags/vagrant" style="font-size:0.8rem">Vagrant</a>
        
            
            
            
            
            
            
            <a href="/tags/wercker" style="font-size:0.8rem">Wercker</a>
        
            
            
            
            
            
            
            <a href="/tags/yarn" style="font-size:0.8rem">Yarn</a>
        
            
            
            
            
            
            
            <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F" style="font-size:1.1770432991281177rem">äº‘åŸç”Ÿ</a>
        
            
            
            
            
            
            
            <a href="/tags/%E5%9B%BE%E4%B9%A6" style="font-size:1.513663507414018rem">å›¾ä¹¦</a>
        
            
            
            
            
            
            
            <a href="/tags/%E5%AE%89%E5%85%A8" style="font-size:1.0378878358046726rem">å®‰å…¨</a>
        
            
            
            
            
            
            
            <a href="/tags/%E5%BC%80%E6%BA%90" style="font-size:0.8rem">å¼€æº</a>
        
            
            
            
            
            
            
            <a href="/tags/%E6%96%87%E5%8C%96" style="font-size:1.0378878358046726rem">æ–‡åŒ–</a>
        
            
            
            
            
            
            
            <a href="/tags/%E6%97%85%E8%A1%8C" style="font-size:0.8rem">æ—…è¡Œ</a>
        
            
            
            
            
            
            
            <a href="/tags/%E7%9B%B4%E6%92%AD" style="font-size:0.8rem">ç›´æ’­</a>
        
            
            
            
            
            
            
            <a href="/tags/%E8%B6%8B%E5%8A%BF" style="font-size:0.8rem">è¶‹åŠ¿</a>
        
            
            
            
            
            
            
            <a href="/tags/%E8%BA%AB%E4%BB%BD" style="font-size:0.8rem">èº«ä»½</a>
        
            
            
            
            
            
            
            <a href="/tags/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81" style="font-size:0.8rem">èº«ä»½è®¤è¯</a>
        
            
            
            
            
            
            
            <a href="/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB" style="font-size:1.0378878358046726rem">é›¶ä¿¡ä»»</a>
        
    </div>

</div>

      <!-- recommend -->
      

<div class="bg-white md-4">
  <p class="sidebar-title">
  ç›¸å…³æ–‡ç« 
  </p>
  <!-- post-item -->
  
  <div class="media border-bottom border-color pb-3 mb-3">
    <a href="/blog/istio-sidecar-traffic-types/"><img class="mr-3 post-thumb-sm" src="/images/banner/mirror.jpg" alt="blog banner"></a>
    <div class="media-body">
      <a href="/blog/istio-sidecar-traffic-types/">
        <p class="mt-0">Istio sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£</p>
      </a>
      2022å¹´5æœˆ7æ—¥
    </div>
  </div>
  
  <div class="media border-bottom border-color pb-3 mb-3">
    <a href="/blog/istio-pod-process-lifecycle/"><img class="mr-3 post-thumb-sm" src="/images/banner/istio-pod-process-lifecycle.jpg" alt="blog banner"></a>
    <div class="media-body">
      <a href="/blog/istio-pod-process-lifecycle/">
        <p class="mt-0">Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£</p>
      </a>
      2022å¹´5æœˆ12æ—¥
    </div>
  </div>
  
  <div class="media border-bottom border-color pb-3 mb-3">
    <a href="/blog/istio-components-and-ports/"><img class="mr-3 post-thumb-sm" src="/images/banner/istio-ports.jpg" alt="blog banner"></a>
    <div class="media-body">
      <a href="/blog/istio-components-and-ports/">
        <p class="mt-0">Istio ä¸­çš„å„ç»„ä»¶ç«¯å£åŠåŠŸèƒ½è¯¦è§£</p>
      </a>
      2022å¹´5æœˆ8æ—¥
    </div>
  </div>
  
</div>


      <!-- /recommend -->
      <!-- toc -->
      
<div class="bg-white py-4 box-shadow mb-4 sticky-top aside-toc d-none d-sm-block">
    <p class="sidebar-title">
    ç›®å½•
    </p>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#å†…å®¹ä»‹ç»">å†…å®¹ä»‹ç»</a></li>
    <li><a href="#sidecar-æ¨¡å¼">Sidecar æ¨¡å¼</a>
      <ul>
        <li><a href="#ä½¿ç”¨-sidecar-æ¨¡å¼çš„ä¼˜åŠ¿">ä½¿ç”¨ Sidecar æ¨¡å¼çš„ä¼˜åŠ¿</a></li>
      </ul>
    </li>
    <li><a href="#sidecar-æ³¨å…¥ç¤ºä¾‹åˆ†æ">Sidecar æ³¨å…¥ç¤ºä¾‹åˆ†æ</a></li>
    <li><a href="#iptables-è§„åˆ™æ³¨å…¥è§£æ">iptables è§„åˆ™æ³¨å…¥è§£æ</a>
      <ul>
        <li><a href="#åœ¨-minikube-ä¸­æŸ¥çœ‹å®¹å™¨ä¸­çš„-iptabes-è§„åˆ™">åœ¨ minikube ä¸­æŸ¥çœ‹å®¹å™¨ä¸­çš„ iptabes è§„åˆ™</a></li>
        <li><a href="#åœ¨-gke-ä¸­æŸ¥çœ‹å®¹å™¨çš„-iptables-è§„åˆ™">åœ¨ GKE ä¸­æŸ¥çœ‹å®¹å™¨çš„ iptables è§„åˆ™</a></li>
      </ul>
    </li>
    <li><a href="#iptables-æµé‡åŠ«æŒè¿‡ç¨‹è¯¦è§£">iptables æµé‡åŠ«æŒè¿‡ç¨‹è¯¦è§£</a></li>
    <li><a href="#æµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£">æµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£</a>
      <ul>
        <li><a href="#ç†è§£-inbound-handler">ç†è§£ Inbound Handler</a></li>
        <li><a href="#ç†è§£-outbound-handler">ç†è§£ Outbound Handler</a></li>
      </ul>
    </li>
    <li><a href="#å°ç»“">å°ç»“</a>
      <ul>
        <li><a href="#ä½¿ç”¨-iptables-åšæµé‡åŠ«æŒæ—¶å­˜åœ¨çš„é—®é¢˜">ä½¿ç”¨ iptables åšæµé‡åŠ«æŒæ—¶å­˜åœ¨çš„é—®é¢˜</a></li>
        <li><a href="#é€æ˜åŠ«æŒæ–¹æ¡ˆä¼˜åŒ–">é€æ˜åŠ«æŒæ–¹æ¡ˆä¼˜åŒ–</a></li>
      </ul>
    </li>
    <li><a href="#æ›´æ–°è¯´æ˜">æ›´æ–°è¯´æ˜</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
</div>

      <!-- /toc -->
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>



      
    

<footer>
  
  <div class="footer bg-footer section-sm border-bottom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-sm-8 mb-5 mb-lg-0">
          
          <h4 class="text-white mb-5 text-uppercase">å…³æ³¨æˆ‘</h4>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">æ‰«ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="128px" alt="footer image"></li>
            
            
            
          
        </div>
        
        

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">åšå®¢</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/how-to-integrate-spire-with-istio/">å¦‚ä½•åœ¨ Istio ä¸­é›†æˆ SPIREï¼Ÿ</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/cloud-and-devops-trend-2022/">2022 å¹´äº‘å’Œ DevOps è¶‹åŠ¿æŠ¥å‘Š</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/what-is-zero-trust/">ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»ï¼Ÿ</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">é“¾æ¥</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener">Tetrate å…¬å¸</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">äº‘åŸç”Ÿå­¦é™¢|Bilibili</a></li>
            
            <li class="mb-3"><a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener">äº‘åŸç”Ÿå¼€æºé¡¹ç›®å¤§å…¨</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener">äº‘åŸç”Ÿç¤¾åŒºï¼ˆä¸­å›½ï¼‰</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://lib.jimmysong.io" target="_blank" rel="noopener">äº‘åŸç”Ÿèµ„æ–™åº“</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">å›¾ä¹¦</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="https://lib.jimmysong.io/envoy-handbook/" target="_blank" rel="noopener">Envoy åŸºç¡€æ•™ç¨‹</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://lib.jimmysong.io/istio-handbook/" target="_blank" rel="noopener">Istio åŸºç¡€æ•™ç¨‹</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://lib.jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener">Kubernetes åŸºç¡€æ•™ç¨‹</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-service-mesh-book/" target="_blank" rel="noopener">æ·±å…¥ç†è§£ Istio</a></li>
            
          </ul>
        </div>
        
        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">é€šçŸ¥</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/cilium-handbook/">ã€ŠCilium ä¸­æ–‡æŒ‡å—ã€‹å‘å¸ƒ</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/what-is-ebpf/">ã€Šä»€ä¹ˆæ˜¯ eBPFã€‹ç¿»è¯‘ç”µå­ä¹¦</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-public-library/">äº‘åŸç”Ÿèµ„æ–™åº“å‘å¸ƒ</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer">
    <div class="container">
      <div class="row">
        <div class="col-sm-9 text-sm-left text-center">
          <p class="mb-0 text-color">Â© 2017-2022 Jimmy Song ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
        </div>
        <div class="col-sm-3 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-twitter "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" rel="noopener"><i class="fa fa-github "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" rel="noopener"><i class="fa fa-linkedin "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="mailto:jimmysong@jimmysong.io" target="_blank" rel="noopener"><i class="fa fa-envelope "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="/blog/index.xml" target="_blank" rel="noopener"><i class="fa fa-rss "></i></a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-1', 'auto');
  ga('send', 'pageview');
</script>



<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- Algolia -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: 'd7f7189aef2be4e5be6a6b9f44897f61',
    indexName: 'DocSearch',
    appId: 'CRNDR5CNMU',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>


<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script>
    anchors.add()
</script>




<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, 'å·²å¤åˆ¶')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>
tocbot.init({
  
  tocSelector: '#TableOfContents',
  
  contentSelector: '.content',
  
  headingSelector: 'h1, h2, h3, h4',
  
  hasInnerContainers: false,
  collapseDepth: 3
});
</script>
</body>

</html>
