<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns:xl="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:dc="http://purl.org/dc/elements/1.1/" viewBox="-245 -183 1505 437" width="1505" height="437">
  <defs>
    <marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -4 10 8" markerWidth="10" markerHeight="8" color="black">
      <g>
        <path d="M 8 0 L 0 -3 L 0 3 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/>
      </g>
    </marker>
    <marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker_2" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -3 7 6" markerWidth="7" markerHeight="6" color="#00fa00">
      <g>
        <path d="M 4.8 0 L 0 -1.8 L 0 1.8 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/>
      </g>
    </marker>
  </defs>
  <g id="ambient-traffic-on-the-same-node-l7" stroke="none" stroke-dasharray="none" fill="none" stroke-opacity="1" fill-opacity="1">
    <title>ambient-traffic-on-the-same-node-l7</title>
    <rect fill="white" x="-245" y="-183" width="1505" height="437"/>
    <g id="ambient-traffic-on-the-same-node-l7_Layer_1">
      <title>Layer 1</title>
      <g id="Graphic_67"/>
      <g id="Graphic_66">
        <path d="M -217 -160 L 320.5 -160 C 322.70914 -160 324.5 -158.20914 324.5 -156 L 324.5 167.5 C 324.5 169.70914 322.70914 171.5 320.5 171.5 L -217 171.5 C -219.20914 171.5 -221 169.70914 -221 167.5 L -221 -156 C -221 -158.20914 -219.20914 -160 -217 -160 Z" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(-216 -155)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">Node A</tspan>
        </text>
      </g>
      <g id="Graphic_65">
        <rect x="-164.0339" y="112.25625" width="425.31497" height="34.27516" fill="#dadada"/>
        <text transform="translate(-159.0339 120.16983)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="150.61749" y="15" xml:space="preserve">Kubernetes CNI</tspan>
        </text>
      </g>
      <g id="Graphic_64">
        <rect x="-164.0339" y="66.11966" width="425.31497" height="34.27516" fill="#dadada"/>
        <text transform="translate(-159.0339 74.03324)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="176.84949" y="15" xml:space="preserve">Istio CNI</tspan>
        </text>
      </g>
      <g id="Graphic_63">
        <rect x="-164.0339" y="9.208055" width="425.31497" height="38.671997" fill="#666"/>
        <text transform="translate(-159.0339 19.320055)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="185.72949" y="15" xml:space="preserve">Pod A</tspan>
        </text>
      </g>
      <g id="Graphic_62">
        <path d="M 689.4616 -160 L 1226.9616 -160 C 1229.1707 -160 1230.9616 -158.20914 1230.9616 -156 L 1230.9616 167.5 C 1230.9616 169.70914 1229.1707 171.5 1226.9616 171.5 L 689.4616 171.5 C 687.2524 171.5 685.4616 169.70914 685.4616 167.5 L 685.4616 -156 C 685.4616 -158.20914 687.2524 -160 689.4616 -160 Z" stroke="#a5a5a5" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
        <text transform="translate(690.4616 -155)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">Node B</tspan>
        </text>
      </g>
      <g id="Graphic_61">
        <rect x="753.2444" y="112.25625" width="425.31497" height="34.27516" fill="#dadada"/>
        <text transform="translate(758.2444 120.16983)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="150.61749" y="15" xml:space="preserve">Kubernetes CNI</tspan>
        </text>
      </g>
      <g id="Graphic_60">
        <rect x="753.2444" y="66.11966" width="425.31497" height="34.27516" fill="#dadada"/>
        <text transform="translate(758.2444 74.03324)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="176.84949" y="15" xml:space="preserve">Istio CNI</tspan>
        </text>
      </g>
      <g id="Graphic_59">
        <rect x="753.2444" y="9.208055" width="425.31497" height="38.671997" fill="#666"/>
        <text transform="translate(758.2444 19.320055)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="185.43349" y="15" xml:space="preserve">Pod B </tspan>
        </text>
      </g>
      <g id="Graphic_58">
        <path d="M 141.28107 -94 L 257.28107 -94 C 259.4902 -94 261.28107 -92.20914 261.28107 -90 L 261.28107 -46 C 261.28107 -43.79086 259.4902 -42 257.28107 -42 L 141.28107 -42 C 139.07194 -42 137.28107 -43.79086 137.28107 -46 L 137.28107 -90 C 137.28107 -92.20914 139.07194 -94 141.28107 -94 Z" fill="#456bb0"/>
        <text transform="translate(142.28107 -90)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="21.928" y="17" xml:space="preserve">Way</tspan>
          <tspan font-family="PingFang SC" font-size="16" fill="white" y="17" xml:space="preserve">point </tspan>
          <tspan font-family="PingFang SC" font-size="16" fill="white" x="35.64" y="39" xml:space="preserve">Proxy</tspan>
        </text>
      </g>
      <g id="Group_55">
        <g id="Graphic_57">
          <path d="M 1116.0166 9.208055 L 1116.0166 -13.653477 L 1147.288 -25.067106 L 1178.5594 -13.653477 L 1178.5594 9.208055 Z" fill="#ff8080"/>
        </g>
        <g id="Graphic_56">
          <text transform="translate(1129.496 -14.239943)" fill="white">
            <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="0" y="15" xml:space="preserve">9080</tspan>
          </text>
        </g>
      </g>
      <g id="Graphic_54">
        <path d="M -120.09785 -94 L -4.097846 -94 C -1.8887068 -94 -.0978458 -92.20914 -.0978458 -90 L -.0978458 -46 C -.0978458 -43.79086 -1.8887068 -42 -4.097846 -42 L -120.09785 -42 C -122.30698 -42 -124.09785 -43.79086 -124.09785 -46 L -124.09785 -90 C -124.09785 -92.20914 -122.30698 -94 -120.09785 -94 Z" fill="#456bb0"/>
        <text transform="translate(-119.09785 -77.73206)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="22.624" y="16" xml:space="preserve">ztunnel A</tspan>
        </text>
      </g>
      <g id="Graphic_51">
        <path d="M 793.1466 -95.307 L 909.1466 -95.307 C 911.3557 -95.307 913.1466 -93.51614 913.1466 -91.307 L 913.1466 -47.307 C 913.1466 -45.09786 911.3557 -43.307 909.1466 -43.307 L 793.1466 -43.307 C 790.9375 -43.307 789.1466 -45.09786 789.1466 -47.307 L 789.1466 -91.307 C 789.1466 -93.51614 790.9375 -95.307 793.1466 -95.307 Z" fill="#456bb0"/>
        <text transform="translate(794.1466 -79.03906)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="22.328" y="16" xml:space="preserve">ztunnel B</tspan>
        </text>
      </g>
      <g id="Graphic_50">
        <path d="M 787.5196 -44.614 L 764.6581 -44.614 L 753.2444 -69.307 L 764.6581 -94 L 787.5196 -94 Z" fill="#ff8080"/>
        <text transform="translate(767.8757 -49.614) rotate(-90)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="14" fill="white" x=".2330008" y="13" xml:space="preserve">15008</tspan>
        </text>
      </g>
      <g id="Graphic_48">
        <path d="M 137.28107 -43.307 L 114.41954 -43.307 L 103.00591 -68 L 114.41954 -92.693 L 137.28107 -92.693 Z" fill="#ff8080"/>
        <text transform="translate(117.63717 -48.307) rotate(-90)" fill="white">
          <tspan font-family="Helvetica Neue" font-size="14" fill="white" x=".2330008" y="13" xml:space="preserve">15008</tspan>
        </text>
      </g>
      <g id="Line_47">
        <path d="M 198.73824 -8.457848 C 118.53286 -9.21665 -92.85166 -12.487604 -159.40807 -26.104478 C -203.91205 -35.209614 -172.40715 -46.63803 -133.77425 -55.25768" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_46">
        <line x1="-.0978458" y1="-68" x2="93.10591" y2="-68" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Line_45">
        <line x1="261.28107" y1="-68.14189" x2="740.3626" y2="-69.2383" marker-end="url(#FilledArrow_Marker_2)" stroke="#00fa00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
      </g>
      <g id="Line_44">
        <path d="M 913.1466 -70.93369 C 948.1104 -70.53923 992.9128 -67.87611 1034.0735 -58.9403 C 1076.4802 -49.733974 1104.9421 -36.05761 1122.7219 -24.782064" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Graphic_43">
        <rect x="472.7021" y="-83.43537" width="67.792" height="29.46411" fill="white"/>
        <text transform="translate(477.7021 -78.43537)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="6394885e-19" y="16" xml:space="preserve">HBONE</tspan>
        </text>
      </g>
      <g id="Graphic_42">
        <rect x="18.319463" y="-82.73206" width="67.792" height="29.46411" fill="white"/>
        <text transform="translate(23.319463 -77.73206)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="6394885e-19" y="16" xml:space="preserve">HBONE</tspan>
        </text>
      </g>
      <g id="Graphic_40">
        <text transform="translate(355.8713 -154.067)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16" xml:space="preserve">Source</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">: </tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="16" xml:space="preserve">Waypoint Proxy IP</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">:Ephemeral Port</tspan>
        </text>
      </g>
      <g id="Graphic_39">
        <text transform="translate(-50.53844 -144.843)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16" xml:space="preserve">Source</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">: </tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="16" xml:space="preserve">ztunnel A IP</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">:Ephemeral Port</tspan>
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="35.46411" xml:space="preserve">Destination</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="35.46411" xml:space="preserve">: </tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="35.46411" xml:space="preserve">Waypoint Proxy IP</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="35.46411" xml:space="preserve">:15008</tspan>
        </text>
      </g>
      <g id="Group_36">
        <g id="Graphic_38">
          <path d="M 198.73824 8.900285 L 198.73824 -13.961247 L 230.00966 -25.374876 L 261.28107 -13.961247 L 261.28107 8.900285 Z" fill="#ff8080"/>
        </g>
        <g id="Graphic_37">
          <text transform="translate(207.76966 -14.547713)" fill="white">
            <tspan font-family="Helvetica Neue" font-size="16" fill="white" x="0" y="15" xml:space="preserve">15001</tspan>
          </text>
        </g>
      </g>
      <g id="Graphic_35">
        <rect x="-115.626" y="-29.18509" width="146.624" height="28.447998" fill="white"/>
        <text transform="translate(-110.62601 -24.185088)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">cross-netns socket</tspan>
        </text>
      </g>
      <g id="Graphic_5">
        <rect x="956.9818" y="-75.17332" width="134.48" height="28.447998" fill="white"/>
        <text transform="translate(961.9818 -70.17332)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">To Pod B IP:9080</tspan>
        </text>
      </g>
      <g id="Graphic_3">
        <text transform="translate(793.4616 -142.81078)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">DaemonSets ztunnel</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="33.448" xml:space="preserve">hostNetwork: true</tspan>
        </text>
      </g>
      <g id="Graphic_68">
        <text transform="translate(355.8713 -128.5)" fill="black">
          <tspan font-family="Helvetica Neue" font-weight="bold" font-size="16" fill="black" x="0" y="16" xml:space="preserve">Destination</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">: </tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="16" xml:space="preserve">Node B IP</tspan>
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="16" xml:space="preserve">:15008</tspan>
        </text>
      </g>
      <g id="Graphic_69">
        <path d="M 662.26276 15.58536 C 662.26276 -6.68263 658.32576 -9.437627 629.56706 -31.47525 L 629.26326 -31.703267 C 600.35266 -53.97126 600.05196 -53.97126 570.38186 -53.97126 C 530.87546 -53.97126 352.26276 -53.97126 352.26276 -53.97126 L 352.26276 181.09673 L 662.26276 181.09673 L 662.26276 15.58536 Z M 662.26276 14.438229 C 662.26276 -6.68263 661.95896 -6.68263 600.05196 -6.68263 L 600.05196 -6.68263 C 600.05196 -53.74089 600.05196 -53.97126 572.19846 -53.97126" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1"/>
      </g>
      <g id="Group_78">
        <g id="Graphic_70">
          <text transform="translate(360.42276 -47.005255)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">:method: CONNECT</tspan>
          </text>
        </g>
        <g id="Graphic_71">
          <text transform="translate(360.42276 -18.557257)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">:scheme: https</tspan>
          </text>
        </g>
        <g id="Graphic_72">
          <text transform="translate(360.42276 9.890741)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="17" xml:space="preserve">:authority: </tspan>
            <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="17" xml:space="preserve">Po</tspan>
            <tspan font-family="PingFang SC" font-size="16" fill="#b1001c" y="17" xml:space="preserve">d B IP</tspan>
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="17" xml:space="preserve">:9080</tspan>
          </text>
        </g>
        <g id="Graphic_73">
          <text transform="translate(360.42276 41.89074)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">:path: /api/v1/users?id=123</tspan>
          </text>
        </g>
        <g id="Graphic_74">
          <text transform="translate(360.42276 70.33874)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">x-envoy-original-dst-host: </tspan>
            <tspan font-family="Helvetica Neue" font-size="16" fill="#b1001c" y="15" xml:space="preserve">Pod B IP</tspan>
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" y="15" xml:space="preserve">:9080</tspan>
          </text>
        </g>
        <g id="Graphic_75">
          <text transform="translate(360.42276 98.78674)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">x-forwarded-proto: hbone</tspan>
          </text>
        </g>
        <g id="Graphic_76">
          <text transform="translate(360.42276 127.23474)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">x-istio-attributes: ...</tspan>
          </text>
        </g>
        <g id="Graphic_77">
          <text transform="translate(360.42276 155.68273)" fill="black">
            <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">x-istio-auth-userinfo: ...</tspan>
          </text>
        </g>
      </g>
      <g id="Graphic_80">
        <text transform="translate(-209 186.09673)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="15" xml:space="preserve">Iptables redirect the packets to the ports that ztunnel listening.</tspan>
        </text>
      </g>
      <g id="Graphic_79">
        <text transform="translate(-209 214.54473)" fill="black">
          <tspan font-family="Helvetica Neue" font-size="16" fill="black" x="0" y="17" xml:space="preserve">Istio CNI will create a cross-netns socket for each Pod that listen on port 15001 </tspan>
          <tspan font-family="PingFang SC" font-size="16" fill="black" y="17" xml:space="preserve">(outbound socket), 15006 (plaintext socket) and 15008 (HBONE socket).</tspan>
        </text>
      </g>
    </g>
  </g>
</svg>
