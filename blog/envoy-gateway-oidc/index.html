<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？ - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/envoy-gateway-oidc/" />
  <meta property="og:title" content="如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？ | Jimmy Song" />
  <meta property="twitter:title" content="如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？ | Jimmy Song" />

  
  <meta property="og:description" content="本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。" />
  <meta property="twitter:description" content="本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/envoy-gateway-oidc/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    如何使用 Envoy Gateway 在 API 网关侧基于 OIDC 实现单点登录？
                </p>
                <p class="page-description">
                    本文详细介绍了如何配置 Envoy Gateway 使用 OIDC 实现单点登录。通过 Auth0 作为身份提供商，演示如何在 API 网关端实现安全、高效的单点登录，提升用户体验和系统安全性。
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>2024/05/24</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/categories/envoy"> 
                        Envoy</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>16 分钟</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>3608 字</li>
                    
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">

            
            
            
              <div class="alert alert-note-container mt-2">
    <div class="alert-note-title px-2 py-2">
      版权声明
    </div>
    <div class="alert-tip px-2">
      本文为 Jimmy Song 原创。转载请注明来源： <a title=https://jimmysong.io/blog/envoy-gateway-oidc/>https://jimmysong.io/blog/envoy-gateway-oidc/</a>
     </div>
  </div>
            

            
              <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#auth-methods">Envoy Gateway 支持的认证方式</a></li>
    <li><a href="#what-is-oidc">什么是 OIDC？</a></li>
    <li><a href="#why-sso">为什么要实现单点登录？</a></li>
    <li><a href="#demo">示例：使用 Envoy Gateway 和 Auth0 的单点登录</a>
      <ul>
        <li><a href="#auth0-sequence">基于 Auth0 实现单点登录</a></li>
        <li><a href="#auth0">在 Auth0 上创建应用</a></li>
        <li><a href="#install-envoy-gateway">安装 Envoy Gateway</a></li>
        <li><a href="#envoy-gateway-oidc">配置 Envoy Gateway 的 OIDC 认证</a></li>
        <li><a href="#login">验证单点登录：登入</a></li>
        <li><a href="#logout">验证单点登录：登出</a></li>
      </ul>
    </li>
    <li><a href="#summary">总结</a></li>
    <li><a href="#reference">参考</a></li>
  </ul>
</nav>
</details>

            
            <p>在<a href="/blog/microservice-auth-methods/" title="微服务中常见的认证方式详解">微服务中常见的认证方式详解</a>这篇博客中我们介绍到了 OAuth 2.0 认证，该身份认证协议有多种实现方式，其中最流行的就是 OpenID Connect（OIDC）认证。OIDC 能够为用户提供身份验证和授权。本文将介绍如何使用 Envoy Gateway 在 API 网关级别实现 OIDC 认证。</p>
<h2 id="auth-methods">Envoy Gateway 支持的认证方式</h2>
<p>Envoy Gateway 是一个使用 Envoy 实现的高性能的 API 网关，支持多种认证方式来保护 API 和微服务：</p>
<ol>
<li><strong>JWT 认证</strong>: 使用 JSON Web Tokens（JWT）进行认证。</li>
<li><strong>mTLS（双向 TLS）</strong>: 使用双向 TLS 确保客户端和服务器之间的安全通信。</li>
<li><strong>HTTP Basic 认证</strong>: 使用用户名和密码进行基本认证。</li>
<li><strong>OIDC 认证</strong>: 使用 OpenID Connect 协议进行身份验证和授权。</li>
<li><strong>外部认证</strong>：外部认证调用外部 HTTP 或 gRPC 服务来检查传入的 HTTP 请求是否经过认证。</li>
</ol>
<p>本文重点介绍如何在 Envoy Gateway 中配置和使用 OIDC 认证从而在网关侧实现单点登录。</p>
<h2 id="what-is-oidc">什么是 OIDC？</h2>
<p>OpenID Connect（OIDC）是一个基于 <a href="/blog/microservice-auth-methods/#oauth-20" title="OAuth 2.0">OAuth 2.0</a> 的身份验证协议。它允许客户端通过认证服务器验证用户身份，并获取有关用户的信息。</p>
<p>OIDC 认证流程如下图所示：</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/83b3c4d30c57805947a314f67c7aa8c1.svg" data-img="/blog/envoy-gateway-oidc/83b3c4d30c57805947a314f67c7aa8c1.svg" alt="image" data-caption="OIDC 认证流程图">
        
      
    
  
  
  <figcaption>OIDC 认证流程图</figcaption>
  
</figure>
<p>OIDC 为 OAuth 2.0 增加了身份验证层，通过引入 ID Token 和标准化的 UserInfo Endpoint，使 OAuth 2.0 不仅能够用于授权，还可以用于安全地验证用户身份，从而实现单点登录（SSO）和用户身份信息的获取。</p>
<h2 id="why-sso">为什么要实现单点登录？</h2>
<p>单点登录（Single Sign-On, SSO）是一种身份验证方式，它允许用户使用一个账户登录多个独立的应用系统，通过一次身份验证即可无缝访问所有相关应用，减少重复输入用户名和密码的麻烦，从而提升用户体验。SSO 集中管理用户身份和认证，增强了系统安全性，并简化了 IT 管理流程。</p>
<p>对于微服务架构，SSO 尤其重要，因为它在各个微服务之间实现统一的认证和授权，避免了每个服务单独实现身份验证逻辑的需求，减少了用户重复登录的麻烦，并提高了用户体验。集中管理的方式还可以统一应用安全策略，更有效地监控和响应安全事件，提升系统的整体安全性。同时，通过使用标准化的令牌（如 JWT），SSO 简化了微服务之间的身份验证过程，提高了开发效率，让开发人员能够专注于业务逻辑的实现。</p>
<h2 id="demo">示例：使用 Envoy Gateway 和 Auth0 的单点登录</h2>
<p>接下来我们将使用 Auth0 作为身份供应商，演示如何使用 Envoy Gateway 在 API 网关端实现单点登录。</p>
<p>你可以在 <a href="https://www.bilibili.com/video/BV11m421K7ZW/?share_source=copy_web&amp;vd_source=87728cb6b1b0090fc617caf07a40b236" title="Bilibili" target="_blank" rel="noopener">Bilibili</a> 上查看该示例演示。</p>
<div class="video-container" style="padding-top: 62.5%;">
    <iframe src="//player.bilibili.com/player.html?isOutside=true&amp;aid=1604968380&amp;bvid=BV11m421K7ZW&amp;cid=1557352862&amp;p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
</div> 
<h3 id="auth0-sequence">基于 Auth0 实现单点登录</h3>
<p>首先我们先说明下示例中 Envoy Gateway 基于 Auth0 实现单点登录的详细流程，如下图所示。</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/0f2852499a637280acfa600e992fd2c8.svg" data-img="/blog/envoy-gateway-oidc/0f2852499a637280acfa600e992fd2c8.svg" alt="image" data-caption="Envoy Gateway 基于 Auth0 实现单点登录的流程图">
        
      
    
  
  
  <figcaption>Envoy Gateway 基于 Auth0 实现单点登录的流程图</figcaption>
  
</figure>
<p>步骤说明：</p>
<ol>
<li><strong>用户访问网站</strong>：用户通过浏览器访问 <code>https://www.example.com</code>。</li>
<li><strong>请求转发</strong>：浏览器向 Envoy Gateway 发送 GET 请求。</li>
<li><strong>检查 ID 令牌</strong>：Envoy Gateway 检查用户请求的 cookie 是否包含有效的 ID 令牌。</li>
<li><strong>重定向到身份提供商</strong>：如果没有找到 ID 令牌，Envoy Gateway 将用户重定向到身份提供商（Identity Provider，IdP）的授权端点，在这里是 Auth0，关于 Auth0 如何实现 Login 的详细信息请查看 <a href="https://auth0.com/docs/api/authentication#login" title="Auth0 文档" target="_blank" rel="noopener">Auth0 文档</a>。</li>
<li><strong>用户登录</strong>：用户在身份提供商的登录页面输入用户名和密码，并提交凭证进行登录。</li>
<li><strong>获取授权码</strong>：用户成功登录后，身份提供商将用户重定向回 Envoy Gateway，并在 URL 中包含授权码。</li>
<li><strong>交换 ID 令牌</strong>：Envoy Gateway 使用授权码向身份提供商请求 ID 令牌。</li>
<li><strong>设置 Cookie</strong>：身份提供商返回 ID 令牌，Envoy Gateway 将其设置为用户的 cookie。</li>
<li><strong>重定向</strong>：Envoy Gateway 将 URL 重定向到 <code>https://www.example.com</code>。</li>
<li><strong>验证 ID 令牌</strong>：Envoy Gateway 验证用户请求中的 ID 令牌。</li>
<li><strong>路由请求</strong>：验证通过后，Envoy Gateway 将请求路由到后端应用（App）。</li>
</ol>
<p>通过上述流程，Envoy Gateway 实现了单点登录功能。用户的 HTTP 请求在没有得到授权的情况下都会被转发单点登录页面。除了 Auth0 以外，Envoy Gateway 还支持多个身份提供商，如 Azure AD、Keycloak、Okta、OneLogin、Salesforce、UAA 等。</p>
<p>下面我们将按照时序图中的流程配置 Auth0 和 Envoy Gateway。</p>
<h3 id="auth0">在 Auth0 上创建应用</h3>
<p>请参考以下步骤在 Auth0 上设置一个 Regular Web Application：</p>
<ol>
<li>访问 <a href="https://auth0.com/" title="Auth0" target="_blank" rel="noopener">Auth0</a> 并注册一个免费账户。</li>
<li>创建一个新的应用，并选择常规 Web 应用程序。</li>
<li>在应用设置中，记录或设置以下字段：
<ul>
<li><strong>Domain</strong> ：<code>{DOMAIN}</code></li>
<li><strong>Client ID</strong>：<code>{CLIENT_ID}</code></li>
<li><strong>Client Secret</strong>：<code>{CLIENT_SECRET}</code></li>
<li><strong>Allowed Callback URLs</strong>：<code>https://www.example.com/oauth2/myapp/callback</code></li>
<li><strong>Allowed Logout URLs</strong>：<code>https://www.example.com/myapp/logout</code></li>
</ul>
</li>
</ol>
<p>记住上面的 Auth0 字段，我们将用它们来配置 Envoy Gateway 的安全策略。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    提示
  </div>
  
  <div class="alert-note px-2">
    这里的 Logout URL 不起实际作用，应为在我们的下面示例中的 backend 服务并没有实现 Auth0 的 logout 接口。我们只是按照习惯在此添加该字段，以待未来实现。
  </div>
</div>

<p>下面展示的是 Auth0 的配置页面截图，在设置好用户后并创建普通 Web 应用后，你只需要配置这两个地方。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/auth0-1.webp" data-img="/blog/envoy-gateway-oidc/auth0-1.webp" data-width="1400" data-height="1079" alt="image" data-caption="Auth0 配置页面 1">
        
      
    
  
  
  <figcaption>Auth0 配置页面 1</figcaption>
  
</figure>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/auth0-2.webp" data-img="/blog/envoy-gateway-oidc/auth0-2.webp" data-width="1400" data-height="1079" alt="image" data-caption="Auth0 配置页面 2">
        
      
    
  
  
  <figcaption>Auth0 配置页面 2</figcaption>
  
</figure>
<p>以上就是 Auth0 的全部配置，接下来我们将安装和配置 Envoy Gateway。</p>
<h3 id="install-envoy-gateway">安装 Envoy Gateway</h3>
<p>参考 <a href="/blog/envoy-gateway-introduction/#envoy-gateway-quick-start" title="Envoy Gateway 快速开始">Envoy Gateway 快速开始</a>在 minikube 上安装 Envoy Gateway：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube start --driver<span class="o">=</span>docker --cpus<span class="o">=</span><span class="m">2</span> --memory<span class="o">=</span>2g
</span></span><span class="line"><span class="cl">helm install eg oci://docker.io/envoyproxy/gateway-helm --version v1.0.1 -n envoy-gateway-system --create-namespace
</span></span><span class="line"><span class="cl">kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/v1.0.1/quickstart.yaml -n default
</span></span></code></pre></div><p>参考安全网关，为 Envoy Gateway 配置 TLS：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建根证书和私钥来签署证书</span>
</span></span><span class="line"><span class="cl">openssl req -x509 -sha256 -nodes -days <span class="m">365</span> -newkey rsa:2048 -subj <span class="s1">&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为 www.example.com 创建证书和私钥</span>
</span></span><span class="line"><span class="cl">openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span class="s2">&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span class="line"><span class="cl">openssl x509 -req -days <span class="m">365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span class="m">0</span> -in www.example.com.csr -out www.example.com.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将证书/密钥存储在 Secret 中</span>
</span></span><span class="line"><span class="cl">kubectl create secret tls example-cert --key<span class="o">=</span>www.example.com.key --cert<span class="o">=</span>www.example.com.crt
</span></span></code></pre></div><p>更新快速开始中创建的网关，使其包含 <code>443</code> 端口并引用 <code>example-cert</code> Secret 的 HTTPS Listener：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;[
</span></span></span><span class="line"><span class="cl"><span class="s1">  {
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;op&#34;: &#34;add&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;value&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;name&#34;: &#34;https&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;port&#34;: 443,
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#34;tls&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;mode&#34;: &#34;Terminate&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#34;certificateRefs&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s1">          {
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;kind&#34;: &#34;Secret&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;group&#34;: &#34;&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;name&#34;: &#34;example-cert&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">          }
</span></span></span><span class="line"><span class="cl"><span class="s1">        ]
</span></span></span><span class="line"><span class="cl"><span class="s1">      }
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">  }
</span></span></span><span class="line"><span class="cl"><span class="s1">]&#39;</span> <span class="p">|</span> kubectl patch gateway eg --type<span class="o">=</span>json --patch-file /dev/stdin
</span></span></code></pre></div><p>创建 HTTPRoute，为 <code>/myapp</code> 端点增加一条到<code>backend</code> 服务的路由：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: gateway.networking.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: HTTPRoute
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: myapp
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  parentRefs:
</span></span></span><span class="line"><span class="cl"><span class="s">  - name: eg
</span></span></span><span class="line"><span class="cl"><span class="s">  hostnames: [&#34;www.example.com&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - matches:
</span></span></span><span class="line"><span class="cl"><span class="s">    - path:
</span></span></span><span class="line"><span class="cl"><span class="s">        type: PathPrefix
</span></span></span><span class="line"><span class="cl"><span class="s">        value: /myapp
</span></span></span><span class="line"><span class="cl"><span class="s">    backendRefs:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: backend
</span></span></span><span class="line"><span class="cl"><span class="s">      port: 3000
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><h3 id="envoy-gateway-oidc">配置 Envoy Gateway 的 OIDC 认证</h3>
<p>创建一个 Kubernetes Secret，用于存储 OAuth Client 的 Client Secret：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create secret generic auth0-client-secret --from-literal<span class="o">=</span>client-secret<span class="o">=</span><span class="si">${</span><span class="nv">CLIENT_SECRET</span><span class="si">}</span>
</span></span></code></pre></div>


<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    注意
  </div>
  
  <div class="alert-note px-2">
    将 <code>${CLIENT_SECRET}</code> 替换成你的 Auth0 Client Secret。
  </div>
</div>

<p>创建一个安全策略（SecurityPolicy）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: SecurityPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: oidc-example
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  targetRef:
</span></span></span><span class="line"><span class="cl"><span class="s">    group: gateway.networking.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">    kind: Gateway
</span></span></span><span class="line"><span class="cl"><span class="s">    name: eg
</span></span></span><span class="line"><span class="cl"><span class="s">  oidc:
</span></span></span><span class="line"><span class="cl"><span class="s">    provider:
</span></span></span><span class="line"><span class="cl"><span class="s">      issuer: &#34;https://${DOMAIN}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    clientID: &#34;${CLIENT_ID}&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    clientSecret:
</span></span></span><span class="line"><span class="cl"><span class="s">      name: &#34;auth0-client-secret&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    redirectURL: &#34;https://www.example.com/myapp/oauth2/callback&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    logoutPath: &#34;/myapp/logout&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p><strong>注意事项</strong></p>
<ul>
<li>此处的 <code>issuer</code> 应该填写成 Auth0 Domain。</li>
<li><code>redirectURL</code> 的值需要出现在 Auth0 配置的 Allowed Callback URLs 中。</li>
<li><code>logoutPath</code> 是必须的，即使其 URL 端点并为实现 logout 逻辑。</li>
</ul>
<p>在这个示例中我们为 Envoy Gateway 网关设置了 OIDC，修改 <code>targetRef</code> 到 HTTPRoute，也可以为单个路由设置 OIDC。关于 ODIC 的具体配置，请参考 Envoy Gateway API 文档。</p>
<h3 id="login">验证单点登录：登入</h3>
<p>将 <code>www.example.com</code> 添加到本地的 <code>/etc/hosts</code> 文件中：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;127.0.0.1 www.example.com&#34;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><p>配置应用程序的端口转发，以便你可以在本地通过域名访问示例应用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ENVOY_SERVICE</span><span class="o">=</span><span class="k">$(</span>kubectl get svc -n envoy-gateway-system --selector<span class="o">=</span>gateway.envoyproxy.io/owning-gateway-namespace<span class="o">=</span>default,gateway.envoyproxy.io/owning-gateway-name<span class="o">=</span>eg -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo kubectl -n envoy-gateway-system port-forward service/<span class="si">${</span><span class="nv">ENVOY_SERVICE</span><span class="si">}</span> 443:443
</span></span></code></pre></div><p>现在在浏览器中访问 <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a>，跳过证书风险提示，页面将跳转到 Auth0 的登录界面，如下图所示，选择使用 Google 账户登录。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/login.webp" data-img="/blog/envoy-gateway-oidc/login.webp" data-width="400" data-height="649" alt="image" data-caption="登录界面">
        
      
    
  
  
  <figcaption>登录界面</figcaption>
  
</figure>
<p>在登录完成后，浏览器将跳转会 <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a> 页面，并展示 HTTP 请求结果，如下面的 JSON 代码所示。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;www.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;proto&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;headers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">/*Omit*/</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Authorization&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Bearer eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Cookie&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;OauthHMAC-167a6c5=RPdscXEBap0NeSIppJXoxkHt0qvMz4fNHXo2uvgDgIY=; OauthExpires-167a6c5=1716540771; BearerToken-167a6c5=eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIiwiaXNzIjoiaHR0cHM6Ly9kZXYtYXdoam15MzhnZzVxeng3dS51cy5hdXRoMC5jb20vIn0..IiH9LnxmnrGAVy-q.eQV_0Ssetw9mmrEaJNLlBowGJNX51awhh67WSejPrksuGU9e9-DcPJQqmR67ONFzTXWR6CFy4Rfgs4btsmEtvCtiNTCgrBHP90ddbOTg_pK31WnsQ7NThyRfGwoogSaAtK6hFrC2pxFaLj0XL7XvSPk-OaTzK1Zh1da1IM1cmWAWiBRc3nQiVWRDrExPo8-i5SawFe0jIcwytVSaRiX5Polyd3cZ7A7nlei-vDLCfj0HVzOO605nF7ED2dBSnZyev1sg14q598f3X2Vfhi2oJlnbiulGZIlpXgGbcPhzAJJxyEe6qpRpNg7Hbk8Ya-i8gUTwwNysrgm3.Zu5kD_6DzSfZPvwemttXYQ; IdToken-167a6c5=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFKWkxWbnNrai0tYmhsNlJzVm51OCJ9.eyJpc3MiOiJodHRwczovL2Rldi1hd2hqbXkzOGdnNXF6eDd1LnVzLmF1dGgwLmNvbS8iLCJhdWQiOiJUZzhlNWVoa0xKM2hka3cxTzREMTBQd21QeTcxZHZtdiIsImlhdCI6MTcxNjQ1NDM3MSwiZXhwIjoxNzE2NDkwMzcxLCJzdWIiOiJnb29nbGUtb2F1dGgyfDExMjc0NDc3OTAyMjMzMTA0ODY0MCIsInNpZCI6IjRlSjhDZnZuZjd5Mm1kaE94QXBTY0JiUEhjOS1rZUVLIn0.r9dwIy_HeiO5_I3UlohLkeRES5FGoxqQnwmcA00cA_kdc5mUxgeVopXIhBUjJnTKv7bOUVJvFw21ew4gqVRJfllDyG-s_XfhSW1-lEXmCc2bGYDtOzva6k2S_VRgyMKfG04_DWFuTgO_pLtix28aYq8cGzKJ_VglT_KgRhoktzJu4Js5iCv9JPnydRJmpvRJwX3tDv_Q3mmUSazaLkhOTdiBJFrGlS07qEzJ_iWANZgR8uDNhpXdmlcqpb3MZkkMulr5-jXIgEhBQKpw28tUiSlzh6EpAVuBH9T1w8bUmFRzCc6JPPamJRfflYW5onNgYHDfcU0RpvpsCHRHRAZbdA&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="err">/*Omit*/</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Envoy-Internal&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Forwarded-For&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;10.244.0.51&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Forwarded-Proto&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;https&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;X-Request-Id&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;c1e64057-c5c8-4fb2-a304-25c291eeed32&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ingress&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pod&#34;</span><span class="p">:</span> <span class="s2">&#34;backend-55d64d8794-4qvgd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>此时通过 Chrome 浏览器的  <em>Inspector - Application - Cookies</em> 查看到 ID Token 如下图所示：</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/envoy-gateway-oidc/inspector.webp" data-img="/blog/envoy-gateway-oidc/inspector.webp" data-width="1400" data-height="983" alt="image" data-caption="在 Chrome Inspector 中查看 ID Token">
        
      
    
  
  
  <figcaption>在 Chrome Inspector 中查看 ID Token</figcaption>
  
</figure>
<p>编写代码 Python 代码，<code>validate_id_token.py</code>，解析 ID Token 并验证其有效性：</p>







  


<div class="internal-file">
  <a href="validate_id_token.py" download>validate_id_token.py</a>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jwt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">jwt.algorithms</span> <span class="kn">import</span> <span class="n">RSAAlgorithm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">base64url_decode</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">rem</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">input</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">rem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_signing_key</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">,</span> <span class="n">kid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">jwks</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">jwk</span> <span class="ow">in</span> <span class="n">jwks</span><span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">jwk</span><span class="p">[</span><span class="s1">&#39;kid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">kid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">RSAAlgorithm</span><span class="o">.</span><span class="n">from_jwk</span><span class="p">(</span><span class="n">jwk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Public key not found.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">audience</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">jwk_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">kid</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;kid&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">signing_key</span> <span class="o">=</span> <span class="n">get_signing_key</span><span class="p">(</span><span class="n">jwk_url</span><span class="p">,</span> <span class="n">kid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">signing_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;RS256&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">audience</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">issuer</span><span class="o">=</span><span class="n">issuer</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decoded_token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Validate a JWT token.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The JWT token to validate&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 解析 token 的 payload 部分，提取 audience 和 issuer</span>
</span></span><span class="line"><span class="cl">    <span class="n">header</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_payload</span> <span class="o">=</span> <span class="n">base64url_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">audience</span> <span class="o">=</span> <span class="n">payload_json</span><span class="p">[</span><span class="s1">&#39;aud&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">issuer</span> <span class="o">=</span> <span class="n">payload_json</span><span class="p">[</span><span class="s1">&#39;iss&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">jwk_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="s2">.well-known/jwks.json&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">audience</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">jwk_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Token is valid. Decoded payload:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">decoded</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Token validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div>
<p>安装依赖的包：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pip install pyjwt requests
</span></span></code></pre></div><p>运行代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python validate_id_token.py <span class="si">${</span><span class="nv">ID_TOKEN</span><span class="si">}</span>
</span></span></code></pre></div><p>你将看到类似下面的输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">Token is valid. Decoded payload:</span>
</span></span><span class="line"><span class="cl"><span class="na">iss: https://dev-awhjmy38gg5qzx7u.us.auth0.com/</span>
</span></span><span class="line"><span class="cl"><span class="na">aud: Tg8e5ehkLJ3hdkw1O4D10PwmPy71dvmv</span>
</span></span><span class="line"><span class="cl"><span class="na">iat: 1716470905</span>
</span></span><span class="line"><span class="cl"><span class="na">exp: 1716506905</span>
</span></span><span class="line"><span class="cl"><span class="na">sub: google-oauth2|112744779022331048640</span>
</span></span><span class="line"><span class="cl"><span class="na">sid: 4W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N</span>
</span></span></code></pre></div><p>通过该 ID Token 的值可以得出：</p>
<ul>
<li>该令牌由 Auth0 签发（<code>iss</code> 字段）。</li>
<li>该令牌的受众是特定的应用或 API（<code>aud</code> 字段），对于 Auth0，这个值是 Client ID。</li>
<li>令牌是在 2024 年 5 月 23 日 04:08:25 UTC 签发的（<code>iat</code> 字段），并将在 2024 年 5 月 23 日 14:08:25 UTC 过期（<code>exp</code> 字段）。</li>
<li>令牌所代表的主体（用户）的唯一标识符是 <code>google-oauth2|112744779022331048640</code>（<code>sub</code> 字段）。在这里，这个标识符表明使用 Google OAuth2 登录的用户</li>
<li>会话 ID 是 <code>4W_hQNJJ8ftDL8S3Cozp8GEu2Au4_e9N</code>（<code>sid</code> 字段），用于会话管理。</li>
</ul>
<h3 id="logout">验证单点登录：登出</h3>
<p>由于我们的示例应用中没有实现 Auth0 的 Logout 逻辑，所以我们需要通过 HTTP 请求明确告知 Auth0 要 logout，在浏览器中访问该 URL：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://<span class="si">${</span><span class="nv">DOMAIN</span><span class="si">}</span>/v2/logout?client_id<span class="o">=</span><span class="si">${</span><span class="nv">CLIENT_ID</span><span class="si">}</span>
</span></span></code></pre></div><p>请将 <code>${DOMAIN}</code> 和 <code>${CLIENT_ID</code> 修改为你的 Auth0 应用程序的<a href="#auth0" title="配置项">配置项</a>。关于 Auth0 如何登出 OIDC 端点的详细说明请查看 <a href="https://auth0.com/docs/api/authentication#logout" title="Auth0 文档" target="_blank" rel="noopener">Auth0 文档</a>。</p>
<p>登出后，页面将再次跳转到登录页面，在登录后，页面将重定向到 <a href="https://www.example.com" title="https://www.example.com" target="_blank" rel="noopener">https://www.example.com</a>。</p>
<h2 id="summary">总结</h2>
<p>通过以上步骤，你可以在 Envoy Gateway 中实现 OIDC 认证，确保 API 的安全性。这种方法不仅能提供灵活的身份验证机制，还能简化应用程序的身份管理。通过集成 Auth0 等身份提供商，Envoy Gateway 可以轻松实现单点登录，提升用户体验和系统安全性。未来，你可以根据需求进一步配置和优化 Envoy Gateway，充分利用其强大的认证和授权功能，以满足更复杂的安全要求和业务需求。</p>
<h2 id="reference">参考</h2>
<ul>
<li>Envoy Gateway OIDC Authentication - gateway.envoyproxy.io</li>
<li><a href="https://auth0.com/docs/authenticate/login/logout/log-users-out-of-auth0" title="Log Users Out of Auth0 with OIDC Endpoint - auth0.com" target="_blank" rel="noopener">Log Users Out of Auth0 with OIDC Endpoint - auth0.com</a></li>
</ul>

            <div class="border-bottom mb-2"></div>
          </div>
          <div class="col-12">
            <p>最后更新于 2024/10/28</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/tags/envoy" class="badge"> 
                  Envoy</a> 
              <a href="/tags/envoy-gateway" class="badge">  
                  Envoy Gateway</a> 
              <a href="/tags/oidc" class="badge">  
                  OIDC</a> 
              <a href="/tags/api-gateway" class="badge">  
                  API Gateway</a> 
              <a href="/tags/gateway" class="badge">  
                  Gateway</a> 
              <a href="/tags/auth0" class="badge">  
                  Auth0</a> 
              <a href="/tags/sso" class="badge">  
                  SSO</a> 
              <a href="/tags/%e5%8d%95%e7%82%b9%e7%99%bb%e5%bd%95" class="badge">  
                  单点登录</a> </div>
          </div>
          
          <div class="col-12">
            









    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    






    



    


<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/blog/hugo-instant-search-guide/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; 上一篇</span>
            <span class="text-align-left">如何为你的 Hugo 网站添加即时搜索功能</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/blog/microservice-auth-methods/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">下一篇 &rarr;</span>
            <span class="text-align-right">微服务中常见的认证方式详解</span>
        </a>
    </div>
     
</div>

          </div>

          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="zh-CN"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          











<div>
  <p class="related-sidebar-title">
  相关文章
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/blog/envoy-gateway-introduction/">
            Envoy Gateway 概述——使用 Gateway API 的现代 Kubernetes 入口
          </a>
      </li>
    
      <li>
          <a href="/trans/what-will-be-the-api-management-trends-for-2024/">
            [译] 2024 年 API 管理趋势预测
          </a>
      </li>
    
      <li>
          <a href="/blog/why-gateway-api-is-the-future-of-ingress-and-mesh/">
            Gateway API：Kubernetes 和服务网格入口中网关的未来
          </a>
      </li>
    
      <li>
          <a href="/blog/tetrate-vulnerability-scaner/">
            TVS：Istio 和 Envoy CVE 扫描解决方案
          </a>
      </li>
    
      <li>
          <a href="/blog/preserve-source-ip-in-istio/">
            维持请求的透明度：在 Istio 中保留客户端请求的源 IP
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#auth-methods">Envoy Gateway 支持的认证方式</a></li>
    <li><a href="#what-is-oidc">什么是 OIDC？</a></li>
    <li><a href="#why-sso">为什么要实现单点登录？</a></li>
    <li><a href="#demo">示例：使用 Envoy Gateway 和 Auth0 的单点登录</a>
      <ul>
        <li><a href="#auth0-sequence">基于 Auth0 实现单点登录</a></li>
        <li><a href="#auth0">在 Auth0 上创建应用</a></li>
        <li><a href="#install-envoy-gateway">安装 Envoy Gateway</a></li>
        <li><a href="#envoy-gateway-oidc">配置 Envoy Gateway 的 OIDC 认证</a></li>
        <li><a href="#login">验证单点登录：登入</a></li>
        <li><a href="#logout">验证单点登录：登出</a></li>
      </ul>
    </li>
    <li><a href="#summary">总结</a></li>
    <li><a href="#reference">参考</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/shanxi-trip/">地上文物看山西：宝藏文物大省不该被埋没</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/multi-cluster-pki-istio-recipe/">多集群 PKI 与 Istio 实践：为服务网格构建可信且可扩展的 PKI</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-tracing/">Envoy 代理如何处理用户请求以实现追踪</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
