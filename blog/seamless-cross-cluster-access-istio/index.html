<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>多集群 Istio 服务网格的跨集群无缝访问指南 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="探索如何在 Istio 多集群网格中利用 SPIRE 联邦、DNS 代理和东西向网关技术，有效实现服务的跨集群无缝访问。本指南将提供详细的配置示例和步骤，帮助你克服部署中的挑战，确保服务间的高效、安全通信。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/seamless-cross-cluster-access-istio/" />
  <meta property="og:title" content="多集群 Istio 服务网格的跨集群无缝访问指南 | Jimmy Song" />
  <meta property="twitter:title" content="多集群 Istio 服务网格的跨集群无缝访问指南 | Jimmy Song" />

  
  <meta property="og:description" content="探索如何在 Istio 多集群网格中利用 SPIRE 联邦、DNS 代理和东西向网关技术，有效实现服务的跨集群无缝访问。本指南将提供详细的配置示例和步骤，帮助你克服部署中的挑战，确保服务间的高效、安全通信。" />
  <meta property="twitter:description" content="探索如何在 Istio 多集群网格中利用 SPIRE 联邦、DNS 代理和东西向网关技术，有效实现服务的跨集群无缝访问。本指南将提供详细的配置示例和步骤，帮助你克服部署中的挑战，确保服务间的高效、安全通信。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/seamless-cross-cluster-access-istio/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    多集群 Istio 服务网格的跨集群无缝访问指南
                </p>
                <p class="page-description">
                    探索如何在 Istio 多集群网格中利用 SPIRE 联邦、DNS 代理和东西向网关技术，有效实现服务的跨集群无缝访问。本指南将提供详细的配置示例和步骤，帮助你克服部署中的挑战，确保服务间的高效、安全通信。
                </p>
                
                <div class="page-metadata">
                  <ul class="list-inline d-flex">
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                        </span>2024/07/11</li>
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-folder-open"></i>
                        </span><a
                        href="/categories/istio"> 
                        Istio</a> </li>
                    
                    
                    <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                        </span>30 分钟</li>
                    <li class="list-inline-item mr-2 mb-md-0 d-sm-block d-none"><span><i class="fa-regular fa-file-word"></i>
                        </span>6646 字</li>
                    
                    
                  </ul>
                </div>
                
            </div>
        </div>
    </div>
</section>

        


  <div class="container-xl blog mb-4">
    <div class="row">
      <div class="col-xl-8">
        <div class="row">
          
          <div class="col-12 content py-md-3">

            
            
            
              <div class="alert alert-note-container mt-2">
    <div class="alert-note-title px-2 py-2">
      版权声明
    </div>
    <div class="alert-tip px-2">
      本文为 Jimmy Song 原创。转载请注明来源： <a title=https://jimmysong.io/blog/seamless-cross-cluster-access-istio/>https://jimmysong.io/blog/seamless-cross-cluster-access-istio/</a>
     </div>
  </div>
            

            
              <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#istio-的部署模型">Istio 的部署模型</a></li>
    <li><a href="#多集群-istio-服务网格中的-fqdn">多集群 Istio 服务网格中的 FQDN</a></li>
    <li><a href="#跨集群的服务注册发现与路由">跨集群的服务注册发现与路由</a>
      <ul>
        <li><a href="#1-服务注册">1. 服务注册</a></li>
        <li><a href="#2-同步到-istiod">2. 同步到 Istiod</a></li>
        <li><a href="#3-跨集群服务发现">3. 跨集群服务发现</a></li>
        <li><a href="#4-路由和负载均衡">4. 路由和负载均衡</a></li>
        <li><a href="#5-流量管理">5. 流量管理</a></li>
      </ul>
    </li>
    <li><a href="#集群间服务的身份识别与认证">集群间服务的身份识别与认证</a>
      <ul>
        <li><a href="#1--配置-trust-domain">1.  配置 Trust Domain</a></li>
        <li><a href="#2-建立-trust-bundle">2. 建立 Trust Bundle</a></li>
        <li><a href="#3-配置-spire-server-和-agent">3. 配置 SPIRE Server 和 Agent</a></li>
        <li><a href="#4-使用-workload-api">4. 使用 Workload API</a></li>
        <li><a href="#5-自动化证书轮换">5. 自动化证书轮换</a></li>
      </ul>
    </li>
    <li><a href="#部署多集群">部署多集群</a>
      <ul>
        <li><a href="#1-准备-kubernetes-集群">1. 准备 Kubernetes 集群</a></li>
        <li><a href="#2-部署-cert-manager">2. 部署 cert-manager</a></li>
        <li><a href="#3-部署-spire-联邦">3. 部署 SPIRE 联邦</a></li>
        <li><a href="#4-安装-istio">4. 安装 Istio</a></li>
      </ul>
    </li>
    <li><a href="#验证流量联邦">验证流量联邦</a>
      <ul>
        <li><a href="#东西向流量联邦跨集群的服务冗余">东西向流量联邦：跨集群的服务冗余</a></li>
        <li><a href="#东西向流量联邦故障转移">东西向流量联邦：故障转移</a></li>
        <li><a href="#南北向流量联邦通过远程入口网关访问服务">南北向流量联邦：通过远程入口网关访问服务</a></li>
      </ul>
    </li>
    <li><a href="#验证身份">验证身份</a></li>
    <li><a href="#生产环境建议">生产环境建议</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</details>

            
            <h2 id="前言">前言</h2>
<p>随着企业信息系统越来越多地采用微服务架构，如何在多集群环境中实现服务的高效、安全地跨集群访问成为了一个重要的挑战。Istio 作为一种流行的服务网格解决方案，提供了丰富的功能来支持跨集群服务的无缝连接。</p>
<p>在部署和使用多集群服务网格时有以下难点：</p>
<ul>
<li>跨集群的服务注册发现与路由</li>
<li>集群间服务的身份识别与认证</li>
</ul>
<p>本文将深入探讨如何在多集群多网格的 Istio 部署中，通过实施 SPIRE 联邦和东西向网关暴露服务的方式，实现跨集群的无缝访问。通过一系列配置和部署示例，本文旨在为读者提供一个清晰的指南，帮助理解和解决多集群服务网格部署中遇到的常见问题和挑战。</p>
<h2 id="istio-的部署模型">Istio 的部署模型</h2>
<p><a href="https://istio.io/latest/docs/setup/install/multicluster/" title="Istio 文档" target="_blank" rel="noopener">Istio 文档</a>中根据集群、网络、控制平面、网格、信任域及租户等维度划分了多种部署模型，我将其总结并附上适用场景说明如下表所示。</p>

<table>
  <thead>
      <tr>
          <th>维度</th>
          <th>单一配置</th>
          <th>多元配置</th>
          <th>适用场景说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>集群</strong></td>
          <td>一个集群托管所有服务与控制平面。</td>
          <td>跨多个集群分布服务，可以共享或分离控制平面。</td>
          <td>单集群适用于资源需求较小、管理相对简单的环境；多集群适合于需要高可用性、地理冗余或遵守数据驻留政策的大型组织。</td>
      </tr>
      <tr>
          <td><strong>网络</strong></td>
          <td>所有服务在单一网络内通信，无需跨网络通信。</td>
          <td>服务跨越多个网络，需通过 Istio 网关进行通信。</td>
          <td>单网络适用于网络简单、无复杂跨网络通信需求的场景；多网络适合在多云、混合云环境中部署，或需要跨行政边界部署的场景。</td>
      </tr>
      <tr>
          <td><strong>控制平面</strong></td>
          <td>一个控制平面管理所有服务。</td>
          <td>每个控制平面管理一个或多个集群，增强隔离与可用性。</td>
          <td>单控制平面适用于小型至中型部署，易于管理；多控制平面适用于大规模部署，需要高度的容错能力和安全隔离。</td>
      </tr>
      <tr>
          <td><strong>网格</strong></td>
          <td>所有服务在一个连续的服务网格中。</td>
          <td>服务网格之间通过联盟进行通信，适用于不同组织或区域。</td>
          <td>单网格适用于组织内部密切协作的服务；多网格适合于需要隔离不同业务线或合作伙伴间的服务，或实施强隔离的大型组织。</td>
      </tr>
      <tr>
          <td><strong>信任域</strong></td>
          <td>所有服务使用同一套密钥和证书体系。</td>
          <td>不同信任域使用不同的密钥和证书，需进行信任链交换。</td>
          <td>单信任域适用于信任级别统一的环境；多信任域适用于需要严格隔离、满足不同安全级别需求的复杂组织或多方合作场景。</td>
      </tr>
      <tr>
          <td><strong>租户</strong></td>
          <td>整个网格为单一租户或用户服务。</td>
          <td>通过命名空间隔离，支持多个租户在同一网格中运行服务。</td>
          <td>单租户适用于所有资源和服务由单一组织管理的场景；多租户适用于云服务提供商或需要在同一物理基础设施上运营多个客户的场景。</td>
      </tr>
  </tbody>
</table>

<figcaption class="text-center">
    
    Istio 的多维度部署模型及适用场景
    
</figcaption>

<p>选择合适的部署模型需要考虑到实际的业务需求、安全要求、管理复杂度以及成本等因素。在生产环境中，往往是对多种部署模型的组合使用。</p>

<p>下表展示了在实际应用中如何结合不同的部署模型来满足更复杂的业务和技术需求：</p>
<table>
  <thead>
      <tr>
          <th><strong>混合部署模型</strong></th>
          <th><strong>描述</strong></th>
          <th><strong>适用场景</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>多集群 + 多网格 + 多控制平面</strong></td>
          <td>不同的集群可以配置成不同的网格，每个网格都有自己的控制平面。通过网格联邦共享服务和策略。</td>
          <td>适合大型组织，其中不同的业务单位需要独立运行并管理自己的服务，同时需要一定级别的服务共享和协作。</td>
      </tr>
      <tr>
          <td><strong>多信任域联邦 + 命名空间隔离的多租户</strong></td>
          <td>不同的网格可以拥有不同的信任域，通过信任域联邦共享密钥和证书。同时在一个网格内部通过命名空间实现租户隔离。</td>
          <td>适用于需要强隔离但又要求跨组织或跨业务线协作的环境，如跨国公司或合作伙伴网络。</td>
      </tr>
      <tr>
          <td><strong>多集群 + 单网格 + 多控制平面</strong></td>
          <td>多个集群共享一个服务网格，但每个集群拥有自己的控制平面来管理本地服务的配置。</td>
          <td>适用于需要高可用性和灾难恢复能力的应用，各地区的集群可以独立运行，减少单点故障风险。</td>
      </tr>
      <tr>
          <td><strong>多集群 + 多网格 + 单控制平面</strong></td>
          <td>多个集群分布在不同的网格中，但所有网格共享一个中心控制平面。</td>
          <td>适用于中心化管理的大规模部署，可以减少管理的复杂性，但对控制平面的可用性要求极高。</td>
      </tr>
      <tr>
          <td><strong>多信任域 + 多网格 + 命名空间隔离的多租户</strong></td>
          <td>各网格拥有独立的信任域，增强安全性和隔离性。在单个网格内使用命名空间来隔离不同的租户。</td>
          <td>适用于提供云服务的组织，需要隔离不同客户的数据和服务，同时在不同的法律和合规环境下操作。</td>
      </tr>
  </tbody>
</table>
<figcaption class="text-center">
    
    Istio 的部署模型组合
    
</figcaption>

<p>这些混合模型提供了高度的灵活性和可扩展性，能够满足各种复杂的部署要求。在选择混合模型时，组织需要考虑到管理复杂性、成本、安全要求以及业务需求，以确定最合适的部署策略。通过适当的规划和设计，Istio 的灵活部署模型可以帮助组织构建出既安全又高效的服务网格架构。在大多数场景下，单信任域的多集群 + 单网格 + 多控制平面已足够满足需要。</p>
<p>本文将聚焦多集群 + 多网格 + 多控制平面 + 多信任域的混合部署模型，这是一种相当复杂的场景，如果你可以完成这种场景的部署，那么其他场景也就不在话下了。</p>
<h2 id="多集群-istio-服务网格中的-fqdn">多集群 Istio 服务网格中的 FQDN</h2>
<p>网格间的服务要想互相访问，必须了解各自的 FQDN。FQDN 通常由服务名、命名空间和顶级域（如 <code>svc.cluster.local</code>）组成。在 Istio 的多集群或多网格设置中，可以通过不同的机制（如<code>ServiceEntry</code>、<code>VirtualService</code>、<code>Gateway</code> 配置）来控制和管理服务的路由和访问，而不是通过修改 FQDN 来实现。</p>
<p>多集群服务网格中的 FQDN 与单集群并没有什么不同，通常遵循以下格式：</p>
<pre tabindex="0"><code>&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local
</code></pre><p>也许你会想到通过 <code>meshID</code> 来区分网格？<code>meshID</code> 主要用于区分和管理在同一环境中或跨环境的多个 Istio 网格，<code>meshID</code> 并不用于直接构造服务的 FQDN。</p>



<div class="alert alert-note-container">
  
  <div class="alert-note-title px-2 py-2">
    <code>meshID</code> 的主要作用
  </div>
  
  <div class="alert-note px-2">
    <ul>
<li><strong>网格级的遥测数据聚合</strong>：区分不同网格的数据，以便在统一平台上进行监控和分析。</li>
<li><strong>网格联邦</strong>：在网格之间建立联邦关系，允许网格间共享一些配置和服务。</li>
<li><strong>跨网格的策略实施</strong>：识别和应用特定于网格的策略，如安全策略和访问控制。</li>
</ul>

  </div>
</div>

<h2 id="跨集群的服务注册发现与路由">跨集群的服务注册发现与路由</h2>
<p>在 Istio 多网格环境中，东西向网关（East-West Gateway）起着关键作用，它不仅处理网格间的入口和出口流量，还支持服务的发现和连接。当一个集群需要访问另一个集群中的服务时，它通过这个网关路由到目标服务。</p>
<p>下图展示了跨集群的服务注册发现与路由的过程。</p>
<p>在跨集群的 Istio 网格配置中，服务注册、发现和路由的流程是至关重要的，它们确保了不同集群中的服务可以相互发现并通信。以下是跨集群 Istio 网格中服务注册、发现与路由的基本流程：</p>
<h3 id="1-服务注册">1. 服务注册</h3>
<p>在每个 Kubernetes 集群中，当一个服务被部署时，它的信息会被注册到 Kubernetes 的 API Server。这包括服务的名称、标签、选择器、端口等信息。</p>
<h3 id="2-同步到-istiod">2. 同步到 Istiod</h3>
<p>Istiod，作为控制平面，负责监控 Kubernetes API Server 的状态变化。每当有新的服务被注册或现有服务被更新时，Istiod 会自动检测到这些变化。Istiod 接着提取必要的服务信息并构建内部的服务和端点的配置。</p>
<h3 id="3-跨集群服务发现">3. 跨集群服务发现</h3>
<p>为了使一个集群中的服务能够发现并通信到另一个集群的服务，Istiod 需要将服务端点信息同步到所有相关集群。这通常通过以下两种方式之一实现：</p>
<ul>
<li><strong>DNS 解析</strong>：Istio 可配置为利用 CoreDNS 或类似服务，在 DNS 查询中返回跨集群的服务端点。当一个服务尝试解析另一个集群中的服务时，DNS 查询会返回可以访问的远程服务的 IP 地址。在本文中我们将启用 Istio 的 <a href="https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/" title="DNS 代理" target="_blank" rel="noopener">DNS 代理</a>实现跨集群的服务发现。在一个服务同时存在于本地和远程集群中时，在本地执行 DNS 查询只会返回本地服务的 ClusterIP，若该服务只存在于远程集群中时，DNS 查询将返回远程服务所在集群的东西向网关的负载均衡器地址，该特性也可以用于跨集群的故障恢复。</li>
<li><strong>服务入口同步</strong>：通过设置特定的 ServiceEntry 配置，使得一个集群的 Envoy 代理知道如何通过东西向网关找到并路由到另一个集群的服务。</li>
</ul>
<h3 id="4-路由和负载均衡">4. 路由和负载均衡</h3>
<p>当服务 A 需要与服务 B 通信时，它的 Envoy 代理首先解析服务 B 的名称获取 IP 地址，即服务 B 所在集群的东西向网关的负载均衡器地址。接着该东西向网关将请求路由到目标服务。Envoy 代理可以根据配置的负载均衡策略（如轮询、最少连接数等），选择最佳的服务实例来发送请求。</p>
<h3 id="5-流量管理">5. 流量管理</h3>
<p>Istio 提供了丰富的流量管理功能，例如请求路由、故障注入、流量复制等。这些规则在 Istio 的控制平面中定义，并推送到各个 Envoy 代理执行。这样可以在跨集群环境中灵活地控制和优化服务间的通信。</p>
<h2 id="集群间服务的身份识别与认证">集群间服务的身份识别与认证</h2>
<p>当不同集群中运行的服务需要相互通信时，正确的身份认证和授权是确保服务安全的关键。使用 SPIFFE 可以帮助标识和验证服务的身份，但在多集群环境中需要确保这些身份是唯一且可验证的。</p>
<p>为此，我们将设置 SPIRE 联邦来为多集群的服务分配身份并实现跨集群的身份认证：</p>
<ul>
<li><strong>使用 SPIFFE 来标识服务身份</strong>：在 SPIFFE 框架下，每个服务都会被分配一个格式为<code>spiffe://&lt;trust-domain&gt;/&lt;namespace&gt;/&lt;service&gt;</code>的唯一标识符。在多集群环境中，可以通过包括集群名称在内的“trust domain”来确保身份的唯一性。例如，可以设置<code>spiffe://foo.com/ns/default/svc/service1</code>和<code>spiffe://bar.com/ns/default/svc/service1</code>，以区分不同集群中相同名称的服务。</li>
<li><strong>使用 SPIRE 联邦来管理集群间的证书</strong>：它可以增强多集群服务网格中的安全性。SPIRE（SPIFFE Runtime Environment）提供了一个高度可配置的平台，用于服务身份验证和证书颁发。当使用 SPIRE 联邦时，可以实现跨集群的服务认证，通过为每个 SPIRE 集群创建 Trust Bundle 实现跨集群的身份认证。</li>
</ul>
<p>以下是实现 SPIRE 联邦的步骤说明。</p>
<h3 id="1--配置-trust-domain">1.  配置 Trust Domain</h3>
<p>每个集群都配置为一个单独的 trust domain。这样，每个集群内的服务都将具有基于其所在 trust domain 的唯一 SPIFFE ID。例如，集群 1 的服务可能拥有 ID <code>spiffe://cluster1/ns/default/svc/service1</code>，而集群 2 的相同服务则为 <code>spiffe://cluster2/ns/default/svc/service1</code>。</p>
<h3 id="2-建立-trust-bundle">2. 建立 Trust Bundle</h3>
<p>在 SPIRE 中配置 trust relationships 以允许不同 trust domain 的节点和工作负载相互验证。这涉及到 trust domain 之间交换和接受彼此的 CA 证书或 JWT keys，确保跨集群通信的安全性。</p>
<h3 id="3-配置-spire-server-和-agent">3. 配置 SPIRE Server 和 Agent</h3>
<p>在每个集群中部署 SPIRE Server 和 SPIRE Agent。SPIRE Server 负责管理证书颁发和续签，而 SPIRE Agent 负责将证书和密钥安全地分发给集群内的服务。</p>



<div class="alert alert-warning-container">
  
  <div class="alert-warning-title px-2 py-2">
    Istio 使用 SPIRE 联邦时的工作负载注册兼容性问题
  </div>
  
  <div class="alert-warning px-2">
    在本文中，我们将在 SPRIE Server 中使用传统的 Kubernetes Workload Registrar 来负责集群中的工作负载注册。从 SPIRE v1.5.4 起弃用了 Kubernetes Workload Registrar，转而是使用 SPIRE Controller Manager 代替，经我测试并不能与 Istio 很好的运行。
  </div>
</div>

<h3 id="4-使用-workload-api">4. 使用 Workload API</h3>
<p>服务可以通过 SPIRE 的 Workload API 请求和更新其身份证书。这样，服务即使在不同集群中运行，也能持续验证其身份，并安全地与其他服务通信。我们将配置 Istio 网格中的代理共享 SPIRE Agent 中的 Unix Domain Socket，从而访问 Workload API 来管理证书。</p>
<h3 id="5-自动化证书轮换">5. 自动化证书轮换</h3>
<p>我们将使用 cert-manager 作为 SPIRE 的 <a href="https://github.com/spiffe/spire/blob/v1.9.5/doc/plugin_server_upstreamauthority_cert_manager.md" title="UpstreamAuthority" target="_blank" rel="noopener">UpstreamAuthority</a>，配置 SPIRE 自动轮换服务证书和密钥，增强系统的安全性。通过自动化轮换，即使证书被泄露，攻击者也只能在很短的时间内利用这些证书。</p>
<p>通过这些步骤，你可以建立一个跨集群的、安全的服务身份验证框架，使得各个集群的服务能够安全地识别和通信，从而有效地降低安全风险并简化证书管理。这样的配置不仅增强了安全性，还通过分散的信任域提高了系统的可扩展性和灵活性。</p>
<h2 id="部署多集群">部署多集群</h2>
<p>下图展示了 Istio 多集群及 SPIRE 联邦的部署模型。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/multi-cluster-deployment.svg" data-img="/blog/seamless-cross-cluster-access-istio/multi-cluster-deployment.svg" alt="image" data-caption="多集群网格部署模型">
        
      
    
  
  
  <figcaption>多集群网格部署模型</figcaption>
  
</figure>
<p>下面我将演示如何在多集群 Istio 网格中实现无缝地跨集群无缝访问。</p>
<ol>
<li>在 GKE 中创建两个 Kubernetes 集群，分别命名为 <code>cluster-1</code> 和 <code>cluster-2</code></li>
<li>分别在这两个集群中部署 SPIRE 并设置联邦</li>
<li>分别在两个集群中安装 Istio，注意配置信任域、东西向网关、入口网关、 <code>sidecarInjectorWebhook</code> 挂载 SPIFFE UDS 的 <code>workload-socket</code>，并启用 DNS 代理</li>
<li>部署测试应用并验证跨集群的无缝访问</li>
</ol>
<p>我们部署的各组件版本如下：</p>
<ul>
<li>Kubernetes: v1.29.4</li>
<li>Istio: v1.22.1</li>
<li>SPIRE: v1.5.1</li>
<li>cert-manager: v1.15.1</li>
</ul>
<p>我将所有命令及步骤说明保存在 Github 上：<a href="https://github.com/rootsongjc/istio-multi-cluster" title="rootsongjc/istio-multi-cluster" target="_blank" rel="noopener">rootsongjc/istio-multi-cluster</a>，你可以按照该项目中的说明操作。下面是对各主要步骤的说明。</p>
<h3 id="1-准备-kubernetes-集群">1. 准备 Kubernetes 集群</h3>
<p>打开 Google Cloud Shell 或本地终端，并确保你已经安装了 <code>gcloud</code> CLI。使用以下命令创建两个集群：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud container clusters create cluster-1 --zone us-central1-a --num-nodes <span class="m">3</span>
</span></span><span class="line"><span class="cl">gcloud container clusters create cluster-2 --zone us-central1-b --num-nodes <span class="m">3</span>
</span></span></code></pre></div><h3 id="2-部署-cert-manager">2. 部署 cert-manager</h3>
<p>使用 cert-manager 作为根 CA 为 istiod 和 SPIRE 颁发证书。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./cert-manager/install-cert-manager.sh
</span></span></code></pre></div><h3 id="3-部署-spire-联邦">3. 部署 SPIRE 联邦</h3>
<p>SPIRE 联邦的基本信息如下：</p>
<table>
  <thead>
      <tr>
          <th>Cluster Alias</th>
          <th>Trust Domain</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>cluster-1</td>
          <td>foo.com</td>
      </tr>
      <tr>
          <td>cluster-2</td>
          <td>bar.com</td>
      </tr>
  </tbody>
</table>
<p>注意：信任域不需要与 DNS 名称一致，但需要与 Istio Operator 配置中的信任域相同。</p>
<p>执行下面的命令部署 SPIRE 联邦：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./spire/install-spire.sh
</span></span></code></pre></div><p>想了解 Istio 中使用 SPIRE 进行身份管理的详情，请参考<a href="/blog/cert-manager-spire-istio/" title="使用 cert-manager 和 SPIRE 管理 Istio 中的证书">使用 cert-manager 和 SPIRE 管理 Istio 中的证书</a>。</p>
<h3 id="4-安装-istio">4. 安装 Istio</h3>
<p>我们将使用 IstioOperator 来安装 Istio，其中为每个集群配置了：</p>
<ul>
<li>自动 Sidecar 注入</li>
<li>入口网关</li>
<li>东西向网关</li>
<li>DNS 代理</li>
<li>SPIRE 集成</li>
<li>访问远程 Kubernetes 集群的 Secret</li>
</ul>
<p>执行下面的命令安装 Istio：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">istio/install-istio.sh
</span></span></code></pre></div><h2 id="验证流量联邦">验证流量联邦</h2>
<p>为了验证多集群安装的正确性，我们将在两个集群中分别部署不同版本的 <code>helloworld</code> 应用，然后在 <code>cluster-1</code> 中访问 <code>helloworld</code> 服务，以测试以下跨集群访问场景：</p>
<ol>
<li>东西向流量联邦：跨集群的服务冗余</li>
<li>东西向流量联邦：处理非本地目标服务</li>
<li>南北向流量联邦：通过远程入口网关访问服务</li>
</ol>
<p>执行下面的命令在两个集群中部署 <code>helloworld</code> 应用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./example/deploy-helloword.sh
</span></span></code></pre></div><h3 id="东西向流量联邦跨集群的服务冗余">东西向流量联邦：跨集群的服务冗余</h3>
<p>部署完成 <code>helloworld</code> 应用后，从 <code>cluster-1</code> 的 <code>sleep</code> pod 访问 <code>hellowrold</code> 服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> --context<span class="o">=</span>cluster-1 -n sleep deployment/sleep -c sleep <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-- sh -c <span class="s2">&#34;while :; do curl -sS helloworld.helloworld:5000/hello; sleep 1; done&#34;</span>
</span></span></code></pre></div><p>下图展示的是该场景下的部署架构及流量路由路径。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/east-west-traffic-federation-between-clusters-without-dns-proxying.svg" data-img="/blog/seamless-cross-cluster-access-istio/east-west-traffic-federation-between-clusters-without-dns-proxying.svg" alt="image" data-caption="东西向流量联邦：跨集群的服务冗余">
        
      
    
  
  
  <figcaption>东西向流量联邦：跨集群的服务冗余</figcaption>
  
</figure>
<p>从请求结果既有 <code>helloworld-v1</code> 又有 <code>helloworld-v2</code> 的响应来看，说明跨集群的服务冗余生效了。</p>
<p><strong>验证 DNS</strong></p>
<p>此时，因为 <code>helloworld</code> 服务既存在于本地又在远程集群中，若你在 <code>cluster-1</code> 中查询 <code>helloworld</code> 服务的 DNS 名称：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it deploy/sleep --context<span class="o">=</span>cluster-1 -n sleep -- nslookup helloworld.helloworld.svc.cluster.local
</span></span></code></pre></div><p>你将得到  <code>cluster-1</code> 集群中的 <code>helloworld</code> 服务的 ClusterIP。</p>
<p><strong>验证流量路由</strong></p>
<p>接下来我们将通过查看 Envoy 代理配置来验证跨集群的流量路由路径。</p>
<p>在 <code>cluster-1</code> 中查看 <code>helloworld</code> 服务的端点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">istioctl proxy-config endpoints deployment/sleep.sleep --context<span class="o">=</span>cluster-1 --cluster <span class="s2">&#34;outbound|5000||helloworld.helloworld.svc.cluster.local&#34;</span>
</span></span></code></pre></div><p>你将得到类似下面的输出：</p>
<pre tabindex="0"><code>ENDPOINT               STATUS      OUTLIER CHECK     CLUSTER
10.76.3.22:5000        HEALTHY     OK                outbound|5000||helloworld.helloworld.svc.cluster.local
34.136.67.85:15443     HEALTHY     OK                outbound|5000||helloworld.helloworld.svc.cluster.local
</code></pre><p>这两个端点，一个是 <code>cluster-1</code> 中的 <code>helloworld</code> 服务的端点，另一个是 <code>cluster-2</code> 的 <code>istio-eastwestgateway</code> 服务的负载均衡器地址。Istio 将为跨集群的 TLS 连接设置 SNI，在 <code>cluster-2</code> 中将通过 SNI 区分目标服务。</p>
<p>执行下面的命令，在 <code>cluster-2</code> 中查询前面 SNI 的端点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">istioctl proxy-config endpoints deploy/istio-eastwestgateway.istio-system --context<span class="o">=</span>cluster-2 --cluster <span class="s2">&#34;outbound_.5000_._.helloworld.helloworld.svc.cluster.local&#34;</span>
</span></span></code></pre></div><p>你将得到类似下面的结果：</p>
<pre tabindex="0"><code>ENDPOINT           STATUS      OUTLIER CHECK     CLUSTER
10.88.2.4:5000     HEALTHY     OK                outbound_.5000_._.helloworld.helloworld.svc.cluster.local
</code></pre><p>这个端点就是 <code>helloworld</code> 服务在 <code>cluster-2</code> 集群中的端点。</p>
<p>通过以上步骤，你应该了解了跨集群冗余服务的流量路径。接下来我们将删除 <code>cluster-1</code> 中的 <code>helloworld</code> 服务，不需要对 Istio 做任何配置，就可以自动实现故障转移。</p>
<h3 id="东西向流量联邦故障转移">东西向流量联邦：故障转移</h3>
<p>执行下面的命令将 <code>cluster-1</code>  中的 <code>helloworld</code> 副本数量缩容为 0：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl -n helloworld scale deploy helloworld-v1 --context<span class="o">=</span>cluster-1 --replicas <span class="m">0</span>
</span></span></code></pre></div><p>再次从 <code>cluster-1</code> 中访问 <code>helloworld</code> 服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> --context<span class="o">=</span>cluster-1 -n sleep deployment/sleep -c sleep <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-- sh -c <span class="s2">&#34;while :; do curl -sS helloworld.helloworld:5000/hello; sleep 1; done&#34;</span>
</span></span></code></pre></div><p>依然可以获得来自 <code>helloworld-v2</code> 的响应。</p>
<p>现在，直接删除 <code>cluster-1</code> 中的 <code>helloworld</code> 服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl delete service helloworld -n helloworld --context<span class="o">=</span>cluster-1
</span></span></code></pre></div><p>依然可以获得来自 <code>helloworld-v2</code> 的响应，这说明跨集群的故障转移生效了。</p>
<p>下图展示了该场景下的流量路径。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/east-west-traffic-federation-between-clusters-failover.svg" data-img="/blog/seamless-cross-cluster-access-istio/east-west-traffic-federation-between-clusters-failover.svg" alt="image" data-caption="东西向流量联邦：故障转移">
        
      
    
  
  
  <figcaption>东西向流量联邦：故障转移</figcaption>
  
</figure>
<p><strong>验证 DNS</strong></p>
<p>此时，因为 <code>helloworld</code> 服务既存在于本地又在远程集群中，若你在 <code>cluster-1</code> 中查询 <code>helloworld</code> 服务的 DNS 名称：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it deploy/sleep --context<span class="o">=</span>cluster-1 -n sleep -- nslookup helloworld.helloworld.svc.cluster.local
</span></span></code></pre></div><p>你将得到  <code>cluster-2</code> 集群中东西向网关的地址和 15443 端口。</p>
<h3 id="南北向流量联邦通过远程入口网关访问服务">南北向流量联邦：通过远程入口网关访问服务</h3>
<p>通过入口网关访问远程集群中的服务，是最传统的跨集群访问方式，下图展示了该场景下的流量路径。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/north-south-traffic-federation-between-clusters.svg" data-img="/blog/seamless-cross-cluster-access-istio/north-south-traffic-federation-between-clusters.svg" alt="image" data-caption="南北向流量联邦：通过远程入口网关访问服务">
        
      
    
  
  
  <figcaption>南北向流量联邦：通过远程入口网关访问服务</figcaption>
  
</figure>
<p>执行下面的命令在 <code>cluster-2</code> 中创建 Gateway 和 VirtualService：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply --context<span class="o">=</span>cluster-2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-f ./examples/helloworld-gateway.yaml -n helloworld
</span></span></code></pre></div><p>获取 <code>cluster-2</code> 中的入口网关地址：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">GATEWAY_URL</span><span class="o">=</span><span class="k">$(</span>kubectl -n istio-ingress --context<span class="o">=</span>cluster-2 get service istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class="k">)</span>
</span></span></code></pre></div><p>执行下面的验证可以通过远程入口网关访问服务：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> --context<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CTX_CLUSTER1</span><span class="si">}</span><span class="s2">&#34;</span> -n sleep deployment/sleep -c sleep <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-- sh -c <span class="s2">&#34;while :; do curl -s http://</span><span class="nv">$GATEWAY_URL</span><span class="s2">/hello; sleep 1; done&#34;</span>
</span></span></code></pre></div><p>你将得到来自 <code>helloworld-v2</code> 的响应。</p>
<h2 id="验证身份">验证身份</h2>
<p>执行下面的命令获取 <code>cluster-1</code> 集群中 <code>sleep</code> pod 中的证书：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">istioctl proxy-config secret deployment/sleep -o json --context<span class="o">=</span>cluster-1<span class="p">|</span> jq -r <span class="s1">&#39;.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes&#39;</span> <span class="p">|</span> base64 --decode &gt; chain.pem
</span></span><span class="line"><span class="cl">split -p <span class="s2">&#34;-----BEGIN CERTIFICATE-----&#34;</span> chain.pem cert-
</span></span><span class="line"><span class="cl">openssl x509 -noout -text -in cert-ab
</span></span><span class="line"><span class="cl">openssl x509 -noout -text -in cert-aa
</span></span></code></pre></div><p>如果在输出的消息中看到下面的字段，说明身份分配正确：</p>
<pre tabindex="0"><code>Subject: C=US, O=SPIFFE

URI:spiffe://foo.com/ns/sample/sa/sleep
</code></pre><p>查看 SPIRE 中的身份信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --context<span class="o">=</span>cluster-1 <span class="nb">exec</span> -i -t -n spire spire-server-0 -c spire-server <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-- ./bin/spire-server entry show -socketPath /run/spire/sockets/server.sock --spiffeID spiffe://foo.com/ns/sleep/sa/sleep
</span></span></code></pre></div><p>你将看到类似下面的输出：</p>
<pre tabindex="0"><code>Found 1 entry
Entry ID         : 9b09080d-3b67-44c2-a5b8-63c42ee03a3a
SPIFFE ID        : spiffe://foo.com/ns/sleep/sa/sleep
Parent ID        : spiffe://foo.com/k8s-workload-registrar/cluster-1/node/gke-cluster-1-default-pool-18d66649-z1lm
Revision         : 1
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:node-name:gke-cluster-1-default-pool-18d66649-z1lm
Selector         : k8s:ns:sleep
Selector         : k8s:pod-uid:6800aca8-7627-4a30-ba30-5f9bdb5acdb2
FederatesWith    : bar.com
DNS name         : sleep-86bfc4d596-rgdkf
DNS name         : sleep.sleep.svc
</code></pre><h2 id="生产环境建议">生产环境建议</h2>
<p>对于生产环境，建议使用<a href="https://docs.tetrate.io/service-bridge/howto/gateway/unified-gateway" title="统一网关" target="_blank" rel="noopener">统一网关</a>，通过 Tier-2 架构，在 Tier-1 边缘网关配置全局的流量路由，该边缘网关将把转写的 Istio 配置下发给 Tier-2 集群中的各个入口网关。</p>
<p>下图展示了使用 TSB 部署的 Tier2 架构的 Istio 服务网格，其中使用 SPIRE 联邦。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/tsb-multi-cluster-architeture.svg" data-img="/blog/seamless-cross-cluster-access-istio/tsb-multi-cluster-architeture.svg" alt="image" data-caption="使用 SPIRE、Tier2 架构的 TSB 部署的多集群 Istio 服务网格架构图">
        
      
    
  
  
  <figcaption>使用 SPIRE、Tier2 架构的 TSB 部署的多集群 Istio 服务网格架构图</figcaption>
  
</figure>
<p>我们将这四个 Kubernetes 集群分为 Tier1 集群（<code>tier1</code>）和 Tier2 集群（<code>cp-cluster-1</code>、<code>cp-cluster-2</code> 和 <code>cp-cluster-3</code>）。在 T1 中安装 Edge Gateway，而在 T2 中安装 bookinfo 和 httpbin 应用程序。每个集群将拥有独立的信任域，所有这些集群将构成 SPIRE 联邦。</p>
<p>下图展示了用户通过入口网关访问 bookinfo 和 httpbin 服务的流量路由。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/blog/seamless-cross-cluster-access-istio/tsb-unified-gateway.svg" data-img="/blog/seamless-cross-cluster-access-istio/tsb-unified-gateway.svg" alt="image" data-caption="统一网关架构图">
        
      
    
  
  
  <figcaption>统一网关架构图</figcaption>
  
</figure>
<p>你需要在 Istio 之上创建一个适用于多集群的逻辑抽象层，关于 TSB 中的统一网关的详细信息，请参考 <a href="https://docs.tetrate.io/service-bridge/howto/gateway/unified-gateway#scenario-1-cluster-based-routing-with-http-path-and-header-match" title="TSB 文档" target="_blank" rel="noopener">TSB 文档</a>.</p>
<h2 id="总结">总结</h2>
<p>本文详细介绍了在 Istio 多集群网格环境中实现服务身份验证、DNS 解析和跨集群流量管理的关键技术和方法。通过精确配置 Istio 和 SPIRE 联邦，我们不仅增强了系统的安全性，还提高了服务间通信的效率和可靠性。遵循这些步骤，你将能够构建一个强大的、可扩展的多集群服务网格，满足现代应用的复杂需求。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://spiffe.io/docs/latest/architecture/federation/readme/" title="Deploying a Federated SPIRE Architecture - spiffe.io" target="_blank" rel="noopener">Deploying a Federated SPIRE Architecture - spiffe.io</a></li>
<li><a href="https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/" title="Install Multi-Primary on different networks -istio.io" target="_blank" rel="noopener">Install Multi-Primary on different networks -istio.io</a></li>
<li><a href="https://istio.io/latest/docs/ops/integrations/spire" title="Istio SPIRE Integration - istio.io" target="_blank" rel="noopener">Istio SPIRE Integration - istio.io</a></li>
<li><a href="https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/" title="DNS Proxying - istio.io" target="_blank" rel="noopener">DNS Proxying - istio.io</a></li>
<li><a href="https://developer.ibm.com/articles/istio-identity-spiffe-spire/" title="Attesting Istio workload identities with SPIFFE and SPIRE - developer.ibm.com" target="_blank" rel="noopener">Attesting Istio workload identities with SPIFFE and SPIRE - developer.ibm.com</a></li>
<li><a href="https://istio.io/latest/blog/2020/dns-proxy/" title="Expanding into New Frontiers - Smart DNS Proxying in Istio - istio.io" target="_blank" rel="noopener">Expanding into New Frontiers - Smart DNS Proxying in Istio - istio.io</a></li>
<li><a href="https://jimmysong.io/blog/cert-manager-spire-istio/" title="使用 cert-manager 和 SPIRE 管理 Istio 中的证书 - jimmysong.io" target="_blank" rel="noopener">使用 cert-manager 和 SPIRE 管理 Istio 中的证书 - jimmysong.io</a></li>
</ul>

            <div class="border-bottom mb-2"></div>
          </div>
          <div class="col-12">
            <p>最后更新于 2024/12/20</p>
            


            


          </div>
          
          <div class="col-12">
              <div class="list-inline-item text-light">
              
              <a href="/tags/istio" class="badge"> 
                  Istio</a> 
              <a href="/tags/dns" class="badge">  
                  DNS</a> 
              <a href="/tags/%e5%a4%9a%e9%9b%86%e7%be%a4" class="badge">  
                  多集群</a> 
              <a href="/tags/spire" class="badge">  
                  SPIRE</a> </div>
          </div>
          
          <div class="col-12">
            









    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
        
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    






    



    


<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/blog/exploring-fantastic-planet/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; 上一篇</span>
            <span class="text-align-left">Fantastic Planet：权力、解放与文明间的微妙平衡 — 深入探索原始星球中知识和自由的力量</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/blog/gateway-api-istio-ingress-evolution/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">下一篇 &rarr;</span>
            <span class="text-align-right">探索 Kubernetes Ingress、Gateway API 与 Istio 的演进和转型</span>
        </a>
    </div>
     
</div>

          </div>

          
          
          <div class="col-12">
            <script src="https://giscus.app/client.js"
        data-repo="rootsongjc/rootsongjc.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTQ1MzczNA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAd_yJs4CPNtR"
        data-mapping="pathname"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        
        data-lang="zh-CN"
        
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
      <aside class="px-2 col-xl-4 py-md-3 d-none d-xl-block">
          <div class="sidebar">
          <!-- recommend -->
          











<div>
  <p class="related-sidebar-title">
  相关文章
  </p>
  <!-- related-blog-item -->
    <ul class="related-list">
    
      <li>
          <a href="/blog/demystifying-the-load-balancing-in-istio/">
            Istio 中的负载均衡详解及多集群路由实践
          </a>
      </li>
    
      <li>
          <a href="/blog/cert-manager-spire-istio/">
            使用 cert-manager 和 SPIRE 管理 Istio 中的证书
          </a>
      </li>
    
      <li>
          <a href="/blog/understanding-the-tls-encryption-in-istio/">
            如何理解 Istio 中的 mTLS 流量加密？
          </a>
      </li>
    
      <li>
          <a href="/blog/how-to-integrate-spire-with-istio/">
            如何在 Istio 中集成 SPIRE？
          </a>
      </li>
    
      <li>
          <a href="/blog/why-istio-need-spire/">
            为什么 Istio 要使用 SPIRE 做身份认证？
          </a>
      </li>
    
    </ul>
</div>


          <!-- /recommend -->
          <!-- toc -->
          
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#istio-的部署模型">Istio 的部署模型</a></li>
    <li><a href="#多集群-istio-服务网格中的-fqdn">多集群 Istio 服务网格中的 FQDN</a></li>
    <li><a href="#跨集群的服务注册发现与路由">跨集群的服务注册发现与路由</a>
      <ul>
        <li><a href="#1-服务注册">1. 服务注册</a></li>
        <li><a href="#2-同步到-istiod">2. 同步到 Istiod</a></li>
        <li><a href="#3-跨集群服务发现">3. 跨集群服务发现</a></li>
        <li><a href="#4-路由和负载均衡">4. 路由和负载均衡</a></li>
        <li><a href="#5-流量管理">5. 流量管理</a></li>
      </ul>
    </li>
    <li><a href="#集群间服务的身份识别与认证">集群间服务的身份识别与认证</a>
      <ul>
        <li><a href="#1--配置-trust-domain">1.  配置 Trust Domain</a></li>
        <li><a href="#2-建立-trust-bundle">2. 建立 Trust Bundle</a></li>
        <li><a href="#3-配置-spire-server-和-agent">3. 配置 SPIRE Server 和 Agent</a></li>
        <li><a href="#4-使用-workload-api">4. 使用 Workload API</a></li>
        <li><a href="#5-自动化证书轮换">5. 自动化证书轮换</a></li>
      </ul>
    </li>
    <li><a href="#部署多集群">部署多集群</a>
      <ul>
        <li><a href="#1-准备-kubernetes-集群">1. 准备 Kubernetes 集群</a></li>
        <li><a href="#2-部署-cert-manager">2. 部署 cert-manager</a></li>
        <li><a href="#3-部署-spire-联邦">3. 部署 SPIRE 联邦</a></li>
        <li><a href="#4-安装-istio">4. 安装 Istio</a></li>
      </ul>
    </li>
    <li><a href="#验证流量联邦">验证流量联邦</a>
      <ul>
        <li><a href="#东西向流量联邦跨集群的服务冗余">东西向流量联邦：跨集群的服务冗余</a></li>
        <li><a href="#东西向流量联邦故障转移">东西向流量联邦：故障转移</a></li>
        <li><a href="#南北向流量联邦通过远程入口网关访问服务">南北向流量联邦：通过远程入口网关访问服务</a></li>
      </ul>
    </li>
    <li><a href="#验证身份">验证身份</a></li>
    <li><a href="#生产环境建议">生产环境建议</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>



          <!-- /toc -->
          <!-- ad-->
          

          <!-- /ad -->
          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-ext-proc-guide/">深入解析 Envoy 外部处理过滤器（ext_proc）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-ambient-l7-flow-analysis/">深入 Istio Ambient 模式：从 ztunnel 到 Waypoint 代理的 L7 流量路径解析</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/building-private-ai-knowledge-base-anythingllm/">探索 AnythingLLM：借助开源 AI 打造私有化智能知识库</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
