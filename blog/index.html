<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>博客 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="专注开源技术、云原生与生活随笔的分享与思考。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/" />
  <meta property="og:title" content="博客 | Jimmy Song" />
  <meta property="twitter:title" content="博客 | Jimmy Song" />

  
  <meta property="og:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />
  <meta property="twitter:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    博客
                </p>
                <p class="page-description">
                    专注开源技术、云原生与生活随笔的分享与思考。
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-mesh-open-policy-agent-authorization/">[译] 在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/15</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://tylerscha.de/articles/2024-09-22-opa-istio-ambient.html" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA) 实现细粒度授权', '本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。', '\n*这是关于在 Istio Ambient Mesh 中使用 Open Policy Agent (OPA) 的系列文章的第一篇。系列文章将涵盖如何使用 OPA 作为外部授权服务，建议的部署模式，以及提高可靠性和可扩展性的最佳架构。我们还将讨论使用 OPA 进行资源验证和控制 Istio 功能。*\n\n正如我在[之前的文章](https:\/\/tylerscha.de\/articles\/2024-08-29-five-things-i-like-lately.html)中提到的，我对 Istio Ambient Mesh 感到非常兴奋。这是服务网格的显著进步，我致力于帮助大家理解如何利用 Ambient 来实现目标。我认为目前关于 Ambient 的用例和教程内容还比较少，我希望能帮助填补这个空白。\n\n本文将介绍如何在 Istio Ambient Mesh 中设置 Open Policy Agent (OPA) 作为外部授权服务。授权是任何安全模型的重要组成部分，而 OPA 是实现细粒度访问控制策略的强大工具。通过将 OPA 用作外部授权服务，你可以强制执行比 Istio 内置授权策略更复杂的策略。\n\nOPA 具有插件模型，允许在基础策略引擎之上添加额外功能。虽然这是一个复杂的用例，但幸运的是，[OPA 社区已经创建并维护了](https:\/\/github.com\/open-policy-agent\/opa-envoy-plugin)实现 [Envoy 外部授权 API](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/ext_authz_filter) 的 OPA 引擎版本。因此，你无需编写任何自定义代码即可在 Istio Ambient Mesh 中使用 OPA 作为外部授权服务。\n\n#### 集群架构图\n\n![OPA 和 Istio Ambient](istio-ambient-opa-without-traffic.webp)\n\n在上图中，你可以看到我们集群中的资源架构。我们有三个命名空间：默认的 \u0060istio-system\u0060 命名空间（Istio 控制平面 istiod 和 ztunnel 代理运行的地方）、安装示例应用的 \u0060app\u0060 命名空间，以及 OPA 运行的 \u0060platform\u0060 命名空间。在这个例子中，我们将 OPA 部署为单个 Deployment。在后续文章中，我会介绍如何将 OPA 部署为 DaemonSet。\n\n#### 带有流量的集群架构图\n\n![OPA 和 Istio Ambient（带有流量）](istio-ambient-opa-with-traffic.webp)\n\n上图展示了与之前相同的集群，但此时有流量通过系统。在本教程中，我们将发送流量到 \u0060app\u0060 命名空间中的 Waypoint 代理，该代理会向 \u0060platform\u0060 命名空间中的 OPA 服务进行授权检查。OPA 服务根据定义的策略返回决策，允许或拒绝请求。如果请求被允许，Waypoint 代理会将请求转发到 \u0060app\u0060 命名空间中的目标服务，否则将返回 403 Forbidden 响应。\n\n### 集群安装与配置\n\n首先，让我们创建集群并使用 Ambient 模式安装 Istio，以及 Kubernetes Gateway API：\n\n\u0060\u0060\u0060bash\n# 创建集群\nkind create cluster --name istio-opa\n\n# 使用 Ambient 模式安装 Istio\nistioctl install --set profile=ambient --skip-confirmation\n\n# 安装 gateway-api CRD\nkubectl get crd gateways.gateway.networking.k8s.io \u0026\u003e \/dev\/null || \\\n    { kubectl apply -f https:\/\/github.com\/kubernetes-sigs\/gateway-api\/releases\/download\/v1.1.0\/standard-install.yaml; }\n\u0060\u0060\u0060\n\n接下来，创建 \u0060app\u0060 命名空间并安装 Istio 的 bookinfo 示例应用及 \u0060sleep\u0060 Pod，这将帮助我们进行集群内的测试：\n\n\u0060\u0060\u0060bash\n# 创建命名空间\nkubectl create namespace app\n\n# 安装 bookinfo 示例应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo.yaml\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/platform\/kube\/bookinfo-versions.yaml\n\n# 安装 sleep 应用\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/sleep\/sleep.yaml\n\u0060\u0060\u0060\n\n我们还需要创建 Waypoint 代理，作为集群入口网关，并为 \u0060app\u0060 命名空间配置 Ambient 模式：\n\n\u0060\u0060\u0060bash\n# 为 productpage 应用创建网关\nkubectl apply -n app -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.23\/samples\/bookinfo\/gateway-api\/bookinfo-gateway.yaml\nistioctl waypoint apply -n app --enroll-namespace --wait\n\n# 为网关添加 ClusterIP 类型\nkubectl annotate gateway bookinfo-gateway networking.istio.io\/service-type=ClusterIP --namespace=app\n\n# 将命名空间标记为 Ambient 模式\nkubectl label namespace app istio.io\/dataplane-mode=ambient\n\u0060\u0060\u0060\n\n接下来，创建 \u0060platform\u0060 命名空间来运行 OPA 服务：\n\n\u0060\u0060\u0060bash\nkubectl create namespace platform\n\u0060\u0060\u0060\n\n### 部署 Open Policy Agent\n\n首先，部署 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: opa-istio\n  template:\n    metadata:\n      labels:\n        app: opa-istio\n    spec:\n      containers:\n      - name: opa-istio\n        image: openpolicyagent\/opa:0.68.0-istio-4-static\n        ports:\n        - containerPort: 9191\n        - containerPort: 8282\n        - containerPort: 8181\n        args:\n        - \u0022run\u0022\n        - \u0022--server\u0022\n        - \u0022--addr=0.0.0.0:8181\u0022\n        - \u0022--config-file=\/config\/config.yaml\u0022\n        - \u0022\/policy\/policy.rego\u0022\n        volumeMounts:\n        - name: opa-istio-config\n          mountPath: \/config\n        - name: opa-policy\n          mountPath: \/policy\nEOF\n\u0060\u0060\u0060\n\n接着，我们需要定义两个 ConfigMap 来配置 OPA：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-istio-config\n  namespace: platform\ndata:\n  config.yaml: |\n    plugins:\n      envoy_ext_authz_grpc:\n        addr: 0.0.0.0:9191\n        path: istio\/authz\/allow\n    decision_logs:\n      console: true\nEOF\n\u0060\u0060\u0060\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: opa-policy\n  namespace: platform\ndata:\n  policy.rego: |\n    package istio.authz\n    import input.attributes.request.http as http_request\n    import input.parsed_path\n    default allow = false\n    allow { roles_for_user[r] required_roles[r] }\n    roles_for_user[r] { r := user_roles[user_name][_] }\n    required_roles[r] { perm := role_perms[r][_] perm.method = http_request.method perm.path = http_request.path }\n    user_name = parsed { [_, encoded] := split(http_request.headers.authorization, \u0022 \u0022) [parsed, _] := split(base64url.decode(encoded), \u0022:\u0022) }\n    user_roles = { \u0022alice\u0022: [\u0022guest\u0022], \u0022bob\u0022: [\u0022admin\u0022] }\n    role_perms = { \u0022guest\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, ], \u0022admin\u0022: [ { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/productpage\u0022 }, { \u0022method\u0022: \u0022GET\u0022, \u0022path\u0022: \u0022\/api\/v1\/products\u0022 }, ], }\nEOF\n\u0060\u0060\u0060\n\n最后，为 OPA 创建服务并配置 Istio MeshConfig：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: opa-istio\n  namespace: platform\nspec:\n  ports:\n  - name: grpc\n    port: 9191\n    targetPort: 9191\n  selector:\n    app: opa-istio\nEOF\n\u0060\u0060\u0060\n\n编辑 Istio \u0060MeshConfig\u0060，将 OPA 注册为 \u0060extensionProvider\u0060：\n\n\u0060\u0060\u0060bash\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: istio\n  namespace: istio-system\ndata:\n  mesh: |-\n    extensionProviders:\n    - name: opa-ext-authz-grpc\n      envoyExtAuthzGrpc:\n        service: opa-istio.platform.svc.cluster.local\n        port: 9191\n\u0060\u0060\u0060\n\n### 测试\n\n通过 \u0060kubectl port-forward\u0060 命令，将 \u0060bookinfo-gateway\u0060 服务的端口转发到本地：\n\n\u0060\u0060\u0060bash\nkubectl port-forward -n app svc\/bookinfo-gateway-istio 8080:80\n\u0060\u0060\u0060\n\n然后，使用 Alice 和 Bob 用户发送请求，验证不同权限的访问控制：\n\n\u0060\u0060\u0060bash\ncurl --user alice:password -vik http:\/\/localhost\n\n:8080\/api\/v1\/products # 应返回 403\ncurl --user alice:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/api\/v1\/products # 应返回 JSON 响应\ncurl --user bob:password -vik http:\/\/localhost:8080\/productpage # 应返回 HTML 响应\n\u0060\u0060\u0060\n\n最后，应用 Istio 的 \u0060AuthorizationPolicy\u0060：\n\n\u0060\u0060\u0060bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: ext-authz\n  namespace: app\nspec:\n  action: CUSTOM\n  provider:\n    name: opa-ext-authz-grpc\n  rules:\n  - to:\n    - operation:\n        paths: [\u0022*\u0022]\nEOF\n\u0060\u0060\u0060\n\n通过上述步骤，你已经成功配置了 OPA 作为 Istio Ambient Mesh 中的外部授权服务。在后续文章中，我们将讨论 OPA 在 Waypoint 代理中的最佳实践。\n', '\/trans\/istio-ambient-mesh-open-policy-agent-authorization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了如何在 Istio Ambient Mesh 中集成 Open Policy Agent (OPA)，实现更强大的外部授权服务。通过 OPA，用户可以定义和执行细粒度的访问控制策略，超越 Istio 内置的授权功能。文章涵盖了 OPA 部署、集群配置以及示例应用，帮助用户在 Ambient Mesh 中轻松实现安全性和灵活性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-waypoint-proxy-deployment-model-explained/">[译] 解读 Istio Ambient Waypoint Proxy 部署模型</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/10/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://www.solo.io/blog/istio-ambient-waypoint-proxy-deployment-model-explained/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('解读 Istio Ambient Waypoint Proxy 部署模型', '本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。', '\n\u003e 译者注：Istio Ambient Waypoint Proxy 为服务网格的 L7 处理提供了灵活且高效的解决方案。通过了解不同的部署模式，团队可以根据自身需求选择最合适的架构，避免资源浪费和性能瓶颈。避免按节点部署 waypoint proxy，有助于降低故障域的影响，提升应用的稳定性和性能。正确地部署和配置 waypoint proxy，将有助于充分发挥 Istio Ambient 模式的优势，实现高效、安全的服务通信。\n\nAmbient 模式是 Istio 在 2022 年引入的新型无边车数据平面，并于今年 5 月达到 [Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 状态。Istio 社区正努力在下一个 Istio v1.24 版本中将 Ambient 推向 GA（一般可用）状态。Ambient 将 Istio 的功能分为两个独立的层：安全覆盖层和第 7 层处理层。在与许多试用 Ambient 的用户合作时，我想澄清关于 waypoint proxy 的一些常见问题和困惑。它是一个可选的基于 Envoy 的组件，负责处理其管理的工作负载的 L7 事务。\n\n## Waypoint Proxy 的常见部署模式是什么？\n\n### 理解 Waypoint Proxy\n\n你可以将 waypoint proxy 简单地视为一组目的地的网关，这些目的地可以是来自一个或多个命名空间的一个或多个服务和工作负载。除了处理集群内部的 L7 流量外，它与你的入口或出口网关没有太大区别。这也是为什么在部署 waypoint proxy 时需要使用 Kubernetes 的 Gateway 资源的原因。\n\n我非常喜欢 waypoint 架构的灵活性，你可以选择适合自己需求的架构。以下是一些常见的模式：\n\n### A: 针对命名空间的 Waypoint Proxy\n\n最常见的模式是，每个团队在集群中拥有一个命名空间，并管理该命名空间内的服务和部署。在这种模式下，我们期望每个团队都有自己的 waypoint proxy，供命名空间内的服务使用。按照这种模式，我们将默认的 waypoint 部署设计为命名空间范围，供命名空间内的所有服务使用。在下图中，服务 A、B、C 位于同一命名空间内。所有到服务 A、B 或 C 的 Ambient Mesh 客户端流量将通过命名空间的 waypoint proxy，由客户端的 ztunnel 进行编程。\n\n![Istio Ambient Waypoint 代理部署模型](f1.webp)\n\n注意：为简洁起见，省略了目的地端的 ztunnel\n\n### B: 针对部分服务的 Waypoint Proxy\n\n如果你不希望到服务 B 的流量经过 waypoint proxy 怎么办？一个常见的原因是，你只需要对服务 B 的流量进行 L4 层的控制，这样在调用它时就不需要通过 waypoint proxy。例如，你有一个调用 MySQL 数据库服务的 Web 服务，只需要对其进行 L4 控制。另一个例子是，当服务是“内部”的，只被命名空间内的其他服务调用，你只需要对跨命名空间边界的服务进行授权策略。例如，在著名的 [Bookinfo 应用程序](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/)中，你可以为 productpage 服务启用零信任，拒绝除端口 9080 上 GET 方法的流量之外的所有流量。对于所有内部服务，如 reviews 或 details 服务，你可以继续允许命名空间内的所有流量。\n\n另一个用例是，服务 A 的流量非常大，你希望有一个专用的 waypoint proxy 来处理其 L7 处理，以便调整资源配置来应对高负载。你可以配置服务 B 或 C 使用不同的 waypoint，避免受到服务 A 的影响，或根据需要跳过它。我们将在下面的部分中详细讨论这一点。\n\n![Istio ambient waypoint 代理部署模型](f2.webp)\n\n### C: 多个命名空间共享一个 Waypoint Proxy\n\n你也可以通过为命名空间添加 \u0060istio.io\/use-waypoint\u0060 标签，并在 Gateway 资源中配置 \u0060allowRoutes\u0060，来让多个命名空间共享一个 waypoint proxy。如果你运行的是小型集群，想要优化资源效率，并且对嘈杂邻居问题不太担心，你可能希望为整个集群使用一个 waypoint proxy。这种情况下的一个常见例子是所谓的 [K8S-at-the-edge](https:\/\/events.linuxfoundation.org\/kubecon-cloudnativecon-europe\/co-located-events\/kubernetes-on-edge-day\/#about)。\n\n\u003e “当应用程序跨越太多命名空间时，使用 waypoint 为多个命名空间服务更具资源效率，通过提升无边车服务网格的概念，并在不同的命名空间中使用集中式的 L7 功能，而不影响性能和应用可用性”，[Ahmad Al-Masry](https:\/\/www.linkedin.com\/in\/ahmad-al-masry-9ab90858\/)，DevSecOps 工程经理说道。\n\n另一个例子是，一个团队拥有几个组成单一信任域的命名空间，你希望通过共享一个 waypoint proxy 来降低资源成本。在下图中，ns-1 和 ns-2 命名空间中的所有服务都使用部署在 ns-1 命名空间中的 waypoint proxy：\n\n![Istio ambient waypoint 代理部署模型](f3.webp)\n\n由于 ns-2 与 ns-1 共享相同的 waypoint proxy，任何在 ns-1 中部署并附加到整个 waypoint 的策略都会影响两个命名空间。例如，如果你部署了一个附加到整个 waypoint 的 \u0060AuthorizationPolicy\u0060，该策略将在两个命名空间中的所有服务上由 waypoint 执行。\n\n## 为什么不简单地为每个节点部署一个 Waypoint Proxy？\n\n虽然将 waypoint proxy 配置为上述不同目的地范围的网关非常好，但你可能会想，为什么不保持简单，为每个节点部署一个 waypoint proxy 作为 Kubernetes [DaemonSet](https:\/\/kubernetes.io\/docs\/concepts\/workloads\/controllers\/daemonset\/) 来处理该节点的所有 L7 处理呢？\n\nWaypoint proxy 需要高度可配置，因为应用程序可能有完全不同的性能要求和运行时自定义。例如，你可以插入针对特定服务的外部授权策略或 WASM 扩展。一个租户的错误 Envoy 配置可能会导致节点代理崩溃，影响该节点上的所有工作负载。\n\n此外，需要在 waypoint proxy 上有大量处理的嘈杂邻居可能会导致另一个应用程序性能不佳，仅仅因为该应用程序也部署在同一节点上。通过为 waypoint proxy 每个节点部署 Envoy，实际上是强制节点上的所有应用程序共享相同的故障域，而不管它们的应用延迟或运行时要求。Envoy 没有租户控制，你无法划分其 CPU 或内存来防止嘈杂邻居抢占其他应用程序。具有复杂 L7 策略的高流量应用程序将需要更多的 CPU 和 waypoint 的内存。Kubernetes DaemonSet 的资源预留是固定的，无法在不增加所有 waypoint pod 的 CPU 和内存的情况下，根据流量负载水平水平或垂直扩展特定的 DaemonSet pod。成本分摊在此模型中也很困难，你无法正确地将 waypoint 引起的资源成本归因于每个租户。\n\n让我们通过一个具体的例子来说明。我在两个命名空间中部署了 Bookinfo 应用程序，每个命名空间都有其默认配置的命名空间 waypoint。我将每个命名空间的 waypoint proxy 配置为与各自的 \u0060productpage\u0060 pod 共置。在每个命名空间中，我部署了一个简单的 L7 \u0060AuthorizationPolicy\u0060，只允许特定命名空间执行 GET 方法：\n\n![Istio ambient waypoint 代理部署模型](f4.webp)\n\n注意：为简洁起见，省略了源和目的地端的 ztunnel\n\n当我从 Fortio 向第一个命名空间的 productpage 服务发送 6500 RPS 的请求，并在 3 秒后向第二个命名空间的 productpage 服务发送相同的请求时，平均响应时间分别为 30.8ms 和 30.4ms，如下图所示：\n\n![命名空间 1](f5.webp)\n\n命名空间 1：通过其 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2](f6.webp)\n\n命名空间 2：通过其 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n由于两个 Bookinfo 应用程序都有非常大的负载，每个应用程序都有自己的 waypoint proxy 是合理的，这样它们不会相互争抢资源。那么，如果 waypoint proxy 改为按节点部署会怎样？\n\n我可以手动将 waypoint proxy 作为 DaemonSet 部署，使用非常复杂的 Envoy 配置。在运行两个 productpage pod 的节点上，waypoint proxy pod 将被两个 productpage pod 使用。然而，这需要深入了解 Envoy 配置，这方面我并不擅长。一种简单的测试方法是，将两个命名空间配置为使用相同的 waypoint proxy，这对于不需要非常高负载或专用 waypoint proxy 的应用程序是推荐的（参见前面的模式 C 了解更多信息）。注意：对于这种情况，我不推荐模式 C，因为两个 Bookinfo 应用程序的负载非常大。\n\n在确保 ns-1 命名空间中的 waypoint proxy pod 也部署在与两个 productpage pod 相同的节点上后，我进行了一个简单的更改，将两个命名空间都配置为使用 ns-1 命名空间中的 waypoint proxy。这使我能够快速测试一个 waypoint proxy pod，被部署在同一节点上的两个 productpage pod 使用，就像我将 waypoint 作为 DaemonSet 部署一样。\n\n![5_Istio ambient waypoint proxy deployment model explained](f7.webp)\n\n当我从 Fortio 负载客户端向第一个命名空间的 productpage 服务发送 6500 RPS 时，平均响应时间从 30ms 增加到了 59ms！在 3 秒后向第二个命名空间的 productpage 发送相同的负载（基本上重复之前的测试，但这次使用共享的 waypoint），它报告了 32% 的错误，从之前的 0% 增加了！当它们共享同一节点上的同一个 waypoint proxy 时，对两者的影响有多大！由于两个应用程序在高负载下都变得非常嘈杂，waypoint proxy 达到了其默认的 CPU 限制（2 核）和 [上游连接限制](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/config\/cluster\/v3\/circuit_breaker.proto#envoy-v3-api-field-config-cluster-v3-circuitbreakers-thresholds-max-connections)（1024），因此许多稍后开始的来自第二个命名空间的请求以高比例的错误失败。Kubernetes 工作节点仍然有充足的 CPU，在峰值时有约 50% 的 CPU 和 6% 的内存利用率。\n\n![命名空间 1.2](f8.webp)\n\n命名空间 1：通过共享的 waypoint 向第一个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n![命名空间 2.1](f9.webp)\n\n命名空间 2：通过共享的 waypoint 向第二个命名空间的 productpage 服务发送 6500 QPS，650 个连接的 Fortio 测试\n\n这个实验表明，在节点上使用相同的 waypoint proxy 共享相同的故障域，可能很容易在嘈杂的邻居下触发故障场景，而这些可以通过为非常繁忙的租户提供专用的 waypoint 来避免。虽然在测试中使用了非常嘈杂的邻居，但也可能是错误的 Envoy 配置或特定的 Envoy 扩展，在多个租户共享相同的故障域时触发类似的问题。\n', '\/trans\/istio-ambient-waypoint-proxy-deployment-model-explained\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文阐述了 Istio Ambient Waypoint Proxy 的多种部署模式，解释了按节点部署的弊端，并通过实例说明了最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-tracing/">Envoy 代理如何处理用户请求以实现追踪</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Envoy 代理如何处理用户请求以实现追踪', '深入探讨 Envoy 代理在云原生环境中如何处理用户请求，实现分布式追踪，提升应用可观测性。', '\n在云原生环境中，提升对应用程序的可观测性以更好地理解用户体验是至关重要的。然而，单纯依靠指标和日志无法提供个别案例的具体细节。这时，追踪（Tracing）技术就显得尤为重要。\n\n## 追踪的基本原理\n\n追踪通过为每个用户请求附加一个关联 ID，向开发人员提供完整的用户体验上下文。这个关联 ID 就像一根线，将跨越多个服务的追踪串联起来，从而实现全面的可观测性。\n\n下图展示了 Envoy 处理用户请求的流程。\n\n\u0060\u0060\u0060mermaid \u0022用户请求与 Envoy 代理的处理流程图\u0022\nsequenceDiagram\n    participant 用户\n    participant Envoy\n    participant 应用程序\n    participant 后端\n\n    %% 用户发送带有各种头部的初始请求\n    用户-\u003e\u003eEnvoy: 用户请求（包含头部：Host, X-User-Identity, X-B3-TraceId）\n\n    %% Envoy 将请求转发给应用程序\n    Envoy-\u003e\u003e应用程序: 转发请求（带头部）\n\n    %% 应用程序处理请求并发出外部请求\n    应用程序-\u003e\u003eEnvoy: 外部请求（发往后端，带头部）\n    Envoy-\u003e\u003e后端: 转发请求（X-B3-TraceId: 1234, X-User-Identity）\n\n    %% 后端对外部请求做出响应\n    后端-\u003e\u003eEnvoy: 对应用程序请求的响应\n    Envoy-\u003e\u003e应用程序: 转发响应\n\n    %% 应用程序处理响应并将响应发送回用户\n    应用程序-\u003e\u003eEnvoy: 对用户请求的响应\n    Envoy-\u003e\u003e用户: 转发响应（给原始用户请求）\n\n    %% 处理多个并发请求\n    用户-\u003e\u003eEnvoy: 多个并发请求\n    Envoy-\u003e\u003e应用程序: 转发多个请求\n    应用程序-\u003e\u003eEnvoy: 转发响应\n    Envoy-\u003e\u003e用户: 多个并发响应\n\u0060\u0060\u0060\n\n![用户请求与 Envoy 代理的处理流程图](98285f54b4811bd9ece87523444f4e02.svg)\n\n**追踪**可以通过为每个用户请求附加一个关联 ID，向开发人员提供完整的用户体验上下文。这个关联 ID 就像一根线，将跨越多个服务的追踪串联起来。\n\n尽管所有请求都会经过 Envoy 代理，但 Envoy 无法独立提供完整的追踪信息。它只看到应用程序作为网络的一部分，无法洞察内部处理。这使得 Envoy 无法区分入站请求和出站请求是否来自同一个用户，因此无法自动转发追踪上下文。\n\n## 服务网格中的请求上下文\n\nEnvoy 可以在 Istio 服务网格中作为 Sidecar 或 Waypoint 代理，下图展示了 Envoy 在服务网格中如何处理请求上下文的。\n\n### 1. 用户请求的开始\n\n追踪涉及通过多个服务跟踪路径，以理解用户体验的完整上下文。追踪从一个用户请求开始，该请求被分配了一个关联 ID。\n\n\u0060\u0060\u0060mermaid \u0022用户请求的开始\u0022\nsequenceDiagram\n    participant User\n    participant Envoy\n    participant Application\n    User-\u003e\u003eEnvoy: 请求（包含Headers）\n    Note right of User: Headers:\u003cbr\/\u003e- Host: example.com\u003cbr\/\u003e- X-User-Identity: Base64 Token\u003cbr\/\u003e- X-B3-TraceId: 1234\n\u0060\u0060\u0060\n\n![用户请求的开始](51fd90d791099a4f158c823a821fba6d.svg)\n\n### 2. 请求通过 Envoy 代理\n\nEnvoy 位于应用程序旁边，所有进入的请求都会经过 Envoy。\n\n\u0060\u0060\u0060mermaid \u0022用户请求的开始\u0022\nsequenceDiagram\n    participant User\n    participant Envoy\n    participant Application\n    User-\u003e\u003eEnvoy: 发起请求\n    Envoy-\u003e\u003eApplication: 转发请求\n\u0060\u0060\u0060\n\n![用户请求的开始](aebbb0ea064ee93575ec5a1ec9bdf329.svg)\n\n### 3. Envoy 附加额外的 Headers\n\nEnvoy 可以在请求中附加额外的 Headers，以收集关于应用程序内部发生情况的信息。\n\n\u0060\u0060\u0060mermaid \u0022Envoy 附加额外的 Headers\u0022\nsequenceDiagram\n    participant Envoy\n    participant Application\n    Envoy-\u003e\u003eApplication: 转发请求（附加Headers）\n    Note right of Envoy: 附加Headers:\u003cbr\/\u003e- X-Forwarded-For\u003cbr\/\u003e- X-Forwarded-Client-Cert\n\u0060\u0060\u0060\n\n![Envoy 附加额外的 Headers](7ab35160ac9d07cfdcaa9436b8706548.svg)\n\n### 4. 应用程序处理请求并调用后端服务\n\n应用程序在处理请求的过程中，可能需要联系其他系统来处理该请求。比如外部的认证和授权服务。\n\n\u0060\u0060\u0060mermaid \u0022应用程序处理请求并调用后端服务\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy2 as Envoy（出站）\n    participant Backend\n    Application-\u003e\u003eEnvoy2: 调用后端请求\n    Envoy2-\u003e\u003eBackend: 转发请求\n\u0060\u0060\u0060\n\n![应用程序处理请求并调用后端服务](d1016c81280b99d35a642a80caa3af52.svg)\n\n### 5. 应用程序需要复制关联 ID\n\n应用程序知道出站请求是代表哪个入站请求发起的（例如 Trace ID 为 1234 的请求）。但是，Envoy 并不知道这一点。因此，应用程序需要将关联 ID 等上下文从入站请求复制到出站请求中。\n\n\u0060\u0060\u0060mermaid \u0022应用程序需要复制关联 ID\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy2 as Envoy（出站）\n    participant Backend\n    Application-\u003e\u003eEnvoy2: 调用后端请求（复制Headers）\n    Note right of Application: 复制Headers:\u003cbr\/\u003e- X-B3-TraceId: 1234\u003cbr\/\u003e- X-User-Identity: Base64 Token\n    Envoy2-\u003e\u003eBackend: 转发请求\n\u0060\u0060\u0060\n\n![应用程序需要复制关联 ID](1409785fdd6f8909dffee3c5bd1b44ba.svg)\n\n### 6. 多个请求的并发处理\n\n在实际场景中，应用程序同时处理多个用户请求，这导致了并发性。由于 Envoy 只能看到网络层面的请求和响应，无法区分这些请求之间的因果关系。\n\n\u0060\u0060\u0060mermaid \u0022多个请求的并发处理\u0022\nsequenceDiagram\n    participant User1\n    participant User2\n    participant Envoy\n    participant Application\n    User1-\u003e\u003eEnvoy: 请求1\n    User2-\u003e\u003eEnvoy: 请求2\n    Envoy-\u003e\u003eApplication: 转发请求1\n    Envoy-\u003e\u003eApplication: 转发请求2\n    Application-\u003e\u003eEnvoy: 响应请求1的出站请求\n    Application-\u003e\u003eEnvoy: 响应请求2的出站请求\n\u0060\u0060\u0060\n\n![多个请求的并发处理](2aebfd544f726da5fe6f4389aed924bd.svg)\n\n### 7. Envoy 的局限性\n\n因为 Envoy 无法看到应用程序内部的处理逻辑，它只能看到一系列的网络请求和响应，无法知道哪些出站请求是由哪些入站请求触发的。\n\n\u0060\u0060\u0060mermaid \u0022Envoy 的局限性\u0022\nsequenceDiagram\n    participant Envoy\n    participant Application\n    Envoy-\u003e\u003eApplication: 多个请求\n    Application-\u003e\u003eEnvoy: 多个响应\n    Note over Envoy: 无法区分请求的因果关系\n\u0060\u0060\u0060\n\n![Envoy 的局限性](d048f6f9fc9af6f29a9f2e4bfe599613.svg)\n\n## 需要应用程序的参与\n\n由于 Envoy 无法自动转发追踪上下文，应用程序本身需要负责将入站请求的 Headers 复制到出站请求中，以保持追踪信息的完整性。\n\n### 应用程序复制 Headers\n\n应用程序在处理入站请求时，需要将必要的 Headers（如关联 ID、用户身份等）复制到任何出站请求中。\n\n\u0060\u0060\u0060mermaid \u0022应用程序复制 Headers\u0022\nsequenceDiagram\n    participant Application\n    participant Backend\n    Application-\u003e\u003eBackend: 出站请求（包含复制的Headers）\n\u0060\u0060\u0060\n\n![应用程序复制 Headers](d1f00ba65d1c61edf996a19a6b5145d7.svg)\n\n### 响应返回给用户\n\n应用程序完成对用户请求的处理后，将响应返回给用户。\n\n\u0060\u0060\u0060mermaid \u0022响应返回给用户\u0022\nsequenceDiagram\n    participant Application\n    participant Envoy\n    participant User\n    Application-\u003e\u003eEnvoy: 响应\n    Envoy-\u003e\u003eUser: 转发响应\n\u0060\u0060\u0060\n\n![响应返回给用户](ed0816d0cb881c7c7d5eb19e6d0826bf.svg)\n\n## 解决方案与推荐\n\n为了确保追踪信息的完整性，应用程序需要主动复制和传递追踪相关的 Headers。这可以通过集成如 [Apache SkyWalking](https:\/\/skywalking.apache.org\/) 的工具来实现，SkyWalking 不仅支持分布式追踪，还包括性能监控、日志分析等功能。利用 SkyWalking 的库和代理，可以简化 Headers 的复制和追踪信息的传递。\n\n关于如何在 Istio 中使用 SkyWalking 实现分布式追踪详见[这篇博客](\/blog\/distributed-tracing-with-skywalking-in-istio\/)。\n\n## 总结\n\n- **追踪的重要性**：追踪为开发人员提供了用户请求的完整上下文，帮助更好地理解和改进用户体验。\n- **Envoy 的局限性**：Envoy 只能看到网络层面的请求和响应，无法跟踪请求的因果关系，因此无法自动转发追踪上下文。\n- **应用程序的角色**：应用程序需要主动复制和传递追踪相关的 Headers，以确保追踪信息的完整性。\n- **推荐的工具**：使用 SkyWalking 等追踪工具的库，可以简化在应用程序中实现 Headers 复制的过程。\n\n## 参考\n\n- [How the Envoy proxy handles a user request - tetrate.io](https:\/\/tetrate.io\/blog\/how-the-envoy-proxy-handles-a-user-request\/)\n- [如何在 Istio 中使用 SkyWalking 进行分布式追踪？- jimmysong.io](https:\/\/jimmysong.io\/blog\/distributed-tracing-with-skywalking-in-istio\/)\n', '\/blog\/envoy-tracing\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入探讨 Envoy 代理在云原生环境中如何处理用户请求，实现分布式追踪，提升应用可观测性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/black-myth-wukong-review/">《黑神话：悟空》一周目评测：瑕不掩瑜，期待更丰富内容</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/16</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e9%9a%8f%e7%ac%94"> 
             随笔
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('《黑神话：悟空》一周目评测：瑕不掩瑜，期待更丰富内容', '《黑神话：悟空》一周目体验总结：虽然游戏有不少亮点，但整体内容稍显不足，导致游戏进程偏快，令人意犹未尽。', '\n最近完成了《黑神话：悟空》的一周目体验。总体来说，音乐和美术表现出色，但战斗系统略显单调，地图设计不够理想，整体内容偏少，让人感到意犹未尽。\n\n![黑神话：悟空](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/wukong.webp)\n\n{{\u003ccallout tip \u0022什么是一周目？\u0022\u003e}}\n\n“一周目”指的是玩家首次完整进行游戏的过程，这个阶段充满新鲜感和探索性，可以体验到完整的剧情与玩法，为后续的游戏体验奠定基础，通常难度适中。\n\n{{\u003c\/callout\u003e}}\n\n## 音乐\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113055920818374\u0026bvid=BV1S9noeREf3\u0026cid=25673204847\u0026p=1\u0022\u003e}}\n\n第二章开头，熊竹英老师用陕北说书的形式演绎了《黄风起兮》，令人印象深刻。熊竹英是陕北说书的非遗传承人。陕北说书起源于陕西北部的延安和榆林地区，最初由贫苦盲人用陕北民歌小调演唱民间传说和故事，后来融入了多种曲调，形成了独特的说唱艺术。通常是一人自弹自唱，伴奏乐器以三弦为主，还会用绑在小腿的甩板和手腕的“嘛喳喳”小木板来打节奏。2006 年，陕北说书被列入国家级非物质文化遗产名录。\n\n## 美术设计\n\n![黑神话悟空截图](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/jietu.webp)\n\n游戏前两章的美术设计非常出色，古建筑的还原相当精致。以下是我对每个章节的感受：\n\n- **第一回：火照黑云（黑风山）**：我很喜欢开头翠绿的丛林，还有偶尔出现的妖怪，营造出一种神秘的氛围。\n- **第二回：风起黄昏（黄风岭）**：漫天黄沙带来了一种苍凉和破败的感觉。\n- **第三回：夜生白露（小雷音寺）**：浮屠界让我头晕目眩，过桥时经常被打落，茫茫雪地既刺眼又让人迷失方向，唯一觉得好些的是**安身寺**的部分。\n- **第四回：曲度紫鸳（盘丝洞）**：层层洞窟让人容易迷路，不过黄花观和紫云山的景色还不错。\n- **第五回：日落红尘（火焰山）**：这种场景不太对我胃口，不由得让我联想到《艾尔登法环》中的火山地形。\n- **第六回：未竟（花果山）**：地图很大，但更容易迷路了，只能不断用筋斗云在空中飞来飞去。\n\n![花果山](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/jindouyun.webp)\n\n总体来说，缺少地图功能让人非常无语，即便没有地图，搞个指南针也不难，但游戏中什么都没有，只能靠空气墙来判断边界。玩家在游戏中不断兜圈子，浪费了不少时间在找路上，真正玩游戏的时间可能不足七成。\n\n## 故事\n\n《黑神话：悟空》的故事设定很简单，背景发生在唐僧师徒取经之后。孙悟空虽被封为斗战胜佛，却辞去佛位回到花果山。天庭不满，派二郎神等前来捉拿，紧箍咒再现使悟空落败，他的“六根”（眼、耳、鼻、舌、身、意）被分为六块。“意”化作天命人（玩家），其余五块被分给五个妖王。花果山的猴子猴孙踏上寻找“六根”复活悟空的征程。玩家扮演的天命人在老猴子的指引下，一路打怪升级，集齐悟空的“五根”，最终战胜悟空的意念和身躯，孙悟空复活却又重新戴上紧箍咒，在石头中等待新的宿命。\n\n第一回的故事比较直白，金池长老因贪财觊觎唐僧的袈裟，最终葬身火海，这也契合了大圣的六根之一——“眼见喜”。观音菩萨的那句“若不披上这件衣裳，众生又怎知我尘缘已断，金海尽干。”（第一章结尾 CG《看见》）也可谓经典。\n\n![灵吉菩萨](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/lingjipusa.webp)\n\n我最喜欢的是第二章关于黄风大圣的故事，网上有很多解读，我比较认可的说法是灵吉菩萨作祟，惩罚黄金佛国的百姓，而黄风大圣是个好妖。尤其是黄风大圣的那句“我来助你”，喊在了多少人的心坎上。\n\n![黄风大圣：我来助你](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/wolaizhuni.webp)\n\n## 金句\n\n除了观音菩萨对黑熊精说的那句“金海尽干”外，游戏中还有许多金句，大多以旁白的形式出现，还有一些是角色的对白。最精彩的当属黄眉大王 boss 战中的那大段对白。以下是我收集的一些精彩对白：\n\n- **旁白**：“只要心中还有放不下的偶像，终有一天，它将化为修行路上的无解业障。”\n- **旁白**：“有圣就有盗，有高山就有深渊，有天地悬殊就有腥风血雨，我逃不掉，你也逃不掉！”\n- **旁白**：“他们想看的，是如今我们跪着的模样！”\n- **旁白**：“人也，兽也，佛也，妖也，众生自有根器，持优劣为次第，可乱来不得。你说，对吗？孙悟空？”\n- **旁白**：“信什么狗屁如来，不如我自己来！”\n- **旁白**：“既见未来，为何不拜？”\n- **旁白**：“不杀生，仇恨永无止息；不偷盗，强弱如我何异；不邪淫，一切有情皆孽；不妄语，梦幻泡影空虚；不馋酒，忧怖涨落无常；不耽乐，芳华刹那而已；不贪眠，苦苦不得解脱；不纵欲，诸行了无生趣。”\n- **旁白**：“可命运呐，就像爱人的舌头，嘴里一套，心里一套。哪怕亲口尝到，也不知到底是想要，还是不想要。”\n- **旁白**：“后来啊，这禅院又被重建了。可人心若是烧没了，修好一座破庙，又有什么用呢？”\n- **旁白**：“天地万物皆炉鼎，唯有上品得我心。”（戌狗炼丹完成时说）\n- **黑风大王**：“前程暗漆本难知，乘风得势各有时。既成南海修真士，却叫财迷作钱痴。”（黑风大王相关剧情）\n- **寅虎**：“六丁六甲，从不吃素。\u0022（击败玩家后）\n- **虎先锋**：“打不过，就跪下。猴头留着下酒，剩下的交给大王。”（击败玩家后）\n\n## 战斗系统\n\n《黑神话：悟空》的战斗系统极具特色。主角以多样棍法战斗，分为轻棍、重棍等多种类型，各种棍法的表现和打击范围各异。但在一周目时，我只使用了劈棍，因为灵光点有限，无法同时加到多个棍法上，二周目再尝试其他棍法吧。\n\n此外，游戏中还可以使用其他武器和多种法术神通，如奇术、身法、毫毛和变身等。闪避机制相当灵活，并带有无敌帧效果，这点在游戏刚开始时我没注意到，一上来就盲目攻击，不懂得躲避，因此死了无数次才明白。\n\n游戏中有生命值、法力值和气力值三种数值条，各自对应不同的恢复机制。与其他魂类游戏不同的是，这款游戏竟然没有恢复法力的药水，直到二周目我才找到这种丹药。\n\n![击败广智](https:\/\/rootsongjc.github.io\/img\/blog\/black-myth-wukong-review\/guangzhi.webp)\n\n至于游戏中的那些精魄，大部分我都没用过，一直到一周目过半，我基本上只使用了广智。\n\n## 期待\n\n玩这款游戏时我一直有个疑问：为什么天命人不能开口说话？而且游戏过程中也无法控制天命人的姿势，不像《艾尔登法环》那样可以摆个 pose 拍照，这在拍照模式中还是挺实用的。\n\n另外，希望在未来的 DLC 中能增加地图和更多章节，现在的游戏内容确实有些单薄，熟悉地图后，二周目真的很快就能完成。此外，希望能引入更多的武器系统。我们都知道悟空的经典武器是棍子，但如果能有更多武器选择，战斗会不会更精彩些？\n\n## 总结\n\n总的来说，《黑神话：悟空》是一部充满诚意的作品，但内容略显不足。希望未来的续作能在保持现有优点的基础上，进一步优化游戏体验，增加更多内容和玩法，使《黑神话》系列成为国产游戏的经典之作，也希望未来能有更多优秀的 3A 大作从国内诞生。', '\/blog\/black-myth-wukong-review\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">《黑神话：悟空》一周目体验总结：虽然游戏有不少亮点，但整体内容稍显不足，导致游戏进程偏快，令人意犹未尽。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/macao-trip/">澳门 City Walk：感受精致濠江</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e6%97%85%e8%a1%8c"> 
             旅行
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('澳门 City Walk：感受精致濠江', '澳门虽小，却处处藏着惊喜。从大三巴到新葡京，城市漫步中感受它的独特魅力。', '\n在决定去澳门之前，我对这座小城的印象仅限于大三巴、官也街、葡式蛋挞、何鸿燊，以及七子之歌里那句“你可知 macao 不是我真姓…”。但当我亲自踏上这片 33.3 平方公里的土地时，才发现这个中国最小的一级行政区，竟然充满了独特的韵味。\n\n## 对澳门的第一印象\n\n这次我是从香港乘坐大巴从港珠澳大桥进入澳门。在此之前我就对查阅过资料，了解到澳门面积不大，只有 33.3 平方公里，而北京二环内的面积有 62 公里，近乎澳门的两倍。澳门行政区域内包含包括澳门半岛、氹仔岛和路环岛。澳门的陆地面积是经过长期不断填海逐渐扩大的。澳门与珠海隔河相望，如果说两地“鸡犬相闻”那好不为过。澳门与内地的距离远没有香港与内地那么远。\n\n从澳门妈阁山眺望对岸，珠海近在眼前。珠海和澳门以前山水道相隔，距离不过 300 多米。\n\n![从澳门远眺珠海](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/zhuhai.webp)\n\n澳门半岛是老城区，街道上车水马龙，留给行人步行的空间十分有限。\n\n![澳门半岛的街道](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/street.webp)\n\n## 城市漫步：City Walk\n\n步行到大三巴牌坊，它是圣保禄大教堂前壁遗址，位于花王堂区炮台山下，左邻澳门博物馆和大炮台。牌坊总共有五层，主要以花岗岩建成，宽 23 米，高 25.5 米，坊前有 68 级台阶。大三巴牌坊位列“澳门八景”之首，2005 年，包含大三巴牌坊在内的“澳门历史城区”列入世界文化遗产名录。\n\n![前往大三巴的街道](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/renqun.webp)\n\n在前往大三巴牌坊的路上经过一段小吃街，街道上人声鼎沸，摩肩接踵，因为当天的天气比较炎热，再加上小吃街上散发的牛杂、猪肉铺、蛋挞等的味道，让人心里五味杂陈。原以为大三巴牌坊前会有一块开阔的广场，没想到只有台阶，而且台阶上还坐了很多人。\n\n![大三巴牌坊的背面还在施工](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/dasanba.webp)\n\n在炮台山上可以俯瞰澳门半岛。\n\n![从炮台山上俯瞰澳门半岛](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/paotai.webp)\n\n此地不宜久留，我继续拾阶而上，前往主教座堂。\n\n![主教座堂](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/churt.webp)\n\n澳门的街道上可以看到，墨绿色的防撞柱，嫩绿色的墙，明黄的建筑，配色让人眼前一亮。\n\n![大堂附近的建筑](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/wall.webp)\n\n还有西望洋眺望主教山小堂，在登上斜坡的时候我看到有人在用抹布清洁墙壁。\n\n![从西望洋眺望主教山小堂](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/hill.webp)\n\n澳门半道上最惹眼的建筑非新葡京莫属了。新葡京的全称是新葡京酒店，它的造型设计极度浮夸，内部装饰更是奢华，它是澳门“赌王”何鸿燊耗资 50 亿元兴建的位于澳门葡京路端的赌场酒店，其外形如巨大金莲花，是澳门最知名的地标建筑之一，也是世界 20 座最具标志性大楼之一。它是澳门首家打造“七星级”的豪华酒店，集赌场、住宿、餐饮、娱乐、艺术展览等多种功能于一体。\n\n![可以在澳门半岛上随处仰望可见的新葡京酒店](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/xinpujing.webp)\n\n澳门虽小，但是各种交通工具都很齐全，澳门现有一条运营中的轻轨线路，从妈阁庙到澳门机场和码头，已经连接了澳门的三大区域及交通枢纽。据悉，还有另外两条线路在建。\n\n![威尼斯人娱乐场](https:\/\/jimmysong.io\/img\/blog\/macao-trip\/weinisiren.webp)\n\n夜幕将至，我来到了路凼的威尼斯人娱乐场（内设赌场），没想到这里门口几十辆大巴排列成行，行人入职，内部更是像一个迷宫，三大主体建筑——威尼斯人、巴黎人、伦敦人串联在一起，让人绕来绕起，就是走不出去。威尼斯人娱乐场里的那条人工河充斥着消毒水味，这里面我是一刻也待不下去，真搞不懂为什么要在这里设置一条河。\n\n## 澳门的堂区\n\n在查看地图上我发现澳门有很多“堂区”，那是澳门在葡萄牙殖民统治时期，以天主教的堂区作为行政区划的基础，不过现在“堂区”已经不是正式的行政机构建置，不具法律地位。澳门有七个堂区和一个无堂区划分区域。其中澳门半岛有五个堂区，分别是花地玛堂区、圣安多尼堂区、大堂区、望德堂区、风顺堂区；澳门离岛有两个堂区，分别是嘉模堂区、圣方济各堂区。位于氹仔和路环之间的填海地段为称为路氹城，不属于任何堂区。\n\n葡萄牙以天主教信仰为重要的社会和文化核心，在海外殖民地也推行以教堂为中心的堂区划分制度。教堂在堂区的形成和发展过程中起到了关键的源头性作用，一个地区往往先有重要的教堂建立，随后围绕教堂逐渐形成了具有一定人口规模和社会经济活动的聚居区域，进而被划定为一个堂区。\n\n## 总结\n\n澳门虽小，但每个角落都有它的故事。无论是大三巴的宏伟遗迹，还是街头小吃的烟火气息，这座小城总能给人留下深刻印象。小而精，这就是澳门的魅力所在。\n', '\/blog\/macao-trip\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">澳门虽小，却处处藏着惊喜。从大三巴到新葡京，城市漫步中感受它的独特魅力。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/introducing-kmesh-kernel-native-service-mesh/">介绍 Kmesh：用内核原生技术革新服务网格数据平面</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/14</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('介绍 Kmesh：用内核原生技术革新服务网格数据平面', 'Kmesh 利用 eBPF 和内核增强，实现高性能、低延迟的服务网格数据平面。它革新了传统的 Sidecar 架构，降低了资源消耗，适用于现代云原生应用。', '\n在近期整理服务网格数据平面的几种部署模式时，我关注到了徐中虎在 KubeCon China 2024 的分享《[Istio 数据平面的新选择：全新性能体验的架构创新](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)》。该分享介绍了 Kmesh，它利用 eBPF 和内核增强技术，消除了 Sidecar，并提出了双引擎模式，是一种创新性的服务网格解决方案。去年我已听闻 Kmesh，借此契机我深入研究了 Kmesh，撰写此博客与大家分享。\n\n{{\u003ccallout note \u0022注意\u0022\u003e}}\n\n**注意**：本文中所展示的所有数据均引用自 [《Istio 数据平面的新选择：全新性能体验的架构创新》](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)，我并未对这些数据的准确性进行独立验证。请读者自行判断和核实这些数据的可靠性。\n\n{{\u003c\/callout\u003e}}\n\n\n## 背景\n\n像 Istio 这样的服务网格已成为管理复杂微服务架构的核心，提供流量管理、安全性和可观测性等功能。Sidecar 模型，即在每个服务实例旁运行一个代理，已成为主要方法。虽然功能有效，但这种架构引入了显著的延迟和资源开销。\n\n## 传统 Sidecar 架构的局限性\n\n1. **延迟开销**：增加 Sidecar 代理会导致网络跳数和上下文切换增加，每次服务调用引入额外 **2 至 3 毫秒** 的延迟。对于对延迟敏感的应用，这种延迟是不可接受的。\n\n2. **资源消耗**：每个 Sidecar 都会消耗 CPU 和内存资源。在拥有数千个服务的大规模部署中，累积的资源开销巨大，虽然可以通过一定的技术手段进行优化，但依然降低了部署密度并增加了运营成本。\n\nIstio 的性能测量显示，即使没有流量分发，仍存在约 3 毫秒的固有延迟开销。随着连接数量的增长，延迟相应增加，这突显了 Sidecar 模型在高性能应用中的低效。\n\n## 行业应对挑战的尝试\n\n已经提出了多种解决方案来缓解 Sidecar 架构的缺点：\n\n### Cilium 服务网格\n\n- **方法**：将 eBPF 与 Envoy 相结合，创建一个无 Sidecar 的服务网格。\n- **机制**：\n  - **L4 流量**：使用 eBPF 进行高效的内核级数据路由。\n  - **L7 流量**：依赖 Envoy 进行应用层解析。\n- **局限性**：\n  - **L7 额外跳数**：通过 Envoy 进行 L7 管理引入了额外的网络跳数。\n  - **故障隔离**：在确保治理故障隔离方面存在挑战。\n\n### Istio Ambient Mesh\n\n- **方法**：使用 **ztunnel** 和 **waypoint** 代理，引入无 Sidecar 的架构。\n- **机制**：\n  - **用户空间处理**：所有流量拦截和管理都在用户空间进行。\n- **局限性**：\n  - **复杂的流量拦截**：用户空间的拦截增加了复杂性。\n  - **跳数增加**：L7 连接涉及多个网络跳数，增加了延迟。\n\n这些解决方案虽然创新，但并未完全解决 Sidecar 架构固有的延迟和资源开销问题。\n\n更多详细信息可以参考我的另一篇文章：[数据平面的几种部署模式](\/blog\/service-mesh-data-plane-deployment-modes\/)。\n\n## 介绍 Kmesh：一种内核原生的方法\n\n[Kmesh](https:\/\/github.com\/kmesh-net\/kmesh) 通过将流量治理直接集成到操作系统内核，定义了一种新的服务网格数据平面。利用 eBPF（扩展伯克利数据包过滤器）和内核增强，Kmesh 提供高性能、低延迟和资源高效的服务网格能力。\n\n### 技术架构\n\n下图展示了 Kmesh 的架构。\n\n![Kmesh 架构图：（根据 [Kmesh GitHub](https:\/\/github.com\/kmesh-net\/kmesh) 绘制）](kmesh-arch.svg)\n\n**核心组件**：\n\n- **Kmesh-Daemon**：每个节点的管理组件，负责：\n  - 管理 eBPF 程序。\n  - 从控制平面（如 Istiod）订阅 xDS 配置。\n  - 处理可观测性和指标收集。\n\n- **eBPF 编排**：在内核级实现流量拦截和管理，支持：\n  - L4 负载均衡。\n  - 流量加密和解密。\n  - 监控和简单的 L7 动态路由。\n\n- **Waypoint Proxy（双引擎模式下可选）**：处理高级 L7 流量治理，可按命名空间或服务进行部署。\n\n### 关键优势\n\n该分享中指出 Kmesh 具有以下优势，尤其是性能和资源利用率上：\n\n![Kmesh vs Sidecar vs Ambient（[来源](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)）](performance.webp)\n\n1. **高性能**：\n   - **延迟降低**：与传统 Sidecar 架构相比，内核原生的 L7 管理将转发延迟降低了超过 **60%**。\n   - **应用启动改进**：由于消除了 Sidecar 初始化，应用启动时间提升了 **40%**。\n\n2. **低资源开销**：\n   - **资源效率**：无需 Sidecar 代理，资源消耗减少了超过 **70%**。\n\n3. **高可用性**：\n   - **无缝升级**：内核级流量管理确保升级或重启 Kmesh 组件不会中断现有的服务连接。\n\n4. **安全隔离**：\n   - **增强的安全性**：利用基于 BPF 的虚拟机安全和 cgroup 级别的治理隔离，确保安全的多租户环境。\n\n5. **灵活的治理模型**：\n   - **部署模式**：提供内核原生模式以实现最大性能，和双引擎模式以获得部署灵活性。\n\n6. **无缝兼容性**：\n   - **控制平面集成**：完全兼容 xDS 协议，允许与 Istio 控制平面集成，支持 Istio API 和 Gateway API。\n\n## Kmesh vs Ambient vs Cilium mesh\n\n通过上文中对 Kmesh 的介绍，你会发现它与 Istio Ambient 模式及 Cilium mesh 有很多相似性，下表将从多个维度对比它们之间的区别。\n\n| 比较维度               | Kmesh                                                        | Istio Ambient 模式                                           | Cilium Mesh                                                  |\n| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| **流量拦截与处理方式** | \u0026bull; **内核级处理：** 利用 eBPF 和内核增强，将流量治理直接集成到操作系统内核中。\u003cbr\u003e\u0026bull;**模式选择：**\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026bull; **内核原生模式：** L4 和 L7 流量全部在内核中处理，无需用户空间代理。\u003cbr\u003e\u0026nbsp;\u0026nbsp;\u0026bull; **双引擎模式：** L4 在内核中处理，L7 由 Waypoint Proxy 处理。 | \u0026bull; **用户空间处理：** 引入 **ztunnel** 和 **Waypoint Proxy**，在用户空间进行流量拦截和管理。\u003cbr\u003e\u0026bull; **无 Sidecar 架构：** 消除了 Sidecar，但增加了新的用户空间组件。 | \u0026bull; **混合处理：** 结合 eBPF 和 Envoy。\u003cbr\u003e\u0026bull; **L4 流量：** 在内核中使用 eBPF 处理。\u003cbr\u003e\u0026bull; **L7 流量：** 由用户空间的 Envoy 代理处理。 |\n| **性能与延迟**         | \u0026bull; **高性能：** 内核级处理，减少上下文切换和数据拷贝。\u003cbr\u003e\u0026bull; **延迟降低：** 转发延迟降低超过 **60%**。\u003cbr\u003e\u0026bull; **低延迟启动：** 应用启动时间提高 **40%**。 | \u0026bull; **性能改进但仍有延迟：** 比传统 Sidecar 架构有所提升，但用户空间处理和增加的网络跳数仍带来延迟。 | \u0026bull; **L4 性能优异：** L4 流量内核处理，高效。\u003cbr\u003e\u0026bull; **L7 存在开销：** L7 流量通过 Envoy，增加网络跳数和潜在延迟。 |\n| **架构复杂度**         | \u0026bull; **内核依赖：** 需要特定内核版本或增强，部署复杂度增加。\u003cbr\u003e\u0026bull; **组件简洁：** 内核处理，减少对用户空间组件的依赖。 | \u0026bull; **新增组件：** 引入 ztunnel 和 Waypoint Proxy，架构更复杂。\u003cbr\u003e\u0026bull; **Istio 生态：** 继承 Istio 的复杂性。 | \u0026bull; **双重组件：** 需要管理 eBPF 和 Envoy。\u003cbr\u003e\u0026bull; **L7 复杂性：** 处理 L7 流量时架构更复杂。\u003cbr\u003e\u0026bull; **CNI 集成：** 简化部分网络配置。 |\n| **安全性与隔离**       | \u0026bull; **内核级安全：** 利用 BPF 虚拟机和 cgroup 隔离，提供高安全保障。\u003cbr\u003e\u0026bull; **mTLS 内核支持：** 内核实现双向 TLS，加密性能高。 | \u0026bull; **用户空间安全：** 通过用户空间组件实现安全功能，可能增加攻击面。\u003cbr\u003e\u0026bull; **丰富策略支持：** 继承 Istio 的安全策略和配置能力。 | \u0026bull; **eBPF 安全特性：** 利用 eBPF 的安全模型。\u003cbr\u003e\u0026bull; **隔离挑战：** 治理故障隔离需额外考虑。 |\n| **兼容性与集成**       | \u0026bull; **Istio 控制平面：** 集成 Istio 控制平面，支持 xDS 协议，兼容 Istio API 和 Gateway API。\u003cbr\u003e\u0026bull; **Kubernetes 原生：** 无缝运行在 Kubernetes 上。 | \u0026bull; **完全兼容：** 作为 Istio 的一部分，完全兼容 Istio API 和生态系统。 | \u0026bull; **CNI 角色：** 作为 Kubernetes 的 CNI 插件，提供网络和服务网格功能。\u003cbr\u003e\u0026bull; **网络策略：** 提供强大的网络策略和安全功能。 |\n| **部署与运维考虑**     | \u0026bull; **内核要求：** 需修改内核或使用特定版本，注意兼容性。\u003cbr\u003e\u0026bull; **性能优先：** 适合追求极致性能的场景。 | \u0026bull; **易于迁移：** 为 Istio 用户提供无 Sidecar 替代方案，便于过渡。\u003cbr\u003e\u0026bull; **复杂性管理：** 需管理新增用户空间组件。 | \u0026bull; **现有 Cilium 用户：** 已使用 Cilium 时，集成服务网格功能简单。\u003cbr\u003e\u0026bull; **学习曲线：** 需熟悉 eBPF 与 Envoy 的结合。 |\n\n**总结：**\n\n- **Kmesh**：通过将流量治理下沉到内核，实现高性能和低延迟，适用于对性能和资源效率要求极高的应用。但需要特定的内核支持，部署时需考虑兼容性。\n\n- **Istio Ambient Mesh**：消除了 Sidecar，改进了性能，保留了 Istio 的丰富功能，但用户空间处理可能带来新的复杂性和延迟。\n\n- **Cilium Mesh**：利用 eBPF 提高 L4 性能，但 L7 流量处理依赖 Envoy，可能增加复杂性和延迟。适合已经使用 Cilium 的环境，提供强大的网络策略和安全功能。\n\n## Kmesh 的两种运行模式\n\nKmesh 提供两种运行模式，以满足不同的部署需求：\n\n### 内核原生模式\n\n**概述**：\n\n- **极致性能**：在 L4 和 L7 流量中实现最低的延迟，无额外的网络跳数。\n- **机制**：\n  - **内核增强**：使用 eBPF 和内核模块（ko）增强内核。\n  - **伪造的 TCP 连接**：在内核中利用“伪建链”来管理复杂的应用层流量。\n  - **流量管理**：在客户端发起通信时直接管理流量，消除不必要的上下文切换和数据拷贝。\n\n{{\u003ccallout tip \u0022伪建链\u0022\u003e}}\n\nKmesh 采用了一种称为“伪建链”的技术，当收到 downstream 的 TCP 请求时，eBPF 程序首先与 downstream 创建一个“伪 TCP 连接”，而不会立即与 upstream 服务建立实际连接。eBPF 程序在获取到 downstream 发出的 HTTP 消息后，根据消息进行 L7 路由处理，找到目标服务后再与 upstream 建立连接。通过这种方式，Kmesh 将 L7 层的处理下沉到内核中，提高了处理效率。\n\n{{\u003c\/callout\u003e}}\n\n**优势**：\n\n- **延迟降低**：转发延迟减少超过 60%。\n- **无需用户空间代理**：整个流量管理在内核内完成。\n\n**考虑因素**：\n\n- **内核版本要求**：可能需要特定的内核版本或增强，这可能影响部署的灵活性。\n\n### 双引擎模式\n\n**概述**：\n\n- **灵活治理**：在性能和更广泛的兼容性之间取得平衡。\n- **机制**：\n  - **内核级拦截**：使用 eBPF 在内核空间拦截流量。\n  - **Waypoint Proxy**：部署远程的 Waypoint Proxy 来处理复杂的 L7 流量管理。\n  - **层次分离**：将 L4 和 L7 的治理在内核空间（eBPF）和用户空间（Waypoint）之间分离。\n\n**优势**：\n\n- **延迟降低**：相比 Istio 的 Ambient Mesh，延迟减少了 **30%**。\n- **简化的流量拦截**：内核空间的拦截比用户空间更安全、更简单。\n- **降低采用门槛**：减少对特定内核版本的依赖，便于用户采用。\n\n**与 Ambient Mesh 的比较**：\n\n- **更少的网络跳数**：Kmesh 对于 L7 连接仅增加一个额外跳数，而 Ambient Mesh 可能增加多达三个。\n- **更简单的架构**：内核级拦截避免了用户空间拦截机制的复杂性。\n\n## 深入了解 Kmesh 的技术\n\n### eBPF 和内核增强\n\n**eBPF（扩展伯克利数据包过滤器）** 是一种强大的技术，允许安全高效地将自定义代码注入到 Linux 内核。Kmesh 利用 eBPF 来：\n\n- **拦截网络流量**：将 eBPF 程序附加到网络事件，实现对数据包的实时拦截和操作。\n- **实现负载均衡**：根据策略将流量导向合适的服务实例。\n- **执行流量加密**：在内核中处理 mTLS 加解密（开发中，计划 2024 年底支持），降低开销。\n- **收集可观测性数据**：在不影响应用性能的情况下收集指标和遥测数据。\n\n### 流量拦截和管理\n\n在内核原生模式中：\n\n- **伪造的连接**：Kmesh 在内核中创建伪造的 TCP 连接，避免涉及用户空间代理来管理流量。\n- **直接的数据包操作**：在内核级拦截和重定向数据包，消除在用户空间和内核空间之间移动数据包时的上下文切换和数据拷贝。\n\n在双引擎模式中：\n\n- **eBPF 拦截**：eBPF 程序处理初始的流量拦截和基本的 L4 管理。\n- **Waypoint Proxy**：对于路由、重试和头部操作等高级 L7 功能，流量被转发到按服务或命名空间部署的 Waypoint Proxy。\n\n### 安全和隔离\n\n- **BPF 虚拟机安全**：eBPF 在内核中的受限虚拟机中运行，确保注入的代码不会破坏内核稳定性。\n- **cgroup 级别隔离**：在 cgroup 级别应用治理策略，为不同的服务和工作负载提供隔离。\n- **mTLS 支持**：计划在内核中实现双向 TLS，提供零信任安全，而无需用户空间的加密开销。\n\n## 性能分析\n\n**测试设置**：\n\n- **基准工具**：使用 [Fortio](https:\/\/github.com\/fortio\/fortio) 生成负载并测量延迟。\n- **比较对象**：在四种配置下测量性能：\n  1. **基线**：没有任何服务网格的直接通信。\n  2. **Istio Sidecar**：传统的 Sidecar 部署。\n  3. **Istio Ambient Mesh**：使用 ztunnel 和 Waypoint 的无 Sidecar 部署。\n  4. **Kmesh**：包括内核原生模式和双引擎模式。\n\n**结果**：\n\n- **延迟**：\n  - **Kmesh 内核原生模式**：相比 Istio Sidecar，转发延迟降低了超过 **60%**。\n  - **Kmesh 双引擎模式**：相比 Istio Ambient Mesh，延迟减少了 **30%**。\n- **资源消耗**：\n  - **CPU 和内存**：Kmesh 将资源开销降低了超过 **70%**，因为无需 Sidecar 代理。\n- **应用启动时间**：\n  - 提高了 **40%**，因为应用不再需要等待 Sidecar 初始化。\n\n**解读**：\n\n- Kmesh 接近基线性能，使服务网格的开销可以忽略不计。\n- 消除上下文切换和数据拷贝对性能提升贡献显著。\n- 内核原生方法确保即使服务数量增加，性能也能保持一致。\n\n## 云原生集成与兼容性\n\n- **Kubernetes 原生**：Kmesh 无缝运行在 Kubernetes 上，管理 Pod 的进出流量，无需更改应用代码。\n- **控制平面集成**：\n  - **xDS 协议支持**：从 Istiod 订阅 xDS 配置，确保与 Istio 控制平面兼容。\n  - **Istio API 兼容性**：支持现有的 Istio API，允许用户使用熟悉的配置和策略。\n- **Gateway API 支持**：兼容 Gateway API，支持更灵活和丰富的流量管理。\n- **可观测性**：\n  - 集成 Prometheus 进行指标收集。\n  - 利用 eBPF 高效地收集数据，不影响性能。\n- **安全策略**：\n  - 支持现有的 Istio 安全策略，包括认证和授权。\n\n## 结论\n\nKmesh 通过将流量管理移入内核，代表了服务网格技术的范式转变。利用 eBPF 和内核增强，它解决了传统 Sidecar 架构中延迟和资源开销的关键问题。Kmesh 为现代云原生应用提供了灵活、高性能的解决方案，特别适用于需要低延迟和高吞吐量的场景。\n\n**主要收获**：\n\n- **性能**：通过消除不必要的开销，实现接近基线的性能。\n- **资源效率**：降低 CPU 和内存消耗，提升部署密度。\n- **灵活性**：提供多种运行模式，适应不同的部署场景。\n- **安全性**：通过内核级的执行和隔离机制增强安全性。\n- **兼容性**：与包括 Kubernetes 和 Istio 在内的现有云原生生态系统无缝集成。\n\n## 参考\n\n- [IstioCon 2023 要点总结](https:\/\/www.zhaohuabing.com\/post\/2023-09-26-istiocon-china\/)\n- [Istio 数据平面的新选择：全新性能体验的架构创新](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYWy\/a-new-choice-for-istio-data-plane-architectural-innovation-for-a-brand-new-performance-experience-istioxiao-zha-sao-daepxia-mo-zha-zhonghu-xu-huawei?iframe=no)', '\/blog\/introducing-kmesh-kernel-native-service-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Kmesh 利用 eBPF 和内核增强，实现高性能、低延迟的服务网格数据平面。它革新了传统的 Sidecar 架构，降低了资源消耗，适用于现代云原生应用。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/noisy-neighbor-detection-with-ebpf/">[译] 使用 eBPF 检测和优化 Linux 容器的噪声邻居问题</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/12</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             其他
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://netflixtechblog.com/noisy-neighbor-detection-with-ebpf-64b1f4b3bbdd" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 eBPF 检测和优化 Linux 容器的噪声邻居问题', 'Netflix 利用 eBPF 技术实现了 Linux 调度器的低开销持续检测，有效地监控和优化了多租户环境中容器的噪声邻居问题。', '\nNetflix 的计算与性能工程团队定期调查我们多租户环境中的性能问题。首先是确定问题是源自应用程序还是底层基础设施。一个经常复杂化这一过程的问题是“噪声邻居”问题。在我们的多租户计算平台 [Titus](https:\/\/netflixtechblog.com\/titus-the-netflix-container-management-platform-is-now-open-source-f868c9fb5436)，“噪声邻居”指的是大量使用服务器资源的容器或系统服务，导致相邻容器的性能下降。我们通常关注 CPU 利用率，因为它是我们工作负载中噪声邻居问题的最常见来源。\n\n检测噪声邻居的影响是复杂的。传统的性能分析工具如 [perf](https:\/\/www.brendangregg.com\/perf.html) 可能会引入显著的开销，从而加剧性能下降。此外，这些工具通常在事后部署，对有效调查来说已经太迟了。另一个挑战是，调试噪声邻居问题需要相当的底层专业知识和专门的工具。在这篇博客文章中，我们将展示我们如何利用 [eBPF](https:\/\/ebpf.io\/) 实现 Linux 调度器的持续、低开销的检测，有效地自助监控噪声邻居问题。你将学习到 Linux 内核检测如何改善你的基础设施可观测性，并带来更深入的洞察和增强的监控。\n\n## 持续检测 Linux 调度器\n\n为了确保我们依赖低延迟响应的工作负载的可靠性，我们对每个容器的 [run queue](https:\/\/en.wikipedia.org\/wiki\/Run_queue) 延迟进行了检测，这个指标衡量进程在调度队列中等待被派发到 CPU 的时间。在此队列中的长时间等待可能是性能问题的征兆，尤其是当容器没有使用其全部 CPU 分配时。持续的检测对于抓住这类问题至关重要，而 eBPF 通过最小的开销进入 Linux 调度器，使我们能够有效地监控 run queue 延迟。\n\n为了发出 run queue 延迟指标，我们利用了三个 eBPF 钩子：\u0060sched_wakeup\u0060、\u0060sched_wakeup_new\u0060 和 \u0060sched_switch\u0060。\n\n![图 1：测量和检测 run queue 延迟的图示](f1.png)\n\n\u0060sched_wakeup\u0060 和 \u0060sched_wakeup_new\u0060 钩子在进程状态从“睡眠”变为“可运行”时调用。它们让我们识别出进程准备运行并等待 CPU 时间的时刻。在此事件中，我们生成一个时间戳，并使用进程 ID 作为键，将其存储在 eBPF 哈希图中。\n\n\u0060\u0060\u0060c\u002b\u002b\nstruct {\n    __uint(type, BPF_MAP_TYPE_HASH);\n    __uint(max_entries, MAX_TASK_ENTRIES);\n    __uint(key_size, sizeof(u32));\n    __uint(value_size, sizeof(u64));\n} runq_enqueued SEC(\u0022.maps\u0022);\n\nSEC(\u0022tp_btf\/sched_wakeup\u0022)\nint tp_sched_wakeup(u64 *ctx)\n{\n    struct task_struct *task = (void *)ctx[0];\n    u32 pid = task-\u003epid;\n    u64 ts = bpf_ktime_get_ns();\n\n    bpf_map_update_elem(\u0026runq_enqueued, \u0026pid, \u0026ts, BPF_NOEXIST);\n    return 0;\n}\n\u0060\u0060\u0060\n\n相反，\u0060sched_switch\u0060 钩子在 CPU 在进程间切换时触发。这个钩子提供了当前利用 CPU 的进程和即将接管的进程的指针。我们使用即将执行任务的进程 ID (PID) 来获取之前存储的时间戳。然后，我们通过简单地减去时间戳来计算 run queue 延迟。\n\n\u0060\u0060\u0060c\u002b\u002b\nSEC(\u0022tp_btf\/sched_switch\u0022)\nint tp_sched_switch(u64 *ctx)\n{\n    struct task_struct *prev = (struct task_struct *)ctx[1];\n    struct task_struct *next = (struct task_struct *)ctx[2];\n    u32 prev_pid = prev-\u003epid;\n    u32 next_pid = next-\u003epid;\n \n    \/\/ 获取下一个任务入队的时间戳\n    u64 *tsp = bpf_map_lookup_elem(\u0026runq_enqueued, \u0026next_pid);\n    if (tsp == NULL) {\n        return 0; \/\/ 未记录入队\n    }\n\n    \/\/ 在删除存储的时间戳前计算 runq 延迟\n    u64 now = bpf_ktime_get_ns();\n    u64 runq_lat = now - *tsp;\n\n    \/\/ 从 enqueued 图中删除 PID\n    bpf_map_delete_elem(\u0026runq_enqueued, \u0026next_pid);\n    ....\n\u0060\u0060\u0060\n\neBPF 的一个优势是它能提供指向实际内核数据结构的指针，这些结构代表进程或线程，也称为内核术语中的任务。这一特性使得我们能够访问关于进程存储的大量信息。我们需要进程的 cgroup ID 以将其与容器关联，但是进程结构中的 cgroup 信息受到 [RCU (Read Copy Update) 锁](https:\/\/elixir.bootlin.com\/linux\/v6.6.16\/source\/include\/linux\/sched.h#L1225) 的保护。\n\n为了安全地访问这些受 RCU 保护的信息，我们可以利用 eBPF 中的 [kfuncs](https:\/\/docs.kernel.org\/bpf\/kfuncs.html)。kfuncs 是可以从 eBPF 程序调用的内核函数。这些函数确保我们的 eBPF 程序在检索任务结构中的 cgroup ID 时保持安全和高效。\n\n\u0060\u0060\u0060c\u002b\u002b\nvoid bpf_rcu_read_lock(void) __ksym;\nvoid bpf_rcu_read_unlock(void) __ksym;\n\nu64 get_task_cgroup_id(struct task_struct *task)\n{\n    struct css_set *cgroups;\n    u64 cgroup_id;\n    bpf_rcu_read_lock();\n    cgroups = task-\u003ecgroups;\n    cgroup_id = cgroups-\u003edfl_cgrp-\u003ekn-\u003eid;\n    bpf_rcu_read_unlock();\n    return cgroup_id;\n}\n\u0060\u0060\u0060\n\n数据准备好后，我们必须将其打包并发送到用户空间。为此，我们选择了 eBPF [环形缓冲区](https:\/\/nakryiko.com\/posts\/bpf-ringbuf\/)。它既高效又高性能，且用户友好。它可以处理变长数据记录，并允许数据读取而无需额外的内存复制或系统调用。然而，大量数据点使得用户空间程序的 CPU 使用过多，所以我们在 eBPF 中实施了速率限制以采样数据。\n\n\u0060\u0060\u0060c\u002b\u002b\nstruct {\n    __uint(type, BPF_MAP_TYPE_RINGBUF);\n    __uint(max_entries, RINGBUF_SIZE_BYTES);\n} events SEC(\u0022.maps\u0022);\n\nstruct {\n    __uint(type, BPF_MAP_TYPE_PERCPU_HASH);\n    __uint(max_entries, MAX_TASK_ENTRIES);\n    __uint(key_size, sizeof(u64));\n    __uint(value_size, sizeof(u64));\n} cgroup_id_to_last_event_ts SEC(\u0022.maps\u0022);\n\nstruct\n\n runq_event {\n    u64 prev_cgroup_id;\n    u64 cgroup_id;\n    u64 runq_lat;\n    u64 ts;\n};\n\nSEC(\u0022tp_btf\/sched_switch\u0022)\nint tp_sched_switch(u64 *ctx)\n{\n    \/\/ ....\n    \/\/ 上述代码\n    \/\/ ....\n \n    u64 prev_cgroup_id = get_task_cgroup_id(prev);\n    u64 cgroup_id = get_task_cgroup_id(next);\n \n    \/\/ 按每个 cgroup ID 每个 CPU 进行速率限制\n    \/\/ 平衡可观测性与性能开销\n    u64 *last_ts = \n        bpf_map_lookup_elem(\u0026cgroup_id_to_last_event_ts, \u0026cgroup_id);\n    u64 last_ts_val = last_ts == NULL ? 0 : *last_ts;\n\n    \/\/ 在进行更多工作之前检查考虑中的 cgroup ID 的速率限制\n    if (now - last_ts_val \u003c RATE_LIMIT_NS) {\n        \/\/ 速率限制超出，丢弃事件\n        return 0;\n    }\n\n    struct runq_event *event;\n    event = bpf_ringbuf_reserve(\u0026events, sizeof(*event), 0);\n  \n    if (event) {\n        event-\u003eprev_cgroup_id = prev_cgroup_id;\n        event-\u003ecgroup_id = cgroup_id;\n        event-\u003erunq_lat = runq_lat;\n        event-\u003ets = now;\n        bpf_ringbuf_submit(event, 0);\n        \/\/ 更新当前 cgroup ID 的最后一个事件时间戳\n        bpf_map_update_elem(\u0026cgroup_id_to_last_event_ts, \u0026cgroup_id,\n            \u0026now, BPF_ANY);\n\n    }\n\n    return 0;\n}\n\u0060\u0060\u0060\n\n我们在 Go 开发的用户空间应用程序处理环形缓冲区中的事件，以向我们的度量后端 [Atlas](https:\/\/netflixtechblog.com\/introducing-atlas-netflixs-primary-telemetry-platform-bd31f4d8ed9a) 发出度量。每个事件包含一个带有 cgroup ID 的 run queue 延迟样本，我们将其与主机上运行的容器关联。如果没有发现这种关联，我们会将其分类为系统服务。当 cgroup ID 与容器关联时，我们会为该容器发出百分位计时器 Atlas 度量（\u0060runq.latency\u0060）。我们还增加了一个计数器度量（\u0060sched.switch.out\u0060）来监控容器进程的抢占情况。通过访问被抢占进程的 \u0060prev_cgroup_id\u0060，我们可以为度量标记抢占的原因，无论是同一容器（或 cgroup）内的进程、另一个容器的进程还是系统服务的进程。\n\n值得强调的是，\u0060runq.latency\u0060 度量和 \u0060sched.switch.out\u0060 度量都需要确定容器是否受到噪声邻居的影响，这是我们旨在实现的目标。单独依赖 \u0060runq.latency\u0060 度量可能会导致误解。例如，如果容器处于或超过其 cgroup CPU 限制，调度器将对其进行限制，导致队列中的延迟明显增加。如果我们只考虑这个度量，我们可能错误地将性能下降归咎于噪声邻居，而实际上是因为容器触及了其 CPU 配额。然而，当两个度量同时出现尖峰，尤其是当原因是不同容器或系统进程时，明显表明了噪声邻居问题。\n\n## 噪声邻居的故事\n\n以下是一台运行单个容器的服务器的 \u0060runq.latency\u0060 度量，该容器拥有充足的 CPU 容量。99 百分位平均为 83.4 微秒（微秒），作为我们的基准。尽管有些尖峰达到 400 微秒，但延迟仍在可接受的参数范围内。\n\n![](f2.png)\n\ncontainer1 的 99 百分位 runq.latency 平均为 83 微秒（微秒），尖峰可达 400 微秒，没有相邻容器。这作为一个容器在主机上未争夺 CPU 的基准。\n\n在 10:35，启动 \u0060container2\u0060，它充分利用了主机上的所有 CPU，导致 \u0060container1\u0060 的 P99 run queue 延迟出现了 131 毫秒的尖峰（131,000 微秒）。如果用户空间应用程序正在服务 HTTP 流量，则这一尖峰将在用户空间应用程序中可见。如果用户空间应用程序所有者报告了无法解释的延迟尖峰，我们可以通过 run queue 延迟度量迅速识别噪声邻居问题。\n\n![](f3.png)\n\n在 10:35 启动的 container2 充分利用了主机上的所有 CPU，**导致 container1 的 P99 run queue 延迟出现了 131 毫秒的尖峰**，因为系统进程的抢占增加。这表明存在一个噪声邻居问题，即系统服务与容器竞争 CPU 时间。我们的度量显示，噪声邻居实际上是系统进程，可能是由 \u0060container2\u0060 消耗所有可用 CPU 容量触发的。\n\n## 优化 eBPF 代码\n\n我们开发了一个名为 [bpftop](https:\/\/netflixtechblog.com\/announcing-bpftop-streamlining-ebpf-performance-optimization-6a727c1ae2e5) 的开源 eBPF 进程监控工具，用来测量此内核热路径中 eBPF 代码的开销。我们使用 \u0060bpftop\u0060 进行的性能分析显示，检测仪增加的开销不到每个 \u0060sched_*\u0060 钩子 600 纳秒。我们对在容器中运行的 Java 服务进行了性能分析，发现检测代码未引入显著开销。开启与关闭 run queue 检测代码的性能差异在毫秒级不可测。\n\n在我们对内核中如何测量 eBPF 统计信息的研究中，我们发现了一个改进计算的机会。我们提交了这个 [patch](https:\/\/git.kernel.org\/pub\/scm\/linux\/kernel\/git\/torvalds\/linux.git\/commit\/?id=ce09cbdd988887662546a1175bcfdfc6c8fdd150)，并包括在 Linux 内核 6.10 版本中。\n\n![](f4.gif)\n\n通过试错和使用 \u0060bpftop\u0060，我们确定了几种优化，帮助保持了我们 eBPF 代码的低开销：\n\n- 我们发现 \u0060BPF_MAP_TYPE_HASH\u0060 存储入队时间戳时最为高效。使用 \u0060BPF_MAP_TYPE_TASK_STORAGE\u0060 会导致性能下降近一倍。\u0060BPF_MAP_TYPE_PERCPU_HASH\u0060 的性能略低于 \u0060BPF_MAP_TYPE_HASH\u0060，这是意料之外的，需要进一步调查。\n- \u0060BPF_MAP_TYPE_LRU_HASH\u0060 映射的操作比常规哈希映射慢 40-50 纳秒。由于 PID 流失引起的空间问题，我们最初使用了它们来存储入队时间戳。最终，我们选择了增大尺寸的 \u0060BPF_MAP_TYPE_HASH\u0060，以降低这一风险。\n- \u0060BPF_CORE_READ\u0060 帮助每次调用增加 20-30 纳秒。在特别是那些“BTF 启用”的原始跟踪点（\u0060tp_btf\/*\u0060）的情况下，直接访问任务结构成员是安全且更高效的。Andrii Nakryiko 在这篇 [博客文章](https:\/\/nakryiko.com\/posts\/bpf-core-reference-guide\/#btf-enabled-bpf-program-types-with-direct-memory-reads) 中推荐了这种方法。\n- \u0060sched_switch\u0060、\u0060sched_wakeup\u0060 和 \u0060sched_wakeup_new\u0060 都会因内核任务触发，这些任务的 PID 为 0。我们发现监控这些任务是不必要的，因此我们实施了几种提前退出条件和条件逻辑，以防在处理内核任务时执行代价高昂的操作，如访问 BPF 映射。值得注意的是，内核任务就像任何常规进程一样通过调度队列操作。\n\n## 结论\n\n我们的发现突出了使用 eBPF 对 Linux 内核进行低开销持续检测的价值。我们已将这些度量整合到客户仪表板中，使其能够提供可操作的洞察，并指导多租户性能讨论。我们现在也可以使用这些度量来完善 CPU 隔离策略，以最小化噪声邻居的影响。此外，这些度量使我们深入了解了 Linux 调度器。\n\n这项工作还加深了我们对 eBPF 技术的理解，并强调了像 \u0060bpftop\u0060 这样的工具对优化 eBPF 代码的重要性。随着 eBPF 的采用增加，我们预见更多的基础设施可观测性和业务逻辑将转向使用它。在这方面有一个前景广阔的项目是 [sched_ext](https:\/\/github.com\/sched-ext\/scx)，它有潜力革新调度决策的制定方式，并根据特定工作负载需求进行定制。\n', '\/trans\/noisy-neighbor-detection-with-ebpf\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Netflix 利用 eBPF 技术实现了 Linux 调度器的低开销持续检测，有效地监控和优化了多租户环境中容器的噪声邻居问题。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/service-mesh-data-plane-deployment-modes/">深入解析服务网格的四种数据平面部署模式：性能、安全性与成本分析</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/10</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('深入解析服务网格的四种数据平面部署模式：性能、安全性与成本分析', '在本文中，我将详细解析四种主要的服务网格数据平面部署模式，包括 Sidecar 模式、Ambient 模式、Cilium mesh 模式和 gRPC 模式。通过对这些模式的架构、性能、安全性、管理复杂性和资源成本的分析，提供选择建议，帮助你在不同的应用场景中做出最优决策。无论你是追求高性能、低资源消耗，还是需要更高的安全保障，本指南都能帮助你找到合适的部署模式。', '\n本文将向你介绍 Istio 服务网格的四种平面部署模式，通过分析它们的优缺点，根据他们的性能、可靠性和安全性给出选择建议。\n\n## 什么是服务网格？\n\n服务网格是一种基础设施层，通常使用应用代理来实现各种功能。以 Istio 为例，它通过应用代理让用户能够将应用感知的流量管理、强大的可观测性和稳健的安全能力编程到网络中。Istio 确保云原生和分布式系统具有弹性，使现代企业能够在不同平台上维护其工作负载，同时保持连接和受保护。它的功能包括零信任安全、策略管理和访问控制等安全和治理控制，以及金丝雀部署、A\/B 测试、负载均衡和故障恢复等网络功能，还能提供对整个网络流量的可观测性。Istio 不受单一集群、网络或运行时的限制，可以将在 Kubernetes 或虚拟机上运行的服务、多云、混合或本地的服务包含在单个网格中。其设计可扩展，并得到广泛生态系统的支持。\n\n服务网格的架构分为控制平面和数据平面，以 Istio 为例，\u0060istiod\u0060 是它的控制平面，而数据平面有两种部署模式，用户可以选择 sidecar 或 ambient 模式。\n\n![Istio 服务网格的架构图（来源 [istio.io](https:\/\/istio.io\/latest\/about\/service-mesh\/)）](service-mesh.svg)\n\n实际上服务网格的数据平面的部署模式不止这两种，加上 Istio 支持的 [gRPC 无 sidecar 的服务网格](https:\/\/istio.io\/latest\/blog\/2021\/proxyless-grpc\/)，以及 [Cilium service mesh](https:\/\/cilium.io\/use-cases\/service-mesh\/)，一共有四种部署模式。\n\n## 数据平面部署模式\n\n下表格从多个维度对服务网格数据平面的部署模式进行了比较。\n\n{{\u003ctable \u0022服务网格的四种部署模式对比\u0022\u003e}}\n\n| **数据平面模式**                          | **平台安全性** 威胁评估、风险                                | **资源效率** – 基础设施\/资源消耗等             | **可管理性** – 升级、漏洞等                                | **性能** – 延迟等                                          |\n| ----------------------------------------- | ------------------------------------------------------------ | ---------------------------------------------- | ---------------------------------------------------------- | ---------------------------------------------------------- |\n| **Sidecar模式**：每个服务实例的L4和L7代理 | 高安全性，因为每个服务实例都有独立的代理，减少了攻击面。风险管理取决于控制平面配置。 | 较高的资源消耗，因为每个实例需要独立的代理。   | 需要集中管理和配置，升级相对复杂，但可以通过控制平面简化。 | 请求需要通过代理转发，可能增加延迟。                       |\n| **Ambient模式**：共享L4 – L7每个服务模型  | 通过ztunnel进行本地路由设计的安全性。然而，共享代理可能会带来风险，其整体安全成熟度仍在发展中。 | 效率较高，因为多个服务共享相同的代理。         | 管理相对简单，但可能因共享代理而面临漏洞。                 | 本地路由性能良好，但在waypoint代理下可能会产生跨AZ的成本。 |\n| **Cilium Mesh模式**：共享L4和L7模型       | 中等安全性，专注于eBPF和细粒度访问控制。然而，身份和信任模型方面存在已知问题。 | 内核级处理提高效率，减少基础设施开销。         | 管理更复杂，需要处理多个服务的配置。                       | 性能可变；某些场景可能会引入显著的延迟。                   |\n| **gRPC模式**：L4和L7集成在应用模型中      | 虽然gRPC将代理功能集成在应用程序中，理论上减少了攻击面，但应用程序的复杂性和多样性实际上可能扩大它。gRPC模式的安全性依赖于具体的用例，需要对潜在威胁和攻击面进行仔细评估。 | 更高的效率，因为代理在与应用相同的进程中实现。 | 管理复杂，需要定期更新和维护应用层代理。                   | 性能优越，延迟低，适合实时应用。                           |\n\n{{\u003c\/table\u003e}}\n\n你可以从下图中更直观地看到这四种模式在成本和安全性方面的比较：\n\n![服务网格部署模式对比](istio-data-plane-deployment-modes.svg)\n\n下图说明了服务网格数据平面的不同部署模式中代理的潜在位置。\n\n![服务网格数据平面的不同部署模式中的代理位置](overview.svg)\n\n- **Sidecar 模式**：代理与应用程序容器位于同一个 Pod 中\n- **Ambient 模式**：L4 代理与应用程序容器位于同一个节点上，L7 代理不一定跟应用程序容器在同一个节点上\n- **Cilium 模式**：L4 和 L7 代理作为一个整体与应用程序容器在同一个节点上\n- **gRPC 模式**：gRPC 框架集成到应用程序中，共同部署在一个容器中\n\n## Sidecar 模式：每个服务实例一个 L4 和 L7 的代理\n\n下面展示的是 sidecar 模式中 Application 1 访问同节点上的 Application 2 及跨节点上的 Application 3 的通信路径。\n\n![Sidecar 模式：每个服务实例一个 L4 和 L7 代理](sidecar-mode.svg)\n\n这是最常见的服务网格部署模式，也是 [Istio](https:\/\/istio.io) 服务网格起初支持的模式。每个服务实例旁边部署一个代理（如 [Envoy](https:\/\/envoyproxy.io)），该代理处理进出该服务的所有网络通信，包括 L4 和 L7 网络通信。\n\n- **优点**：安全性高，因为每个服务实例都是隔离的，减少了潜在的攻击面。\n- **缺点**：资源消耗较高，因为每个服务实例都需要单独的代理，增加了基础设施成本。\n- **成熟度**：Istio Sidecar 模式的成熟度已经达到生产级别，它们经过广泛测试并准备好在实际环境中使用。\n\n## Ambient 模式：节点共享 L4 代理，服务账户共享 L7 代理\n\n下面展示的是 ambient 模式中 Application 1 访问同节点上的 Application 2 及跨节点上的 Application 3 的通信路径。\n\n![Ambient 模式：节点共享 L4 代理，服务账户共享 L7 代理](ambient-mode.svg)\n\n在这种模式下，每个节点上的共享L4代理为同一物理主机上的所有服务实例提供服务，而每个服务账户都有一个专用的L7代理。\n\n- **优点**：成本较低，因为多个服务共享同一个代理。\n- **缺点**：尽管ztunnel（Istio网格中）组件是为安全性设计的，共享代理可能会带来风险。此模型的安全成熟度仍在发展中。\n- **成熟度**：Istio的Ambient模式目前处于beta阶段，没有大规模的生产级最佳实践，也不支持多集群。\n\n## Cilium mesh 模式：共享的 L4 和 L7 代理\n\n下面展示的是 Cilium mesh 模式中 Application 1 访问同节点上的 Application 2 及跨节点上的 Application 3 的通信路径。\n\n![Cilium mesh 模式：共享的 L4 和 L7 代理](cilium-mesh-mode.svg)\n\n这种模式介于完全独立和完全共享之间，每个节点都有一个共享的L7代理。然而，身份和信任模型方面存在已知问题。使用eBPF的Cilium服务网格允许通过内核程序实现无需代理的网络策略。\n\n- **优点**：在特定场景下，内核级效率可以降低基础设施成本。\n- **缺点**：管理更复杂，某些场景可能会导致延迟增加。\n- **成熟度**：Cilium Mesh通过eBPF直接管理L4流量，并在每个节点上配置Envoy代理以通过CRD（如CiliumEnvoyConfig）控制L7流量。然而，由于身份模型不一致，其安全性令人担忧。该[代理](https:\/\/github.com\/cilium\/proxy)是经过定制过的，它具有最少的 Envoy 扩展和 Cilium 策略执行过滤器。因此，该 Cilium mesh 可能无法支持 Envoy 代理的全部功能。\n\n**注意**：该模式并非 Istio 的数据平面。\n\n## gRPC 模式：L4 和 L7 代理集成到应用程序内\n\n在gRPC模式中，没有部署外部代理；而是通过RPC框架将代理功能直接集成到应用程序中，导致对应用程序的显著侵入。服务网格控制平面使用一组称为xDS API的发现API来动态配置应用程序。应用程序中的gRPC客户端库提供对xDS API的广泛支持。利用这种能力，服务网格控制平面可以在服务容器内的这个库中直接编程L4和L7代理功能。\n\n下图展示了在 Istio 的 gRPC 模式中，控制平面如何与应用程序通信。\n\n![gRPC 模式：L4 和 L7 代理集成到应用程序内](grpc-mode.svg)\n\n在这种模式下，当gRPC服务与控制平面通信时，不需要传统的Sidecar代理，而是使用特定的代理进行初始化和与控制平面的通信。此设计减少了资源消耗和部署复杂性，同时仍能实现服务发现、流量管理等功能。\n\n- **优点**：高性能，由于代理与应用程序紧密集成，减少了网络跳跃和额外的开销。\n- **缺点**：高复杂性，需要在应用程序内部实现复杂的网络处理功能，这可能增加开发成本。\n- **安全性考虑**：这种模式的安全性存在争议。虽然将代理功能集成在应用程序中理论上减少了外部攻击面，但应用程序的多样性和复杂性可能会扩大整体攻击面。因此，在考虑gRPC模式的安全性时，必须仔细分析其具体用例中的安全威胁模型和攻击风险。\n- **成熟度**：Istio的gRPC模式仍处于实验阶段。\n\n## 如何选择？\n\n如前所述，选择服务网格数据平面部署模式的决定因素有多个：\n\n- 成熟度\n- 企业的安全需求\n- 资源限制\n- 性能要求\n- 网络开销\n- 管理复杂性的容忍度\n\n### 成熟度\n\n在考虑服务网格数据平面部署模式时，成熟度是一个关键因素。每种模式的成熟度都会影响其在生产环境中的可靠性和支持程度：\n\n- **Sidecar模式**：这是最成熟的服务网格部署模式，广泛应用于生产环境，并得到良好支持。\n- **Ambient模式**：尽管该模式提供了一些成本和性能优势，但它仍处于早期阶段，可能缺乏成熟的最佳实践和广泛的生态系统支持。\n- **Cilium Mesh模式**：作为一个相对较新的选择，它在使用eBPF的场景中提供了独特的技术优势。然而，其安全模型和身份管理的担忧表明，它可能不像其他模式那样成熟或可靠。\n- **gRPC模式**：尽管性能出色，但这种模式的复杂性和侵入性意味着它可能需要更多的定制开发，目前仍处于实验阶段。\n\n### 安全需求\n\n如果您的业务有较高的安全需求，如金融或医疗行业，那么**Sidecar模式**可能是最佳选择。这种模式通过确保每个服务实例都有自己独立的代理，从而最大限度地实现服务隔离。对于那些探索较新模式（如**Ambient模式**）的用户来说，必须了解虽然ztunnel旨在实现安全的本地路由，但该模式的整体安全策略仍在发展中。\n\n### 资源限制\n\n在资源受限的环境中，为每个服务实例部署一个单独的代理可能不切实际。在这种情况下，可以考虑**gRPC模式**或**Ambient模式**。**gRPC模式**特别适合已经广泛使用gRPC且愿意在应用程序内部处理复杂网络功能的组织。另一方面，**Ambient模式**通过共享代理来减少资源消耗。\n\n### 性能要求\n\n对于需要高性能和低延迟的应用程序，**gRPC模式**提供了最佳性能，因为它消除了传统代理引入的额外网络跳跃。然而，值得注意的是，gRPC模式仍处于实验阶段，可能不支持Istio的所有功能。请根据您的服务网格功能需求进行考虑。\n\n### 网络开销\n\n每种数据平面模式对网络开销都有不同的影响。**Sidecar模式**通过本地化路由减少了跨区域流量，但增加了网络跳跃，增加了延迟和计算使用。**Ambient模式**使用ztunnel进行本地路由，但在waypoint代理下可能会产生跨AZ的成本。**Cilium模式**将代理放置在与应用程序相同的节点上，可能减少节点间的流量，但可能引入更多的延迟。**gRPC模式**将RPC框架集成到应用程序中，最小化网络跳跃和开销，适用于高性能、低延迟的需求。\n\n### 对管理复杂性的容忍度\n\n选择服务网格数据平面模式时，管理复杂性也是一个重要的考虑因素。**Sidecar模式**和**gRPC模式**可能需要更复杂的配置和维护，而在某些部署环境中，**Ambient模式**可能提供更简化的管理体验。**Cilium模式**由于依赖于eBPF和多个配置点，可能需要更复杂的管理。\n\n## 结论\n\n选择正确的服务网格数据平面部署模式取决于多个特定因素，包括成熟度、安全性、资源限制、性能和管理复杂性。以下是一个快速指南：\n\n- **Sidecar模式**：最适合高安全需求，提供最大的隔离性。\n- **gRPC模式**：适用于高性能需求且已在使用gRPC的环境。\n- **Ambient模式**：适合成本效益和较低隔离需求，但安全模型正在演变中。\n- **Cilium Mesh模式**：可能适用于利用eBPF技术的基础设施，但需考虑安全性和管理复杂性。\n\n最佳选择将与您的应用程序需求、安全策略和技术熟悉度相一致。理解每种模式的优势和局限性，以做出平衡收益、风险和成本的明智决策。\n\n## 参考文献\n\n- [云原生应用的服务网格代理模型](https:\/\/csrc.nist.gov\/pubs\/sp\/800\/233\/ipd)\n', '\/blog\/service-mesh-data-plane-deployment-modes\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">在本文中，我将详细解析四种主要的服务网格数据平面部署模式，包括 Sidecar 模式、Ambient 模式、Cilium mesh 模式和 gRPC 模式。通过对这些模式的架构、性能、安全性、管理复杂性和资源成本的分析，提供选择建议，帮助你在不同的应用场景中做出最优决策。无论你是追求高性能、低资源消耗，还是需要更高的安全保障，本指南都能帮助你找到合适的部署模式。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/service-mesh-sidecar-vs-sidecarless-debate/">服务网格架构：Sidecar vs. Sidecarless，谁才是未来？</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/09</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('服务网格架构：Sidecar vs. Sidecarless，谁才是未来？', '探讨服务网格架构中 sidecar 与 sidecarless 的争论，比较 Cilium、Istio 和 Linkerd 在安全性、性能和架构复杂性方面的不同观点，帮助读者理解这些技术专家的看法和背后的争议。', '\n服务网格已经成为现代云原生应用架构中至关重要的一部分，帮助团队在大规模分布式系统中管理微服务通信、提高安全性并优化性能。然而，随着技术的不断演进，关于服务网格架构的最佳实践出现了激烈的争论，尤其是关于 sidecar 与 sidecarless 模式的选择问题。这场争论的核心在于如何在性能、资源利用、安全性和操作复杂性之间取得最佳平衡。近年来，Cilium 引入了无 sidecar 架构的 eBPF 技术，而 Istio 也推出了 Ambient 模式，结合了传统 sidecar 与无 sidecar 的优点。与此同时，Linkerd 则坚守 sidecar 架构，并对新兴的无 sidecar 方法持保守态度。这篇文章将深入探讨这些服务网格架构的主要观点和争议，并分析每种方法的优势与挑战。\n\n## 关于服务网格有无 sidecar 的争论\n\n关于服务网格的 sidecar 与无 sidecar 的争论是随着 Cilium 的推出和各大服务网格技术的演变而逐渐加剧的，尤其是在 2021 年之后：\n\n1. **Cilium Service Mesh 的推出（2021 年 12 月）**  ：Cilium 通过 eBPF 技术引入了无 sidecar 的服务网格架构，开始引发对传统 sidecar 模式的讨论。这一概念的提出标志着无 sidecar 架构的兴起。\n   \n2. **Linkerd 与 Istio 的反应（2021 年 12 月至 2022 年初）** ：Linkerd 的创始人 William Morgan 及其团队对 Cilium 的无 sidecar 方法表示担忧，认为这种方法可能会带来安全和性能上的问题。这一讨论逐渐演变为对 sidecar 与无 sidecar 架构的更广泛争辩。\n   \n3. **Istio 的 Ambient 概念（2022 年 5 月）** ：Istio 提出了 Ambient Mesh，尝试结合 sidecar 和主机级代理的优势，这进一步加剧了各方对服务网格架构的讨论。此时，业界对不同服务网格架构的看法开始分化。\n   \n4. **专家观点的发表（2021 年 12 月至 2023 年）**  ：多位行业专家如 Thomas Graf 和 William Morgan 等在不同场合发表了对 sidecar 与无 sidecar 架构的看法，形成了更为系统的争论。这些观点在多个会议和文章中被广泛讨论，推动了对服务网格架构的深入理解。\n\n## 各方观点\n\n下表摘录了各服务网格提供商及用户的公开观点。\n\n{{\u003ctable \u0022关于服务网格技术选型的公开观点\u0022\u003e}}\n\n| **人物**            | **职位\/公司**                             | **观点**                                                     |\n| ------------------- | ----------------------------------------- | ------------------------------------------------------------ |\n| **Andrey Rybka**    | Bloomberg                                 | 倾向于选择成熟度更高的 Istio，特别是在有 Google 等大公司支持的情况下。 |\n| **Ara Pulido**      | Datadog 开发者关系专家                     | 认为 eBPF 工具（如 Cilium）是 Kubernetes 网络扩展问题的解决方案，使用 Cilium 可以完全替代 kube-proxy，实现更细粒度的容器安全特性；移除 kube-proxy 后，操作简化，性能提升。 |\n| **Dale Ragan**      | SAP Concur Technologies 首席软件设计工程师 | 认为 eBPF 在安全方面提供了更好的优势，可同时应用于整个集群和各个服务；正在使用 Cilium 替代 Flannel 作为其生产环境中的容器网络接口（CNI）插件，并测试 Isovalent 的专有 SecOps 插件。 |\n| **Dan Wendlandt**   | Isovalent CEO                             | 认为 eBPF 和服务网格是互补的技术，eBPF 可作为服务网格的基础，为服务网格代理（如 Envoy）提供高效的数据进出服务。 |\n| **David Ortiz**     | Constant Contact 首席软件工程师            | 对 Istio 的 Ambient Mesh 非常感兴趣，认为其显著简化了 Istio 的操作流程，尤其是在升级方面，计划尽快采用这一技术。 |\n| **Filip Nikolic**   | PostFinance                               | 认为 eBPF 基础的无 sidecar 服务网格具有更高的网络性能和效率，并且安全实践也在不断进化。 |\n| **Greg Otto**       | Comcast 云服务执行董事                     | 对 Istio Ambient Mesh 感兴趣，计划在其成熟后进行评估；希望能够分别扩展和服务第 7 层（L7）和第 4 层（L4）功能，认为减少不必要的 L7 过滤可以减少安全暴露面和漏洞风险。 |\n| **John Mitchell**   | 独立数字化转型顾问                        | 认为 eBPF 正经历一个炒作周期，但它确实有潜力为 Kubernetes 提供高级网络安全特性，而无需改变应用程序代码。 |\n| **Kasper Nissen**   | Lunar 的首席平台架构师                     | 支持 sidecar 架构，认为它简单易用，并与其他容器技术相同；在全面部署服务网格后，资源消耗增加不多但功能增多；指出 sidecar 同步问题源于 Kubernetes 网络层的问题，建议在 Kubernetes 层面进行修复。 |\n| **Louis Ryan**      | Solo.io CTO                               | 强调 Istio 1.23 版引入的 Ambient Mesh 的优势，包括减少 sidecar 的使用，简化架构，提高性能，降低复杂性，并增强了灵活性与可扩展性。他认为，Ambient Mesh 能够帮助团队更轻松地管理微服务架构。 |\n| **Thomas Graf**     | Isovalent CTO                             | 主张通过 eBPF 和 Cilium 提供无边车的服务网格，优化 mTLS 认证，消除 sidecar 的使用，从而提高性能和安全性。认为分离认证握手和数据传输的模式能够实现更高效、更灵活的服务间认证，同时减少管理复杂性，并提供对多种网络协议的支持。 |\n| **William Morgan**  | Linkerd 创始人兼 Buoyant CEO                | 强烈批评无 sidecar 的 eBPF 方法，认为 sidecar 提供了更好的安全隔离和性能预测性，指出 sidecarless 架构可能重蹈 Linkerd 1 的覆辙。他认为，eBPF 和 sidecar 不是对立的，eBPF 可以用于网络优化，但不应替代 sidecar。主张继续使用更轻量的 sidecar 代理。 |\n| **Zachary Butcher** | Tetrate 创始工程师                         | 对 Ambient Mesh 持审慎乐观态度，认为它有助于降低服务网格的采用难度，但当前性能表现较差、功能有限，距离生产就绪还有很长的路要走。他建议用户暂时不要在生产环境中使用 Ambient Mesh，直到其成熟度提高。 |\n\n{{\u003c\/table\u003e}}\n\n## 个人观点\n\n近年来，我有幸见证并参与了许多关于服务网格架构选择的讨论和实践。我认为服务网格选择不应仅仅基于技术特性的比较，更应考虑到团队的具体需求、现有技术栈的兼容性以及未来的扩展性。\n\n在 sidecar 与 sidecarless 的选择问题上，我的看法是两者各有千秋。Sidecar 模型虽然在某些情况下可能会带来资源占用和管理复杂性的增加，但它提供了更细粒度的流量控制和安全策略实施，这对于需要高度精细化管理的企业环境是非常宝贵的。与此同时，sidecarless 模型，尤其是通过 eBPF 技术实现的，为服务网格带来了前所未有的性能优化和资源利用率提升，它对于构建高效率的大规模服务网格同样具有重要价值。\n\n因此，我的建议是，企业在选择服务网格架构时，应该从自身的业务需求出发，综合考虑安全性、性能、成本以及团队的运维能力，选择最适合自己的服务网格解决方案。\n\n## 总结\n\n总结下目前关于这三个流行的服务网格项目的主流看法：\n\n1. **Linkerd**：强调 sidecar 的安全隔离和性能稳定性，对 eBPF 无 sidecar 模式持批评态度，认为其复杂性和安全风险增加。\n2. **Istio**：引入 Ambient Mesh，部分采用无 sidecar 方法，以降低复杂性和提高性能，但仍保留 sidecar 的部分功能，体现出对现有 sidecar 架构的保留与创新。\n3. **Cilium**：主张通过 eBPF 无 sidecar 模式来优化网络性能和安全性，简化操作，同时保持对多种协议的支持，推动服务网格功能集成到 Linux 内核中。\n\n不同的观点反映了各自对服务网格架构设计的偏好与关注点，不同企业应根据自身需求和技术背景选择合适的服务网格方案。\n\n## 参考\n\n- [Sidecarless eBPF service mesh sparks debate](https:\/\/www.techtarget.com\/searchitoperations\/news\/365535362\/Sidecarless-eBPF-service-mesh-sparks-debate)\n\n- [eBPF or not: Sidecars are the future of the service mesh](https:\/\/thenewstack.io\/ebpf-or-not-sidecars-are-the-future-of-the-service-mesh\/)\n\n- [eBPF Service Mesh](https:\/\/isovalent.com\/blog\/post\/2021-12-08-ebpf-servicemesh\/)\n\n- [Linux kernel utility could solve Kubernetes networking woes](https:\/\/www.techtarget.com\/searchitoperations\/news\/252483517\/Linux-kernel-utility-could-solve-Kubernetes-networking-woes)\n\n- [Service Mesh Security](https:\/\/isovalent.com\/blog\/post\/2022-05-03-servicemesh-security\/)\n\n- [Istio 1.23 drops the sidecars for a simpler ambient mesh](https:\/\/thenewstack.io\/istio-1-23-drops-the-sidecars-for-a-simpler-ambient-mesh)\n\n- [Ambient Mesh: What you need to know about this experimental new deployment model for Istio](https:\/\/tetrate.io\/blog\/ambient-mesh-what-you-need-to-know-about-this-experimental-new-deployment-model-for-istio\/)\n\n- [Sidecarless service mesh: fad or the future?](https:\/\/www.techtarget.com\/searchitoperations\/news\/252526651\/Sidecarless-service-mesh-fad-or-the-future)\n', '\/blog\/service-mesh-sidecar-vs-sidecarless-debate\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探讨服务网格架构中 sidecar 与 sidecarless 的争论，比较 Cilium、Istio 和 Linkerd 在安全性、性能和架构复杂性方面的不同观点，帮助读者理解这些技术专家的看法和背后的争议。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/hong-kong-trip/">香港——内地的一面的镜子</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/06</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e6%97%85%e8%a1%8c"> 
             旅行
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('香港——内地的一面的镜子', '上个月，因为参加 KubeCon China，我第一次前往香港，这让我有机会近距离审视这颗“东方明珠”。', '\n上个月，因为参加 KubeCon China，我第一次前往香港，这让我有机会近距离审视这颗“东方明珠”。\n\n![从尖沙咀眺望香港岛](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/jianshazui.webp)\n\n我不记得之前在哪里看到一个说法，说是“香港是中国内地的一面镜子”。香港因其特殊的历史背景、经济发展轨迹以及在回归后的一系列表现等，许多人都在分析研究过程中会将香港的发展情况、社会治理经验教训等与内地进行关联和比较，认为其在某些方面可以为内地提供参考借鉴，就如同镜子一样反映出一些现象和问题的不同侧面及解决路径的可能性等。比如一些研究区域发展和社会治理的专家学者在相关论述中可能就会涉及到类似的观点表达。\n\n## 香港与内地的不同\n\n香港与内地存在着诸多不同，这些不同不光是表面上的：\n\n| 维度         | 香港                                        | 内地                                          |\n|--------------|---------------------------------------------|-----------------------------------------------|\n| 政治制度     | 资本主义制度，行政长官是特别行政区首长。     | 社会主义制度，人民代表大会制度。               |\n| 法律体系     | 英美法系，判例法重要。                       | 大陆法系，以成文法为主。                       |\n| 经济体制     | 自由市场经济，服务业和金融为主。              | 社会主义市场经济，公有制为主体，多种所有制发展。|\n| 文化方面     | 中西文化交融，保留大量中华传统文化。           | 以中华文化为主，地域文化多样。                 |\n| 教育体系     | 推行“三三四”学制，多语言教学，注重素质教育。    | 国家指导，地方负责，应试教育为主，统一教材。    |\n| 医疗体系     | 公立私立并存，谨慎用药，社区医院为主。          | 医疗体系多元，大医院资源紧张，用药依据病情。    |\n| 税收制度     | 地域来源征税，税种少，税率低。                 | 居民身份征税，税种多，税负较高。               |\n| 养老保障     | 强积金制度，雇主和雇员共同供款。               | 职工和居民基本养老保险，缴费比例不同。         |\n| 语言使用     | 粤语为主，英语广泛使用。                      | 普通话为主，各地方言众多。                     |\n| 文字形式     | 使用繁体中文。                                | 使用简体中文。                                 |\n| 生活习惯     | 饮食清淡，煲汤文化，部分西方生活习惯。           | 饮食丰富多样，生活习惯因地域文化不同。          |\n| 消费观念     | 消费多元化，注重品质，高端品牌接受度高。          | 消费观念多样化，与经济水平有关。               |\n| 交通规则     | 靠左行驶，驾驶位在右侧。                      | 靠右行驶，驾驶位在左侧。                       |\n| 住房情况     | 土地少，房价高，公屋制度完善。                  | 住房类型多样，房价差异大。                     |\n| 电影分级     | 有明确的电影分级制度。                         | 无明确电影分级，审查严格。                     |\n| 新闻出版审查   | 新闻出版较自由，但有监管。                     | 严格的新闻出版审查制度。                       |\n| 网络开放度     | 互联网相对开放，全球大多数网站可访问。           | 互联网监管严格，部分国外网站被屏蔽。            |\n| 护照含金量     | 可免签或落地签前往约 170 个国家和地区。             | 可免签或落地签前往约 80 个国家和地区。           |\n| 计量单位使用   | 使用英制和公制单位。                          | 主要使用公制单位。                             |\n| 电压和插座类型 | 220V，英式三插（G 型）。                      | 220V，双孔和三孔插座（A 型、I 型）。              |\n| 手机支付普及度 | 现金和信用卡普及，八达通卡使用广泛。             | 手机支付非常普及，微信支付和支付宝常用。         |\n| 购物和零售模式 | 国际品牌与本地品牌并存，夜市和街边小店常见。       | 大型购物中心、超市、夜市、电商平台多样。         |\n| 社交习惯       | 英语使用普遍，西方社交礼仪。                   | 普通话为主，传统社交礼仪。                     |\n| 宗教信仰       | 多元宗教环境，宗教自由。                       | 宗教信仰有限制，信仰自由受法律保护。            |\n| 食品安全标准   | 食品进口和监控严格，国际标准。                 | 标准逐渐完善，偶有问题。                       |\n| 工作时间和假期 | 每周 44 小时，公共假期多。                       | 每周 40 小时，法定节假日较少。                    |\n\n## 香港拥挤的交通\n\n香港岛是香港最繁华的地方，面积约 78.10 平方公里，这里集中了大量的商业、办公和住宅区域，吸引了众多人口和车辆，交通压力较大。在香港岛上，有一种极具特色的交通工具——叮当车，它也被称为有轨电车。叮当车全部分布在港岛北部狭长的地带，共有 6 条线路，全都经过港岛繁华热闹的地区，如铜锣湾、跑马地、中环等。它的车身通常为双层，造型古朴，当司机踩到踏脚时，车子会发出“叮当、叮当”的声响，故而得名。\n\n![香港岛上的叮当车](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/dingdingche.webp)\n\n在香港旺角的街头，人群如潮水般涌动。这里是繁华都市的缩影，喧嚣与热闹交织成一幅独特的画卷。摩肩接踵的人们，怀揣着各自的梦想与故事，在这个充满活力的地方穿梭。时尚的店铺、美味的小吃、璀璨的灯光，共同构成了旺角的魅力。每一个匆忙的脚步，每一张洋溢着笑容的脸庞，都在诉说着这座城市的无限可能。旺角，一个让人感受香港脉搏跳动的地方，永远充满着生机与活力。\n\n![旺角的夜晚街景](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/wangjiao.webp)\n\n香港岛地形以山地为主，地势较高，自北向南地势渐缓，环岛沿岸曲折，多美景港湾。岛上的主要山峰包括太平山、柏架山、奇力山等，其中太平山是香港岛的最高峰，海拔 554 米。\n\n兰桂坊位于香港岛中西区中环，是一个聚集大小酒吧与餐馆的中高档消费区。它由德己立街、威灵顿街、云咸街、和安里、仁寿里及荣华里构成，宽约 20 米，长约 300 米。20 世纪中期，香港经济腾飞，商业高速发展，夜总会文化开始在香港流行，很多在香港工作或暂居的外国人渴求适合他们品味和要求的娱乐场所，兰桂坊便应运而生。每当夜幕降临，这里便会灯红酒绿，觥筹交错，置身这里让我仿佛置身东南亚，感觉跟泰国很像。\n\n![兰桂坊周边的街道夜景](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/languifang.jpg)\n\n## 本地特色\n\n我在香港 City walk 的时候发现的一些本地特色。\n\n我发现很多建筑使用竹子搭建的脚手架，现在竹子脚手架在大城市中很少见到了。\n\n![堆放在地上的竹子](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/zhuzi.webp)\n\n![使用竹子搭建的脚手架](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/jiaoshoujia.webp)\n\n我还在庙街看到算命一条街，还有一家店代客烧香。\n\n![算命一条街](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/suanming.webp)\n\n![代客拜先人](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/baozhi.webp)\n\n最后本地的粤菜真的很好吃，我吃了一道炸猪排，外焦里嫩，口水直流。\n\n![炸猪排](https:\/\/jimmysong.io\/img\/blog\/hong-kong-trip\/zhazhupai.jpg)\n\n## 总结\n\n在香港的这次旅行中，我不仅领略了这座城市的繁华与多样性，还感受到了它作为一面“镜子”所带来的思考。香港的独特之处在于它东西方文化的交融、现代与传统的结合，以及其与内地在政治、经济、文化等方面的显著差异。无论是乘坐叮当车穿行在港岛繁华的街道，还是漫步在兰桂坊体验夜生活的丰富多彩，亦或是在街头巷尾发现本地的特色文化，这一切都让我更加理解为什么有人说香港是中国内地的一面镜子。通过这面镜子，我们可以看到一个不同的视角，这不仅让我们更好地理解香港，也能反思内地的许多方面，为未来的社会和经济发展提供更多的借鉴和启示。\n', '\/blog\/hong-kong-trip\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">上个月，因为参加 KubeCon China，我第一次前往香港，这让我有机会近距离审视这颗“东方明珠”。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     
     
     
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/blog/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/blog/page/2/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/blog/page/27/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(73)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(24)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-tracing/">Envoy 代理如何处理用户请求以实现追踪</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/black-myth-wukong-review/">《黑神话：悟空》一周目评测：瑕不掩瑜，期待更丰富内容</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/macao-trip/">澳门 City Walk：感受精致濠江</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
