<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>博客 · Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="专注开源技术、云原生与生活随笔的分享与思考。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.129.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.595949bd12db88434115e2a1e70965cf2928cc646e73acc6437c4cbbc323f585.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/" />
  <meta property="og:title" content="博客 | Jimmy Song" />
  <meta property="twitter:title" content="博客 | Jimmy Song" />

  
  <meta property="og:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />
  <meta property="twitter:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    博客
                </p>
                <p class="page-description">
                    专注开源技术、云原生与生活随笔的分享与思考。
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/ambient-mesh-can-sidecar-less-istio-make-applications-faster/">[译] Istio Ambient 模式：无 Sidecar Istio 如何让应用更快？</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/09/05</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://thenewstack.io/ambient-mesh-can-sidecar-less-istio-make-applications-faster/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式：无 Sidecar Istio 如何让应用更快？', '探索如何使用 Fortio 与 Istio 集成，在使用 Bookinfo 应用和流行的 DevOps 工具如 Kubernetes、Prometheus 和 Grafana 的微服务架构中进行高效的性能测试和监控。', '\nAmbient 模式是 2022 年在 [Istio](https:\/\/thenewstack.io\/simplifying-cluster-connectivity-with-istio-service-mesh\/) 中引入的新型无 sidecar 数据平面。当今年 5 月 [Ambient 模式](https:\/\/thenewstack.io\/ambient-mesh-sidestepping-the-sidecar\/) 达到 [Beta](https:\/\/istio.io\/latest\/blog\/2024\/ambient-reaches-beta\/) 阶段时，我观察到用户开始试用并运行负载测试，以理解将应用添加到网格后的性能影响。\n\n受到 [Quentin Joly 的博客](https:\/\/a-cup-of.coffee\/blog\/istio\/#with-istio-ambient) 关于 Istio 在 Ambient 模式下的惊人性能的启发，以及来自社区其他用户有时应用在 [Ambient 模式](https:\/\/thenewstack.io\/istio-1-23-drops-the-sidecars-for-a-simpler-ambient-mesh\/) 下稍快的反馈，我决定自己验证这些结果。\n\n## 测试环境\n\n我使用了一个拥有 256GB RAM 和每个节点 32 核 CPU 的三节点 Kubernetes 集群。\n\n![](f1.webp)\n\nIstio 使用了一些工具来简化一致性的基准测试。首先，我们使用一个叫做 [Fortio](https:\/\/github.com\/fortio\/fortio) 的负载测试工具，它以指定的每秒请求数 (RPS) 运行，记录执行时间的直方图并计算百分位数，例如 P99，即 99% 的请求在此时间内完成。\n\n我们还提供了一个叫做 [Bookinfo](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/) 的示例应用，其中包括用 Python、Java、Node.js 和 Ruby 编写的微服务。\n\n每个 Bookinfo 部署都有两个副本，这些副本均匀分布在三个工作节点上。使用 [pod anti-affinity rule](https:\/\/kubernetes.io\/docs\/concepts\/scheduling-eviction\/assign-pod-node\/#affinity-and-anti-affinity)，我确保 Fortio 被放置在与 [details](https:\/\/github.com\/istio\/istio\/tree\/master\/samples\/bookinfo\/src\/details) 服务不同的节点上。\n\n## 初始测试结果\n\n我从 Istio v1.22.3 版本安装了 Bookinfo 应用。使用 Fortio 工具对单个 Bookinfo 服务（例如 details）或完整的 Bookinfo 应用进行负载驱动，我注意到在将所有服务添加到 ambient 网格后，延迟影响 **接近零**。大多数时间它们的增加范围在 0-5% 之间，用于平均值或 P90。我一致注意到 Istio 的 details 服务在 ambient 模式下稍微快一点，就像 Quentin 在他的博客中报告的那样。\n\n### 对 Details 服务进行负载测试\n\n我进行了与 Quentin 相同的测试，通过 10 个连接发送 100 RPS 到 details 服务，并收集了无网格和 ambient 的结果。\n\n![无网格：details 服务 100 RPS。](f2.webp)\n\n![Ambient：details 服务 100 RPS。](f3.webp)\n\n就像 Quentin 一样，我不得不进行多次测试以验证 ambient 模式比无网格模式略有性能提升——这很难让人相信！对于 Bookinfo 的 details 服务来说，加入 ambient 模式平均降低了 6-11% 的延迟——以及添加了 mTLS 和 L4 观测！\n\n| **Fortio 对 details** | **平均** | **P50** | **P75** | **P90** | **P99** | **差异**                  |\n| --------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------- |\n| **无网格运行 1**      | 0.89ms   | 0.64ms  | 0.74ms  | 0.85ms  | 2.67ms  | **平均慢 11%，P90 慢 5%** |\n| **Ambient 运行 1**    | 0.80ms   | 0.6ms   | 0.71ms  | 0.81ms  | 1.4ms   |                           |\n| **无网格运行 2**      | 0.86ms   | 0.65ms  | 0.75ms  | 0.86ms  | 1.71ms  | **平均慢 6%，P90 慢 4%**  |\n| **Ambient 运行 2**    | 0.81ms   | 0.61ms  | 0.72ms  | 0.83ms  | 1.56ms  |                           |\n| **无网格运行 3**      | 0.90ms   | 0.65ms  | 0.76ms  | 0.88ms  | 1.92ms  | **平均慢 10%，P90 慢 5%** |\n| **Ambient 运行 3**    | 0.82ms   | 0.63ms  | 0.72ms  | 0.84ms  | 1.5ms   |                           |\n\n*表 1: Fortio 对 details 服务 100 RPS 10 连接。*\n\n## 为什么应用有时在 Ambient Mesh 中更快？\n\n我们被教导说服务网格会增加延迟。Quentin 的结果，这里复制的结果，展示了一个工作负载在通过服务网格运行时*更快*的案例。这是怎么回事？\n\n### 第一种理论\n\n当您的应用位于 ambient 模式 中时，负载请求首先通过一个轻量级的本地节点代理叫做 [ztunnel](https:\/\/istio.io\/latest\/docs\/ambient\/overview\/#ztunnel)，然后传送到目的地 ztunnel，再向服务传送。details 服务使用带有 Webrick 库的 HTTP\/1.1，我们已经看到旧的或配置不良的 HTTP 库中存在连接管理和保持活动状态的行为不佳。我的第一个假设是，当客户端和服务器位于不同节点时，通过客户端和服务器 ztunnels 代理实际上可能更快，如果应用没有使用高效的 HTTP\/2 连接的话。Ztunnel 使用连接池和 [HTTP Connect](https:\/\/en.wikipedia.org\/wiki\/HTTP_tunnel) 建立节点之间的安全通道，以在负载下利用并行性和 HTTP\/2 流多路复用。\n\n![](f4.webp)\n\n然而，这个理论有一些挑战。为什么我只在 details 服务上一致观察到这个，而不是任何其他 Bookinfo 服务？\n\n进一步研究，我发现我们的 Fortio 负载工具默认启用了[连接保持活动](https:\/\/github.com\/fortio\/fortio\/blob\/8a7d9112667e637139c788b68cb063f456d20cb4\/bincommon\/commonflags.go#L55)。使用 10 个来自 Fortio 的连接到 details 服务和 details 服务（使用 WEBrick Ruby 库）尊重连接保持活动设置，连接可以有效地被重用，无需 ambient。\n\n### 用 Connection Close 进行负载测试\n\n接下来，我探索了使用设置 \u0060Connection: close\u0060 标头的同样负载测试。这强制禁用任何 HTTP 连接池，这是测试这个假设的好方法。\n\n\u0060\u0060\u0060bash\ncurl -v -d \u0027{\u0022metadata\u0022: {\u0022url\u0022:\u0022http:\/\/details:9080\/details\/0\u0022, \u0022c\u0022:\u002210\u0022, \u0022qps\u0022: \u0022100\u0022, \u0022n\u0022: \u00222000\u0022, \u0022async\u0022:\u0022on\u0022, \u0022save\u0022:\u0022on\u0022}}\u0027 \u0022localhost:8081\/fortio\/rest\/run?jsonPath=.metadata\u0022 -H \u0022Connection: close\u0022\n\u0060\u0060\u0060\n\n![无网格：details 服务 100 RPS 10 连接带有 connection close。](f5.webp)\n\n![Ambient：details 服务 100 RPS 10 连接带有 connection close。](f6.webp)\n\n| **Fortio 对** **details** | **平均** | **P50** | **P75** | **P90** | **P99** | **差异**                 |\n| ------------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------ |\n| **无网格**                | 1.90ms   | 1.72ms  | 2.28ms  | 2.77ms  | 3.98ms  |                          |\n| **Ambient**               | 2.06ms   | 2.15ms  | 2.65ms  | 2.94ms  | 4ms     | **平均慢 8%，P90 慢 6%** |\n\n*表 2: Fortio 对 details 服务 100 RPS 10 连接带有 connection close。*\n\n与表 1 的结果相比，表 2 的响应时间明显更高，这是预期的，因为每个连接在 details 服务响应后立即关闭。考虑到 P50、P75、P90 和 P99 都从带有 connection close 的 ambient 运行中变慢，似乎可以安全排除第一理论中的 ztunnel 连接池可能使请求更快。\n\n### 第二种理论\n\n我注意到在我们新的 Istio v1.23 版本中的 details 和 productpage 服务中有一个与性能相关的 [PR](https:\/\/github.com\/istio\/istio\/pull\/51428\/files)。对于 details 服务，PR 为 details WEBrick 服务器启用了 [TCP_NODELAY](https:\/\/brooker.co.za\/blog\/2024\/05\/09\/nagle.html) 标志，这将减少来自 details 服务响应时间的不必要延迟（高达 [40ms](https:\/\/vorner.github.io\/2020\/11\/06\/40-ms-bug.html)）。对于 productpage 服务，PR 在传入请求上启用了保持活动状态，这将重用现有的传入连接，从而提高性能。\n\n包含修复的新更新的 details 部署中，我重复了通过 10 个连接发送 100 RPS 到 details 服务的相同测试。无网格和 ambient 的结果非常接近，所以我进行了三次测试以确保结果的一致性。下面是每个场景的第一次运行的截图：\n\n![无网格：新 details 服务 100 RPS 10 连接。](f7.webp)\n\n![Ambient：新 details 服务 100 RPS 10 连接。](f8.webp)\n\n我为每个场景的三次运行建立了一个表格：\n\n![](t1.webp)\n\n*表 3: Fortio 对新 details 服务 100 RPS 10 连接。*\n\n与表 1 的先前结果相比，表 3 的无网格数字有了相当大的改进（在更高百分比下更显著地超过 ambient 数字），现在接近于 ambient 数字。Ztunnel 默认启用了 [TCP_NODELAY](https:\/\/github.com\/istio\/ztunnel\/pulls?q=is%3Apr\u002bis%3Aclosed\u002bTCP_NODELAY)，这有助于 ambient 性能在表 1 中超过无网格，当旧的 details 服务没有启用 TCP_NODELAY 时。当新的 details 服务启用了 TCP_NODELAY 时，它也稍微提高了 ambient 的响应时间。\n\n表 3 还显示，在此类型的负载测试中，无网格和 ambient 运行之间的平均、P50、P75 和 P90 几乎没有差异。这些运行之间的差异可能只是噪音，除了 P99，无网格始终比 ambient 慢 8% 或更多。\n\n### 第三种理论\n\n继续审查表 3 的测试结果，为什么在有额外跳转到 ztunnel pod 和 ambient 提供的如 mTLS 和 L4 观测等显著优势时，无网格和 ambient 之间的延迟相似？对于 P99 情况，为什么 details 服务在 ambient 模式下始终更快？\n\nZtunnel 提供了出色的读写缓冲管理，并通过 HTTP\/2 多路复用，可以有效地最小化或有时甚至消除通过客户端和服务器 ztunnel pod 的额外跳转所增加的开销。我决定通过在两个 Fortio 和 details 服务的 Kubernetes 工作节点上进入并附加 strace 来测量这一点，同时过滤掉无关的跟踪：\n\n\u0060\u0060\u0060bash\nstrace -fp {pid} -e trace=write,writev,read,recvfrom,sendto,readv\n\u0060\u0060\u0060\n\n无网格和 ambient 情况下的 details 服务的 strace 输出是相似的：\n\n\u0060\u0060\u0060\n…read(9, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 8192) = 118write(9, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 180) = 180write(9, \u0022{\u0022id\u0022:0,\u0022author\u0022:\u0022William Shakes\u0022..., 178) = 178write(2, \u0022192.168.239.19 - - [13\/Aug\/2024:\u0022..., 80) = 80…\n\u0060\u0060\u0060\n\n*输出 1: 无网格或 ambient —— 附加 strace 到 details 服务的 PID。*\n\n无网格和 ambient 情况下的 Fortio 服务的 strace 输出不同。在无网格情况下，我们看到 Fortio 执行了两次读取，一次用于 HTTP 头部，另一次用于正文。\n\n\u0060\u0060\u0060\n…read(13, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 4096) = 180read(13, \u0022{\u0022id\u0022:0,\u0022author\u0022:\u0022William Shakes\u0022..., 4096) = 178…write(19, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 118) = 118 …\n\u0060\u0060\u0060\n\n*输出 2: 无网格 —— 附加 strace 到 Fortio 的 PID。*\n\n在 ambient 情况下，我们始终只看到一个读取，用于同时获取头部和正文。\n\n\u0060\u0060\u0060\n…read(19, \u0022HTTP\/1.1 200 OK\\r\\nContent-Type: a\u0022..., 4096) = 358…write(19, \u0022GET \/details\/0 HTTP\/1.1\\r\\nHost: d\u0022..., 118) = 118…\n\u0060\u0060\u0060\n\n*输出 3: Ambient 模式 —— 附加 strace 到 Fortio 的 PID。*\n\n为什么会这样？这是有道理的，因为 write 调用完全基于应用行为，而这在这种情况下没有变化。Ambient 将这些多个应用写入合并为单个网络写入，并隐含地在对等端进行单个读取。\n\n在上述测试场景中，我观察到 Fortio 服务在启用 ambient 时系统调用总数减少了 60%。这非常**重要**，并解释了在 peak 时 Fortio pod 的延迟和 CPU 使用量减少约 25% 的大部分原因。系统调用的减少超过了 mTLS 和 ztunnel 的其他功能的成本。我预计这种模式在企业中会相当常见，因为一些 HTTP 库和应用在缓冲和刷新方面做得更好，而一些则不太好。这通常与应用的年龄和它们构建时使用的 SDK 相关。\n\n![无网格和 ambient 运行：details 服务 100 QPS 10 连接。](f9.webp)\n\n## 整个 Bookinfo 应用怎么样？\n\n在更新了 details 和 productpage 部署之后，我开始通过 100 个连接发送 1000 RPS 到 Bookinfo 应用，并观察到无网格和 ambient 的优异结果。\n\n![无网格：新 Bookinfo 应用 1000 RPS 100 连接。](f10.webp)\n\n![无网格：新 Bookinfo 应用 1000 RPS 100 连接。](f11.webp)\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异**               |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | -------------------------- |\n| **无网格**             | 1.39ms   | 1.32ms  | 1.42ms  | 1.67ms  | 2.19ms  |                            |\n| **Ambient**            | 1.40ms   | 1.34ms  | 1.48ms  | 1.68ms  | 2.94ms  | **平均和 P90 均慢不到 1%** |\n\n*表 4: Fortio 对新 Bookinfo 应用 1000 RPS 100 连接。*\n\n作为对比，我还针对 v1.22.3 版本中附带的旧 Bookinfo 示例进行了同样的测试，你可以看到新 Bookinfo 在响应时间上取得了 **5-10 倍** 的提升，无论是无网格还是 ambient！\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异** |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | ------------ |\n| **无网格**             | 6.35ms   | 4.68ms  | 7.44ms  | 11.4ms  | 36.63ms |              |\n| **Ambient**            | 6.74ms   | 4.9ms   | 7.79ms  | 12.12ms | 41.14ms | **慢 6%**    |\n\n*表 5: Fortio 对旧 Bookinfo 应用 1000 RPS 100 连接。*\n\n将负载增加到 4000 RPS 和 400 连接，并使用新 Bookinfo 部署：\n\n![Ambient：新 Bookinfo 应用 4000 RPS 400 连接。](f12.webp)\n\n![Ambient：新 Bookinfo 应用 4000 RPS 400 连接。](f13.webp)\n\n响应时间依然很好，远远优于只有 1000 RPS 和 100 连接的旧 Bookinfo 应用（表 5）：\n\n| **Fortio 对 Bookinfo** | **平均** | **P50** | **P75** | **P90** | **P99** | **平均差异**             |\n| ---------------------- | -------- | ------- | ------- | ------- | ------- | ------------------------ |\n| **无网格**             | 1.54ms   | 1.33ms  | 1.54ms  | 2.25ms  | 3.98ms  |                          |\n| **Ambient**            | 1.58ms   | 1.37ms  | 1.57ms  | 2.33ms  | 4.9ms   | **平均慢 3%，P90 慢 4%** |\n\n*表 6: Fortio 对新 Bookinfo 应用 4000 RPS 400 连接。*\n\n很高兴看到 Bookinfo 能够在 4000 RPS 下无错误地运行，而且 ambient 模式比无网格慢 3-4%，但带来了传输中加密的 mTLS 和 L4 观测的所有好处。我记得我之前只能在旧 Bookinfo 应用中达到最高 1200 RPS，这已经导致了少量的错误。现在我可以增加到 4000 或更高 RPS 而不出现错误。\n\n## 总结\n\n在 L4 上，Ambient 模式只引入了非常微小的影响——偶尔甚至可以自动**改善**！— 用户应用的延迟。结合简单的用户体验，通过标记命名空间以将您的应用注册到 ambient 而无需重启任何工作负载，它为用户提供了我们初衷中预期的愉快体验。\n\n我想感谢所有 Istio 维护者，他们构建了这样一个令人愉快的项目，以及为 Istio 项目提供测试基础设施的 [CNCF](https:\/\/www.cncf.io\/community-infrastructure-lab\/)。我还要感谢 Quentin Joly 和许多提供了“ambient 有时比无网格稍快”的反馈的用户，这促使我进行了上述基准测试，亲身体验了在负载下的改善或微小的延迟影响。\n', '\/trans\/ambient-mesh-can-sidecar-less-istio-make-applications-faster\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索如何使用 Fortio 与 Istio 集成，在使用 Bookinfo 应用和流行的 DevOps 工具如 Kubernetes、Prometheus 和 Grafana 的微服务架构中进行高效的性能测试和监控。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/kubecon-china-2024-recap/">KubeCon China 2024 回顾：引领云原生技术的前沿动态</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f"> 
             云原生
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('KubeCon China 2024 回顾：引领云原生技术的前沿动态', '深入剖析 KubeCon China 2024 中的云原生技术进展，聚焦 Istio 的 Ambient 模式和 API 网关的融合及其对行业的深远影响。', '\n今年的[KubeCon China](https:\/\/events.linuxfoundation.org\/kubecon-cloudnativecon-open-source-summit-ai-dev-china\/)是首次在香港举办的盛会，持续了三天。作为会议的参与者及一个论坛的主持人，我在这篇文章中将分享会议的精彩内容和对服务网格及网关技术的深入讨论。\n\n![KubeCon China 现场画面](https:\/\/jimmysong.io\/img\/blog\/kubecon-china-2024-recap\/kubecon-china-2024-hall.webp)\n\n## 主题焦点\n\n本次 KubeCon 新增了 AI 与开发者主题，以下是部分重点内容：\n\n1. **云原生技术在行业中的实际应用**：特别是电动汽车和网络安全领域，如 Huawei 和 NIO 的共同探讨云原生技术如何加速电动汽车创新。\n\n2. **Kubernetes 社区的力量**：详细讨论了中国 Kubernetes 社区的影响力及其在推动区域云原生活动中的角色。\n\n3. **开源技术与人工智能的融合**：探讨了中国及香港在开源与 AI 技术领域的先进地位及对区域技术创新的推动。\n\n4. **服务网格与 API 网关的最新进展**：包括服务网格的最新技术更新及其与 Kubernetes 调度器的协同工作提高系统吞吐量的策略。\n\n5. **供应链安全的新策略**：关注保障供应链安全的最新动态，特别是 SLSA 合规性的实践指南。\n\n6. **多集群管理与边缘计算**：探讨了在不同架构下进行有效管理与创新的策略。\n\n7. **AI 大模型的推理性能优化**：讨论了无服务器架构下的 AI 大模型推理性能优化及相关技术进展。\n\n## Istio 与现代 API 网关：探索服务网格的未来\n\n我与来自 Tetrate、阿里云和 Kong Inc.的行业领袖共同参与的[圆桌讨论](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYY6\/istio-and-modern-api-gateways-navigating-the-future-of-service-meshes-istiorejiong-apijie-daepqiu-jie-zha-jimmy-song-jianpeng-he-tetrate-jiaqi-zhang-alibaba-cloud-jintao-zhang-kong-inc-xunzhuo-liu-tencent)，深入探讨了 Istio 和 API 网关的最新进展及其融合带来的革新。\n\n![KubeCon China 2024 Istio 和现代 API 网关的圆桌论坛](https:\/\/jimmysong.io\/img\/blog\/kubecon-china-2024-recap\/kubecon-china-2024-panel.webp)\n\n1. **Istio 的革新**：介绍了 Istio 1.123 版本中的 Ambient 模式优化，此模式作为新的架构选择，减少资源消耗同时提升性能。\n\n2. **Ambient 模式与 Sidecar 模式的实用对比**：\n   - **何时选择 Sidecar**：需要高度隔离与详尽流量管理时。\n   - **何时选择 Ambient**：追求极致性能与资源效率时。\n\n3. **Ambient 模式的发展挑战**：尽管有诸多优势，Ambient 模式在复杂流量管理与多租户环境中仍面临挑战。\n\n4. **服务网格优化策略**：讨论了服务网格的优化方法，如何提升云应用的性能与效率。\n\n5. **服务网格与 API 网关的整合**：展示了这两大技术如何共同作用，支持更复杂的部署与运维模式。\n\n## Istio 的未来展望\n\n在[徐中虎和何建鹏的分享](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYcG\/what-is-the-future-of-service-mesh-sidecar-or-sidecarless-jie-zha-dyagsyi-wu-pi-yi-wu-zhonghu-xu-huawei)中，我们了解到了 Istio 未来的可能发展方向：\n\n- **双模驱动**：Istio 将同时支持 Ambient 模式和传统的 Sidecar 模式。Ambient 模式适合追求性能和资源成本优化的用户，而 Sidecar 模式将为需要更全面功能的用户长期支持。\n\n- **Gateway API 的支持**：Istio 对 Gateway API 的支持，为用户提供了更灵活的路由与策略配置选项。\n\n- **Waypoints 的策略应用**：Waypoints 不必局限于 Istio 或 Envoy。通过使用 Gateway API 和 GAMMA，任何符合标准的实现都可以作为 Waypoint，这为服务网格提供了更大的灵活性和扩展性。\n\n### Sandwich Waypoint\n\n他们着重介绍了 Sandwich Waypoint，这是一种在 Istio 内管理和引导流量的复杂方法，特别是在环境模式下。这种 Waypoint 代理模式旨在通过充当处理、转换和转发客户端和服务器之间流量的中介层来简化和提高流量路由的效率。它利用了双 zTunnel 设置，其中位于通信通道两端的每个 zTunnel 协作封装和解码流量。Waypoint 本身负责执行额外的功能，如流量整形、安全检查和协议转换，从而在没有传统边车开销的情况下丰富服务网格功能。这种方法允许 Istio 保持强大的流量管理和安全功能，同时优化资源利用率并减少延迟。\n\nSandwich Waypoint 支持：\n\n- **流量重定向**：可通过设置  \u0060istio.io\/use-waypoint: {namespace}\/{gateway-name}\u0060 注解，将目标服务、Pod 或命名空间内的流量重定向到同一个 Waypoint。\n- **Waypoint 部署**：用户可以通过创建一个 Gateway 对象来部署 Waypoint。与原始的 Waypoint 实现不同，新的部署方式将包括相关联的服务和服务账户，不仅仅是 Waypoint 实例。\n- **路由与政策配置**：使用 Gateway API 进行路由和政策配置，这为用户和供应商提供了更多的自定义选项。\n\n这是一种 Istio Ambient 模式中捕获七层流量模式，如下图所示。\n\n![Sandwich Waypoint 捕获流量](istio-ambient-traffic-capture.svg)\n\nIstio Sandwich Waypoint 捕获七层流量的步骤如下：\n\n1. 通过 zTunnel 终止 HBONE 连接，到达 Waypoint，zTunnel 负责解码 HBONE 协议。 \n2. Waypoint 提取目的地地址、源地址等信息用于处理流量及确定转发位置。 \n3. Waypoint 扩展或解析传输层封装（TLV）数据，代理支持处理 TLV 以提供更多上下文。\n4. Waypoint 与同位 zTunnel 通信，与服务端 zTunnel 协调确保流量正确转移。\n5. 封装 HBONE，由服务端 zTunnel 发送到最终服务器目的地。实现 Istio 环境中服务的细粒度流量管理和路由并保持与现有网络协议兼容性。\n\n## Envoy Gateway 的前沿扩展\n\n赵化冰在 KubeCon 上介绍了 Envoy Gateway 如何通过扩展 Kubernetes Gateway API 来增强功能与灵活性的[演讲](https:\/\/kccncossaidevchn2024.sched.com\/event\/1eYcX\/gateway-api-and-beyond-introducing-envoy-gateways-gateway-api-extensions-jie-api-daeptao-envoyjie-zha-jie-api-huabing-zhao-tetrate)，涵盖了多种匹配与路由能力的扩展、新的资源和策略模型以及安全策略的细节。\n\n- **网关 API 兼容性**：Envoy 网关完全兼容网关 API，并提供了广泛的匹配和路由选项。这些包括 HTTP 主机和路径匹配、基于 HTTP 头的操作、权重负载均衡，以及对 gRPC、UDP 和 TCP 路由的支持。\n- **高级流量管理策略**：引入的 \u0060ClientTrafficPolicy\u0060 和 \u0060BackendTrafficPolicy\u0060 为用户提供了更细粒度的流量管理控制，适用于上游和下游连接，包括如限速、重试、负载均衡、断路器等功能。\n- **安全与认证增强**：新引入的 \u0060SecurityPolicy\u0060 支持 CORS、HTTP 基础认证、OIDC、JWT 认证，并能与各种身份提供商集成。它还提供了详细的访问控制，允许根据请求者的原始 IP、JWT 声明等进行授权。\n- **自定义扩展功能**：Envoy 网关支持通过 WASM（WebAssembly）和外部进程扩展来支持自定义扩展。这允许用户通过集成他们自己为特定用例和操作需求量身定制的扩展来增强网关的功能。\n- **未来探索**：未来版本预计将支持非 Kubernetes 环境部署，优化控制平面的内存使用，并扩展授权能力。\n\n## 总结\n\n通过本次会议我们了解了 Istio 的 Ambient 模式和 Envoy Gateway 的进展。这些技术的讨论不仅展望了未来趋势，也提供了实用的洞察，助力技术实施与创新。\n', '\/blog\/kubecon-china-2024-recap\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入剖析 KubeCon China 2024 中的云原生技术进展，聚焦 Istio 的 Ambient 模式和 API 网关的融合及其对行业的深远影响。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/integrating-dapr-with-cilium/">[译] 使用 Dapr 与 Cilium 打造无 Sidecar 服务网格</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/service-mesh"> 
             Service Mesh
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://www.codecentric.de/wissens-hub/blog/integrating-dapr-with-cilium-a-sidecar-less-service-mesh-approach-combined-with-a-powerful-distributed-application-runtime" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('使用 Dapr 与 Cilium 打造无 Sidecar 服务网格：新一代分布式应用运行时', '本文探讨了将 Dapr 与 Cilium 集成的无 Sidecar 服务网格方法，强调了其高性能和安全性。', '\n几周前，我们介绍了 Dapr，并讨论了它与服务网格的重叠功能，尽管 Dapr 本身并不是一个服务网格。如之前的博客所述，近年来服务网格已成为现代云原生应用的关键组成部分，提供了诸如流量管理、安全性和可观测性等关键功能。传统的服务网格依赖于 sidecar 代理，这可能会引入复杂性和性能开销。而 Cilium 的无 sidecar 服务网格功能通过利用 eBPF 实现高效的内核级网络处理，结合 Dapr 这一强大的分布式应用运行时，这种集成承诺提供高性能、增强的安全性和简化的操作。\n\n## 无 Sidecar 服务网格的需求\n\n正如[这篇文章](https:\/\/www.codecentric.de\/wissens-hub\/blog\/sidecars-sidecarless-evolution-service-mesh-technologies-istio-cilium)所讨论的，Cilium 最初作为 Kubernetes 的一种 eBPF 驱动的容器网络接口（CNI）开始。随着时间的推移，Cilium 演变成了 Kubernetes 内部网络的多功能工具。2022 年 7 月，Cilium 服务网格的首个版本发布，引入了一种利用 eBPF 并在 Linux 内核中运行的无 sidecar 服务网格。\n\n![基于 Cilium 的服务网格](cilium-mesh.webp)\n\n这种服务网格旨在广泛利用 eBPF，专注于较低层次的网络（直到第 4 层）以提供其功能。然而，对于一个功能齐全的服务网格，较高层次的功能如服务调用依赖于第 7 层。通常，这些功能需要一个代理来实现重试和断路等功能。\n\n考虑到 Dapr 及其第 7 层功能，它传统上运行在基于 sidecar 的模型上。虽然这是准确的，但有一个与无 sidecar 架构相一致的替代方法。\n\n## 介绍 Dapr 共享\n\n[Dapr 共享](https:\/\/github.com\/dapr\/dapr-shared\/)提供了 Dapr 的另一种部署模型。虽然默认的方法仍然使用 sidecars，但 Dapr 共享允许用户轻松地将 Dapr 运行时（Daprd）部署为 Kubernetes 内的 DaemonSet（每个节点一个）或 Deployment（每个集群一个）。这种方法的显著优势在于，它在一定程度上将 Daprd 实例的生命周期与实际应用的生命周期解耦。你可能会问：这有什么好处？有几种情况下，这种方法是有利的：\n\n- 函数即服务（FaaS）集成：在 FaaS 中，实际函数的一个实例可能只在执行期间存在几秒钟。然而，你可能仍然希望使用 PubSub 进行异步消息传递。\n- 无 Sidecar 服务网格集成：当主要使用 Dapr 的构建模块时，类似于 FaaS 的示例，将 Daprd 的生命周期与其应用解耦是有益的。通过控制 Daprd 实例（\u0022代理\u0022）的数量，这种方法与无 sidecar 服务网格很好地集成。\n\n通过在这些情况下使用 Dapr 共享，我们仍然可以利用所有构建块和高级功能，如 mTLS 与服务调用结合使用。\n\n## 我们的示例案例和架构\n\n理论介绍完毕，现在是时候进行实践了。我们将设置一个简单而强大的架构，以演示 Dapr 和 Cilium 服务网格如何协同工作。\n\n![架构图](arch.webp)\n\n在这个设置中，我们将采用前沿技术。Cilium 将处理一般的网络层，并使用其 Gateway API 实现来管理流入我们演示集群的南北流量。对于东西流量，我们将利用 Cilium GAMMA 实现，通过 Dapr 共享运行时进行增强，以确保全面的集成。\n\n通过整合这些技术，我们将能够为我们的设置添加弹性和其他高级功能。这种架构将展示 Dapr 和 Cilium 之间的无缝协作，为 Kubernetes 环境提供强大而可扩展的网络解决方案。\n\n### 要求\n\n如果你想跟进，你将需要访问一个 Kubernetes 集群。这个集群应该安装了 Cilium 版本 1.16，配置如下：\n\n- 替换 Kube-proxy 或 NodePort 服务\n- 启用 GatewayAPI\n- 可访问的 Hubble 和 Hubble UI\n\n你可以按照[官方文档](https:\/\/docs.cilium.io\/en\/stable\/gettingstarted\/k8s-install-default\/)安装 Cilium。\n\n### 设置 Gateway API 和网关\n\n如前所述，我们将使用 GatewayAPI 来路由流量进入我们的集群。这可以通过定义一个 Gateway 资源轻松实现，如下所示：\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.networking.k8s.io\/v1\nkind: Gateway\nmetadata:\n  name: default-gateway\n  namespace: default\nspec:\n  gatewayClassName: cilium\n  listeners:\n  - allowedRoutes:\n      namespaces:\n        from: All\n    name: default-http\n    port: 80\n    protocol: HTTP\n\u0060\u0060\u0060\n\n有了这个资源并正确安装 Cilium，你可以运行以下命令来验证 Gateway 是否已成功编程并具有外部 IP：\n\n\u0060\u0060\u0060bash\nkubectl get gateway default-gateway\n\u0060\u0060\u0060\n\n这应该输出类似于：\n\n\u0060\u0060\u0060\nNAME              CLASS    ADDRESS          PROGRAMMED   AGE\ndefault-gateway   cilium   18.192.114.200   True         27h\n\u0060\u0060\u0060\n\n现在我们已经设置好了 Gateway，我们可以继续运行一个虚拟应用。\n\n### 虚拟应用和简单路由\n\n为了测试我们的设置，我们将部署由 Traefik Labs 创建的 whoami 镜像。这个应用显示 HTTP 请求头和其他相关信息，这对于验证我们的配置非常有用。让我们开始部署并使虚拟应用可访问。\n\n为 whoami 应用创建一个服务、部署和 HTTPRoute：\n\n\u0060\u0060\u0060yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: whoami\n  labels:\n    app: whoami\nspec:\n  ports:\n    - name: http\n      targetPort: 80\n      port: 80\n  selector:\n    app: whoami\n---\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: whoami-v1\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: whoami\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: whoami\n        version: v1\n    spec:\n      serviceAccountName: whoami\n      containers:\n        - image: traefik\/whoami\n          imagePullPolicy: IfNotPresent\n          name: whoami\n          ports:\n            - containerPort: 80\n          env:\n            - name: WHOAMI_NAME\n              value: \u0022v1\u0022\n---\napiVersion: gateway.networking.k8s.io\/v1\nkind: HTTPRoute\nmetadata:\n  name: whoami-route-service\nspec:\n  parentRefs:\n  - group: \u0022\u0022\n    kind: Service\n    name: whoami\n  rules:\n  - matches:\n    - path:\n        type: PathPrefix\n        value: \/\n    backendRefs:\n    - name: whoami\n      port: 80\n\u0060\u0060\u0060\n\n部署这些资源后，你可以使用一个简单的 curl 命令来验证设置：\n\n\u0060\u0060\u0060\ncurl -v http:\/\/18.192.114.200\n\u0060\u0060\u0060\n\n预期输出应类似于：\n\n\u0060\u0060\u0060\n*   Trying 18.192.114.200:80...\n* Connected to 18.192.114.200 (18.192.114.200) port 80\n\u003e GET \/ HTTP\/1.1\n\u003e Host: 18.192.114.200\n\u003e User-Agent: curl\/8.4.0\n\u003e Accept: *\/*\n\u003e\n\u003c HTTP\/1.1 200 OK\n\u003c date: Tue, 30 Jul 2024 14:16:41 GMT\n\u003c content-length: 350\n\u003c content-type: text\/plain; charset=utf-8\n\u003c x-envoy-upstream-service-time: 6\n\u003c server: envoy\n\u003c\nName: v1\nHostname: whoami-v1-cd9b4bdf7-ht6dc\nIP: 127.0.0.1\nIP: ::1\nIP: 10.42.0.101\nIP: fe80::e0d3:4fff:fe30:95ef\nRemoteAddr: 10.42.1.170:35911\nGET \/ HTTP\/1.1\nHost: 18.192.114.200\nUser-Agent: curl\/8.4.0\nAccept: *\/*\nX-Envoy-Internal: true\nX-Forwarded-For: 10.42.1.82\nX-Forwarded-Proto: http\nX-Request-Id: bc928d69-06e2-427b-89f1-fab7c8bfb7e9\n\n* Connection #0 to host 18.192.114.200 left intact\n\u0060\u0060\u0060\n\n这确认了 whoami 应用是可访问的，且 GatewayAPI 正确路由流量进入我们的集群。\n\n### 安装 Dapr 运行时\n\n接下来，我们需要在我们的 Kubernetes 集群中安装 Dapr 运行时。这可以通过使用现有的 Helm chart 快速完成。执行以下命令安装 Dapr：\n\n\u0060\u0060\u0060bash\nhelm upgrade --install dapr dapr\/dapr \\\n--version=1.13 \\\n--namespace dapr-system \\\n--create-namespace \\\n--wait\n\u0060\u0060\u0060\n\n成功安装的输出看起来像这样：\n\n\u0060\u0060\u0060\nRelease \u0022dapr\u0022 has been upgraded. Happy Helming!\nNAME: dapr\nLAST DEPLOYED: Tue Jul 30 16:09:45 2024\nNAMESPACE: dapr-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nThank you for installing Dapr: High-performance, lightweight serverless runtime for cloud and edge\n\nYour release is named dapr.\n\nTo get started with Dapr, we recommend using our quickstarts:\nhttps:\/\/github.com\/dapr\/quickstarts\n\nFor more information on running Dapr, visit:\nhttps:\/\/dapr.io\n\u0060\u0060\u0060\n\n要验证所有 Dapr 组件是否正确运行，检查 dapr-system 命名空间中的 pods：\n\n\u0060\u0060\u0060bash\nkubectl get pods -n dapr-system\n\u0060\u0060\u0060\n\n典型的输出应显示所有 Dapr 组件处于运行状态：\n\n\u0060\u0060\u0060\nNAME                                    READY   STATUS    RESTARTS   AGE\ndapr-operator-c449df54-px8q2            1\/1     Running   0          25h\ndapr-placement-server-0                 1\/1     Running   0          25h\ndapr-sentry-774c876df5-h2nhh            1\/1     Running   0          25h\ndapr-sidecar-injector-78769c6d9-zh2jw   1\/1     Running   0          25h\n\u0060\u0060\u0060\n\nDapr 成功安装并且所有组件健康后，我们可以继续安装我们的共享实例。\n\n### 部署 Dapr 共享实例\n\n现在，让我们设置我们的 Dapr 共享实例。我们需要部署两个实例：一个用于入口（Cilium Gateway）和一个用于虚拟的 whoami 应用。入口实例将作为 DaemonSet 部署，而 whoami 实例将作为 Deployment 部署。\n\n\u0060\u0060\u0060bash\nhelm upgrade --install ingress-shared oci:\/\/registry-1.docker.io\/daprio\/dapr-shared-chart --set shared.appId=ingress --set shared.strategy=daemonset --set shared.remoteURL=cilium-gateway-default-gateway.default.svc.cluster.local --set shared.remotePort=80 --set shared.daprd.mtls.enabled=true --namespace default\n\nhelm upgrade --install whoami-shared  oci:\/\/registry-1.docker.io\/daprio\/dapr-shared-chart --set shared.appId=whoami --set shared.strategy=deployment --set shared.remoteURL=whoami.default.svc.cluster.local --set shared.remotePort=80 --set shared.daprd.mtls.enabled=true --namespace default\n\u0060\u0060\u0060\n\n执行这些命令后，你可以使用以下命令验证 Dapr 共享实例是否正在正确运行：\n\n\u0060\u0060\u0060bash\nkubectl get pods\n\u0060\u0060\u0060\n\n你应该看到类似于这样的输出：\n\n\u0060\u0060\u0060\nNAME                                               READY   STATUS    RESTARTS   AGE\ningress-shared-dapr-shared-chart-bfnxc             1\/1     Running   0          29s\ningress-shared-dapr-shared-chart-lg62n             1\/1     Running   0          21s\nwhoami-shared-dapr-shared-chart-69fd8658db-kmzph   1\/1     Running   0          26s\n\u0060\u0060\u0060\n\n有了这些共享实例的运行，我们已经成功建立了一个强大的设置来处理应用流量和服务调用。\n\n### Daprise 操作\n\n现在来到了有趣的部分：\u0022Dapr 化\u0022我们的设置！我们将 Dapr 与 Cilium Gateway 和 whoami 应用整合，充分利用 Dapr 的功能。为了确保所有请求都通过专门的网关的 Dapr 共享实例流动，我们将配置 HTTPRoute 以针对这个 Dapr 实例。Dapr 期望特定的 URL 格式用于服务调用，因此我们将使用 Gateway API 中的 URLRewrite 过滤器来调整请求路径。\n\n使用以下配置更新之前的 HTTPRoute 资源：\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.networking.k8s.io\/v1\nkind: HTTPRoute\nmetadata:\n  name: whoami-route\nspec:\n  parentRefs:\n  - name: default-gateway\n  rules:\n  - matches:\n    - path:\n        type: PathPrefix\n        value: \/\n    filters:\n    - type: URLRewrite\n      urlRewrite:\n        path: \n          type: ReplacePrefixMatch\n          replacePrefixMatch: \/v1.0\/invoke\/whoami.default\/method\/\/\n    backendRefs:\n    - name: ingress-dapr\n      port: 3500\n\u0060\u0060\u0060\n\n我们是如何\u0022Dapr 化\u0022它的？\n\n- filters: URLRewrite 过滤器重写 URL 以匹配 Dapr 的服务调用格式。（是的，\/\/是正确的）\n- backendRefs: 指向处理网关请求的 ingress-dapr 实例。\n\n为了验证一切是否正常工作，对网关的外部 IP 执行 curl 请求：\n\n\u0060\u0060\u0060bash\ncurl -v http:\/\/18.192.114.200\n\u0060\u0060\u0060\n\n你应该看到类似于这样的输出：\n\n\u0060\u0060\u0060\n*   Trying 18.192.114.200:80...\n* Connected to 18.192.114.200 (18.192.114.200) port 80\n\u003e GET \/ HTTP\/1.1\n\u003e Host: 18.192.114.200\n\u003e User-Agent: curl\/8.4.0\n\u003e Accept: *\/*\n\u003e\n\u003c HTTP\/1.1 200 OK\n\u003c content-length: 719\n\u003c content-type: text\/plain; charset=utf-8\n\u003c date: Tue, 30 Jul 2024 14:38:18 GMT\n\u003c traceparent: 00-00000000000000000000000000000000-0000000000000000-00\n\u003c x-envoy-upstream-service-time: 18\n\u003c server: envoy\n\u003c\nName: v1\nHostname: whoami-v1-cd9b4bdf7-4tmvr\nIP: 127.0.0.1\nIP: ::1\nIP: 10.42.1.30\nIP: fe80::7f:66ff:fe14:15ad\nRemoteAddr: 10.42.0.60:55178\nGET \/ HTTP\/1.1\nHost: whoami.default.svc.cluster.local:80\nUser-Agent: curl\/8.4.0\nAccept: *\/*\nAccept-Encoding: gzip\nDapr-Callee-App-Id: whoami\nDapr-Caller-App-Id: ingress\nForwarded: for=10.42.0.131;by=10.42\n\n.0.131;host=ingress-shared-dapr-shared-chart-bfnxc\nTraceparent: 00-00000000000000000000000000000000-0000000000000000-00\nX-Envoy-Internal: true\nX-Envoy-Original-Path: \/\nX-Forwarded-For: 10.42.1.110\nX-Forwarded-For: 10.42.0.131\nX-Forwarded-Host: ingress-shared-dapr-shared-chart-bfnxc\nX-Forwarded-Proto: http\nX-Request-Id: 5556df41-f78f-4c98-9526-f5025a787a1e\n\n* Connection #0 to host 18.192.114.200 left intact\n\u0060\u0060\u0060\n\n从头文件中，你可以看到\u0060Dapr-Callee-App-Id\u0060和\u0060Dapr-Caller-App-Id\u0060，表明流量正确通过 Dapr 实例路由。这个设置确保连接默认通过 mTLS（传输）加密，为我们的通信增加了额外的安全层。我们已经成功地将 Dapr 与 Cilium 的服务网格整合在一起，利用其先进的功能增强了应用的网络和服务调用。\n\n### 实现流量转移使用 Gamma\n\nDapr 不提供的一个功能，但 Cilium 提供的是流量转移。幸运的是，通过我们的集成，我们可以利用 Cilium 的 GAMMA（服务网格的 Gateway API）来启用这个功能。GAMMA 扩展了 Gateway API 以支持集群内的东西向流量管理，补充其用于南北向流量的用途。要设置流量转移，我们需要创建一个 HTTPRoute 配置，以便在应用的不同版本之间进行负载平衡。通过利用 GAMMA，你可以在不同版本的应用之间转移流量，使得部署新功能或进行金丝雀发布更容易，最小化中断。首先，我们将部署 whoami 应用的新版本并为其创建额外的服务。以下是部署 whoami 版本 2 并设置必要服务的 YAML 配置：\n\n\u0060\u0060\u0060yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: whoami-v1\n  labels:\n    app: whoami\n    version: v1\nspec:\n  ports:\n    - name: http\n      targetPort: 80\n      port: 80\n  selector:\n    app: whoami\n    version: v1\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: whoami-v2\n  labels:\n    app: whoami\n    version: v2\nspec:\n  ports:\n    - name: http\n      targetPort: 80\n      port: 80\n  selector:\n    app: whoami\n    version: v2\n---\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: whoami-v2\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: whoami\n      version: v2\n  template:\n    metadata:\n      labels:\n        app: whoami\n        version: v2\n    spec:\n      serviceAccountName: whoami\n      containers:\n        - image: traefik\/whoami\n          imagePullPolicy: IfNotPresent\n          name: whoami\n          ports:\n            - containerPort: 80\n          env:\n            - name: WHOAMI_NAME\n              value: \u0022v2\u0022\n\u0060\u0060\u0060\n\n接下来，我们配置一个 HTTPRoute 来启用在 whoami-v1 和 whoami-v2 之间的流量转移。HTTPRoute 将根据定义的权重将一定比例的流量路由到每个应用版本。\n\n\u0060\u0060\u0060yaml\napiVersion: gateway.networking.k8s.io\/v1\nkind: HTTPRoute\nmetadata:\n  name: whoami-route-service\nspec:\n  parentRefs:\n  - group: \u0022\u0022\n    kind: Service\n    name: whoami\n  rules:\n  - matches:\n    - path:\n        type: PathPrefix\n        value: \/\n    backendRefs:\n    - name: whoami-v1\n      port: 80\n      weight: 50\n    - name: whoami-v2\n      port: 80\n      weight: 50\n\u0060\u0060\u0060\n\n这里重要的部分是\u0060parentRefs\u0060。虽然在传统的 Gateway API 中，我们使用这个来绑定该 \u0060HTTPRoute\u0060 到一个网关，我们在这里将其绑定到\u0060whoami\u0060服务，启用 GAMMA 案例。\n\n此外，通过在\u0060backendRef\u0060中定义\u0060weight\u0060，我们可以调整我们希望如何转移流量。为了确保流量转移工作正确，你可以进行多次 curl 请求并检查响应，以验证流量是否按照指定在 whoami-v1 和 whoami-v2 之间分配。\n\n\u0060\u0060\u0060\ncurl http:\/\/18.192.114.200\nName: v1\nHostname: whoami-v1-cd9b4bdf7-4tmvr\nIP: 127.0.0.1\nIP: ::1\nIP: 10.42.1.30\nIP: fe80::7f:66ff:fe14:15ad\nRemoteAddr: 10.42.0.60:55178\nGET \/ HTTP\/1.1\nHost: whoami.default.svc.cluster.local:80\nUser-Agent: curl\/8.4.0\nAccept: *\/*\nAccept-Encoding: gzip\nDapr-Callee-App-Id: whoami\nDapr-Caller-App-Id: ingress\nForwarded: for=10.42.0.131;by=10.42.0.131;host=ingress-shared-dapr-shared-chart-bfnxc\nTraceparent: 00-00000000000000000000000000000000-0000000000000000-00\nX-Envoy-Internal: true\nX-Envoy-Original-Path: \/\nX-Forwarded-For: 10.42.1.110\nX-Forwarded-For: 10.42.0.131\nX-Forwarded-Host: ingress-shared-dapr-shared-chart-bfnxc\nX-Forwarded-Proto: http\nX-Request-Id: e9d8ab85-8ae7-46a9-8b44-42240d1d6833\n---\ncurl http:\/\/18.192.114.200\nName: v2\nHostname: whoami-v2-766bb5fbd5-bfx9j\nIP: 127.0.0.1\nIP: ::1\nIP: 10.42.1.181\nIP: fe80::d441:87ff:fea1:d123\nRemoteAddr: 10.42.1.27:32774\nGET \/ HTTP\/1.1\nHost: whoami.default.svc.cluster.local:80\nUser-Agent: curl\/8.4.0\nAccept: *\/*\nAccept-Encoding: gzip\nDapr-Callee-App-Id: whoami\nDapr-Caller-App-Id: ingress\nForwarded: for=10.42.0.131;by=10.42.0.131;host=ingress-shared-dapr-shared-chart-bfnxc\nTraceparent: 00-00000000000000000000000000000000-0000000000000000-00\nX-Envoy-Internal: true\nX-Envoy-Original-Path: \/\nX-Forwarded-For: 10.42.1.64\nX-Forwarded-For: 10.42.0.131\nX-Forwarded-Host: ingress-shared-dapr-shared-chart-bfnxc\nX-Forwarded-Proto: http\nX-Request-Id: f1df7207-098c-4a98-8a97-858ce1f9c0ed\n\u0060\u0060\u0060\n\n你应该会看到基于配置的流量权重，从两个应用版本收到响应。此外，我们可以查阅\u0060hubble flow\u0060日志来检查实际连接情况：\n\n\u0060\u0060\u0060\nJul 29 15:18:13.883: kube-system\/svclb-cilium-gateway-default-gateway-f455e04d-jljl8:54047 (ingress) -\u003e default\/ingress-shared-dapr-shared-chart-g2596:3500 (ID:33809) http-request FORWARDED (HTTP\/1.1 GET http:\/\/whoami.cloud-native.rocks\/v1.0\/invoke\/whoami.default\/method\/something)\nJul 29 15:18:13.884: 10.42.1.170:39105 (ingress) \u003c\u003e default\/ingress-shared-dapr-shared-chart-g2596:3500 (ID:33809) to-overlay FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:13.884: 10.42.1.170:39105 (ingress)\n\n -\u003e default\/ingress-shared-dapr-shared-chart-g2596:3500 (ID:33809) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:13.890: default\/ingress-shared-dapr-shared-chart-g2596:55194 (ID:33809) -\u003e default\/whoami-shared-dapr-shared-chart-crmxz:50002 (ID:14274) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:13.890: default\/ingress-shared-dapr-shared-chart-g2596:55194 (ID:33809) \u003c- default\/whoami-shared-dapr-shared-chart-crmxz:50002 (ID:14274) to-endpoint FORWARDED (TCP Flags: ACK)\nJul 29 15:18:13.891: default\/whoami-shared-dapr-shared-chart-crmxz:46028 (ID:14274) -\u003e default\/whoami-v1-cd9b4bdf7-gxkvt:80 (ID:26920) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:13.891: default\/whoami-shared-dapr-shared-chart-crmxz:46028 (ID:14274) \u003c- default\/whoami-v1-cd9b4bdf7-gxkvt:80 (ID:26920) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:13.893: 10.42.1.170:39105 (ingress) \u003c\u003e default\/ingress-shared-dapr-shared-chart-g2596:3500 (ID:33809) to-overlay FORWARDED (TCP Flags: ACK)\nJul 29 15:18:13.895: kube-system\/svclb-cilium-gateway-default-gateway-f455e04d-jljl8:54047 (ingress) \u003c- default\/ingress-shared-dapr-shared-chart-g2596:3500 (ID:33809) http-response FORWARDED (HTTP\/1.1 200 15ms (GET http:\/\/whoami.cloud-native.rocks\/v1.0\/invoke\/whoami.default\/method\/something))\nJul 29 15:18:14.405: kube-system\/svclb-cilium-gateway-default-gateway-f455e04d-jljl8:54048 (ingress) -\u003e default\/ingress-shared-dapr-shared-chart-zxv74:3500 (ID:33809) http-request FORWARDED (HTTP\/1.1 GET http:\/\/whoami.cloud-native.rocks\/v1.0\/invoke\/whoami.default\/method\/something)\nJul 29 15:18:14.406: 10.42.1.170:38391 (ingress) -\u003e default\/ingress-shared-dapr-shared-chart-zxv74:3500 (ID:33809) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:14.414: default\/ingress-shared-dapr-shared-chart-zxv74:55876 (ID:33809) -\u003e default\/whoami-shared-dapr-shared-chart-g572c:50002 (ID:14274) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:14.414: default\/whoami-shared-dapr-shared-chart-g572c:58854 (ID:14274) -\u003e default\/whoami-v2-766bb5fbd5-jvtcd:80 (ID:2184) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:14.414: default\/ingress-shared-dapr-shared-chart-zxv74:55876 (ID:33809) \u003c- default\/whoami-shared-dapr-shared-chart-g572c:50002 (ID:14274) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\nJul 29 15:18:14.415: default\/whoami-shared-dapr-shared-chart-g572c:58854 (ID:14274) \u003c- default\/whoami-v2-766bb5fbd5-jvtcd:80 (ID:2184) to-endpoint FORWARDED (TCP Flags: ACK, PSH)\n\u0060\u0060\u0060\n\n这个日志显示，流量被重定向到\u0060whoami-v1\u0060以及\u0060whoami-v2\u0060。在 hubble UI 中，这也是可见的。\n\n![流量拓扑图](topo.webp)\n\n## 使用网络策略进行访问控制\n\n有了 Cilium 处理到 Dapr 的流量，我们可以利用 Cilium 的网络策略来配置访问控制。与 Dapr 的访问控制在第 7 层（应用层）操作不同，Cilium 的方法在更低的网络堆栈层次上工作，提供更细粒度的控制。\n\n下面是如何使用 Cilium 的 CiliumNetworkPolicy 配置访问控制：\n\n\u0060\u0060\u0060yaml\napiVersion: cilium.io\/v2\nkind: CiliumNetworkPolicy\nmetadata:\n  name: \u0022allow-ingress-shared-to-whoami\u0022\nspec:\n  endpointSelector:\n    matchLabels:\n      dapr.io\/app-id: whoami\n  ingress:\n  - fromEndpoints:\n    - matchLabels:\n         dapr.io\/app-id: ingress\n    toPorts:\n    - ports:\n      - port: \u002250002\u0022\n        protocol: TCP\n---\napiVersion: \u0022cilium.io\/v2\u0022\nkind: CiliumNetworkPolicy\nmetadata:\n  name: \u0022allow-ingress-to-ingress-shared\u0022\nspec:\n  endpointSelector:\n    matchLabels:\n      dapr.io\/app-id: ingress\n  ingress:\n  - fromEntities:\n    - ingress\n    toPorts:\n    - ports:\n      - port: \u00223500\u0022\n        protocol: TCP\n\u0060\u0060\u0060\n\n这两个策略将限制我们集群中的流量流向。它们确保只允许 cilium-gateway 连接到 ingress-dapr 实例。类似地，ingress-dapr 实例是唯一允许与 whoami-dapr 实例通信的实体。这个设置确保 Dapr 共享实例是彼此唯一的通信者，增强了安全性和控制。Cilium 在第 3 层和第 4 层应用网络策略，提供了在流量到达应用层之前的更细粒度控制。这通过在网络堆栈的早期阻止未经授权的访问来减少不必要的流量，并通过提升性能来增强性能。\n\n## 优势 1 - 本地重定向策略\n\nCilium 1.16 引入了一个名为 Local Redirect Policy 的 beta 功能。这个功能允许你将流量重定向到同一节点上的本地端点，而不是在整个集群中路由。这对于优化流量流和确保某些连接保持本地特别有用。\n\n\u0060\u0060\u0060yaml\napiVersion: \u0022cilium.io\/v2\u0022\nkind: CiliumLocalRedirectPolicy\nmetadata:\n  name: \u0022redirect-ingress\u0022\nspec:\n  redirectFrontend:\n    serviceMatcher:\n      serviceName: ingress-dapr\n      namespace: default\n  redirectBackend:\n    localEndpointSelector:\n      matchLabels:\n        dapr.io\/app-id: ingress\n    toPorts:\n      - port: \u00223500\u0022\n        protocol: TCP\n\u0060\u0060\u0060\n\n我们将使用这个策略确保从\u0060cilium-gateway\u0060到其 Dapr 共享实例的流量保持在节点上。这种方法将连接保持在同一节点上，确保在流量离开节点之前建立并维持 mTLS。请注意，由于这是一个 beta 功能，你需要在 Cilium 中启用它。有关启用此功能的指南，请参阅 Cilium 文档。\n\n## 优势 2 - mTLS 和强身份\n\n将 Cilium 整合到你的设置中的另一个优势是使用 Cilium 的 mTLS 功能，而不是 Dapr 的。Cilium 通过节点间的 Wireguard 或 IPSec 隧道提供 mTLS，与 Dapr 通过双向 gRPC 连接使用 mTLS 的方法相比，提供了明显的好处。\n\n- 内核级执行：Cilium 的 mTLS 可以直接在 Linux 内核中执行，利用 Wireguard 或 IPSec。这种方法通常比 Dapr 通过 gRPC 的用户空间实现的 mTLS 提供更好的性能。\n- 广泛的加密覆盖：Cilium 确保所有服务到服务的连接都\n- 加密，而不仅仅是那些通过 Dapr 进行的。这提供了一个更全面的安全模型。\n\n一旦在 Cilium 本身启用了 mTLS，你可以通过将其附加到\u0060CiliumNetworkPolicy\u0060来在 Cilium 中强制执行 mTLS：\n\n  \u0060\u0060\u0060yaml\n  authentication:\n      mode: \u0022required\u0022\n  \u0060\u0060\u0060\n\nCilium 将检查匹配的强身份以及 mTLS 验证。\n\n## 总结\n\n总之，Dapr 与 Cilium 的无 sidecar 服务网格的整合为微服务架构打开了新的可能性。通过利用 Dapr 共享，我们可以将 Dapr 运行时的生命周期与应用解耦，允许更灵活的部署。Dapr 的强大服务调用能力与 Cilium 的高效、基于 eBPF 的网络和服务网格功能的结合，使得微服务交互具有高性能、安全性和弹性。\n\n这次演示展示了这些技术如何协调一致，创造了一个简化服务管理的前沿基础设施，同时增强了可扩展性和可靠性。Dapr 和 Cilium 的整合代表了构建下一代分布式应用的重要一步。\n', '\/trans\/integrating-dapr-with-cilium\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文探讨了将 Dapr 与 Cilium 集成的无 Sidecar 服务网格方法，强调了其高性能和安全性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/black-myth-wukong-game-life/">从黑神话悟空聊起：我心目中的 3A 大作</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/23</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e9%9a%8f%e7%ac%94"> 
             随笔
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('从黑神话悟空聊起：我心目中的 3A 大作', '在《黑神话：悟空》的璀璨光芒下，回顾我的游戏旅程，探讨何为我心目中的 3A 游戏巅峰之作。', '\n随着 8 月 20 日《黑神话：悟空》的正式发售，瞬间点燃了玩家们对 3A 游戏无尽的热情与讨论。在这篇随笔中，我将漫步于记忆的长廊，从孩提时代的掌中世界到今日的次世代主机，细数那些陪伴我的游戏时光，并深入探讨我心目中 3A 大作的独特魅力。\n\n## 我的游戏养成史\n\n在中国，游戏曾一度被视为教育的绊脚石，是家长眼中的洪水猛兽。然而，正是这些看似微不足道的游戏机，悄然开启了我探索未知世界的奇妙之旅。\n\n### 掌上游戏机\n\n在我十岁左右，我获得了一个第一台游戏机，一台类似 Gameboy 的掌上游戏机。\n\n![90 年代的掌上游戏机（图片来自网络，复古游戏机）](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/gameboy.webp)\n\n这是我最早接触的游戏机，还有我最早接触的游戏《俄罗斯方块》。\n\n### 游戏机厅\n\n也进过游戏机厅，小学时每年寒暑假前都要写保证书，名叫《暑\/寒假公约》，其中一定会有一条——“不去游戏机厅”。我只去过一两次，这些游戏机需要投币。\n\n![九十年代游戏机厅里的游戏机（图片来自网络）](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/game-machine.webp)\n\n这类游戏机上常玩的游戏是《街头霸王（Street Fighters）》。\n\n![FC 游戏：街头霸王](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/street-fighter.webp)\n\n### 小霸王学习机\n\n小霸王学习机，可以更换卡带，接上电视就能玩，那时候经常用它玩高桥名人的《冒险岛》。\n\n![小霸王学习机](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/xiaobawang.webp)\n\n虽然号称是学习机，但是我没有见过有谁用它来学习的。\n\n![FC 游戏：冒险岛](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/maoxiandao.webp)\n\n### 网吧\n\n世纪之交的时候，网吧开始兴起，2000 年的时候我才第一次接触电脑，暑期的时候还参加电脑培训，练习过五笔打字，那时候也没学会，光顾着玩游戏了，我记得那时候还使用的是 3.5 英寸软盘，操作系统还是 Windows 98，使用的是笨重的 CRT 显示器。\n\n![90 年代末 2000 年初的网吧（图片来自网络）](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/netbar.webp)\n\n2000 年左右，电脑上的游戏有《红色警戒》、《暴力摩托》、《三角洲部队》、《拳皇》，但是我最喜欢的还是《红色警戒 2》，从 2000 年一直到 2008 年。\n\n![红色警戒（红警 2）](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/red-alert.webp)\n\n最开始玩红警的时候年纪还小，是我自己一个人探索着玩，一开始做任务，甚至不知道怎样展开基地车，因为游戏是繁体字，很多我还看不懂。\n\n### 单机游戏：2000 - 2008\n\n除了红色警戒之外，我玩过的游戏还有《反恐精英》、《半条命》、《暗黑破坏神》、《仙剑奇侠传》、《魔兽争霸》，但这些游戏都不是我的菜，大多也玩不好，我还是钟情于红警，还有它的各种 mod。\n\n### 网络游戏：2005 - 2008\n\n在开始玩网络游戏之前，从来没有为玩游戏花过钱，因为中国的各种盗版游戏泛滥，网上到处都可以下载到。\n\n在此之后就是网游的时代了，什么《传奇》、《大话西游》，腾讯的各种游戏比如《泡泡堂》、《劲舞团》、《地下城与勇士》、《QQ 飞车》这些我都玩过。\n\n### 休闲游戏：2009 - 2013\n\n曾经有一段时间，大概 2008 到 2013 年，校友网、QQ 空间上诞生的网页游戏，比如《抢车位》、《开心农场》等火爆一时，很多人定闹钟偷菜，也诞生了一些做网页游戏的网站。\n\n还有一些流行的休闲游戏，比如《植物大战僵尸》也是我特别喜欢的一款游戏。跟它同时期的一些游戏也不错。\n\n### 手机游戏：2014 - 2023\n\n《开心消消乐》、《原神》、《辐射：避难所》。不过很多流行的手机游戏比如《绝地求生》、《穿越火线》我都没有玩过。\n\n### 主机游戏：2023 至今\n\n从 2009 年到 2023 年可以说我就没有再接触主机游戏和网游了，平时也很少玩游戏，直到 2023 年 12 月，我获得了我的第一台游戏主机 PS5，情况才发生了改变。\n\n在此之前我曾玩过朋友的任天堂主机，但是并不是很喜欢任天堂主机的游戏，画面质量，游戏类型都不是我喜爱的。\n\n但是从我接触的第一个 PS5 主机游戏《双人成行》开始，我对主机游戏甚至说对电子游戏的看法大大改观了。一起我对大部分游戏都提不起兴趣，感觉那些游戏就是打发打发时间，玩久了就很无聊，但是接下来的几款游戏让我体验到了什么是 3A 大作。\n\n## 3A 大作\n\n在拥有了 PS5 之后，玩什么游戏就是一个问题了。我订阅了二挡会员，所以起初我下载和玩了一些游戏库里的游戏。\n\n### 双人成行\n\n《双人成行》这是一个必须两个人配合才能完成的游戏，通过 PS5 的手柄来操控，终于让我体会到玩游戏的快感。这也是我第一次购买的实体游戏，我购买了游戏光盘。\n\n![双人成行](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/it-takes-two.webp)\n\n### 地平线：西之绝境\n\n《地平线：西之绝境》在 PlayStation 的二挡会员库里，所以我也下载和游玩了这款游戏。这款游戏以废土世界的旧金山为背景，里面有很多奇思妙想的未来机械生物。但是我对它的剧情和部落完全不感兴趣，只是享受其中打斗的乐趣，因为主角可以使用的武器和技能有很多。\n\n![地平线：西之绝境](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/horizontal.webp)\n\n### 对马岛之魂\n\n《对马岛之魂》，故事发生在古代日本的对马岛，虽然景色很美，但是打斗风格及剧情让我提不起兴趣，一个日本人反抗蒙古侵略者的故事，我只玩了几个小时就卸载了游戏。\n\n![对马岛之魂](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/ghost-of-tsushima.webp)\n\n### 蜘蛛侠：Miles Morales\n\n《蜘蛛侠：Miles Morales》，以纽约为背景，化身蜘蛛侠在纽约的城市上空飞来飞去，还有爽快的打斗，确实是一款很刺激的游戏，但是我对漫画人物为主角的游戏也不是特别喜欢，这款游戏的故事也比较简单，很快就通关了。\n\n![蜘蛛侠：Miles Morales](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/spiderman.webp)\n\n### 极地战嚎 6\n\n《极地战嚎 6》，是一个虚构的现代国家 Yara 为背景（实际上是映射古巴）的游击队反抗政府军的故事，这是育碧旗下的游戏，已经出到第六代，有点像罐头游戏，完成主线任务也很快，我喜欢里面的各种枪械和野路子武器，剧情能够发人深省。\n\n![极地战嚎 6](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/far-cry.webp)\n\n### 荒野大镖客 2\n\n《荒野大镖客 2》是以 19 世纪末的美国西部为背景，玩了不到 1 个小时，实在无法带入剧情，对这个的故事和背景也不感兴趣，索性不玩了。\n\n![荒野大镖客 2](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/red-dead-2.webp)\n\n### 艾尔登法环\n\n我玩过的最后一个 3A 大作是《艾尔登法环》，这是我第一次玩魂系游戏，其中的世界观，复杂的技能点加成，庞大的地图，开放世界都给我造成很大的困惑，尤其是强大的怪物，我一开始玩了几个小时，就死过无数次，被大树守卫很轻易就秒杀，甚至一个普通怪物三两下就把我干掉，我感觉玩这个游戏很痛苦，完全无法体会其中的乐趣，直到我了解可以购买卢恩，将角色升级到满级，然后玩这个游戏就可以轻松很多。\n\n![艾尔登法环](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/elden-ring.webp)\n\n不过这个游戏偶尔还是会让人感觉很不适，尤其是各种迷宫一样的墓地，阴暗的环境，下水道，恶心的怪物。但是面对那些强大的怪物，当时死亡无数次后将其打败，可以体会到其中的快感，以及游戏庞大的地图，琳琅满目的武器，是我坚持玩下去的动力。\n\n## 什么是我想要的 3A 游戏\n\n在《黑神话：悟空》诞生之前，并没有一个让我眼前一亮的 3A 大作，它的出现就像一颗闪耀的新星。下面我将谈谈什么是我心目中的 3A 大作。\n\n### 深入灵魂的叙事篇章\n\n我心目中的 3A 大作，首先必须拥有一段深入人心的故事。它应当如同一部宏大的史诗，让玩家在跌宕起伏的剧情中与角色同悲共喜，体验一段段难忘的旅程。《黑神话：悟空》以其独特的中国神话背景，正是我所期待的那一抹亮色。\n\n### 视觉与听觉的双重盛宴\n\n高质量的美术与音乐是 3A 大作的另一大亮点。精美的画面、逼真的场景、细腻的角色设计，以及动人心弦的背景音乐和音效，共同构建了一个令人向往的虚拟世界。《黑神话：悟空》的预告片已经展现出了其在这方面的非凡实力。\n\n### 流畅操作与无限玩法\n\n流畅的操作手感与丰富的游戏玩法是 3A 大作的基石。无论是战斗系统的爽快感、解谜机制的巧妙设计，还是探索元素的无限可能，都应让玩家在享受游戏的过程中感受到无尽的乐趣与挑战。《黑神话：悟空》作为动作冒险游戏，其在这方面的表现无疑值得期待。\n\n### 文化内涵的深度挖掘\n\n对于国内玩家而言，游戏中融入的文化内涵往往能引发更深的共鸣与认同。《黑神话：悟空》以中国神话为背景，不仅展现了丰富的传统文化元素，更通过游戏这一载体将中华文化的魅力传播至世界各地。\n\n### 持续的创新与支持\n\n一款优秀的 3A 大作不仅需要在发布时惊艳四座，更需要在后续的开发与运营中保持活力与创新。持续的更新与支持不仅能够为玩家带来新鲜感与惊喜，更是游戏生命力的体现。《黑神话：悟空》作为国产 3A 的佼佼者，其后续的更新与支持同样值得我们期待。\n\n## 结语\n\n《黑神话：悟空》的发布不仅是对国产游戏的一次重大突破，更是对全球游戏界的一次震撼宣言。它让我看到了国产 3A 大作的无限可能。\n\n![黑神话：悟空](https:\/\/jimmysong.io\/img\/blog\/black-myth-wukong-game-life\/black-myth.webp)\n\n今天我就购入了《黑神话：悟空》，在游玩一段时间后我会发布新的博客谈谈我的游玩体验。\n', '\/blog\/black-myth-wukong-game-life\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">在《黑神话：悟空》的璀璨光芒下，回顾我的游戏旅程，探讨何为我心目中的 3A 游戏巅峰之作。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-gateway-integration-istio-mesh/">集成 Envoy Gateway 作为 Istio 服务网格中的入口网关</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/13</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('集成 Envoy Gateway 作为 Istio 服务网格中的入口网关', '本文介绍了如何将 Envoy Gateway 作为 Istio 服务网格中的入口网关集成，增强应用的安全性和可访问性。', '\n[Istio](https:\/\/istio.io) 提供了对入口网关的强大而灵活的支持，利用 Envoy 代理在其 sidecar 模式下运行。尽管 Istio 专注于管理集群内服务之间的通信，[Envoy Gateway](https:\/\/gateway.envoyproxy.io) 旨在将应用程序暴露给外部世界，处理用户请求，并支持高级功能，如 OIDC 单点登录。通过结合 Istio 服务网格的功能和 Envoy Gateway 的高级网关功能，可以增强整体应用程序的可访问性和安全性。\n\n下图显示了 Istio 网格中入口网关的流量路径。\n\n![Istio 入口网关流量路径](https:\/\/jimmysong.io\/blog\/explore-tetrate-enterprise-gateway\/istio-ingress-sidecar.svg)\n\n下一个图表显示了在引入 Envoy Gateway 后，流量如何从 Istio 网格的边缘流入内部网络。\n\n![引入 Envoy Gateway 后的流量路径](https:\/\/jimmysong.io\/blog\/explore-tetrate-enterprise-gateway\/istio-teg-integration.svg)\n\n### 准备 Envoy Gateway 与 Istio 之间的互操作性\n\n要将 Envoy Gateway 用作 Istio 的入口网关，请考虑以下关键点：\n\n- 在 Istio 安装期间避免启用入口网关。我们将手动安装并配置 Envoy Gateway 作为入口网关。\n- 由于 Istio 和 Envoy Gateway 都使用 Envoy 作为代理，确保 Istio 将 Envoy sidecar 注入到 Envoy Gateway 的网关 Pod 中，以允许与 Istio 的数据平面安全通信。\n- 配置由 Envoy Gateway 创建的 Envoy 代理的路由类型为 \u0060Service\u0060 而不是 \u0060Endpoint\u0060，以确保正确路由。\n\n按照 [快速启动文档](https:\/\/gateway.envoyproxy.io\/docs\/tasks\/quickstart\/) 安装 Envoy Gateway。标记 Envoy Gateway 的命名空间以确保数据平面获得 Istio sidecar 注入：\n\n\u0060\u0060\u0060bash\nkubectl label namespace envoy-gateway-system --overwrite=true istio-injection=enabled\n\u0060\u0060\u0060\n\n配置 Envoy Gateway 的 sidecar 以不拦截进入网关的流量。注入的 sidecar 确保 Envoy Gateway 的组件及其创建的代理被包含在 Istio 网格中，并安装正确的证书以进行安全通信。\n\n{{\u003cinclude_code file=\u0022control-plane-tls.yaml\u0022\u003e}}\n\n应用补丁：\n\n\u0060\u0060\u0060bash\nkubectl patch service -n envoy-gateway-system envoy-gateway --type strategic --patch-file control-plane-tls.yaml\n\u0060\u0060\u0060\n\n配置 Envoy Gateway 不拦截入站流量：\n\n{{\u003cinclude_code file=\u0022teg-sidecars-no-inbound.yaml\u0022\u003e}}\n\n应用配置：\n\n\u0060\u0060\u0060bash\nkubectl apply -f teg-sidecars-no-inbound.yaml\n\u0060\u0060\u0060\n\n修改 GatewayClass 配置以将 sidecar 配置应用于 Envoy Gateway 数据平面中的所有 \u0060EnvoyProxy\u0060：\n\n{{\u003cinclude_code file=\u0022gtwcls-use-envoyproxy.yaml\u0022\u003e}}\n\n应用补丁：\n\n\u0060\u0060\u0060bash\nkubectl patch gatewayclass teg --patch-file gtwcls-use-envoyproxy.yaml --type merge\n\u0060\u0060\u0060\n\n### 安装 Istio\n\n使用 minimal 配置文件部署 Istio 以避免部署入口网关：\n\n\u0060\u0060\u0060bash\nistioctl install --set profile=minimal -y\n\u0060\u0060\u0060\n\n### 重启 Envoy Gateway 控制平面\n\n在 Istio 的 sidecar 注入准备好后，重启所有 Envoy Gateway 控制平面的 pod：\n\n\u0060\u0060\u0060bash\nfor d in envoy-gateway envoy-ratelimit teg-envoy-gateway teg-redis;\n\tdo kubectl rollout restart deployment -n envoy-gateway-system $d;\ndone\n\u0060\u0060\u0060\n\n### 部署测试应用程序\n\n在安装 Istio 后部署测试应用程序，以确保它们也接收到 sidecar 注入：\n\n\u0060\u0060\u0060bash\nkubectl create namespace httpbin\nkubectl label namespace httpbin --overwrite=true istio-injection=enabled\nkubectl apply -n httpbin -f https:\/\/raw.githubusercontent.com\/istio\/istio\/master\/samples\/httpbin\/httpbin.yaml\n\u0060\u0060\u0060\n\n### 配置 Envoy Gateway\n\n现在配置 Envoy Gateway 以处理边缘流量：\n\n{{\u003cinclude_code file=\u0022apps-gateway.yaml\u0022\u003e}}\n\n应用配置：\n\n\u0060\u0060\u0060bash\nkubectl apply -f apps-gateway.yaml\n\u0060\u0060\u0060\n\n部署应用网关，包括以下容器：\n\n- \u0060istio-init\u0060：由 Istio 注入以修改 pod iptables。\n- \u0060envoy\u0060：由 Envoy Gateway 控制，充当入口网关。\n- \u0060istio-proxy\u0060：由 Istio 注入，负责与内部集群 pod 的通信。\n- \u0060shutdown-manager\u0060：由 Envoy Gateway 控制，负责 pod 生命周期管理。\n\n创建一个 HTTP 路由：\n\n{{\u003cinclude_code file=\u0022httpbin-route.yaml\u0022\u003e}}\n\n应用路由配置：\n\n\u0060\u0060\u0060bash\nkubectl apply -f httpbin-route.yaml\n\u0060\u0060\u0060\n\n### 发送测试请求\n\n获取网关的负载平衡器 IP 地址并发送测试请求：\n\n\u0060\u0060\u0060bash\nexport GATEWAY_URL=$(kubectl get svc -n envoy-gateway-system -l gateway.envoyproxy.io\/owning-gateway-name=apps -o jsonpath=\u0027{.items[0].status.loadBalancer.ingress[0].ip}\u0027)\ncurl -v -H Host:www.example.com http:\/\/$GATEWAY_URL\/httpbin\/get\n\u0060\u0060\u0060\n\n你应该能看到来自 \u0060httpbin\u0060 服务的正确响应：\n\n\u0060\u0060\u0060\n*   Trying 34.41.0.90:80...\n* Connected to 34.41.0.90 (34.41.0.90) port 80\n\u003e GET \/httpbin\/get HTTP\/1.1\n\u003e Host:www.example.com\n\u003e User-Agent: curl\/8.7.1\n\u003e Accept: *\/*\n\u003e\n* Request completely sent off\n\u003c HTTP\/1.1 200 OK\n\u003c server: envoy\n\u003c date: Wed, 31 Jul 2024 08:21:58 GMT\n\u003c content-type: application\/json\n\u003c content-length: 282\n\u003c access-control-allow-origin: *\n\u003c access-control-allow-credentials: true\n\u003c x-envoy-upstream-service-time: 11\n\u003c\n{\n  \u0022args\u0022: {},\n  \u0022headers\u0022: {\n    \u0022Accept\u0022: \u0022*\/*\u0022,\n    \u0022Host\u0022: \u0022www.example.com\u0022,\n    \u0022User-Agent\u0022: \u0022curl\/8.7.1\u0022,\n    \u0022X-Envoy-Attempt-Count\u0022: \u00221\u0022,\n    \u0022X-Envoy-External-Address\u0022: \u0022123.120.227.173\u0022\n  },\n  \u0022origin\u0022: \u0022123.120.227.173\u0022,\n  \u0022url\u0022: \u0022http:\/\/www.example.com\/get\u0022\n}\n* Connection #0 to host 34.41.0.90 left intact\n\u0060\u0060\u0060\n\n### 启用严格 mTLS\n\n通过应用以下配置启用严格 mTLS：\n\n{{\u003cinclude_code file=\u0022strict-mtls.yaml\u0022\u003e}}\n\n应用配置：\n\n\u0060\u0060\u0060bash\nkubectl apply -f strict-mtls.yaml\n\u0060\u0060\u0060\n\n### 为网关启用 TLS\n\n创建服务签名的根证书和私钥：\n\n\u0060\u0060\u0060bash\nmkdir example_certs\nopenssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj \u0027\/O=example Inc.\/CN=example.com\u0027 -keyout example_certs\/example.com.key -out example_certs\/example.com.crt\n\u0060\u0060\u0060\n\n为 \u0060www.example.com\u0060 创建证书和私钥：\n\n\u0060\u0060\u0060bash\nopenssl req -out example_certs\/www.example.com.csr -newkey rsa:2048 -nodes -keyout example_certs\/www.example.com.key -subj \u0022\/CN=www.example.com\/O=www organization\u0022\nopenssl x509 -req -sha256 -days 365 -CA example_certs\/example.com.crt -CAkey example_certs\/example.com.key -set_serial 0 -in example_certs\/www.example.com.csr -out example_certs\/www.example.com.crt\n\u0060\u0060\u0060\n\n为入口网关创建一个密钥：\n\n\u0060\u0060\u0060bash\nkubectl create -n httpbin secret tls httpbin-credential --key=example_certs\/www.example.com.key --cert=example_certs\/www.example.com.crt\n\u0060\u0060\u0060\n\n配置入口网关：\n\n{{\u003cinclude_code file=\u0022tls-apps-gateway.yaml\u0022\u003e}}\n\n应用配置：\n\n\u0060\u0060\u0060bash\nkubectl apply -f tls-apps-gateway.yaml\n\u0060\u0060\u0060\n\n发送测试请求：\n\n\u0060\u0060\u0060bash\ncurl -v -H Host:www.example.com --resolve \u0022www.example.com:443:$GATEWAY_URL\u0022 --cacert example_certs\/example.com.crt \u0022https:\/\/www.example.com:443\/httpbin\/get\u0022\n\u0060\u0060\u0060\n\n你应该可以通过 HTTPS 在网格内访问 \u0060httpbin\u0060 服务。\n\n### 结论\n\n通过将 Envoy Gateway 集成为 Istio 服务网格中的入口网关，你可以利用两者的优势：Istio 的强大服务网格能力和 Envoy Gateway 的高级网关功能。这种设置增强了你的应用程序的安全性、可扩展性和灵活性，提供了无缝且安全的用户体验。通过仔细的配置和正确的工具，管理服务网格内外的流量变得更加高效和有效，确保你的应用程序始终可访问并且安全。\n', '\/blog\/envoy-gateway-integration-istio-mesh\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文介绍了如何将 Envoy Gateway 作为 Istio 服务网格中的入口网关集成，增强应用的安全性和可访问性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/cilium-native-authentication/">[译] 解密 Cilium 原生认证功能</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/08</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%ae%89%e5%85%a8"> 
             安全
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://blog.teknews.cloud/aks/security/network/2024/07/30/About_Cilium_native_authentication_feature.html" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('解密 Cilium 原生认证功能', '在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。', '\n我们已经讨论了 Cilium 一段时间了，但是这个话题有很多值得关注的地方，我们知道我们会再次回到这个话题。今天，我建议我们探索一个用于认证工作负载的功能。在讨论这个话题之前，我们需要一些定义。\n\n我们的议程将按照以下顺序进行：\n\n1. 了解 Cilium 认证功能\n2. 尝试认证功能\n\n## Cilium 认证功能\n\n### 为什么我们需要认证\n\n在基于微服务的架构中，安全是一个巨大的话题。在 Kubernetes 环境中，我们可以查看网络，并通过限制只允许必要端口和协议的流量来实施最小权限原则。在这种情况下，我们可以依赖网络策略。例如，这个策略拒绝 \u0060basic\u0060 命名空间中的所有入站流量：\n\n\u0060\u0060\u0060yaml\nkind: NetworkPolicy\napiVersion: networking.k8s.io\/v1\nmetadata:\n  name: default-deny-all\n  namespace: basics\nspec:\n  podSelector: {}\n  ingress: []\n\u0060\u0060\u0060\n\n这个策略仅允许标有 \u0060app=userprofile\u0060 标签的 pod 在端口 \u00608082\u0060 上从带有标签 \u0060tier=front\u0060 和 \u0060app=tripsinsights\u0060 的命名空间中的 pod 接收流量。\n\n\u0060\u0060\u0060yaml\napiVersion: networking.k8s.io\/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-tripviewer-ingress-apiprofile\n  namespace: api\nspec:\n  podSelector: \n    matchLabels:\n      app: userprofile\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - namespaceSelector:\n        matchLabels:\n          tier: front\n          app: tripinsights\n    ports:\n    - protocol: TCP\n      port: 8082   \n\u0060\u0060\u0060\n\n但这可能还不够，全局管理也相当困难，这是分布式安全的悖论。\n\n我们在之前的文章中谈到了服务网格，其目的是为网络流量提供一个集中的控制平面。我们还看到，在标准化的倡议中，我们有一些特定的流量控制对象，其中包括了认证功能。\n\n\u0060\u0060\u0060yaml\napiVersion: access.smi-spec.io\/v1alpha4\nkind: IdentityBinding\nmetadata:\n name: service-a\n namespace: default\nspec:\n schemes:\n   podLabelSelector:\n    matchLabels:\n      app: service-a\n   spiffeIdentities:\n     - \u0022cluster.local\/ns\/default\/sa\/service-a\u0022\n     - \u0022federated.trustdomain\/boundary\/boundaryName\/identifierType\/identifier\u0022\n   serviceAccount: service-a\n\u0060\u0060\u0060\n\n我们将在 Cilium 服务网格中，尤其是基于身份的安全性方面探讨这一点。在基础设施层拥有这样的功能是有趣的，因为应用层不总是能够包含认证功能，尤其是当我们考虑多服务时。最多，不幸的是，我们可能在前端获得认证，但不会更多。这里，我们提出了增加基于身份的安全性的建议。\n\n让我们看看它是如何工作的。\n\n### Cilium 认证功能的底层原理\n\n认证意味着，某种程度上，身份。正如之前在 smi 规范中暗示的，并在 [Cilium 文档](https:\/\/docs.cilium.io\/en\/stable\/network\/servicemesh\/mutual-authentication\/mutual-authentication\/#identity-management)中记录的，所使用的技术是 [SPIFFE](https:\/\/spiffe.io\/)，即每个人的安全生产身份框架。它也是 [CNCF](https:\/\/www.cncf.io\/projects\/spiffe\/) 中的一个毕业项目，自 2022 年 8 月以来。Spiffe 规范在一个 [专用的 github](https:\/\/github.com\/spiffe\/spiffe)上定义。\n\n此时，我们将在 github 仓库中描述的 SPIFFE 标准的高层概述，其中包括：\n\n- SPIFFE ID，一个结构化的字符串（表示为 URI），用作实体的“名称”。\n- SPIFFE 可验证身份文档（SVID）是携带 SPIFFE ID 的文档。它是护照的功能等同物 - 一个携带提供者身份的文档。\n- 工作负载 API 是工作负载或计算过程获取其 SVID 的方法。它通常在本地暴露（例如，通过 Unix 域套接字），并且明确不包括来自工作负载的认证握手或认证令牌。\n\n此外，重要的是要提到信任域，这是一个身份命名空间，由一组加密密钥支持的发行机构支持。这些密钥共同作为居住在信任域中的所有身份的加密锚点。\n\n再次强调，由于 SPIFFE 是一组规范，所有这些概念\/标准实际上都在 [github 仓库](https:\/\/github.com\/spiffe\/spiffe\/tree\/main\/standards)中详细说明。\n\n现在我们知道了规范和标准，但还有很多工作要做，因为，毕竟，这只是规范。幸运的是，还有 [SPIRE 项目](https:\/\/spiffe.io\/docs\/latest\/spire-about\/spire-concepts\/)，[另一个毕业的 CNCF 项目](https:\/\/www.cncf.io\/projects\/spire\/)，这是 SPIFFE 规范的一个生产就绪实现。\n\n在 Cilium 中，SPIFFE 的实现基于 SPIRE 中央服务器。这个 SPIRE 服务器扮演我们之前在规范和标准中提到的信任域的角色。它与每个节点的 SPIRE 代理一起工作，这些代理从服务器获取自己的身份，然后验证工作负载的身份请求。\n\n要了解 SPIRE 是如何工作的，我们需要再次一些概念：\n\n- **工作负载注册**是 SPIRE 将能够识别所述工作负载的过程。它告诉 SPIRE 如何识别工作负载以及给它分配哪个 SPIFFE ID。\n- SPIRE 实现工作负载的**认证**，即断言其身份，通过收集来自工作负载和运行 SPIRE 代理的节点的属性。还值得注意的是，认证是由称为 *认证器* 的软件完成的。在我们的案例中，我们将有一个 Kubernetes 认证器用于托管在 Kubernetes 上的工作负载，但也有节点认证器用于需要首先注册的 SPIRE 代理，然后才能进行工作负载认证。在 Azure 上，节点认证\/注册依赖于具有托管身份的 Azure VMs。\n\n节点认证遵循以下步骤：\n\n1. 代理节点认证器插件查询平台以获取节点身份的证明，并将该信息提供给代理。\n2. 代理将这个身份证明传递给服务器。服务器将这些数据传递给其节点认证器。\n3. 服务器节点认证器通过调用平台 API 验证身份证明，使用它在第 2 步中获得的信息。节点认证器还为代理创建一个 SPIFFE ID，并将此 ID 以及它发现的任何节点选择器一起传回服务器进程。\n4. 服务器为代理节点发送回一个 SVID。\n\n![图 1：节点认证流程](nodeattestation.webp)\n\n一个请求身份的工作负载遵循以下步骤：\n\n1. 它调用代理公开的工作负载 API 请求一个 SVID。\n2. 代理询问调用工作负载认证器插件，向其提供有关工作负载的信息。\n3. 工作负载认证器通过查询邻近的平台特定组件（如 Kubernetes kubelet）发现有关工作负载的额外信息。\n4. 认证器将发现的信息以选择器的形式返回给代理。\n5. 代理通过将发现的选择器与注册条目进行比较来确定工作负载的身份，并将正确的缓存 SVID 返回给工作负载。\n\n![图 2：工作负载认证流程](wlattest.webp)\n\n好了，这就是这个概述的全部内容。SPIFFE 规范中还有更多细节，我只能建议进行更彻底的阅读以获得更好的理解。让我们看看当我们在 AKS 集群中部署时情况如何。\n\n## 尝试 Cilium 认证\n\n### 准备环境\n\n为了尝试这个功能，我们将使用一个仅包含 AKS 集群及其默认节点池的环境，位于虚拟网络中。\n\n**shcemainfra**\n\n认证需要在安装 Cilium 时指定，参数 \u0060authentication.mutual.spire.enabled\u0060 和 \u0060authentication.mutual.spire.install.enabled\u0060 必须设置为 true。\n\n我们使用的 Helm 参数的完整列表如下所示\n\n| Helm 参数                                   | 值                                                           | 描述                                                         |\n| ------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| hubble.relay.enabled                        | true                                                         | 启用 Hubble Relay                                            |\n| hubble.ui.enabled                           | true                                                         | 是否启用 Hubble UI                                           |\n| aksbyocni.enabled                           | true                                                         | 启用 AKS BYOCNI 集成。注意，这与未在 BYOCNI 模式下创建的 AKS 集群不兼容：改用 Azure 集成（azure.enabled）。 |\n| nodeinit.enabled                            | true                                                         | 启用节点初始化 DaemonSet                                     |\n| kubeProxyReplacement                        | true                                                         | 替换 kubeproxy                                               |\n| k8sServiceHost                              | “\u0022                                                           | Kubernetes 服务主机 - 使用“auto”从集群信息 ConfigMap 中自动查找（仅限基于 kubeadm 的集群） |\n| k8sServicePort                              | 443                                                          | Kubernetes 服务端口                                          |\n| cluster.id                                  | 1                                                            | 集群的唯一 ID。必须在所有连接的集群中是唯一的，并且在 1 到 255 的范围内。只有在使用 Cluster Mesh 时才需要，如果不使用 Cluster Mesh 可以为 0。 |\n| cluster.name                                | “\u0022                                                           | 集群的名称。只有在使用 Cluster Mesh 和与 SPIRE 的互相认证时才需要。它必须满足以下限制：* 最多包含 32 个字符；* 必须以小写字母或数字字符开头和结尾；* 之间可以包含小写字母或数字字符和破折号。如果集群 ID 不同于 0，则不能使用“default”名称。 |\n| azure.resourceGroup                         | “\u0022                                                           | AKS 资源组                                                   |\n| ipam.operator.clusterPoolIPv4PodCIDRList    | “{Ip_Range}”                                                 | PoolIPv4PodCIDRList 列表 [“10.0.0.0\/8”] IPv4 CIDR 范围列表，分配给单个节点用于 IPAM。 |\n| prometheus.enabled                          | true                                                         | 启用 prometheus 指标                                         |\n| operator.prometheus.enabled                 | true                                                         | 启用以 OpenMetrics 格式导出 hubble 指标。                    |\n| hubble.metrics.enableOpenMetrics            | false                                                        | 启用以 OpenMetrics 格式导出 hubble 指标。                    |\n| hubble.metrics.enabled                      | “{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction}” | 配置要收集的指标列表。如果为空或 null，则禁用指标。示例：enabled: - dns:query;ignoreAAAA - drop - tcp - flow - icmp - http 您可以从 helm CLI 指定指标列表：–set hubble.metrics.enabled=”{dns:query;ignoreAAAA,drop,tcp,flow,icmp,http}” |\n| authentication.mutual.spire.enabled         | true                                                         | mutual.spire.enabled bool false 启用 SPIRE 集成（beta）      |\n| authentication.mutual.spire.install.enabled | true                                                         | ion.mutual.spire.install.enabled bool true 启用 SPIRE 安装。这将仅在 authentication.mutual.spire.enabled 为 true 时生效 |\n\n安装完成后，我们可以查看 Cilium 的状态。\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ cilium status\n    \/¯¯\\\n \/¯¯\\__\/¯¯\\    Cilium:             OK\n \\__\/¯¯\\__\/    Operator:           OK\n \/¯¯\\__\/¯¯\\    Envoy DaemonSet:    OK\n \\__\/¯¯\\__\/    Hubble Relay:       OK\n    \\__\/       ClusterMesh:        disabled\n\nDeployment             hubble-ui          Desired: 1, Ready: 1\/1, Available: 1\/1\nDaemonSet              cilium-envoy       Desired: 3, Ready: 3\/3, Available: 3\/3\nDaemonSet              cilium             Desired: 3, Ready: 3\/3, Available: 3\/3\nDeployment             hubble-relay       Desired: 1, Ready: 1\/1, Available: 1\/1\nDeployment             cilium-operator    Desired: 2, Ready: 2\/2, Available: 2\/2\nContainers:            cilium             Running: 3\n                       hubble-ui          Running: 1\n                       cilium-envoy       Running: 3\n                       cilium-operator    Running: 2\n                       hubble-relay       Running: 1\nCluster Pods:          29\/29 managed by Cilium\nHelm chart version:    1.16.0\nImage versions         cilium             quay.io\/cilium\/cilium:v1.16.0@sha256:46ffa4ef3cf6d8885dcc4af5963b0683f7d59daa90d49ed9fb68d3b1627fe058: 3\n                       hubble-ui          quay.io\/cilium\/hubble-ui:v0.13.1@sha256:e2e9313eb7caf64b0061d9da0efbdad59c6c461f6ca1752768942bfeda0796c6: 1\n                       hubble-ui          quay.io\/cilium\/hubble-ui-backend:v0.13.1@sha256:0e0eed917653441fded4e7cdb096b7be6a3bddded5a2dd10812a27b1fc6ed95b: 1\n                       cilium-envoy       quay.io\/cilium\/cilium-envoy:v1.29.7-39a2a56bbd5b3a591f69dbca51d3e30ef97e0e51@sha256:bd5ff8c66716080028f414ec1cb4f7dc66f40d2fb5a009fff187f4a9b90b566b: 3\n                       cilium-operator    quay.io\/cilium\/operator-generic:v1.16.0@sha256:d6621c11c4e4943bf2998af7febe05be5ed6fdcf812b27ad4388f47022190316: 2\n                       hubble-relay       quay.io\/cilium\/hubble-relay:v1.16.0@sha256:33fca7776fc3d7b2abe08873319353806dc1c5e07e12011d7da4da05f836ce8d: 1\n\u0060\u0060\u0060\n\n我们还可以查看其他 Kubernetes 对象：\n\n- 一个 SPIRE 服务器的部署\n- 在每个节点上运行的代理的守护进程集。\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ k get all -n cilium-spire \nNAME                    READY   STATUS    RESTARTS   AGE\npod\/spire-agent-65sh2   1\/1     Running   0          7h2m\npod\/spire-agent-hqnsm   1\/1     Running   0          7h2m\npod\/spire-agent-lcqrz   1\/1     Running   0          7h2m\npod\/spire-server-0      2\/2     Running   0          24h\n\nNAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE\nservice\/spire-server   ClusterIP   100.65.61.5   \u003cnone\u003e        8081\/TCP   27h\n\nNAME                         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\ndaemonset.apps\/spire-agent   3         3         3       3            3           \u003cnone\u003e          27h\n\nNAME                            READY   AGE\nstatefulset.apps\/spire-server   1\/1     27h\n\u0060\u0060\u0060\n\n在进行一些测试之前，让我们看看我们的 SPIRE 服务器。我们可以在[相应文档](https:\/\/docs.cilium.io\/en\/stable\/network\/servicemesh\/mutual-authentication\/mutual-authentication-example\/)中找到查看它的命令。\n\n首先我们可以检查 SPIRE 服务器的健康状况：\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server healthcheck\nServer is healthy.\n\u0060\u0060\u0060\n\n然后我们可以看看 SPIRE 代理及其认证状态。因为我们有 3 个节点，所以在守护进程集中有 3 个 pod\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ k get ds -n cilium-spire \nNAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nspire-agent   3         3         3       3            3           \u003cnone\u003e          27h\n\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server agent list\nFound 3 attested agents:\n\nSPIFFE ID         : spiffe:\/\/spiffe.cilium\/spire\/agent\/k8s_psat\/cluster1\/c0c6afc3-1e0a-4ffb-b61e-18442b04123d\nAttestation type  : k8s_psat\nExpiration time   : 2024-07-30 17:27:15 \u002b0000 UTC\nSerial number     : 8338212869267325996294354393424215766\nCan re-attest     : true\n\nSPIFFE ID         : spiffe:\/\/spiffe.cilium\/spire\/agent\/k8s_psat\/cluster1\/08af80d6-0166-4f46-b575-0aa0dc6a5152\nAttestation type  : k8s_psat\nExpiration time   : 2024-07-30 17:27:15 \u002b0000 UTC\nSerial number     : 317183292034746089049553637864798125627\nCan re-attest     : true\n\nSPIFFE ID         : spiffe:\/\/spiffe.cilium\/spire\/agent\/k8s_psat\/cluster1\/bdd0dfa9-20ec-4f24-a82f-c646754588ce\nAttestation type  : k8s_psat\nExpiration time   : 2024-07-30 17:27:15 \u002b0000 UTC\nSerial number     : 215301213544348190052950735212628656167\nCan re-attest     : true\n\u0060\u0060\u0060\n\n接下来我们可以检查 SPIFFE 身份。\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server entry show -parentID spiffe:\/\/spiffe.cilium\/ns\/cilium-spire\/sa\/spire-agent\nFound 2 entries\nEntry ID         : 53b6506b-ebe3-4cd8-89b4-9647fa535c37\nSPIFFE ID        : spiffe:\/\/spiffe.cilium\/cilium-agent\nParent ID        : spiffe:\/\/spiffe.cilium\/ns\/cilium-spire\/sa\/spire-agent\nRevision         : 0\nX509-SVID TTL    : default\nJWT-SVID TTL     : default\nSelector         : k8s:ns:kube-system\nSelector         : k8s:sa:cilium\n\nEntry ID         : 8c361104-31a1-480e-b97d-83673a63ce72\nSPIFFE ID        : spiffe:\/\/spiffe.cilium\/cilium-operator\nParent ID        : spiffe:\/\/spiffe.cilium\/ns\/cilium-spire\/sa\/spire-agent\nRevision         : 0\nX509-SVID TTL    : default\nJWT-SVID TTL     : default\nSelector         : k8s:ns:kube-system\n\u0060\u0060\u0060\n### 使用相互认证\n\n现在让我们部署一些工作负载。为了简单起见，我们将创建一系列基于 nginx 的部署：\n\n一个目标应用：\n\n\u0060\u0060\u0060yaml\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: demodeployment\n  name: demodeployment\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: demodeployment\n  strategy: {}\n  template:\n    metadata:\n      labels:\n        app: demodeployment\n    spec:\n      containers:\n      - image: nginx\n        name: nginx\n        resources: {}\nstatus: {}\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: demodeployment\n  name: demodeployment\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    targetPort: 80\n  selector:\n    app: demodeployment\nstatus:\n  loadBalancer: {}\n\u0060\u0060\u0060\n\n以及客户端：\n\n\u0060\u0060\u0060yaml\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: client1\n  name: client1\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: client1\n  strategy: {}\n  template:\n    metadata:\n      labels:\n        app: client1\n    spec:\n      containers:\n      - image: nginx\n        name: nginx\n        resources: {}\nstatus: {}\n---\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: client2\n  name: client2\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: client2\n  strategy: {}\n  template:\n    metadata:\n      labels:\n        app: client2\n    spec:\n      containers:\n      - image: nginx\n        name: nginx\n        resources: {}\nstatus: {}\n\u0060\u0060\u0060\n\n如果我们查看 Cilium 端点，我们应该能看到关联身份的信息：\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ k get ciliumendpoint -o wide\nNAME                             SECURITY IDENTITY   INGRESS ENFORCEMENT   EGRESS ENFORCEMENT   VISIBILITY POLICY   ENDPOINT STATE   IPV4           IPV6\nclient1-599c487979-dqm4v         76513                                                                              ready            100.64.1.197   \nclient1-599c487979-qqzvl         76513                                                                              ready            100.64.0.206   \nclient1-599c487979-t8728         76513                                                                              ready            100.64.2.214   \nclient2-d64dd865b-cj56m          77602                                                                              ready            100.64.0.77    \nclient2-d64dd865b-kb7cs          77602                                                                              ready            100.64.1.51    \nclient2-d64dd865b-qskqc          77602                                                                              ready            100.64.2.25    \ndemodeployment-bf5d895b5-6s4xn   108597                                                                             ready            100.64.0.124   \ndemodeployment-bf5d895b5-pmzkm   108597                                                                             ready            100.64.1.244   \ndemodeployment-bf5d895b5-vz4gq   108597                                                                             ready            100.64.2.127   \n\u0060\u0060\u0060\n\n使用安全身份值，我们可以在 SPIRE 服务器上检查相应的身份。我们将使用 \u0060\u0027{.items[0].status.identity.id}\u0027\u0060 作为 jsonpath 值来提取安全身份作为变量。\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ k get deployment --show-labels \nNAME             READY   UP-TO-DATE   AVAILABLE   AGE   LABELS\nclient1          3\/3     3            3           14h   app=client1\nclient2          3\/3     3            3           14h   app=client2\ndemodeployment   3\/3     3            3           15h   app=demodeployment\nyumemaru@azure:~$ export client1=$(k get ciliumendpoints.cilium.io -l app=client1 -o=jsonpath=\u0027{.items[0].status.identity.id}\u0027)id}\u0027)\nyumemaru@azure:~$ export client2Id=$(k get ciliumendpoints.cilium.io -l app=client2 -o=jsonpath=\u0027{.items[0].status.identity.id}\u0027)\nyumemaru@azure:~$ export demoId=$(k get ciliumendpoints.cilium.io -l app=demodeployment -o=jsonpath=\u0027{.items[0].status.identity.id}\u0027)\n\u0060\u0060\u0060\n\n在 SPIRE 服务器 pod 内部，我们现在可以检查每个工作负载对应的身份：\n\n\u0060\u0060\u0060bash\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server entry show -spiffeID spiffe:\/\/spiffe.cilium\/identity\/$client1Id\nFound 1 entry\nEntry ID         : 7bf9a3b0-a06c-480e-8f0c-1fd654d3ec56\nSPIFFE ID        : spiffe:\/\/spiffe.cilium\/identity\/76513\nParent ID        : spiffe:\/\/spiffe.cilium\/cilium-operator\nRevision         : 0\nX509-SVID TTL    : default\nJWT-SVID TTL     : default\nSelector         : cilium:mutual-auth\n\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server entry show -spiffeID spiffe:\/\/spiffe.cilium\/identity\/$client2Id\nFound 1 entry\nEntry ID         : 62b158d0-c90b-449a-9b30-a8a24ba012ba\nSPIFFE ID        : spiffe:\/\/spiffe.cilium\/identity\/77602\nParent ID        : spiffe:\/\/spiffe.cilium\/cilium-operator\nRevision         : 0\nX509-SVID TTL    : default\nJWT-SVID TTL     : default\nSelector         : cilium:mutual-auth\n\nyumemaru@azure:~$ kubectl exec -n cilium-spire spire-server-0 -c spire-server -- \/opt\/spire\/bin\/spire-server entry show -spiffeID spiffe:\/\/spiffe.cilium\/identity\/$demoId\nFound 1 entry\nEntry ID         : 07f27f3c-7a94-450b-aecc-bb006f57b97e\nSPIFFE ID        : spiffe:\/\/spiffe.cilium\/identity\/108597\nParent ID        : spiffe:\/\/spiffe.cilium\/cilium-operator\nRevision         : 0\nX509-SVID TTL    : default\nJWT-SVID TTL     : default\nSelector         : cilium:mutual-auth\n\u0060\u0060\u0060\n\n但也可以直接作为 cilium api 对象查看身份。以下是 \u0060client1\u0060 应用的结果：\n\n\u0060\u0060\u0060bash\nyumemary@azure:~$ k describe ciliumidentities.cilium.io $client1Id \nName:         76513\nNamespace:    \nLabels:       app=client1\n              io.cilium.k8s.policy.cluster=cluster1\n              io.cilium.k8s.policy.serviceaccount=default\n              io.kubernetes.pod.namespace=default\nAnnotations:  \u003cnone\u003e\nAPI Version:  cilium.io\/v2\nKind:         CiliumIdentity\nMetadata:\n  Creation Timestamp:  2024-07-30T16:46:43Z\n  Generation:          1\n  Resource Version:    224640\n  UID:                 433dd70b-58ba-41c0-abef-c9d5785eaddb\nSecurity - Labels:\n  k8s:app:                                                         client1\n  k8s:io.cilium.k8s.namespace.labels.kubernetes.io\/metadata.name:  default\n  k8s:io.cilium.k8s.policy.cluster:                                cluster1\n  k8s:io.cilium.k8s.policy.serviceaccount:                         default\n  k8s:io.kubernetes.pod.namespace:                                 default\nEvents:                                                            \u003cnone\u003e\n\u0060\u0060\u0060\n\n我们会注意到 Cilium 身份名称、Cilium 端点上显示的安全身份和我们在 SPIRE 服务器上得到的 SPIFFE ID \u0060spiffe:\/\/spiffe.cilium\/identity\/76513\u0060 之间的对应关系。\n\n那很好。现在，我们如何强制执行相互认证呢？实际上很简单，我们只需要在 Cilium 网络策略中添加适当的参数：\n\n\u0060\u0060\u0060yaml\nauthentication:\n    mode: \u0022required\u0022\n\u0060\u0060\u0060\n\n让我们编写 3 个网络策略：\n\n- 首先，按应有的方式，一个拒绝所有策略。\n\n\u0060\u0060\u0060yaml\napiVersion: \u0022cilium.io\/v2\u0022\nkind: CiliumNetworkPolicy\nmetadata:\n  name: \u0022demo1-default-deny\u0022\n  namespace: default\nspec:\n  description: \u0022Default-deny ingress policy for demo app\u0022\n  endpointSelector:\n    matchLabels:\n      app: demodeployment\n  ingress:\n  - {}\n\u0060\u0060\u0060\n\n- 其次，一个允许 app1 流量到 demo 应用的策略。\n- 第三，一个网络策略允许 app2 到 demo 应用，但这次需要认证。\n\n如果我们仅应用第一个策略，我们应该无法再访问 demo 应用。这可以通过 \u0060hubble observe\u0060 命令看到\n\n\u0060\u0060\u0060bash\nyumemary@azure:~$ k exec deployments\/client1 -- curl -i -X GET http:\/\/demodeployment\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:--  0:02:09 --:--:--     0\ncurl: (28) Failed to connect to demodeployment port 80 after 129180 ms: Couldn\u0027t connect to server\ncommand terminated with exit code 28\nyumemary@azure:~$ hubble observe --to-label app=demodeployment\nJul 31 09:54:42.541: default\/client1-599c487979-t8728:54548 (ID:76513) -\u003e default\/demodeployment-bf5d895b5-pmzkm:80 (ID:108597) to-overlay FORWARDED (TCP Flags: SYN)\n\u0060\u0060\u0060\n\n然而，我们仍然可以访问 client2 部署的一个 pod，因为我们只针对其标签的 demo 应用。\n\n\u0060\u0060\u0060bash\nyumemary@azure:~$ k get pod -o custom-columns=Name:.metadata.name,PodIp:.status.podIP,HostIp:.status.hostIP\nName                             PodIp          HostIp\nclient1-599c487979-dqm4v         100.64.1.197   172.21.14.69\nclient1-599c487979-qqzvl         100.64.0.206   172.21.14.68\nclient1-599c487979-t8728         100.64.2.214   172.21.14.70\nclient2-d64dd865b-cj56m          100.64.0.77    172.21.14.68\nclient2-d64dd865b-kb7cs          100.64.1.51    172.21.14.69\nclient2-d64dd865b-qskqc          100.64.2.25    172.21.14.70\nclient3-6fbfd96c6f-bwhqh         100.64.1.150   172.21.14.69\nclient3-6fbfd96c6f-cfhhv         100.64.0.91    172.21.14.68\nclient3-6fbfd96c6f-wldx5         100.64.2.95    172.21.14.70\ndemodeployment-bf5d895b5-6s4xn   100.64.0.124   172.21.14.68\ndemodeployment-bf5d895b5-pmzkm   100.64.1.244   172.21.14.69\ndemodeployment-bf5d895b5-vz4gq   100.64.2.127   172.21.14.70\nyumemary@azure:~$ k exec deployments\/client1 -- curl -i -X GET http:\/\/100.64.2.25\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   615  100   615    0     0   499k      0 --:--:-- --:--:-- --:--:--  600k\nHTTP\/1.1 200 OK\nServer: nginx\/1.27.0\nDate: Wed, 31 Jul 2024 10:01:58 GMT\nContent-Type: text\/html\nContent-Length: 615\nLast-Modified: Tue, 28 May 2024 13:22:30 GMT\nConnection: keep-alive\nETag: \u00226655da96-267\u0022\nAccept-Ranges: bytes\n\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n\u003ctitle\u003eWelcome to nginx!\u003c\/title\u003e\n\u003cstyle\u003e\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n\u003c\/style\u003e\n\u003c\/head\u003e\n\u003cbody\u003e\n\u003ch1\u003eWelcome to nginx!\u003c\/h1\u003e\n\u003cp\u003eIf you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.\u003c\/p\u003e\n\n\u003cp\u003eFor online documentation and support please refer to\n\u003ca href=\u0022http:\/\/nginx.org\/\u0022\u003enginx.org\u003c\/a\u003e.\u003cbr\/\u003e\nCommercial support is available at\n\u003ca href=\u0022http:\/\/nginx.com\/\u0022\u003enginx.com\u003c\/a\u003e.\u003c\/p\u003e\n\n\u003cp\u003e\u003cem\u003eThank you for using nginx.\u003c\/em\u003e\u003c\/p\u003e\n\u003c\/body\u003e\n\u003c\/html\u003e\n\u0060\u0060\u0060\n\n### 实施策略 2 和 3\n\n现在我们来从客户端 1 和客户端 2 使用命令 \u0060kubectl exec deployments\/\u003cdeploymentname\u003e -- curl -i -X GET http:\/\/demodeployment\u0060 访问 demo 应用，我们可以通过 hubble 观察到客户端 1 的流量被授权：\n\n\u0060\u0060\u0060bash\nyumemary@azure:~$ hubble observe --to-label app=demodeployment --from-label app=client1\nJul 31 11:33:48.647: default\/client1-599c487979-t8728:54594 (ID:76513) \u003c\u003e default\/demodeployment-bf5d895b5-vz4gq (ID:108597) pre-xlate-rev TRACED (TCP)\nJul 31 11:33:48.647: default\/client1-599c487979-t8728 (ID:76513) \u003c\u003e default\/demodeployment-bf5d895b5-vz4gq:80 (ID:108597) post-xlate-fwd TRANSLATED (TCP)\nJul 31 11:33:48.647: default\/client1-599c487979-t8728:54594 (ID:76513) -\u003e default\/demodeployment-bf5d895b5-vz4gq:80 (ID:108597) policy-verdict:L3-L4 INGRESS ALLOWED (TCP Flags: SYN)\nJul 31 11:33:48.647: default\/client1-599c487979-t8728:54594 (ID:76513) -\u003e default\/demodeployment-bf5d895b5-vz4gq:80 (ID:108597) to-endpoint FORWARDED (TCP Flags: SYN)\nJul 31 11:33:48.647: default\/client1-599c487979-t8728:54594 (ID:76513) -\u003e default\/demodeployment-bf5d895b5-vz4gq:80 (ID:108597) to-endpoint FORWARDED (TCP Flags: ACK)\n\u0060\u0060\u0060\n\n以及客户端 2 的认证步骤：\n\n\u0060\u0060\u0060bash\nyumemary@azure:~$ hubble observe --to-label app=demodeployment --from-label app=client2\nJul 31 11:35:18.651: default\/client2-d64dd865b-qskqc (ID:77602) \u003c\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) post-xlate-fwd TRANSLATED (TCP)\nJul 31 11:35:18.651: default\/client2-d64dd865b-qskqc:50986 (ID:77602) -\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) to-overlay FORWARDED (TCP Flags: SYN)\nJul 31 11:35:18.651: default\/client2-d64dd865b-qskqc:50986 (ID:77602) \u003c\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) policy-verdict:L3-L4 INGRESS DENIED (TCP Flags: SYN; Auth: SPIRE)\nJul 31 11:35:18.651: default\/client2-d64dd865b-qskqc:50986 (ID:77602) \u003c\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) Authentication required DROPPED (TCP Flags: SYN)\nJul 31 11:35:19.661: default\/client2-d64dd865b-qskqc:50986 (ID:77602) -\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) policy-verdict:L3-L4 INGRESS ALLOWED (TCP Flags: SYN; Auth: SPIRE)\nJul 31 11:35:19.661: default\/client2-d64dd865b-qskqc:50986 (ID:77602) -\u003e default\/demodeployment-bf5d895b5-6s4xn:80 (ID:108597) to-endpoint FORWARDED (TCP Flags: SYN)\n\u0060\u0060\u0060\n\n到此为止就是所有的内容了。让我们来总结一下。\n\n## 总结\n\n在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。这一功能依赖于实现 SPIFFE 框架的 SPIRE 服务器部署。之后，实际上非常简单。网络策略中的简单规范确保了工作负载间的身份验证。而且在 hubble 上也很容易看到这一点。下一步应该是在 hubble 部分以及 SPIRE 服务器上配置更多的监控。这就是为什么在图表配置中添加了与指标相关的值。目前这对我来说还不起作用，所以我稍后还得回来处理这个问题。还需要对 SPIRE 服务器的可观测性进行一些思考。可能查看 loki 或类似工具的日志会很不错。但那将是下一次的内容。\n', '\/trans\/cilium-native-authentication\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">在本文中，我们更深入地探讨了 Cilium 的功能，特别是它从服务网格获得的相互认证功能。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-configuration-safety-common-misconfigurations/">Istio 配置安全：如何避免错误配置</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/08/06</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio 配置安全：如何避免错误配置', '探索常见的 Istio 配置错误及其解决方法，提高服务网格的安全性和稳定性。', '\nIstio 是一个功能强大的服务网格解决方案，提供零信任安全性、可观测性和高级流量管理等功能，且无需修改代码即可实现。然而，由于配置错误，我们经常会遇到意料之外的行为。本文将介绍几种常见的 Istio 配置错误，解析其背后的原理，并通过示意图展示如何识别和解决这些问题。我们还将介绍 Tetrate 提供的工具——[TIS Config Analyzer](https:\/\/docs.tetrate.io\/istio-subscription\/dashboard\/analyzers\/config)，这是一种优化 Istio 操作效率和安全性的工具。\n\n## 配置错误导致的事故案例\n\n以下是两个由于配置错误导致的典型事故案例：\n\n1. **[Amazon Web Services 2017 年停机事件](https:\/\/www.theverge.com\/2017\/3\/2\/14792442\/amazon-s3-outage-cause-typo-internet-server)**：一次简单的输入错误导致了广泛的服务中断，影响了数千个在线服务和应用，突显了即使在成熟的云基础设施中，一个小小的配置错误也会引发严重后果。\n\n2. **[GitLab 2017 年数据丢失事故](https:\/\/about.gitlab.com\/blog\/2017\/02\/01\/gitlab-dot-com-database-incident\/)**：由于配置错误，GitLab 在进行数据库维护时误删除了大量生产数据。尽管备份机制被配置好，但错误的配置阻止了数据的及时恢复。\n\n这些案例表明，正确的配置管理对于防止服务中断和数据丢失至关重要。\n\n## 常见的 Istio 配置错误类型\n\nIstio 配置错误主要分为以下几大类：\n\n1. **AuthorizationPolicy（授权策略）**：命名空间不存在、仅允许 HTTP 方法和完全限定的 gRPC 名称、主机没有匹配的服务注册表条目、字段需要启用 mTLS、未找到服务帐户等。\n2. **DestinationRule（目标规则）**：同一主机子集组合的多个目标规则、主机在服务注册表中没有匹配条目、子集标签在任何匹配主机中未找到等。\n3. **Gateway（网关）**：同一主机端口组合的多个网关、网关选择器在命名空间中未找到匹配的工作负载等。\n4. **Port（端口）**：端口名称必须遵循特定格式、端口的应用协议必须遵循特定格式等。\n5. **Service（服务）**：未找到暴露与服务相同端口的部署等。\n6. **VirtualService（虚拟服务）**：目标权重的路由没有有效的服务、指向不存在网关的虚拟服务等。\n\n## 常见的 Istio 配置错误示例\n\n在 Istio 的日常使用中，以下是一些最常见的配置错误：\n\n1. **虚拟服务指向不存在的网关：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: VirtualService\n    metadata:\n      name: details\n      namespace: bookinfo\n    spec:\n      hosts:\n        - details\n      gateways:\n        - non-existent-gateway\n    \u0060\u0060\u0060\n    在这种情况下，\u0060details\u0060 虚拟服务试图通过一个不存在的 \u0060non-existent-gateway\u0060 进行路由，导致流量管理失败。\n\n2. **虚拟服务引用不存在的服务子集：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: VirtualService\n    metadata:\n      name: details\n      namespace: bookinfo\n    spec:\n      hosts:\n        - details\n    \u0060\u0060\u0060\n    如果 \u0060details\u0060 服务没有定义相应的子集，请求将因无法找到正确的服务实例而被拒绝。\n\n3. **网关找不到指定的服务器凭证：**\n\n    \u0060\u0060\u0060yaml\n    apiVersion: networking.istio.io\/v1beta1\n    kind: Gateway\n    metadata:\n      name: cert-not-found-gateway\n      namespace: bookinfo\n    spec:\n      selector:\n        istio: ingressgateway\n      servers:\n        - port:\n            number: 443\n            name: https\n            protocol: HTTPS\n          tls:\n            mode: SIMPLE\n            credentialName: \u0022not-exist\u0022\n    \u0060\u0060\u0060\n    这会导致 TLS 握手失败，因为指定的凭证 \u0060not-exist\u0060 不存在。\n\n## 配置验证\n\n为了减少由于配置错误而导致的服务中断风险，配置验证成为了一个不可或缺的步骤。配置验证可以分为以下两种：\n\n- **静态配置验证**：在配置应用到系统之前进行验证。这包括检查语法错误、完整性以及配置项的有效性。\n- **按需配置验证**：在配置已经应用但可能需要根据实时数据进行调整时进行验证。这种类型的验证有助于适应动态环境中的变化，确保配置的持续正确性。\n\n### 推荐的配置验证工具\n\n#### \u0060istioctl validate\u0060\n\n\u0060istioctl validate\u0060 用于验证 Istio 配置文件（如 YAML 文件）的语法和基本结构，确保配置文件符合 Istio API 的规范。它可以在配置应用到集群之前检测出语法错误和格式问题，是一个静态分析工具，通常结合 CI 流程使用，防止无效配置文件应用到集群中。\n\n#### \u0060istioctl analyze\u0060\n\n[\u0060istioctl analyze\u0060](https:\/\/istio.io\/latest\/docs\/ops\/diagnostic-tools\/istioctl-analyze\/) 是一个强大的诊断工具，用于分析 Istio 集群的运行状态和配置一致性。它不仅检查配置文件的语法，还可以检查集群中实际应用的配置，找出潜在的问题和冲突。\u0060istioctl analyze\u0060 提供动态分析功能，能够识别集群运行时的配置错误和潜在问题。\n\n\u0060istioctl analyze\u0060 的配置流程如下：\n\n1. **收集配置数据**：首先，\u0060istioctl analyze\u0060 收集来自指定源的 Istio 配置数据。这些源可以是活动的 Kubernetes 集群，也可以是本地的配置文件。\n2. **解析和构建模型**：工具解析收集的配置数据，构建一个内部表示 Istio 配置的模型。\n3. **应用分析规则**：随后，它应用一系列预定义的规则来分析这个模型，检测潜在的配置问题。这些规则涵盖从安全漏洞到性能问题的各种潜在问题。\n4. **生成报告**：分析完成后，\u0060istioctl analyze\u0060 输出一个包含所有发现问题的详细报告。如果没有发现问题，它会通知用户配置看起来没有问题。\n\n下面是 \u0060istioctl analyze\u0060 的工作流程图：\n\n\u0060\u0060\u0060mermaid istio analyze 的工作流程\nflowchart TD\n    A[开始] --\u003e B[选择配置源]\n    B --本地文件--\u003e C[加载本地配置文件]\n    B --实时集群--\u003e D[连接 Kubernetes 集群]\n    B --两者--\u003e E[组合本地文件和集群配置]\n    C --\u003e F[解析配置数据]\n    D --\u003e F\n    E --\u003e F\n    F --\u003e G[构建内部配置模型]\n    G --\u003e H[应用分析规则]\n    H --\u003e I{发现问题?}\n    I --是--\u003e J[生成问题报告]\n    I --否--\u003e K[输出配置无问题]\n    J --\u003e L[结束]\n    K --\u003e L\n\u0060\u0060\u0060\n\n![istioctl analyze 的工作流程](4eb4d5bbb7c8856d609944835aa03993.svg)\n\n#### Kiali\n\n[Kiali](https:\/\/kiali.io) 是管理和可视化 Istio 服务网格的重要工具，提供对网格健康状况、性能和配置状态的实时洞察。通过将 Kiali 集成到 Istio 环境中，可以通过以下方式增强配置安全性：\n\n- **可视化**：Kiali 提供服务网格的图形表示，更容易发现配置错误，如路由错误或缺失的策略。\n- **验证**：有助于验证 Istio 配置，突出显示如配置错误的网关或目标规则等问题，以防这些问题引起麻烦。\n- **安全洞察**：Kiali 提供对安全策略的可见性，确保 mTLS 和授权设置正确实施。\n\n将 Kiali 与 \u0060istioctl validate\u0060 和 \u0060istioctl analyze\u0060 等工具结合使用，能确保更为稳健的方法来预防和解决 Istio 配置错误，进而提升服务网格的安全性和效率。\n\n## Tetrate 的 TIS 中的 Config Analyzer 工具介绍\n\n为了帮助开发者和运维人员避免常见的配置失误，Tetrate 开发了 TIS Dashboard 中的 [Config Analyzer](https:\/\/docs.tetrate.io\/istio-subscription\/dashboard\/analyzers\/config) 工具。该工具能够自动验证 Istio 的配置，根据最佳实践分析服务网格的配置问题，并提供优化建议。Config Analyzer 可以自动检测 Istio 服务网格中的配置问题，提供解释及解决方案，支持按需检测配置中的错误。\n\n![TIS Config Analyzer 可以按需检测配置中的问题](config-validate.png)\n\n## 总结\n\n正确配置 Istio 是确保服务网格健康运行的关键。通过了解和避免常见配置错误，以及利用如 Tetrate 的 TIS Config Analyzer 这样的高级工具，您可以确保 Istio 环境的稳定性和安全性。记住，一个小小的配置错误可能导致整个服务网格的故障，因此持续监控和审核配置是非常必要的。\n\n## 参考\n\n- [Validation - kiali.io](https:\/\/kiali.io\/docs\/features\/validations\/)', '\/blog\/istio-configuration-safety-common-misconfigurations\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索常见的 Istio 配置错误及其解决方法，提高服务网格的安全性和稳定性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/podless-kubernetes-istio/">[译] 如何实现无 Pod 的 Kubernetes 和 Istio 部署</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/30</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/kubernetes"> 
             Kubernetes
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://blog.howardjohn.info/posts/podless-kubernetes/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('如何实现无 Pod 的 Kubernetes 和 Istio 部署', '探索如何将 Kubernetes 和 Istio 的完整功能嵌入到单一二进制文件中，实现无 Pod 的极简部署方案。', '\nKubernetes 经常被批评（有些不公平）操作起来过于复杂，促使大多数人依赖托管服务。然而，[\u0060k3s\u0060](https:\/\/k3s.io\/) 某种程度上颠覆了这一点，将完整的 Kubernetes 发行版打包成一个二进制文件。这非常方便，特别是在物联网等小型环境中运行时；虽然隔离组件对非常大规模、先进的部署有好处，但对较小的环境来说，操作微服务可能只是一种负担——这正是 [Istio 多年前选择重构为更单体架构的原因](https:\/\/blog.christianposta.com\/microservices\/istio-as-an-example-of-when-not-to-do-microservices\/)。\n\n然而，它还是没有那么“精简”。在一个空集群中运行 \u0060k3d cluster create test\u0060 后，我们会在集群中看到各种 pod：\n\n\u0060\u0060\u0060bash\n$ kubectl get pods --all-namespaces\nNAMESPACE     NAME                                      READY   STATUS     RESTARTS  AGE\nkube-system   local-path-provisioner-6c86858495-gc9jq   1\/1     Running    0         2m18s\nkube-system   coredns-6799fbcd5-pdf4b                   1\/1     Running    0         2m18s\nkube-system   helm-install-traefik-crd-cp9s2            0\/1     Completed  0         2m18s\nkube-system   helm-install-traefik-pch7c                0\/1     Completed  1         2m18s\nkube-system   traefik-f4564c4f4-q4lkj                   1\/1     Running    0         2m8s\nkube-system   metrics-server-54fd9b65b-d69w6            1\/1     Running    0         2m18s\nkube-system   svclb-traefik-58c5bb65-sq54b              2\/2     Running    0         2m8s\n\u0060\u0060\u0060\n\n\u003e [\u0060k3d\u0060](https:\/\/github.com\/k3d-io\/k3d\/) 是一个方便的工具，可以在 Docker 内部部署 \u0060k3s\u0060，便于测试。\n\n这是怎么回事？我们的“单二进制 Kubernetes”怎么变成了 6 个不同的容器？\n\n虽然 k3s 将许多组件（\u0060kube-proxy\u0060、\u0060flannel\u0060、\u0060containerd\u0060、\u0060kubelet\u0060 等）嵌入到一个二进制文件中，但其他组件则作为标准 pod 在集群中运行。\n\n此外，一旦我们部署了我们最喜欢的 [服务网格](https:\/\/istio.io\/)，我们将会有更多的 pod，使我们离没有 pod 的目标更远。\n\n## 没有 pod 的 Kubernetes？\n\n那么问题是——我们能否通过进一步推进 \u0060k3s\u0060 的理念，将完整的集群功能嵌入到一个二进制文件中，来获得一个功能齐全的 Kubernetes 和 Istio 部署？\n\n\u003e **警告**：这些是实验性概念；绝不要在生产环境中尝试！\n\n首先，我们可以直接去除一些不必要的组件，如 \u0060servicelb\u0060（负载均衡服务需要）、\u0060traefik\u0060（Ingress 需要）、\u0060local-storage\u0060（PVC 需要）和 \u0060metrics-server\u0060（\u0060kubectl top\u0060 需要）。\n\n这就剩下 \u0060coredns\u0060 和 Istio。\n\n如果我们追求极简，我们肯定会希望使用 Istio 的 [ambient mode](https:\/\/istio.io\/latest\/docs\/ops\/ambient\/getting-started\/)，它完全不需要 sidecar。幸运的是，它开箱即用并且有完整的 [DNS 支持](https:\/\/istio.io\/latest\/docs\/ops\/configuration\/traffic-management\/dns-proxy\/)。这让我们可以去掉 \u0060coredns\u0060。\n\n这样一来，如果我们能运行 Istio ambient，就可以去掉 \u0060kube-system\u0060 中的所有内容。这相对简单；难点在于不为 Istio 添加更多的 pod。\n\n## 嵌入 Istio\n\n通过 \u0060k3s\u0060 的一个分支，我修改了它，使 Istio 本身嵌入到 \u0060k3s\u0060 中。\u0060k3s\u0060 可以作为服务器和\/或代理运行。通常你会有 1 个服务器，每个其他节点作为代理运行。\n\n在 \u0060server\u0060 上，我们希望运行 \u0060Istiod\u0060（Istio 的控制平面）。在代理上，我们希望运行 \u0060istio-cni\u0060（每个节点的控制平面）和 \u0060ztunnel\u0060（每个节点的数据平面）。\n\n这三个组件都可以直接嵌入到 \u0060k3s\u0060 中，只需一些工作！\n\n使用这个自定义构建，我们可以通过一些自定义配置启动一个新的 \u0060k3d\u0060 集群，禁用我们不再需要的组件：\n\n\u0060\u0060\u0060yaml\napiVersion: k3d.io\/v1alpha5\nkind: Simple\nmetadata:\n  name: podless\nservers: 1\nagents: 1\noptions:\n  k3d:\n    wait: true\n    timeout: \u002260s\u0022\n    disableLoadbalancer: true\n    disableRollback: true\n  k3s:\n    extraArgs:\n      - arg: --disable-cloud-controller\n        nodeFilters:\n          - server:*\n      - arg: --disable-kube-proxy\n        nodeFilters:\n          - server:*\n      - arg: --disable-network-policy\n        nodeFilters:\n          - server:*\n      - arg: --disable-helm-controller\n        nodeFilters:\n          - server:*\n      - arg: --disable=coredns,servicelb,traefik,local-storage,metrics-server\n        nodeFilters:\n          - server:*\n\u0060\u0060\u0060\n\n这里我们禁用了上面看到的所有 pod，包括一些额外的。\n\n一个显著的例子是 \u0060kube-proxy\u0060。像其他一些项目一样（如 [Cilium](https:\/\/docs.cilium.io\/en\/stable\/network\/kubernetes\/kubeproxy-free\/)），Istio 的 \u0060ztunnel\u0060 可以有效地替代大多数用例中的 \u0060kube-proxy\u0060。\n\n## 无 pod 的服务网格\n\n所有配置就绪后，我们的集群是什么样子？\n\n\u0060\u0060\u0060\n$ kubectl get pods --all-namespaces\nNo resources found\n\u0060\u0060\u0060\n\n到目前为止一切顺利....当然，什么都不运行很容易；真正的挑战是保持集群的功能。\n\n让我们部署一些应用程序 pod。再次强调，这些是集群中的唯一 pod：\n\n\u0060\u0060\u0060\n$ kubectl get pods --all-namespaces\nNAMESPACE   NAME                     READY   STATUS    RESTARTS   AGE\ndefault     shell-5fff89ccf5-98kgg   1\/1     Running   0          19s\ndefault     echo-66d88ff694-9qprp    1\/1     Running   0          14s\n\u0060\u0060\u0060\n\n然后我们可以发送流量：\n\n\u0060\u0060\u0060\n$ kubectl exec deploy\/shell -- curl -s echo\nRequestHeader=Accept:*\/*\nRequestHeader=User-Agent:curl\/8.5.0\nHostname=echo-66d88ff694-9qprp\n\u0060\u0060\u0060\n\n流量完全正常，包括服务流量（以前由 \u0060kube-proxy\u0060 处理）和 DNS（以前由 \u0060coredns\u0060 处理）。现在这些全部由 \u0060ztunnel\u0060 处理，并且所有内容都通过安全的 mTLS 传输。\n\n除了 mTLS 加密，我们还可以基于 mTLS 身份应用策略。同样，这些都由 \u0060ztunnel\u0060 执行。\n\n\u0060\u0060\u0060yaml\napiVersion: security.istio.io\/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: allow-default\nspec:\n  action: ALLOW\n  selector:\n    matchLabels:\n      app: echo\n  rules:\n  - from:\n    - source:\n        namespace: [\u0022cluster.local\/ns\/default\/sa\/shell\u0022]\n\u0060\u0060\u0060\n\n现在 \u0060default\u0060 命名空间的流量被允许，但其他流量不被允许。我们可以通过从 \u0060shell\u0060 发送流量以及我在 \u0060other\u0060 命名空间中部署的新测试工作负载来验证这一点：\n\n\u0060\u0060\u0060bash\n$ kubectl exec deploy\/shell -- curl -s echo\nRequestHeader=Accept:*\/*\nRequestHeader=User-Agent:curl\/8.5.0\nHostname=echo-66d88ff694-9qprp\n$ kubectl exec deploy\/shell -n other -- curl -s echo\ncommand terminated with exit code 56\n\u0060\u0060\u0060\n\n正如预期的那样，我们的其他应用程序被拒绝了！\n\n此外，如果我们愿意，我们可以将流量升级通过完整的 HTTP 代理（[\u0022waypoint\u0022](https:\/\/istio.io\/latest\/docs\/ops\/ambient\/architecture\/)）：\n\n\u0060\u0060\u0060\n$ istioctl x waypoint apply --enroll-namespace\nwaypoint default\/waypoint applied\n\n$ kubectl get pods\nNAME                        READY   STATUS    RESTARTS   AGE\necho-66d88ff694-czd65       1\/1     Running  \n\n 0          93m\nshell-56bd5dbdbf-f4gh9      1\/1     Running   0          93m\nwaypoint-7cd4dc789f-2s7z2   1\/1     Running   0          41s\n\n$ kubectl exec deploy\/shell -- curl -s echo\nRequestHeader=Accept:*\/*\nRequestHeader=User-Agent:curl\/8.5.0\nRequestHeader=X-Request-Id:18d72190-9caa-4162-8bc5-4c11518d7568\nHostname=echo-66d88ff694-czd65\n\u0060\u0060\u0060\n\n现在我们的 waypoint 已经部署，所有到命名空间的流量会自动转发到它，在那里可以执行完整的 HTTP 策略。这里，我们可以看到 \u0060X-Request-Id\u0060 被添加到我们的请求中，但我们还可以获得 [自动配置的其他功能](https:\/\/istio.io\/latest\/blog\/2021\/zero-config-istio\/)，以及更多 [我们可以配置的内容](https:\/\/istio.io\/latest\/docs\/tasks\/)。\n\n## 总结\n\n最终，我们能够部署一个完整的 Kubernetes 集群和服务网格，所有基础设施组件嵌入到一个隐藏的节点二进制文件中——集群功能不需要 pod。\n\n这实际操作起来是否实用？不太实用。然而，这确实表明 Kubernetes\/Istio 被认为过于臃肿和复杂的看法并不完全准确。\n\n它真的比典型的集群更简单吗？某种程度上是的……我们确实替换了两个组件（\u0060kube-proxy\u0060 和 \u0060coredns\u0060），但其余的我们基本上只是隐藏和打包。这显然不如完全替换有意义，但也不错。话虽如此，隐藏东西对 [社交媒体参与度](https:\/\/twitter.com\/wm\/status\/1577081662848241664) 有好处，而 \u0060k3s\u0060 通过有效地隐藏和打包取得了巨大成功，因此显然提供了一些实实在在的好处。\n', '\/trans\/podless-kubernetes-istio\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索如何将 Kubernetes 和 Istio 的完整功能嵌入到单一二进制文件中，实现无 Pod 的极简部署方案。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/building-a-generative-ai-platform/">[译] 构建生成式人工智能平台：从基础知识到高级实现策略指南</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/26</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/ai"> 
             AI
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://huyenchip.com/2024/07/25/genai-platform.html" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('构建生成式人工智能平台：从基础知识到高级实现策略指南', '探索构建生成式人工智能平台的关键组件与实现策略，从基础架构到高级功能，提供全面的指导和深入分析。', '\n在研究了各公司部署生成式人工智能应用程序的方式后，我注意到他们的平台之间有许多相似之处。本文概述了生成式人工智能平台的常见组件、其功能及其实现方式。我尽量保持架构的通用性，但某些应用可能会有所不同。以下是整体架构的外观。\n\n![生成式 AI 平台概览](1-genai-platform.webp)\n\n这是一个相当复杂的系统。本文将从最简单的架构开始，逐步添加更多组件。在最简单的形式中，你的应用程序接收一个查询并将其发送到模型。模型生成响应，该响应被返回给用户。没有防护措施、没有增强上下文，也没有优化。**模型 API**框指的是第三方 API（例如 OpenAI、Google、Anthropic）和自托管 API。\n\n![生成式 AI 平台概览](2.webp)\n\n从这里开始，你可以根据需要添加更多组件。本文讨论的顺序是常见的，尽管你不需要完全按照相同的顺序操作。如果你的系统运行良好，可以跳过某个组件。开发过程中的每一步都需要进行评估。\n\n1. 通过让模型访问外部数据源和信息收集工具，增强模型的上下文输入。\n2. 设置防护措施，以保护你的系统和用户。\n3. 添加模型路由器和网关，以支持复杂的管道并增加更多安全性。\n4. 通过缓存优化延迟和成本。\n5. 添加复杂逻辑和写操作，以最大化系统的功能。\n\n可观察性和编排是平台的两个重要组件。我们将在本文末尾讨论它们。\n\n**» 本文不涉及的内容 «**\n\n_本文重点讨论部署 AI 应用程序的总体架构。它讨论构建这些组件时需要哪些组件和考虑因素。它不涉及如何构建 AI 应用程序，因此不讨论模型评估、应用程序评估、提示工程、微调、数据注释指南或用于 RAG 的分块策略。所有这些主题都包含在我即将出版的书籍 [AI Engineering](https:\/\/learning.oreilly.com\/library\/view\/ai-engineering\/9781098166298\/) 中。_\n\n## 第一步：增强上下文\n\n平台的初步扩展通常涉及添加机制，允许系统用必要的信息增强每个查询。收集相关信息称为上下文构建。\n\n许多查询需要上下文来回答。上下文中的相关信息越多，模型就越少依赖其内部知识，这可能因其训练数据和训练方法而不可靠。研究表明，访问上下文中的相关信息可以帮助模型生成更详细的回应，同时减少幻觉 ([Lewis et al.](https:\/\/arxiv.org\/abs\/2005.11401), 2020)。\n\n例如，给定查询“Acme 的精美打印机 A300 是否能打印 100 页每秒？”，如果给出了精美打印机 A300 的规格，模型将能够更好地响应。（感谢 Chetan Tekur 举的例子）\n\n上下文构建对于基础模型来说等同于传统 ML 模型的特征工程。它们的目的相同：为模型提供处理输入所需的信息。\n\n在上下文中学习，从上下文中学习，是一种连续学习的形式。它使模型能够持续地整合新信息以做出决策，防止其过时。例如，一个在上周数据上训练的模型，除非将新信息包含在其上下文中，否则无法回答有关本周的问题。通过使用最新信息更新模型的上下文，例如精美打印机 A300 的最新规格，模型保持最新状态，并可以回应超出其截止日期的查询。\n\n### RAGs\n\n上下文构建的最著名模式是 RAG，检索增强生成。RAG 由两个组件组成：一个生成器（例如语言模型）和一个检索器，后者从外部来源检索相关信息。\n\n![生成式 AI 平台概览](3-rag.webp)\n\n检索不仅限于 RAG。它是搜索引擎、推荐系统、日志分析等的支柱。许多为传统检索系统开发的检索算法可以用于 RAG。\n\n外部记忆源通常包含非结构化数据，如备忘录、合同、新闻更新等。它们可以统称为_文档_。一个文档可以有 10 个标记，也可以有 100 万个标记。简单地检索整个文档可能会导致你的上下文长度过长。RAG 通常要求将文档分割成_可管理的块_，这可以根据模型的最大上下文长度和应用程序的延迟要求确定。要了解更多有关分块和最佳块大小的信息，请参见 [Pinecone](https:\/\/www.pinecone.io\/learn\/chunking-strategies\/)、[Langchain](https:\/\/js.langchain.com\/v0.1\/docs\/modules\/data_connection\/document_transformers\/)、[Llamaindex](https:\/\/docs.llamaindex.ai\/en\/stable\/optimizing\/production_rag\/) 和 [Greg Kamradt](https:\/\/www.youtube.com\/watch?v=8OJC21T2SL4) 的教程。\n\n一旦外部记忆源的数据被加载并分块后，检索主要通过以下两种方式执行：\n\n1. **基于术语的检索**  \n   这可以简单到像关键字搜索。例如，对于查询“transformer”，检索包含此关键词的所有文档。更复杂的算法包括 BM25（利用 TF-IDF）和 Elasticsearch（利用倒排索引）。基于术语的检索通常用于文本数据，但它也适用于包含文本元数据（如标题、标签、字幕、评论等）的图像和视频。\n\n2. **基于嵌入的检索**（也称为向量搜索）  \n   你将数据块转换为嵌入向量，使用嵌入模型如 [BERT](https:\/\/arxiv.org\/abs\/1810.04805)，[sentence-transformers](https:\/\/github.com\/UKPLab\/sentence-transformers)，以及 OpenAI 或 Google 提供的专有嵌入模型。根据查询，检索与查询嵌入最接近的数据，这一过程由向量搜索算法确定。\n\n   向量搜索通常被视为最近邻搜索，使用近似最近邻 (ANN) 算法，如 [FAISS](https:\/\/arxiv.org\/abs\/1702.08734)（Facebook AI 相似性搜索），Google 的 [ScaNN](https:\/\/research.google.blog\/announcing-scann-efficient-vector-similarity-search\/)，Spotify 的 [ANNOY](https:\/\/github.com\/spotify\/annoy)，和 [hnswlib](https:\/\/github.com\/nmslib\/hnswlib)（[层次化可导航小世界](https:\/\/arxiv.org\/abs\/1603.09320)）。[ANN-benchmarks 网站](https:\/\/ann-benchmarks.com\/) 在多个数据集上比较了不同 ANN 算法，考虑了索引和查询之间的权衡。\n\n   - **召回率**：算法找到的最近邻居的比例。\n   - **每秒查询数 (QPS)**：算法每秒可以处理的查询数。这对高流量应用至关重要。\n   - **构建时间**：构建索引所需的时间。这个指标特别重要，尤其是如果你需要频繁更新你的索引（例如因为你的数据发生了变化）。\n   - **索引大小**：算法创建的索引的大小，这对评估其可扩展性和存储需求至关重要。\n\n   这种方法不仅适用于文本文档，还适用于图像、视频、音频和代码。许多团队甚至尝试总结 SQL 表和数据框，然后使用这些总结来生成检索用的嵌入。\n\n基于术语的检索比基于嵌入的检索快得多、成本也更低。它可以开箱即用，是一个吸引人的起点。BM25 和 Elasticsearch 在行业中得到了广泛使用，为更复杂的检索系统提供了强大的基线。尽管基于嵌入的检索在计算上开销较大，但随着时间的推移可以显著改进，以超越基于术语的检索。\n\n生产检索系统通常结合了几种方法。结合基于术语的检索和基于嵌入的检索被称为 _混合搜索_。\n\n一个常见的模式是顺序的。首先，一个便宜、精度较低的检索器，如基于术语的系统，获取候选项。然后，一个更精确但更昂贵的机制，如 k-最近邻，找到这些候选中的最佳选项。第二步也称为重排。\n\n例如，给定术语“transformer”，你可以检索所有包含单词 transformer 的文档，无论它们是关于电器设备、神经结构还是电影。然后你使用向量搜索，在这些文档中找到与你的 transformer 查询实际相关的文档。\n\n上下文重排与传统的搜索重排不同，因为项目的确切位置不那么重要。在搜索中，排名（例如第一或第五）至关重要。在上下文重排中，文档的顺序仍然重要，因为它影响模型如何处理它们。模型可能更好地理解上下文开始和结束时的文档，正如论文 [Lost in the middle](https:\/\/arxiv.org\/abs\/2307.03172) (Liu et al., 2023) 所示。然而，只要文档被包含在内，其顺序的影响就比在搜索排名中的影响要小。\n\n另一种模式是集成。记住，检索器通过对查询的相关性评分对文档进行排名。你使用多个检索器同时获取候选项，然后将这些不同的排名结合起来生成最终的排名。\n\n### 带表格数据的 RAGs\n\n外部数据源也可以是结构化的，如数据框或 SQL 表。从 SQL 表检索数据与从非结构化文档检索数据有显著不同。系统的工作流程如下：\n\n1. **文本到 SQL**：根据用户查询和表结构，确定需要什么 SQL 查询。\n2. **SQL 执行**：执行 SQL 查询。\n3. **生成**：根据 SQL 结果和原始用户查询生成响应。\n\n![生成式 AI 平台概览](4-rag-with-tabular-data.webp)\n\n对于文本到 SQL 步骤，如果有很多可用的表格，其架构不能全部适应模型上下文，你可能需要一个中间步骤来预测每个查询使用哪些表格。文本到 SQL 可以由生成最终响应的同一模型或许多专门的文本到 SQL 模型完成。\n\n### 具有代理能力的 RAGs\n\n互联网是一个重要的数据来源。像 Google 或 Bing API 这样的网络搜索工具可以使模型访问丰富、最新的资源，以收集每个查询的相关信息。例如，给定查询“今年谁赢得了奥斯卡？”，系统会搜索有关最新奥斯卡的信息，并使用这些信息为用户生成最终响应。\n\n基于术语的检索、基于嵌入的检索、SQL 执行和网络搜索是模型可以采取的行动，以增强其上下文。你可以将每个动作视为模型可以调用的函数。可以整合外部动作的工作流程也被称为 _具有代理能力_。其架构如下所示。\n\n![生成式 AI 平台概览](5-agentic-rag.webp)\n\n**» 动作与工具 «**\n\n一个工具允许一个或多个动作。例如，一个人员搜索工具可能允许两个动作：按姓名搜索和按电子邮件搜索。然而，差别很小，所以很多人将 _动作_ 和 _工具_ 混为一谈。\n\n**» 只读动作与写入动作 «**\n\n从外部源检索信息但不改变其状态的动作是只读动作。赋予模型写入动作，例如更新表中的值，使模型能够执行更多任务，但也带来了更多风险，稍后将进行讨论。\n\n### 查询重写\n\n通常，需要重写用户查询以增加获取正确信息的可能性。考虑以下对话。\n\n\u0060\u0060\u0060\n用户：John Doe 上次从我们这里购买东西是什么时候？\nAI：John 最后一次从我们这里购买是两周前，即 2030 年 1 月 3 日购买的 Fruity Fedora 帽。\n用户：那 Emily Doe 呢？\n\u0060\u0060\u0060\n\n最后一个问题，“那 Emily Doe 呢？”是模糊的。如果你逐字使用这个查询来检索文档，你可能会得到无关的结果。你需要重写这个查询，以反映用户实际在询问什么。新查询应该本身就有意义。最后一个问题应该被重写为“Emily Doe 上次从我们这里购买东西是什么时候？”\n\n查询重写通常使用其他 AI 模型完成，使用类似于“给定以下对话，重写最后一个用户输入以反映用户实际在询问什么”的提示。\n\n![生成式 AI 平台概览](6-query-rewriting.webp)\n\n查询重写可能会变得复杂，特别是如果你需要进行身份解析或纳入其他知识。如果用户问“他的妻子怎么样？”，你首先需要查询你的数据库来找出他的妻子是谁。如果你没有这个信息，重写模型应该承认这个查询是无法解决的，而不是臆造一个名字，导致错误的答案。\n\n## 第二步：设置防护栏\n\n防护栏有助于减少 AI 风险，保护的不仅是用户，还有开发者。在存在失败潜力的地方应设置防护栏。本文讨论两种类型的防护栏：输入防护和输出防护。\n\n### 输入防护\n\n输入防护通常用于防范两种风险：将私人信息泄露给外部 API，以及执行可能危及系统的不良提示（模型越狱）。\n\n#### 向外部 API 泄露私人信息\n\n当需要将数据发送到组织外部时，使用外部模型 API 会特别有这种风险。例如，员工可能会将公司的秘密或用户的私人信息复制到提示中，并发送到托管模型的位置。\n\n没有万无一失的方法来消除使用第三方 API 时的潜在泄露。然而，你可以通过防护栏来减轻这些风险。你可以使用许多可用的工具之一来自动检测敏感数据。要检测的敏感数据由你指定。常见的敏感数据类别包括：\n\n- 个人信息（身份证号、电话号码、银行账户）。\n- 人脸。\n- 与公司的知识产权或特权信息相关的特定关键词和短语。\n\n许多敏感数据检测工具使用 AI 来识别潜在的敏感信息，例如判断一个字符串是否像一个有效的家庭地址。如果发现一个查询包含敏感信息，你有两个选择：阻止整个查询或从中移除敏感信息。例如，你可以使用占位符 \\[PHONE NUMBER\\] 来掩盖用户的电话号码。如果生成的响应包含此占位符，请使用 PII 可逆字典将此占位符映射回原始信息，以便你可以取消屏蔽它，如下图所示。\n\n![生成式 AI 平台概览](7-reversible-pii-mapping.webp)\n\n#### 模型越狱\n\n试图越狱 AI 模型，让它们说出或做出不良行为，已经成为一种在线运动。尽管有些人可能觉得让 ChatGPT 发表争议性言论很有趣，但如果你的客户支持聊天机器人，带有你的品牌和标志做同样的事情就没那么有趣了。这对于有权访问工具的 AI 系统尤其危险。想象一下，如果用户找到一种方法让你的系统执行一个会破坏你的数据的 SQL 查询。\n\n为了对抗这一点，你应该首先在你的系统上设置防护栏，以便不会自动执行任何有害的操作。例如，没有人工批准，不得执行可以插入、删除或更新数据的 SQL 查询。这种增加的安全性的缺点是它可能会减慢你的系统。\n\n为了防止你的应用程序发表不应该发表的离谱言论，你可以为你的应用程序定义范围外的话题。例如，如果你的应用程序是一个客户支持聊天机器人，它不应该回答政治或社会问题。一个简单的方法是过滤掉包含通常与争议话题相关的预定义短语的输入，如“移民”或“反疫苗”。更复杂的算法使用 AI 来分类输入是否关于预定义的受限话题之一。\n\n如果你的系统中有害提示很少，你可以使用异常检测算法来识别不寻常的提示。\n\n#### 故障管理\n\nAI 模型是概率性的，这意味着如果你再次尝试一个查询，你可能会得到不同的响应。许多故障可以通过基本的重试逻辑来缓解。例如，如果响应为空，尝试再次查询 X 次或直到你得到一个非空响应。同样，如果响应格式错误，再试一次直到模型生成一个格式正确的响应。\n\n然而，这种重试策略可能会增加额外的延迟和成本。一次重试意味着 API 调用次数翻倍。如果在失败后进行重试，用户体验的延迟将会加倍。为了减少延迟，你可以并行进行调用。例如，对于每个查询，不是等待第一个查询失败后再重试，而是同时向模型发送两次查询，获取两个响应，并选择较好的一个。这会增加冗余的 API 调用次数，但保持延迟在可管理的范围内。\n\n处理棘手查询时常常需要人类介入。例如，如果查询包含特定关键短语，你可以将查询转给人工操作员。有些团队使用专门的模型（可能是内部训练的）来决定何时将对话转交给人类。例如，有一个团队在他们的情感分析模型检测到用户开始生气时，会将对话转给人工操作员。另一个团队在一定的对话轮数后转交对话，以防用户陷入无限循环。\n\n### 防护栏权衡\n\n**可靠性与延迟的权衡**：虽然承认防护栏的重要性，但一些团队告诉我延迟更为重要。他们决定不实施防护栏，因为这会显著增加应用的延迟。然而，这些团队属于少数。大多数团队发现增加的风险比增加的延迟更为昂贵。\n\n输出防护栏可能在流式完成模式中不太有效。默认情况下，整个响应在显示给用户之前生成，这可能需要很长时间。在流式完成模式中，新的令牌在生成时即时传输给用户，减少了用户等待看到响应的时间。缺点是，很难评估部分响应，因此不安全的响应可能在系统防护栏判定应该阻止之前被传输给用户。\n\n**自托管与第三方 API 的权衡**：自托管模型意味着你不必将数据发送给第三方，减少了输入防护栏的需求。然而，这也意味着你必须自己实施所有必要的防护栏，而不是依赖第三方服务提供的防护栏。\n\n我们的平台现在看起来是这样的。防护栏可以是独立工具或模型网关的一部分，稍后将进行讨论。如果使用，评分器通常被归类在模型 API 下，因为评分器通常也是 AI 模型。用于评分的模型通常比用于生成的模型小且快。\n\n![生成式 AI 平台概览](8-guardrails.webp)\n\n## 第三步：添加模型路由器和网关\n\n随着应用变得越来越复杂并涉及更多模型，出现了两种类型的工具以帮助你处理多个模型：路由器和网关。\n\n### 路由器\n\n应用程序可以使用不同的模型来响应不同类型的查询。对不同的查询有不同的解决方案有几个好处。首先，这允许你拥有专门的解决方案，如一个专门处理技术故障的模型，另一个专门处理订阅的模型。专门的模型可能比通用模型表现更好。其次，这可以帮助你节省成本。你可以将简单的查询路由到更便宜的模型，而不是所有查询都路由到昂贵的模型。\n\n路由器通常包括**意图分类器**，用于预测用户试图做什么。根据预测的意图，将查询路由到合适的解决方案。例如，对于客户支持聊天机器人，如果意图是：\n\n- 重置密码 -\u003e 将用户路由到关于密码重置的页面。\n- 纠正账单错误 -\u003e 将用户路由到人工操作员。\n- 排查技术问题 -\u003e 将查询路由到为排查故障而微调的模型。\n\n意图分类器还可以帮助你的系统避免超出范围的对话。例如，你可以有一个意图分类器来预测查询是否超出范围。如果查询被认为是不适当的（例如，如果用户询问你在即将到来的选举中会投票给谁），聊天机器人可以礼貌地拒绝参与，使用一个标准回复（“作为一个聊天机器人，我没有投票的能力。如果你有关于我们产品的问题，我很乐意帮助。”）而不浪费一个 API 调用。\n\n如果你的系统有权访问多个动作，路由器可以包括一个**下一步动作预测器**来帮助系统决定下一步采取什么动作。一个有效的动作是如果查询含糊不清，要求澄清。例如，对于查询“Freezing”，系统可能会问，“你是想冻结你的账户还是在谈论天气？”或者简单地说，“对不起，请你详细说明一下。”\n\n意图分类器和下一步动作预测器可以是通用模型或专门的分类模型。专门的分类模型通常比通用模型小且快，允许你的系统使用多个这样的模型，而不会引入显著的额外延迟和成本。\n\n当将查询路由到具有不同上下文限制的模型时，可能需要相应地调整查询的上下文。考虑一个设定为使用 4K 上下文限制的模型的 1,000 令牌查询。然后系统采取一个动作，例如网络搜索，带回 8,000 令牌的上下文。你可以截断查询的上下文以适应最初的模型，或者将查询路由到具有更大上下文限制的模型。\n\n### 网关\n\n模型网关是一个中间层，允许你的组织以统一且安全的方式与不同模型进行交互。模型网关的基本功能是使开发者能够以相同的方式访问不同的模型——无论是自托管模型还是商业 API（如 OpenAI 或 Google）背后的模型。模型网关简化了代码的维护。如果模型 API 发生变化，你只需要更新模型网关，而不是更新所有使用该模型 API 的应用程序。\n\n模型网关是**访问控制和成本管理**。与其将组织的令牌分发给每个需要访问 OpenAI API 的人，不如只允许他们通过模型网关访问，这样可以创建一个集中和受控的访问点。网关还可以实施细粒度的访问控制，指定哪些用户或应用程序应该访问哪个模型。此外，网关还可以监控和限制 API 调用的使用，有效防止滥用和管理成本。\n\n模型网关还可以用来实施回退策略，以克服速率限制或 API 失败（后者不幸很常见）。当主要 API 不可用时，网关可以将请求路由到备用模型，短暂等待后重试，或以其他优雅的方式处理失败。这确保了你的应用程序可以平稳运行，不受中断。\n\n由于请求和响应已经通过网关，这是实施其他功能（如负载平衡、日志记录和分析）的好地方。一些网关服务甚至提供缓存和防护栏。\n\n鉴于网关的实施相对简单，市面上有许多现成的网关。示例包括 Portkey 的[网关](https:\/\/github.com\/Portkey-AI\/gateway)，[MLflow AI Gateway](https:\/\/mlflow.org\/docs\/latest\/llms\/gateway\/index.html)，WealthSimple 的[llm-gateway](https:\/\/github.com\/wealthsimple\/llm-gateway)，[TrueFoundry](https:\/\/docs.truefoundry.com\/docs\/ai-gateway)，[Kong](https:\/\/konghq.com\/products\/kong-ai-gateway)，和 [Cloudflare](https:\/\/developers.cloudflare.com\/ai-gateway\/)。\n\n随着网关和路由器的添加，我们的平台变得更加令人兴奋。与评分一样，路由也在模型网关中进行。用于路由的模型通常比用于生成的模型小且快。\n\n![生成式 AI 平台概览](10-model-gateway.webp)\n\n## 第四步：通过缓存减少延迟\n\n当我与我的朋友 Eugene Yan 分享这篇帖子时，他说缓存可能是 AI 平台中最被低估的组件。缓存可以显著减少应用程序的延迟和成本。\n\n缓存技术也可以在训练期间使用，但由于这篇帖子是关于部署的，我将重点讨论用于推理的缓存。一些常见的推理缓存技术包括提示缓存、精确缓存和语义缓存。提示缓存通常由你使用的推理 API 实现。在评估推理库时，了解它支持哪种缓存机制是有帮助的。\n\n_用于注意力机制的 KV 缓存超出了本讨论的范围。_\n\n### 提示缓存\n\n许多应用中的提示存在重叠的文本段。例如，所有查询可以共享相同的系统提示。提示缓存存储这些重叠段以便重用，因此你只需要处理一次。对于有长系统提示的应用，提示缓存可以显著减少延迟和成本。如果你的系统提示是 1000 个令牌，而你的应用今天生成了 100 万个模型 API 调用，提示缓存将每天为你节省大约 10 亿个重复输入令牌的处理！然而，这并不是完全免费的。与 KV 缓存一样，提示缓存的大小可能相当大，需要显著的工程努力。\n\n提示缓存还适用于涉及长文档的查询。例如，如果许多用户查询与同一长文档（如一本书或代码库）相关，这个长文档可以被缓存以便跨查询重用。\n\n自从 2023 年 11 月 [Gim et al.](https:\/\/arxiv.org\/pdf\/2311.04934) 引入以来，提示缓存已经被纳入模型 API。Google 宣布将在 2024 年 6 月提供名为 [context cache](https:\/\/ai.google.dev\/gemini-api\/docs\/caching) 的功能。缓存的输入令牌与常规输入令牌相比可获得 75% 的折扣，但你需要为缓存存储支付额外费用（编写时为每小时 1 美元\/100 万令牌）。考虑到提示缓存的明显好处，我不会感到惊讶如果它变得和 KV 缓存一样流行。\n\n而 llama.cpp 也有 [prompt cache](https:\/\/github.com\/ggerganov\/llama.cpp\/blob\/master\/examples\/main\/README.md#prompt-caching)，但它似乎只缓存整个提示，并且仅适用于同一聊天会话中的查询。其文档有限，但从阅读代码的情况来看，在一次长对话中，它会缓存之前的消息并只处理最新的消息。\n\n### 精确缓存\n\n如果提示缓存和 KV 缓存是基础模型独有的，那么精确缓存则更为通用和直接。你的系统存储处理过的项目以便稍后在请求确切项目时重用。例如，如果用户要求模型总结一个产品，系统会检查缓存中是否有该产品的总结。如果有，就获取这个总结。如果没有，就总结该产品并缓存总结。\n\n精确缓存也用于基于嵌入的检索，以避免重复的向量搜索。如果传入的查询已经在向量搜索缓存中，就获取缓存的搜索结果。如果没有，就为这个查询执行向量搜索并缓存结果。\n\n缓存对于需要多个步骤（例如思维链）和\/或耗时操作（例如检索、SQL 执行或网络搜索）的查询特别有吸引力。\n\n精确缓存可以使用内存存储来实现快速检索。然而，由于内存存储有限，也可以使用数据库如 PostgreSQL、Redis 或分层存储来平衡速度和存储容量。拥有一个逐出政策对于管理缓存大小和维护性能至关重要。常见的逐出政策包括最近最少使用（LRU）、最少频繁使用（LFU）和先进先出（FIFO）。\n\n缓存一个查询多长时间取决于这个查询被再次调用的可能性有多大。特定于用户的查询，如“我的最近订单的状态如何”，不太可能被其他用户重用，因此不应该被缓存。同样，缓存时间敏感的查询，如“天气如何？”也没有多大意义。有些团队训练一个小型分类器来预测是否应该缓存一个查询。\n\n### 语义缓存\n\n与精确缓存不同，语义缓存不要求传入查询与任何缓存的查询完全相同。语义缓存允许重用相似的查询。想象一下，一个用户问“越南的首都是什么？”模型生成答案“河内”。后来，另一个用户问“越南的首都**_城市_**是什么？”这是同一个问题，但增加了“城市”这个词。语义缓存的思想是系统可以重用答案“河内”，而不是从头计算新查询。\n\n语义缓存只有在你有可靠的方式确定两个查询在语义上是否相似时才有效。一种常见的方法是基于嵌入的相似性，具体操作如下：\n\n1. 对每个查询生成其嵌入，使用嵌入模型。\n2. 使用向量搜索找到与当前查询嵌入最接近的缓存嵌入。假设这个相似度得分是 X。\n3. 如果 X 小于你设置的相似度阈值，认为缓存的查询与当前查询相同，并返回缓存结果。如果不是，处理这个当前查询并将其与其嵌入和结果一起缓存。\n\n这种方法需要一个向量数据库来存储缓存查询的嵌入。\n\n与其他缓存技术相比，语义缓存的价值更为可疑，因为它的许多组件容易失败。其成功依赖于高质量的嵌入、功能性的向量搜索和可靠的相似度度量。设置正确的相似度阈值也可能很棘手，需要大量的试验和错误。如果系统错误地将传入查询视为与另一个查询相似，从缓存中获取的响应将是错误的。\n\n此外，语义缓存可能耗时且计算密集，因为它涉及向量搜索。这种向量搜索的速度和成本取决于你的缓存嵌入数据库的大小。\n\n如果缓存命中率很高，即大部分查询可以通过利用缓存结果有效地回答，那么语义缓存可能仍然值得。然而，在纳入语义缓存的复杂性之前，请确保评估与之相关的效率、成本和性能风险。\n\n## 可观测性\n\n虽然我将可观测性单独分为一节，但它应该从平台构建之初就被整合进去，而不是事后才加入。对于所有规模的项目，可观测性都至关重要，其重要性随着系统复杂性的增加而增加。\n\n### 指标\n\n讨论监控时，大多数人会想到指标。你想追踪的指标取决于你希望了解系统的哪些方面，这是特定于应用程序的。一般而言，有两类指标你可能会追踪：模型指标和系统指标。\n\n系统指标反映了你整个系统的状态。常见的系统指标包括吞吐量、内存使用情况、硬件利用率和服务可用性\/运行时间。本帖将重点介绍模型指标。\n\n模型指标评估你的模型性能，如准确性、毒性和幻觉率。应用程序流程中的不同步骤也有自己的指标。例如，在 RAG 应用中，检索质量常用上下文相关性和上下文精确度来评估。向量数据库的评估可以通过它存储数据所需的存储空间和查询数据所需的时间来进行。\n\n### 日志\n\n关于日志，我的哲学很简单：记录一切。记录系统配置、查询、输出和中间输出。记录组件开始、结束、崩溃等事件。录制日志时，请确保为其标记和 ID，以帮助你了解日志来自系统中的哪里。\n\n记录所有内容意味着你拥有的日志量可能会迅速增长。许多用于自动日志分析和日志异常检测的工具都是由 AI 驱动的。\n\n虽然手工处理日志是不可能的，但每天手工检查你的生产数据，了解用户如何使用你的应用程序是有用的。Shankar 等人（2024）发现，随着开发者与更多数据的互动，他们对什么构成良好和不良输出的看法发生了变化，使他们能够重写他们的提示以增加良好响应的机会，并更新他们的评估流程以捕捉不良响应。\n\n### 跟踪\n\n跟踪是详细记录请求通过各种系统组件和服务的执行路径。在 AI 应用中，跟踪揭示了从用户发送查询到返回最终响应的整个过程，包括系统采取的动作、检索的文档以及发送给模型的最终提示。它还应显示每个步骤所需的时间及其相关成本（如果可测量）。例如，这是 [Langsmith](https:\/\/blog.langchain.dev\/announcing-langsmith\/) 跟踪的可视化表示。\n\n![生成式 AI 平台概览](15-traces.webp)\n\n理想情况下，你应该能够逐步追踪每个查询在系统中的转换。如果查询失败，你应该能够确定出错的确切步骤：是处理不当、检索的上下文不相关，还是模型生成了错误的响应。\n\n## AI 流水线编排\n\nAI 应用可以变得相当复杂，涉及多个模型、从多个数据库检索数据，并使用多种工具。编排器帮助你指定如何将这些不同组件组合（链接）在一起，创建端到端的应用流程。\n\n在高层次上，编排器分两步工作：组件定义和链接（也称为流水线）。\n\n1. **组件定义**  \n   你需要告诉编排器你的系统使用哪些组件，如模型（包括用于生成、路由和评分的模型）、系统可以从中检索数据的数据库以及系统可以采取的操作。与模型网关的直接集成可以简化模型引入，一些编排工具也想成为网关。许多编排器还支持与评估和监控工具的集成。\n\n2. **链接（或流水线）**  \n   你告诉编排器你的系统从接收用户查询到完成任务的步骤顺序。简而言之，链接就是函数组合。以下是流水线的一个示例。\n\n   1. 处理原始查询。\n   2. 根据处理后的查询检索相关数据。\n   3. 将原始查询和检索到的数据组合起来，创建模型预期格式的提示。\n   4. 模型根据提示生成响应。\n   5. 评估响应。\n   6. 如果响应被认为是好的，返回给用户。如果不是，将查询路由到人工操作员。\n\n   编排器负责在步骤之间传递数据，并可以提供工具来确保当前步骤的输出符合下一步骤的预期格式。\n\n设计流程时，尤其对于有严格延迟要求的应用，尽可能并行处理各个步骤。例如，如果你有一个路由组件（决定将查询发送到哪里）和一个 PII 移除组件，它们可以同时进行。\n\n有许多 AI 编排工具，包括 [LangChain](https:\/\/github.com\/langchain-ai\/langchain), [LlamaIndex](https:\/\/github.com\/run-llama\/llama_index), [Flowise](https:\/\/github.com\/FlowiseAI\/Flowise), [Langflow](https:\/\/github.com\/langflow-ai\/langflow), 和 [Haystack](https:\/\/github.com\/deepset-ai\/haystack)。每个工具都有自己的 API，所以我不会在这里展示实际代码。\n\n虽然在开始一个项目时直接使用编排工具很诱人，但首先应该在没有工具的情况下开始构建应用。任何外部工具都会带来额外的复杂性。编排器可能会抽象掉系统工作的关键细节，使系统难以理解和调试。\n\n随着应用开发过程的深入，你可能会发现编排器能让你的工作更轻松。在评估编排器时需要考虑三个方面：\n\n1. **集成和扩展性**  \n   评估编排器是否支持你已经使用或可能在未来采用的组件。例如，如果你想使用 Llama 模型，检查编排器是否支持它。鉴于存在许多模型、数据库和框架，编排器不可能支持所有内容。因此，你还需要考虑编排器的扩展性。如果它不支持特定组件，更改难度如何？\n\n2. **支持复杂流水线**  \n   随着应用复杂性的增加，你可能需要管理涉及多个步骤和条件逻辑的复杂流水线。支持高级功能如分支、并行处理和错误处理的编排器将帮助你有效管理这些复杂性。\n\n3. **易用性、性能和可扩展性**  \n   考虑编排器的用户友好性。寻找直观的 API、全面的文档和强大的社区支持，这些可以显著降低你和你团队的学习曲线。避免使用会启动隐藏 API 调用或引入应用延迟的编排器。此外，确保编排器可以随着应用、开发者和流量的增长有效扩展。\n\n## 结论\n\n这篇文章从基础架构开始，逐步添加组件来应对日益增长的应用复杂性。每次添加都带来了自己的好处和挑战，需要仔细考虑和实施。\n\n虽然组件的分离对于保持系统的模块化和可维护性很重要，但这种分离是流动的。组件之间有许多重叠。例如，模型网关可以与防护栏共享功能。缓存可以在不同的组件中实施，如在向量搜索和推理服务中。\n\n这篇文章比我预期的要长，但仍有许多细节我没有能够进一步探讨，尤其是在可观测性、上下文构建、复杂逻辑、缓存和防护栏方面。我将在即将出版的书籍《AI 工程》中更深入地探讨这些组件。\n\n这篇文章也没有讨论如何服务模型，假设大多数人将使用第三方 API 提供的模型。《AI 工程》还将专门介绍推理和模型优化。\n\n## 参考文献和致谢\n\n特别感谢 [Luke Metz](https:\/\/x.com\/luke_metz), [Alex Li](https:\/\/www.linkedin.com\/in\/findalexli\/), [Chetan Tekur](https:\/\/www.linkedin.com\/in\/chetantekur\/), [Kittipat “Bot” Kampa](https:\/\/www.linkedin.com\/in\/kittipat-bot-kampa-1b1965\/), [Hien Luu](https:\/\/www.linkedin.com\/in\/hienluu\/), 和 [Denys Linkov](https:\/\/www.linkedin.com\/in\/denyslinkov\/) 对本文早期版本的反馈。他们的见解极大地改善了内容。任何剩余的错误都是我的。\n\n我阅读了许多公司分享的案例研究，了解它们如何采用生成式 AI，以下是我最喜欢的一些。\n\n- [构建生成式 AI 产品的思考](https:\/\/www.linkedin.com\/blog\/engineering\/generative-ai\/musings-on-building-a-generative-ai-product?_l=en_US) (LinkedIn, 2024)\n- [我们是如何在 Pinterest 构建 Text-to-SQL 的](https:\/\/medium.com\/pinterest-engineering\/how-we-built-text-to-sql-at-pinterest-30bad30dabff) (Pinterest, 2024)\n- [从想法到现实：通过生成式 AI 提升我们的客户支持](https:\/\/medium.com\/vimeo-engineering-blog\/from-idea-to-reality-elevating-our-customer-support-through-generative-ai-101a2c5ea680) (Vimeo, 2023)\n- [深入探究世界上最智能的电子邮件 AI](https:\/\/www.shortwave.com\/blog\/deep-dive-into-worlds-smartest-email-ai\/) (Shortwave, 2023)\n- [LLM-powered 数据实体分类的大规模实施](https:\/\/engineering.grab.com\/llm-powered-data-classification) (Grab, 2023)\n- [从预测到生成 - 如何加速 Uber 的 AI 之旅](https:\/\/www.uber.com\/blog\/from-predictive-to-generative-ai\/) (Uber, 2024)\n', '\/trans\/building-a-generative-ai-platform\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索构建生成式人工智能平台的关键组件与实现策略，从基础架构到高级功能，提供全面的指导和深入分析。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/securing-istio-addressing-critical-security-gaps-and-best-practices/">保障 Istio 安全：解决关键安全漏洞及最佳实践</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/07/25</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('保障 Istio 安全：解决关键安全漏洞及最佳实践', '探索 Istio 中的关键安全漏洞及其缓解措施，并结合多层安全策略的最佳实践。', '\n## 引言\n\n近期，Wiz 研究团队发布了[博客](\/trans\/sapwned-sap-ai-vulnerabilities-ai-security\/)，揭示了 AI 服务中的租户隔离漏洞，引起了广泛关注。该研究详细阐述了多个 AI 服务供应商存在的安全缺陷，特别是 SAP AI Core 平台。通过合法的 AI 训练过程，研究人员能够绕过 Istio 服务网格中的流量劫持，进而横向移动并接管服务，获取客户的私人文件和云环境凭证。这些发现凸显了当今云服务和管理平台在确保隔离和沙盒环境方面面临的挑战。\n\n{{\u003ccallout tip \u0022关于 UID 1337\u0022\u003e}}\nIstio 选择 UID 1337（leet 的变体）作为 \u0060istio-proxy\u0060 容器中的用户 ID 是为了便于配置并避免权限冲突。这个数字在技术和游戏文化中象征“精英”（elite），有助于防止与其他常规用户 ID 冲突，确保流量管理操作不受权限问题干扰。\n{{\u003c\/callout\u003e}}\n\n在这个背景下，Istio 作为一个重要的服务网格解决方案，同样面临着类似的安全问题，尤其是在 sidecar 注入和流量管理等关键功能上。这篇博客旨在探讨如何保护 Istio 服务网格的安全，并提供一套全面的缓解措施。我们还将讨论多层安全策略如何有效增强 Istio 的安全性，以应对类似 Wiz 报告中提到的挑战。\n\n## 概述\n\nIstio 主要用于管理 Kubernetes 中的东西向流量，提供详细的流量管理功能，如请求路由、负载均衡和故障恢复策略。虽然 Istio 提供了流量加密、认证和授权等安全功能，但它本身不应被视为防火墙。为了确保 Istio 网格中的服务安全，除了使用 Istio 自身的安全功能，还需要结合底层网络和基础设施的安全措施，比如 CNI 和安全容器。此外，微分段技术可以用来实现更细粒度的隔离，提高安全性。\n\n不论是 Sidecar 模式还是 Ambient 模式，都是通过劫持应用程序 Pod 的流量到数据平面代理中进行处理和转发的。如果没有成功拦截到应用程序流量或者被仿冒程序冒充了 Istio 而执行操作，就会有安全漏洞出现。\n\n下图展示了通过绕过或仿冒 Istio 系统用户而造成的安全漏洞存在的位置。\n\n![能够绕过 Istio 中流量劫持的“安全漏洞\u0022](bypass-sidecar-traffic-hijack.svg)\n\n接下来，我们将探讨“安全漏洞”产生的具体情况及应对策略。\n\n## 绕过 Istio Sidecar 注入\n\n### 在命名空间级别禁用注入\n\n- **场景**：应用团队滥用命名空间标签，在命名空间级别禁用 Istio Sidecar 注入。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes 命名空间资源的访问。\n- **监控**：使用策略引擎（如 OPA Gatekeeper）来确保命名空间标签的合规性，定期审查命名空间的配置。\n\n### 在 Pod 级别禁用注入\n\n- **场景**：应用团队滥用 Pod 标签，在 Pod 级别禁用 Istio Sidecar 注入。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：使用 Admission Webhook 强制启用 Sidecar 注入，禁止使用排除标签，定期扫描和审计所有 Pod，确保所有需要的 Pod 都注入了 Sidecar。\n\n## 绕过流量重定向到 Istio Sidecar\n\n### 滥用流量重定向注解\n\n- **场景**：应用团队滥用 Pod 注解，排除特定的入站或出站端口或 IP 地址，从而绕过流量重定向。\n- **缓解策略**：平台团队抽象化应用部署，限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：使用策略引擎来检测和警告不合规的注解使用，定期审查 Pod 注解。\n\n### 滥用 Pod 的 UID\n\n- **场景**：应用团队滥用 UID 1337（sidecar 代理的 ID），绕过 Istio Iptables 重定向规则。\n- **缓解策略**：\n  - 强制所有 Pod 指定非 1337 的 UID。\n  - 检查所有容器镜像以检查 UID 1337 并拒绝这些镜像。此检查可以使用准入 Webhook 或由管理镜像注册表的中央团队来执行。\n- **监控**：禁用或限制 UID 1337 的使用，定期审计 Pod 的 UID 配置，确保没有绕过行为。\n\n### 滥用 Pod 能力（NET_ADMIN、NET_RAW）\n\n- **场景**：应用团队滥用 NET_ADMIN 和 NET_RAW 能力，移除 Istio Iptables 规则。\n- **缓解策略**：平台团队启用 Istio CNI（以避免授予应用团队提升的权限），并限制对原始 Kubernetes Pod 资源的访问。\n- **监控**：定期审查和监控 Pod 的权限配置，确保没有越权行为。\n\n## 绕过入站流量约束\n\n### 滥用 PeerAuthentication\n\n- **场景**：应用团队创建一个针对每个命名空间\/每个工作负载的 PeerAuthentication 资源，启用 PERMISSIVE 认证模式。\n- **缓解策略**：平台团队限制对原始 Istio PeerAuthentication 资源的访问。\n- **监控**：定期审查 PeerAuthentication 配置，确保所有入站流量都按照要求加密。\n\n## 绕过出站流量约束\n\n### 滥用 ServiceEntry\n\n- **场景**：应用团队创建一个 ServiceEntry，直接访问外部服务，而无需经过 Egress 网关。\n- **缓解策略**：平台团队限制对原始 Istio ServiceEntry 资源的访问。\n- **监控**：定期审查 ServiceEntry 配置，确保没有绕过行为。\n\n### 滥用 ExternalName 服务\n\n- **场景**：应用团队创建一个类型为 ExternalName 的 Kubernetes Service，直接访问外部服务，而无需经过 Egress 网关。\n- **缓解策略**：平台团队限制对原始 Kubernetes Service 资源的访问。\n- **监控**：定期审查 Kubernetes Service 的类型配置，确保没有绕过行为。\n\n## 无法控制地更改 Istio Sidecar 配置\n\n### 滥用 Sidecar 资源\n\n- **场景**：应用团队创建一个针对每个工作负载的 Istio Sidecar 资源，并将 \u0060outboundTrafficPolicy\u0060 字段设置为 \u0060ALLOW_ANY\u0060（覆盖可能的全局值 \u0060REGISTRY_ONLY\u0060）。\n- **缓解策略**：平台团队限制对原始 Istio Sidecar 资源的访问。\n- **监控**：定期审查 Sidecar 资源配置，确保没有覆盖全局设置的行为。\n\n### 滥用 EnvoyFilter\n\n- **场景**：应用团队创建 EnvoyFilter，导致与现有 Istio 对象冲突，从而引发 DoS 攻击或违反安全策略。\n- **缓解策略**：平台团队限制对原始 Istio EnvoyFilter 资源的访问。\n- **监控**：定期审查 EnvoyFilter 配置，确保没有不当使用行为。\n\n## 服务网格应作为分层防御的一部分\n\n服务网格被描述为现有安全模型的一个补充层，通过在传统安全控制之上添加更细粒度的安全策略来增强微服务的安全性。然而，文章强调了服务网格无法独立保障微服务的全面安全，而是应当作为整体安全策略的一部分。\n\n![微服务安全分层架构](security-layers.svg)\n\n服务网格主要通过在每个服务实例旁部署一个轻量级的代理（sidecar），来管理和控制网络流量。这使得它能够在网络层面上实现精细的流量控制和策略执行，如流量加密、身份认证和授权。尽管服务网格能够提供诸如流量控制、服务发现和断路器等功能，这些功能本质上是对网络流量的管理，无法解决所有安全问题。例如，它不能替代应用层防火墙、入侵检测系统和数据安全等更传统的安全措施。\n\n此外，服务网格依赖于正确的配置和管理，配置不当可能导致安全漏洞。因此，尽管服务网格是现代微服务架构中不可或缺的一部分，它应该与传统的安全措施相结合，共同构成一个全面的、多层次的安全策略框架。参考[如何通过服务网格增强微服务的安全性](\/trans\/how-service-mesh-layers-microservices-security-with-traditional-security-to-move-fast-safely\/)以进一步了解如何加强服务网格的安全。\n\n## 长期解决方案和社区合作\n\nIstio 社区每年都会进行一次安全审计，见 [2021 年](https:\/\/istio.io\/latest\/blog\/2021\/ncc-security-assessment\/)、[2022 年](https:\/\/istio.io\/latest\/blog\/2023\/ada-logics-security-assessment\/) 的安全审计结果。从结果中我们可以看到，Istio 的安全态势有了很大的提升。确保你的 Istio 服务网格符合[安全最佳实践](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/)。另外，你还需要关注 [Istio CVE 公告栏](https:\/\/istio.io\/latest\/news\/security\/)，或者使用如 [Tetrate Istio Subscription](https:\/\/tetrate.io\/tetrate-istio-subscription\/) 这类工具来扫描 Istio 服务网格的各种 CVE，部署符合 FIPS 并经过 FIPS 验证的 Istio 发行版。\n\n## 结论\n\n服务网格通过在应用程序外部管理控制流，为微服务架构提供了额外的安全层。这允许在不影响应用程序性能的前提下，加强服务之间的通信安全。在部署服务网格时，推荐使用 Istio 的 Egress Gateway 来管理出口流量，结合 Kubernetes 的 NetworkPolicy，确保所有出口流量都必须经过网关，从而防止潜在的数据泄露和其他安全威胁。\n\n## 参考\n\n- [How to enforce egress traffic using Istio’s authorization policies - tetrate.io](https:\/\/tetrate.io\/blog\/istio-how-to-enforce-egress-traffic-using-istios-authorization-policies\/)\n- [Istio Security Best Practice - istio.io](https:\/\/istio.io\/latest\/docs\/ops\/best-practices\/security\/)\n- [Optimize Traffic Management and Security with These Service Mesh Best Practices - tetrate.io](https:\/\/tetrate.io\/blog\/optimize-traffic-management-and-security-with-these-service-mesh-best-practices\/)\n- [Istio publishes results of 2022 security audit - istio.io](https:\/\/istio.io\/latest\/blog\/2023\/ada-logics-security-assessment\/)\n- [Announcing the results of Istio’s first security assessment - istio.io](https:\/\/istio.io\/latest\/blog\/2021\/ncc-security-assessment\/)\n', '\/blog\/securing-istio-addressing-critical-security-gaps-and-best-practices\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索 Istio 中的关键安全漏洞及其缓解措施，并结合多层安全策略的最佳实践。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     
     
     
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/blog/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/blog/page/2/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/blog/page/26/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(70)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(39)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(24)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(21)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(16)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(4)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(1)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/kubecon-china-2024-recap/">KubeCon China 2024 回顾：引领云原生技术的前沿动态</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/black-myth-wukong-game-life/">从黑神话悟空聊起：我心目中的 3A 大作</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-gateway-integration-istio-mesh/">集成 Envoy Gateway 作为 Istio 服务网格中的入口网关</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-meetup-dalian-2024/">2024 大连云原生技术开放日</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>




<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
