<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>博客 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="专注开源技术、云原生与生活随笔的分享与思考。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/blog/" />
  <meta property="og:title" content="博客 | Jimmy Song" />
  <meta property="twitter:title" content="博客 | Jimmy Song" />

  
  <meta property="og:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />
  <meta property="twitter:description" content="专注开源技术、云原生与生活随笔的分享与思考。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/banner/default.jpg" />
  <meta property="twitter:image" content="https://jimmysong.io/images/banner/default.jpg" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xl">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          <li class="nav-item">
            
            
            
              
              
                
                
                
                  
                    
                    <a class="nav-link" href="/en/blog/">English</a>
                    
                  
                
              
              
              
                
                  
                    
                    
                  
                
                
                
              
          </li>
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

<section class="bg-cover page-title-section overlay" style="background-image: url('/images/backgrounds/circle.svg'),url('/images/backgrounds/page-title.webp');background-size: cover;">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <p class="h1">
                    博客
                </p>
                <p class="page-description">
                    专注开源技术、云原生与生活随笔的分享与思考。
                </p>
                
            </div>
        </div>
    </div>
</section>

        


<section class="section-sm book-list-section bg-gray">
  <div class="container-xl">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          
          
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/cilium-annual-report-2024/">Cilium 2024 年度报告解读</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2025/01/07</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%85%b6%e4%bb%96"> 
             其他
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Cilium 2024 年度报告解读', 'Cilium 2024 年度报告回顾成就与技术创新，展望其在云原生网络与安全领域的发展。', '\n近日 Cilium 项目发布了 2024 年度报告，见 [Github](https:\/\/github.com\/cilium\/cilium.io\/blob\/main\/Annual-Reports\/Cilium_Annual_Report_2024.pdf)。这份报告详细回顾了 Cilium 在过去一年中所取得的重大成就，并展望了其在云原生网络和安全领域的未来发展方向。Cilium 项目自首次提交以来，历经近十年发展，其势头持续强劲，正引领云原生网络和安全领域的新变革。\n\n![Cilium 2024 年度报告概述](f1.svg)\n\n## Cilium 的卓越发展\n\n2024 年是 Cilium 发展历程中至关重要的一年，它不仅巩固了其作为 Kubernetes 事实标准 CNI 的地位，更发展成为 Kubernetes 环境下的综合网络堆栈。Cilium 的演进展示了其应对现代云原生环境挑战的卓越能力，从最初的 pod 到 pod 连接方案，扩展到一个统一网络、可观察性和安全性的项目，这一切都由 eBPF 技术驱动。\n\n![Cilium 在 2024 年的演变](f2.svg)\n\n## 关键里程碑与重大成就\n\n![关键里程碑与重大成就](f3.svg)\n\n- **社区蓬勃发展**：Cilium 社区持续壮大，贡献者和贡献公司数量不断增加，用户遍布金融、物流、媒体、电信等众多行业。自加入 CNCF 以来，贡献公司数量增长了 90%，达到 1,011 家，个人贡献者增长了 252%，达到 4,464 人。Cilium 还是 CNCF 生态系统中第三大发展最快的项目。\n- **技术创新**：Cilium 在 2024 年发布了 1.15 和 1.16 两个主要版本，带来了诸多创新功能。\n  - **Cilium 1.15**: 引入了对 Gateway API 1.0 的全面支持，使 Cluster Mesh 的可扩展性翻倍，增强了可观测性，将流量与网络策略关联，并扩展了 BGP 的功能，以更好地集成外部世界。\n  - **Cilium 1.16**: 以“更快、更强、更智能”为主题，通过 netkit 消除了虚拟网络开销，实现了主机和容器之间的性能对等；引入了 BGPv2 API，支持用户定义复杂的网络策略；支持多播数据路径；并显著优化了 CPU 和内存使用，同时将尾部延迟降低了高达 5 倍。\n- **广泛应用**：用户调查显示，Cilium 正在逐步接管 Kubernetes 网络堆栈，Cluster Mesh、BGP 和 Gateway API 等功能已广泛应用于生产环境。95% 的受访者运行多个 Kubernetes 集群，而 Cilium 被 CNCF 技术雷达评为顶级多集群管理工具。\n- **行业认可**：Cilium 荣获 OpenUK 2024 年度开源软件奖。同时，在 CNCF 的多集群管理技术雷达中，Cilium 被评为最值得采用的技术，并在实用性和成熟度方面均获得最高分。\n- **eBPF 安全**：eBPF 基金会发布了两份重要研究报告，提升了基于 eBPF 部署的安全性与操作指导：\n  - **eBPF 安全威胁模型**：详细阐述了 eBPF 的潜在风险，并提供了相应的缓解策略。\n  - **eBPF 验证器代码审计**：强调了验证器在保障 eBPF 部署安全方面的作用，并提出了改进建议。\n\n## 用户反馈与应用案例\n\n来自用户的反馈和案例进一步印证了 Cilium 在性能、成本效益以及功能方面的优势。用户普遍认为，Cilium 有效降低了网络成本和 CPU 消耗，同时提供了卓越的性能和低延迟。此外，Cilium 的可观察性工具（如 Hubble）以及网络策略功能也受到了用户的广泛好评。\n\n## 未来展望\n\n![Cilium 2025 年发展展望](f4.svg)\n\n展望 2025 年，Cilium 的发展势头将持续增强。平台工程和整合趋势正在重塑组织管理 Kubernetes 网络的方式，而 Cilium 正处于这场变革的核心。我们预计：\n\n- Cilium 堆栈将进一步整合网络功能。\n- Tetragon 在高级安全可观察性方面的应用将更加普及。\n- Cilium 将更深入地集成外部和传统工作负载至 Kubernetes 环境。\n- Cilium 不仅会被广泛用作 CNI，更将作为全面的 Kubernetes 网络解决方案。\n- Tetragon 将不断进化，提供更强大的检测能力和更具行动力的威胁响应方案。\n- Cilium 的混合云和多云集成将在 2025 年发挥更大的作用。\n\nCilium 对外部工作负载、4 层负载均衡以及 BGP 增强功能的支持将弥合 Kubernetes 原生系统与传统系统之间的鸿沟。\n\n## 总结\n\nCilium 项目在 2024 年取得了巨大成功，确立了其在 Kubernetes 网络领域的领导地位。Cilium 不仅仅是一个 CNI，更是一个涵盖网络、可观察性和安全性的综合 Kubernetes 网络解决方案。随着云原生技术的不断发展，Cilium 将继续引领行业创新，为用户提供更强大、更可靠的云原生网络解决方案。\n\n**注**：本文中的图片利用 [napkin.ai](https:\/\/www.napkin.ai\/) 制作。\n', '\/blog\/cilium-annual-report-2024\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">Cilium 2024 年度报告回顾成就与技术创新，展望其在云原生网络与安全领域的发展。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-packet-lifecycle-optimization/">Istio Ambient 模式中的数据包生命周期及流量优化</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2025/01/07</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中的数据包生命周期及流量优化', '解析 Istio Ambient 模式下初始数据包的详细处理与后续数据包的快速转发及流量优化策略。', '\n本文围绕 Istio Ambient 模式下的数据包生命周期进行深入剖析，从初始数据包的流量拦截与目标解析，到后续数据包的快速转发与优化策略，帮助读者理解 Ambient 模式背后的技术逻辑和性能实践。\n\n## 数据包生命周期概览：从内核态到用户态\n\n在 Ambient 模式中，数据包的处理路径从 Pod 内核态网络栈开始，经由 \u0060iptables\u0060 规则被拦截后进入 ztunnel 的用户态处理逻辑。ztunnel 负责透明代理、策略验证、加密隧道建立等任务，最终将数据包通过内核态网络再次转发给目标服务或下一个 ztunnel。其核心思想是通过首次数据包的详细解析和标记，为后续数据包铺路，从而减少重复开销。\n\n下图展示了 Istio Ambient 模式中从 Pod 到 ztunnel 的数据包生命周期：\n\n\u0060\u0060\u0060mermaid \u0022Istio Ambient 模式中从 Pod 到 ztunnel 的数据包生命周期\u0022\nsequenceDiagram\n    participant App as 应用程序\n    participant PodKernel as Pod内核态网络栈\n    participant ipt as iptables\n    participant ztunnel as ztunnel 用户态处理\n    participant HostKernel as 主机内核态\n    participant Service as 目标服务或下一个 ztunnel\n\n    rect rgb(240, 249, 255)\n    note over App: 首个数据包路径\n    App-\u003e\u003ePodKernel: 发出首个数据包\n    PodKernel-\u003e\u003eipt: 检查iptables重定向规则\n    ipt-\u003e\u003eztunnel: 将数据包重定向至zTunnel透明代理端口\n    ztunnel-\u003e\u003eztunnel: 提取目标地址 \u0026 策略验证 \u0026 建立隧道\/连接\n    ztunnel-\u003e\u003eHostKernel: 返回处理后的数据包\n    HostKernel-\u003e\u003eService: 转发至目标服务或下一个 ztunnel\n    end\n\n    rect rgb(240, 255, 240)\n    note over App: 后续数据包路径\n    App-\u003e\u003ePodKernel: 发出后续数据包\n    PodKernel-\u003e\u003ePodKernel: 利用 conntrack 匹配已有连接\n    PodKernel-\u003e\u003eztunnel: 数据包直接进入 ztunnel inbound socket（无需iptables重定向）\n    ztunnel-\u003e\u003eztunnel: 无需重复解析 \u0026 复用已有隧道\/连接\n    ztunnel-\u003e\u003eHostKernel: 返回数据包\n    HostKernel-\u003e\u003eService: 转发至目标服务或下一个 ztunnel\n    end\n\u0060\u0060\u0060\n\n![Istio Ambient 模式中从 Pod 到 ztunnel 的数据包生命周期](4c7d5e7ac5168314a5c5de34a39a4f9c.svg)\n\n接下来，我们将详细介绍首个数据包与后续数据包的处理路径，并分析其中的技术要点与优化手段。\n\n## 首个数据包路径：从拦截到目标解析\n\n当应用程序在 Pod 内发出数据包（如 HTTP 请求），数据包首先经过 Pod 的网络命名空间和内核态网络栈进行处理。\n\n### 透明拦截与目标解析\n\n\u0060iptables\u0060 规则对出站流量进行筛选，若发现目标地址为非本地资源且数据包未携带特定标记，则将数据包重定向至 ztunnel 的透明代理端口（如 \u006015006\u0060 或 \u006015008\u0060）。借助 \u0060IP_TRANSPARENT\u0060 和 \u0060SO_ORIGINAL_DST\u0060 选项，ztunnel 可提取数据包的原始目标地址，实现无缝透明代理。\n\n### 用户态处理：策略验证与加密隧道\n\n数据包进入 ztunnel 用户态后，将经历以下处理流程：\n\n1. **策略验证**：RBAC 验证、mTLS 加密判定。\n2. **目标流量处理**：对网格内部流量，通过 HTTP\/2 CONNECT 隧道（HBONE）加密与跨节点传输；对网格外流量，直接通过本地 TCP 连接透传。\n\n完成处理后，ztunnel 基于数据包解析结果建立出站连接（如 HTTP\/2 隧道或明文 TCP），并将数据包送回内核态，最终转发至目标服务或下一个 ztunnel。\n\n## 后续数据包路径：利用 Conntrack 与隧道复用\n\n首个数据包完成解析与策略验证后，Linux 内核的连接跟踪（\u0060conntrack\u0060）记录连接状态与标记。后续数据包无需再次经历复杂的拦截与解析，直接进入 ztunnel 的 inbound socket。\n\n### 连接跟踪与快速转发\n\n后续数据包基于 \u0060conntrack\u0060 跟踪机制，快速到达 ztunnel 的 inbound socket。ztunnel 可直接识别目标地址与安全策略，避免重复的解析与验证。\n\n### 隧道与明文连接优化\n\n1. **HBONE 隧道**：支持多路复用，提高加密流量处理效率。\n2. **明文连接**：对无需加密的流量，直接复用现有 TCP 连接，进一步减少处理开销。\n\n## 技术要点与优化策略\n\n- **透明代理**：利用 \u0060IP_TRANSPARENT\u0060 实现透明流量捕获与目标解析。\n- **内核与用户态高效协作**：首个数据包通过用户态完成深度处理，后续数据包借助 \u0060conntrack\u0060 与 inbound socket 实现快速转发，降低上下文切换成本。\n- **多路复用**：借助 HTTP\/2 隧道实现高效加密与负载均衡，优化传输性能。\n\n## 实践建议\n\n1. **多平台适配**：根据平台特性调整透明代理实现。\n2. **调优与监控**：结合 ztunnel 日志与服务网格监控工具，优化流量路径与性能表现。\n\n## 总结\n\nIstio Ambient 模式通过数据包生命周期设计，在透明代理、性能优化与安全策略间实现平衡。zTunnel 通过高效的用户态处理与内核态快速转发，将应用程序的透明体验与底层网络优化有效结合，助力服务网格的实践与推广。\n', '\/blog\/istio-ambient-packet-lifecycle-optimization\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">解析 Istio Ambient 模式下初始数据包的详细处理与后续数据包的快速转发及流量优化策略。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/trans/istio-ambient-mode-ztunnel-shutdown/">[译] Istio Ambient 模式中 Ztunnel 停止运行时的流量处理机制</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2025/01/07</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fas fa-language"></i>
              <a href="https://blog.howardjohn.info/posts/ztunnel-shutdown/" target="_blank" rel="noopener">原文</a>
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio Ambient 模式中 Ztunnel 停止运行时的流量处理机制', '了解 Istio Ambient 模式中 Ztunnel 停止运行的过程、流量处理机制及如何减少连接中断风险。', '\n关于 Istio 的 Ambient 模式，一个常见的问题是它如何在升级或重启期间处理流量。\n\n在 Sidecar 模型中，代理和应用程序是 1:1 的关系，这种情况下无需担心此类问题——代理在应用程序停止时会关闭，并在应用程序启动时加载最新版本。\n\n然而，Ambient 模式中，每个节点都有一个专用代理（“Ztunnel”），这意味着我们可能需要在应用程序运行时对其进行升级。\n\n## 停止运行的过程\n\nZtunnel 遵循标准的滚动更新流程。也就是说，当我们需要引入新版本时，会按照以下步骤进行：\n\n1. 启动新版本\n2. 当新版本准备就绪后，开始关闭旧版本\n3. 在一段时间内，两个版本会同时运行\n4. 最终，旧版本被关闭\n\n对于 Ztunnel，有两种类型的流量需要考虑：\n\n第一种是当同时运行多个实例时，*新建*连接会发生什么。在非常短的时间内，两个实例都会接受连接（利用 \u0060SO_REUSEPORT\u0060），这些连接由内核随机分配。然而，一旦新实例完全准备就绪，就会通知旧实例停止接受新连接，这样新实例可以开始处理所有新建连接。\n\n第二种是对于我们正在关闭的实例上的*现有*连接会发生什么。虽然应用协议通常具有通知对端停止使用的机制，例如 HTTP\/1.1 可以发送 \u0060Connection: close\u0060 标头，HTTP\/2 可以发送 \u0060GOAWAY\u0060，但 Ztunnel 在 L4 层工作，TCP 本身并没有这样的机制。为此，Ztunnel 使用了一种宽限期机制。只要仍有活动连接，旧实例就会继续运行并服务这些连接（但正如前面提到的，不再处理任何新连接）。最终，如果超出了可配置的宽限期，任何剩余的连接都会被发送 \u0060RST\u0060（连接复位）。\n\n结合起来，从“蓝色版本”升级到“绿色版本”的生命周期如下图所示：\n\n![Ztunnel 升级时间线](ztunnel-shutdown.png)\n\n第一条时间轴显示哪个实例正在积极接受连接。可以看到，这个状态从“蓝色”切换到“绿色”，其中有一个短暂的时间段内两个实例都在接受连接。\n\n第二和第三条时间轴分别显示旧实例和新实例的状态。旧实例在新实例准备就绪后开始其宽限期，最终强制终止所有剩余连接。\n\n## 我的应用程序会受到影响吗？\n\n对大多数人来说，重要的不是内部运作的细节，而是他们的应用程序是否会受到影响。简短的答案是：这取决于情况。\n\n如果你的应用程序存在比宽限期更长的连接，这些连接可能会被重置。具体影响取决于你的应用程序——有些能够更优雅地处理这种情况，而有些则不行。\n\n需要特别注意的是，**在任何时候，新建连接都不会失败**。因此，如果你的应用程序在连接终止后尝试重新建立新连接（这是正确的做法！），那么这个过程始终可以成功。\n\n## 如何减少连接重置的影响？\n\n如果你的应用程序无法很好地处理连接重置，有两种主要的方法可以缓解问题：\n\n第一种方法是确保 Ztunnel 的宽限期比你的最大连接时长更长。许多使用长连接的场景（例如连接池）可以配置连接的最大时长，并在达到最大时长后重新建立连接。如果需要，可以将此值设置得更短。此外，Ztunnel 的宽限期可以通过配置其 \u0060terminationGracePeriodSeconds\u0060 设置来调整——这个值可以设置得相当高，甚至是数小时。\n\n另一种更具侵入性但非常安全的选项是，确保升级过程中节点上没有运行应用程序。这可以通过[给节点打上隔离标记](https:\/\/kubernetes.io\/docs\/reference\/kubectl\/generated\/kubectl_cordon\/)来实现。在大多数情况下，这种方法可能过于繁琐，但如果你将 TCP 连接视为“宠物”（需要精心维护），这种方式可能是值得的。\n\n\u003e 你可能会好奇，为什么节点隔离\/关闭可以 100% 避免连接终止，而 Ztunnel 升级却不能？问题在于，Ztunnel 升级时无法通知应用程序优雅地关闭或终止连接。然而，当应用程序关闭时，它会收到 \u0060SIGTERM\u0060 信号，可以利用该信号进行优雅的关闭。当然，你的应用程序必须正确处理该信号才能获得任何好处！\n', '\/trans\/istio-ambient-mode-ztunnel-shutdown\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">了解 Istio Ambient 模式中 Ztunnel 停止运行的过程、流量处理机制及如何减少连接中断风险。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/envoy-ext-proc-guide/">深入解析 Envoy 外部处理过滤器（ext_proc）</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/20</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/envoy"> 
             Envoy
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('深入解析 Envoy 外部处理过滤器（ext_proc）', '本文详细介绍了 Envoy 的 ext_proc 外部处理过滤器的功能、配置与性能优化策略。通过示例演示，展示了如何配置 Envoy 与实现外部处理服务器，帮助开发人员灵活处理请求与响应。', '\n在微服务架构中，API 网关通常需要对请求和响应进行高级别的处理，如身份验证、数据转换和安全检查。Envoy 提供的 \u0060ext_proc\u0060 外部处理过滤器，是一个强大的工具，通过与 gRPC 服务交互，实现灵活的请求与响应处理。本文将深入解析该过滤器的功能、配置与性能优化策略，帮助开发人员和 DevOps 工程师高效应用该特性。\n\n## ext_proc 与其他过滤器的关系\n\n[\u0060ext_proc\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/filters\/http\/ext_proc\/v3\/ext_proc.proto) 和 Envoy 中的其他 gRPC 接口过滤器（如 [\u0060ext_authz\u0060](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/filters\/http\/ext_authz\/v3\/ext_authz.proto)）在功能上有相似之处，但 \u0060ext_proc\u0060 提供了更强大的功能，支持完整的请求和响应处理。这使其特别适用于需要深度内容检查和修改的应用场景。\n\n你可以通过下面的 Envoy 外部处理过滤器思维导图快速了解 \u0060ext_proc\u0060。\n\n![Envoy ext_proc 思维导图](envoy-ext-proc.svg)\n\n这张思维导图展示了 Envoy \u0060ext_proc\u0060 外部处理过滤器的核心结构和功能模块。\u0060ext_proc\u0060 通过 gRPC 双向流协议与外部服务交互，可灵活处理 HTTP 请求和响应的各个阶段，并支持同步与异步处理。\n\n## ext_proc 工作原理与配置\n\n### 定义与功能\n\n\u0060ext_proc\u0060 是 Envoy 提供的 HTTP 过滤器，支持将请求和响应外包给 gRPC 服务进行处理，允许在外部服务中实现复杂的逻辑，灵活应对业务需求。例如，在安全场景中，\u0060ext_proc\u0060 可用于执行身份验证和授权检查；在数据转换场景中，可以实现数据格式转换与内容过滤。此外，还可用于记录审计日志、动态请求重写以及内容增强等功能，适用于各种企业应用环境中的深度流量管理。\n\n### 工作原理\n\n\u0060ext_proc\u0060 使用双向 gRPC 流与外部服务通信，实现请求和响应处理的实时交互。这使得 Envoy 可以将复杂任务（如身份验证、数据转换和自定义 Header 操作）卸载到外部服务，从而提高灵活性和可扩展性。\n\nEnvoy 发送 \u0060ProcessingRequest\u0060 消息，外部服务返回 \u0060ProcessingResponse\u0060 消息。需要注意的是，每个 HTTP 请求流都会创建一个独立的 gRPC 流，而不会在多个请求之间共享。每个由 Envoy 处理的 HTTP 请求都会创建其专属的 gRPC 流，从而确保请求与响应的隔离和精确管理。\n\n这种设计允许外部服务在请求与响应生命周期的不同阶段进行干预，甚至能够生成全新的响应内容。\u0060\u0060\n\n下图概述 Envoy 外部处理过滤器的处理过程：\n\n\u0060\u0060\u0060mermaid \u0022Envoy ext_proc 流程\u0022\nsequenceDiagram\nparticipant Downstream as 下游服务\nparticipant Envoy as Envoy 网关\nparticipant ExtProc as 外部处理服务\nparticipant Upstream as 上游应用\n\nDownstream-\u003e\u003eEnvoy: 发送请求头\nEnvoy-\u003e\u003eExtProc: 提取请求头信息，发送到外部处理服务\nExtProc--\u003e\u003eEnvoy: 修改、添加或删除请求头，返回修改结果\nEnvoy-\u003e\u003eUpstream: 更新请求头，转发到上游应用\n\u0060\u0060\u0060\n\n![Envoy ext_proc 流程](622cc6601c811db8cc3254fe80f347e3.svg)\n\n### 关键功能\n\n- 请求和响应处理：读取和修改 HTTP 请求和响应的头部、主体和尾部。\n- 灵活性：根据业务需求定义自定义逻辑，弥补内置功能的不足。\n- 异步处理：支持异步处理模式，防止请求阻塞。\n\n### Envoy 配置示例\n\n以下是一个基本的 Envoy 配置示例：\n\n{{\u003cinclude_code  file=\u0022envoy.yaml\u0022\u003e}}\n\n为了理解 Envoy 配置与 gRPC 服务之间的关联，我们需要了解以下配置项如何影响流量处理：\n\n- **grpc_service**: 定义与 gRPC 服务通信的目标地址和集群名，对应 Envoy 配置中的 \u0060ext_proc_cluster\u0060。\n- **processing_mode**: 控制请求头、请求体和响应头等处理阶段的触发行为，决定了何时调用 gRPC 服务。\n- **failure_mode_allow**: 指定当 gRPC 服务失败时是否继续请求处理，确保服务在部分失败场景下的高可用性。\n- **listeners**: 定义了 Envoy 接收请求的网络地址和端口。\n- **filter_chains**: 配置请求的处理链，包括 HTTP 连接管理器和外部处理过滤器。\n- **http_filters**: 列出启用的过滤器，如 \u0060ext_proc\u0060 和 \u0060router\u0060。\n- **clusters**: 定义上游服务和外部处理 gRPC 服务的位置。\n\n详细的配置说明请参考 [Envoy 文档](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/filters\/http\/ext_proc\/v3\/ext_proc.proto)。\n\nEnvoy 使用这些配置选项将请求和响应外包给 gRPC 服务，处理结果通过双向流协议返回，影响请求的转发行为。\n\n### gRPC 服务示例\n\n以下是一个简单的 gRPC 外部处理服务器实现，演示如何通过 \u0060ext_proc\u0060 添加自定义响应头。该实现展示了核心方法的选择和设计决策，例如使用 \u0060Process\u0060 方法持续接收请求和发送响应，确保处理过程的连续性。此外，采用 \u0060HeaderMutation\u0060 配置修改 HTTP 响应头，展现了 gRPC 消息结构与 Envoy 配置的紧密集成，便于动态扩展和灵活管理。\n\n{{\u003cinclude_code file=\u0022ext_proc_demo\/main.go\u0022\u003e}}\n\n预期结果：请求返回状态码 200，响应头中包含自定义头 \u0060x-extproc-hello: Hello from ext_proc\u0060。如果缺少该头，检查以下内容：\n\n- **gRPC 服务是否正常运行**：确认 gRPC 服务器是否已启动并监听端口 \u0060:9000\u0060。\n- **Envoy 配置是否正确**：检查 Envoy 配置文件，确保 \u0060ext_proc\u0060 过滤器已启用，并且 \u0060ext_proc_cluster\u0060 配置无误。\n- **日志和错误排查**：查看 Envoy 和 gRPC 服务器的日志，排查潜在错误。\n\n在本地运行 Envoy 和  gRPC 服务后，使用 \u0060curl\u0060 进行测试：\n\n\u0060\u0060\u0060\nenvoy -c envoy.yaml\ngo run main.go\ncurl -v http:\/\/localhost:8080\n\u0060\u0060\u0060\n\n你将看到包含自定义头 \u0060x-extproc-hello: Hello from ext_proc\u0060 的响应。\n\n你将看到如下图所示的结果。\n\n![示例结果](https:\/\/jimmysong.io\/img\/blog\/envoy-ext-proc-guide\/warp.png)\n\n在 curl 请求的响应中包含了我们自定义的 header \u0060x-extproc-hello: Hello from ext_proc\u0060。\n\n## 统计与监控\n\n\u0060ext_proc\u0060 输出的统计信息位于 \u0060http.\u003cstat_prefix\u003e.ext_proc.\u0060 命名空间，其中 \u0060stat_prefix\u0060 是 HTTP 连接管理器的前缀。常用统计信息包括：\n\n| 指标名称                   | 类型    | 描述                           |\n| -------------------------- | ------- | ------------------------------ |\n| streams_started            | Counter | 启动的 gRPC 流数量             |\n| streams_msgs_sent          | Counter | 发送的消息数量                 |\n| streams_msgs_received      | Counter | 接收的消息数量                 |\n| spurious_msgs_received     | Counter | 接收的违反协议的意外消息数量   |\n| streams_closed             | Counter | 成功关闭的流数量               |\n| streams_failed             | Counter | 产生 gRPC 错误的流数量         |\n| failure_mode_allowed       | Counter | 错误被忽略的次数（根据配置）   |\n| message_timeouts           | Counter | 配置超时内未收到响应的消息数量 |\n| rejected_header_mutations  | Counter | 被拒绝的头部更改数量           |\n| clear_route_cache_ignored  | Counter | 忽略的清理路由缓存请求数量     |\n| clear_route_cache_disabled | Counter | 被禁用的清理路由缓存请求数量   |\n\n详见 [Envoy 文档](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/ext_proc_filter#statistics)。\n\n## 应用场景与优化策略\n\n### 常见应用场景\n\n- 身份验证：外部身份验证服务检查用户凭证。\n- 数据审计：记录请求和响应的数据以满足合规要求。\n- 流量管理：根据动态分析调整流量路由策略。\n\n### 配置说明与优化策略\n\n- 故障恢复与负载均衡：部署多实例 gRPC 服务，使用负载均衡自动转移请求。\n\n- 消息超时与重试配置：\n\n  \u0060\u0060\u0060yaml\n  http_filters:\n    - name: envoy.filters.http.ext_proc\n      config:\n        grpc_service:\n          envoy_grpc:\n            cluster_name: ext_proc_server\n        processing_mode:\n          request_header_mode: SEND\n          response_header_mode: SEND\n        message_timeout: 500ms\n        max_message_timeout: 1000ms\n        failure_mode_allow: false\n  \u0060\u0060\u0060\n\n- 元数据选项与安全策略：\n\n  \u0060\u0060\u0060yaml\n  metadata_options:\n    forwarding_namespaces:\n      untyped: [\u0022custom_namespace\u0022]\n  \u0060\u0060\u0060\n\n## 总结\n\nEnvoy 的 \u0060ext_proc\u0060 过滤器通过灵活的请求和响应处理能力，为微服务架构中的服务治理、数据转换和请求检查提供了强大的支持。正确配置和优化 \u0060ext_proc\u0060 可以显著提高系统的灵活性和可扩展性，满足多样化的业务需求。\n\n## 参考\n\n- [External Processing](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/configuration\/http\/http_filters\/ext_proc_filter)\n- [External Processing Filter (proto)](https:\/\/www.envoyproxy.io\/docs\/envoy\/latest\/api-v3\/extensions\/filters\/http\/ext_proc\/v3\/ext_proc.proto)\n- [go-control-plane](https:\/\/github.com\/envoyproxy\/go-control-plane)\n', '\/blog\/envoy-ext-proc-guide\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">本文详细介绍了 Envoy 的 ext_proc 外部处理过滤器的功能、配置与性能优化策略。通过示例演示，展示了如何配置 Envoy 与实现外部处理服务器，帮助开发人员灵活处理请求与响应。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-ambient-l7-flow-analysis/">深入 Istio Ambient 模式：从 ztunnel 到 Waypoint 代理的 L7 流量路径解析</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/12</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('深入 Istio Ambient 模式：从 ztunnel 到 Waypoint 代理的 L7 流量路径解析', '深入解析 Istio Ambient 模式中的 L7 流量路径，从 ztunnel 到 Waypoint 代理的透明拦截与策略应用。', '\n在 Istio Ambient 模式下，ztunnel 是节点级安全代理，在 L4 层拦截并加密服务间流量。但不负责 L7（如 HTTP）层处理。Ambient 模式中，L7 处理由 Waypoint 代理负责。当 ztunnel 发现目标服务需 L7 处理时，通过 HBONE 协议将流量转发给 Waypoint 代理进行 HTTP 层策略应用和可观察性处理，再由 Waypoint 代理经 ztunnel 转发给目标 Pod，本文将详细阐述这条 L7 流量转发链路。\n\n## Waypoint 代理的角色与责任\n\n在 Istio Ambient 模式中：\n\n- **ztunnel** 负责透明捕获 Pod 间的 L4 流量，提供 mTLS 加密和身份认证。\n\n- **Waypoint 代理** 是一个基于 Envoy 的 L7 代理，处理 HTTP 层的高级路由、策略和可观察性。\n\n当一个请求需要 L7 层策略时（如 \u0060productpage\u0060 调用 \u0060reviews-v1\u0060 服务），**ztunnel 将流量通过 HBONE 隧道转发到 Waypoint Proxy**，由 Waypoint 执行 HTTP 路由和策略。\n\n## L7 流量在 Ambient 模式中的处理路径\n\n下图展示了 L7 流量在 Ambient 模式中的处理路径。\n\n\u0060\u0060\u0060mermaid \u0022L7 流量在 Ambient 模式中的处理路径\u0022\nsequenceDiagram\n    participant SP as 源 Pod (productpage)\n    participant ZT1 as ztunnel (源节点)\n    participant WP as Waypoint Proxy\n    participant ZT2 as ztunnel (目标节点)\n    participant DP as 目标 Pod (reviews-v1)\n\n    SP-\u003e\u003eZT1: 发出请求 (HTTP\/1.1)\n    note over SP,ZT1: 流量被源节点上的 ztunnel 拦截\n    ZT1-\u003e\u003eWP: 封装为 HBONE 请求 (mTLS)\n    note over ZT1,WP: ztunnel 执行透明拦截和加密\n    WP-\u003e\u003eZT2: 应用 L7 策略后转发流量 (mTLS)\n    note over WP,ZT2: Waypoint 应用 L7 策略后发送请求\n    ZT2-\u003e\u003eDP: 解封装并转发到 Pod 应用端口 (TCP)\n    note over ZT2,DP: ztunnel 在目标节点执行流量重定向\n    DP--\u003e\u003eZT2: 响应数据 (TCP)\n    note over DP,ZT2: Pod 返回响应\n    ZT2-\u003e\u003eWP: 封装为 HBONE 响应 (mTLS)\n    WP-\u003e\u003eZT1: 应用 L7 策略后的响应 (mTLS)\n    note over WP,ZT1: Waypoint 应用 L7 策略后的响应数据\n    ZT1-\u003e\u003eSP: 解封装并返回响应 (HTTP\/1.1)\n    note over ZT1,SP: ztunnel 在源节点解封装并返回响应\n\u0060\u0060\u0060\n\n![L7 流量在 Ambient 模式中的处理路径](022a72b18c3091c40cf01bb4fad208a2.svg)\n\n下面两张图片分别展示了源 Pod 和目标 Pod 在同节点和跨节点情况下的 L7 流量处理路径。\n\n![源 pod 和目标 pod 在同一节点上的 L7 流量路径](hbone-same-node.svg)\n\n![源 pod 和目标 pod 在不同节点上的 L7 流量路径](hbone-cross-node.svg)\n\n下面是详细的流量路径。\n\n### 1. 应用请求发出\n\n假设 productpage 应用需要访问 reviews 服务。productpage Pod 内的应用向 \u0060reviews.default.svc.cluster.local:9080\u0060 发起 HTTP 请求。\n\n### 2. ztunnel L4 透明捕获与识别\n\nproductpage Pod 的出站请求首先被所在节点上的 ztunnel 拦截。ztunnel 查看从 Istio 控制面下发的配置，根据目标服务（reviews）的身份和策略，得知该服务需要经过 Waypoint 代理进行 L7 层处理。\n\n### 3. 通过 HBONE 协议转发至 Waypoint\n\nztunnel 并非使用传统的 Envoy-to-Envoy XDS 或原生 TCP\u002bmTLS 隧道，而是通过 **HBONE 协议** 与 Waypoint 代理通信。HBONE 是 Istio Ambient 模式中专门设计的无 Sidecar L7 路由协议，基于 HTTP\/2，可在透明模式下对流量进行叠加转发，从而实现灵活的服务拓扑和策略控制。\n\n在这一阶段，ztunnel 会将 L4 流量封装到 HBONE 隧道中，发送给相应的 Waypoint 代理。\n\n### 4. Waypoint 代理的 L7 策略与遥测处理\n\nWaypoint 代理（目前仍基于 Envoy 实现）收到通过 HBONE 隧道传来的流量后，通过 TLS 配置和客户端证书校验，确保下游（ztunnel）是已被认证的受信主体。它将下游客户端的身份信息（SPIFFE ID）和其他上下文元数据提取出来，以便在 L7 层策略决策中使用。\n\n执行的操作包括：\n\n- 基于 HTTP Path\/Host 的路由和流量拆分\n- 基于 Headers 的访问控制和认证策略\n- 故障注入、熔断、限流\n- 遥测数据收集（请求时延、错误率、Tracing、Metrics、Logs）\n\n完成 L7 处理后，Waypoint 代理再通过 HBONE 将流量传回到目标节点的 ztunnel。\n\n### 5. 流量到达目标 Pod\n\n目标节点上的 ztunnel 会从 Waypoint 代理接收处理过的流量（同样通过 HBONE 隧道传递），然后解封装并将流量传递给对应的 reviews Pod 中的应用容器端口。\n\n## 洞察与关键点总结\n\n### 1. Waypoint 并不知道 ztunnel 的存在\n\n- Waypoint 代理只知道目标 Pod 的 IP 地址，但目标端口被重写为 \u006015008\u0060。\n- Kubernetes \u0060iptables\u0060 规则将流量透明重定向到 ztunnel。\n\n### 2. 流量安全性：端到端加密与身份认证\n\n- 双向 TLS（mTLS）和 SPIFFE ID 校验确保了端到端安全。\n- 无法绕过 ztunnel，确保了零信任架构的完整实施。\n\n### 3. 完全透明的流量控制\n\n- 应用开发人员无需更改任何代码。\n- 流量控制、策略和可观察性完全在数据面层面透明执行。\n\n## 如何调试？\n\n在 Ambient 模式下，调试方式也有了一些变化：\n\n- **ztunnel 调试**：\n  - Istio 引入了新的 \u0060istioctl ztunnel\u0060 子命令来协助查看和调试 ztunnel 的配置与状态。\n\n- **waypoint 调试**：\n  - 虽然 Waypoint 代理仍然是 Envoy，所以仍然可以使用 \u0060istioctl pc\u0060 和 \u0060istioctl ps\u0060 来查看其路由、集群和监听器配置。\n  - \u0060istioctl waypoint\u0060 提供了更直观的配置查看和状态检查功能。\n\n## 总结\n\nIstio Ambient 模式通过 ztunnel 来处理 L4 流量并实现零信任加密与传输，再通过 Waypoint 代理为需要 L7 策略的请求提供集中处理。两者之间通过 HBONE 协议进行高效、透明的通信，实现比传统 Sidecar 模式更轻量且易于运维的架构。\n', '\/blog\/istio-ambient-l7-flow-analysis\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入解析 Istio Ambient 模式中的 L7 流量路径，从 ztunnel 到 Waypoint 代理的透明拦截与策略应用。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/building-private-ai-knowledge-base-anythingllm/">探索 AnythingLLM：借助开源 AI 打造私有化智能知识库</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%b7%a5%e5%85%b7"> 
             工具
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('探索 AnythingLLM：借助开源 AI 打造私有化智能知识库', '探索如何使用开源项目 AnythingLLM 构建私有化智能知识库。通过 RAG 技术，将文档转化为可检索向量，结合大语言模型实现高效问答，适用于企业与个人开发者。', '\n随着大语言模型（LLM）的快速发展，将企业内部知识库与 AI 工具结合成为热门解决方案。作为一名技术探索者，我对构建私有知识库充满兴趣，也希望测试 LLM 的能力，尤其是像 Ollama 和千问这类模型。此外，AnythingLLM 是一个开源项目，具有较高的社区关注度，因此我决定对其进行深入调研。\n\n基于 RAG（检索增强生成）技术，[AnythingLLM](https:\/\/anythingllm.com\/) 提供了从数据处理到用户界面的全栈解决方案，支持构建企业内部的智能知识库。其模块化架构和灵活部署方式，使其成为企业和个人开发者进行知识管理和 AI 项目实践的重要工具。\n\n## RAG 原理概述\n\n### 简介\n\n**RAG（Retrieval-Augmented Generation）** 是一种结合了信息检索和语言模型的技术。它通过从大规模的知识库中检索相关信息，并利用这些信息来指导语言模型生成更准确和深入的答案。这种方法由 Meta AI 研究人员在 2020 年提出，旨在解决大型语言模型在信息滞后、模型幻觉、私有数据匮乏和内容不可追溯等问题。\n\n**RAG 就是可以开卷回复的 LLM**。其发展历程：**Naive RAG** 包含索引、检索、生成三步，存在 **召回率低、Prompt 拼接问题**。**Advanced RAG** 优化索引与检索，引入 **预检索、后检索策略与数据清洗** 提升效率。**Modular RAG** 实现 **模块化流水线与端到端训练**，具备更高的 **灵活性与适应性**。\n\n### 背景与挑战\n\n尽管 LLM 在处理复杂任务方面表现出色，但在以下三个方面存在局限：\n\n- **知识局限性**：大模型的训练数据来自公开数据源，无法访问非公开和实时数据。\n- **幻觉问题**：模型有时会生成错误答案，特别是在缺少特定领域知识时。\n- **数据安全性**：涉及内部私有数据时，企业面临数据泄露风险。\n\nRAG 技术通过向量检索与生成模型结合，显著提高了数据处理的深度和准确性。\n\n### 工作原理\n\nRAG 的工作流程包括两个主要阶段：\n\n1. **数据准备阶段**\n\n    - 将内部私有数据向量化存入数据库，构建检索索引。\n\n2. **用户应用阶段**\n\n    - 根据用户的 Prompt 检索相关内容，将结果与原 Prompt 组合，生成模型回答。\n\n通过这种方式，RAG 可以搭建团队内部的本地知识库，弥补大模型的知识局限性，解决幻觉和数据隐私问题。然而，RAG 也存在一些主要限制：\n\n- **数据依赖性强**：RAG 系统的效果严重依赖于内置知识库的数据质量和覆盖范围。\n\n- **检索准确性受限**：检索算法可能因索引构建不完善或查询表达模糊导致相关性降低。\n\n- **模型推理成本高**：大型语言模型的推理消耗大量资源，尤其在频繁查询和大规模应用场景中。\n\n- **技术复杂度高**：构建和维护 RAG 系统需要强大的数据管理与模型集成能力，涉及嵌入、索引构建和检索优化等多个复杂组件。\n\n- **响应延迟与性能瓶颈**：在高负载下，检索与推理过程可能导致响应速度变慢，尤其在硬件性能受限的环境中。\n\n## AnythingLLM 简介\n\n**AnythingLLM** 是 Mintplex Labs Inc. 开发的一款开源 ChatGPT 等效工具，用于在安全的环境中与文档进行交互。它融合了从数据处理到用户界面的所有技术，适用于构建个人或企业私有化的知识库。\n\n### 核心特点\n\n- **多用户支持和权限管理**：支持多个用户和不同权限设置。\n- **支持多种文档类型**：PDF、TXT、DOCX、JSON 等。\n- **内置数据连接器**：GitHub、GitLab、YouTube、链接抓取、Confluence 等。\n- **多种向量数据库支持**：如 LanceDB（默认）、Pinecone、Weaviate 等。\n- **灵活的 LLM 集成**：支持 OpenAI、Azure OpenAI、Ollama、LM Studio、LocalAI 等。\n- **成本节约措施**：大文档只需嵌入一次，显著降低成本。\n- **开发者 API 支持**：便于自定义和扩展。\n\n![在 AnythingLLM 中选择 LLM](https:\/\/jimmysong.io\/img\/blog\/building-private-ai-knowledge-base-anythingllm\/ollama.webp)\n\n### 技术架构\n\n- **收集器（Collector）**：将本地或在线资源转化为 LLM 可用格式。\n- **前端（Frontend）**：基于 ViteJS 和 React 构建的用户界面。\n- **服务器（Server）**：基于 NodeJS 和 Express 的后端，管理数据库和 LLM 交互。\n\n#### 构建自己的知识库：详细步骤\n\n要在 AnythingLLM 中构建一个私有知识库，可以按照以下步骤操作：\n\n1. **上传文档**：将 PDF、TXT、DOCX、JSON 等支持的文档格式上传到系统中。\n2. **嵌入向量生成（Embedding）**：\n\n    - 使用配置的嵌入模型（如 OpenAI、Azure OpenAI、LocalAI）将文档转化为向量数据。\n    - 确保配置正确的嵌入模型以匹配项目需求。\n\n3. **存储到向量数据库**：\n\n    - 选择适合的向量数据库，如 LanceDB（默认）、Pinecone、Weaviate。\n    - 配置数据库连接，保证数据安全和高效检索。\n\n4. **查询与回答**：\n\n    - 用户输入查询，系统将其转化为查询向量。\n    - 向量数据库检索最匹配的内容，调用大语言模型（如 OpenAI GPT）生成答案。\n    - 返回最终答案，链接相关文档和参考。\n\n##### 流程图示：\n\n\u0060\u0060\u0060mermaid \u0022构建知识库流程\u0022\ngraph TD\nA[上传文档] --\u003e B[嵌入模型生成向量数据]\nB --\u003e C[存储到向量数据库]\nC --\u003e D[用户输入查询]\nD --\u003e E[查询向量匹配数据库]\nE --\u003e F[调用大模型生成答案]\nF --\u003e G[返回结果与参考文档]\n\u0060\u0060\u0060\n\n![构建知识库流程](5587c3855cc19cfb95184d6e784543a3.svg)\n\n通过该流程，可以有效构建支持高效查询和生成回答的智能知识库。\n\n### 在 Docker 中安装 AnythingLLM\n\n参考：[Docker 安装指南](https:\/\/github.com\/Mintplex-Labs\/anything-llm\/blob\/master\/docker\/HOW_TO_USE_DOCKER.md)\n\n\u0060\u0060\u0060bash\nexport STORAGE_LOCATION=$HOME\/anythingllm \u0026\u0026 \\\nmkdir -p $STORAGE_LOCATION \u0026\u0026 \\\ntouch \u0022$STORAGE_LOCATION\/.env\u0022 \u0026\u0026 \\\ndocker run -d \\\n--cap-add SYS_ADMIN \\\n--network host \\\n--add-host=host.docker.internal:host-gateway \\\n-v ${STORAGE_LOCATION}:\/app\/server\/storage \\\n-v ${STORAGE_LOCATION}\/.env:\/app\/server\/.env \\\n-e STORAGE_DIR=\u0022\/app\/server\/storage\u0022 \\\nmintplexlabs\/anythingllm\n\u0060\u0060\u0060\n\n注意：使用 host network，否则容器中无法与 Ollama 通信。\n\n若要在本机运行 Ollama，可以使用下面的命令：\n\n\u0060\u0060\u0060bash\nollama run qwen2.5:14b --keepalive 0\n\u0060\u0060\u0060\n\n这将会运行 qwen2.5:14b，你也可以选择其他大模型。\n\n打开浏览器：[http:\/\/localhost:3001](http:\/\/localhost:3001)\n\n\u003e 注意：必须选择要接入的 LLM，可以使用 \u0060local\u0060 或 \u0060cloud\u0060\n\n### Desktop 部署\n\nAnythingLLM 内置的 LLM 引擎支持下载流行的模型如 LLama-3、Phi-3 等，支持 CPU 和 GPU。本地运行适用于试用其基本功能。\n\n参考：[Desktop 安装概览](https:\/\/docs.anythingllm.com\/installation-desktop\/overview)\n\n\u003e **局限性**：缺少多用户支持、浏览器插件、用户和 Workspace 管理等功能。\n\n![AnythingLLM 的对话界面](https:\/\/jimmysong.io\/img\/blog\/building-private-ai-knowledge-base-anythingllm\/chat.webp)\n\n## 使用体验与问题记录\n\n如果你的电脑性能堪忧的话，强烈不建议你在本地运行大模型。你会遇到各种性能问题，例如下面看到的，在上传文件嵌入到 Workspace 时卡住了。\n\n![本地运行大模型时遇到性能问题](https:\/\/jimmysong.io\/img\/blog\/building-private-ai-knowledge-base-anythingllm\/stuck.webp)\n\n### 性能与硬件限制\n\n- **构建向量数据库特别慢**：支持的文档格式很多，但在我的 MacBook Pro 2015（16G 内存，无 M 系列芯片）上，构建向量数据库的过程非常耗时。这是因为文档需要被嵌入模型处理成高维向量，并存储到数据库中。该过程涉及复杂的计算和大量内存操作，导致处理一个 7M 的 JSON 数据需要 3 分钟，而嵌入（Embed）到 Workspace 则需十几分钟，且时常失败。\n- **高性能需求**：由于硬件性能受限，运行本地 LLM 十分吃力。运行 Ollama 尚可，但进行 RAG 操作时性能明显不足。\n\n### 查询与响应延迟\n\n- **响应慢**：在聊天模式下，系统反馈非常慢，通常需要等待几分钟才能得到回复。\n\n### 常见错误提示与解决方案\n\n- **查询执行失败**：遇到错误提示 \u0060Failed to execute query stream: Invalid input, No vector column found to match with the query vector dimension: 4096\u0060。\n    - **解决方案**：查看官方问题跟踪 [[BUG]: Could not respond to message. LanceDBError: No vector column found to create index #1131](https:\/\/github.com\/Mintplex-Labs\/anything-llm\/issues\/1131)。\n\n#### 如何改善用户体验\n\n1. **使用商用大模型 API**：\n\n    - 如果硬件资源有限，可以考虑使用 OpenAI、Azure OpenAI 等商用大模型 API。这些服务在稳定性和性能方面具有优势，尤其适用于大规模文档处理和实时查询。\n\n2. **优化硬件环境**：\n\n    - 使用带有 GPU 加速的现代硬件，推荐内存不低于 32GB，显卡支持 CUDA 的 GPU（如 NVIDIA RTX 系列）来显著提升向量嵌入和模型推理速度。\n\n3. **调整 AnythingLLM 配置**：\n\n    - **Chat Setting（聊天设置）**：配置聊天相关参数，包括模型选择、响应超时、查询历史记录存储策略等。\n    - **Agent 设置**：根据项目需求启用不同类型的代理，如检索代理、对话代理和任务代理。\n    - **资源分配与性能优化**：在 Docker 或 Kubernetes 部署环境中，设置 CPU、内存和 GPU 加速参数。调整嵌入批处理大小（Batch Size）、线程池大小等性能参数，优化推理与检索性能。\n\n4. **分布式部署与扩展**：\n\n    - **Kubernetes 集群部署**：\n        - 使用 Kubernetes 编排多个 AnythingLLM 实例，确保高可用性和自动扩展能力。\n        - 部署配置包括 ReplicaSet、Pod 自动缩放（HPA）、负载均衡（Service）、存储卷（PersistentVolumeClaim）等。\n    - **云服务部署**：\n        - 在云平台上运行托管服务，使用容器服务管理。\n        - 配置高性能数据库（如 RDS、Firestore），并启用 CDN 加速文件传输。\n    - **数据库和缓存扩展**：\n        - 使用分布式数据库（如 Redis、Pinecone、Weaviate）提高查询速度。\n        - 启用数据库主从复制与自动备份，确保数据持久性和高可用性。\n\n5. **升级数据库存储方案**：\n\n    - 替换默认数据库 LanceDB，考虑使用更高性能的向量数据库如 Pinecone、Weaviate 等，以减少查询延迟。\n\n6. **代码优化与插件扩展**：\n\n    - 定制插件来适配特定任务，并启用数据缓存机制以减少频繁查询对资源的消耗。\n\n## 总结与展望\n\n**AnythingLLM** 是一个功能全面的 RAG 解决方案，适用于企业内部知识库构建。通过结合向量检索与大语言模型，该平台提供了强大的文档问答能力。然而，部署和定制化需要一定的技术投入。未来的改进方向包括增强多数据库支持、更灵活的嵌入模型选择以及提升文档解析能力。\n', '\/blog\/building-private-ai-knowledge-base-anythingllm\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索如何使用开源项目 AnythingLLM 构建私有化智能知识库。通过 RAG 技术，将文档转化为可检索向量，结合大语言模型实现高效问答，适用于企业与个人开发者。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/migrate-to-istio-telemetry-api/">从 MeshConfig 迁移到 Istio Telemetry API：提升网格观测性和灵活性</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/11</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('从 MeshConfig 迁移到 Istio Telemetry API：提升网格观测性和灵活性', '通过迁移到 Telemetry API 配置 SkyWalking 提供商，从而提升 Istio 网格的追踪能力和灵活性。', '\nIstio 的 Telemetry API 是替代传统 MeshConfig 遥测配置的现代化方式，提供了更灵活的工具来定义服务网格中的 **Tracing**、**Metrics** 和 **Access Logging**。相比传统的 \u0060EnvoyFilter\u0060 和 \u0060MeshConfig\u0060，Telemetry API 更具模块化、动态更新和跨层次配置能力。\n\n在本篇中，我们将详解如何使用 Telemetry API 配置 Istio 遥测功能，涵盖 Tracing、Metrics 和 Logging 的具体实现，同时展示如何迁移过时的 MeshConfig 配置。\n\n## Telemetry API 发展历程\n\nIstio 的遥测能力在早期版本中依赖于较为传统的配置方法，如 **Mixer** 和 **MeshConfig** 的 \u0060configOverride\u0060，这些方法虽然能够满足基本需求，但在复杂场景下显得力不从心。为了解决这些问题，Istio 引入了基于 CRD 的 **Telemetry API**。\n\n### 关键版本更新\n\n为了帮助读者了解 Telemetry API 的进化过程，以下是一些重要版本的更新信息：\n\n1. **Istio 1.11**：引入 Telemetry API（Alpha），提供了基本的指标和日志自定义功能。\n2. **Istio 1.13**：支持 OpenTelemetry 日志记录、自定义追踪服务名称，以及更强的日志过滤功能。\n3. **Istio 1.18**：默认不再安装 Prometheus 的 \u0060EnvoyFilter\u0060，完全依赖 Telemetry API 定义遥测行为。\n4. **Istio 1.22**：Telemetry API 升级为稳定版（v1），全面支持生产环境需求。\n\n## 为什么迁移到 Telemetry API？\n\n尽管传统的 MeshConfig 和 EnvoyFilter 提供了基础的遥测能力，但它们的配置方式在灵活性、动态性和扩展性方面存在诸多限制。为了更清晰地理解这些局限性，我们将从几个关键维度展开说明。\n\n### 使用 MeshConfig 和 EnvoyFilter 的复杂性\n\n在介绍具体问题之前，我们先了解一下 MeshConfig 和 EnvoyFilter 的定位：MeshConfig 适用于全局配置，而 EnvoyFilter 用于细粒度的自定义。但正是这种分工，导致了它们在管理上的复杂性。\n\n#### 1. 配置方式分散\n- **MeshConfig** 用于集中定义全局网格行为，例如访问日志路径、追踪采样率和指标维度。虽然适合简单场景，但无法满足命名空间级或工作负载级的需求。\n- **EnvoyFilter** 则可以覆盖或扩展 Envoy 的配置，允许更细粒度的控制。但这种方式直接操作 Envoy 内部结构（xDS 字段），配置语言复杂且容易出错。\n\n  **示例：通过 MeshConfig 配置访问日志**\n  \u0060\u0060\u0060yaml\n  apiVersion: install.istio.io\/v1alpha1\n  kind: IstioOperator\n  spec:\n    meshConfig:\n      accessLogFile: \/dev\/stdout\n  \u0060\u0060\u0060\n  **问题**：\n  - 无法为特定服务或命名空间设置不同的日志路径。\n  - 需要重新应用整个配置，动态性不足。\n\n  **示例：通过 EnvoyFilter 自定义指标**\n  \u0060\u0060\u0060yaml\n  apiVersion: networking.istio.io\/v1alpha3\n  kind: EnvoyFilter\n  metadata:\n    name: custom-metric-filter\n    namespace: mynamespace\n  spec:\n    workloadSelector:\n      labels:\n        app: myapp  # 选择特定的工作负载\n    configPatches:\n      - applyTo: HTTP_FILTER\n        match:\n          context: SIDECAR_INBOUND  # 匹配入站流量\n        patch:\n          operation: ADD\n          filterClass: STATS  # 指定为统计过滤器\n          value:\n            name: istio.request_operation  # 自定义指标名称\n            typed_config:\n              \u0022@type\u0022: type.googleapis.com\/udpa.type.v1.TypedStruct\n              type_url: type.googleapis.com\/envoy.extensions.filters.http.wasm.v3.Wasm\n              value:\n                config:\n                  configuration: |\n                    \u0022attributes\u0022: [\n                      {\n                        \u0022output_attribute\u0022: \u0022istio_operationId\u0022,\n                        \u0022match\u0022: [\n                          {\n                            \u0022value\u0022: \u0022GetReviews\u0022,\n                            \u0022condition\u0022: \u0022request.url_path == \u0027\/reviews\u0027 \u0026\u0026 request.method == \u0027GET\u0027\u0022\n                          }\n                        ]\n                      }\n                    ]\n                vm_config:\n                  runtime: envoy.wasm.runtime.null\n                  code:\n                    local: { inline_string: \u0022envoy.wasm.attributegen\u0022 }\n  \u0060\u0060\u0060\n  **问题**：\n  - 配置语法复杂且冗长，需深入理解 Envoy 的结构。\n  - 易于出错，调试和维护成本高。\n\n#### 2. 动态性不足\n\n虽然现代微服务环境强调动态调整配置，但 MeshConfig 和 EnvoyFilter 的动态性支持有限：\n\n- **MeshConfig**：修改配置通常需要重启代理或重新应用整个配置，导致服务中断。\n- **EnvoyFilter**：更新流程复杂，调整单个参数也需重新部署相关代理实例。\n\n#### 3. 多租户支持困难\n\n在多租户环境中，针对不同命名空间或工作负载自定义遥测配置非常重要。然而：\n\n- **MeshConfig**：无法针对命名空间或工作负载进行差异化设置。\n- **EnvoyFilter**：需要编写多个过滤器配置，增加了管理复杂性。\n\n#### 4. 难以扩展和调试\n\n- MeshConfig 和 EnvoyFilter 对新需求（如 OpenTelemetry）支持较慢。\n- EnvoyFilter 的调试难度高，需要深入分析 Envoy 日志和行为。\n\n### 弃用传统 MeshConfig 的遥测配置\n\n鉴于上述局限性，Istio 社区已经将传统的 MeshConfig 遥测配置标记为**弃用**。以下示例展示了这些配置的使用方式及其不足之处：\n\n- **Access Logging 配置**：\n  \n  \u0060\u0060\u0060yaml\n  meshConfig:\n    accessLogFile: \/dev\/stdout\n  \u0060\u0060\u0060\n  \n- **Trace Sampling 配置**：\n  \u0060\u0060\u0060yaml\n  meshConfig:\n    enableTracing: true\n    extensionProviders:\n    - name: zipkin\n      zipkin:\n        service: zipkin.istio-system.svc.cluster.local\n        port: 9411\n  \u0060\u0060\u0060\n  \n- **自定义 Metrics 标签**：\n  \u0060\u0060\u0060yaml\n  meshConfig:\n    telemetry:\n      v2:\n        prometheus:\n          configOverride:\n            inboundSidecar:\n              metrics:\n                - name: requests_total\n                  dimensions:\n                    user-agent: request.headers[\u0027User-Agent\u0027]\n  \u0060\u0060\u0060\n\n通过上述例子可以看出，这些配置的灵活性和扩展性明显不足，难以应对复杂的生产环境需求。\n\n## Telemetry API 的优势\n\n在传统配置方式的基础上，Telemetry API 带来了多项改进，使其更适合现代化的服务网格管理需求：\n\n1. **模块化设计**：Tracing、Metrics 和 Access Logging 独立配置，清晰简洁。\n2. **动态更新**：支持实时更新配置，无需重启代理。\n3. **层级化支持**：允许全局、命名空间和工作负载级别的配置覆盖。\n4. **简单直观**：使用声明式语法，无需深入理解 Envoy 的内部结构。\n\n## Istio Telemetry API 配置示例\n\n### 全局配置示例\n\n为帮助理解 Telemetry API 的具体使用，我们以全局配置示例作为开始：\n\n\u0060\u0060\u0060yaml\napiVersion: telemetry.istio.io\/v1alpha1\nkind: Telemetry\nmetadata:\n  name: mesh-default\n  namespace: istio-system\nspec:\n  accessLogging:\n  - providers:\n    - name: envoy # better to use a built-in one\n  tracing:\n  - providers:\n    - name: \u0022skywalking\u0022\n    randomSamplingPercentage: 100.00\n  metrics:\n  - overrides:\n    - match:\n        metric: REQUEST_COUNT\n        mode: CLIENT\n      tagOverrides:\n        x_user_email:\n          value: |\n            \u0027x-user-email\u0027 in request.headers ? request.headers[\u0027x-user-email\u0027] : \u0027empty\u0027\n    providers:\n    - name: prometheus\n\u0060\u0060\u0060\n\n### 使用 Telemetry API 配置 SkyWalking\n\n我们再以配置 SkyWalking 的采样率和 span tag 为例，演示如何使用 Telemetry API。\n\n#### 检查 Istio 版本与 CRD\n\n- 如果使用 Istio 1.22 或更高版本，使用 \u0060telemetry.istio.io\/v1\u0060。\n- 对于 Istio 1.18 至 1.21 的用户，使用 \u0060telemetry.istio.io\/v1alpha1\u0060。\n\n通过以下命令检查 Telemetry API 的 CRD 是否已安装：\n\n\u0060\u0060\u0060bash\nkubectl get crds | grep telemetry\n\u0060\u0060\u0060\n\n#### 部署 SkyWalking\n\n在集群中部署 SkyWalking OAP 服务：\n\n\u0060\u0060\u0060bash\nkubectl apply -f https:\/\/raw.githubusercontent.com\/istio\/istio\/release-1.24\/samples\/addons\/extras\/skywalking.yaml\n\u0060\u0060\u0060\n\n检查服务状态：\n\n\u0060\u0060\u0060bash\nkubectl get pods -n istio-system -l app=skywalking-oap\n\u0060\u0060\u0060\n\n#### 配置 MeshConfig 添加 SkyWalking 提供商\n\n在 Istio 的 \u0060MeshConfig\u0060 中定义 SkyWalking 提供商。\n\n\u0060\u0060\u0060yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: istio\n  namespace: istio-system\ndata:\n  mesh: |-\n    enableTracing: true\n    extensionProviders:\n    - name: \u0022skywalking\u0022\n      skywalking:\n        service: \u0022tracing.istio-system.svc.cluster.local\u0022\n        port: 11800\n\u0060\u0060\u0060\n\n#### 使用 Telemetry API 配置采样率\n\n通过 Telemetry API，将 SkyWalking 设置为默认的 Tracing 提供商，并定义采样率。\n\n你可以从使用 Telemetry API 从多个层级配置采样率，为了节约篇幅，我们仅演示在命名空间范围配置采样率，其他层级的配置请参考 [Telemetry API](https:\/\/istio.io\/latest\/docs\/tasks\/observability\/telemetry\/)。\n\n\u0060\u0060\u0060yaml\napiVersion: telemetry.istio.io\/v1\nkind: Telemetry\nmetadata:\n  name: namespace-override\n  namespace: default\nspec:\n  tracing:\n  - providers:\n      - name: skywalking\n    randomSamplingPercentage: 50\n    customTags:\n      env:\n        literal:\n          value: production\n\u0060\u0060\u0060\n\n说明：\n\n- \u0060providers.name\u0060：指定 SkyWalking 为默认的 Tracing 提供商。\n- \u0060randomSamplingPercentage\u0060：覆盖命名空间级别配置，设置 50% 的采样率。\n- \u0060customTags\u0060：为所有追踪数据添加 \u0060env=production\u0060 标签。\n\n### 验证配置\n\n访问网格中的服务（如 [Bookinfo](https:\/\/istio.io\/latest\/docs\/examples\/bookinfo\/) 示例应用）生成流量：\n\n\u0060\u0060\u0060bash\ncurl http:\/\/$GATEWAY_URL\/productpage\n\u0060\u0060\u0060\n\n查看追踪数据：\n\n\u0060\u0060\u0060bash\nistioctl dashboard skywalking\n\u0060\u0060\u0060\n\n打开浏览器访问 \u0060http:\/\/localhost:8080\u0060，在追踪界面中查看生成的追踪信息。\n\n![Skywalking Tracing](https:\/\/jimmysong.io\/img\/blog\/migrate-to-istio-telemetry-api\/skywalking-tracing.webp)\n\n点击一个span后，你可以看到其中的追加的 \u0060env: production\u0060 tag。\n\n![Skywalking Span](https:\/\/jimmysong.io\/img\/blog\/migrate-to-istio-telemetry-api\/skywalking-span.webp)\n\n## 总结\n\nTelemetry API 通过其模块化设计、动态更新和多层级支持，大幅降低了服务网格中遥测配置的复杂性。相比 MeshConfig 和 EnvoyFilter，Telemetry API 是一套更灵活、高效的现代化解决方案。我们强烈推荐迁移到 Telemetry API，以充分利用其功能。\n', '\/blog\/migrate-to-istio-telemetry-api\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">通过迁移到 Telemetry API 配置 SkyWalking 提供商，从而提升 Istio 网格的追踪能力和灵活性。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/south-korea-trip/">韩国旅行回忆：首尔、釜山与仁川的真实体验</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/04</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e6%97%85%e8%a1%8c"> 
             旅行
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('韩国旅行回忆：首尔、釜山与仁川的真实体验', '韩国旅行体验：从首尔的繁华与文化冲突，到釜山的宁静与活力，再到仁川的历史沉淀。', '\n韩国，是我去了一次，可能不会去第二次的国家。难怪韩国人喜欢往外跑，原来是因为他们国家真的没啥好玩的。虽然文化上有不少相似之处，但实际体验却让我感到复杂而矛盾。借着最近韩国发生的政治风波，写下这篇关于我去年韩国之行的记录，既是对旅行的回顾，也是对这个国家的一些思考。\n\n## 题记\n\n2023 年 10 月，我从中国距离韩国最近的城市威海出发，仅需 1 小时的飞行便抵达仁川机场。韩国与中国一衣带水，但这却是我第一次踏上这片土地。之前，我曾去过两次日本，这两个与中国邻近的国家，旅行体验却有着天壤之别。\n\n这次行程从仁川入境，先前往首尔，再坐火车南下釜山。在釜山停留较久后，返回首尔，从仁川飞回中国。\n\n## 首尔：匆忙与拥挤\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113344992250823\u0026bvid=BV1MyyGYqEdS\u0026cid=26396068624\u0026p=1\u0022\u003e}}\n\n到达仁川机场后，我直接坐火车前往首尔。其间发生了一个小插曲。由于携带的行李较多，在仁川机场买火车票时弄丢了一件。眼看我要买票的那趟火车即将到来，我才发现行李少了一件。当时我火急火燎地出了站台，赶往机场到达大厅。但因为对环境不熟悉，找不到路。正在这时，火车进站检票处的工作人员问我是不是丢了行李。我跟他确认了行李内的物品和身份信息后，取回了丢失的行李，并使用之前购买的火车票重新进站。工作人员很热情，用流利的英语跟我对话。东西失而复得，而且是在火车即将开车之前找回，实在是庆幸。\n\n在首尔的第一晚，我选择住在明洞。这里是一个繁华的商业区，同时也是许多抗议和文化活动的集中地。漫步在明洞街头，我还看到了大量的法轮功宣传。另外韩国还有大量的教会，我在釜山住的地方就靠近一个教会。这种对比让我对韩国的社会氛围有了更深的思考。\n\n我的行程恰逢中秋节，韩国也放假。去南山塔的公交车站挤满了人，等了许久才上车。南山塔俯瞰整个首尔，但繁华和拥挤是我对这座城市最深的感受。\n\n![首尔南山塔公交站](https:\/\/jimmysong.io\/img\/blog\/south-korea\/tower.jpeg)\n\n## 釜山：更喜欢这里的舒适节奏\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113366064434679\u0026bvid=BV1mbymYeEtm\u0026cid=26451576660\u0026p=1\u0022\u003e}}\n\n比起首尔，我更喜欢釜山的节奏。釜山依山傍海，有美丽的沙滩和繁忙的港口。这里让我想起家乡威海，但更加繁华，也更加国际化。釜山也是韩国与日本贸易的重要港口，这里的一切都洋溢着开放的气息。\n\n![甘川文化村](https:\/\/jimmysong.io\/img\/blog\/south-korea\/ganchuan.webp)\n\n在釜山旅行的一个亮点是购买了 Busan Pass，这种专为外国游客设计的旅行通票可以带你游览许多官方景点。釜山的乐天乐园是其中之一，既适合家庭游玩，又充满现代化气息。\n\n![釜山乐天乐园](https:\/\/jimmysong.io\/img\/blog\/south-korea\/busan-park.webp)\n\n另一个难忘的经历是在釜山国际电影节上近距离见到了周润发，并在电影节的特别放映中重温了经典电影《卧虎藏龙》。\n\n![周润发在参加釜山电影节](https:\/\/jimmysong.io\/img\/blog\/south-korea\/biff.webp)\n\n## 仁川：历史与现代的碰撞\n\n{{\u003c responsive_video src=\u0022\/\/player.bilibili.com\/player.html?isOutside=true\u0026aid=113367725376595\u0026bvid=BV1WJyUY8EJz\u0026cid=26457407922\u0026p=1\u0022\u003e}}\n\n行程的最后一天，我在仁川停留了一天，夜晚去了仁川登陆纪念公园。这是一个值得参观的地方，纪念了朝鲜战争期间联合国军队的仁川登陆战役。\n\n![仁川纪念联合国军的纪念碑](https:\/\/jimmysong.io\/img\/blog\/south-korea\/un.webp)\n\n## 韩国文化：熟悉又陌生\n\n历史建筑，景福宫像袖珍版的故宫，尤其是宫殿内的陈设，很像影视剧中拙劣的道具。但是韩国人还是不遗余力的推广自己的文化，很多白人、黑人穿着他们的传统服装在景福宫内拍照。\n\n![景福宫](https:\/\/jimmysong.io\/img\/blog\/south-korea\/jingfugong.webp)\n\n韩国的便利店里有很多种泡面，吃起来味道感觉一般，我个人更喜欢吃杯面。甚至在汉阳公园的 711 里还有专门泡面的机器。\n\n![汉江公园里的自助泡面机](https:\/\/jimmysong.io\/img\/blog\/south-korea\/noodles.webp)\n\n韩国人喝咖啡真多，咖啡店到处都是，可以说咖啡流淌在韩国人的血液里了。最让我念念不忘的就是 blu shaak 咖啡，既便宜又好喝，这种咖啡有一种咸味。\n\n![在釜山喝到的 blu shaak 咖啡](https:\/\/jimmysong.io\/img\/blog\/south-korea\/blue-shaak.JPG)\n\n韩国景福宫内随处可见的“中国文化”。\n\n![景福宫公园中的十二生肖](https:\/\/jimmysong.io\/img\/blog\/south-korea\/shegnxiao.webp)\n\n博物馆中很多介绍都只有韩文和英文，没有中文介绍。\n\n![景福宫内某博物馆中的汉字帖子](https:\/\/jimmysong.io\/img\/blog\/south-korea\/paper.webp)\n\n## 韩国美食：单调的味觉体验\n\n韩餐部分吃起来还不错，不过大部分都是泡菜、酱汤、米饭、炸鸡、烤肉之类的，花样太少，远不如中国的饮食丰富，还没有早餐可以吃。\n\n![韩餐](https:\/\/jimmysong.io\/img\/blog\/south-korea\/korean-dish.JPG)\n\n而且，在韩国便利店里买到的各种小零食，大多也不好吃，这点远不如日本，我觉得在日本的便利店里买到的东西口感都还不错。在韩国我就像一个文盲，一个韩文也不认识，而翻译软件经常翻译的莫名其妙，很多招牌和菜单上都没有英文或汉字，甚至连图片都没有，让人很无语。\n\n![莫名奇妙的韩文翻译](https:\/\/jimmysong.io\/img\/blog\/south-korea\/korea-text.webp)\n\n## 评价：下次可能不会再来了\n\n总结这次韩国之行，虽然有些亮点，但总体体验不尽如人意。语言障碍、文化隔阂，以及相比之下单调的饮食和高昂的住宿费用，让我感到再来一次的动力不足。不过，釜山的电影节和咖啡，以及仁川的历史氛围，还是让我留下了些许回味的瞬间。\n\n如果你没去过韩国，可以去体验一次；但对于我来说，这一次可能就是最后一次了。\n', '\/blog\/south-korea-trip\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">韩国旅行体验：从首尔的繁华与文化冲突，到釜山的宁静与活力，再到仁川的历史沉淀。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/istio-sidecar-vs-ambient-network-cost-performance/">Istio sidecar 和 ambient 模式的网络成本对比</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/12/02</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/istio"> 
             Istio
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('Istio sidecar 和 ambient 模式的网络成本对比', '深入对比 Istio sidecar 和 ambient 模式的网络成本与性能，分析其本地性感知及排查方法。', '\n在服务网格架构不断演进的过程中，了解不同部署模式下的网络成本对于优化性能和资源效率至关重要。本文将对比 Istio 的 sidecar 模式和 ambient 模式的网络成本，分享我在[这篇文章](\/blog\/service-mesh-data-plane-deployment-modes\/)中的一些观点。\n\n## Sidecar 模式\n\nIstio 的 sidecar 模式通过在每个 pod 旁部署 sidecar 代理来拦截服务间的流量。这种架构引入了额外的网络跳转，可能会增加延迟和计算资源使用量。然而，该模式内置了重要的性能优化特性：[本地性感知](https:\/\/istio.io\/latest\/docs\/tasks\/traffic-management\/locality-load-balancing\/)。\n\n图 1 展示了 Application 1 在 Istio sidecar 模式下访问位于不同可用区（AZ）的 Application 2 的流量路径。\n\n![图 1：Application 1 在 Istio sidecar 模式下访问位于不同可用区（AZ）的 Application 2 的流量路径。](sidecar-mode.svg)\n\n### Sidecar 模式的本地化感知\n\n在 Sidecar 模式下，可以使用以下命令查看端点表中的本地性信息，从而更好地理解本地性管理：\n\n\u0060\u0060\u0060bash\nistioctl proxy-config endpoint \u003cpod-name[.namespace]\u003e -o yaml\n\u0060\u0060\u0060\n\n以下是一个示例输出片段，显示了集群 \u0060outbound|9080||reviews.default.svc.cluster.local\u0060 的端点信息：\n\n\u0060\u0060\u0060yaml\n- addedViaApi: true\n  circuitBreakers:\n    thresholds:\n    - maxConnections: 4294967295\n      maxPendingRequests: 4294967295\n      maxRequests: 4294967295\n      maxRetries: 4294967295\n    - maxConnections: 1024\n      maxPendingRequests: 1024\n      maxRequests: 1024\n      maxRetries: 3\n      priority: HIGH\n  edsServiceName: outbound|9080||reviews.default.svc.cluster.local\n  hostStatuses:\n  - address:\n      socketAddress:\n        address: 10.244.0.98\n        portValue: 9080\n    healthStatus:\n      edsHealthStatus: HEALTHY\n    locality:\n      region: us-central1\n      zone: us-central1-c\n    stats:\n    - name: cx_connect_fail\n    - name: cx_total\n    - name: rq_error\n    - name: rq_success\n    - name: rq_timeout\n    - name: rq_total\n    - name: cx_active\n      type: GAUGE\n    - name: rq_active\n      type: GAUGE\n    weight: 1\n  - address:\n    # 省略\n  - address:\n    # 省略\n  name: outbound|9080||reviews.default.svc.cluster.local\n  observabilityName: outbound|9080||reviews.default.svc.cluster.local;\n\u0060\u0060\u0060\n\n从中可以看到 sidecar 模式下对 Envoy 代理对 pod 基于负载均衡的细粒度控制，例如 \u0060maxConnections\u0060, \u0060maxRequests\u0060, \u0060maxRetries\u0060 等 circuit breaker 配置，同时包含流量指标和健康状态。这些细节帮助在 Pod 级别管理流量的健康度、稳定性和延迟。\n\n流量负载均衡考虑到 Locality，如 zone 和 region。Envoy 使用这些信息对流量执行更加精准的区域感知流量分配策略（如优先使用同一 zone 内的服务）。\n\n每个 sidecar 代理都会优先将流量路由至同一可用区（AZ）或区域内的服务。这一设计减少了不必要的跨 AZ 流量，从而降低了由数据传输产生的高延迟和高成本。通过将流量限制在本地区域，sidecar 模式能够优化网络路径，避免跨区域的瓶颈。\n\n尽管 sidecar 架构计算密集，但其本地性感知功能在维护高效流量路由方面起到了关键作用，尤其是在多区域云部署中，该功能有助于降低跨区域流量成本。\n\n## Ambient 模式\n\n下图展示的 Istio ambient 模式的架构。\n\n![图 2：Istio ambient 模式](istio-ambient-layers.svg)\n\nIstio ambient 模式包含两层：\n\n1. **Ztunnel 安全层（L3\/L4 流量处理）**：在此模式下，ambient 模式仅依赖 zTunnel 进行流量管理，主要处理三层和四层的流量，即网络和传输层。这一方式可减少开销，确保基本的连接和安全要求得到满足。\n\n2. **Waypoint 代理层（L7 流量处理）**：此模式下引入了 waypoint 代理，以扩展至应用层流量，处理高级路由、观测性和策略执行。然而，waypoint 代理的部署位置对性能至关重要。为避免跨 AZ 流量，建议将 waypoint 代理分布于各个 AZ 内，以确保最佳性能。\n\n### Ambient 模式的本地化感知\n\n相比之下，ambient 模式通过 ztunnel 和 waypoint 代理实现不同的架构。zTunnel 确保本地感知的流量路由，类似于 sidecar 模式，优先在同一 AZ 内路由流量，从而限制跨 AZ 流量并减少相应的网络成本。\n\n图 3 展示了 Application 1 在 Istio ambient 模式下访问位于不同 AZ 的 Application 2 的流量路径。\n\n![图 3：Application 1 在 Istio ambient 模式下访问位于不同可用区（AZ）的 Application 2 的流量路径。](ambient-mode.svg)\n\n**注意**：图中 Waypoint Proxy 为演示目的单独显示；在实际中，它并不绑定到特定节点，可以与 Ztunnel 同节点部署。\n\n可以通过以下命令查看 Ambient 模式中 Ztunnel 的详细配置和流量分布：\n\n\u0060\u0060\u0060bash\nistioctl ztunnel-config workload -o yaml\n\u0060\u0060\u0060\n\n以下是一个示例输出：\n\n\u0060\u0060\u0060yaml\n- applicationTunnel:\n    protocol: \u0022\u0022\n  canonicalName: productpage\n  canonicalRevision: v1\n  clusterId: Kubernetes\n  hostname: \u0022\u0022\n  locality:\n    region: us-central1\n    zone: us-central1-c\n  name: productpage-v1-d5789fdfb-gmw5r\n  namespace: default\n  node: gke-cilium-default-pool-63a77182-f699\n  protocol: HBONE\n  serviceAccount: bookinfo-productpage\n  status: Healthy\n  trustDomain: cluster.local\n  uid: Kubernetes\/\/Pod\/default\/productpage-v1-d5789fdfb-gmw5r\n  workloadIps:\n    - 10.28.2.14\n  workloadName: productpage-v1\n  workloadType: deployment\n\u0060\u0060\u0060\n\n从中可以看到 ztunnel 隧道的本地化信息，ztunnel 可以对进出该节点所有 pod 的流量进行集中式管理，比如统一执行负载均衡、健康检查和区域感知等操作。\n\n### Waypoint 代理优化\n\n然而，waypoint 代理并非自动具有 AZ 感知功能。关键问题在于它们的部署位置。为优化成本与性能，waypoint 代理需要跨所有 AZ 进行扩展，以便本地处理流量。否则，可能导致跨 AZ 流量和额外成本。此外，当流量进入 waypoint 代理时，原始本地性信息可能被隐藏，进一步增加了路由优化的难度。\n\n为优化性能和成本，建议 waypoint 代理在各个 AZ 内分布，以便能够本地处理流量。此外，ztunnel 与 waypoint 代理的通信设计为接近感知，从而确保流量被路由至最近的 waypoint 代理。这一特性进一步减少了跨 AZ 费用和延迟。\n\n## 使用 Kiali dashboard 进行可视化\n\n在对比 sidecar 和 ambient 模式时，为了更直观地理解本地性和路由行为，建议使用 Kiali dashboard。Kiali 能够直观展示不同模式下的流量路径，有助于理解 ambient 模式在复杂性上的表现。\n\n![图 4：Kiali 页面](kiali.webp)\n\n## 总结\n\n在对比 Istio 的 sidecar 和 ambient 模式的网络成本时，两种架构都提供了本地性感知的路由以减少跨 AZ 流量。然而，sidecar 模式在每个代理的本地性管理上更加完善，而 ambient 模式需要谨慎管理 waypoint 代理以避免额外成本。此外，需要考虑 ambient 模式的两种子模式（有或无 waypoint 代理）来理解它们对网络成本和性能的不同影响。\n\n如果希望深入了解四种主要的服务网格数据平面部署模式，建议阅读[深入解析服务网格的四种数据平面部署模式：性能、安全性与成本分析]\/blog\/service-mesh-data-plane-deployment-modes\/)。\n', '\/blog\/istio-sidecar-vs-ambient-network-cost-performance\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">深入对比 Istio sidecar 和 ambient 模式的网络成本与性能，分析其本地性感知及排查方法。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
              <div class="col-sm-6 mb-3">
  <article class="card rounded-0 border-bottom border-primary border-top-0 border-left-0 border-right-0 hover-shadow">
    
    
    <div class="card-body blog-list-card-body">
      <p class="card-title"><a href="/blog/mindmap-review/">思维导图工具评测：为什么我选择 Whimsical</a></p>
      
      <div class="blog-list-metadata">
          <ul class="list-inline">
             
             <li class="list-inline-item mr-2 mb-md-0"><i class="fa-regular fa-calendar"></i>
               2024/11/27</li>
             <li class="list-inline-item mr-2 md-md-0"><i class="fa-regular fa-folder-open"></i>
             
             <a href="/categories/%e5%b7%a5%e5%85%b7"> 
             工具
             </a>
             
             </li>
             
             <li class="list-inline-item mr-2 mb-md-0">
              

             </li>
             
             <li class="list-inline-item mr-2 mb-md-0 export-button" style="display: none;">
              <a href="#" onclick="exportToMarkdown('思维导图工具评测：为什么我选择 Whimsical', '探索本地和在线思维导图优劣，揭秘为什么我最终选择了 Whimsical。', '\n{{\u003cmindmap src=\u0022https:\/\/whimsical.com\/embed\/FuuokxVScXeGqU57Qo1V3P\u0022\u003e}}\n\n思维导图是一种高效的工具，用于整理思路、构建结构和规划项目。我尝试了许多思维导图工具，包括 Coggle、Miro、GitMind、MindMeister 等。这些工具各有特点，但最终 Whimsical 成为了我的首选。在这篇博客中，我将深入介绍这些工具的特点，并分享选择 Whimsical 的原因。\n\n## 在线思维导图工具对比\n\n在选择在线思维导图工具时，我重点关注以下方面：\n\n- 是否支持嵌入网站并具备交互性。\n- 操作是否直观流畅。\n- 功能是否能满足个人和团队协作的需求。\n\n### Coggle\n\nCoggle 是一款专注于思维导图的在线工具，界面清新，适合个人用户和小型团队。它的核心特色是可以快速创建节点并生成树状结构。\n\n- 优点：\n  - 免费版提供无限制的思维导图创建。\n  - 支持实时协作，适合简单项目规划。\n- 缺点：\n  - 操作逻辑不够直观，尤其是在复杂项目中容易产生混乱。\n  - 缺乏高级功能，不适合需要高效编辑的用户。\n\n### Miro\n\nMiro 是一款功能丰富的协作白板工具，思维导图是其众多功能中的一个模块。它适合团队在复杂项目中进行头脑风暴和流程规划。\n\n- 优点：\n  - 支持多种图表类型，扩展性强。\n  - 界面设计美观，操作流畅，支持团队实时协作。\n- 缺点：\n  - 嵌入网站时节点无法展开和折叠，仅适合静态展示。\n  - 功能丰富但较为复杂，对新用户来说学习曲线较陡。\n\n### GitMind\n\nGitMind 是一款轻量级的在线思维导图工具，界面简洁，专注于核心功能，适合初学者或对功能需求不高的用户。\n\n- 优点：\n\n  - 易于上手，操作简单。\n  - 提供多种模板，便于快速构建导图。\n  \n- 缺点：\n\n  - 功能较单一，无法满足复杂项目需求。\n- 免费版限制较多，对高级用户不够友好。\n\n### MindMeister\n\nMindMeister 是一款成熟的在线思维导图工具，以优雅的界面和强大的分享功能著称。它的嵌入功能特别适合内容创作者。\n\n- 优点：\n  - 支持节点的展开和折叠，交互体验良好。\n  - 提供清晰的界面和流畅的操作体验。\n  - 免费版适合个人用户。\n- 缺点：\n  - 免费版限制导图数量，对于长期使用者可能需要订阅高级版本。\n\n### Whimsical\n\nWhimsical 是一款多功能在线工具，除了思维导图，还支持流程图、看板等多种图表类型。它的设计简洁直观，功能多样，是团队协作的利器。\n\n![Whimsical 界面](https:\/\/jimmysong.io\/img\/blog\/mindmap-review\/whimsical-ui.png)\n\n- 优点：\n  - 节点支持展开和折叠，交互性出色。\n  - 操作直观，上手快，适合个人和团队使用。\n  - 支持生成嵌入代码和链接分享，展示灵活。\n  - 除了思维导图，还能创建流程图、看板等，适合多场景使用。\n  - 支持 AI 思维导图，但是对免费用户有一定限制。\n  - 从中国大陆可以正常访问。\n- 缺点：\n  - 免费版限制 3 个 team board，个人用户无需考虑这一点。\n  - 只支持导出为低像素的 png 图片，不支持 svg 格式导出。\n  - 无法导入 Markdown 文件生成思维导图。\n\n## 本地化思维导图工具对比\n\n如果不需要在线协作或网站嵌入，本地化思维导图工具也是不错的选择。其中，MindNode、XMind 和 Markmap 都是备受推荐的工具。\n\n### MindNode\n\nMindNode 是一款 macOS 和 iOS 平台的思维导图工具，以其简约设计和轻量化著称，适合快速构建简单的思维导图。\n\n- 优点：\n  - 轻量化工具，操作简单流畅。\n  - 与 macOS 和 iOS 的深度集成，支持导出多种格式。\n- 缺点：\n  - 高级功能有限，难以满足复杂需求。\n  - 不支持实时协作，仅适合个人使用。\n\n### XMind\n\nXMind 是一款历史悠久的思维导图工具，以功能强大和专业性著称，适合对功能要求较高的用户。\n\n- 优点：\n  - 支持多种思维导图样式，功能丰富。\n  - 导出选项多样，适合演示和文档输出。\n- 缺点：\n  - 界面相对复杂，新用户需要一定学习成本。\n  - 本地化工具，协作和展示功能较弱。\n\n### Markmap\n\n[Markmap](https:\/\/github.com\/markmap\/markmap) 是一款基于 Markdown 的开源思维导图工具，非常适合技术用户。它可以将 Markdown 文件直接渲染成动态思维导图。\n\n- 优点：\n  - 支持私有化部署，适合安全要求高的场景。\n  - 兼容 Markdown 格式，适合开发者和技术人员。\n- 缺点：\n  - 功能较为单一，仅能展示静态内容。\n  - 动态交互性有限，对非技术用户不够友好。\n\n## 为什么选择 Whimsical？\n\n经过多方比较，我最终选择 Whimsical，主要基于以下几点：\n\n1. **交互性出色**：支持节点的展开和折叠，嵌入网页后体验良好。\n2. **简洁直观**：界面设计易用性强，操作流畅，无需复杂学习。\n3. **多功能性**：不仅支持思维导图，还能绘制流程图、创建看板等，满足多种需求。\n4. **协作能力强**：实时多人编辑功能极大提升团队效率。\n5. **灵活分享**：支持生成嵌入代码和分享链接，适合展示和传播。\n\n{{\u003ccallout tip \u0022下载 SVG 图片\u0022\u003e}}\n\nWhimsical 免费版不支持导出 Markdown、高清 PNG 或 PDF 格式。但有技巧可下载思维导图 SVG 文件，在编辑中的思维导图 URL 加“.svg”后缀能下载矢量图。\n\n{{\u003c\/callout\u003e}}\n\n## 结语\n\n不同思维导图工具有各自的优势和适用场景。对我而言，Whimsical 的交互性、多功能性以及便捷的协作体验使其脱颖而出。如果你正在寻找一款能够满足多场景需求的在线思维导图工具，不妨尝试一下 Whimsical，它可能会带给你意想不到的惊喜。如果想要直接在自己的网站中私有化部署一个思维导图，那么我推荐你使用 Markmap。\n', '\/blog\/mindmap-review\/')">
                <i class="fas fa-file-download"></i>
              </a>
             </li>
          </ul>
      </div>
      <p class="card-text">探索本地和在线思维导图优劣，揭秘为什么我最终选择了 Whimsical。</p>
    </div>
  </article>
</div>


<script>
  function convertImageLinks(rawContent, permalink) {
      
      const baseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const blogPath = permalink.replace(/^\/|\/$/g, ''); 
      return rawContent.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, altText, relativePath) {
          
          if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {
              return match; 
          }
          return `![${altText}](${baseUrl}${blogPath}/${relativePath})`;
      });
  }
  
  function convertRelativeLinks(rawContent) {
      
      const domain = 'https://jimmysong.io'; 
      return rawContent.replace(/\[([^\]]+)\]\((\/[^)]+)\)/g, function(match, linkText, relativePath) {
          return `[${linkText}](${domain}${relativePath})`;
      });
  }
  
  function exportToMarkdown(title, description, rawContent, permalink) {
      const githubBaseUrl = 'https://raw.githubusercontent.com/rootsongjc/rootsongjc.github.io/master/'; 
      const filename = title + '.md';
  
      
      const convertedContent = convertImageLinks(rawContent, permalink);
      
      
      const contentWithLinks = convertRelativeLinks(convertedContent);
  
      
      const contentWithHeader = `> ${description}\n>\n> 阅读原文请转到：https://jimmysong.io${permalink}\n${contentWithLinks}`;
  
      
      const contentWithFooter = `${contentWithHeader}\n\n---\n`;
  
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(contentWithFooter));
      element.setAttribute('download', filename);
  
      element.style.display = 'none';
      document.body.appendChild(element);
  
      element.click();
  
      document.body.removeChild(element);
  }
  
  
  if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
      document.querySelectorAll('.export-button').forEach(function(button) {
          button.style.display = 'inline';
      });
  }
</script>
          
          <div class="col-12">
 
 
 
 
 
 
 
 
 
 
 
 <nav aria-label="Page navigation">
   <ul class="pagination justify-content-center">
     
     
     
     
     
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item page-item active ">
           <a href="/blog/" class="page-link">
             1
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/2/" class="page-link">
             2
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/3/" class="page-link">
             3
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/4/" class="page-link">
             4
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
             
           
         
         
         
       
       
       
       
         <li class="page-item">
           <a href="/blog/page/5/" class="page-link">
             5
           </a>
         </li>
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
       
       
       
         
         
         
           
           
         
         
         
       
       
       
       
     
     
     
     <li class="page-item">
       <a href="/blog/page/2/" class="page-link">
         »
       </a>
     </li>
     
     
     
     <li class="page-item">
       <a class="page-link" href="/blog/page/29/">
         »»
       </a>
     </li>
     
   </ul>
 </nav>
 
</div>

        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4 order-1 order-lg-2 d-none d-sm-block">
          <div class="sidebar">
          <!-- categories -->
<div class="blog-categories mb-4">
  <p class="sidebar-title">
      专栏
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/istio" class="sidebar-item">
            <span>Istio</span>
            <span>(83)</span>
        </a>
      
        <a href="/categories/service-mesh" class="sidebar-item">
            <span>Service Mesh</span>
            <span>(42)</span>
        </a>
      
        <a href="/categories/kubernetes" class="sidebar-item">
            <span>Kubernetes</span>
            <span>(25)</span>
        </a>
      
        <a href="/categories/%e9%9a%8f%e7%ac%94" class="sidebar-item">
            <span>随笔</span>
            <span>(22)</span>
        </a>
      
        <a href="/categories/%e5%85%b6%e4%bb%96" class="sidebar-item">
            <span>其他</span>
            <span>(20)</span>
        </a>
      
        <a href="/categories/envoy" class="sidebar-item">
            <span>Envoy</span>
            <span>(18)</span>
        </a>
      
        <a href="/categories/%e4%b8%9a%e6%80%81" class="sidebar-item">
            <span>业态</span>
            <span>(17)</span>
        </a>
      
        <a href="/categories/%e4%ba%91%e5%8e%9f%e7%94%9f" class="sidebar-item">
            <span>云原生</span>
            <span>(14)</span>
        </a>
      
        <a href="/categories/ai" class="sidebar-item">
            <span>AI</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%ae%89%e5%85%a8" class="sidebar-item">
            <span>安全</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e5%bc%80%e6%ba%90" class="sidebar-item">
            <span>开源</span>
            <span>(9)</span>
        </a>
      
        <a href="/categories/%e6%97%85%e8%a1%8c" class="sidebar-item">
            <span>旅行</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e5%b7%a5%e5%85%b7" class="sidebar-item">
            <span>工具</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7" class="sidebar-item">
            <span>可观测性</span>
            <span>(5)</span>
        </a>
  </div>
</div>

<div class="blog-categories mb-4">
  <p class="sidebar-title">
      资料
  </p>
  
  
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
        
      
      
  
  <div class="bg-gray">
      
        <a href="/categories/%e5%87%ba%e7%89%88%e7%89%a9" class="sidebar-item">
            <span>出版物</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e7%94%b5%e5%ad%90%e4%b9%a6" class="sidebar-item">
            <span>翻译电子书</span>
            <span>(8)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e6%96%87%e6%a1%a3" class="sidebar-item">
            <span>翻译文档</span>
            <span>(7)</span>
        </a>
      
        <a href="/categories/%e7%bf%bb%e8%af%91%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>翻译图书</span>
            <span>(6)</span>
        </a>
      
        <a href="/categories/%e5%8e%9f%e5%88%9b%e5%9b%be%e4%b9%a6" class="sidebar-item">
            <span>原创图书</span>
            <span>(2)</span>
        </a>
      
        <a href="/categories/%e6%95%99%e7%a8%8b%e6%89%8b%e5%86%8c" class="sidebar-item">
            <span>教程手册</span>
            <span>(2)</span>
        </a>
  </div>
</div>





          </div>
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>




<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay ">
    <div class="container-xl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/cilium-annual-report-2024/">Cilium 2024 年度报告解读</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-ambient-packet-lifecycle-optimization/">Istio Ambient 模式中的数据包生命周期及流量优化</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/envoy-ext-proc-guide/">深入解析 Envoy 外部处理过滤器（ext_proc）</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xl">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
