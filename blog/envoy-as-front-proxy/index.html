<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  <title>使用 Envoy 作为前端代理</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.62.2" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  
  <link rel="stylesheet" href="/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/plugins/hightlight/syntax.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">

  <meta property="og:image" content="https://jimmysong.io/images/favicon.png">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>

<header class="fixed-top header">
  
  
  
  <div class="navigation w-100 ">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/"><img class="img-fluid" width="200px"
            src="/images/logo.png" alt="Jimmy Song - Cloud Native | Open Source | Community"></a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/about">关于</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                图书
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="/kubernetes-handbook/">KUBERNETES HANDBOOK</a>
                
                <a class="dropdown-item" href="/istio-handbook/">ISTIO HANDBOOK</a>
                
                <a class="dropdown-item" href="/book/">全部图书</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                博客
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="/categories/%E5%AE%B9%E5%99%A8">容器</a>
                
                <a class="dropdown-item" href="/categories/kubernetes">KUBERNETES</a>
                
                <a class="dropdown-item" href="/categories/service-mesh">SERVICE MESH</a>
                
                <a class="dropdown-item" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F">云原生</a>
                
                <a class="dropdown-item" href="/categories/%E5%BC%80%E6%BA%90">开源</a>
                
                <a class="dropdown-item" href="/categories/%E5%85%B6%E4%BB%96">其他</a>
                
                <a class="dropdown-item" href="/blog">全部博客</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                社区
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="https://cloudnative.to">云原生社区</a>
                
                <a class="dropdown-item" href="https://www.servicemesher.com">服务网格社区</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contact">联系</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                更多
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="/partner">伙伴</a>
                
                <a class="dropdown-item" href="/notice">通知</a>
                
                <a class="dropdown-item" href="/event">活动</a>
                
                <a class="dropdown-item" href="/job">招聘</a>
                
              </div>
            </li>
            
            

          
          
          
          <!-- search -->
          <div class="m-auto search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


	
<section class="page-title-section overlay" style="background-image: url('/images/backgrounds/page-title.jpg'),url('/images/backgrounds/page-title.jpg');" >
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <ul class="list-inline custom-breadcrumb">
          
            
            
          <li class="list-inline-item h2"><a class="text-primary font-secondary" href="/blog">博客</a></li>
            
          
          <li class="list-inline-item h5"><i class="ti-angle-right text-white"></i></li>
          <li class="list-inline-item text-white h3 font-secondary">使用 Envoy 作为前端代理</li>
        </ul>
        <p class="text-lighten">本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。</p>
      </div>
    </div>
  </div>
</section>

	


<section class="section-sm">
  <div class="container blog">
    <div class="row">
      <div class="col-lg-8">
        <div class="row">
          
          <div class="col-12">
            <ul class="list-inline">
            
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">日期
                  :</span>2018年4月22日</li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">分类
                  :</span><a
                  href="/categories/service-mesh"> 
                  Service Mesh</a> </li>

            </ul>
          </div>
          
          <div class="col-12 my-4">
            <div class="border-bottom"></div>
          </div>
          
          <div class="col-12 content">
            <p><a href="https://github.com/envoyproxy/envoy">Envoy</a> 是一款由 Lyft 开源的，使用 C++ 编写的 L7 代理和通信总线，目前是 <a href="https://cncf.io">CNCF</a> 旗下的开源项目，代码托管在 GitHub 上，它也是 <a href="https://istio.io">Istio</a> service mesh 中默认的 data plane。本文将给出使用 Envoy 作为 service mesh 的数据平面的示例，应用使用 docker-compose 编排。</p>
<h2 id="特性">特性</h2>
<p>Envoy 包括如下特性：</p>
<ul>
<li>进程外架构，不侵入应用进程</li>
<li>使用现代版 C++11 代码</li>
<li>L3/L4 filter 架构</li>
<li>HTTP L7 filter 架构</li>
<li>支持 HTTP/2</li>
<li>HTTP L7 routing</li>
<li>支持 gRPC</li>
<li>支持 MongoDB L7</li>
<li>动态配置</li>
<li>最佳可观测性</li>
<li>支持 front/edge proxy</li>
<li>高级负载均衡</li>
<li>健康检查</li>
<li>服务发现</li>
<li>支持 DynamoDB L7</li>
</ul>
<p>Envoy 本身无法构成一个完整的 Service Mesh，但是它可以作为 service mesh 中的应用间流量的代理，负责 service mesh 中的数据层。</p>
<p>更多信息请参考 <a href="https://www.envoyproxy.io/">Envoy 官网</a>。</p>
<h2 id="envoy-作为前端代理">Envoy 作为前端代理</h2>
<p>本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。</p>
<h2 id="快速开始">快速开始</h2>
<p>Envoy 中的所有规则配置跟 Kubernetes 一样都是通过 YAML 文件来完成的。在继续下面的步骤之前，首先克隆 Envoy 的 GitHub repo。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/envoyproxy/envoy.git
</code></pre></div><h2 id="运行-sandbox-测试">运行 sandbox 测试</h2>
<p>Envoy 官方提供了以下打包用例：</p>
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy">Front Proxy</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/zipkin_tracing">Zipkin Tracing</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/jaeger_tracing">Jaeger Tracing</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/grpc_bridge">gRPC Bridge</a></li>
</ul>
<p>全部可以使用 <code>docker-compose</code> 运行，代码可以在 <a href="https://github.com/envoyproxy/envoy/tree/master/examples">https://github.com/envoyproxy/envoy/tree/master/examples</a> 找到。</p>
<h2 id="front-proxy">Front proxy</h2>
<p>Envoy 在 envoymesh 的边缘做反向代理，详细使用方式见 <a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy">https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy</a>，在此我将解说下以下问题：</p>
<ul>
<li>Envoy 是如何作为进程外架构运行的？</li>
<li>为何说 Envoy 是无侵入式架构？</li>
<li>Envoy 作为边缘反向代理能做什么？</li>
</ul>
<p>本示例的架构图如下所示，此时 Envoy 将作为一个反向代理，类似于 Nginx，但与 Nginx 不同的是它还会作为一个进程，伴随每个服务一起运行在同一个容器中（在 Kubernetes 中可以作为 Sidecar 与应用容器一起运行在同一个 Pod 中）。</p>
<p><img src="envoyproxy-docker-compose.png" alt="Front proxy 部署结构图"></p>
<p>在此示例中一共有 3 个服务，我们需要为其创建容器编排的 <code>docker-compose.yml</code> 文件。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>front-envoy<span class="p">:</span><span class="w">
</span><span class="w">    </span>build<span class="p">:</span><span class="w">
</span><span class="w">      </span>context<span class="p">:</span><span class="w"> </span>.<span class="w">
</span><span class="w">      </span>dockerfile<span class="p">:</span><span class="w"> </span>Dockerfile-frontenvoy<span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./front-envoy.yaml<span class="p">:</span>/etc/front-envoy.yaml<span class="w">
</span><span class="w">    </span>networks<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>envoymesh<span class="w">
</span><span class="w">    </span>expose<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8001&#34;</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8000:80&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8001:8001&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>service1<span class="p">:</span><span class="w">
</span><span class="w">    </span>build<span class="p">:</span><span class="w">
</span><span class="w">      </span>context<span class="p">:</span><span class="w"> </span>.<span class="w">
</span><span class="w">      </span>dockerfile<span class="p">:</span><span class="w"> </span>Dockerfile-service<span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./service-envoy.yaml<span class="p">:</span>/etc/service-envoy.yaml<span class="w">
</span><span class="w">    </span>networks<span class="p">:</span><span class="w">
</span><span class="w">      </span>envoymesh<span class="p">:</span><span class="w">
</span><span class="w">        </span>aliases<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>service1<span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>SERVICE_NAME=<span class="m">1</span><span class="w">
</span><span class="w">    </span>expose<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>service2<span class="p">:</span><span class="w">
</span><span class="w">    </span>build<span class="p">:</span><span class="w">
</span><span class="w">      </span>context<span class="p">:</span><span class="w"> </span>.<span class="w">
</span><span class="w">      </span>dockerfile<span class="p">:</span><span class="w"> </span>Dockerfile-service<span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./service-envoy.yaml<span class="p">:</span>/etc/service-envoy.yaml<span class="w">
</span><span class="w">    </span>networks<span class="p">:</span><span class="w">
</span><span class="w">      </span>envoymesh<span class="p">:</span><span class="w">
</span><span class="w">        </span>aliases<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>service2<span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>SERVICE_NAME=<span class="m">2</span><span class="w">
</span><span class="w">    </span>expose<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>networks<span class="p">:</span><span class="w">
</span><span class="w">  </span>envoymesh<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></code></pre></div><p>使用 docker-compose 启动可以保证三个服务都在同一个网络内，即 <code>frontproxy_envoymesh</code> 网络中。</p>
<p>其中 <code>front-envoy</code> 是前端（边缘）Envoy 服务，用来做反向代理，它使用的是 <code>Dockerfile-frontenvoy</code> 文件来构建镜像的，我们来看下该 <code>Dockerfile</code> 的内容。</p>
<div class="highlight"><pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> envoyproxy/envoy:latest</span><span class="err">
</span><span class="err"></span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get -q install -y <span class="se">\
</span><span class="se"></span>    curl<span class="err">
</span><span class="err"></span><span class="k">CMD</span> /usr/local/bin/envoy -c /etc/front-envoy.yaml --service-cluster front-proxy<span class="err">
</span></code></pre></div><p>其中 <code>/etc/front-envoy.yaml</code> 是本地的 <code>front-envoy.yaml</code> 挂载进去的。我们看下该文件的内容。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">static_resources<span class="p">:</span><span class="w">
</span><span class="w">  </span>listeners<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>address<span class="p">:</span><span class="w">
</span><span class="w">      </span>socket_address<span class="p">:</span><span class="w">
</span><span class="w">        </span>address<span class="p">:</span><span class="w"> </span><span class="m">0.0</span><span class="m">.0</span><span class="m">.0</span><span class="w">
</span><span class="w">        </span>port_value<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span>filter_chains<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>filters<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>envoy.http_connection_manager<span class="w">
</span><span class="w">        </span>config<span class="p">:</span><span class="w">
</span><span class="w">          </span>codec_type<span class="p">:</span><span class="w"> </span>auto<span class="w">
</span><span class="w">          </span>stat_prefix<span class="p">:</span><span class="w"> </span>ingress_http<span class="w">
</span><span class="w">          </span>route_config<span class="p">:</span><span class="w">
</span><span class="w">            </span>name<span class="p">:</span><span class="w"> </span>local_route<span class="w">
</span><span class="w">            </span>virtual_hosts<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>backend<span class="w">
</span><span class="w">              </span>domains<span class="p">:</span><span class="w">
</span><span class="w">              </span>-<span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">              </span>routes<span class="p">:</span><span class="w">
</span><span class="w">              </span>-<span class="w"> </span>match<span class="p">:</span><span class="w">
</span><span class="w">                  </span>prefix<span class="p">:</span><span class="w"> </span><span class="s2">&#34;/service/1&#34;</span><span class="w">
</span><span class="w">                </span>route<span class="p">:</span><span class="w">
</span><span class="w">                  </span>cluster<span class="p">:</span><span class="w"> </span>service1<span class="w">
</span><span class="w">              </span>-<span class="w"> </span>match<span class="p">:</span><span class="w">
</span><span class="w">                  </span>prefix<span class="p">:</span><span class="w"> </span><span class="s2">&#34;/service/2&#34;</span><span class="w">
</span><span class="w">                </span>route<span class="p">:</span><span class="w">
</span><span class="w">                  </span>cluster<span class="p">:</span><span class="w"> </span>service2<span class="w">
</span><span class="w">          </span>http_filters<span class="p">:</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>envoy.router<span class="w">
</span><span class="w">            </span>config<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">  </span>clusters<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>service1<span class="w">
</span><span class="w">    </span>connect_timeout<span class="p">:</span><span class="w"> </span><span class="m">0.</span>25s<span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>strict_dns<span class="w">
</span><span class="w">    </span>lb_policy<span class="p">:</span><span class="w"> </span>round_robin<span class="w">
</span><span class="w">    </span>http2_protocol_options<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">    </span>hosts<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>socket_address<span class="p">:</span><span class="w">
</span><span class="w">        </span>address<span class="p">:</span><span class="w"> </span>service1<span class="w">
</span><span class="w">        </span>port_value<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>service2<span class="w">
</span><span class="w">    </span>connect_timeout<span class="p">:</span><span class="w"> </span><span class="m">0.</span>25s<span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>strict_dns<span class="w">
</span><span class="w">    </span>lb_policy<span class="p">:</span><span class="w"> </span>round_robin<span class="w">
</span><span class="w">    </span>http2_protocol_options<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">    </span>hosts<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>socket_address<span class="p">:</span><span class="w">
</span><span class="w">        </span>address<span class="p">:</span><span class="w"> </span>service2<span class="w">
</span><span class="w">        </span>port_value<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w"></span>admin<span class="p">:</span><span class="w">
</span><span class="w">  </span>access_log_path<span class="p">:</span><span class="w"> </span><span class="s2">&#34;/dev/null&#34;</span><span class="w">
</span><span class="w">  </span>address<span class="p">:</span><span class="w">
</span><span class="w">    </span>socket_address<span class="p">:</span><span class="w">
</span><span class="w">      </span>address<span class="p">:</span><span class="w"> </span><span class="m">0.0</span><span class="m">.0</span><span class="m">.0</span><span class="w">
</span><span class="w">      </span>port_value<span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></code></pre></div><p>我们看到其中包括了三大配置项：</p>
<ul>
<li><strong>static_resources</strong>：路由配置信息</li>
<li><strong>cluster</strong>：envoymesh 的服务注册信息</li>
<li><strong>admin</strong>：管理接口，可以通过访问 8001 端口的，访问 <code>/stats</code>  获取当前 envoymesh 的一些统计信息，访问 <code>/server_info</code> 获取 Envoy 的版本信息</li>
</ul>
<p>使用 <code>docker-compose</code> 启动三个容器。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">pwd</span>
envoy/examples/front-proxy
$ docker-compose up --build -d
$ docker-compose ps
        Name                       Command               State      Ports
-------------------------------------------------------------------------------------------------------------
example_service1_1      /bin/sh -c /usr/local/bin/ ... Up       80/tcp
example_service2_1      /bin/sh -c /usr/local/bin/ ... Up       80/tcp
example_front-envoy_1   /bin/sh -c /usr/local/bin/ ... Up       0.0.0.0:8000-&gt;80/tcp, 0.0.0.0:8001-&gt;8001/tcp
</code></pre></div><p>我们下面将过一遍 Envoy 作为前端代理的所有功能，这些功能是通用功能。</p>
<h3 id="路由">路由</h3>
<p>访问 service1 <a href="http://localhost:8000/service/1">http://localhost:8000/service/1</a> 将看到如下输出。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -v localhost:8000/service/1
* 
Trying ::1...
* TCP_NODELAY <span class="nb">set</span>
* Connected to localhost <span class="o">(</span>::1<span class="o">)</span> port <span class="m">8000</span> <span class="o">(</span><span class="c1">#0)</span>
&gt; GET /service/1 HTTP/1.1
&gt; Host: localhost:8000
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
&lt; content-length: <span class="m">89</span>
&lt; server: envoy
&lt; date: Fri, <span class="m">20</span> Apr <span class="m">2018</span> 08:26:33 GMT
&lt; x-envoy-upstream-service-time: <span class="m">14</span>
&lt;
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4
* Connection <span class="c1">#0 to host localhost left intact</span>
</code></pre></div><p>访问 service2 <a href="http://localhost:8000/service/2">http://localhost:8000/service/2</a> 将看到如下输出。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">*   Trying ::1...
* TCP_NODELAY <span class="nb">set</span>
* Connected to localhost <span class="o">(</span>::1<span class="o">)</span> port <span class="m">8000</span> <span class="o">(</span><span class="c1">#0)</span>
&gt; GET /service/2 HTTP/1.1
&gt; Host: localhost:8000
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
&lt; content-length: <span class="m">89</span>
&lt; server: envoy
&lt; date: Fri, <span class="m">20</span> Apr <span class="m">2018</span> 08:27:27 GMT
&lt; x-envoy-upstream-service-time: <span class="m">10</span>
&lt;
Hello from behind Envoy <span class="o">(</span>service 2<span class="o">)</span>! hostname: f6650e1911a0 resolvedhostname: 172.18.0.3
* Connection <span class="c1">#0 to host localhost left intact</span>
</code></pre></div><p>我们看到访问请求被路由到了正确的服务后端。</p>
<h3 id="负载均衡">负载均衡</h3>
<p>增加 service1 的示例数。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ docker-compose scale <span class="nv">service1</span><span class="o">=</span><span class="m">3</span>
WARNING: The scale <span class="nb">command</span> is deprecated. Use the up <span class="nb">command</span> with the --scale flag instead.
Starting frontproxy_service1_1 ... <span class="k">done</span>
Creating frontproxy_service1_2 ... <span class="k">done</span>
Creating frontproxy_service1_3 ... <span class="k">done</span>

$ docker-compose ps
          Name                        Command               State                            Ports
---------------------------------------------------------------------------------------------------------------------------
frontproxy_front-envoy_1   /usr/bin/dumb-init -- /bin ...   Up      10000/tcp, 0.0.0.0:8000-&gt;80/tcp, 0.0.0.0:8001-&gt;8001/tcp
frontproxy_service1_1      /bin/sh -c /usr/local/bin/ ...   Up      10000/tcp, 80/tcp
frontproxy_service1_2      /bin/sh -c /usr/local/bin/ ...   Up      10000/tcp, 80/tcp
frontproxy_service1_3      /bin/sh -c /usr/local/bin/ ...   Up      10000/tcp, 80/tcp
frontproxy_service2_1      /bin/sh -c /usr/local/bin/ ...   Up      10000/tcp, 80/tcp
</code></pre></div><p>我们看到现在 service1 已经有了 3 个实例，现在再访问 service1 <a href="http://localhost:8000/service/1">http://localhost:8000/service/1</a>。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="k">while</span> true<span class="p">;</span><span class="k">do</span> curl localhost:8000/service/1<span class="p">;</span>sleep 1<span class="p">;</span><span class="k">done</span>
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: fe44dba64122 resolvedhostname: 172.18.0.5
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: fe44dba64122 resolvedhostname: 172.18.0.5
Hello from behind Envoy <span class="o">(</span>service 1<span class="o">)</span>! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6
</code></pre></div><p>我们看到对 service1 的已经有负载均衡了，使用的策略是 <code>round_robin</code>，这些都是在 <code>front-envoy.yaml</code> 文件中的 <code>cluster</code> 项下配置的。</p>
<h3 id="admin-端点">admin 端点</h3>
<p>访问 <a href="http://localhost:8001">http://localhost:8001</a> 可以看到 Envoy admin 提供以下管理 API 端点。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>Admin 主页</td>
</tr>
<tr>
<td>/certs</td>
<td>打印机器上的 certs</td>
</tr>
<tr>
<td>/clusters</td>
<td>upstream cluster 状态</td>
</tr>
<tr>
<td>/config_dump</td>
<td>输出当前的 Envoy 配置</td>
</tr>
<tr>
<td>/cpuprofiler</td>
<td>开启/关闭 CPU profiler</td>
</tr>
<tr>
<td>/healthcheck/fail</td>
<td>导致服务失败健康检查</td>
</tr>
<tr>
<td>/healthcheck/ok</td>
<td>导致服务通过健康检查</td>
</tr>
<tr>
<td>/help</td>
<td>打印管理命令的帮助信息</td>
</tr>
<tr>
<td>/hot_restart_version</td>
<td>打印热重启兼容版本</td>
</tr>
<tr>
<td>/listeners</td>
<td>打印 listener 地址</td>
</tr>
<tr>
<td>/logging</td>
<td>查询/更改日志级别</td>
</tr>
<tr>
<td>/quitquitquit</td>
<td>退出服务</td>
</tr>
<tr>
<td>/reset_counters</td>
<td>将计数器重置为 1</td>
</tr>
<tr>
<td>/runtime</td>
<td>打印运行时值</td>
</tr>
<tr>
<td>/runtime_modify</td>
<td>修改运行时值</td>
</tr>
<tr>
<td>/server_info</td>
<td>打印服务器版本/状态信息</td>
</tr>
<tr>
<td>/stats</td>
<td>打印服务器状态统计信息</td>
</tr>
<tr>
<td>/stats/prometheus</td>
<td>打印 prometheus 格式的服务器状态统计信息</td>
</tr>
</tbody>
</table>
<p>Envoy 提供了 API 管理端点，可以对 Envoy 进行动态配置，参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api">v2 API reference</a>。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy">Front proxy</a></li>
</ul>

          </div>

          
          <div class="col-12 link-article">
  <div class="pre-article">
    
    <div><i class="fa fa-arrow-left"></i> 上一篇</div>
    <a href="https://jimmysong.io/blog/istio-tutorial/">Istio Service Mesh 教程</a>
    
  </div>
  <div class="next-article">
    
    <div>下一篇 <i class="fa fa-arrow-right"></i></div>
    <a href="https://jimmysong.io/blog/envoy-archiecture-and-terminology/">Envoy 的架构与基本配置解析</a>
  
  </div>
</div>


          
          
        
        <div class="col-12 mb-5" id="gitalk-container"></div>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  window.onload = function() {
      const gitalk = new Gitalk({
      clientID: '93a0df08e0f93ff0c8a3',
      clientSecret: '89f20e962982401489bc9339dea437161ea44c68',
      repo: 'rootsongjc.github.io',
      owner: 'rootsongjc',
      admin: ['rootsongjc'],
      id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
      distractionFreeMode: false 
    });
    (function() {
      if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
        document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
        return;
      }
      gitalk.render('gitalk-container');
    })();
  }
</script>

        
        </div>
      </div>
      <!-- sidebar -->
      <aside class="col-lg-4">
      <!-- categories -->

<!-- tags -->
<div class="bg-white mb-5">
  <h4 class="mb-4">标签</h4>
  <ul class="list-inline">
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/cloudfoundry">Cloudfoundry</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/cncf">Cncf</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/contiv">Contiv</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/docker">Docker</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/envoy">Envoy</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/hadoop">Hadoop</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/helm">Helm</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/hugo">Hugo</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/iptables">Iptables</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/istio">Istio</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/kubernetes">Kubernetes</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/oam">Oam</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/service-mesh">Service mesh</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/thenewstack">Thenewstack</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/vagrant">Vagrant</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/wercker">Wercker</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/%e4%ba%91%e5%8e%9f%e7%94%9f">云原生</a></li>
    <li class="list-inline-item mb-2 text-capitalize"><a class="px-3 py-2 d-block bg-light" href="/tags/%e5%9b%be%e4%b9%a6">图书</a></li>
  </ul>
</div>
<!-- latest post -->


      <!-- recommend -->
      


      <!-- /recommend -->
      <!-- toc -->
      
<div class="bg-white py-5 box-shadow mb-5 sticky-top aside-toc d-none d-sm-block">
  <h4 class="mb-4">目录</h4>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#特性">特性</a></li>
    <li><a href="#envoy-作为前端代理">Envoy 作为前端代理</a></li>
    <li><a href="#快速开始">快速开始</a></li>
    <li><a href="#运行-sandbox-测试">运行 sandbox 测试</a></li>
    <li><a href="#front-proxy">Front proxy</a>
      <ul>
        <li><a href="#路由">路由</a></li>
        <li><a href="#负载均衡">负载均衡</a></li>
        <li><a href="#admin-端点">admin 端点</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</div>

      <!-- /toc -->
      </aside>
      <!-- /sidebar -->
    </div>
  </div>
</section>



      
    

<footer>
  
  

  
  <div class="footer bg-footer section border-bottom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-sm-8 mb-5 mb-lg-0">
          
          <a class="logo-footer" href="/"><img class="img-fluid mb-4" width="50%" src="/images/logo.png" alt="Jimmy Song - Cloud Native | Open Source | Community"></a>
          <ul class="list-unstyled">
            
            
            <li class="mb-4"><a class="text-color" href="/contact">扫描下面的二维码加我微信</a></li>
            <li class="mb=4"><img src="https://res.cloudinary.com/jimmysong/image/upload/v1594296773/images/jimmysong-wechat-qr-code.jpg" width="128px"></li>
            
          </ul>
          </ul>
        </div>
        
        

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">博客</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/must-read-for-cloud-native-beginner/">云原生初学者入门必读</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/moving-on-from-ant-group/">新的开始——告别蚂蚁，加入 Tetrate</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/post-kubernetes-era/">Kubernetes 次世代的云原生应用</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/sidecar-injection-iptables-and-traffic-routing/">Istio 中的 Sidecar 注入及透明流量劫持过程详解</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/oam-intro/">OAM（开放应用模型）——定义云原生应用标准的野望</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">链接</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="https://space.bilibili.com/31004924/">Jimmy 的 B 站视频</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://jimmysongio.tuchong.com">Jimmy 的图虫摄影频道</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://www.servicemesher.com">ServiceMesher 社区</a></li>
            
            <li class="mb-3"><a class="text-color" href="/awesome-cloud-native">云原生开源技术大全</a></li>
            
            <li class="mb-3"><a class="text-color" href="https://cloudnative.to">云原生社区</a></li>
            
          </ul>
        </div>

        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">图书</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/book/cloud-native-patterns/">云原生模式</a></li>
            
            <li class="mb-3"><a class="text-color" href="/book/serverless-handbook/">Serverless Handbook</a></li>
            
            <li class="mb-3"><a class="text-color" href="/book/cloud-native-infrastructure/">云原生基础架构</a></li>
            
            <li class="mb-3"><a class="text-color" href="/book/google-engineering-practices/">Google 工程实践</a></li>
            
            <li class="mb-3"><a class="text-color" href="/book/future-architecture/">未来架构</a></li>
            
          </ul>
        </div>
        
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">通知</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/job/tetrate/">企业级服务网格提供商 Tetrate 公司招聘</a></li>
            
            <li class="mb-3"><a class="text-color" href="/job/intern-ant-group-container-service/">[实习生招聘] 蚂蚁集团可信原生技术部容器与服务组</a></li>
            
            <li class="mb-3"><a class="text-color" href="/job/cloud-native-app-platform-fall-recruitment/">阿里云云原生应用平台秋招</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/migrating-to-alibaba-cloud/">迁移到阿里云香港节点</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/guide-to-cloud-native-app/">推出云原生应用白皮书</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="copyright py-4 bg-footer">
    <div class="container">
      <div class="row">
        <div class="col-sm-9 text-sm-left text-center">
          <p class="mb-0">Copyright © 2020 Jimmy Song 保留所有权利；<!-- raw HTML omitted -->基于 Hugo <a href="https://github.com/themefisher/educenter-hugo">educenter</a>  主题构建</p>
        </div>
        <div class="col-sm-3 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://twitter.com/jimmysongio"><i class="fa fa-twitter "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://www.youtube.com/channel/UCwLGlxo3b492bzIgD8lnOKg/"><i class="fa fa-youtube "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://github.com/rootsongjc"><i class="fa fa-github "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio"><i class="fa fa-linkedin "></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="/blog/index.xml"><i class="fa fa-rss "></i></a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>




<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>

<script src="/plugins/bigPicture/bigPicture.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-1', 'auto');
  ga('send', 'pageview');
</script>



<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: 'd7f7189aef2be4e5be6a6b9f44897f61',
    indexName: 'DocSearch',
    appId: 'CRNDR5CNMU',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>
</body>

</html>
