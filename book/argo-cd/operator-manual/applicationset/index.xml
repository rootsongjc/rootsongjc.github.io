<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Jimmy Song&#39;s Blog – ApplicationSet 控制器</title>
    <link>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/</link>
    <description>Recent content in ApplicationSet 控制器 on Jimmy Song&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    <lastBuildDate>Fri, 30 Jun 2023 16:00:00 +0800</lastBuildDate>
    
	  <atom:link href="https://jimmysong.io/book/argo-cd/operator-manual/applicationset/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>ApplicationSet 控制器介绍</title>
      <link>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/overview/</link>
      <pubDate>Fri, 30 Jun 2023 16:00:00 +0800</pubDate>
      
      <guid>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/overview/</guid>
      <description>
        
        
        &lt;h2 id=&#34;介绍&#34;&gt;介绍&lt;/h2&gt;
&lt;p&gt;应用程序集控制器是一个&lt;a href=&#34;https://kubernetes.io/docs/concepts/architecture/controller/&#34; title=&#34;Kubernetes 控制器&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Kubernetes 控制器&lt;/a&gt;
，它添加了对&lt;code&gt;ApplicationSet&lt;/code&gt;&lt;a href=&#34;https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/&#34; title=&#34;自定义资源定义&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;自定义资源定义&lt;/a&gt;
 (CRD) 的支持。这个控制器/CRD 使得自动化和更大的灵活性在管理 Argo CD 应用程序跨大量的集群和在 monorepos 内成为可能，同时它使多租户 Kubernetes 集群上的自助式使用成为可能。&lt;/p&gt;
&lt;p&gt;应用程序集控制器与现有的 Argo CD 安装一起工作。Argo CD 是一个声明性的、GitOps 持续交付工具，允许开发人员从他们现有的 Git 工作流程中定义和控制 Kubernetes 应用程序资源的部署。&lt;/p&gt;
&lt;p&gt;从 Argo CD v2.3 开始，应用程序集控制器与 Argo CD 捆绑在一起。&lt;/p&gt;
&lt;p&gt;应用程序集控制器通过添加支持面向集群管理员的附加功能来补充 Argo CD。&lt;code&gt;ApplicationSet&lt;/code&gt;控制器提供：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用单个 Kubernetes 清单定位多个 Kubernetes 集群的能力，使用 Argo CD 部署多个应用程序的能力&lt;/li&gt;
&lt;li&gt;使用单个 Kubernetes 清单从一个或多个 Git 存储库中部署多个应用程序的能力&lt;/li&gt;
&lt;li&gt;改进了对 monorepos 的支持：在 Argo CD 的上下文中，monorepo 是一个单个 Git 存储库中定义的多个 Argo CD 应用程序资源&lt;/li&gt;
&lt;li&gt;在多租户集群中，提高了各个集群租户使用 Argo CD 部署应用程序的能力（无需涉及特权集群管理员以启用目标集群/命名空间）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;🔔 注意：在使用 ApplicationSets 之前，请注意其安全影响。&lt;/p&gt;
&lt;h2 id=&#34;应用程序集资源&#34;&gt;应用程序集资源&lt;/h2&gt;
&lt;p&gt;此示例定义了一个名为&lt;code&gt;guestbook&lt;/code&gt;的&lt;code&gt;ApplicationSet&lt;/code&gt;资源：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;argoproj.io/v1alpha1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ApplicationSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;guestbook&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;generators&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;elements&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;cluster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;engineering-dev&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;https://1.2.3.4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;cluster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;engineering-prod&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;https://2.4.6.8&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;cluster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;finance-preprod&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;https://9.8.7.6&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{{cluster}}-guestbook&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;project&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;my-project&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;repoURL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;https://github.com/infra-team/cluster-deployments.git&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;targetRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;HEAD&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;guestbook/{{cluster}}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;destination&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{{url}}&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;guestbook&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在此示例中，我们想要将我们的&lt;code&gt;guestbook&lt;/code&gt;应用程序（由于这是 GitOps，该应用程序的 Kubernetes 资源来自 Git）部署到一系列 Kubernetes 集群（目标集群的列表在&lt;code&gt;ApplicationSet&lt;/code&gt;资源的 List 项元素中定义）。&lt;/p&gt;
&lt;p&gt;虽然&lt;code&gt;ApplicationSet&lt;/code&gt;资源可以使用多种类型的&lt;em&gt;生成器&lt;/em&gt;，但此示例使用了列表生成器，它只包含一个固定的、字面的集群列表。这个集群列表将是 Argo CD 在处理了&lt;code&gt;ApplicationSet&lt;/code&gt;资源后部署&lt;code&gt;guestbook&lt;/code&gt;应用程序资源的集群。&lt;/p&gt;
&lt;p&gt;生成器（如 List 生成器）负责生成&lt;em&gt;参数&lt;/em&gt;。参数是键值对，在模板渲染期间被替换到&lt;code&gt;ApplicationSet&lt;/code&gt;资源的&lt;code&gt;template:&lt;/code&gt;部分中。&lt;/p&gt;
&lt;p&gt;当前支持的多个生成器：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;List 生成器&lt;/strong&gt;：基于固定的集群名称/URL 值列表生成参数，如上面的示例所示。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cluster 生成器&lt;/strong&gt;：而不是一个字面的集群列表（如列表生成器），集群生成器根据在 Argo CD 中定义的集群自动生成集群参数。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Git 生成器&lt;/strong&gt;：Git 生成器基于包含在生成器资源中的文件或文件夹生成参数。 - 包含 JSON 值的文件将被解析并转换为模板参数。 - Git 存储库中的单个目录路径也可以用作参数值。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Matrix 生成器&lt;/strong&gt;：矩阵生成器结合了两个其他生成器的生成参数。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有关各个生成器的更多信息以及未列出的其他生成器，请参见生成器部分。&lt;/p&gt;
&lt;h2 id=&#34;将参数替换为模板&#34;&gt;将参数替换为模板&lt;/h2&gt;
&lt;p&gt;不管使用哪个生成器，由生成器生成的参数都会被替换为&lt;code&gt;{{parameter name}}&lt;/code&gt;值，而这些值位于&lt;code&gt;ApplicationSet&lt;/code&gt;资源的&lt;code&gt;template:&lt;/code&gt;部分中。在此示例中，列表生成器定义了&lt;code&gt;cluster&lt;/code&gt;和&lt;code&gt;url&lt;/code&gt;参数，这些参数随后分别被替换为模板的&lt;code&gt;{{cluster}}&lt;/code&gt;和&lt;code&gt;{{url}}&lt;/code&gt;值。&lt;/p&gt;
&lt;p&gt;在将参数替换后，将此&lt;code&gt;guestbook&lt;/code&gt; &lt;code&gt;ApplicationSet&lt;/code&gt;资源应用于 Kubernetes 集群：&lt;/p&gt;
&lt;p&gt;1.应用程序集控制器处理生成器条目，生成一组模板参数。2.这些参数被替换到模板中，每组参数替换一次。3.每个渲染的模板都被转换为一个 Argo CD &lt;code&gt;Application&lt;/code&gt;资源，然后创建（或更新）在 Argo CD 名称空间中。4.最后，Argo CD 控制器会收到这些&lt;code&gt;Application&lt;/code&gt;资源的通知，并负责处理它们。&lt;/p&gt;
&lt;p&gt;对于我们的示例中定义的三个不同集群——&lt;code&gt;engineering-dev&lt;/code&gt;、&lt;code&gt;engineering-prod&lt;/code&gt;和&lt;code&gt;finance-preprod&lt;/code&gt;，这将产生三个新的 Argo CD&lt;code&gt;Application&lt;/code&gt;资源：每个集群一个。&lt;/p&gt;
&lt;p&gt;这是将创建的&lt;code&gt;Application&lt;/code&gt;资源之一的示例，为&lt;code&gt;engineering-dev&lt;/code&gt;集群在&lt;code&gt;1.2.3.4&lt;/code&gt;处：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;argoproj.io/v1alpha1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;Application&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;engineering-dev-guestbook&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;repoURL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;https://github.com/infra-team/cluster-deployments.git&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;targetRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;HEAD&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;guestbook/engineering-dev&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;destination&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;https://1.2.3.4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;guestbook&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们可以看到生成的值已被替换到模板的&lt;code&gt;server&lt;/code&gt;和&lt;code&gt;path&lt;/code&gt;字段中，模板已被渲染成一个完整的 Argo CD 应用程序。&lt;/p&gt;
&lt;p&gt;现在这些 Application 也可以在 Argo CD UI 中看到：&lt;/p&gt;
&lt;p&gt;&lt;figure class=&#34;mx-auto text-center&#34;&gt;
  
  
  
  
  &lt;figcaption&gt;ArgoCD Web UI 中的列表生成器示例&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;应用程序集控制器将确保将对&lt;code&gt;ApplicationSet&lt;/code&gt;资源所做的任何更改、更新或删除自动应用于相应的&lt;code&gt;Application&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;例如，如果向列表生成器添加了新的集群/URL 列表条目，则将为此新集群相应地创建一个新的 Argo CD&lt;code&gt;Application&lt;/code&gt;资源。对&lt;code&gt;guestbook&lt;/code&gt; &lt;code&gt;ApplicationSet&lt;/code&gt;资源所做的任何编辑都将影响由该资源实例化的所有 Argo CD 应用程序，包括新应用程序。&lt;/p&gt;
&lt;p&gt;虽然列表生成器的字面集群列表相当简单，但 ApplicationSet 控制器支持其他可用生成器的更复杂的场景。&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>ApplicationSet 入门</title>
      <link>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/getting-started/</link>
      <pubDate>Fri, 30 Jun 2023 16:00:00 +0800</pubDate>
      
      <guid>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/getting-started/</guid>
      <description>
        
        
        &lt;p&gt;本指南假定你已经熟悉 Argo CD 及其基本概念。有关更多信息，请参阅 Argo CD 文档。&lt;/p&gt;
&lt;h2 id=&#34;要求&#34;&gt;要求&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;安装 &lt;a href=&#34;https://kubernetes.io/docs/tasks/tools/install-kubectl/&#34; title=&#34;kubectl&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;kubectl&lt;/a&gt;
 命令行工具&lt;/li&gt;
&lt;li&gt;有一个 &lt;a href=&#34;https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/&#34; title=&#34;kubeconfig&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;kubeconfig&lt;/a&gt;
 文件（默认位置为 &lt;code&gt;~/.kube/config&lt;/code&gt;）。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;安装&#34;&gt;安装&lt;/h2&gt;
&lt;p&gt;有几种安装 ApplicationSet 控制器的选项。&lt;/p&gt;
&lt;h3 id=&#34;a-将-applicationset-作为-argo-cd-的一部分安装&#34;&gt;A) 将 ApplicationSet 作为 Argo CD 的一部分安装&lt;/h3&gt;
&lt;p&gt;从 Argo CD v2.3 开始，ApplicationSet 控制器已捆绑在 Argo CD 中。无需从 Argo CD 单独安装 ApplicationSet 控制器。&lt;/p&gt;
&lt;p&gt;有关更多信息，请参阅 Argo CD &lt;a href=&#34;../../../getting-started/&#34; title=&#34;入门指南&#34;&gt;入门指南&lt;/a&gt;
。&lt;/p&gt;
&lt;h3 id=&#34;b-将-applicationset-安装到现有的-argo-cd-安装中argeo-cd-v23-之前&#34;&gt;B) 将 ApplicationSet 安装到现有的 Argo CD 安装中（Argeo CD v2.3 之前）&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;: 以下说明仅适用于 Argo CD 版本 v2.3.0 之前。&lt;/p&gt;
&lt;p&gt;ApplicationSet 控制器 &lt;em&gt;必须&lt;/em&gt; 安装到与其所针对的 Argo CD 相同的命名空间中。&lt;/p&gt;
&lt;p&gt;假设 Argo CD 安装在 &lt;code&gt;argocd&lt;/code&gt; 命名空间中，请运行以下命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/applicationset/v0.4.0/manifests/install.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;安装完成后，ApplicationSet 控制器不需要进行其他设置。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;manifests/install.yaml&lt;/code&gt; 文件包含安装 ApplicationSet 控制器所需的 Kubernetes 清单：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ApplicationSet&lt;/code&gt; 资源的自定义资源定义&lt;/li&gt;
&lt;li&gt;&lt;code&gt;argocd-applicationset-controller&lt;/code&gt; 的 Deployment&lt;/li&gt;
&lt;li&gt;供 ApplicationSet 控制器使用的 ServiceAccount，用于访问 Argo CD 资源&lt;/li&gt;
&lt;li&gt;授予 ServiceAccount 所需资源的 RBAC 访问权限的 Role&lt;/li&gt;
&lt;li&gt;将 ServiceAccount 和 Role 绑定的 RoleBinding&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;启用高可用性模式&#34;&gt;启用高可用性模式&lt;/h2&gt;
&lt;p&gt;要启用高可用性，必须在 argocd-applicationset-controller 容器中设置命令 &lt;code&gt;--enable-leader-election=true&lt;/code&gt; 并增加副本数。&lt;/p&gt;
&lt;p&gt;在 manifests/install.yaml 中执行以下更改：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;containers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;command&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;entrypoint.sh&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;- &lt;span class=&#34;l&#34;&gt;argocd-applicationset-controller&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;- --&lt;span class=&#34;l&#34;&gt;enable-leader-election=true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;可选升级后的额外安全保障&#34;&gt;可选：升级后的额外安全保障&lt;/h3&gt;
&lt;p&gt;请参阅 控制资源修改 页面，了解你可能希望在 &lt;code&gt;install.yaml&lt;/code&gt; 中的 ApplicationSet Resource 中添加的其他参数，以提供额外的安全性，以防止任何初始意外的后升级行为。&lt;/p&gt;
&lt;p&gt;例如，为了暂时防止升级后的 ApplicationSet 控制器进行任何更改，你可以：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;启用干运行&lt;/li&gt;
&lt;li&gt;使用仅创建策略&lt;/li&gt;
&lt;li&gt;在 ApplicationSets 上启用 &lt;code&gt;preserveResourcesOnDeletion&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;在你的 ApplicationSets 模板中暂时禁用自动同步&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些参数将允许你观察/控制新版本 ApplicationSet 控制器在你的环境中的行为，以确保你对结果感到满意（请参阅 ApplicationSet 日志文件以获取详细信息）。只需不要忘记在完成测试后删除任何临时更改！&lt;/p&gt;
&lt;p&gt;但是，如上所述，这些步骤并不是必需的：升级 ApplicationSet 控制器应该是一项最小侵入性的过程，并且这些步骤仅建议作为额外安全措施。&lt;/p&gt;
&lt;h2 id=&#34;下一步&#34;&gt;下一步&lt;/h2&gt;
&lt;p&gt;一旦你的 ApplicationSet 控制器正常运行，请继续阅读 &lt;a href=&#34;../use-cases/&#34; title=&#34;用例&#34;&gt;用例&lt;/a&gt;
，了解更多支持的场景，或直接转到 &lt;a href=&#34;../generators/&#34; title=&#34;生成器&#34;&gt;生成器&lt;/a&gt;
 查看示例 &lt;code&gt;ApplicationSet&lt;/code&gt; 资源。&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>ApplicationSet 控制器用例</title>
      <link>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/use-cases/</link>
      <pubDate>Fri, 30 Jun 2023 16:00:00 +0800</pubDate>
      
      <guid>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/use-cases/</guid>
      <description>
        
        
        &lt;p&gt;使用生成器的概念，应用集控制器提供了一组强大的工具，用于自动化模板化和修改 Argo CD 应用程序。生成器从各种来源（包括 Argo CD 集群和 Git 存储库）生成模板参数数据，支持和启用新的用例。&lt;/p&gt;
&lt;p&gt;虽然可以将这些工具用于任何目的，但这里是应用集控制器旨在支持的一些特定用例。&lt;/p&gt;
&lt;h2 id=&#34;用例集群附加组件&#34;&gt;用例：集群附加组件&lt;/h2&gt;
&lt;p&gt;应用集控制器的初始设计重点是允许基础架构团队的 Kubernetes 集群管理员自动创建大量不同的 Argo CD 应用程序，跨多个集群，并将这些应用程序作为单个单元进行管理。 &lt;em&gt;集群附加组件用例&lt;/em&gt; 就是其中一个例子。&lt;/p&gt;
&lt;p&gt;在 &lt;em&gt;集群附加组件用例&lt;/em&gt; 中，管理员负责为一个或多个 Kubernetes 集群配置集群附加组件：集群附加组件是 Operator，例如 &lt;a href=&#34;https://github.com/prometheus-operator/prometheus-operator&#34; title=&#34;Prometheus  Operator&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Prometheus  Operator&lt;/a&gt;
 或控制器，例如 &lt;a href=&#34;https://argoproj.github.io/argo-workflows/&#34; title=&#34;argo-workflows 控制器&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;argo-workflows 控制器&lt;/a&gt;
（&lt;a href=&#34;https://argoproj.github.io/&#34; title=&#34;Argo 生态系统&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Argo 生态系统&lt;/a&gt;
的一部分）。&lt;/p&gt;
&lt;p&gt;通常，这些附加组件是开发团队的应用程序所需的（例如作为多租户集群的租户，他们可能希望向 Prometheus 提供度量数据或通过 Argo Workflows 编排工作流程）。&lt;/p&gt;
&lt;p&gt;由于安装这些插件需要集群级别的权限，而这些权限不被单个开发团队持有，因此安装是组织的基础架构/运营团队的责任，在大型组织内，这个团队可能负责数十、数百或数千个 Kubernetes 集群（新集群定期添加/修改/删除）。&lt;/p&gt;
&lt;p&gt;需要在大量集群上扩展，并自动响应新集群的生命周期，这必然需要某种形式的自动化。进一步的要求是允许使用特定标准（例如，staging vs production）将附加组件针对子集群进行定位。&lt;/p&gt;
&lt;p&gt;&lt;figure class=&#34;mx-auto text-center&#34;&gt;
  
  
  
  
    
    &lt;img src=&#34;https://jimmysong.io/book/argo-cd/operator-manual/applicationset/use-cases/Cluster-Add-Ons.png&#34; data-img=&#34;/book/argo-cd/operator-manual/applicationset/use-cases/Cluster-Add-Ons.png&#34; data-width=&#34;835&#34; data-height=&#34;532&#34; alt=&#34;image&#34; data-caption=&#34;集群附加组件图&#34;&gt;
    
  
  &lt;figcaption&gt;集群附加组件图&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/p&gt;
&lt;p&gt;在这个例子中，基础架构团队维护一个包含 Argo Workflows 控制器和 Prometheus  Operator 应用程序清单的 Git 存储库。&lt;/p&gt;
&lt;p&gt;基础架构团队希望使用 Argo CD 将这两个插件部署到大量集群，并希望轻松管理新集群的创建/删除。&lt;/p&gt;
&lt;p&gt;在这个用例中，我们可以使用应用集控制器的 List、Cluster 或 Git 生成器中的任一个来提供所需的行为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;List 生成器：管理员维护两个 &lt;code&gt;ApplicationSet&lt;/code&gt; 资源，每个应用程序（工作流和 Prometheus）都包含它们希望在 List 生成器元素中定位的集群列表。
&lt;ul&gt;
&lt;li&gt;在该生成器中，添加/删除集群需要手动更新 &lt;code&gt;ApplicationSet&lt;/code&gt; 资源的列表元素。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Cluster 生成器：管理员维护两个 &lt;code&gt;ApplicationSet&lt;/code&gt;  资源，每个应用程序（工作流和 Prometheus）都确保在 Argo CD 中定义所有新集群。
&lt;ul&gt;
&lt;li&gt;由于 Cluster 生成器自动检测并针对 Argo CD 中定义的集群，添加/删除 Argo CD 中的集群 将自动导致应用集控制器创建 Application 资源（每个应用程序）。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Git 生成器：Git 生成器是生成器中最灵活/最强大的，因此有多种不同的方法来处理此用例。以下是其中的几个：
&lt;ul&gt;
&lt;li&gt;使用 Git 生成器的 &lt;code&gt;files&lt;/code&gt; 字段：将集群列表作为 JSON 文件保存在 Git 存储库中。通过 Git 提交更新 JSON 文件，会导致添加/删除新集群。&lt;/li&gt;
&lt;li&gt;使用 Git 生成器的 &lt;code&gt;directories&lt;/code&gt; 字段：对于每个目标集群，都在 Git 存储库中存在一个对应的同名目录。通过 Git 提交添加/修改目录，将触发共享目录名称的集群的更新。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有关每个生成器的详细信息，请参见 &lt;a href=&#34;../generator/&#34; title=&#34;生成器部分&#34;&gt;生成器部分&lt;/a&gt;
。&lt;/p&gt;
&lt;h2 id=&#34;用例单体库&#34;&gt;用例：单体库&lt;/h2&gt;
&lt;p&gt;在 &lt;em&gt;单体库用例&lt;/em&gt; 中，Kubernetes 集群管理员从单个 Git 存储库管理单个 Kubernetes 集群的整个状态。&lt;/p&gt;
&lt;p&gt;合并到 Git 存储库的清单更改应自动部署到集群。&lt;/p&gt;
&lt;p&gt;在这个例子中，基础架构团队维护一个包含 Argo Workflows 控制器和 Prometheus  Operator 应用程序清单的 Git 存储库。独立的开发团队还添加了他们希望部署到集群的其他服务。&lt;/p&gt;
&lt;p&gt;对 Git 生成器可能用于支持此用例：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Git 生成器的 &lt;code&gt;directories&lt;/code&gt; 字段可用于指定包含要部署的各个应用程序的特定子目录（使用通配符）。&lt;/li&gt;
&lt;li&gt;Git 生成器的 &lt;code&gt;files&lt;/code&gt; 字段可以引用包含 JSON 元数据的 Git 存储库文件，该元数据描述要部署的各个应用程序。&lt;/li&gt;
&lt;li&gt;更多详情请参见 Git 生成器文档。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;用例多租户集群上的-argo-cd-应用程序自助服务&#34;&gt;用例：多租户集群上的 Argo CD 应用程序自助服务&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;自助服务用例&lt;/em&gt; 旨在允许开发人员（作为多租户 Kubernetes 集群的最终用户）以自动化方式更灵活地执行以下操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 Argo CD 将多个应用程序部署到单个集群&lt;/li&gt;
&lt;li&gt;使用 Argo CD 自动化地部署到多个集群&lt;/li&gt;
&lt;li&gt;但在这两种情况下，使开发人员能够在不需要涉及集群管理员的情况下执行此操作（以代表他们创建所需的 Argo CD 应用程序/AppProject 资源）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个用例的一个潜在解决方案是，开发团队在 Git 存储库中定义 Argo CD &lt;code&gt;Application&lt;/code&gt; 资源（包含他们希望部署的清单），在 &lt;a href=&#34;../../cluster-bootstrapping/#app-of-apps-pattern&#34; title=&#34;app-of-apps 模式&#34;&gt;app-of-apps 模式&lt;/a&gt;
 中，并且集群管理员通过合并请求审查/接受对此存储库的更改。&lt;/p&gt;
&lt;p&gt;虽然这听起来像是一种有效的解决方案，但一个主要的劣势是需要高度的信任/审查来接受包含 Argo CD &lt;code&gt;Application&lt;/code&gt; 规范更改的提交。这是因为 &lt;code&gt;Application&lt;/code&gt; 规范中包含许多敏感字段，包括 &lt;code&gt;project&lt;/code&gt;、&lt;code&gt;cluster&lt;/code&gt; 和 &lt;code&gt;namespace&lt;/code&gt;。意外合并可能会允许应用程序访问其不属于的命名空间/集群。&lt;/p&gt;
&lt;p&gt;因此，在自助服务用例中，管理员希望仅允许开发人员控制 &lt;code&gt;Application&lt;/code&gt; 规范的某些字段（例如 Git 源存储库），但不允许控制其他字段（例如目标命名空间或目标集群应受到限制）。&lt;/p&gt;
&lt;p&gt;幸运的是，应用集控制器提供了另一种解决方案：集群管理员可以安全地创建包含 Git 生成器的 &lt;code&gt;ApplicationSet&lt;/code&gt; 资源，该生成器使用 &lt;code&gt;template&lt;/code&gt; 字段将应用程序资源的部署限制为固定值，同时允许开发人员随意自定义 &amp;lsquo;safe&amp;rsquo; 字段。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;ApplicationSet&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# (...)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;generators&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;git&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;repoURL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;https://github.com/argoproj/argo-cd.git&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;files&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;apps/**/config.json&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;template&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;project&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;dev-team-one&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 项目受到限制&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 开发人员可以使用上述 repo URL 中的 JSON 文件自定义应用程序详细信息&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;repoURL&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{{&lt;span class=&#34;l&#34;&gt;app.source}}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;targetRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{{&lt;span class=&#34;l&#34;&gt;app.revision}}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{{&lt;span class=&#34;l&#34;&gt;app.path}}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;destination&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;production-cluster&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 集群受到限制&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;dev-team-one&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 命名空间受到限制&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;有关更多详细信息，请参见 &lt;a href=&#34;../generators-git/&#34; title=&#34;Git 生成器&#34;&gt;Git 生成器&lt;/a&gt;
。&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>ApplicationSet 安全性</title>
      <link>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/security/</link>
      <pubDate>Fri, 30 Jun 2023 16:20:00 +0800</pubDate>
      
      <guid>https://jimmysong.io/book/argo-cd/operator-manual/applicationset/security/</guid>
      <description>
        
        
        &lt;p&gt;在使用 ApplicationSet 之前，了解其安全性影响非常重要。&lt;/p&gt;
&lt;h2 id=&#34;只有管理员可以创建更新删除-applicationset&#34;&gt;只有管理员可以创建/更新/删除 ApplicationSet&lt;/h2&gt;
&lt;p&gt;ApplicationSet 可以在任意 Project 下创建应用程序。Argo CD 设置通常包括高权限的 &lt;a href=&#34;../../user-guide/projects/&#34; title=&#34;Project&#34;&gt;Project&lt;/a&gt;
（例如 &lt;code&gt;default&lt;/code&gt;），往往包括管理 Argo CD 自身资源的能力（例如 RBAC ConfigMap）。&lt;/p&gt;
&lt;p&gt;ApplicationSets 还可以快速创建任意数量的应用程序，并同样快速删除它们。&lt;/p&gt;
&lt;p&gt;最后，ApplicationSets 可以显示特权信息。例如，&lt;a href=&#34;../generators-git/&#34; title=&#34;git generator&#34;&gt;git generator&lt;/a&gt;
 可以读取 Argo CD 命名空间中的 Secrets，并将其作为 Auth 标头发送到任意 URL（例如为 &lt;code&gt;api&lt;/code&gt; 字段提供的 URL）。 （此功能旨在为 SCM 提供程序（如 GitHub）授权请求，但可能会被恶意用户滥用。）&lt;/p&gt;
&lt;p&gt;出于这些原因，&lt;strong&gt;只有管理员&lt;/strong&gt;可以通过 Kubernetes RBAC 或任何其他机制获得创建、更新或删除 ApplicationSets 的权限。&lt;/p&gt;
&lt;h2 id=&#34;管理员必须为-applicationsets-的真实来源应用适当的控制&#34;&gt;&lt;strong&gt;管理员必须为 ApplicationSets 的真实来源应用适当的控制&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;即使非管理员不能创建 ApplicationSet 资源，他们也可能影响 ApplicationSets 的行为。&lt;/p&gt;
&lt;p&gt;例如，如果 ApplicationSet 使用 &lt;a href=&#34;../generators-git/&#34; title=&#34;git generator&#34;&gt;git generator&lt;/a&gt;
，则具有源 Git 存储库的推送访问权限的恶意用户可能会生成过多的应用程序，对 ApplicationSet 和应用程序控制器造成压力。他们还可能导致 SCM 提供者的速率限制生效，影响 ApplicationSet 服务。&lt;/p&gt;
&lt;h3 id=&#34;模板化的project字段&#34;&gt;&lt;strong&gt;模板化的“project”字段&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;特别需要注意使用模板化的“project”字段的 ApplicationSet。具有写权限的恶意用户（例如，具有对 git generator 的 git repo 的推送访问权限的用户）可能会在限制不足的 Projects 下创建应用程序。具有在不受限制的 Project（如“default”Project）下创建应用程序的能力的恶意用户可能会通过修改其 RBAC ConfigMap 等方式接管 Argo CD 本身。&lt;/p&gt;
&lt;p&gt;如果 ApplicationSet 的模板中未硬编码“project”字段，则管理员&lt;em&gt;必须&lt;/em&gt;控制 ApplicationSet 的生成器的所有来源。&lt;/p&gt;

      </description>
    </item>
    
  </channel>
</rss>
