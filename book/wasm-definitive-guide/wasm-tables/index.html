<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>WebAssembly 表 - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="这篇文章是《WebAssembly 权威指南》一书的第七章，介绍了 WebAssembly 的表（table）的概念和用法。表是一种存储函数指针的数据结构，可以让模块间动态地调用彼此的函数。文章分析了表的类型、元素、导入和导出等特性，并给出了几个使用表的示例代码，包括 C/C&#43;&#43; 和 JavaScript 的互操作。文章最后讨论了表的局限性和未来发展方向。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.f6911c0ac7d2b5b69c3f2d9f2a2b3b496b5da0608580347fdb4dc11ef74f3ec5.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/book/wasm-definitive-guide/wasm-tables/" />
  <meta property="og:title" content="WebAssembly 表 | Jimmy Song" />
  <meta property="twitter:title" content="WebAssembly 表 | Jimmy Song" />

  
  <meta property="og:description" content="这篇文章是《WebAssembly 权威指南》一书的第七章，介绍了 WebAssembly 的表（table）的概念和用法。表是一种存储函数指针的数据结构，可以让模块间动态地调用彼此的函数。文章分析了表的类型、元素、导入和导出等特性，并给出了几个使用表的示例代码，包括 C/C&#43;&#43; 和 JavaScript 的互操作。文章最后讨论了表的局限性和未来发展方向。" />
  <meta property="twitter:description" content="这篇文章是《WebAssembly 权威指南》一书的第七章，介绍了 WebAssembly 的表（table）的概念和用法。表是一种存储函数指针的数据结构，可以让模块间动态地调用彼此的函数。文章分析了表的类型、元素、导入和导出等特性，并给出了几个使用表的示例代码，包括 C/C&#43;&#43; 和 JavaScript 的互操作。文章最后讨论了表的局限性和未来发展方向。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xxl book-padding">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

        

<div class="blog book book-padding">
  <div class="container-xxl d-flex">
    <aside class="docs-sidebar d-none col-sm-2">
      <nav class="collapse docs-links box-shadow mb-4 sticky-top aside-toc d-none d-sm-block pt-4" id="docs-nav">

  
  
  
  
  
  

  
  
    

    
      
      
      
      
        
          
        
      



  
    
    
    
    
      
    
    

    
      
      
        
      
        <div class="docs-toc-item root">
          
          
            <div class="docs-toc-title d-flex mb-0 justify-content-start">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/wasm-definitive-guide/">WebAssembly 权威指南</a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  show " id="id42c08c6ee449a32bf771395037ac34f0">
          



  <li class="leaf"><a href="/book/wasm-definitive-guide/foreword/">译者序</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/introduction/">第 1 章：简介</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/hello-world/">第 2 章：入门</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/wasm-modules/">第 3 章：WebAssembly 模块</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/wasm-memory/">第 4 章：WebAssembly 内存</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/using-c-cpp-and-wasm/">第 5 章：使用 C/C&#43;&#43; 和 WebAssembly</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/apply-wasm-lagacy-code-in-the-browser/">第 6 章：使用 WebAssembly 在浏览器中运行遗留代码</a></li>




  <li class="leaf active"><a href="/book/wasm-definitive-guide/wasm-tables/">第 7 章：WebAssembly 表</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/wasm-in-the-server/">第 8 章：在服务器中运行 WebAssembly</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/applied-wasm-tensorflow-js/">第 9 章：WebAssembly 在 TensorFlow.js 中的应用</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/rust/">第 10 章：Rust</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/wasi/">第 11 章：WASI（WebAssembly 系统接口）</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/extending-wasm-platform/">第 12 章：扩展 WebAssembly 平台</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/applied-wasm-cloud-and-edge/">第 15 章：云和边缘计算场景下的 WebAssembly 应用</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/applied-wasm-decentralized-apps/">第 16 章：WebAssembly 的去中心化应用</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/wasm-and-other-languages/">第 17 章：WebAssembly 和其他语言</a></li>




  <li class="leaf"><a href="/book/wasm-definitive-guide/appendix/appendix/">附录</a></li>

          
            </ul>
          
        

        
          </div>
        

    
  
</nav>

    </aside>

    
    <aside class="docs-toc d-none d-xl-block col-xl-2 px-2">
      <div class="sidebar">
      
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#静态链接与动态链接">静态链接与动态链接</a></li>
    <li><a href="#在模块中创建表">在模块中创建表</a></li>
    <li><a href="#webassembly-中的动态链接">WebAssembly 中的动态链接</a></li>
    <li><a href="#注释">注释</a></li>
  </ul>
</nav>
  </div>



      

      </div>
    </aside>

    <main class="py-md-3 pl-md-3 mt-2 col-lg-8 p-0" role="main">
      <div class="row">
            <div class="col-12">
                <div class="mb-2">
                    <nav aria-label="breadcrumb" class="page-breadcrumb">
    <ol class="breadcrumb mb-0">
    
          
      
        
      
        
      
        
      
    
            
      
    
            
              <li class="breadcrumb-item"><a href="/book/">资料</a></li>
            
      
    
            
              <li class="breadcrumb-item"><a href="/book/wasm-definitive-guide/">WebAssembly 权威指南</a></li>
            
      
    
          <li class="breadcrumb-item active" aria-current="page">第 7 章：WebAssembly 表</li>
    

    
    </ol>
</nav>

                </div>
              <hr class="mt-0">
              <h1 class="mb-3">
               WebAssembly 表
              </h1>
              
                <div class="book-page-metadata mb-3">
                    <ul class="list-inline">
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                            </span>2023/01/26</li>
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                            </span>22 分钟</li>
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-file-word"></i>
                            </span>4775 字</li>
                    </ul>
                </div>
              
              
                <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#静态链接与动态链接">静态链接与动态链接</a></li>
    <li><a href="#在模块中创建表">在模块中创建表</a></li>
    <li><a href="#webassembly-中的动态链接">WebAssembly 中的动态链接</a></li>
    <li><a href="#注释">注释</a></li>
  </ul>
</nav>
</details>

              
            </div>
        </div>

      <article class="border-bottom content mb-4">
          <blockquote>
<p>译者注：这篇文章是《WebAssembly 权威指南》一书的第七章，介绍了 WebAssembly 的表（table）的概念和用法。表是一种存储函数指针的数据结构，可以让模块间动态地调用彼此的函数。文章分析了表的类型、元素、导入和导出等特性，并给出了几个使用表的示例代码，包括 C/C++ 和 JavaScript 的互操作。文章最后讨论了表的局限性和未来发展方向。</p>
</blockquote>
<p>人们经常在餐桌上分享自己的想法和故事。与他人一起吃饭比自己一个人吃饭更有趣。如果你把一群来自各行各业的人聚集在一起，可能有谈不完的话题。没有人可以面面俱到。有的人可能分享相同故事的某些方面。其他人可能有他们自己的版本。然而必须有一定的礼仪、克制，并愿意接受其他参与者提供的东西。那些行为不端、喋喋不休或相互踩线的客人会毁了大家的晚餐。</p>
<p>表是 WebAssembly 成为一个现代软件系统的一个特点，其功能依赖将由额外的模块来满足。与静态链接库相比，它提供了相当于动态共享库的能力。不是每个模块都需要具有所有功能才能工作。这将使效率低的可怕。相反，它是根据一些其他模块在运行时满足需求的承诺来编写的。这在 C 和 C++ 世界中被称为动态链接。很明显，餐桌论只是对表（Table）这个词的玩味，就像在吃饭时需要礼仪一样，库之间的分享也需要规范。让我们更仔细地探讨这个想法，然后看看 WebAssembly 是如何支持的。</p>
<h2 id="静态链接与动态链接">静态链接与动态链接</h2>
<p>任何在 Twitter 上关注我的人都知道我妻子是一个多么了不起的厨师。她来自一个伟大的厨师家庭，有机会向很多大师学习。人们经常看到我发布的关于她制烹饪的帖子，并向我索取食谱。这通常不像发送一个链接那么容易，因为她经常把来自多个来源的想法结合起来，然后把自己的想法放在上面。</p>
<p>在我们家，她可以依靠她所积累的食谱库。她可以说，&ldquo;用那本书里的酱汁做这个。用另一本书中描述的技术准备牛肉。在牛肉达到你想要的熟度后，加入这些我认为会让它变得更好的额外成分&rdquo;。</p>
<p>在我们家，她可以参考已知来源的步骤和配料表，并以她的额外步骤修正过程。但是当她想把菜谱交给别人时，她不能默认人们有这些书。在这种情况下，她将不得不把她的来源中的食谱复制到完整的食谱文件中。这时，所有的步骤和成分都会被定义在一个地方，食谱就可以发给别人了。</p>
<p>这基本上就是静态链接和动态链接的区别。一个典型的程序需要读写文件的内容，打开窗口，收集用户的输入，或在网络上发送消息。这些都是很常见的任务，它们通常可以作为操作系统提供的库中的功能。当你希望使用其中的一个函数时，你会告诉链接器允许运行时链接。否则，它将抱怨缺少符号参考。</p>
<p>在运行时，操作系统将搜索其配置路径，告诉它在哪里可以找到这些共享库。在启动程序之前，它将把库中的功能映射到一个可以动态链接到其余代码的内存位置。
这样做有很多原因。首先是效率问题。比方说，你有一个名为 <code>a ()</code> 的函数被十几个其他程序引用。通过静态链接，每个可执行程序都有自己的副本。程序占用了更多的磁盘空间。它们在运行时的内存足迹也会变大。这不将浪费磁盘和内存空间。</p>
<p>如果动态库被加载到一个共享的内存空间，那么我们的磁盘上只需要一个文件副本。根据你的操作系统的复杂性，内存中可能也只需要一个副本。</p>
<p>动态链接库通常有自己的发布周期。如果你正在使用一个可执行程序的系统库，你可能会更新操作系统并得到一个带有安全补丁的新版本的库。只要编号机制正常，并且是向后兼容的，就可以通过使用打了补丁的版本来加强你的应用程序的安全性，而不需要做任何其他事情。</p>
<p>请看例 7-1，这是一个独立的函数，没有 <code>main ()</code> 函数。它的目的是作为一个库来使用。我们可以把它编译成一个静态库，但现在我们只需创建目标代码，并将我们的 <code>main ()</code> 程序与之链接。注意，这个函数也依赖于 <code>printf ()</code>，所以它必须导入 <code>stdio.h</code> 头。</p>
<p>例 7-1. 一个有函数调用的库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sayHello</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span> <span class="p">(</span><span class="s">&#34;% s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在例 7-2 中，你会看到 <code>main ()</code> 函数首先调用 <code>printf ()</code>，然后再调用我们的函数，该函数也调用 <code>printf ()</code>。</p>
<p>例 7-2. 一个调用库函数的  <code>main ()</code> 方法示例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">sayHello</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span> <span class="p">(</span><span class="s">&#34;Hello, world.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">sayHello</span> <span class="p">(</span><span class="s">&#34;How are you?&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认情况下，如果你用 clang 编译这两个文件，它将生成一个输出文件。我们使用默认的名字。当我们运行它时，我们会看到我们所期望的行为。默认情况下，编译器将对系统库使用动态链接，以满足我已经列出的所有需求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; clang main.c library.c brian@tweezer ~/g/w/s/ch07&gt; ls
</span></span><span class="line"><span class="cl">a.out* library.c main.c
</span></span><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; ./a.out
</span></span><span class="line"><span class="cl">Hello, world.
</span></span><span class="line"><span class="cl">How are you?
</span></span></code></pre></div><p>你可以用 nm 命令验证这里使用了动态链接。首先，我们看到我们的二进制文件提供了 <code>main ()</code> 和 <code>sayHello ()</code> 的定义，但没有 <code>printf ()</code>。这是从标准库中重复使用的函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; nm a.out 
</span></span><span class="line"><span class="cl"><span class="m">0000000100008008</span> d __dyld_private 
</span></span><span class="line"><span class="cl"><span class="m">0000000100000000</span> T __mh_execute_header
</span></span><span class="line"><span class="cl">0000000100003f10 T _main
</span></span><span class="line"><span class="cl">                 U _printf
</span></span><span class="line"><span class="cl">0000000100003f50 T _sayHello
</span></span><span class="line"><span class="cl">                 U dyld_stub_binder
</span></span></code></pre></div><p>在 Linux 上，你可以看到同样的构建步骤产生了一个带有额外功能的二进制文件。这很自然，因为它是一个不同的操作系统，有不同的运行时和不同的二进制格式。突出的一点是，我们的方法是在二进制文件中提供的，但 <code>printf ()</code> 却没有。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@bbfcfm:~/src/hello$ nm a.out
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> B __bss_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> b completed.8060
</span></span><span class="line"><span class="cl"><span class="m">0000000000404020</span> D __data_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404020</span> W data_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000401080</span> t deregister_tm_clones
</span></span><span class="line"><span class="cl"><span class="m">0000000000401070</span> T _dl_relocate_static_pie
</span></span><span class="line"><span class="cl">00000000004010f0 t __do_global_dtors_aux
</span></span><span class="line"><span class="cl">0000000000403e08 d __do_global_dtors_aux_fini_array_entry <span class="m">0000000000404028</span> D __dso_handle
</span></span><span class="line"><span class="cl">0000000000403e10 d _DYNAMIC
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> D _edata
</span></span><span class="line"><span class="cl"><span class="m">0000000000404038</span> B _end
</span></span><span class="line"><span class="cl"><span class="m">0000000000401218</span> T _fini
</span></span><span class="line"><span class="cl"><span class="m">0000000000401120</span> t frame_dummy
</span></span><span class="line"><span class="cl">0000000000403e00 d __frame_dummy_init_array_entry
</span></span><span class="line"><span class="cl">000000000040216c r __FRAME_END__
</span></span><span class="line"><span class="cl"><span class="m">0000000000404000</span> d _GLOBAL_OFFSET_TABLE_
</span></span><span class="line"><span class="cl">                 w __gmon_start__
</span></span><span class="line"><span class="cl"><span class="m">0000000000402024</span> r __GNU_EH_FRAME_HDR
</span></span><span class="line"><span class="cl"><span class="m">0000000000401000</span> T _init
</span></span><span class="line"><span class="cl">0000000000403e08 d __init_array_end
</span></span><span class="line"><span class="cl">0000000000403e00 d __init_array_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000402000</span> R _IO_stdin_used
</span></span><span class="line"><span class="cl"><span class="m">0000000000401210</span> T __libc_csu_fini
</span></span><span class="line"><span class="cl">00000000004011a0 T __libc_csu_init
</span></span><span class="line"><span class="cl">                 U __libc_start_main@@GLIBC_2.2.5
</span></span><span class="line"><span class="cl"><span class="m">0000000000401130</span> T main
</span></span><span class="line"><span class="cl">                 U printf@@GLIBC_2.2.5
</span></span><span class="line"><span class="cl">00000000004010b0 t register_tm_clones
</span></span><span class="line"><span class="cl"><span class="m">0000000000401170</span> T sayHello
</span></span><span class="line"><span class="cl"><span class="m">0000000000401040</span> T _start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> D __TMC_END__
</span></span></code></pre></div><p>otool 命令是另一个可以在 macOS 上使用的命令，它可以显示哪些动态库是成功执行你的二进制文件所需要的。显示的是系统库的 macOS 版本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; otool -L a.out 
</span></span><span class="line"><span class="cl">a.out:
</span></span><span class="line"><span class="cl">   /usr/lib/libSystem.B.dylib <span class="o">(</span>compatibility vers 1.0.0, current vers 1292.60.1<span class="o">)</span>
</span></span></code></pre></div><p>otool 在 Linux 上并不存在，但我们可以通过使用 objdump 看到类似的结果。为了节省空间，我把部分输出删除了，但相关部分显示在下面的片段中。在 Windows 上也会有类似的工具来检查你的 DLL 依赖性。正如你所看到的，我们需要 <code>libc.so.6</code> 来满足我们二进制文件的需要。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@bbfcfm:~/src/hello$ objdump -x a.out
</span></span><span class="line"><span class="cl">    a.out:     file format elf64-x86-64
</span></span><span class="line"><span class="cl">    a.out
</span></span><span class="line"><span class="cl">    architecture: i386:x86-64, flags 0x00000112:
</span></span><span class="line"><span class="cl">    EXEC_P, HAS_SYMS, D_PAGED
</span></span><span class="line"><span class="cl">    start address 0x0000000000401040
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Dynamic Section:
</span></span><span class="line"><span class="cl">  NEEDED        	libc.so.6
</span></span><span class="line"><span class="cl">  INIT          	0x0000000000401000
</span></span><span class="line"><span class="cl">  FINI	          0x0000000000401218
</span></span><span class="line"><span class="cl">  INIT_ARRAY	    0x0000000000403e00
</span></span><span class="line"><span class="cl">  INIT_ARRAYSZ  	0x0000000000000008
</span></span><span class="line"><span class="cl">  FINI_ARRAY	    0x0000000000403e08
</span></span><span class="line"><span class="cl">  FINI_ARRAYSZ  	0x0000000000000008
</span></span><span class="line"><span class="cl">  HASH	          0x00000000004002e8
</span></span><span class="line"><span class="cl">  GNU_HASH      	0x0000000000400310
</span></span><span class="line"><span class="cl">  STRTAB	        0x0000000000400390
</span></span><span class="line"><span class="cl">  SYMTAB	        0x0000000000400330
</span></span><span class="line"><span class="cl">  STRSZ         	0x000000000000003f
</span></span><span class="line"><span class="cl">  SYMENT	        0x0000000000000018
</span></span><span class="line"><span class="cl">  DEBUG	          0x0000000000000000
</span></span><span class="line"><span class="cl">  PLTGOT	        0x0000000000404000
</span></span><span class="line"><span class="cl">  PLTRELSZ	      0x0000000000000018
</span></span><span class="line"><span class="cl">  PLTREL	        0x0000000000000007
</span></span><span class="line"><span class="cl">  JMPREL	        0x0000000000400428
</span></span><span class="line"><span class="cl">  RELA	          0x00000000004003f8
</span></span><span class="line"><span class="cl">  RELASZ	        0x0000000000000030
</span></span><span class="line"><span class="cl">  RELAENT	        0x0000000000000018
</span></span><span class="line"><span class="cl">  VERNEED	        0x00000000004003d8
</span></span><span class="line"><span class="cl">  VERNEEDNUM    	0x0000000000000001
</span></span><span class="line"><span class="cl">  VERSYM        	0x00000000004003d0
</span></span><span class="line"><span class="cl">Version References:
</span></span><span class="line"><span class="cl">  required from libc.so.6:
</span></span><span class="line"><span class="cl">    0x09691a75 0x00 <span class="m">02</span> GLIBC_2.2.5
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>WebAssembly 与操作系统显然不是一回事，但它得益于类似的概念。我们的选择是一样的：把所有的函数定义放到一个模块里，这样它就可以独立存在，或者从另一个模块调用行为，以满足我们的需要。考虑到我们要经常通过网络下载 WebAssembly 模块，让它们偏小是可取的。这也会影响到磁盘存储、模块验证、在内存中加载实例等。为此，我们有 Table 实例。</p>
<h2 id="在模块中创建表">在模块中创建表</h2>
<p>Table 实例有一些类似于我们在<a href="../wasm-memeory/" title="第 4 章">第 4 章</a>中介绍的 Memory 实例的特征。目前每个模块只能有一个，但它可以在模块中定义，也可以通过导入的对象传入。每个模块只有一个实例的限制在未来可能会被取消，但目前我们必须遵守这一规定。</p>
<p>我们在 WebAssembly 中采用这种结构，而不是仅仅使用 Memory 实例，部分原因是后者可以被模块操纵。进行晚餐谈话，我们不希望任何个人参与者改写行为准则。在共享模块上也是如此。如果我们已经加载并验证了一个通过表实例导出函数的模块，我们不希望另一个模块给其他人带来麻烦。因此，你所能做的就是对存储在表中的函数引用进行间接函数调用。目前，函数引用是唯一可以存储在表实例中的东西，但这也有望在未来改变。</p>
<p>在这一点上，我不想把事情搞得太复杂，回到 Wat 中的简单函数定义，以演示创建表实例和导出它们的方法。</p>
<p>在例 7-3 中，我创建了两个函数。<code>$add</code> 函数接收两个参数，将它们相加，然后返回结果。<code>$sub</code> 函数接收两个参数，用第一个参数减去第二个参数，然后返回结果。那又怎样呢？这不过是复习前几章的内容。这里的区别在于接下来会发生什么。</p>
<p>例 7-3. 一个导出其表实例的模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$add</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.add<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$sub</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.sub<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>table <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;tbl&#34;</span><span class="o">)</span> funcref <span class="o">(</span>elem <span class="nv">$add</span> <span class="nv">$sub</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>我们引入了一个新的 Wat 关键字 ——table。这定义了一个函数引用的集合。注意内联导出命令。这允许主机环境调用 <code>$add</code> 和 <code>$sub</code> 函数，但不能通过函数名称调用。宿主只能通过表的实例来调用这两个函数。Anyfunc 类型目前是这个结构唯一允许的类型，正如我们之前指出的那样。根据 elem 引用中的排序，<code>$add</code> 将在第 0 个位置，<code>$sub</code> 将在第 1 个位置 <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>我们可以把我们的 Wat 文件变成一个 Wasm 模块，并检查其内容，如下所示。注意表部分、类型部分和导出部分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; wat2wasm math.wat 
</span></span><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; wasm-objdump -x math.wasm
</span></span><span class="line"><span class="cl">    math.wasm:      file format wasm 0x1
</span></span><span class="line"><span class="cl">    Section Details:
</span></span><span class="line"><span class="cl">    Type <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - <span class="nb">type</span> <span class="o">[</span>0<span class="o">]</span> <span class="o">(</span>i32, i32<span class="o">)</span> -&gt; i32
</span></span><span class="line"><span class="cl">    Function <span class="o">[</span>2<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>0<span class="o">]</span> <span class="nv">sig</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>1<span class="o">]</span> <span class="nv">sig</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    Table <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - table <span class="o">[</span>0<span class="o">]</span> <span class="nv">type</span><span class="o">=</span>funcref <span class="nv">initial</span><span class="o">=</span><span class="m">2</span> <span class="nv">max</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">    Export <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - table <span class="o">[</span>0<span class="o">]</span> -&gt; <span class="s2">&#34;tbl&#34;</span>
</span></span><span class="line"><span class="cl">    Elem <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - segment <span class="o">[</span>0<span class="o">]</span> <span class="nv">flags</span><span class="o">=</span><span class="m">0</span> <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">count</span><span class="o">=</span><span class="m">2</span> - init <span class="nv">i32</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">      - elem <span class="o">[</span>0<span class="o">]</span> <span class="o">=</span> func <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">      - elem <span class="o">[</span>1<span class="o">]</span> <span class="o">=</span> func <span class="o">[</span>1<span class="o">]</span>
</span></span><span class="line"><span class="cl">    Code <span class="o">[</span>2<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>0<span class="o">]</span> <span class="nv">size</span><span class="o">=</span><span class="m">7</span>
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>1<span class="o">]</span> <span class="nv">size</span><span class="o">=</span><span class="m">7</span>
</span></span></code></pre></div><p>例 7-4 中的 JavaScript 实例化了我们的模块，就像我们在之前章节中做的那样。从那里，它从模块的导出部分提取 Table 实例。</p>
<p>例 7-4. 使用从 JavaScript 导出的表实例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!doctype html&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WASM Table test<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;utils.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;data:;base64,=&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">fetchAndInstantiate</span> <span class="p">(</span><span class="s1">&#39;math.wasm&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">tbl</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">tbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">t</span> <span class="o">=</span> <span class="nx">tbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;3 + 1 =&#34;</span> <span class="o">+</span> <span class="nx">tbl</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;3 - 1 =&#34;</span> <span class="o">+</span> <span class="nx">tbl</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>在我们获取引用后，我们可以检索到与第 0 个位置相关的函数并调用它。请记住，从<code>get ()</code> 调用回来的是一个函数的引用。为了调用它，我们提交第二组括号中的参数，然后将结果打印到控制台。然后我们对第 1 个位置上的函数也这样做。</p>
<p>通过 HTTP 发送 HTML，并打开 JavaScript 控制台。当你的浏览器执行该代码时，它应该如图 7-1 所示。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          
          <picture>
           <source srcset="/book/wasm-definitive-guide/wasm-tables/f7-1_hu1133915424773536760.webp" type="image/webp">
           <img src="/book/wasm-definitive-guide/wasm-tables/f7-1.png" data-img="/book/wasm-definitive-guide/wasm-tables/f7-1.png" data-width="1894" data-height="448" alt="image" data-caption="图 7-1. 通过表实例调用方法的输出结果">
          </picture>
        
      
    
  
  
  <figcaption>图 7-1. 通过表实例调用方法的输出结果</figcaption>
  
</figure>
<p>表实例只能有两个引用。如果你试图访问一个超过 <code>tbl.length</code> 的位置，就会引起一个异常。</p>
<h2 id="webassembly-中的动态链接">WebAssembly 中的动态链接</h2>
<p>我们的最后一个例子是在 WebAssembly 中使用动态链接。我们将定义两个模块。一个将包含我们预先定义的 <code>$add</code> 和 <code>$sub</code> 方法。第一个模块在例 7-5 中。与我们之前看到的主要区别是，这个模块从主机中导入了一个表。我们用 elem 指令将算术函数放入这个表中。加法函数被存放在 0 号位置，减法函数被存放在 1 号位置。</p>
<p>例 7-5. 一个动态链接的模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>import <span class="s2">&#34;js&#34;</span> <span class="s2">&#34;table&#34;</span> <span class="o">(</span>table <span class="m">2</span> funcref<span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$add</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.add<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$sub</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      local.get <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.sub<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>elem <span class="o">(</span>i32.const 0<span class="o">)</span> <span class="nv">$add</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>elem <span class="o">(</span>i32.const 1<span class="o">)</span> <span class="nv">$sub</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>我们的第二个模块将输出两个函数，myadd 和 mysub。它向其客户宣传加减两个数字的能力。在内部，它将调用导入表实例中的函数引用，我们也从主机的 JavaScript 环境中导入。</p>
<p>我们所宣传的功能的实现见于例 7-6。两个函数都调用了 <code>call_indirect</code> 指令。在前面的章节中，我们看到使用调用指令来调用当前模块中定义的函数。call_indirect 指令通过确定你想调用的表的哪个元素来调用一个函数。</p>
<p>例 7-6. 依赖于动态链接模块的一个模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>import <span class="s2">&#34;js&#34;</span> <span class="s2">&#34;table&#34;</span> <span class="o">(</span>table <span class="m">2</span> funcref<span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span> <span class="o">(</span>func <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;myadd&#34;</span><span class="o">)</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">(</span>call_indirect <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span><span class="o">)</span> <span class="o">(</span>local.get <span class="nv">$a</span><span class="o">)</span> <span class="o">(</span>local.get <span class="nv">$b</span><span class="o">)</span> <span class="o">(</span>i32.const 0<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;mysub&#34;</span><span class="o">)</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">(</span>call_indirect <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span><span class="o">)</span> <span class="o">(</span>local.get <span class="nv">$a</span><span class="o">)</span> <span class="o">(</span>local.get <span class="nv">$b</span><span class="o">)</span> <span class="o">(</span>i32.const 1<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>其中一个会让你眼前一亮的东西是类型指令的使用。这将定义一个函数的签名，以便在 WebAssembly 中提供一定程度的类型安全。我们的想法是，导入的表函数应该有你想要调用的签名。</p>
<p>在这种情况下，我们定义了一个函数签名，它接收两个 i32 并返回一个 i32。当我们通过表调用这些方法时，表明这是我们所期望的类型。在签名之后，我们将函数的参数推到堆栈中，最后推到表的位置号。对于加法，它的常量值是 0，代表表的第一个位置。对于减法，它将是第二个位置。</p>
<p>我们在例 7-7 中把这一切放在一起。我们做的第一件事是创建一个共享的表实例。这将通过 <code>importObject</code> 传递给两个模块。不同的是，<code>math2.wat</code> 模块将其函数 <code>$add</code> 和 <code>$sub</code> 分别写在 0 和 1 的位置。<code>mymath.wat</code> 模块从主机 JavaScript 环境中调用 <code>myadd</code> 和 <code>mysub</code> 时间接地调用了这些位置。作为调用的一部分，它们也将把它们被赋予的参数传递给动态链接的函数。</p>
<p>因为我们处理的是两个模块，所以我们的实例化机制略有不同。我们调用 <code>Promise.all ()</code> 方法，而不是等待一个单一的 Promise，该方法会阻止所有的从属 Promise 得到满足。在这种情况下，这意味着两个模块都已加载并准备就绪。</p>
<p>例 7-7. 实例化两个模块并在它们之间建立动态链接</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!doctype html&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WASM Dynamic Linking test<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;utils.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;data:;base64,=&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">importObject</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">js</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">memory</span><span class="o">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">({</span> <span class="nx">initial</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">table</span><span class="o">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Table</span><span class="p">({</span> <span class="nx">initial</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">element</span><span class="o">:</span><span class="s2">&#34;anyfunc&#34;</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">          <span class="nx">fetchAndInstantiate</span><span class="p">(</span><span class="s1">&#39;math2.wasm&#39;</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">fetchAndInstantiate</span><span class="p">(</span><span class="s1">&#39;mymath.wasm&#39;</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">instances</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;4 + 3 = &#34;</span> <span class="o">+</span> <span class="nx">instances</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">exports</span><span class="p">.</span><span class="nx">myadd</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;4 - 3 = &#34;</span> <span class="o">+</span> <span class="nx">instances</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">exports</span><span class="p">.</span><span class="nx">mysub</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>一旦模块都可用，这段代码就用一些参数调用 <code>myadd</code> 和 <code>mysub</code> 方法。注意我们正在选择第二个模块实例，代表我们的行为版本。这是一个数组的实例，而不是一个单一的实例。</p>
<p>在通过 HTTP 提供服务后，浏览器中的结果如图 7-2 所示。一个模块通过共享的 Table 实例间接调用在另一个模块中实现的行为。</p>
<figure class="mx-auto text-center">
  
  
  
    
      
        
          
          <picture>
           <source srcset="/book/wasm-definitive-guide/wasm-tables/f7-2_hu16532374438698465361.webp" type="image/webp">
           <img src="/book/wasm-definitive-guide/wasm-tables/f7-2.png" data-img="/book/wasm-definitive-guide/wasm-tables/f7-2.png" data-width="1890" data-height="414" alt="image" data-caption="图 7-2. 调用我们的动态链接函数的输出结果">
          </picture>
        
      
    
  
  
  <figcaption>图 7-2. 调用我们的动态链接函数的输出结果</figcaption>
  
</figure>
<p>至此，我们对 WebAssembly 作为一个平台的主要功能元素的介绍结束了。本书的其余部分将以这些基础知识为基础，向你展示几个例子，介绍如何使用 WebAssembly，以及它的未来。包括一些我们尚未涉及的更高级的功能。</p>
<h2 id="注释">注释</h2>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>基于 0 的集合中的第二个位置。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

      </article>
      <div class="mb-4">
          <p>最后更新于 2024/12/03</p>
          


          


          
            


    
    





    




    

    

    

    

    

    

    

    
        
    

    

    

    

    

    

    

    

    

    






    



    


<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="previous mr-4">
        <a href="https://jimmysong.io/book/wasm-definitive-guide/apply-wasm-lagacy-code-in-the-browser/" class="d-flex flex-column align-items-start">
            <span class="nav mb-2 text-color-dark">&larr; 上一篇</span>
            <span class="text-align-left">使用 WebAssembly 在浏览器中运行遗留代码</span>
        </a>
    </div>
    

    
    <div class="next">
        <a href="https://jimmysong.io/book/wasm-definitive-guide/wasm-in-the-server/" class="d-flex flex-column align-items-end">
            <span class="nav mb-2 text-color-dark">下一篇 &rarr;</span>
            <span class="text-align-right">在服务器中运行 WebAssembly</span>
        </a>
    </div>
     
</div>

          
          <div class="body-footer">
            
          </div>
      </div>
    </main>
  </div>
</div>


<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay  book-padding ">
    <div class="container-xxl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/istio-sidecar-vs-ambient-network-cost-performance/">Istio sidecar 和 ambient 模式的网络成本对比</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/mindmap-review/">思维导图工具评测：为什么我选择 Whimsical</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/follow-is-review/">Follow.is 使用体验分享：高效信息管理的智能工具</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/kubecon-china-2024-panel/">KubeCon China 2024（香港）</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/website-revamp-notice/">网站改版通知</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xxl book-padding">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2024 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
