<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="utf-8">
  
  <title>Web 应用防火墙（WAF） - Jimmy Song</title>
  

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="介绍如何在 Envoy 中使用 WAF，以 Coraza 为例。">
  <meta name="author" content="Jimmy Song">
  <meta name="generator" content="Hugo 0.136.0">

  <!-- CSS plugins -->
  
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
    
    
      
    
  
  
  <link rel="preload" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" as="style">
  <link rel="stylesheet" href="/css/combined.7ac6b2864cb09c5595ac8ca79f8ca0db6c69a657edac885ba2c2412080d68da0.css" media="screen">
  

  <!-- Main Stylesheet -->
  
  <link rel="preload" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" as="style">
  <link rel="stylesheet" href="/scss/style.min.784204edcd29c092198e88494fa2ae755eba9ae231d6fa7faf8e7da3207b4623.css" media="screen">

  <!-- Bigger picture css -->
  
  <link rel="stylesheet" href="/plugins/bigger-picture/bigger-picture.min.css" media="print" onload="this.media='all'">
  <!--Favicon generate by https://realfavicongenerator.net-->
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="200x200" href="/images/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">

  <link href='/opensearchdescription.xml' rel='search' title='Content search' type='application/opensearchdescription+xml'/>

  <!--Twitter card-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="jimmysong.io" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/book/envoy-made-simple/security/waf/" />
  <meta property="og:title" content="Web 应用防火墙（WAF） | Jimmy Song" />
  <meta property="twitter:title" content="Web 应用防火墙（WAF） | Jimmy Song" />

  
  <meta property="og:description" content="介绍如何在 Envoy 中使用 WAF，以 Coraza 为例。" />
  <meta property="twitter:description" content="介绍如何在 Envoy 中使用 WAF，以 Coraza 为例。" />

  
  <meta property="og:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />
  <meta property="twitter:image" content="https://jimmysong.io/images/backgrounds/favicon.png" />

  
  
</head>
<body>
<header class="fixed-top header">
  
  
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa fa-arrow-circle-up" aria-hidden="true"></i></button>
  
  <div class="navigation w-100 ">
    <div class="container-xxl book-padding">
      <nav class="navbar navbar-expand-lg navbar-light p-0">
        <a class="navbar-brand" href="/">
            
            <b>JIMMY SONG</b>
            
        </a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/blog">博客</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/book">资料</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/tags">标签</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/notice">公告</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/contact">联系</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/about">关于</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="/community/">社区</a>
              
            </li>
            
            
            
            <li class="nav-item">
              
              <a class="nav-link" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener">视频 <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i></a>
              
            </li>
            
            

          
          
          
          <!-- search -->
           <button type="button" class="search-btn js-search" id="searchOpen" aria-label="Search">
              <div class="search-container d-flex justify-content-center">
              <span class="search-content">
                  <i class="fa fa-search"></i>
                  <span>搜索</span>
              </span>
              <span class="search-shortcuts d-none d-sm-block">
                  <kbd class="cmd-key">⌘</kbd>
                  <kbd class="k-key">K</kbd>
              </span>
              </div>
          </button>
          
          </ul>
        </div>
      </nav>
    </div>
  </div>
</header>


            <aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between">
        <div class="col-6 search-title">
          <p>站内搜索</p> 
        </div>
        <div class="col-6 col-search-close">
          <div class="js-search" aria-label="关闭"><i class="fa-solid fa-circle-xmark text-muted" aria-hidden="true"></i></div>
        </div>
      </div>

      <div id="search-box">
        <i class="fa-solid fa-magnifying-glass" id="search-icon" aria-hidden="true"></i>
        <input name="q" id="search-query" placeholder="请输入搜索词" autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control" aria-label="请输入搜索词">
        
        <div class="mt-4">
          <span>搜索类型: </span>
          <span>
            <input type="radio" id="all" name="search_type" value="all" checked>
            <label for="all">所有</label>
            
              <input type="radio" id="blog" name="search_type" value="blog">
              <label for="blog">原创</label>
              <input type="radio" id="trans" name="search_type" value="trans">
              <label for="trans">译文</label>
            
            <input type="radio" id="book" name="search_type" value="book">
            <label for="book">资料</label>
            <input type="radio" id="notice" name="search_type" value="notice">
            <label for="notice">公告</label>
          </span>
        </div>
      </div>
      
    </section>
    <section class="section-search-results">
      <div id="search-results-count" class="search-results-count"></div>
      <div id="search-hits">
        
      </div>
    </section>
  </div>
</aside>

        
        
            

        

<div class="blog book book-padding">
  <div class="container-xxl d-flex">
    <aside class="docs-sidebar d-none col-sm-2">
      <nav class="collapse docs-links box-shadow mb-4 sticky-top aside-toc d-none d-sm-block pt-4" id="docs-nav">

  
  
  
  
  
  

  
  
    

    
      
      
      
      
        
          
        
      



  
    
    
    
    
      
    
    

    
      
      
        
      
        <div class="docs-toc-item root">
          
          
            <div class="docs-toc-title d-flex mb-0 justify-content-start">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/">简明 Envoy 教程</a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  show " id="id5768e6caa0d62ee1e00cda8a07e20100">
          



  <li class="leaf"><a href="/book/envoy-made-simple/preface/">前言</a></li>




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id42fa251edb511bf255f872af62e59eef&#34;)" href="#id42fa251edb511bf255f872af62e59eef" aria-expanded="false" aria-controls="id42fa251edb511bf255f872af62e59eef" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/basics/">Envoy 基础</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id42fa251edb511bf255f872af62e59eef" aria-expanded="false" aria-controls="id42fa251edb511bf255f872af62e59eef">
              
                <i class="fa-solid fa-angle-right" id="caret-id42fa251edb511bf255f872af62e59eef"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id42fa251edb511bf255f872af62e59eef">
          



  <li class="leaf"><a href="/book/envoy-made-simple/basics/network-protocols/">网络协议概述</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/basics/introduction/">Envoy 简介</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/basics/core-features/">核心功能和特点</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-idabfb4104fc1afbce1666cbfa6a173efa&#34;)" href="#idabfb4104fc1afbce1666cbfa6a173efa" aria-expanded="false" aria-controls="idabfb4104fc1afbce1666cbfa6a173efa" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/architecture/">Envoy 架构</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#idabfb4104fc1afbce1666cbfa6a173efa" aria-expanded="false" aria-controls="idabfb4104fc1afbce1666cbfa6a173efa">
              
                <i class="fa-solid fa-angle-right" id="caret-idabfb4104fc1afbce1666cbfa6a173efa"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="idabfb4104fc1afbce1666cbfa6a173efa">
          



  <li class="leaf"><a href="/book/envoy-made-simple/architecture/overview/">简介</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/architecture/data-flow-request-processing/">数据流和请求处理</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/architecture/configuration/">配置管理</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id2d41ac79d6da1ad2edb44a35a7fa26b7&#34;)" href="#id2d41ac79d6da1ad2edb44a35a7fa26b7" aria-expanded="false" aria-controls="id2d41ac79d6da1ad2edb44a35a7fa26b7" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/hcm/">HTTP 连接管理器</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id2d41ac79d6da1ad2edb44a35a7fa26b7" aria-expanded="false" aria-controls="id2d41ac79d6da1ad2edb44a35a7fa26b7">
              
                <i class="fa-solid fa-angle-right" id="caret-id2d41ac79d6da1ad2edb44a35a7fa26b7"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id2d41ac79d6da1ad2edb44a35a7fa26b7">
          



  <li class="leaf"><a href="/book/envoy-made-simple/hcm/overview/">简介</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/hcm/http-filters/">HTTP 过滤器</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/hcm/http-routing/">HTTP 路由</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/hcm/route-match/">路由匹配</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/hcm/traffic-splitting/">流量分割</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id2a8575f6bb76e60bf8c05571ce2bbfd0&#34;)" href="#id2a8575f6bb76e60bf8c05571ce2bbfd0" aria-expanded="false" aria-controls="id2a8575f6bb76e60bf8c05571ce2bbfd0" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/clusters/">集群</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id2a8575f6bb76e60bf8c05571ce2bbfd0" aria-expanded="false" aria-controls="id2a8575f6bb76e60bf8c05571ce2bbfd0">
              
                <i class="fa-solid fa-angle-right" id="caret-id2a8575f6bb76e60bf8c05571ce2bbfd0"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id2a8575f6bb76e60bf8c05571ce2bbfd0">
          



  <li class="leaf"><a href="/book/envoy-made-simple/clusters/overview/">简介</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-idda5f9a6d697f75b039de410de6c3e998&#34;)" href="#idda5f9a6d697f75b039de410de6c3e998" aria-expanded="false" aria-controls="idda5f9a6d697f75b039de410de6c3e998" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/listeners/">监听器</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#idda5f9a6d697f75b039de410de6c3e998" aria-expanded="false" aria-controls="idda5f9a6d697f75b039de410de6c3e998">
              
                <i class="fa-solid fa-angle-right" id="caret-idda5f9a6d697f75b039de410de6c3e998"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="idda5f9a6d697f75b039de410de6c3e998">
          



  <li class="leaf"><a href="/book/envoy-made-simple/listeners/overview/">简介</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id38ab4dd0c718862b378ee6645f7165db&#34;)" href="#id38ab4dd0c718862b378ee6645f7165db" aria-expanded="false" aria-controls="id38ab4dd0c718862b378ee6645f7165db" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/filters/">过滤器</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id38ab4dd0c718862b378ee6645f7165db" aria-expanded="false" aria-controls="id38ab4dd0c718862b378ee6645f7165db">
              
                <i class="fa-solid fa-angle-right" id="caret-id38ab4dd0c718862b378ee6645f7165db"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id38ab4dd0c718862b378ee6645f7165db">
          



  <li class="leaf"><a href="/book/envoy-made-simple/filters/overview/">简介</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id6b8ac6a0ff0bc34fe1e79096f5124771&#34;)" href="#id6b8ac6a0ff0bc34fe1e79096f5124771" aria-expanded="false" aria-controls="id6b8ac6a0ff0bc34fe1e79096f5124771" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/routing/">路由</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id6b8ac6a0ff0bc34fe1e79096f5124771" aria-expanded="false" aria-controls="id6b8ac6a0ff0bc34fe1e79096f5124771">
              
                <i class="fa-solid fa-angle-right" id="caret-id6b8ac6a0ff0bc34fe1e79096f5124771"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id6b8ac6a0ff0bc34fe1e79096f5124771">
          



  <li class="leaf"><a href="/book/envoy-made-simple/routing/overview/">简介</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-ida214f85d86f89d9975a80d88ea268064&#34;)" href="#ida214f85d86f89d9975a80d88ea268064" aria-expanded="false" aria-controls="ida214f85d86f89d9975a80d88ea268064" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/security/">安全</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#ida214f85d86f89d9975a80d88ea268064" aria-expanded="false" aria-controls="ida214f85d86f89d9975a80d88ea268064">
              
                <i class="fa-solid fa-angle-down" id="caret-ida214f85d86f89d9975a80d88ea268064"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  show " id="ida214f85d86f89d9975a80d88ea268064">
          



  <li class="leaf active"><a href="/book/envoy-made-simple/security/waf/">Web 应用防火墙（WAF）</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-idccb43f8cc3a2cf738db1054ec0394a74&#34;)" href="#idccb43f8cc3a2cf738db1054ec0394a74" aria-expanded="false" aria-controls="idccb43f8cc3a2cf738db1054ec0394a74" aria-hidden="false" data-toggle="collapse">
          
          
        </div>
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id3dbeaf13c879157429306a0f44ce723e&#34;)" href="#id3dbeaf13c879157429306a0f44ce723e" aria-expanded="false" aria-controls="id3dbeaf13c879157429306a0f44ce723e" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/extensibility/">可扩展性</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id3dbeaf13c879157429306a0f44ce723e" aria-expanded="false" aria-controls="id3dbeaf13c879157429306a0f44ce723e">
              
                <i class="fa-solid fa-angle-right" id="caret-id3dbeaf13c879157429306a0f44ce723e"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id3dbeaf13c879157429306a0f44ce723e">
          



  <li class="leaf"><a href="/book/envoy-made-simple/extensibility/lua/">Lua</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-idf90e852b8044dd851647e319dd95d8ad&#34;)" href="#idf90e852b8044dd851647e319dd95d8ad" aria-expanded="false" aria-controls="idf90e852b8044dd851647e319dd95d8ad" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/gateway/">Envoy Gateway</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#idf90e852b8044dd851647e319dd95d8ad" aria-expanded="false" aria-controls="idf90e852b8044dd851647e319dd95d8ad">
              
                <i class="fa-solid fa-angle-right" id="caret-idf90e852b8044dd851647e319dd95d8ad"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="idf90e852b8044dd851647e319dd95d8ad">
          



  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-idc32b986f00624bbb37a2607795bb715f&#34;)" href="#idc32b986f00624bbb37a2607795bb715f" aria-expanded="false" aria-controls="idc32b986f00624bbb37a2607795bb715f" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/gateway/traffic-management/">流量管理</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#idc32b986f00624bbb37a2607795bb715f" aria-expanded="false" aria-controls="idc32b986f00624bbb37a2607795bb715f">
              
                <i class="fa-solid fa-angle-right" id="caret-idc32b986f00624bbb37a2607795bb715f"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="idc32b986f00624bbb37a2607795bb715f">
          



  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/routing-traffic-distribution/">路由与流量分发</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/traffic-control-optimization/">流量控制与优化</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/traffic-modification-enhandcement/">流量修正与增强</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/load-balancing/">负载均衡</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/gateway-config/">网关配置</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/gateway/traffic-management/client-traffic-policy/">客户端流量管理</a></li>

          
            </ul>
          
        

        
          </div>
        

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id3951dd21632cbd9164143c411116bbae&#34;)" href="#id3951dd21632cbd9164143c411116bbae" aria-expanded="false" aria-controls="id3951dd21632cbd9164143c411116bbae" aria-hidden="false" data-toggle="collapse">
          
          
            <a class="d-inline docs-toc-link mr-2 " href="/book/envoy-made-simple/service-mesh/">服务网格</a>
            
            <a class="nav-toogle d-inline" aria-hidden="false" data-toggle="collapse" href="#id3951dd21632cbd9164143c411116bbae" aria-expanded="false" aria-controls="id3951dd21632cbd9164143c411116bbae">
              
                <i class="fa-solid fa-angle-right" id="caret-id3951dd21632cbd9164143c411116bbae"></i>
              
            </a>
            
          
        </div>
        
          
            <ul class="nav docs-sidenav collapse  " id="id3951dd21632cbd9164143c411116bbae">
          



  <li class="leaf"><a href="/book/envoy-made-simple/service-mesh/overview/">简介</a></li>




  <li class="leaf"><a href="/book/envoy-made-simple/service-mesh/envoy-filter/">EnvoyFilter</a></li>

          
            </ul>
          
        

        
          </div>
        




  
    
    
    
    
      
    
    

    
      
      
        <div class="docs-toc-item has-leaf">
          
            <div class="parent-node d-flex mb-0 justify-content-between" onClick="toggleCollapse(&#34;caret-id12a93dd74f21037e60d83b95901054cd&#34;)" href="#id12a93dd74f21037e60d83b95901054cd" aria-expanded="false" aria-controls="id12a93dd74f21037e60d83b95901054cd" aria-hidden="false" data-toggle="collapse">
          
          
        </div>
        

        
          </div>
        




  <li class="leaf"><a href="/book/envoy-made-simple/references/">参考资料</a></li>

          
            </ul>
          
        

        
          </div>
        

    
  
</nav>

    </aside>

    
    <aside class="docs-toc d-none d-xl-block col-xl-2 px-2">
      <div class="sidebar">
      
  <div class="bg-white sticky-top aside-toc">
    <p class="toc-sidebar-title">
      目录
    </p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是-waf">什么是 WAF？</a></li>
    <li><a href="#waf-的基本概念">WAF 的基本概念</a>
      <ul>
        <li><a href="#owasp-crs-owasp-core-rule-set">OWASP CRS (OWASP Core Rule Set)</a></li>
        <li><a href="#modsecurity">ModSecurity</a></li>
        <li><a href="#seclang">SecLang</a></li>
        <li><a href="#waf-web-application-firewall">WAF (Web Application Firewall)</a></li>
        <li><a href="#coraza">Coraza</a></li>
      </ul>
    </li>
    <li><a href="#类比机场安全检查系统">类比：机场安全检查系统</a></li>
    <li><a href="#waf-的使用案例">WAF 的使用案例</a>
      <ul>
        <li><a href="#sql-注入">SQL 注入</a></li>
        <li><a href="#xss-攻击">XSS 攻击</a></li>
      </ul>
    </li>
    <li><a href="#waf-的工作原理">WAF 的工作原理</a></li>
    <li><a href="#基于-envoy-集成的-waf">基于 Envoy 集成的 WAF</a></li>
    <li><a href="#实施建议">实施建议</a></li>
    <li><a href="#coraza-1">Coraza</a>
      <ul>
        <li><a href="#主要特性">主要特性</a></li>
        <li><a href="#集成">集成</a></li>
        <li><a href="#使用">使用</a></li>
      </ul>
    </li>
    <li><a href="#如何在-envoy-中集成-coraza">如何在 Envoy 中集成 Coraza</a></li>
    <li><a href="#如何在-istio-中集成-coraza">如何在 Istio 中集成 Coraza</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>



      

      </div>
    </aside>

    <main class="py-md-3 pl-md-3 mt-2 col-lg-8 p-0" role="main">
      <div class="row">
            <div class="col-12">
                <div class="mb-2">
                    <nav aria-label="breadcrumb" class="page-breadcrumb">
    <ol class="breadcrumb mb-0">
    
          
      
        
      
        
      
        
      
        
      
    
            
      
    
            
              <li class="breadcrumb-item"><a href="/book/">资料</a></li>
            
      
    
            
              <li class="breadcrumb-item"><a href="/book/envoy-made-simple/">简明 Envoy 教程</a></li>
            
      
    
            
              <li class="breadcrumb-item"><a href="/book/envoy-made-simple/security/">安全</a></li>
            
      
    
          <li class="breadcrumb-item active" aria-current="page">Web 应用防火墙（WAF）</li>
    

    
    </ol>
</nav>

                </div>
              <hr class="mt-0">
              <h1 class="mb-3">
               Web 应用防火墙（WAF）
              </h1>
              
                <div class="book-page-metadata mb-3">
                    <ul class="list-inline">
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-calendar"></i>
                            </span>2024/08/08</li>
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-clock"></i>
                            </span>21 分钟</li>
                        <li class="list-inline-item mr-2 mb-md-0"><span><i class="fa-regular fa-file-word"></i>
                            </span>4711 字</li>
                    </ul>
                </div>
              
              
                <details class="mobile-toc d-sm-none d-block mb-0">
  <summary>查看本文大纲</summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是-waf">什么是 WAF？</a></li>
    <li><a href="#waf-的基本概念">WAF 的基本概念</a>
      <ul>
        <li><a href="#owasp-crs-owasp-core-rule-set">OWASP CRS (OWASP Core Rule Set)</a></li>
        <li><a href="#modsecurity">ModSecurity</a></li>
        <li><a href="#seclang">SecLang</a></li>
        <li><a href="#waf-web-application-firewall">WAF (Web Application Firewall)</a></li>
        <li><a href="#coraza">Coraza</a></li>
      </ul>
    </li>
    <li><a href="#类比机场安全检查系统">类比：机场安全检查系统</a></li>
    <li><a href="#waf-的使用案例">WAF 的使用案例</a>
      <ul>
        <li><a href="#sql-注入">SQL 注入</a></li>
        <li><a href="#xss-攻击">XSS 攻击</a></li>
      </ul>
    </li>
    <li><a href="#waf-的工作原理">WAF 的工作原理</a></li>
    <li><a href="#基于-envoy-集成的-waf">基于 Envoy 集成的 WAF</a></li>
    <li><a href="#实施建议">实施建议</a></li>
    <li><a href="#coraza-1">Coraza</a>
      <ul>
        <li><a href="#主要特性">主要特性</a></li>
        <li><a href="#集成">集成</a></li>
        <li><a href="#使用">使用</a></li>
      </ul>
    </li>
    <li><a href="#如何在-envoy-中集成-coraza">如何在 Envoy 中集成 Coraza</a></li>
    <li><a href="#如何在-istio-中集成-coraza">如何在 Istio 中集成 Coraza</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</details>

              
            </div>
        </div>

      <article class="border-bottom content mb-4">
          <p>本节将介绍如何在 Envoy 中使用 WAF 来增强应用安全性，并以 Coraza 为例进行详细讲解。</p>
<h2 id="什么是-waf">什么是 WAF？</h2>
<p>WAF 是一种安全技术，用于监控、过滤或阻止向 Web 应用发送的恶意流量。WAF 主要保护应用免受 SQL 注入、跨站脚本（XSS）、文件包含等攻击，是现代 Web 应用安全不可或缺的一部分。</p>
<h2 id="waf-的基本概念">WAF 的基本概念</h2>
<p>了解下面的概念及组件将有助于你理解 WAF 是如何运行的。</p>
<ul>
<li><strong>Envoy</strong> 使用 <strong>Coraza</strong> 作为其 WAF 的实现。</li>
<li><strong>Coraza</strong> 作为 WAF，保护 Web 应用，并支持 <strong>SecLang</strong> 语言。</li>
<li><strong>SecLang</strong> 是 <strong>ModSecurity</strong> 的规则语言。</li>
<li><strong>ModSecurity</strong> 定义了 <strong>OWASP CRS</strong> (OWASP Core Rule Set)。</li>
<li><strong>OWASP CRS</strong> 的具体项目名为 <code>coreruleset</code>。</li>
</ul>
<p>下图展示了它们之间的关系。</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/book/envoy-made-simple/security/waf/4b07307f5dbd40abb7ca12c2e4a2e6a4.svg" data-img="/book/envoy-made-simple/security/waf/4b07307f5dbd40abb7ca12c2e4a2e6a4.svg" alt="image" data-caption="WAF 基本概念">
        
      
    
  
  
  <figcaption>WAF 基本概念</figcaption>
  
</figure>
<p>接下来我们将详细介绍这些概念，并将其与机场安检系统类比，加深你对 WAF 的理解。</p>
<h3 id="owasp-crs-owasp-core-rule-set">OWASP CRS (OWASP Core Rule Set)</h3>
<p>OWASP CRS 是一套为 WAF 设计的开源规则集，旨在防护 Web 应用免受广泛的攻击。</p>
<p><strong>示例（配置示例）：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-apache" data-lang="apache"><span class="line"><span class="cl"><span class="c"># 在Apache服务器上启用OWASP CRS</span>
</span></span><span class="line"><span class="cl"><span class="nb">SecRuleEngine</span> <span class="k">On</span>
</span></span><span class="line"><span class="cl"><span class="nb">Include</span> owasp-modsecurity-crs/crs-setup.conf
</span></span><span class="line"><span class="cl"><span class="nb">Include</span> owasp-modsecurity-crs/rules/*.conf
</span></span></code></pre></div><h3 id="modsecurity">ModSecurity</h3>
<p>ModSecurity 是一个跨平台的开源 WAF 引擎，最初为 Apache HTTP 服务器设计，现已扩展到多个平台，用于实时监控、记录和阻止 HTTP 流量中的恶意请求。</p>
<p><strong>示例（使用方式）：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-apache" data-lang="apache"><span class="line"><span class="cl"><span class="c"># 在Apache中启用ModSecurity</span>
</span></span><span class="line"><span class="cl"><span class="nb">LoadModule</span> security2_module modules/mod_security2.so
</span></span><span class="line"><span class="cl"><span class="nt">&lt;IfModule</span> <span class="s">mod_security2.c</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Include</span> modsecurity.d/*.conf
</span></span><span class="line"><span class="cl">    <span class="nb">Include</span> modsecurity.d/activated_rules/*.conf
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/IfModule&gt;</span>
</span></span></code></pre></div><h3 id="seclang">SecLang</h3>
<p>SecLang 是 ModSecurity 使用的规则语言，允许用户定义复杂的安全策略来监控和控制进入 Web 应用的 HTTP 流量。</p>
<p><strong>示例（配置示例）：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-apache" data-lang="apache"><span class="line"><span class="cl"><span class="c"># SecLang规则示例，防止SQL注入</span>
</span></span><span class="line"><span class="cl"><span class="nb">SecRule</span> ARGS <span class="s2">&#34;select|insert|update|delete|union|select|drop&#34;</span> <span class="s2">&#34;id:&#39;100001&#39;,phase:2,deny,status:403,msg:&#39;SQL injection attempt&#39;&#34;</span>
</span></span></code></pre></div><h3 id="waf-web-application-firewall">WAF (Web Application Firewall)</h3>
<p>WAF 是一种专门设计来监视、过滤和阻止到 Web 应用的恶意流量的安全技术。</p>
<p><strong>示例（使用方式）：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="c1"># 在Nginx中配置基本的WAF设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">modsecurity</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">modsecurity_rules_file</span> <span class="s">/etc/nginx/modsec/main.conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="coraza">Coraza</h3>
<p>Coraza 是一个开源、高性能的 WAF 库，兼容 ModSecurity 的 SecLang 规则，可作为 Go 应用的库或集成到其他平台。</p>
<p><strong>示例（配置示例）：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 使用 Coraza 在 Go 程序中创建 WAF 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">import</span> <span class="s">&#34;github.com/corazawaf/coraza/v2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">waf</span> <span class="o">:=</span> <span class="nx">coraza</span><span class="p">.</span><span class="nf">NewWaf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">rules</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">waf</span><span class="p">.</span><span class="nx">Rules</span><span class="p">.</span><span class="nf">CompileFile</span><span class="p">(</span><span class="s">&#34;/path/to/modsec_rules.conf&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>这些简要说明和示例展示了每种技术的核心用途和配置方式，有助于理解其在实际应用中的实施和运用。</p>
<p>如果以上解释还不够直观的理解 WAF 是如何运行的，那么将 WAF 比作机场的安检系统，将有助你理解。</p>
<h2 id="类比机场安全检查系统">类比：机场安全检查系统</h2>
<ol>
<li>
<p><strong>OWASP CRS</strong>：想象 OWASP CRS 是安全检查中使用的检查标准和规程手册。这本手册详细列出了哪些物品是禁止携带的，以及如何检测这些违禁品。</p>
</li>
<li>
<p><strong>ModSecurity</strong>：ModSecurity 像是执行这些规程的安检员，他使用手册中的规则来检查旅客和他们的行李是否符合安全标准。</p>
</li>
<li>
<p><strong>SecLang</strong>：SecLang 是安检员使用的具体操作语言或指导，确保他们可以准确无误地理解和执行手册中的规则。</p>
</li>
<li>
<p><strong>WAF（Web Application Firewall）</strong>：整个安检区域，装备了必要的设施和技术（如 X 光机和金属探测器，对应 ModSecurity 和 Coraza）来检查和过滤所有进出的旅客和行李。</p>
</li>
<li>
<p><strong>Coraza</strong>：另一位安检员，在同一个安检区域内工作，使用与 ModSecurity 相同的手册，但可能有不同的检查技术或工具。</p>
</li>
<li>
<p><strong>Envoy</strong>：Envoy 是整个机场的交通调度系统，负责协调旅客的流动，确保所有人都通过安检区。Envoy 确保信息和数据流在安全的环境下高效流通，优化整个机场的运作。</p>
</li>
</ol>
<p>通过这个类比，我们可以看到 Envoy 如何协调和管理网络流量，而 WAF（如 ModSecurity 和 Coraza）则是进行安全检查的关键组件。OWASP CRS 提供了检查的规则和标准，SecLang 是执行这些规则的具体指南。这种设置保证了网络环境的安全，防止不安全或不合规的数据进入或离开网络系统。</p>
<h2 id="waf-的使用案例">WAF 的使用案例</h2>
<p>使用 WAF 的两个常见的例子是防止 SQL 注入和 XSS 攻击。</p>
<h3 id="sql-注入">SQL 注入</h3>
<p>SQL 注入是攻击者试图通过 Web 应用执行恶意 SQL 代码的行为。例如，未经过滤的用户输入可能被直接用在 SQL 命令中，从而允许攻击者访问或修改数据库内容。WAF 可以识别并阻止这类恶意输入。</p>
<p><strong>示例场景</strong>：假设一个登录页面通过拼接字符串的方式构造 SQL 查询来验证用户名和密码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;$username&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;$password&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>如果攻击者在用户名字段输入 <code>' OR '1'='1</code>，则查询变为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>由于 <code>'1'='1'</code> 总是为真，攻击者可以绕过身份验证，访问系统。</p>
<h3 id="xss-攻击">XSS 攻击</h3>
<p>跨站脚本攻击（XSS）允许攻击者将恶意脚本注入其他用户会看到的页面中。这可能用于窃取信息或欺骗用户。WAF 通过检测和阻断可疑的脚本执行，帮助防止 XSS 攻击。</p>
<p><strong>示例场景</strong>：一个评论功能允许用户提交评论并在页面上显示，而没有对输入进行适当的过滤。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;comment&#34;</span> <span class="p">/&gt;</span>
</span></span></code></pre></div><p>如果攻击者输入 <code>&lt;script&gt;alert('XSS');&lt;/script&gt;</code>，则当其他用户访问该页面时，会弹出一个警告框，显示“XSS”。这种攻击可以用于窃取用户会话信息、重定向到恶意网站等。</p>
<h2 id="waf-的工作原理">WAF 的工作原理</h2>
<p>WAF 通过分析和过滤所有进入 Web 应用的 HTTP 请求来阻止恶意访问。WAF 的核心组件包括：</p>
<ol>
<li><strong>请求和响应监控</strong>：WAF 监控所有进入和离开 Web 应用的 HTTP 请求和响应。</li>
<li><strong>规则引擎</strong>：WAF 使用一系列预定义的或自定义的规则，这些规则基于已知的攻击模式和行为。这些规则用于评估 HTTP 请求中的各种元素，如 URLs、查询字符串、POST 数据、HTTP 头部等。</li>
<li><strong>攻击检测逻辑</strong>：当 HTTP 请求到达时，WAF 根据其规则引擎分析请求内容。如果发现符合攻击模式的请求，WAF 将根据配置决定拦截请求或仅记录攻击尝试。</li>
<li><strong>响应决策</strong>：WAF 根据分析结果对请求做出响应。如果请求被确定为恶意的，WAF 可以阻止该请求，并发送错误页面给用户；如果请求是合法的，则允许它继续到达 Web 应用。</li>
</ol>
<p>下图展示了 WAF 的工作原理。</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/book/envoy-made-simple/security/waf/4587654ea7289c28e125ab6c8b7c81af.svg" data-img="/book/envoy-made-simple/security/waf/4587654ea7289c28e125ab6c8b7c81af.svg" alt="image" data-caption="WAF 的工作原理">
        
      
    
  
  
  <figcaption>WAF 的工作原理</figcaption>
  
</figure>
<p>从图中可以看到，当客户端发送 HTTP 请求时，它最初会被 WAF 拦截，然后才到达 Web 应用程序。WAF 会分析此请求并应用一组预定义的安全规则。根据此分析，WAF 会做出阻止请求或允许其继续的决定。如果请求被阻止，客户端将立即收到一条错误消息。相反，如果允许该请求，则 Web 应用程序将对其进行处理，从而生成响应。随后，此响应将通过 WAF 路由回 WAF，在 WAF 中，它将经历与请求类似的分析和规则应用过程。如果 WAF 在响应中检测到任何恶意内容，它会阻止响应并向客户端发送错误消息。如果未检测到任何问题，则允许将响应传回给客户端。这种全面的检查过程可确保对传入请求和传出响应进行安全威胁审查，从而有效阻止恶意流量，同时允许合法交互与 Web 应用程序顺利进行。</p>
<h2 id="基于-envoy-集成的-waf">基于 Envoy 集成的 WAF</h2>
<p>WAF 作为防火墙需要拦截流量，而 Envoy 代理也同样需要拦截流量，这样我们就可以在 Envoy 中集成 WAF 来拦截恶意流量。Envoy Proxy 可以通过多种方式集成 WAF，以下是一些常见的基于 Envoy 实现的 WAF：</p>
<ol>
<li>
<p><strong>WebAssembly 插件</strong>：Envoy 本身不具备内置的 WAF 功能，但可以通过 WebAssembly 插件接口实现。开发者可以使用 WebAssembly 编写插件，将现成的 WAF 库（如 <a href="https://coraza.io/" title="Coraza" target="_blank" rel="noopener">Coraza</a>）编译为 WebAssembly，以便在 Envoy 中使用。</p>
</li>
<li>
<p><strong>Wafris</strong>：这是一个专为 Envoy Proxy 设计的原生 WAF，能够提升 Envoy 的安全性。<a href="https://wafris.org/firewalls/envoy" title="Wafris" target="_blank" rel="noopener">Wafris</a> 提供了一个完整的 WAF 安全套件，可以过滤潜在威胁并提供有价值的流量分析（截止到撰写本文时，该 WAF 尚未正式发布）。</p>
</li>
<li>
<p><strong>Next-Gen WAF Agent</strong>：可以将 <a href="https://docs.fastly.com/en/ngwaf/configuring-envoy-proxy-deployments#adding-the-next-gen-waf-agent-cluster" title="Next-Gen WAF" target="_blank" rel="noopener">Next-Gen WAF</a> 代理作为 sidecar 部署在 Kubernetes 中，与 Envoy Proxy 集成。此代理通过 Envoy 的 gRPC 服务进行通信，允许在 Envoy 配置中添加额外的安全层。</p>
</li>
<li>
<p><strong>Gloo Edge API Gateway</strong>：<a href="https://www.solo.io/blog/5-minutes-with-gloo-web-application-firewalls-waf-in-api-gateways/" title="Gloo Edge" target="_blank" rel="noopener">Gloo Edge</a> 是基于 Envoy 构建的 API 网关，支持 WAF 扩展。它通过在 Envoy 中实现 ModSecurity 框架和规则集来提供 WAF 功能，默认包含 OWASP 核心规则集（CRS），并允许创建和应用自定义规则集。</p>
</li>
<li>
<p><strong>Coraza WAF</strong>：Tetrate Enterprise Gateway for Envoy（TEG）内置了<a href="https://docs.tetrate.io/envoy-gateway/howto/coraza" title="Coraza WAF" target="_blank" rel="noopener">Coraza WAF</a>，使用标准的 mod_security 规则格式进行配置。Coraza 默认配置了 OWASP 核心规则集（CRS），可以根据需要进行调整。</p>
</li>
</ol>
<h2 id="实施建议">实施建议</h2>
<p>下图展示了流量如何经过 集成了 WAF 的 Envoy 后处理流程：</p>

<figure class="mx-auto text-center">
  
  
  
    
      
        
          <img src="/book/envoy-made-simple/security/waf/47a79e5f4b8d806d2882ed7544df6e93.svg" data-img="/book/envoy-made-simple/security/waf/47a79e5f4b8d806d2882ed7544df6e93.svg" alt="image" data-caption="流量如何经过集成了 WAF 的 Envoy 代理">
        
      
    
  
  
  <figcaption>流量如何经过集成了 WAF 的 Envoy 代理</figcaption>
  
</figure>
<p>步骤说明：</p>
<ul>
<li><strong>客户端</strong>发送请求到 <strong>Envoy 的 ext_authz 过滤器</strong>。</li>
<li><strong>ext_authz 过滤器</strong>将请求转发到 <strong>WAF 代理</strong>。</li>
<li><strong>WAF 代理</strong> 分析请求并应用规则，决定是否检测到攻击。</li>
<li>如果检测到攻击，<strong>WAF 代理</strong>将返回错误信息给<strong>客户端</strong>。</li>
<li>如果没有检测到攻击，<strong>WAF 代理</strong>将允许请求，并将其传递给 <strong>Web 应用</strong>，最终返回响应给<strong>客户端</strong>。</li>
</ul>
<p>在实施 WAF 时，建议逐步调整规则以最大化其有效性并尽量减少误报。可以通过以下步骤实现：</p>
<ol>
<li>将 WAF 设置为仅检测模式，以便在不干扰生产环境的情况下测试规则。</li>
<li>监控日志，识别并调整规则以减少误报和漏报。</li>
<li>在对规则集满意后，将 WAF 切换回正常模式以全面启用其保护功能。</li>
</ol>
<p>通过合理配置和调整，Envoy 中的 WAF 功能可以显著增强 Web 应用程序的安全性，帮助开发者专注于功能开发，同时减少安全问题的处理时间。</p>
<p><strong>Envoy 版本与功能</strong>：使用推荐的 Envoy 版本（v1.11.0 或更高）以获得最佳功能支持。低版本（v1.8.0 及以上）也支持，但可能功能受限。</p>
<p><strong>集成<code>ext_authz</code>过滤器</strong>：</p>
<ul>
<li>将<code>envoy.ext_authz</code>过滤器配置在 HTTP 过滤器链中，该过滤器负责将客户端请求的元数据发送到 WAF 代理进行安全审查。</li>
<li>根据 WAF 代理的判断，请求可能被允许继续处理或直接阻止。</li>
</ul>
<p><strong>配置访问日志服务（ALS）</strong>：</p>
<ul>
<li>将响应数据通过访问日志服务异步发送到 WAF 代理，以便进行后续的审计和分析。</li>
<li>这有助于监控响应数据，并可能用于检测响应中的数据泄露等安全问题。</li>
</ul>
<p><strong>安全和 TLS 配置</strong>：</p>
<ul>
<li>对于需要加密的部署，配置 TLS 支持以保证数据传输过程中的安全。</li>
<li>配置包括证书和密钥的管理。</li>
</ul>
<p><strong>请求和响应数据处理</strong>：</p>
<ul>
<li>配置 Envoy 以启用对请求体和响应数据的处理，这可能需要在更高版本的 Envoy 中特别配置。</li>
</ul>
<p><strong>部署模式</strong>：</p>
<ul>
<li>WAF 代理通常部署为 Kubernetes 中的 sidecar，与 Envoy 代理共存，提供低延迟和高效的数据处理。</li>
</ul>
<h2 id="coraza-1">Coraza</h2>
<p>Coraza 是一个开源的、企业级的高性能 WAF 库，采用 Go 语言编写。它与 ModSecurity 的 SecLang 规则集兼容，并完全支持 OWASP Core Rule Set (CRS) v4。Coraza 旨在保护 Web 应用程序免受广泛攻击，包括 OWASP Top Ten 列出的常见威胁，如 SQL 注入、跨站脚本（XSS）、代码注入等。</p>
<h3 id="主要特性">主要特性</h3>
<ul>
<li><strong>兼容性</strong>：Coraza 是 ModSecurity 引擎的替代方案，支持行业标准的 SecLang 规则集。</li>
<li><strong>安全性</strong>：运行 OWASP CRS v4 以保护 Web 应用程序，减少误报。</li>
<li><strong>可扩展性</strong>：作为一个库，Coraza 提供多种集成方式，可以在本地部署 WAF 实例。</li>
<li><strong>性能</strong>：能够处理从大型网站到小型博客的负载，性能影响最小。</li>
<li><strong>简单性</strong>：源代码易于理解和修改，便于扩展新功能。</li>
<li><strong>社区支持</strong>：作为一个社区项目，Coraza 接受贡献，欢迎各种想法。</li>
</ul>
<h3 id="集成">集成</h3>
<p>Coraza 项目维护了多个服务器的实现和插件，包括：</p>
<ul>
<li>Caddy 反向代理和 Web 服务器插件</li>
<li>Proxy WASM 扩展（例如用于 Envoy）</li>
<li>HAProxy SPOE 插件</li>
<li>Coraza C 库（用于 nginx 等）</li>
</ul>
<h3 id="使用">使用</h3>
<p>Coraza 可以作为 Go 程序的库来实现安全中间件，或与现有的应用程序和 Web 服务器集成。它支持通过 Go 的构建标签调整某些功能，以适应高级用例。也可以编译成 WebAssembly 插件，集成到 Web 服务器中运行。</p>
<h2 id="如何在-envoy-中集成-coraza">如何在 Envoy 中集成 Coraza</h2>
<p>要想在 Envoy 中集成 Coraza WAF 可以使用 Coraza Proxy WASM 这个项目，参考步骤如下：</p>
<ol>
<li>
<p><strong>编译 WASM 插件</strong>：
使用 Go 和 TinyGo，你可以通过运行 <code>go run mage.go build</code> 命令来编译 Coraza WASM 插件。编译完成后，你会在 <code>./build</code> 目录下找到生成的 <code>main.wasm</code> 文件。</p>
</li>
<li>
<p><strong>配置和运行 Envoy</strong>：
插件编译后，需要在 Envoy 配置文件中设置 WASM 插件。这涉及到配置 HTTP 过滤器以使用 WASM 扩展，然后<a href="https://github.com/corazawaf/coraza-proxy-wasm?tab=readme-ov-file#running-the-filter-in-an-envoy-process" title="指定 WASM 模块的位置和配置" target="_blank" rel="noopener">指定 WASM 模块的位置和配置</a>。具体配置包括指定处理规则和日志级别等。</p>
</li>
<li>
<p><strong>测试和运行</strong>：
使用 <code>mage runExample</code> 和 <code>mage teardownExample</code> 命令可以启动和关闭测试环境。测试环境默认在 <code>localhost:8080</code> 运行。你可以发送 HTTP 请求来测试 Coraza 的行为和规则。</p>
</li>
<li>
<p><strong>使用 OWASP Core Rule Set (CRS)</strong>：
Coraza Proxy WASM 支持直接集成 OWASP Core Rule Set，允许通过配置文件直接加载和使用。这有助于增强安全性并测试常见的 Web 攻击场景。</p>
</li>
<li>
<p><strong>运行回归测试</strong>：
使用 <code>go run mage.go ftw</code> 命令运行 Coraza 的回归测试，确保所有功能按预期工作并且新的更改没有引入错误。</p>
</li>
</ol>
<p>通过这些步骤，你可以成功地部署和使用 Coraza Proxy WASM 来增强你的 Web 应用安全性。更多详细信息和配置示例，请访问 <a href="https://github.com/corazawaf/coraza-proxy-wasm" title="Coraza Proxy WASM 的 GitHub 页面" target="_blank" rel="noopener">Coraza Proxy WASM 的 GitHub 页面</a>。这里提供了完整的安装指南、示例和配置说明，帮助你更好地理解和使用该项目。</p>
<h2 id="如何在-istio-中集成-coraza">如何在 Istio 中集成 Coraza</h2>
<p>与在 Envoy 中集成 Coraza 类似，要想在 Istio 中集成 Coraza，同样需要使用 Wasm 插件——利用 Istio 内置的 <a href="https://istio.io/latest/docs/reference/config/proxy_extensions/wasm-plugin/" title="WasmPlugin" target="_blank" rel="noopener">WasmPlugin</a> 资源，例如下面的定义。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions.istio.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WasmPlugin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">coraza-waf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">waf</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">oci://ghcr.io/corazawaf/coraza-proxy-wasm:0.5.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">AUTHN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pluginConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      SecRuleEngine On
</span></span></span><span class="line"><span class="cl"><span class="sd">      Include @crs-setup-conf
</span></span></span><span class="line"><span class="cl"><span class="sd">      Include @owasp_crs/*.conf</span><span class="w">      
</span></span></span></code></pre></div><p>这个配置允许 Istio 在处理请求的认证阶段利用 Coraza WAF 执行额外的安全检查，通过定义的规则集增强安全性。此外，使用 OWASP Core Rule Set 帮助防御常见的 Web 应用攻击，如跨站脚本攻击（XSS）和 SQL 注入等。这种方式使得在 Istio 环境中部署和管理 WAF 更为灵活和集成。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://owasp.org/www-project-coraza-web-application-firewall/" title="OWASP Coraza Web Application Firewall" target="_blank" rel="noopener">OWASP Coraza Web Application Firewall</a></li>
<li><a href="https://medium.com/@jptosso/a-step-by-step-guide-to-installing-owasp-coraza-waf-as-a-sidecar-proxy-using-istio-aa9f7fd1f1e" title="A Step-By-Step Guide to Installing OWASP Coraza WAF as a Sidecar Proxy Using Istio" target="_blank" rel="noopener">A Step-By-Step Guide to Installing OWASP Coraza WAF as a Sidecar Proxy Using Istio</a></li>
</ul>

      </article>
      <div class="mb-4">
          <p>最后更新于 2025/01/21</p>
          


          


          
            


    
    





    




    
        
    









<div class="pager blog-pager d-flex justify-content-between">
    
    <div class="placeholder"></div>
    

    
    <div class="placeholder"></div>
     
</div>

          
          <div class="body-footer">
            
          </div>
      </div>
    </main>
  </div>
</div>


<footer>
  
  <div class="footer bg-footer section-sm border-bottom overlay  book-padding ">
    <div class="container-xxl">
      <div class="row">
        <div class="col col-xl-4 d-sm-none mb-2 mb-lg-0 d-xl-block d-none">
          
          <p class="h3 text-white mb-4 text-uppercase">联系</p>
          
          <ul class="list-unstyled">
            
            
            <li class="mb-4 text-color">微信公众号</li>
            
            
            <li class="mb-4"><img src="/images/servicemesher-wechat.webp" width="118px" height="118px" alt="footer image"></li>
            
            
            
          
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">博客</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/blog/free-ai-drawing-tool-raphael/">免费的 AI 绘图工具推荐：Raphael.app</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/cloud-native-observability-devops/">探索云原生可观测性：技术与团队协作的深度结合</a></li>
            
            <li class="mb-3"><a class="text-color" href="/blog/http2-envoy-tunnel-demo/">使用 Envoy 实现 HTTP/2 CONNECT 隧道：原理与实践</a></li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">链接</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://istio.io/latest/zh/" target="_blank" rel="noopener noreferrer">
                  Istio 服务网格
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://tetrate.io/?jimmysong" target="_blank" rel="noopener noreferrer">
                  Tetrate 公司
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://space.bilibili.com/515485124" target="_blank" rel="noopener noreferrer">
                  云原生学院|Bilibili
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/awesome-cloud-native/" target="_blank" rel="noopener noreferrer">
                  云原生开源项目大全
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://cloudnative.to" target="_blank" rel="noopener noreferrer">
                  云原生社区（中国）
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">教程</p>
          <ul class="list-unstyled">
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Envoy 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="https://academy.tetrate.io/courses/istio-fundamentals-zh" target="_blank" rel="noopener noreferrer">
                  Istio 基础教程
                  
                  <i class="fa-solid fa-arrow-up-right-from-square icon-small"></i>
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/kubernetes-handbook/" >
                  Kubernetes 基础教程
                  
              </a>
            </li>
            
            <li class="mb-3">
              <a class="text-color" href="/book/envoy-made-simple/" >
                  简明 Envoy 教程
                  
              </a>
            </li>
            
          </ul>
        </div>

        
        <div class="col col-xl-2 col-6 col-sm-3 mb-2">
          <p class="h3 text-white mb-4 text-uppercase">通知</p>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="/notice/kcd-beijing-2025/">KCD Beijing 2025 - 提交议题开启！</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/cloud-native-community-domain-migration/">云原生社区网站域名变更通知</a></li>
            
            <li class="mb-3"><a class="text-color" href="/notice/nist-sp-800-233-service-mesh-proxy-models/">资料分享：云原生应用服务网格代理模型的威胁分析指南</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>

  
  <div class="copyright py-4 bg-footer overlay">
    <div class="container-xxl book-padding">
      <div class="row">
        <div class="col-sm-6 text-sm-left text-center">
          <p class="mb-0 text-color">© 2017-2025 Jimmy Song 保留所有权利</p>
        </div>
        <div class="col-sm-6 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://twitter.com/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-x-twitter text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/contact/" >
                    <i class="fa-brands fa-weixin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://github.com/rootsongjc" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-github text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="https://linkedin.com/in/jimmysongio" target="_blank" title="Social link" rel="noopener noreferrer">
                    <i class="fa-brands fa-linkedin text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="mailto:rootsongjc@gmail.com" >
                    <i class="fa-solid fa-envelope text-white"></i>
              </a>
            </li>
            
            <li class="list-inline-item">
              <a class="d-inline-block p-2" href="/blog/index.xml" >
                    <i class="fa-solid fa-rss text-white"></i>
              </a>
            </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<!-- JS Plugins -->

<script src="/plugins/popper/popper.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/hex_md5/hex_md5.js"></script>

<script src="/plugins/anchor/anchor.min.js"></script>

<script src="/plugins/tocbot/tocbot.min.js"></script>

<script src="/plugins/bigger-picture/bigger-picture.min.js"></script>


<!-- Main Script -->

<script src="/js/script.min.f94c22b1d478bfc9e2e0a7d954429e47b7e6d36edd423758482e04154ae1842e.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ESY906ZWZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ESY906ZWZ0');
</script>


<!-- Baidu analysis -->
<meta name="baidu-site-verification" content="g8IYR9SNLF" />





<script>
    anchors.add();
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>










<script src="/js/wowchemy-search.min.7a37268e7bbe4a9160c2e4c33b749816.js" type="module"></script>
<script id="search-hit-fuse-template" type="text/x-template">
  <div class="search-hit" id="summary-{{key}}">
    <div class="search-hit-content border-bottom">
      <div class="search-hit-name">
        <div class='search-hit-link'><a href="{{relpermalink}}">{{title}}</a></div>
        <div class="search-hit-metadata d-flex">
            <span class="mr-1"><i class="fa-regular fa-calendar mr-1"></i>{{date}}</span>
            <span class="mr-1"><i class="fa-regular fa-folder-open mr-1"></i>{{section}}</span>
            <span class="d-sm-block d-none"><i class="fa-solid fa-link mr-1"></i>{{relpermalink}}</span>
        </div>
        <div class="search-hit-description">{{snippet}}</div>
      </div>
    </div>
  </div>
</script>



    </body>
</html>
